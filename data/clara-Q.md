### Low Risk Issues

| |Issue|Instances|
|-|:-|:-:|
| [[L001](#l001---abiencodepacked-should-not-be-used-with-dynamic-types-when-passing-the-result-to-a-hash-function-such-as-keccak256)] | `abi.encodePacked()` should not be used with dynamic types when passing the result to a hash function such as `keccak256()` | 5 |
| [[L002](#l002---safeapprove-is-deprecated)] | `safeApprove` is Deprecated | 4 |
| [[L003](#l003---_setuprole-is-deprecated)] | `_setupRole` is Deprecated | 4 |
| [[L004](#l004---External calls in modifiers should be avoided:)]  | 1 |
| [[L005](#l005---array-lengths-not-checked)] | Array lengths not checked | 2 |
| [[L006](#l006---missing-checks-for-address0x0-when-assigning-values-to-address-state-variables)] | Missing checks for `address(0x0)` when assigning values to address state variables | 6 |
| [[L007](#l007---upgradeable-contract-is-missing-a-__gap50-storage-variable-to-allow-for-new-storage-variables-in-later-versions)] | Upgradeable contract is missing a __gap[50] storage variable to allow for new storage variables in later versions | 4 |
| [[L008](#l008---unsafe-downcast)] | Unsafe downcast | 30 |
| [[L009](#l009---array-does-not-have-a-pop-function)] | Array does not have a `pop` function | 2 |
| [[L010](#l010---setters-should-have-initial-value-check)] | Setters should have initial value check | 28 |
| [[L011](#l011---empty-receivepayable-fallback-function-does-not-authorize-requests)] | Empty `receive()`/`payable fallback()` function does not authorize requests | 4 |
| [[L012](#l012---contracts-are-designed-to-receive-eth-but-do-not-implement-function-for-withdrawal)] | Contracts are designed to receive ETH but do not implement function for withdrawal | 3 |
| [[L013](#l013---draft-imports-may-break-in-new-minor-versions)] | Draft imports may break in new minor versions | 1 |
| [[L014](#l014---int-casting-blocktimestamp-can-reduce-the-lifespan-of-a-contract)] | Int casting `block.timestamp` can reduce the lifespan of a contract | 2 |
| [[L015](#l015---no-limits-when-setting-state-variable-amounts)] | No limits when setting state variable amounts | 28 |
| [[L016](#l016---double-type-casts-create-complexity-within-the-code)] | Double type casts create complexity within the code | 91 |
| [[L017](#l017---constructor-contains-no-validation)] | Constructor contains no validation | 4 |
| [[L018](#l018---for-loops-in-public-or-external-functions-should-be-avoided-due-to-high-gas-costs-and-possible-dos)] | For loops in `public` or `external` functions should be avoided due to high gas costs and possible DOS | 11 |
| [[L019](#l019---function-calls-within-for-loops)] | Function calls within for loops | 14 |
| [[L020](#l020---external-calls-in-an-unbounded-for-loop-may-result-in-a-dos)] | External calls in an unbounded for-loop may result in a DoS | 11 |
| [[L021](#l021---contracts-are-not-using-their-oz-upgradeable-counterparts)] | Contracts are not using their OZ Upgradeable counterparts | 20 |
| [[L022](#l022---multiplication-on-the-result-of-a-division)] | Multiplication on the result of a division | 2 |
| [[L023](#l023---decimals-is-not-a-part-of-the-erc-20-standard)] | `decimals()` is not a part of the ERC-20 standard | 1 |
| [[L024](#l024---symbol-is-not-a-part-of-the-erc-20-standard)] | `symbol()` is not a part of the ERC-20 standard | 1 |
| [[L025](#l025---name-is-not-a-part-of-the-erc-20-standard)] | `name()` is not a part of the ERC-20 standard | 1 |
| [[L026](#l026---missing-checks-for-address0x0-in-the-constructor)] | Missing checks for address(0x0) in the constructor | 3 |
| [[L027](#l027---missing-checks-for-address0x0-in-the-initializer)] | Missing checks for address(0x0) in the initializer | 1 |
| [[L028](#l028---governance-functions-should-be-controlled-by-time-locks)] | Governance functions should be controlled by time locks | 19 |
| [[L029](#l029---code-does-not-follow-the-best-practice-of-check-effects-interaction)] | Code does not follow the best practice of check-effects-interaction | 7 |
| [[L030](#l030---addresses-upcast-and-compared-to-values-larger-than-a-uint160-may-result-in-collisions)] | addresses upcast and compared to values larger than a uint160, may result in collisions | 1 |
| [[L031](#l031---missing-checks-for-address0x0-when-updating-address-state-variables)] | Missing checks for address(0x0) when updating address state variables | 17 |
| [[L032](#l032---the-additionsmultiplications-may-silently-overflow-because-theyre-in-unchecked-blocks-with-no-preceding-value-checks-which-may-lead-to-unexpected-results)] | The additions/multiplications may silently overflow because they're in unchecked blocks with no preceding value checks, which may lead to unexpected results. | 45 |


### Non-critical Issues

| |Issue|Instances|
|-|:-|:-:|
| [[NC001](#nc001---empty-bytes-check-is-missing)] | Empty bytes check is missing | 75 |
| [[NC002](#nc002---the-nonreentrant-modifier-should-occur-before-all-other-modifiers)] | The `nonReentrant` `modifier` should occur before all other modifiers | 2 |
| [[NC003](#nc003---requirerevert-statements-should-have-descriptive-reason-strings)] | `require()`/`revert()` statements should have descriptive reason strings | 5 |
| [[NC004](#nc004---avoid-mutating-function-parameters)] | Avoid mutating function parameters | 2 |
| [[NC005](#nc005---event-is-not-properly-indexed)] | Event is not properly indexed | 4 |
| [[NC006](#nc006---function-ordering-does-not-follow-the-solidity-style-guide)] | Function ordering does not follow the Solidity style guide | 41 |
| [[NC007](#nc007---imports-could-be-organized-more-systematically)] | Imports could be organized more systematically | 20 |
| [[NC008](#nc008---constants-in-comparisons-should-appear-on-the-left-side)] | Constants in comparisons should appear on the left side | 145 |
| [[NC009](#nc009---else-block-not-required)] | else-block not required | 3 |
| [[NC010](#nc010---events-may-be-emitted-out-of-order-due-to-reentrancy)] | Events may be emitted out of order due to reentrancy | 2 |
| [[NC011](#nc011---if-statement-can-be-converted-to-a-ternary)] | If-statement can be converted to a ternary | 1 |
| [[NC012](#nc012---import-declarations-should-import-specific-identifiers-rather-than-the-whole-file)] | Import declarations should import specific identifiers, rather than the whole file | 2 |
| [[NC013](#nc013---adding-a-return-statement-when-the-function-defines-a-named-return-variable-is-redundant)] | Adding a return statement when the function defines a named return variable, is redundant | 2 |
| [[NC014](#nc014---public-functions-not-called-by-the-contract-should-be-declared-external-instead)] | Public functions not called by the contract should be declared external instead | 11 |
| [[NC015](#nc015---2n---1-should-be-re-written-as-typeuintnmax)] | `2**<n> - 1` should be re-written as `type(uint<n>).max` | 4 |
| [[NC016](#nc016---constant-redefined-elsewhere)] | Constant redefined elsewhere | 5 |
| [[NC017](#nc017---defining-all-externalpublic-functions-in-contract-interfaces)] | Defining All External/Public Functions in Contract Interfaces | 4 |
| [[NC018](#nc018---avoid-defining-a-function-in-a-single-line-including-its-contents)] | Avoid defining a function in a single line including it's contents | 8 |
| [[NC019](#nc019---use-a-struct-to-encapsulate-multiple-function-parameters)] | Use a struct to encapsulate multiple function parameters | 55 |
| [[NC020](#nc020---consider-only-defining-one-libraryinterfacecontract-per-sol-file)] | Consider only defining one library/interface/contract per sol file | 2 |
| [[NC021](#nc021---contracts-with-only-unimplemented-functions-can-be-labeled-as-abstract)] | Contracts with only unimplemented functions can be labeled as abstract | 1 |
| [[NC022](#nc022---variable-names-for-immutables-should-use-constant_case)] | Variable names for `immutable`s should use CONSTANT_CASE | 5 |
| [[NC023](#nc023---it-is-best-practice-to-use-linear-inheritance)] | It is best practice to use linear inheritance | 21 |
| [[NC024](#nc024---file-is-missing-natspec-comments)] | File is missing NatSpec comments | 24 |
| [[NC025](#nc025---function-declarations-should-have-natspec-descriptions)] | Function declarations should have NatSpec descriptions | 200 |
| [[NC026](#nc026---contract-declarations-should-have-notice-tags)] | Contract declarations should have `@notice` tags | 92 |
| [[NC027](#nc027---contract-does-not-follow-the-solidity-style-guides-suggested-layout-ordering)] | Contract does not follow the Solidity style guide's suggested layout ordering | 16 |
| [[NC028](#nc028---non-externalpublic-variable-names-should-begin-with-an-underscore)] | Non-external/public variable names should begin with an underscore | 28 |
| [[NC029](#nc029---unused-file)] | Unused file | 7 |
| [[NC030](#nc030---not-using-the-named-return-variables-anywhere-in-the-function-is-confusing)] | Not using the named return variables anywhere in the function is confusing | 4 |
| [[NC031](#nc031---unused-arguments-in-override-functions)] | Unused arguments in override functions | 1 |
| [[NC032](#nc032---expressions-for-constant-values-such-as-a-call-to-keccak256-should-use-immutable-rather-than-constant)] | Expressions for constant values such as a call to `keccak256()`, should use `immutable` rather than `constant` | 4 |
| [[NC033](#nc033---empty-function-body---consider-commenting-why)] | Empty Function Body - Consider commenting why | 4 |
| [[NC034](#nc034---contracts-should-have-full-test-coverage)] | Contracts should have full test coverage | 1 |
| [[NC035](#nc035---a-event-should-be-emitted-if-a-non-immutable-state-variable-is-set-in-a-constructor)] | A event should be emitted if a non immutable state variable is set in a constructor | 1 |
| [[NC036](#nc036---missing-events-in-sensitive-functions)] | Missing events in sensitive functions | 17 |
| [[NC037](#nc037---functions-should-have-natspec-param-annotations)] | Functions should have Natspec @param annotations | 285 |
| [[NC038](#nc038---consider-using-blocknumber-instead-of-blocktimestamp)] | Consider using `block.number` instead of `block.timestamp` | 11 |
| [[NC039](#nc039---consider-bounding-input-array-length)] | Consider bounding input array length | 16 |
| [[NC040](#nc040---large-numeric-literals-should-use-underscores-for-readability)] | Large numeric literals should use underscores for readability | 3 |
| [[NC041](#nc041---cast-to-bytes-or-bytes32-for-clearer-semantic-meaning)] | Cast to `bytes` or `bytes32` for clearer semantic meaning | 2 |
| [[NC042](#nc042---variables-should-be-named-in-mixedcase-style)] | Variables should be named in mixedCase style | 13 |
| [[NC043](#nc043---consider-using-named-mappings)] | Consider using named mappings | 14 |
| [[NC044](#nc044---use-allowlistdenylist-rather-than-whitelistblacklist)] | Use allowlist/denylist rather than whitelist/blacklist | 66 |
| [[NC045](#nc045---contracts-containing-only-utility-functions-should-be-made-into-libraries)] | Contracts containing only utility functions should be made into libraries | 2 |
| [[NC046](#nc046---function-names-should-use-lowercamelcase)] | Function names should use lowerCamelCase | 13 |
| [[NC047](#nc047---consider-adding-a-deny-list)] | Consider adding a deny-list | 33 |
| [[NC049](#nc049---top-level-declarations-should-be-separated-by-two-blank-lines)] | Top level declarations should be separated by two blank lines | 7 |
| [[NC050](#nc050---duplicate-import-statements)] | Duplicate import statements | 3 |
| [[NC051](#nc051---contract-uses-both-requirerevert-as-well-as-custom-errors)] | Contract uses both `require()`/`revert()` as well as custom errors | 1 |
| [[NC052](#nc052---functions-should-have-natspec-return-annotations)] | Functions should have Natspec @return annotations | 274 || [[NC053](#nc053---overridden-function-has-no-body)] | Overridden function has no body | 1 |
| [[NC054](#nc054---consider-moving-msgsender-checks-to-a-common-authorization-modifier)] | Consider moving `msg.sender` checks to a common authorization `modifier` | 13 |
| [[NC055](#nc055---unused-struct-definition)] | Unused `struct` definition | 1 |
| [[NC056](#nc056---events-are-missing-sender-information)] | Events are missing sender information | 44 |
| [[NC057](#nc057---enum-values-should-be-used-in-place-of-constant-array-indexes)] | Enum values should be used in place of constant array indexes | 41 |
| [[NC058](#nc058---zero-as-a-function-argument-should-have-a-descriptive-meaning)] | Zero as a function argument should have a descriptive meaning | 114 |
| [[NC059](#nc059---function-names-should-differ-to-make-the-code-more-readable)] | Function names should differ to make the code more readable | 480 |
| [[NC060](#nc060---use-eip-5627-to-describe-eip-712-domains)] | Use EIP-5627 to describe EIP-712 domains | 1 |
| [[NC061](#nc061---it-is-standard-for-all-external-and-public-functions-to-be-override-from-an-interface)] | It is standard for all external and public functions to be override from an interface | 243 |
| [[NC062](#nc062---consider-adding-formal-verification-proofs)] | Consider adding formal verification proofs | 1 |
| [[NC063](#nc063---assembly-code-blocks-should-be-thoroughly-commented)] | Assembly code blocks should be thoroughly commented | 71 |
| [[NC064](#nc064---common-functions-should-be-refactored-to-a-common-base-contract)] | Common functions should be refactored to a common base contract | 34 |
| [[NC065](#nc065---polymorphic-functions-make-security-audits-more-time-consuming-and-error-prone)] | Polymorphic functions make security audits more time-consuming and error-prone | 2 |
| [[NC066](#nc066---error-messages-should-descriptive-rather-that-cryptic)] | Error messages should descriptive, rather that cryptic | 96 |
| [[NC067](#nc067---missing-timelock-for-critical-parameter-change)] | Missing timelock for critical parameter change | 14 |
| [[NC068](#nc068---setters-should-prevent-re-setting-of-the-same-value)] | Setters should prevent re-setting of the same value | 29 |
| [[NC069](#nc069---consider-splitting-long-calculations)] | Consider splitting long calculations | 6 |
| [[NC070](#nc070---high-cyclomatic-complexity)] | High cyclomatic complexity | 1 |
| [[NC071](#nc071---use-of-override-is-unnecessary)] | Use of override is unnecessary | 54 |
| [[NC072](#nc072---non-externalpublic-function-names-should-begin-with-an-underscore)] | Non-`external`/`public` function names should begin with an underscore | 5 |
| [[NC073](#nc073---unused-import)] | Unused import | 38 |
| [[NC074](#nc074---state-variable-declarations-should-have-natspec-dev-annotations)] | State variable declarations should have Natspec @dev annotations | 48 |
| [[NC075](#nc075---unused-function-parameter)] | Unused function parameter | 1 |
| [[NC076](#nc076---put-all-system-wide-constants-in-one-file)] | Put all system-wide constants in one file | 5 |
| [[NC077](#nc077---add-inline-comments-for-unnamed-variables)] | Add inline comments for unnamed variables | 13 |
| [[NC078](#nc078---consider-adding-emergency-stop-functionality)] | Consider adding emergency-stop functionality | 5 |
| [[NC079](#nc079---named-imports-of-parent-contracts-are-missing)] | Named imports of parent contracts are missing | 4 |
| [[NC080](#nc080---use-bytesconcat-on-bytes-instead-of-abiencodepacked-for-clearer-semantic-meaning)] | Use `bytes.concat()` on bytes instead of `abi.encodePacked()` for clearer semantic meaning | 5 |
| [[NC081](#nc081---consider-using-safetransferlibsafetransfereth-or-addresssendvalue-for-clearer-semantic-meaning)] | Consider using `SafeTransferLib.safeTransferETH()` or `Address.sendValue()` for clearer semantic meaning | 1 |
| [[NC082](#nc082---style-guide-state-and-local-variables-should-be-named-using-lowercamelcase)] | Style guide: State and local variables should be named using lowerCamelCase | 3 |
| [[NC083](#nc083---pure-function-accesses-storage)] | Pure function accesses storage | 1 |
| [[NC084](#nc084---unnecessary-cast)] | Unnecessary cast | 5 |
| [[NC085](#nc085---unusual-loop-variable)] | Unusual loop variable | 1 |
| [[NC086](#nc086---use-the-latest-solidity-prior-to-0820-if-on-l2s-for-deployment)] | Use the latest solidity (prior to 0.8.20 if on L2s) for deployment | 1 |
| [[NC087](#nc087---events-should-use-parameters-to-convey-information)] | Events should use parameters to convey information | 2 |
| [[NC088](#nc088---state-variable-declarations-should-have-natspec-notice-annotations)] | State variable declarations should have Natspec @notice annotations | 67 |
| [[NC089](#nc089---use-bit-shifts-in-an-imutable-variable-rather-than-long-bit-masks-of-a-single-bit-for-readability)] | Use bit shifts in an imutable variable rather than long bit masks of a single bit, for readability | 1 |
| [[NC090](#nc090---event-declarations-should-have-natspec-param-annotations)] | Event declarations should have NatSpec @param annotations | 62 |
| [[NC091](#nc091---event-declarations-should-have-natspec-dev-annotations)] | Event declarations should have NatSpec @dev annotations | 62 |
| [[NC092](#nc092---function-definitions-should-have-natspec-dev-annotations)] | Function definitions should have NatSpec @dev annotations | 516 |
| [[NC093](#nc093---function-definitions-should-have-natspec-notice-annotations)] | Function definitions should have NatSpec @notice annotations | 451 |
| [[NC094](#nc094---interface-declarations-should-have-natspec-title-annotations)] | Interface declarations should have NatSpec @title annotations | 36 |
| [[NC095](#nc095---interface-declarations-should-have-natspec-author-annotations)] | Interface declarations should have NatSpec @author annotations | 18 |
| [[NC096](#nc096---interface-declarations-should-have-natspec-notice-annotations)] | Interface declarations should have NatSpec @notice annotations | 32 |
| [[NC097](#nc097---interface-declarations-should-have-natspec-dev-annotations)] | Interface declarations should have NatSpec @dev annotations | 41 |
| [[NC098](#nc098---abstract-contract-declarations-should-have-natspec-title-annotations)] | Abstract contract declarations should have NatSpec @title annotations | 4 |
| [[NC099](#nc099---abstract-contract-declarations-should-have-natspec-author-annotations)] | Abstract contract declarations should have NatSpec @author annotations | 1 |
| [[NC100](#nc100---abstract-contract-declarations-should-have-natspec-notice-annotations)] | Abstract contract declarations should have NatSpec @notice annotations | 1 |
| [[NC101](#nc101---abstract-contract-declarations-should-have-natspec-dev-annotations)] | Abstract contract declarations should have Natspec @dev annotations | 2 |
| [[NC102](#nc102---library-declarations-should-have-natspec-title-annotations)] | Library declarations should have Natspec @title annotations | 19 |
| [[NC103](#nc103---library-declarations-should-have-natspec-author-annotations)] | Library declarations should have Natspec @author annotations | 4 |
| [[NC104](#nc104---library-declarations-should-have-natspec-notice-annotations)] | Library declarations should have Natspec @notice annotations | 9 |
| [[NC105](#nc105---library-declarations-should-have-natspec-dev-annotations)] | Library declarations should have Natspec @dev annotations | 11 |
| [[NC106](#nc106---modifier-definitions-should-have-natspec-notice-annotations)] | Modifier definitions should have Natspec @notice annotations | 15 |
| [[NC107](#nc107---modifier-definitions-should-have-natspec-dev-annotations)] | Modifier definitions should have Natspec @dev annotations | 29 |
| [[NC108](#nc108---contract-definitions-should-have-natspec-title-annotations)] | Contract definitions should have Natspec @title annotations | 27 |
| [[NC109](#nc109---contract-definitions-should-have-natspec-author-annotations)] | Contract definitions should have Natspec @author annotations | 2 |
| [[NC110](#nc110---contract-definitions-should-have-natspec-notice-annotations)] | Contract definitions should have Natspec @notice annotations | 12 |
| [[NC111](#nc111---contract-definitions-should-have-natspec-dev-annotations)] | Contract definitions should have Natspec @dev annotations | 18 |
| [[NC112](#nc112---event-definitions-should-have-natspec-notice-annotations)] | Event definitions should have Natspec @notice annotations | 34 |


## L001 - `abi.encodePacked()` should not be used with dynamic types when passing the result to a hash function such as `keccak256()`:

Use `abi.encode()` instead which will pad items to 32 bytes, which will [prevent hash collisions](https://docs.soliditylang.org/en/v0.8.13/abi-spec.html#non-standard-packed-mode) (e.g. `abi.encodePacked(0x123,0x456)` => `0x123456` => `abi.encodePacked(0x1,0x23456)`, but `abi.encode(0x123,0x456)` => `0x0...1230...456`). Unless there is a compelling reason, `abi.encode` should be preferred. If there is only one argument to `abi.encodePacked()` it can often be cast to `bytes()` or `bytes32()` [instead](https://ethereum.stackexchange.com/questions/30912/how-to-compare-strings-in-solidity#answer-82739). If all arguments are strings and or bytes, `bytes.concat()` should be used instead.


<details>
<summary>Click to show 5 findings</summary>

```solidity
File: system-contracts/contracts/SystemContext.sol


// that's why the legacy L2 blocks' hashes are keccak256(abi.encodePacked(uint32(_block))), while these are equivalent to

// keccak256(abi.encodePacked(_block))

return keccak256(abi.encodePacked(uint32(_blockNumber)));

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L234:234

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


keccak256(abi.encodePacked(_transaction.factoryDeps)),

return keccak256(abi.encodePacked("\x19\x01", domainSeparator, structHash));

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L142:142

</details>

## L002 - `safeApprove` is Deprecated:

`safeApprove` is deprecated in favor of `safeIncreaseAllowance` and `safeDecreaseAllowance`.


<details>
<summary>Click to show 4 findings</summary>

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


IERC20(token).safeApprove(paymaster, 0);

IERC20(token).safeApprove(paymaster, minAllowance);

IERC20(token).safeApprove(paymaster, 0);

IERC20(token).safeApprove(paymaster, minAllowance);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L383:383

</details>

## L003 - `_setupRole` is Deprecated:

`_setupRole` is deprecated in favor of `grantRole` and `renounceRole`.


<details>
<summary>Click to show 4 findings</summary>

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


IERC20(token).safeApprove(paymaster, 0);

IERC20(token).safeApprove(paymaster, minAllowance);

IERC20(token).safeApprove(paymaster, 0);

IERC20(token).safeApprove(paymaster, minAllowance);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L383:383

</details>


## L004 - External calls in modifiers should be avoided:

Using external calls within modifiers can introduce reentrancy risks and make a contract's logic less transparent. Modifiers are meant for pre-execution checks, and external calls can lead to unpredictable flow and potential reentrancy issues. Avoiding external calls in modifiers and placing them directly in the function body enhances code clarity, aids in auditing, and minimizes unexpected behaviors. This practice ensures a more explicit execution order and clearer understanding of the code's effects.


```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


62              require(msg.sender == stateTransitionManager.getChainAdmin(_chainId), "ValidatorTimelock: only chain admin");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L62:62



## L005 - Array lengths not checked:

If the length of the arrays are not required to be of the same length, user operations may not be fully executed due to a mismatch in the number of items iterated over, versus the number of items provided in the second array.


```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


500         function _createBatchCommitment(
501             CommitBatchInfo calldata _newBatchData,
502             bytes32 _stateDiffHash,
503             bytes32[] memory _blobCommitments,
504             bytes32[] memory _blobHashes
505         ) internal view returns (bytes32) {
506             bytes32 passThroughDataHash = keccak256(_batchPassThroughData(_newBatchData));
507             bytes32 metadataHash = keccak256(_batchMetaParameters());
508             bytes32 auxiliaryOutputHash = keccak256(
509                 _batchAuxiliaryOutput(_newBatchData, _stateDiffHash, _blobCommitments, _blobHashes)
510             );
511     
512             return keccak256(abi.encode(passThroughDataHash, metadataHash, auxiliaryOutputHash));
513         }


537         function _batchAuxiliaryOutput(
538             CommitBatchInfo calldata _batch,
539             bytes32 _stateDiffHash,
540             bytes32[] memory _blobCommitments,
541             bytes32[] memory _blobHashes
542         ) internal pure returns (bytes memory) {
543             require(_batch.systemLogs.length <= MAX_L2_TO_L1_LOGS_COMMITMENT_BYTES, "pu");
544     
545             bytes32 l2ToL1LogsHash = keccak256(_batch.systemLogs);
546     
547             return
548                 abi.encodePacked(
549                     l2ToL1LogsHash,
550                     _stateDiffHash,
551                     _batch.bootloaderHeapInitialContentsHash,
552                     _batch.eventsQueueStateHash,
553                     _encodeBlobAuxilaryOutput(_blobCommitments, _blobHashes)
554                 );
555         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L537:555



## L006 - Missing checks for `address(0x0)` when assigning values to address state variables:

This issue arises when an address state variable is assigned a value without a preceding check to ensure it isn't address(0x0). This can lead to unexpected behavior as address(0x0) often represents an uninitialized address.


<details>
<summary>Click to show 6 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


55              pendingAdmin = _newPendingAdmin;


109             sharedBridge = IL1SharedBridge(_sharedBridge);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L109:109

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


258             securityCouncil = _newSecurityCouncil;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L258:258

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


114             pendingAdmin = _newPendingAdmin;


133             validatorTimelock = _validatorTimelock;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L133:133

```solidity
File: system-contracts/contracts/SystemContext.sol


100             origin = _newOrigin;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L100:100

</details>

## L007 - Upgradeable contract is missing a __gap[50] storage variable to allow for new storage variables in later versions:

This issue arises when an upgradeable contract doesn't include a __gap[50] storage variable. This variable is crucial for facilitating future upgrades and preserving storage layout.


<details>
<summary>Click to show 4 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


30      contract L1SharedBridge is IL1SharedBridge, ReentrancyGuard, Initializable, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L30:30

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


23      contract L2SharedBridge is IL2SharedBridge, Initializable {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L23:23

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


15      contract L2StandardERC20 is ERC20PermitUpgradeable, IL2StandardToken, ERC1967Upgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L15:15

```solidity
File: system-contracts/contracts/libraries/SystemContractHelper.sol


41      library SystemContractHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L41:41

</details>

## L008 - Unsafe downcast:

When a type is downcast to a smaller type, the higher order bits are truncated, effectively applying a modulo to the original value. Without any other checks, this wrapping will lead to unexpected behavior and bugs.


<details>
<summary>Click to show 30 findings</summary>

```solidity
File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol


71              return address(uint160(uint256(data)));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L71:71

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


134                 uint32 timestamp = uint32(block.timestamp);


115                 uint32 timestamp = uint32(block.timestamp);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L115:115

```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


112             return address(uint160(uint256(data)));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L112:112

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


30              return uint32(_x);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L30:30

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


92              address account = address(uint160(_input));


120             address account = address(uint160(_input));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L120:120

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


259                 uint64 txDataLen = uint64(_transaction.data.length);


164                 uint64 txDataLen = uint64(_transaction.data.length);


68                  uint64 txDataLen = uint64(_transaction.data.length);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L68:68

```solidity
File: system-contracts/contracts/ContractDeployer.sol


125             newAddress = address(uint160(uint256(hash)));


109             newAddress = address(uint160(uint256(hash)));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L109:109

```solidity
File: system-contracts/contracts/L2BaseToken.sol


57              return balance[address(uint160(_account))];


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L57:57

```solidity
File: system-contracts/contracts/SystemContext.sol


234             return keccak256(abi.encodePacked(uint32(_blockNumber)));


476             BlockInfo memory newBlockInfo = BlockInfo({number: uint128(_number), timestamp: uint128(_newTimestamp)});


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L476:476

```solidity
File: system-contracts/contracts/libraries/RLPEncoder.sol


69                      encoded[0] = bytes1(uint8(_offset + hbs + 56));


64                      encoded[0] = bytes1(uint8(_len + _offset));


29                      encoded[0] = (_val == 0) ? bytes1(uint8(128)) : bytes1(uint8(_val));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L29:29

```solidity
File: system-contracts/contracts/libraries/SystemContractHelper.sol


247             auxHeapSize = uint32(extractNumberFromMeta(meta, META_AUX_HEAP_SIZE_OFFSET, 32));


238             heapSize = uint32(extractNumberFromMeta(meta, META_HEAP_SIZE_OFFSET, 32));


228             pubdataPublished = uint32(extractNumberFromMeta(meta, META_GAS_PER_PUBDATA_BYTE_OFFSET, 32));


264             callerShardId = uint8(extractNumberFromMeta(meta, META_CALLER_SHARD_ID_OFFSET, 8));


273             codeShardId = uint8(extractNumberFromMeta(meta, META_CODE_SHARD_ID_OFFSET, 8));


255             shardId = uint8(extractNumberFromMeta(meta, META_SHARD_ID_OFFSET, 8));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L255:255

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


321                 uint64 txDataLen = uint64(_transaction.data.length);


171                 uint64 txDataLen = uint64(_transaction.data.length);


249                 uint64 txDataLen = uint64(_transaction.data.length);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L249:249

```solidity
File: system-contracts/contracts/libraries/Utils.sol


23              return uint128(_x);


29              return uint32(_x);


35              return uint24(_x);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L35:35

</details>


## L009 - Array does not have a `pop` function:

Arrays without the pop operation in Solidity can lead to inefficient memory management and increase the likelihood of out-of-gas errors.


```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


196                 ds.facets.push(_facet);


223             ds.facetToSelectors[_facet].selectors.push(_selector);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L223:223

## L010 - Setters should have initial value check:

Setters should have initial value check to prevent assigning wrong value to the variable. Assginment of wrong value can lead to unexpected behavior of the contract.


<details>
<summary>Click to show 28 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


51          function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin {
52              // Save previous value into the stack to put it into the event later
53              address oldPendingAdmin = pendingAdmin;
54              // Change pending admin
55              pendingAdmin = _newPendingAdmin;
56              emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
57          }


108         function setSharedBridge(address _sharedBridge) external onlyOwner {
109             sharedBridge = IL1SharedBridge(_sharedBridge);
110         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L108:110

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


110         function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin {
111             // Save previous value into the stack to put it into the event later
112             address oldPendingAdmin = pendingAdmin;
113             // Change pending admin
114             pendingAdmin = _newPendingAdmin;
115             emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
116         }


132         function setValidatorTimelock(address _validatorTimelock) external onlyOwnerOrAdmin {
133             validatorTimelock = _validatorTimelock;
134         }


137         function setInitialCutHash(Diamond.DiamondCutData calldata _diamondCut) external onlyOwner {
138             initialCutHash = keccak256(abi.encode(_diamondCut));
139         }


142         function setNewVersionUpgrade(
143             Diamond.DiamondCutData calldata _cutData,
144             uint256 _oldProtocolVersion,
145             uint256 _newProtocolVersion
146         ) external onlyOwner {
147             upgradeCutHash[_oldProtocolVersion] = keccak256(abi.encode(_cutData));
148             protocolVersion = _newProtocolVersion;
149         }


152         function setUpgradeDiamondCut(
153             Diamond.DiamondCutData calldata _cutData,
154             uint256 _oldProtocolVersion
155         ) external onlyOwner {
156             upgradeCutHash[_oldProtocolVersion] = keccak256(abi.encode(_cutData));
157         }


177         function _setChainIdUpgrade(uint256 _chainId, address _chainContract) internal {
178             bytes memory systemContextCalldata = abi.encodeCall(ISystemContext.setChainId, (_chainId));
179             uint256[] memory uintEmptyArray;
180             bytes[] memory bytesEmptyArray;
181     
182             L2CanonicalTransaction memory l2ProtocolUpgradeTx = L2CanonicalTransaction({
183                 txType: SYSTEM_UPGRADE_L2_TX_TYPE,
184                 from: uint256(uint160(L2_FORCE_DEPLOYER_ADDR)),
185                 to: uint256(uint160(L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR)),
186                 gasLimit: $(PRIORITY_TX_MAX_GAS_LIMIT),
187                 gasPerPubdataByteLimit: REQUIRED_L2_GAS_PRICE_PER_PUBDATA,
188                 maxFeePerGas: uint256(0),
189                 maxPriorityFeePerGas: uint256(0),
190                 paymaster: uint256(0),
191                 // Note, that the priority operation id is used as "nonce" for L1->L2 transactions
192                 nonce: protocolVersion,
193                 value: 0,
194                 reserved: [uint256(0), 0, 0, 0],
195                 data: systemContextCalldata,
196                 signature: new bytes(0),
197                 factoryDeps: uintEmptyArray,
198                 paymasterInput: new bytes(0),
199                 reservedDynamic: new bytes(0)
200             });
201     
202             ProposedUpgrade memory proposedUpgrade = ProposedUpgrade({
203                 l2ProtocolUpgradeTx: l2ProtocolUpgradeTx,
204                 factoryDeps: bytesEmptyArray,
205                 bootloaderHash: bytes32(0),
206                 defaultAccountHash: bytes32(0),
207                 verifier: address(0),
208                 verifierParams: VerifierParams({
209                     recursionNodeLevelVkHash: bytes32(0),
210                     recursionLeafLevelVkHash: bytes32(0),
211                     recursionCircuitsSetVksHash: bytes32(0)
212                 }),
213                 l1ContractsUpgradeCalldata: new bytes(0),
214                 postUpgradeCalldata: new bytes(0),
215                 upgradeTimestamp: 0,
216                 newProtocolVersion: protocolVersion
217             });
218     
219             Diamond.FacetCut[] memory emptyArray;
220             Diamond.DiamondCutData memory cutData = Diamond.DiamondCutData({
221                 facetCuts: emptyArray,
222                 initAddress: genesisUpgrade,
223                 initCalldata: abi.encodeCall(IDefaultUpgrade.upgrade, (proposedUpgrade))
224             });
225     
226             IAdmin(_chainContract).executeUpgrade(cutData);
227             emit SetChainIdUpgrade(_chainContract, l2ProtocolUpgradeTx, protocolVersion);
228         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L177:228

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


73          function setStateTransitionManager(IStateTransitionManager _stateTransitionManager) external onlyOwner {
74              stateTransitionManager = _stateTransitionManager;
75          }


96          function setExecutionDelay(uint32 _executionDelay) external onlyOwner {
97              executionDelay = _executionDelay;
98              emit NewExecutionDelay(_executionDelay);
99          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L96:99

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


23          function setPendingAdmin(address _newPendingAdmin) external onlyAdmin {
24              // Save previous value into the stack to put it into the event later
25              address oldPendingAdmin = s.pendingAdmin;
26              // Change pending admin
27              s.pendingAdmin = _newPendingAdmin;
28              emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
29          }


45          function setValidator(address _validator, bool _active) external onlyStateTransitionManager {
46              s.validators[_validator] = _active;
47              emit ValidatorStatusUpdate(_validator, _active);
48          }


51          function setPorterAvailability(bool _zkPorterIsAvailable) external onlyStateTransitionManager {
52              // Change the porter availability
53              s.zkPorterIsAvailable = _zkPorterIsAvailable;
54              emit IsPorterAvailableStatusUpdate(_zkPorterIsAvailable);
55          }


58          function setPriorityTxMaxGasLimit(uint256 _newPriorityTxMaxGasLimit) external onlyStateTransitionManager {
59              require(_newPriorityTxMaxGasLimit <= MAX_GAS_PER_TRANSACTION, "n5");
60      
61              uint256 oldPriorityTxMaxGasLimit = s.priorityTxMaxGasLimit;
62              s.priorityTxMaxGasLimit = _newPriorityTxMaxGasLimit;
63              emit NewPriorityTxMaxGasLimit(oldPriorityTxMaxGasLimit, _newPriorityTxMaxGasLimit);
64          }


79          function setTokenMultiplier(uint128 _nominator, uint128 _denominator) external onlyAdminOrStateTransitionManager {
80              uint128 oldNominator = s.baseTokenGasPriceMultiplierNominator;
81              uint128 oldDenominator = s.baseTokenGasPriceMultiplierDenominator;
82      
83              s.baseTokenGasPriceMultiplierNominator = _nominator;
84              s.baseTokenGasPriceMultiplierDenominator = _denominator;
85      
86              emit NewBaseTokenMultiplier(oldNominator, oldDenominator, _nominator, _denominator);
87          }


89          function setValidiumMode(PubdataPricingMode _validiumMode) external onlyAdmin {
90              require(s.totalBatchesCommitted == 0, "AdminFacet: set validium only after genesis"); // Validium mode can be set only before the first batch is committed
91              s.feeParams.pubdataPricingMode = _validiumMode;
92              emit ValidiumModeStatusUpdate(_validiumMode);
93          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L89:93

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


597         function _setBit(uint256 _bitMap, uint8 _index) internal pure returns (uint256) {
598             return _bitMap | (1 << _index);
599         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L597:599

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


34          function setImmutables(address _dest, ImmutableData[] calldata _immutables) external override {
35              require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract");
36              unchecked {
37                  uint256 immutablesLength = _immutables.length;
38                  for (uint256 i = 0; i < immutablesLength; ++i) {
39                      uint256 index = _immutables[i].index;
40                      bytes32 value = _immutables[i].value;
41                      immutableDataStorage[uint256(uint160(_dest))][index] = value;
42                  }
43              }
44          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L34:44

```solidity
File: system-contracts/contracts/NonceHolder.sol


82          function setValueUnderNonce(uint256 _key, uint256 _value) public onlySystemCall {
83              IContractDeployer.AccountInfo memory accountInfo = DEPLOYER_SYSTEM_CONTRACT.getAccountInfo(msg.sender);
84      
85              require(_value != 0, "Nonce value cannot be set to 0");
86              // If an account has sequential nonce ordering, we enforce that the previous
87              // nonce has already been used.
88              if (accountInfo.nonceOrdering == IContractDeployer.AccountNonceOrdering.Sequential && _key != 0) {
89                  require(isNonceUsed(msg.sender, _key - 1), "Previous nonce has not been used");
90              }
91      
92              uint256 addressAsKey = uint256(uint160(msg.sender));
93      
94              nonceValues[addressAsKey][_key] = _value;
95      
96              emit ValueSetUnderNonce(msg.sender, _key, _value);
97          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L82:97

```solidity
File: system-contracts/contracts/SystemContext.sol


84          function setChainId(uint256 _newChainId) external onlyCallFromForceDeployer {
85              chainId = _newChainId;
86          }


99          function setTxOrigin(address _newOrigin) external onlyCallFromBootloader {
100             origin = _newOrigin;
101         }


105         function setGasPrice(uint256 _gasPrice) external onlyCallFromBootloader {
106             gasPrice = _gasPrice;
107         }


112         function setPubdataInfo(uint256 _gasPerPubdataByte, uint256 _basePubdataSpent) external onlyCallFromBootloader {
113             basePubdataSpent = _basePubdataSpent;
114             gasPerPubdataByte = _gasPerPubdataByte;
115         }


212         function _setL2BlockHash(uint256 _block, bytes32 _hash) internal {
213             l2BlockHash[_block % MINIBLOCK_HASHES_TO_STORE] = _hash;
214         }


263         function _setVirtualBlock(
264             uint128 _l2BlockNumber,
265             uint128 _maxVirtualBlocksToCreate,
266             uint128 _newTimestamp
267         ) internal {
268             if (virtualBlockUpgradeInfo.virtualBlockFinishL2Block != 0) {
269                 // No need to to do anything about virtual blocks anymore
270                 // All the info is the same as for L2 blocks.
271                 currentVirtualL2BlockInfo = currentL2BlockInfo;
272                 return;
273             }
274     
275             BlockInfo memory virtualBlockInfo = currentVirtualL2BlockInfo;
276     
277             if (currentVirtualL2BlockInfo.number == 0 && virtualBlockInfo.timestamp == 0) {
278                 uint128 currentBatchNumber = currentBatchInfo.number;
279     
280                 // The virtual block is set for the first time. We can count it as 1 creation of a virtual block.
281                 // Note, that when setting the virtual block number we use the batch number to make a smoother upgrade from batch number to
282                 // the L2 block number.
283                 virtualBlockInfo.number = currentBatchNumber;
284                 // Remembering the batch number on which the upgrade to the virtual blocks has been done.
285                 virtualBlockUpgradeInfo.virtualBlockStartBatch = currentBatchNumber;
286     
287                 require(_maxVirtualBlocksToCreate > 0, "Can't initialize the first virtual block");
288                 _maxVirtualBlocksToCreate -= 1;
289             } else if (_maxVirtualBlocksToCreate == 0) {
290                 // The virtual blocks have been already initialized, but the operator didn't ask to create
291                 // any new virtual blocks. So we can just return.
292                 return;
293             }
294     
295             virtualBlockInfo.number += _maxVirtualBlocksToCreate;
296             virtualBlockInfo.timestamp = _newTimestamp;
297     
298             // The virtual block number must never exceed the L2 block number.
299             // We do not use a `require` here, since the virtual blocks are a temporary solution to let the Solidity's `block.number`
300             // catch up with the L2 block number and so the situation where virtualBlockInfo.number starts getting larger
301             // than _l2BlockNumber is expected once virtual blocks have caught up the L2 blocks.
302             if (virtualBlockInfo.number >= _l2BlockNumber) {
303                 virtualBlockUpgradeInfo.virtualBlockFinishL2Block = _l2BlockNumber;
304                 virtualBlockInfo.number = _l2BlockNumber;
305             }
306     
307             currentVirtualL2BlockInfo = virtualBlockInfo;
308         }


314         function _setNewL2BlockData(uint128 _l2BlockNumber, uint128 _l2BlockTimestamp, bytes32 _prevL2BlockHash) internal {
315             // In the unsafe version we do not check that the block data is correct
316             currentL2BlockInfo = BlockInfo({number: _l2BlockNumber, timestamp: _l2BlockTimestamp});
317     
318             // It is always assumed in production that _l2BlockNumber > 0
319             _setL2BlockHash(_l2BlockNumber - 1, _prevL2BlockHash);
320     
321             // Reseting the rolling hash
322             currentL2BlockTxsRollingHash = bytes32(0);
323         }


341         function setL2Block(
342             uint128 _l2BlockNumber,
343             uint128 _l2BlockTimestamp,
344             bytes32 _expectedPrevL2BlockHash,
345             bool _isFirstInBatch,
346             uint128 _maxVirtualBlocksToCreate
347         ) external onlyCallFromBootloader {
348             // We check that the timestamp of the L2 block is consistent with the timestamp of the batch.
349             if (_isFirstInBatch) {
350                 uint128 currentBatchTimestamp = currentBatchInfo.timestamp;
351                 require(
352                     _l2BlockTimestamp >= currentBatchTimestamp,
353                     "The timestamp of the L2 block must be greater than or equal to the timestamp of the current batch"
354                 );
355                 require(_maxVirtualBlocksToCreate > 0, "There must be a virtual block created at the start of the batch");
356             }
357     
358             (uint128 currentL2BlockNumber, uint128 currentL2BlockTimestamp) = getL2BlockNumberAndTimestamp();
359     
360             if (currentL2BlockNumber == 0 && currentL2BlockTimestamp == 0) {
361                 // Since currentL2BlockNumber and currentL2BlockTimestamp are zero it means that it is
362                 // the first ever batch with L2 blocks, so we need to initialize those.
363                 _upgradeL2Blocks(_l2BlockNumber, _expectedPrevL2BlockHash, _isFirstInBatch);
364     
365                 _setNewL2BlockData(_l2BlockNumber, _l2BlockTimestamp, _expectedPrevL2BlockHash);
366             } else if (currentL2BlockNumber == _l2BlockNumber) {
367                 require(!_isFirstInBatch, "Can not reuse L2 block number from the previous batch");
368                 require(currentL2BlockTimestamp == _l2BlockTimestamp, "The timestamp of the same L2 block must be same");
369                 require(
370                     _expectedPrevL2BlockHash == _getLatest257L2blockHash(_l2BlockNumber - 1),
371                     "The previous hash of the same L2 block must be same"
372                 );
373                 require(_maxVirtualBlocksToCreate == 0, "Can not create virtual blocks in the middle of the miniblock");
374             } else if (currentL2BlockNumber + 1 == _l2BlockNumber) {
375                 // From the checks in _upgradeL2Blocks it is known that currentL2BlockNumber can not be 0
376                 bytes32 prevL2BlockHash = _getLatest257L2blockHash(currentL2BlockNumber - 1);
377     
378                 bytes32 pendingL2BlockHash = _calculateL2BlockHash(
379                     currentL2BlockNumber,
380                     currentL2BlockTimestamp,
381                     prevL2BlockHash,
382                     currentL2BlockTxsRollingHash
383                 );
384     
385                 require(_expectedPrevL2BlockHash == pendingL2BlockHash, "The current L2 block hash is incorrect");
386                 require(
387                     _l2BlockTimestamp > currentL2BlockTimestamp,
388                     "The timestamp of the new L2 block must be greater than the timestamp of the previous L2 block"
389                 );
390     
391                 // Since the new block is created, we'll clear out the rolling hash
392                 _setNewL2BlockData(_l2BlockNumber, _l2BlockTimestamp, _expectedPrevL2BlockHash);
393             } else {
394                 revert("Invalid new L2 block number");
395             }
396     
397             _setVirtualBlock(_l2BlockNumber, _maxVirtualBlocksToCreate, _l2BlockTimestamp);
398         }


444         function setNewBatch(
445             bytes32 _prevBatchHash,
446             uint128 _newTimestamp,
447             uint128 _expectedNewNumber,
448             uint256 _baseFee
449         ) external onlyCallFromBootloader {
450             (uint128 previousBatchNumber, uint128 previousBatchTimestamp) = getBatchNumberAndTimestamp();
451             require(_newTimestamp > previousBatchTimestamp, "Timestamps should be incremental");
452             require(previousBatchNumber + 1 == _expectedNewNumber, "The provided block number is not correct");
453     
454             _ensureBatchConsistentWithL2Block(_newTimestamp);
455     
456             batchHashes[previousBatchNumber] = _prevBatchHash;
457     
458             // Setting new block number and timestamp
459             BlockInfo memory newBlockInfo = BlockInfo({number: previousBatchNumber + 1, timestamp: _newTimestamp});
460     
461             currentBatchInfo = newBlockInfo;
462     
463             baseFee = _baseFee;
464     
465             // The correctness of this block hash:
466             SystemContractHelper.toL1(false, bytes32(uint256(SystemLogKey.PREV_BATCH_HASH_KEY)), _prevBatchHash);
467         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L444:467

</details>

## L011 - Empty `receive()`/`payable fallback()` function does not authorize requests:

If the intention is for the Ether to be used, the function should call another function, otherwise it should revert (e.g. `require(msg.sender == address(weth))`). Having no access control on the function means that someone may send Ether to the contract, and have no way to get anything back out, which is a loss of funds. If the concern is having to spend a small amount of gas to check the sender against an immutable address, the code should at least have a function to rescue unused Ether.


<details>
<summary>Click to show 4 findings</summary>

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


262         receive() external payable {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L262:262

```solidity
File: system-contracts/contracts/DefaultAccount.sol


227         receive() external payable {
228             // If the contract is called directly, behave like an EOA
229         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L227:229

```solidity
File: system-contracts/contracts/EmptyContract.sol


11          fallback() external payable {}


13          receive() external payable {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L13:13

</details>

## L012 - Contracts are designed to receive ETH but do not implement function for withdrawal:

The following contracts can receive ETH but can not withdraw, ETH is occasionally sent by users will be stuck in those contracts. This functionality also applies to baseTokens resulting in locked tokens and loss of funds.


```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


262         receive() external payable {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L262:262

```solidity
File: system-contracts/contracts/DefaultAccount.sol


227         receive() external payable {
228             // If the contract is called directly, behave like an EOA
229         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L227:229

```solidity
File: system-contracts/contracts/EmptyContract.sol


11          fallback() external payable {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L11:11


## L013 - Draft imports may break in new minor versions:

While OpenZeppelin draft contracts are safe to use and have been audited, their 'draft' status means that the EIPs they're based on are not finalized, and thus there may be breaking changes in even minor releases. If a bug is found in this version of OpenZeppelin, and the version that you're forced to upgrade to has breaking changes in the new version, you'll encounter unnecessary delays in porting and testing replacement contracts. Ensure that you have extensive test coverage of this area so that differences can be automatically detected, and have a plan in place for how you would fully test a new version of these contracts if they do indeed change unexpectedly. Consider creating a forked version of the file rather than importing it from the package, and manually patch your fork as changes are made.


```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


5       import {ERC20PermitUpgradeable} from "@openzeppelin/contracts-upgradeable/token/ERC20/extensions/draft-ERC20PermitUpgradeable.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L5:5

## L014 - Int casting `block.timestamp` can reduce the lifespan of a contract:

Consider removing casting to ensure future functionality.


```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


115                 uint32 timestamp = uint32(block.timestamp);


134                 uint32 timestamp = uint32(block.timestamp);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L134:134

## L015 - No limits when setting state variable amounts:

It is important to ensure state variables numbers are set to a reasonable value.


<details>
<summary>Click to show 28 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


111             eraFirstPostUpgradeBatch = _eraFirstPostUpgradeBatch;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L111:111

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


49              minDelay = _minDelay;


251             minDelay = _newDelay;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L251:251

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


148             protocolVersion = _newProtocolVersion;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L148:148

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


57              executionDelay = _executionDelay;


97              executionDelay = _executionDelay;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L97:97

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


83              s.baseTokenGasPriceMultiplierNominator = _nominator;


84              s.baseTokenGasPriceMultiplierDenominator = _denominator;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L84:84

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


164                     logOutput.packedBatchAndL2BlockTimestamp = uint256(logValue);


173                     logOutput.numberOfLayer1Txs = uint256(logValue);


357             s.totalBatchesExecuted = newTotalBatchesExecuted;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L357:357

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/LibMap.sol


30                  result = uint32(mapValue >> bitOffset);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L30:30

```solidity
File: system-contracts/contracts/Compressor.sol


252             number = uint256(bytes32(_calldataSlice));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L252:252

```solidity
File: system-contracts/contracts/L1Messenger.sol


108             logIdInMerkleTree = numberOfLogsToProcess;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L108:108

```solidity
File: system-contracts/contracts/SystemContext.sol


85              chainId = _newChainId;


106             gasPrice = _gasPrice;


113             basePubdataSpent = _basePubdataSpent;


114             gasPerPubdataByte = _gasPerPubdataByte;


285                 virtualBlockUpgradeInfo.virtualBlockStartBatch = currentBatchNumber;


463             baseFee = _baseFee;


479             baseFee = _baseFee;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L479:479

```solidity
File: system-contracts/contracts/libraries/SystemContractHelper.sol


131             rawParams = _inputMemoryOffset;


228             pubdataPublished = uint32(extractNumberFromMeta(meta, META_GAS_PER_PUBDATA_BYTE_OFFSET, 32));


238             heapSize = uint32(extractNumberFromMeta(meta, META_HEAP_SIZE_OFFSET, 32));


247             auxHeapSize = uint32(extractNumberFromMeta(meta, META_AUX_HEAP_SIZE_OFFSET, 32));


255             shardId = uint8(extractNumberFromMeta(meta, META_SHARD_ID_OFFSET, 8));


264             callerShardId = uint8(extractNumberFromMeta(meta, META_CALLER_SHARD_ID_OFFSET, 8));


273             codeShardId = uint8(extractNumberFromMeta(meta, META_CODE_SHARD_ID_OFFSET, 8));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L273:273

</details>

## L016 - Double type casts create complexity within the code:

Double type casting should be avoided in Solidity contracts to prevent unintended consequences and ensure accurate data representation. Performing multiple type casts in succession can lead to unexpected truncation, rounding errors, or loss of precision, potentially compromising the contract's functionality and reliability. Furthermore, double type casting can make the code less readable and harder to maintain, increasing the likelihood of errors and misunderstandings during development and debugging. To ensure precise and consistent data handling, developers should use appropriate data types and avoid unnecessary or excessive type casting, promoting a more robust and dependable contract execution.


<details>
<summary>Click to show 91 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


bytes32 salt = bytes32(uint256(uint160(_l1Token)));

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L77:77

```solidity
File: contracts/ethereum/contracts/common/Config.sol


bytes32 constant TWO_BRIDGES_MAGIC_VALUE = bytes32(uint256(keccak256("TWO_BRIDGES_MAGIC_VALUE")) - 1);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/Config.sol#L112:112

```solidity
File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol


hashedBytecode = (hashedBytecode | bytes32(uint256(1 << 248)));

codeLengthInWords = uint256(uint8(_bytecodeHash[2])) * 256 + uint256(uint8(_bytecodeHash[3]));

bytes32 senderBytes = bytes32(uint256(uint160(_sender)));

return address(uint160(uint256(data)));

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L71:71

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


from: uint256(uint160(L2_FORCE_DEPLOYER_ADDR)),

to: uint256(uint160(L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR)),

bytes32(uint256(uint160(bridgehub))),

bytes32(uint256(uint160(address(this)))),

bytes32(uint256(protocolVersion)),

bytes32(uint256(uint160(_admin))),

bytes32(uint256(uint160(validatorTimelock))),

bytes32(uint256(uint160(_baseToken))),

bytes32(uint256(uint160(_sharedBridge))),

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L270:270

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


uint8 pubdataSource = uint8(bytes1(_newBatch.pubdataCommitments[0]));

uint256(uint128(bytes16(_pubdataCommitments[i:i + PUBDATA_COMMITMENT_CLAIMED_VALUE_OFFSET])))

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L644:644

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


value: bytes32(uint256(_status))

key: bytes32(uint256(uint160(_message.sender))),

from: uint256(uint160(_priorityOpParams.sender)),

to: uint256(uint160(_priorityOpParams.contractAddressL2)),

reserved: [_priorityOpParams.valueToMint, uint256(uint160(_priorityOpParams.refundRecipient)), 0, 0],

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L306:306

```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


bytes32 senderBytes = bytes32(uint256(uint160(_sender)));

return address(uint160(uint256(data)));

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L112:112

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


salt = bytes32(uint256(uint160(_l1Token)));

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L158:158

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


uint256 addressAsKey = uint256(uint160(_address));

uint256 addressAsKey = uint256(uint160(_address));

address account = address(uint160(_input));

address account = address(uint160(_input));

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L120:120

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


bytes memory encodedTo = RLPEncoder.encodeAddress(address(uint160(_transaction.to)));

uint256 rInt = uint256(bytes32(_transaction.signature[0:32]));

uint256 sInt = uint256(bytes32(_transaction.signature[32:64]));

uint256 vInt = uint256(uint8(_transaction.signature[64]));

bytes memory encodedTo = RLPEncoder.encodeAddress(address(uint160(_transaction.to)));

uint256 rInt = uint256(bytes32(_transaction.signature[0:32]));

uint256 sInt = uint256(bytes32(_transaction.signature[32:64]));

uint256 vInt = uint256(uint8(_transaction.signature[64]));

bytes memory encodedTo = RLPEncoder.encodeAddress(address(uint160(_transaction.to)));

uint256 rInt = uint256(bytes32(_transaction.signature[0:32]));

uint256 sInt = uint256(bytes32(_transaction.signature[32:64]));

uint256 vInt = uint256(uint8(_transaction.signature[64]));

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L285:285

```solidity
File: system-contracts/contracts/Compressor.sol


uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr]));

uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr]));

number = uint256(bytes32(_calldataSlice));

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L252:252

```solidity
File: system-contracts/contracts/ContractDeployer.sol


bytes.concat(CREATE2_PREFIX, bytes32(uint256(uint160(_sender))), _salt, _bytecodeHash, constructorInputHash)

newAddress = address(uint160(uint256(hash)));

bytes.concat(CREATE_PREFIX, bytes32(uint256(uint160(_sender))), bytes32(_senderNonce))

newAddress = address(uint160(uint256(hash)));

ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.getCodeHash(uint256(uint160(_newAddress))) == 0x0,

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L269:269

```solidity
File: system-contracts/contracts/DefaultAccount.sol


address to = address(uint160(_transaction.to));

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L132:132

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


return immutableDataStorage[uint256(uint160(_dest))][_index];

immutableDataStorage[uint256(uint160(_dest))][index] = value;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L41:41

```solidity
File: system-contracts/contracts/L1Messenger.sol


key: bytes32(uint256(uint160(msg.sender))),

uint32 numberOfL2ToL1Logs = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));

uint32 numberOfMessages = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));

uint32 currentMessageLength = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));

uint32 numberOfBytecodes = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));

uint256(uint8(bytes1(_totalL2ToL1PubdataAndStateDiffs[calldataPtr]))) ==

uint24 compressedStateDiffSize = uint24(bytes3(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 3]));

uint8 enumerationIndexSize = uint8(bytes1(_totalL2ToL1PubdataAndStateDiffs[calldataPtr]));

uint32 numberOfStateDiffs = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));

SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.L2_TO_L1_LOGS_TREE_ROOT_KEY)), l2ToL1LogsTreeRoot);

bytes32(uint256(SystemLogKey.TOTAL_L2_TO_L1_PUBDATA_KEY)),

SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.STATE_DIFF_HASH_KEY)), stateDiffHash);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L326:326

```solidity
File: system-contracts/contracts/L2BaseToken.sol


return balance[address(uint160(_account))];

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L57:57

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


to = address(uint160(addressAsUint));

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L32:32

```solidity
File: system-contracts/contracts/NonceHolder.sol


uint256 addressAsKey = uint256(uint160(_address));

uint256 addressAsKey = uint256(uint160(_address));

uint256 addressAsKey = uint256(uint160(msg.sender));

uint256 addressAsKey = uint256(uint160(msg.sender));

uint256 addressAsKey = uint256(uint160(msg.sender));

uint256 addressAsKey = uint256(uint160(msg.sender));

uint256 addressAsKey = uint256(uint160(_address));

uint256 addressAsKey = uint256(uint160(_address));

uint256 addressAsKey = uint256(uint160(_address));

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L155:155

```solidity
File: system-contracts/contracts/PubdataChunkPublisher.sol


SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.BLOB_ONE_HASH_KEY)), blobHashes[0]);

SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.BLOB_TWO_HASH_KEY)), blobHashes[1]);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L56:56

```solidity
File: system-contracts/contracts/SystemContext.sol


bytes32(uint256(SystemLogKey.PACKED_BATCH_AND_L2_BLOCK_TIMESTAMP_KEY)),

SystemContractHelper.toL1(false, bytes32(uint256(SystemLogKey.PREV_BATCH_HASH_KEY)), _prevBatchHash);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L466:466

```solidity
File: system-contracts/contracts/libraries/RLPEncoder.sol


encoded[0] = (_val == 0) ? bytes1(uint8(128)) : bytes1(uint8(_val));

encoded[0] = bytes1(uint8(hbs + 0x81));

encoded[0] = bytes1(uint8(_len + _offset));

encoded[0] = bytes1(uint8(_offset + hbs + 56));

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L69:69

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


return _addr == uint256(uint160(address(BASE_TOKEN_SYSTEM_CONTRACT))) || _addr == 0;

bytes memory encodedTo = RLPEncoder.encodeAddress(address(uint160(_transaction.to)));

bytes memory encodedTo = RLPEncoder.encodeAddress(address(uint160(_transaction.to)));

bytes memory encodedTo = RLPEncoder.encodeAddress(address(uint160(_transaction.to)));

address paymaster = address(uint160(_transaction.paymaster));

if (address(uint160(_transaction.paymaster)) != address(0)) {

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L406:406

```solidity
File: system-contracts/contracts/libraries/Utils.sol


codeLengthInWords = uint256(uint8(_bytecodeHash[2])) * 256 + uint256(uint8(_bytecodeHash[3]));

hashedBytecode = (hashedBytecode | bytes32(uint256(1 << 248)));

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L93:93

</details>

## L017 - Constructor contains no validation:

In Solidity, when values are being assigned in constructors to unsigned or integer variables, it's crucial to ensure the provided values adhere to the protocol's specific operational boundaries as laid out in the project specifications and documentation. If the constructors lack appropriate validation checks, there's a risk of setting state variables with values that could cause unexpected and potentially detrimental behavior within the contract's operations, violating the intended logic of the protocol. This can compromise the contract's security and impact the maintainability and reliability of the system. In order to avoid such issues, it is recommended to incorporate rigorous validation checks in constructors. These checks should align with the project's defined rules and constraints, making use of Solidity's built-in require function to enforce these conditions. If the validation checks fail, the require function will cause the transaction to revert, ensuring the integrity and adherence to the protocol's expected behavior.


<details>
<summary>Click to show 4 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


55          constructor(IL1SharedBridge _sharedBridge) reentrancyGuardInitializer {
56              sharedBridge = _sharedBridge;
57          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L55:57

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


90          constructor(
91              address _l1WethAddress,
92              IBridgehub _bridgehub,
93              IL1ERC20Bridge _legacyBridge
94          ) reentrancyGuardInitializer {
95              _disableInitializers();
96              l1WethAddress = _l1WethAddress;
97              bridgehub = _bridgehub;
98              legacyBridge = _legacyBridge;
99          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L90:99

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


58          constructor(address _bridgehub) reentrancyGuardInitializer {
59              bridgehub = _bridgehub;
60          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L58:60

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


55          constructor(address _initialOwner, uint32 _executionDelay) {
56              _transferOwnership(_initialOwner);
57              executionDelay = _executionDelay;
58          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L55:58

</details>

## L018 - For loops in `public` or `external` functions should be avoided due to high gas costs and possible DOS:

In Solidity, for loops can potentially cause Denial of Service (DoS) attacks if not handled carefully. DoS attacks can occur when an attacker intentionally exploits the gas cost of a function, causing it to run out of gas or making it too expensive for other users to call. Below are some scenarios where for loops can lead to DoS attacks: Nested for loops can become exceptionally gas expensive and should be used sparingly.


<details>
<summary>Click to show 11 findings</summary>

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


108         function commitBatches(
109             StoredBatchInfo calldata,
110             CommitBatchInfo[] calldata _newBatchesData
111         ) external onlyValidator(ERA_CHAIN_ID) {
112             unchecked {
113                 // This contract is only a temporary solution, that hopefully will be disabled until 2106 year, so...
114                 // It is safe to cast.
115                 uint32 timestamp = uint32(block.timestamp);
116                 for (uint256 i = 0; i < _newBatchesData.length; ++i) {
117                     committedBatchTimestamp[ERA_CHAIN_ID].set(_newBatchesData[i].batchNumber, timestamp);
118                 }
119             }
120     
121             _propagateToZkSyncStateTransition(ERA_CHAIN_ID);
122         }


126         function commitBatchesSharedBridge(
127             uint256 _chainId,
128             StoredBatchInfo calldata,
129             CommitBatchInfo[] calldata _newBatchesData
130         ) external onlyValidator(_chainId) {
131             unchecked {
132                 // This contract is only a temporary solution, that hopefully will be disabled until 2106 year, so...
133                 // It is safe to cast.
134                 uint32 timestamp = uint32(block.timestamp);
135                 for (uint256 i = 0; i < _newBatchesData.length; ++i) {
136                     committedBatchTimestamp[_chainId].set(_newBatchesData[i].batchNumber, timestamp);
137                 }
138             }
139     
140             _propagateToZkSyncStateTransition(_chainId);
141         }


182         function executeBatches(StoredBatchInfo[] calldata _newBatchesData) external onlyValidator(ERA_CHAIN_ID) {
183             uint256 delay = executionDelay; // uint32
184             unchecked {
185                 for (uint256 i = 0; i < _newBatchesData.length; ++i) {
186                     uint256 commitBatchTimestamp = committedBatchTimestamp[ERA_CHAIN_ID].get(
187                         _newBatchesData[i].batchNumber
188                     );
189     
190                     // Note: if the `commitBatchTimestamp` is zero, that means either:
191                     // * The batch was committed, but not through this contract.
192                     // * The batch wasn't committed at all, so execution will fail in the zkSync contract.
193                     // We allow executing such batches.
194     
195                     require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed
196                 }
197             }
198             _propagateToZkSyncStateTransition(ERA_CHAIN_ID);
199         }


203         function executeBatchesSharedBridge(
204             uint256 _chainId,
205             StoredBatchInfo[] calldata _newBatchesData
206         ) external onlyValidator(_chainId) {
207             uint256 delay = executionDelay; // uint32
208             unchecked {
209                 for (uint256 i = 0; i < _newBatchesData.length; ++i) {
210                     uint256 commitBatchTimestamp = committedBatchTimestamp[_chainId].get(_newBatchesData[i].batchNumber);
211     
212                     // Note: if the `commitBatchTimestamp` is zero, that means either:
213                     // * The batch was committed, but not through this contract.
214                     // * The batch wasn't committed at all, so execution will fail in the zkSync contract.
215                     // We allow executing such batches.
216     
217                     require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed
218                 }
219             }
220             _propagateToZkSyncStateTransition(_chainId);
221         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L203:221

```solidity
File: system-contracts/contracts/Compressor.sol


44          function publishCompressedBytecode(
45              bytes calldata _bytecode,
46              bytes calldata _rawCompressedData
47          ) external payable onlyCallFromBootloader returns (bytes32 bytecodeHash) {
48              unchecked {
49                  (bytes calldata dictionary, bytes calldata encodedData) = _decodeRawBytecode(_rawCompressedData);
50      
51                  require(
52                      encodedData.length * 4 == _bytecode.length,
53                      "Encoded data length should be 4 times shorter than the original bytecode"
54                  );
55      
56                  require(
57                      dictionary.length / 8 <= encodedData.length / 2,
58                      "Dictionary should have at most the same number of entries as the encoded data"
59                  );
60      
61                  for (uint256 encodedDataPointer = 0; encodedDataPointer < encodedData.length; encodedDataPointer += 2) {
62                      uint256 indexOfEncodedChunk = uint256(encodedData.readUint16(encodedDataPointer)) * 8;
63                      require(indexOfEncodedChunk < dictionary.length, "Encoded chunk index is out of bounds");
64      
65                      uint64 encodedChunk = dictionary.readUint64(indexOfEncodedChunk);
66                      uint64 realChunk = _bytecode.readUint64(encodedDataPointer * 4);
67      
68                      require(encodedChunk == realChunk, "Encoded chunk does not match the original bytecode");
69                  }
70              }
71      
72              bytecodeHash = Utils.hashL2Bytecode(_bytecode);
73              L1_MESSENGER_CONTRACT.sendToL1(_rawCompressedData);
74              KNOWN_CODE_STORAGE_CONTRACT.markBytecodeAsPublished(bytecodeHash);
75          }


110         function verifyCompressedStateDiffs(
111             uint256 _numberOfStateDiffs,
112             uint256 _enumerationIndexSize,
113             bytes calldata _stateDiffs,
114             bytes calldata _compressedStateDiffs
115         ) external payable onlyCallFrom(address(L1_MESSENGER_CONTRACT)) returns (bytes32 stateDiffHash) {
116             // We do not enforce the operator to use the optimal, i.e. the minimally possible _enumerationIndexSize.
117             // We do enforce however, that the _enumerationIndexSize is not larger than 8 bytes long, which is the
118             // maximal ever possible size for enumeration index.
119             require(_enumerationIndexSize <= MAX_ENUMERATION_INDEX_SIZE, "enumeration index size is too large");
120     
121             uint256 numberOfInitialWrites = uint256(_compressedStateDiffs.readUint16(0));
122     
123             uint256 stateDiffPtr = 2;
124             uint256 numInitialWritesProcessed = 0;
125     
126             // Process initial writes
127             for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) {
128                 bytes calldata stateDiff = _stateDiffs[i:i + STATE_DIFF_ENTRY_SIZE];
129                 uint64 enumIndex = stateDiff.readUint64(84);
130                 if (enumIndex != 0) {
131                     // It is a repeated write, so we skip it.
132                     continue;
133                 }
134     
135                 numInitialWritesProcessed++;
136     
137                 bytes32 derivedKey = stateDiff.readBytes32(52);
138                 uint256 initValue = stateDiff.readUint256(92);
139                 uint256 finalValue = stateDiff.readUint256(124);
140                 require(derivedKey == _compressedStateDiffs.readBytes32(stateDiffPtr), "iw: initial key mismatch");
141                 stateDiffPtr += 32;
142     
143                 uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr]));
144                 stateDiffPtr++;
145                 uint8 operation = metadata & OPERATION_BITMASK;
146                 uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;
147                 _verifyValueCompression(
148                     initValue,
149                     finalValue,
150                     operation,
151                     _compressedStateDiffs[stateDiffPtr:stateDiffPtr + len]
152                 );
153                 stateDiffPtr += len;
154             }
155     
156             require(numInitialWritesProcessed == numberOfInitialWrites, "Incorrect number of initial storage diffs");
157     
158             // Process repeated writes
159             for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) {
160                 bytes calldata stateDiff = _stateDiffs[i:i + STATE_DIFF_ENTRY_SIZE];
161                 uint64 enumIndex = stateDiff.readUint64(84);
162                 if (enumIndex == 0) {
163                     continue;
164                 }
165     
166                 uint256 initValue = stateDiff.readUint256(92);
167                 uint256 finalValue = stateDiff.readUint256(124);
168                 uint256 compressedEnumIndex = _sliceToUint256(
169                     _compressedStateDiffs[stateDiffPtr:stateDiffPtr + _enumerationIndexSize]
170                 );
171                 require(enumIndex == compressedEnumIndex, "rw: enum key mismatch");
172                 stateDiffPtr += _enumerationIndexSize;
173     
174                 uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr]));
175                 stateDiffPtr += 1;
176                 uint8 operation = metadata & OPERATION_BITMASK;
177                 uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;
178                 _verifyValueCompression(
179                     initValue,
180                     finalValue,
181                     operation,
182                     _compressedStateDiffs[stateDiffPtr:stateDiffPtr + len]
183                 );
184                 stateDiffPtr += len;
185             }
186     
187             require(stateDiffPtr == _compressedStateDiffs.length, "Extra data in _compressedStateDiffs");
188     
189             stateDiffHash = EfficientCall.keccak(_stateDiffs);
190         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L110:190

```solidity
File: system-contracts/contracts/ContractDeployer.sol


238         function forceDeployOnAddresses(ForceDeployment[] calldata _deployments) external payable {
239             require(
240                 msg.sender == FORCE_DEPLOYER || msg.sender == address(COMPLEX_UPGRADER_CONTRACT),
241                 "Can only be called by FORCE_DEPLOYER or COMPLEX_UPGRADER_CONTRACT"
242             );
243     
244             uint256 deploymentsLength = _deployments.length;
245             // We need to ensure that the `value` provided by the call is enough to provide `value`
246             // for all of the deployments
247             uint256 sumOfValues = 0;
248             for (uint256 i = 0; i < deploymentsLength; ++i) {
249                 sumOfValues += _deployments[i].value;
250             }
251             require(msg.value == sumOfValues, "`value` provided is not equal to the combined `value`s of deployments");
252     
253             for (uint256 i = 0; i < deploymentsLength; ++i) {
254                 this.forceDeployOnAddress{value: _deployments[i].value}(_deployments[i], msg.sender);
255             }
256         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L238:256

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


34          function setImmutables(address _dest, ImmutableData[] calldata _immutables) external override {
35              require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract");
36              unchecked {
37                  uint256 immutablesLength = _immutables.length;
38                  for (uint256 i = 0; i < immutablesLength; ++i) {
39                      uint256 index = _immutables[i].index;
40                      bytes32 value = _immutables[i].value;
41                      immutableDataStorage[uint256(uint160(_dest))][index] = value;
42                  }
43              }
44          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L34:44

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


27          function markFactoryDeps(bool _shouldSendToL1, bytes32[] calldata _hashes) external onlyCallFromBootloader {
28              unchecked {
29                  uint256 hashesLen = _hashes.length;
30                  for (uint256 i = 0; i < hashesLen; ++i) {
31                      _markBytecodeAsPublished(_hashes[i], _shouldSendToL1);
32                  }
33              }
34          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L27:34

```solidity
File: system-contracts/contracts/L1Messenger.sol


194         function publishPubdataAndClearState(
195             bytes calldata _totalL2ToL1PubdataAndStateDiffs
196         ) external onlyCallFromBootloader {
197             uint256 calldataPtr = 0;
198     
199             /// Check logs
200             uint32 numberOfL2ToL1Logs = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));
201             require(numberOfL2ToL1Logs <= L2_TO_L1_LOGS_MERKLE_TREE_LEAVES, "Too many L2->L1 logs");
202             calldataPtr += 4;
203     
204             bytes32[] memory l2ToL1LogsTreeArray = new bytes32[](L2_TO_L1_LOGS_MERKLE_TREE_LEAVES);
205             bytes32 reconstructedChainedLogsHash;
206             for (uint256 i = 0; i < numberOfL2ToL1Logs; ++i) {
207                 bytes32 hashedLog = EfficientCall.keccak(
208                     _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + L2_TO_L1_LOG_SERIALIZE_SIZE]
209                 );
210                 calldataPtr += L2_TO_L1_LOG_SERIALIZE_SIZE;
211                 l2ToL1LogsTreeArray[i] = hashedLog;
212                 reconstructedChainedLogsHash = keccak256(abi.encode(reconstructedChainedLogsHash, hashedLog));
213             }
214             require(
215                 reconstructedChainedLogsHash == chainedLogsHash,
216                 "reconstructedChainedLogsHash is not equal to chainedLogsHash"
217             );
218             for (uint256 i = numberOfL2ToL1Logs; i < L2_TO_L1_LOGS_MERKLE_TREE_LEAVES; ++i) {
219                 l2ToL1LogsTreeArray[i] = L2_L1_LOGS_TREE_DEFAULT_LEAF_HASH;
220             }
221             uint256 nodesOnCurrentLevel = L2_TO_L1_LOGS_MERKLE_TREE_LEAVES;
222             while (nodesOnCurrentLevel > 1) {
223                 nodesOnCurrentLevel /= 2;
224                 for (uint256 i = 0; i < nodesOnCurrentLevel; ++i) {
225                     l2ToL1LogsTreeArray[i] = keccak256(
226                         abi.encode(l2ToL1LogsTreeArray[2 * i], l2ToL1LogsTreeArray[2 * i + 1])
227                     );
228                 }
229             }
230             bytes32 l2ToL1LogsTreeRoot = l2ToL1LogsTreeArray[0];
231     
232             /// Check messages
233             uint32 numberOfMessages = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));
234             calldataPtr += 4;
235             bytes32 reconstructedChainedMessagesHash;
236             for (uint256 i = 0; i < numberOfMessages; ++i) {
237                 uint32 currentMessageLength = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));
238                 calldataPtr += 4;
239                 bytes32 hashedMessage = EfficientCall.keccak(
240                     _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + currentMessageLength]
241                 );
242                 calldataPtr += currentMessageLength;
243                 reconstructedChainedMessagesHash = keccak256(abi.encode(reconstructedChainedMessagesHash, hashedMessage));
244             }
245             require(
246                 reconstructedChainedMessagesHash == chainedMessagesHash,
247                 "reconstructedChainedMessagesHash is not equal to chainedMessagesHash"
248             );
249     
250             /// Check bytecodes
251             uint32 numberOfBytecodes = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));
252             calldataPtr += 4;
253             bytes32 reconstructedChainedL1BytecodesRevealDataHash;
254             for (uint256 i = 0; i < numberOfBytecodes; ++i) {
255                 uint32 currentBytecodeLength = uint32(
256                     bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4])
257                 );
258                 calldataPtr += 4;
259                 reconstructedChainedL1BytecodesRevealDataHash = keccak256(
260                     abi.encode(
261                         reconstructedChainedL1BytecodesRevealDataHash,
262                         Utils.hashL2Bytecode(
263                             _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + currentBytecodeLength]
264                         )
265                     )
266                 );
267                 calldataPtr += currentBytecodeLength;
268             }
269             require(
270                 reconstructedChainedL1BytecodesRevealDataHash == chainedL1BytecodesRevealDataHash,
271                 "reconstructedChainedL1BytecodesRevealDataHash is not equal to chainedL1BytecodesRevealDataHash"
272             );
273     
274             /// Check State Diffs
275             /// encoding is as follows:
276             /// header (1 byte version, 3 bytes total len of compressed, 1 byte enumeration index size)
277             /// body (`compressedStateDiffSize` bytes, 4 bytes number of state diffs, `numberOfStateDiffs` * `STATE_DIFF_ENTRY_SIZE` bytes for the uncompressed state diffs)
278             /// encoded state diffs: [20bytes address][32bytes key][32bytes derived key][8bytes enum index][32bytes initial value][32bytes final value]
279             require(
280                 uint256(uint8(bytes1(_totalL2ToL1PubdataAndStateDiffs[calldataPtr]))) ==
281                     STATE_DIFF_COMPRESSION_VERSION_NUMBER,
282                 "state diff compression version mismatch"
283             );
284             calldataPtr++;
285     
286             uint24 compressedStateDiffSize = uint24(bytes3(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 3]));
287             calldataPtr += 3;
288     
289             uint8 enumerationIndexSize = uint8(bytes1(_totalL2ToL1PubdataAndStateDiffs[calldataPtr]));
290             calldataPtr++;
291     
292             bytes calldata compressedStateDiffs = _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr +
293                 compressedStateDiffSize];
294             calldataPtr += compressedStateDiffSize;
295     
296             bytes calldata totalL2ToL1Pubdata = _totalL2ToL1PubdataAndStateDiffs[:calldataPtr];
297     
298             require(calldataPtr <= MAX_ALLOWED_PUBDATA_PER_BATCH, "L1 Messenger pubdata is too long");
299     
300             uint32 numberOfStateDiffs = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));
301             calldataPtr += 4;
302     
303             bytes calldata stateDiffs = _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr +
304                 (numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE)];
305             calldataPtr += numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE;
306     
307             bytes32 stateDiffHash = COMPRESSOR_CONTRACT.verifyCompressedStateDiffs(
308                 numberOfStateDiffs,
309                 enumerationIndexSize,
310                 stateDiffs,
311                 compressedStateDiffs
312             );
313     
314             /// Check for calldata strict format
315             require(calldataPtr == _totalL2ToL1PubdataAndStateDiffs.length, "Extra data in the totalL2ToL1Pubdata array");
316     
317             PUBDATA_CHUNK_PUBLISHER.chunkAndPublishPubdata(totalL2ToL1Pubdata);
318     
319             /// Native (VM) L2 to L1 log
320             SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.L2_TO_L1_LOGS_TREE_ROOT_KEY)), l2ToL1LogsTreeRoot);
321             SystemContractHelper.toL1(
322                 true,
323                 bytes32(uint256(SystemLogKey.TOTAL_L2_TO_L1_PUBDATA_KEY)),
324                 EfficientCall.keccak(totalL2ToL1Pubdata)
325             );
326             SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.STATE_DIFF_HASH_KEY)), stateDiffHash);
327     
328             /// Clear logs state
329             chainedLogsHash = bytes32(0);
330             numberOfLogsToProcess = 0;
331             chainedMessagesHash = bytes32(0);
332             chainedL1BytecodesRevealDataHash = bytes32(0);
333         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L194:333

```solidity
File: system-contracts/contracts/PubdataChunkPublisher.sol


21          function chunkAndPublishPubdata(bytes calldata _pubdata) external onlyCallFrom(address(L1_MESSENGER_CONTRACT)) {
22              require(_pubdata.length <= BLOB_SIZE_BYTES * MAX_NUMBER_OF_BLOBS, "pubdata should fit in 2 blobs");
23      
24              bytes32[] memory blobHashes = new bytes32[](MAX_NUMBER_OF_BLOBS);
25      
26              // We allocate to the full size of MAX_NUMBER_OF_BLOBS * BLOB_SIZE_BYTES because we need to pad
27              // the data on the right with 0s if it doesn't take up the full blob
28              bytes memory totalBlobs = new bytes(BLOB_SIZE_BYTES * MAX_NUMBER_OF_BLOBS);
29      
30              assembly {
31                  // The pointer to the allocated memory above. We skip 32 bytes to avoid overwriting the length.
32                  let ptr := add(totalBlobs, 0x20)
33                  calldatacopy(ptr, _pubdata.offset, _pubdata.length)
34              }
35      
36              for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) {
37                  uint256 start = BLOB_SIZE_BYTES * i;
38      
39                  // We break if the pubdata isn't enough to cover 2 blobs. On L1 it is expected that the hash
40                  // will be bytes32(0) if a blob isn't going to be used.
41                  if (start >= _pubdata.length) {
42                      break;
43                  }
44      
45                  bytes32 blobHash;
46                  assembly {
47                      // The pointer to the allocated memory above skipping the length.
48                      let ptr := add(totalBlobs, 0x20)
49                      blobHash := keccak256(add(ptr, start), BLOB_SIZE_BYTES)
50                  }
51      
52                  blobHashes[i] = blobHash;
53              }
54      
55              SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.BLOB_ONE_HASH_KEY)), blobHashes[0]);
56              SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.BLOB_TWO_HASH_KEY)), blobHashes[1]);
57          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L21:57

</details>

## L019 - Function calls within for loops:

Making function calls within loops in Solidity can lead to inefficient gas usage, potential bottlenecks, and increased vulnerability to attacks. Each function call or external call consumes gas, and when executed within a loop, the gas cost multiplies, potentially causing the transaction to run out of gas or exceed block gas limits. This can result in transaction failure or unpredictable behavior.


<details>
<summary>Click to show 14 findings</summary>

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


289             for (uint256 i = 0; i < _newBatchesData.length; i = i.uncheckedInc()) {
290                 // The upgrade transaction must only be included in the first batch.
291                 bytes32 expectedUpgradeTxHash = i == 0 ? _systemContractUpgradeTxHash : bytes32(0);
292                 _lastCommittedBatchData = _commitOneBatch(
293                     _lastCommittedBatchData,
294                     _newBatchesData[i],
295                     expectedUpgradeTxHash
296                 );
297     
298                 s.storedBatchHashes[_lastCommittedBatchData.batchNumber] = _hashStoredBatchInfo(_lastCommittedBatchData);
299                 emit BlockCommit(
300                     _lastCommittedBatchData.batchNumber,
301                     _lastCommittedBatchData.batchHash,
302                     _lastCommittedBatchData.commitment
303                 );
304             }


351             for (uint256 i = 0; i < nBatches; i = i.uncheckedInc()) {
352                 _executeOneBatch(_batchesData[i], i);
353                 emit BlockExecution(_batchesData[i].batchNumber, _batchesData[i].batchHash, _batchesData[i].commitment);
354             }


142             for (uint256 i = 0; i < emittedL2Logs.length; i = i.uncheckedAdd(L2_TO_L1_LOG_SERIALIZE_SIZE)) {
143                 // Extract the values to be compared to/used such as the log sender, key, and value
144                 (address logSender, ) = UnsafeBytes.readAddress(emittedL2Logs, i + L2_LOG_ADDRESS_OFFSET);
145                 (uint256 logKey, ) = UnsafeBytes.readUint256(emittedL2Logs, i + L2_LOG_KEY_OFFSET);
146                 (bytes32 logValue, ) = UnsafeBytes.readBytes32(emittedL2Logs, i + L2_LOG_VALUE_OFFSET);
147     
148                 // Ensure that the log hasn't been processed already
149                 require(!_checkBit(processedLogs, uint8(logKey)), "kp");
150                 processedLogs = _setBit(processedLogs, uint8(logKey));
151     
152                 // Need to check that each log was sent by the correct address.
153                 if (logKey == uint256(SystemLogKey.L2_TO_L1_LOGS_TREE_ROOT_KEY)) {
154                     require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "lm");
155                     logOutput.l2LogsTreeRoot = logValue;
156                 } else if (logKey == uint256(SystemLogKey.TOTAL_L2_TO_L1_PUBDATA_KEY)) {
157                     require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "ln");
158                     logOutput.pubdataHash = logValue;
159                 } else if (logKey == uint256(SystemLogKey.STATE_DIFF_HASH_KEY)) {
160                     require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "lb");
161                     logOutput.stateDiffHash = logValue;
162                 } else if (logKey == uint256(SystemLogKey.PACKED_BATCH_AND_L2_BLOCK_TIMESTAMP_KEY)) {
163                     require(logSender == L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR, "sc");
164                     logOutput.packedBatchAndL2BlockTimestamp = uint256(logValue);
165                 } else if (logKey == uint256(SystemLogKey.PREV_BATCH_HASH_KEY)) {
166                     require(logSender == L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR, "sv");
167                     logOutput.previousBatchHash = logValue;
168                 } else if (logKey == uint256(SystemLogKey.CHAINED_PRIORITY_TXN_HASH_KEY)) {
169                     require(logSender == L2_BOOTLOADER_ADDRESS, "bl");
170                     logOutput.chainedPriorityTxsHash = logValue;
171                 } else if (logKey == uint256(SystemLogKey.NUMBER_OF_LAYER_1_TXS_KEY)) {
172                     require(logSender == L2_BOOTLOADER_ADDRESS, "bk");
173                     logOutput.numberOfLayer1Txs = uint256(logValue);
174                 } else if (logKey == uint256(SystemLogKey.BLOB_ONE_HASH_KEY)) {
175                     require(logSender == L2_PUBDATA_CHUNK_PUBLISHER_ADDR, "pc");
176                     logOutput.blob1Hash = logValue;
177                 } else if (logKey == uint256(SystemLogKey.BLOB_TWO_HASH_KEY)) {
178                     require(logSender == L2_PUBDATA_CHUNK_PUBLISHER_ADDR, "pd");
179                     logOutput.blob2Hash = logValue;
180                 } else if (logKey == uint256(SystemLogKey.EXPECTED_SYSTEM_CONTRACT_UPGRADE_TX_HASH_KEY)) {
181                     require(logSender == L2_BOOTLOADER_ADDRESS, "bu");
182                     require(_expectedSystemContractUpgradeTxHash == logValue, "ut");
183                 } else {
184                     revert("ul");
185                 }
186             }


405             for (uint256 i = 0; i < committedBatchesLength; i = i.uncheckedInc()) {
406                 currentTotalBatchesVerified = currentTotalBatchesVerified.uncheckedInc();
407                 require(
408                     _hashStoredBatchInfo(_committedBatches[i]) == s.storedBatchHashes[currentTotalBatchesVerified],
409                     "o1"
410                 );
411     
412                 bytes32 currentBatchCommitment = _committedBatches[i].commitment;
413                 proofPublicInput[i] = _getBatchProofPublicInput(
414                     prevBatchCommitment,
415                     currentBatchCommitment,
416                     verifierParams
417                 );
418     
419                 prevBatchCommitment = currentBatchCommitment;
420             }


257             for (uint256 i = 0; i < _newBatchesData.length; i = i.uncheckedInc()) {
258                 _lastCommittedBatchData = _commitOneBatch(_lastCommittedBatchData, _newBatchesData[i], bytes32(0));
259     
260                 s.storedBatchHashes[_lastCommittedBatchData.batchNumber] = _hashStoredBatchInfo(_lastCommittedBatchData);
261                 emit BlockCommit(
262                     _lastCommittedBatchData.batchNumber,
263                     _lastCommittedBatchData.batchHash,
264                     _lastCommittedBatchData.commitment
265                 );
266             }


636             for (uint256 i = 0; i < _pubdataCommitments.length; i += PUBDATA_COMMITMENT_SIZE) {
637                 bytes32 blobVersionedHash = _getBlobVersionedHash(versionedHashIndex);
638     
639                 require(blobVersionedHash != bytes32(0), "vh");
640     
641                 // First 16 bytes is the opening point. While we get the point as 16 bytes, the point evaluation precompile
642                 // requires it to be 32 bytes. The blob commitment must use the opening point as 16 bytes though.
643                 bytes32 openingPoint = bytes32(
644                     uint256(uint128(bytes16(_pubdataCommitments[i:i + PUBDATA_COMMITMENT_CLAIMED_VALUE_OFFSET])))
645                 );
646     
647                 _pointEvaluationPrecompile(
648                     blobVersionedHash,
649                     openingPoint,
650                     _pubdataCommitments[i + PUBDATA_COMMITMENT_CLAIMED_VALUE_OFFSET:i + PUBDATA_COMMITMENT_SIZE]
651                 );
652     
653                 // Take the hash of the versioned hash || opening point || claimed value
654                 blobCommitments[versionedHashIndex] = keccak256(
655                     abi.encodePacked(blobVersionedHash, _pubdataCommitments[i:i + PUBDATA_COMMITMENT_COMMITMENT_OFFSET])
656                 );
657                 versionedHashIndex += 1;
658             }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L636:658

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


178             for (uint256 i = 0; i < selectorsLength; i = i.uncheckedInc()) {
179                 bytes4 selector = _selectors[i];
180                 SelectorToFacet memory oldFacet = ds.selectorToFacet[selector];
181                 require(oldFacet.facetAddress != address(0), "a2"); // Can't delete a non-existent facet
182     
183                 _removeOneFunction(oldFacet.facetAddress, selector);
184             }


138             for (uint256 i = 0; i < selectorsLength; i = i.uncheckedInc()) {
139                 bytes4 selector = _selectors[i];
140                 SelectorToFacet memory oldFacet = ds.selectorToFacet[selector];
141                 require(oldFacet.facetAddress == address(0), "J"); // facet for this selector already exists
142     
143                 _addOneFunction(_facet, selector, _isFacetFreezable);
144             }


158             for (uint256 i = 0; i < selectorsLength; i = i.uncheckedInc()) {
159                 bytes4 selector = _selectors[i];
160                 SelectorToFacet memory oldFacet = ds.selectorToFacet[selector];
161                 require(oldFacet.facetAddress != address(0), "L"); // it is impossible to replace the facet with zero address
162     
163                 _removeOneFunction(oldFacet.facetAddress, selector);
164                 // Add facet to the list of facets if the facet address is a new one
165                 _saveFacetIfNew(_facet);
166                 _addOneFunction(_facet, selector, _isFacetFreezable);
167             }


101             for (uint256 i = 0; i < facetCutsLength; i = i.uncheckedInc()) {
102                 Action action = facetCuts[i].action;
103                 address facet = facetCuts[i].facet;
104                 bool isFacetFreezable = facetCuts[i].isFreezable;
105                 bytes4[] memory selectors = facetCuts[i].selectors;
106     
107                 require(selectors.length > 0, "B"); // no functions for diamond cut
108     
109                 if (action == Action.Add) {
110                     _addFunctions(facet, selectors, isFacetFreezable);
111                 } else if (action == Action.Replace) {
112                     _replaceFunctions(facet, selectors, isFacetFreezable);
113                 } else if (action == Action.Remove) {
114                     _removeFunctions(facet, selectors);
115                 } else {
116                     revert("C"); // undefined diamond cut action
117                 }
118             }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L101:118

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol


29              for (uint256 i; i < pathLength; i = i.uncheckedInc()) {
30                  currentHash = (_index % 2 == 0)
31                      ? _efficientHash(currentHash, _path[i])
32                      : _efficientHash(_path[i], currentHash);
33                  _index /= 2;
34              }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L29:34

```solidity
File: system-contracts/contracts/Compressor.sol


159             for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) {
160                 bytes calldata stateDiff = _stateDiffs[i:i + STATE_DIFF_ENTRY_SIZE];
161                 uint64 enumIndex = stateDiff.readUint64(84);
162                 if (enumIndex == 0) {
163                     continue;
164                 }
165     
166                 uint256 initValue = stateDiff.readUint256(92);
167                 uint256 finalValue = stateDiff.readUint256(124);
168                 uint256 compressedEnumIndex = _sliceToUint256(
169                     _compressedStateDiffs[stateDiffPtr:stateDiffPtr + _enumerationIndexSize]
170                 );
171                 require(enumIndex == compressedEnumIndex, "rw: enum key mismatch");
172                 stateDiffPtr += _enumerationIndexSize;
173     
174                 uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr]));
175                 stateDiffPtr += 1;
176                 uint8 operation = metadata & OPERATION_BITMASK;
177                 uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;
178                 _verifyValueCompression(
179                     initValue,
180                     finalValue,
181                     operation,
182                     _compressedStateDiffs[stateDiffPtr:stateDiffPtr + len]
183                 );
184                 stateDiffPtr += len;
185             }


127             for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) {
128                 bytes calldata stateDiff = _stateDiffs[i:i + STATE_DIFF_ENTRY_SIZE];
129                 uint64 enumIndex = stateDiff.readUint64(84);
130                 if (enumIndex != 0) {
131                     // It is a repeated write, so we skip it.
132                     continue;
133                 }
134     
135                 numInitialWritesProcessed++;
136     
137                 bytes32 derivedKey = stateDiff.readBytes32(52);
138                 uint256 initValue = stateDiff.readUint256(92);
139                 uint256 finalValue = stateDiff.readUint256(124);
140                 require(derivedKey == _compressedStateDiffs.readBytes32(stateDiffPtr), "iw: initial key mismatch");
141                 stateDiffPtr += 32;
142     
143                 uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr]));
144                 stateDiffPtr++;
145                 uint8 operation = metadata & OPERATION_BITMASK;
146                 uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;
147                 _verifyValueCompression(
148                     initValue,
149                     finalValue,
150                     operation,
151                     _compressedStateDiffs[stateDiffPtr:stateDiffPtr + len]
152                 );
153                 stateDiffPtr += len;
154             }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L127:154

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


30                  for (uint256 i = 0; i < hashesLen; ++i) {
31                      _markBytecodeAsPublished(_hashes[i], _shouldSendToL1);
32                  }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L30:32

</details>

## L020 - External calls in an unbounded for-loop may result in a DoS:

Consider limiting the number of iterations in for-loops that make external calls.


<details>
<summary>Click to show 11 findings</summary>

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


185                 for (uint256 i = 0; i < _newBatchesData.length; ++i) {


209                 for (uint256 i = 0; i < _newBatchesData.length; ++i) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L209:209

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


142             for (uint256 i = 0; i < emittedL2Logs.length; i = i.uncheckedAdd(L2_TO_L1_LOG_SERIALIZE_SIZE)) {


257             for (uint256 i = 0; i < _newBatchesData.length; i = i.uncheckedInc()) {


289             for (uint256 i = 0; i < _newBatchesData.length; i = i.uncheckedInc()) {


636             for (uint256 i = 0; i < _pubdataCommitments.length; i += PUBDATA_COMMITMENT_SIZE) {


667             for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L667:667

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


226             for (uint256 i = 0; i < _factoryDeps.length; ++i) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L226:226

```solidity
File: system-contracts/contracts/Compressor.sol


61                  for (uint256 encodedDataPointer = 0; encodedDataPointer < encodedData.length; encodedDataPointer += 2) {


127             for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) {


159             for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L159:159

</details>

## L021 - Contracts are not using their OZ Upgradeable counterparts:

The non-upgradeable standard version of OpenZeppelins library is inherited/used by the contracts. It would be safer to use the upgradeable versions of the library contracts to avoid unexpected behavior.

Use the contracts from `@openzeppelin/contracts-upgradeable` instead of `@openzeppelin/contracts` where applicable. See https://github.com/OpenZeppelin/openzeppelin-contracts-upgradeable/tree/master/contracts for a list of available upgradeable contracts


<details>
<summary>Click to show 20 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


6       import {SafeERC20} from "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";


5       import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L5:5

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


8       import {IERC20Metadata} from "@openzeppelin/contracts/token/ERC20/extensions/IERC20Metadata.sol";


5       import {Initializable} from "@openzeppelin/contracts/proxy/utils/Initializable.sol";


9       import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";


10      import {SafeERC20} from "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";


6       import {Ownable2Step} from "@openzeppelin/contracts/access/Ownable2Step.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L6:6

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


5       import {Ownable2Step} from "@openzeppelin/contracts/access/Ownable2Step.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L5:5

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


5       import {Ownable2Step} from "@openzeppelin/contracts/access/Ownable2Step.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L5:5

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


16      import {Ownable2Step} from "@openzeppelin/contracts/access/Ownable2Step.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L16:16

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


5       import {Ownable2Step} from "@openzeppelin/contracts/access/Ownable2Step.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L5:5

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


5       import {Math} from "@openzeppelin/contracts/utils/math/Math.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L5:5

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


5       import {SafeCast} from "@openzeppelin/contracts/utils/math/SafeCast.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L5:5

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol


5       import {Math} from "@openzeppelin/contracts/utils/math/Math.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L5:5

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


6       import {BeaconProxy} from "@openzeppelin/contracts/proxy/beacon/BeaconProxy.sol";


5       import {Initializable} from "@openzeppelin/contracts/proxy/utils/Initializable.sol";


7       import {UpgradeableBeacon} from "@openzeppelin/contracts/proxy/beacon/UpgradeableBeacon.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L7:7

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


6       import {UpgradeableBeacon} from "@openzeppelin/contracts/proxy/beacon/UpgradeableBeacon.sol";


5       import {ERC20PermitUpgradeable} from "@openzeppelin/contracts-upgradeable/token/ERC20/extensions/draft-ERC20PermitUpgradeable.sol";


7       import {ERC1967Upgrade} from "@openzeppelin/contracts/proxy/ERC1967/ERC1967Upgrade.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L7:7

</details>

## L022 - Multiplication on the result of a division:

Dividing an integer by another integer will often result in loss of precision. When the result is multiplied by another number, the loss of precision is magnified, often to material magnitudes. (X / Z) * Y should be re-written as (X * Y) / Z.


```solidity
File: system-contracts/contracts/L1Messenger.sol


51              return KECCAK_ROUND_GAS_COST * (_length / KECCAK_ROUND_NUMBER_OF_BYTES + 1);


62              return SHA256_ROUND_GAS_COST * ((_length + 8) / SHA256_ROUND_NUMBER_OF_BYTES + 1);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L62:62


## L023 - `decimals()` is not a part of the ERC-20 standard:

The `decimals()` function is not a part of the [ERC-20 standard](https://eips.ethereum.org/EIPS/eip-20), and was added later as an [optional extension](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/extensions/IERC20Metadata.sol). As such, some valid ERC20 tokens do not support this interface, so it is unsafe to blindly cast all tokens to this interface, and then call this function.


```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


264             (, bytes memory data3) = _token.staticcall(abi.encodeCall(IERC20Metadata.decimals, ()));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L264:264

## L024 - `symbol()` is not a part of the ERC-20 standard:

The `symbol()` function is not a part of the [ERC-20 standard](https://eips.ethereum.org/EIPS/eip-20), and was added later as an [optional extension](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/extensions/IERC20Metadata.sol). As such, some valid ERC20 tokens do not support this interface, so it is unsafe to blindly cast all tokens to this interface, and then call this function.


```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


263             (, bytes memory data2) = _token.staticcall(abi.encodeCall(IERC20Metadata.symbol, ()));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L263:263

## L025 - `name()` is not a part of the ERC-20 standard:

The `name()` function is not a part of the [ERC-20 standard](https://eips.ethereum.org/EIPS/eip-20), and was added later as an [optional extension](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/extensions/IERC20Metadata.sol). As such, some valid ERC20 tokens do not support this interface, so it is unsafe to blindly cast all tokens to this interface, and then call this function.


```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


262             (, bytes memory data1) = _token.staticcall(abi.encodeCall(IERC20Metadata.name, ()));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L262:262

## L026 - Missing checks for address(0x0) in the constructor:




```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


96              l1WethAddress = _l1WethAddress;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L96:96

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


46              securityCouncil = _securityCouncil;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L46:46

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


59              bridgehub = _bridgehub;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L59:59

## L027 - Missing checks for address(0x0) in the initializer:




```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


41          function initialize(address _owner) external reentrancyGuardInitializer {
42              _transferOwnership(_owner);
43          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L41:43

## L028 - Governance functions should be controlled by time locks:

Governance functions (such as upgrading contracts, setting critical parameters) should be controlled using time locks to introduce a delay between a proposal and its execution. This gives users time to exit before a potentially dangerous or malicious operation is applied.


<details>
<summary>Click to show 19 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


116         function transferFundsFromLegacy(address _token, address _target, uint256 _targetChainId) external onlyOwner {

142         function initializeChainGovernance(uint256 _chainId, address _l2BridgeAddress) external onlyOwner {

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L142:144

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


108         function setSharedBridge(address _sharedBridge) external onlyOwner {

92          function removeStateTransitionManager(address _stateTransitionManager) external onlyOwner {

82          function addStateTransitionManager(address _stateTransitionManager) external onlyOwner {

101         function addToken(address _token) external onlyOwner {

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L101:104

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


129         function scheduleTransparent(Operation calldata _operation, uint256 _delay) external onlyOwner {

154         function cancel(bytes32 _id) external onlyOwner {

142         function scheduleShadow(bytes32 _id, uint256 _delay) external onlyOwner {

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L142:145

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


160         function freezeChain(uint256 _chainId) external onlyOwner {

230         function registerAlreadyDeployedStateTransition(
231             uint256 _chainId,
232             address _stateTransitionContract
233         ) external onlyOwner {

165         function unfreezeChain(uint256 _chainId) external onlyOwner {

152         function setUpgradeDiamondCut(
153             Diamond.DiamondCutData calldata _cutData,
154             uint256 _oldProtocolVersion
155         ) external onlyOwner {

142         function setNewVersionUpgrade(
143             Diamond.DiamondCutData calldata _cutData,
144             uint256 _oldProtocolVersion,
145             uint256 _newProtocolVersion
146         ) external onlyOwner {

137         function setInitialCutHash(Diamond.DiamondCutData calldata _diamondCut) external onlyOwner {

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L137:139

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


73          function setStateTransitionManager(IStateTransitionManager _stateTransitionManager) external onlyOwner {

96          function setExecutionDelay(uint32 _executionDelay) external onlyOwner {

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L96:99

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


23          function setPendingAdmin(address _newPendingAdmin) external onlyAdmin {

89          function setValidiumMode(PubdataPricingMode _validiumMode) external onlyAdmin {

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L89:93

</details>

## L029 - Code does not follow the best practice of check-effects-interaction:

Code should follow the best-practice of [check-effects-interaction](https://blockchain-academy.hs-mittweida.de/courses/solidity-coding-beginners-to-intermediate/lessons/solidity-11-coding-patterns/topic/checks-effects-interactions/), where state variables are updated before any external calls are made. Doing so prevents a large class of reentrancy bugs.


<details>
<summary>Click to show 7 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


/// @audit IMailbox.transferEthToSharedBridge() called prior to this assignment
133                 chainBalance[_targetChainId][_token] = chainBalance[_targetChainId][_token] + amount;


/// @audit _depositFunds() called prior to this assignment
/// @audit contains nested function call _token.balanceOf() 
/// @audit located in file zksync/contracts/ethereum/contracts/bridge/L1SharedBridge.sol  
165                 chainBalance[_chainId][_l1Token] += _amount;


/// @audit _depositFunds() called prior to this assignment
/// @audit contains nested function call _token.balanceOf() 
/// @audit located in file zksync/contracts/ethereum/contracts/bridge/L1SharedBridge.sol  
212                 chainBalance[_chainId][_l1Token] += amount;


/// @audit _finalizeWithdrawal() called prior to this assignment
/// @audit contains nested function call IGetters.isEthWithdrawalFinalized() 
/// @audit located in file zksync/contracts/ethereum/contracts/bridge/L1SharedBridge.sol  
440                 chainBalance[_chainId][l1Token] -= amount;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L440:440

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


/// @audit bytes.concat() called prior to this assignment
282             stateTransition[_chainId] = stateTransitionAddress;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L282:282

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


/// @audit IStateTransitionManager.protocolVersion() called prior to this assignment
260                 s.storedBatchHashes[_lastCommittedBatchData.batchNumber] = _hashStoredBatchInfo(_lastCommittedBatchData);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L260:260

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


/// @audit l2TokenAddress() called prior to this assignment
/// @audit contains nested function call bytes.concat() 
/// @audit located in file zksync/contracts/zksync/contracts/bridge/L2SharedBridge.sol  
99                  l1TokenAddress[expectedL2Token] = _l1Token;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L99:99

</details>

## L030 - addresses upcast and compared to values larger than a uint160, may result in collisions:

If the value is being compared to an input value in order to reject it, rather than allowing it to be converted to an address, the check will pass if the value is larger than type(uint160).max, even if, when cast, it matches the gating address.


```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


95              return _addr == uint256(uint160(address(BASE_TOKEN_SYSTEM_CONTRACT))) || _addr == 0;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L95:95

## L031 - Missing checks for address(0x0) when updating address state variables:

issing checks for address(0x0) when updating address state variables


<details>
<summary>Click to show 17 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


96              l1WethAddress = _l1WethAddress;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L96:96

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


55              pendingAdmin = _newPendingAdmin;


65              admin = currentPendingAdmin;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L65:65

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


46              securityCouncil = _securityCouncil;


258             securityCouncil = _newSecurityCouncil;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L258:258

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


59              bridgehub = _bridgehub;


114             pendingAdmin = _newPendingAdmin;


124             admin = currentPendingAdmin;


133             validatorTimelock = _validatorTimelock;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L133:133

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


27              s.pendingAdmin = _newPendingAdmin;


37              s.admin = pendingAdmin;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L37:37

```solidity
File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol


30                  l2Address = address(uint160(l1Address) + offset);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L30:30

```solidity
File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol


30                  l2Address = address(uint160(l1Address) + offset);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L30:30

```solidity
File: system-contracts/contracts/ContractDeployer.sol


109             newAddress = address(uint160(uint256(hash)));


125             newAddress = address(uint160(uint256(hash)));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L125:125

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


32              to = address(uint160(addressAsUint));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L32:32

```solidity
File: system-contracts/contracts/SystemContext.sol


100             origin = _newOrigin;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L100:100

</details>

## L032 - The additions/multiplications may silently overflow because they're in unchecked blocks with no preceding value checks, which may lead to unexpected results.:

The additions/multiplications may silently overflow because they're in unchecked blocks with no preceding value checks, which may lead to unexpected results.


<details>
<summary>Click to show 45 findings</summary>

```solidity
File: contracts/ethereum/contracts/common/libraries/UncheckedMath.sol


13                  return _number + 1;


19                  return _lhs + _rhs;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UncheckedMath.sol#L19:19

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


195                     require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed


217                     require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L217:217

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/LibMap.sol


23                  uint256 mapValue = _map.map[_index / 8];


27                  uint256 bitOffset = (_index & 7) * 32;


43                  uint256 mapIndex = _index / 8;


48                  uint256 bitOffset = (_index & 7) * 32;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L48:48

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol


118                 txBodyGasLimit = _totalGasLimit - overhead;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L118:118

```solidity
File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol


30                  l2Address = address(uint160(l1Address) + offset);


40                  l1Address = address(uint160(l2Address) - offset);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L40:40

```solidity
File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol


30                  l2Address = address(uint160(l1Address) + offset);


40                  l1Address = address(uint160(l2Address) - offset);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L40:40

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


105                 uint256 listLength = encodedNonce.length +
106                     encodedGasParam.length +
107                     encodedTo.length +
108                     encodedValue.length +
109                     encodedDataLength.length +
110                     _transaction.data.length +
111                     rEncoded.length +
112                     sEncoded.length +
113                     vEncoded.length;


198                 uint256 listLength = encodedFixedLengthParams.length +
199                     encodedDataLength.length +
200                     _transaction.data.length +
201                     encodedAccessListLength.length +
202                     rEncoded.length +
203                     sEncoded.length +
204                     vEncoded.length;


293                 uint256 listLength = encodedFixedLengthParams.length +
294                     encodedDataLength.length +
295                     _transaction.data.length +
296                     encodedAccessListLength.length +
297                     rEncoded.length +
298                     sEncoded.length +
299                     vEncoded.length;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L293:299

```solidity
File: system-contracts/contracts/Compressor.sol


52                      encodedData.length * 4 == _bytecode.length,


57                      dictionary.length / 8 <= encodedData.length / 2,


62                      uint256 indexOfEncodedChunk = uint256(encodedData.readUint16(encodedDataPointer)) * 8;


66                      uint64 realChunk = _bytecode.readUint64(encodedDataPointer * 4);


203                 dictionary = _rawCompressedData[2:2 + dictionaryLen * 8];


204                 encodedData = _rawCompressedData[2 + dictionaryLen * 8:];


233                         _initialValue + convertedValue == _finalValue,


238                         _initialValue - convertedValue == _finalValue,


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L238:238

```solidity
File: system-contracts/contracts/L1Messenger.sol


140                 pubdataLen = 4 + _message.length + L2_TO_L1_LOG_SERIALIZE_SIZE;


171                 pubdataLen = 4 + bytecodeLen;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L171:171

```solidity
File: system-contracts/contracts/L2BaseToken.sol


43                  balance[_from] = fromBalance - _amount;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L43:43

```solidity
File: system-contracts/contracts/NonceHolder.sol


72                  rawNonces[addressAsKey] = (oldRawNonce + _value);


118                 rawNonces[addressAsKey] = oldRawNonce + 1;


144                 rawNonces[addressAsKey] = (oldRawNonce + DEPLOY_NONCE_MULTIPLIER);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L144:144

```solidity
File: system-contracts/contracts/SystemContext.sol


248                 bytes32 correctPrevBlockHash = _calculateLegacyL2BlockHash(_l2BlockNumber - 1);


255                 _setL2BlockHash(_l2BlockNumber - 1, correctPrevBlockHash);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L255:255

```solidity
File: system-contracts/contracts/libraries/RLPEncoder.sol


33                      encoded = new bytes(hbs + 2);


34                      encoded[0] = bytes1(uint8(hbs + 0x81));


36                      uint256 lbs = 31 - hbs;


37                      uint256 shiftedVal = _val << (lbs * 8);


64                      encoded[0] = bytes1(uint8(_len + _offset));


68                      encoded = new bytes(hbs + 2);


69                      encoded[0] = bytes1(uint8(_offset + hbs + 56));


71                      uint256 lbs = 31 - hbs;


72                      uint256 shiftedVal = uint256(_len) << (lbs * 8);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L72:72

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


190                 uint256 listLength = encodedNonce.length +
191                     encodedGasParam.length +
192                     encodedTo.length +
193                     encodedValue.length +
194                     encodedDataLength.length +
195                     _transaction.data.length +
196                     encodedChainId.length;


265                 uint256 listLength = encodedFixedLengthParams.length +
266                     encodedDataLength.length +
267                     _transaction.data.length +
268                     encodedAccessListLength.length;


337                 uint256 listLength = encodedFixedLengthParams.length +
338                     encodedDataLength.length +
339                     _transaction.data.length +
340                     encodedAccessListLength.length;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L337:340

```solidity
File: system-contracts/contracts/libraries/Utils.sol


46                  codeLengthInWords = uint256(uint8(_bytecodeHash[2])) * 256 + uint256(uint8(_bytecodeHash[3]));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L46:46

</details>









## NC001 - Empty bytes check is missing:

When developing smart contracts in Solidity, it's crucial to validate the inputs of your functions. This includes ensuring that the bytes parameters are not empty, especially when they represent crucial data such as addresses, identifiers, or raw data that the contract needs to process.Missing empty bytes checks can lead to unexpected behaviour in your contract.For instance, certain operations might fail, produce incorrect results, or consume unnecessary gas when performed with empty bytes.  Moreover, missing input validation can potentially expose your contract to malicious activity, including exploitation of unhandled edge cases.To mitigate these issues, always validate that bytes parameters are not empty when the logic of your contract requires it.


<details>
<summary>Click to show 75 findings</summary>

```solidity
File: contracts/GasBoundCaller.sol


35          function gasBoundCall(address _to, uint256 _maxTotalGas, bytes calldata _data) external payable {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L35:35

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


208         function finalizeWithdrawal(
209             uint256 _l2BatchNumber,
210             uint256 _l2MessageIndex,
211             uint16 _l2TxNumberInBatch,
212             bytes calldata _message,
213             bytes32[] calldata _merkleProof
214         ) external nonReentrant {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L208:214

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


182         function bridgehubDeposit(
183             uint256 _chainId,
184             address _prevMsgSender,
185             uint256, // l2Value, needed for Weth deposits in the future
186             bytes calldata _data
187         ) external payable override onlyBridgehub returns (L2TransactionRequestTwoBridgesInner memory request) {


385         function finalizeWithdrawal(
386             uint256 _chainId,
387             uint256 _l2BatchNumber,
388             uint256 _l2MessageIndex,
389             uint16 _l2TxNumberInBatch,
390             bytes calldata _message,
391             bytes32[] calldata _merkleProof
392         ) external override {


409         function _finalizeWithdrawal(
410             uint256 _chainId,
411             uint256 _l2BatchNumber,
412             uint256 _l2MessageIndex,
413             uint16 _l2TxNumberInBatch,
414             bytes calldata _message,
415             bytes32[] calldata _merkleProof
416         ) internal nonReentrant returns (address l1Receiver, address l1Token, uint256 amount) {


458         function _checkWithdrawal(
459             uint256 _chainId,
460             MessageParams memory _messageParams,
461             bytes calldata _message,
462             bytes32[] calldata _merkleProof
463         ) internal view returns (address l1Receiver, address l1Token, uint256 amount) {


487         function _parseL2WithdrawalMessage(
488             uint256 _chainId,
489             bytes memory _l2ToL1message
490         ) internal view returns (address l1Receiver, address l1Token, uint256 amount) {


615         function finalizeWithdrawalLegacyErc20Bridge(
616             uint256 _l2BatchNumber,
617             uint256 _l2MessageIndex,
618             uint16 _l2TxNumberInBatch,
619             bytes calldata _message,
620             bytes32[] calldata _merkleProof
621         ) external override onlyLegacyBridge returns (address l1Receiver, address l1Token, uint256 amount) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L615:621

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


114         function createNewChain(
115             uint256 _chainId,
116             address _stateTransitionManager,
117             address _baseToken,
118             uint256, //_salt
119             address _admin,
120             bytes calldata _initData
121         ) external onlyOwnerOrAdmin nonReentrant returns (uint256 chainId) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L114:121

```solidity
File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol


21          function hashL2Bytecode(bytes memory _bytecode) internal pure returns (bytes32 hashedBytecode) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L21:21

```solidity
File: contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol


19          function readUint32(bytes memory _bytes, uint256 _start) internal pure returns (uint32 result, uint256 offset) {


26          function readAddress(bytes memory _bytes, uint256 _start) internal pure returns (address result, uint256 offset) {


33          function readUint256(bytes memory _bytes, uint256 _start) internal pure returns (uint256 result, uint256 offset) {


40          function readBytes32(bytes memory _bytes, uint256 _start) internal pure returns (bytes32 result, uint256 offset) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L40:40

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


239         function createNewChain(
240             uint256 _chainId,
241             address _baseToken,
242             address _sharedBridge,
243             address _admin,
244             bytes calldata _diamondCut
245         ) external onlyBridgehub {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L239:245

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


605         function _pointEvaluationPrecompile(
606             bytes32 _versionedHash,
607             bytes32 _openingPoint,
608             bytes calldata _openingValueCommitmentProof
609         ) internal view {


625         function _verifyBlobInformation(
626             bytes calldata _pubdataCommitments,
627             bytes32[] memory _blobHashes
628         ) internal view returns (bytes32[] memory blobCommitments) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L625:628

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


178         function finalizeEthWithdrawal(
179             uint256 _l2BatchNumber,
180             uint256 _l2MessageIndex,
181             uint16 _l2TxNumberInBatch,
182             bytes calldata _message,
183             bytes32[] calldata _merkleProof
184         ) external nonReentrant {


197         function requestL2Transaction(
198             address _contractL2,
199             uint256 _l2Value,
200             bytes calldata _calldata,
201             uint256 _l2GasLimit,
202             uint256 _l2GasPerPubdataByteLimit,
203             bytes[] calldata _factoryDeps,
204             address _refundRecipient
205         ) external payable returns (bytes32 canonicalTxHash) {


258         function _requestL2Transaction(
259             uint256 _mintValue,
260             WritePriorityOpParams memory _params,
261             bytes memory _calldata,
262             bytes[] memory _factoryDeps
263         ) internal returns (bytes32 canonicalTxHash) {


289         function _serializeL2Transaction(
290             WritePriorityOpParams memory _priorityOpParams,
291             bytes memory _calldata,
292             bytes[] memory _factoryDeps
293         ) internal pure returns (L2CanonicalTransaction memory transaction) {


316         function _writePriorityOp(
317             WritePriorityOpParams memory _priorityOpParams,
318             bytes memory _calldata,
319             bytes[] memory _factoryDeps
320         ) internal returns (bytes32 canonicalTxHash) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L316:320

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


278         function _initializeDiamondCut(address _init, bytes memory _calldata) private {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L278:278

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol


19          function validateL1ToL2Transaction(
20              L2CanonicalTransaction memory _transaction,
21              bytes memory _encoded,
22              uint256 _priorityTxMaxGasLimit,
23              uint256 _priorityTxMaxPubdata
24          ) internal pure {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L19:24

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


263         function _upgradeL1Contract(bytes calldata _customCallDataForUpgrade) internal virtual {}


269         function _postUpgrade(bytes calldata _customCallDataForUpgrade) internal virtual {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L269:269

```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


90          function sendMessageToL1(bytes memory _message) internal returns (bytes32) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L90:90

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


37          function systemCall(uint32 gasLimit, address to, uint256 value, bytes memory data) internal returns (bool success) {


76          function systemCallWithReturndata(
77              uint32 gasLimit,
78              address to,
79              uint128 value,
80              bytes memory data
81          ) internal returns (bool success, bytes memory returnData) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L76:81

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


79          function finalizeDeposit(
80              address _l1Sender,
81              address _l2Receiver,
82              address _l1Token,
83              uint256 _amount,
84              bytes calldata _data
85          ) external payable override {


109         function _deployL2Token(address _l1Token, bytes calldata _data) internal returns (address) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L109:109

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


50          function bridgeInitialize(address _l1Address, bytes memory _data) external initializer {


178         function decodeString(bytes memory _input) external pure returns (string memory result) {


183         function decodeUint8(bytes memory _input) external pure returns (uint8 result) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L183:183

```solidity
File: system-contracts/contracts/ComplexUpgrader.sol


21          function upgrade(address _delegateTo, bytes calldata _calldata) external payable {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L21:21

```solidity
File: system-contracts/contracts/Compressor.sol


44          function publishCompressedBytecode(
45              bytes calldata _bytecode,
46              bytes calldata _rawCompressedData
47          ) external payable onlyCallFromBootloader returns (bytes32 bytecodeHash) {


110         function verifyCompressedStateDiffs(
111             uint256 _numberOfStateDiffs,
112             uint256 _enumerationIndexSize,
113             bytes calldata _stateDiffs,
114             bytes calldata _compressedStateDiffs
115         ) external payable onlyCallFrom(address(L1_MESSENGER_CONTRACT)) returns (bytes32 stateDiffHash) {


197         function _decodeRawBytecode(
198             bytes calldata _rawCompressedData
199         ) internal pure returns (bytes calldata dictionary, bytes calldata encodedData) {


220         function _verifyValueCompression(
221             uint256 _initialValue,
222             uint256 _finalValue,
223             uint256 _operation,
224             bytes calldata _compressedValue
225         ) internal pure {


251         function _sliceToUint256(bytes calldata _calldataSlice) internal pure returns (uint256 number) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L251:251

```solidity
File: system-contracts/contracts/ContractDeployer.sol


95          function getNewAddressCreate2(
96              address _sender,
97              bytes32 _bytecodeHash,
98              bytes32 _salt,
99              bytes calldata _input
100         ) public view override returns (address newAddress) {


132         function create2(
133             bytes32 _salt,
134             bytes32 _bytecodeHash,
135             bytes calldata _input
136         ) external payable override returns (address) {


147         function create(
148             bytes32 _salt,
149             bytes32 _bytecodeHash,
150             bytes calldata _input
151         ) external payable override returns (address) {


162         function create2Account(
163             bytes32 _salt,
164             bytes32 _bytecodeHash,
165             bytes calldata _input,
166             AccountAbstractionVersion _aaVersion
167         ) public payable override onlySystemCall returns (address) {


182         function createAccount(
183             bytes32, // salt
184             bytes32 _bytecodeHash,
185             bytes calldata _input,
186             AccountAbstractionVersion _aaVersion
187         ) public payable override onlySystemCall returns (address) {


258         function _nonSystemDeployOnAddress(
259             bytes32 _bytecodeHash,
260             address _newAddress,
261             AccountAbstractionVersion _aaVersion,
262             bytes calldata _input
263         ) internal {


283         function _performDeployOnAddress(
284             bytes32 _bytecodeHash,
285             address _newAddress,
286             AccountAbstractionVersion _aaVersion,
287             bytes calldata _input
288         ) internal {


321         function _constructContract(
322             address _sender,
323             address _newAddress,
324             bytes32 _bytecodeHash,
325             bytes calldata _input,
326             bool _isSystem,
327             bool _callConstructor
328         ) internal {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L321:328

```solidity
File: system-contracts/contracts/DefaultAccount.sol


159         function _isValidSignature(bytes32 _hash, bytes memory _signature) internal view returns (bool) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L159:159

```solidity
File: system-contracts/contracts/L1Messenger.sol


116         function sendToL1(bytes calldata _message) external override returns (bytes32 hash) {


194         function publishPubdataAndClearState(
195             bytes calldata _totalL2ToL1PubdataAndStateDiffs
196         ) external onlyCallFromBootloader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L194:196

```solidity
File: system-contracts/contracts/L2BaseToken.sol


85          function withdrawWithMessage(address _l1Receiver, bytes memory _additionalData) external payable override {


117         function _getExtendedWithdrawMessage(
118             address _to,
119             uint256 _amount,
120             address _sender,
121             bytes memory _additionalData
122         ) internal pure returns (bytes memory) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L117:122

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


47          fallback(bytes calldata _data) external onlySystemCall returns (bytes memory) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L47:47

```solidity
File: system-contracts/contracts/PubdataChunkPublisher.sol


21          function chunkAndPublishPubdata(bytes calldata _pubdata) external onlyCallFrom(address(L1_MESSENGER_CONTRACT)) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L21:21

```solidity
File: system-contracts/contracts/libraries/EfficientCall.sol


36          function keccak(bytes calldata _data) internal view returns (bytes32) {


45          function sha(bytes calldata _data) internal view returns (bytes32) {


58          function call(
59              uint256 _gas,
60              address _address,
61              uint256 _value,
62              bytes calldata _data,
63              bool _isSystem
64          ) internal returns (bytes memory returnData) {


74          function staticCall(
75              uint256 _gas,
76              address _address,
77              bytes calldata _data
78          ) internal view returns (bytes memory returnData) {


88          function delegateCall(
89              uint256 _gas,
90              address _address,
91              bytes calldata _data
92          ) internal returns (bytes memory returnData) {


105         function mimicCall(
106             uint256 _gas,
107             address _address,
108             bytes calldata _data,
109             address _whoToMimic,
110             bool _isConstructor,
111             bool _isSystem
112         ) internal returns (bytes memory returnData) {


124         function rawCall(
125             uint256 _gas,
126             address _address,
127             uint256 _value,
128             bytes calldata _data,
129             bool _isSystem
130         ) internal returns (bool success) {


159         function rawStaticCall(uint256 _gas, address _address, bytes calldata _data) internal view returns (bool success) {


173         function rawDelegateCall(uint256 _gas, address _address, bytes calldata _data) internal returns (bool success) {


191         function rawMimicCall(
192             uint256 _gas,
193             address _address,
194             bytes calldata _data,
195             address _whoToMimic,
196             bool _isConstructor,
197             bool _isSystem
198         ) internal returns (bool success) {


245         function _loadFarCallABIIntoActivePtr(
246             uint256 _gas,
247             bytes calldata _data,
248             bool _isConstructor,
249             bool _isSystem
250         ) private view {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L245:250

```solidity
File: system-contracts/contracts/libraries/SystemContractsCaller.sol


76          function systemCall(uint32 gasLimit, address to, uint256 value, bytes memory data) internal returns (bool success) {


123         function systemCallWithReturndata(
124             uint32 gasLimit,
125             address to,
126             uint128 value,
127             bytes memory data
128         ) internal returns (bool success, bytes memory returnData) {


150         function systemCallWithPropagatedRevert(
151             uint32 gasLimit,
152             address to,
153             uint128 value,
154             bytes memory data
155         ) internal returns (bytes memory returnData) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L150:155

```solidity
File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol


19          function readUint16(bytes calldata _bytes, uint256 _start) internal pure returns (uint16 result) {


26          function readUint32(bytes calldata _bytes, uint256 _start) internal pure returns (uint32 result) {


33          function readUint64(bytes calldata _bytes, uint256 _start) internal pure returns (uint64 result) {


40          function readBytes32(bytes calldata _bytes, uint256 _start) internal pure returns (bytes32 result) {


46          function readUint256(bytes calldata _bytes, uint256 _start) internal pure returns (uint256 result) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L46:46

```solidity
File: system-contracts/contracts/libraries/Utils.sol


82          function hashL2Bytecode(bytes calldata _bytecode) internal view returns (bytes32 hashedBytecode) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L82:82

</details>



## NC002 - The `nonReentrant` `modifier` should occur before all other modifiers:



```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


554         function depositLegacyErc20Bridge(
555             address _prevMsgSender,
556             address _l2Receiver,
557             address _l1Token,
558             uint256 _amount,
559             uint256 _l2TxGasLimit,
560             uint256 _l2TxGasPerPubdataByte,
561             address _refundRecipient
562         ) external payable override onlyLegacyBridge nonReentrant returns (bytes32 l2TxHash) {
563             require(l2BridgeAddress[ERA_CHAIN_ID] != address(0), "ShB b. n dep");
564             require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported 2");
565     
566             // Note that funds have been transferred to this contract in the legacy ERC20 bridge.
567             if (!hyperbridgingEnabled[ERA_CHAIN_ID]) {
568                 chainBalance[ERA_CHAIN_ID][_l1Token] += _amount;
569             }
570     
571             bytes memory l2TxCalldata = _getDepositL2Calldata(_prevMsgSender, _l2Receiver, _l1Token, _amount);
572     
573             {
574                 // If the refund recipient is not specified, the refund will be sent to the sender of the transaction.
575                 // Otherwise, the refund will be sent to the specified address.
576                 // If the recipient is a contract on L1, the address alias will be applied.
577                 address refundRecipient = _refundRecipient;
578                 if (_refundRecipient == address(0)) {
579                     refundRecipient = _prevMsgSender != tx.origin
580                         ? AddressAliasHelper.applyL1ToL2Alias(_prevMsgSender)
581                         : _prevMsgSender;
582                 }
583     
584                 L2TransactionRequestDirect memory request = L2TransactionRequestDirect({
585                     chainId: ERA_CHAIN_ID,
586                     l2Contract: l2BridgeAddress[ERA_CHAIN_ID],
587                     mintValue: msg.value, // l2 gas + l2 msg.Value the bridgehub will withdraw the mintValue from the base token bridge for gas
588                     l2Value: 0, // L2 msg.value, this contract doesn't support base token deposits or wrapping functionality, for direct deposits use bridgehub
589                     l2Calldata: l2TxCalldata,
590                     l2GasLimit: _l2TxGasLimit,
591                     l2GasPerPubdataByteLimit: _l2TxGasPerPubdataByte,
592                     factoryDeps: new bytes[](0),
593                     refundRecipient: refundRecipient
594                 });
595                 l2TxHash = bridgehub.requestL2TransactionDirect{value: msg.value}(request);
596             }
597     
598             bytes32 txDataHash = keccak256(abi.encode(_prevMsgSender, _l1Token, _amount));
599             // Save the deposited amount to claim funds on L1 if the deposit failed on L2
600             depositHappened[ERA_CHAIN_ID][l2TxHash] = txDataHash;
601     
602             emit LegacyDepositInitiated(ERA_CHAIN_ID, l2TxHash, _prevMsgSender, _l2Receiver, _l1Token, _amount);
603         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L554:603

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


114         function createNewChain(
115             uint256 _chainId,
116             address _stateTransitionManager,
117             address _baseToken,
118             uint256, //_salt
119             address _admin,
120             bytes calldata _initData
121         ) external onlyOwnerOrAdmin nonReentrant returns (uint256 chainId) {
122             require(_chainId != 0, "Bridgehub: chainId cannot be 0");
123             require(_chainId <= type(uint48).max, "Bridgehub: chainId too large");
124     
125             require(
126                 stateTransitionManagerIsRegistered[_stateTransitionManager],
127                 "Bridgehub: state transition not registered"
128             );
129             require(tokenIsRegistered[_baseToken], "Bridgehub: token not registered");
130             require(address(sharedBridge) != address(0), "Bridgehub: weth bridge not set");
131     
132             require(stateTransitionManager[_chainId] == address(0), "Bridgehub: chainId already registered");
133     
134             stateTransitionManager[_chainId] = _stateTransitionManager;
135             baseToken[_chainId] = _baseToken;
136     
137             IStateTransitionManager(_stateTransitionManager).createNewChain(
138                 _chainId,
139                 _baseToken,
140                 address(sharedBridge),
141                 _admin,
142                 _initData
143             );
144     
145             emit NewChain(_chainId, _stateTransitionManager, _admin);
146             return _chainId;
147         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L114:147

## NC003 - `require()`/`revert()` statements should have descriptive reason strings:

Ensure that `require()` and `revert()` statements include a reason string for better error reporting.


<details>
<summary>Click to show 5 findings</summary>

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


51                  require(_newBatch.pubdataCommitments.length == 1);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L51:51

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


161             if (availableGetters.ignoreName) revert();


167             if (availableGetters.ignoreSymbol) revert();


173             if (availableGetters.ignoreDecimals) revert();


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L173:173

```solidity
File: system-contracts/contracts/interfaces/ISystemContract.sol


55              require(msg.sender == FORCE_DEPLOYER);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L55:55

</details>

## NC004 - Avoid mutating function parameters:

Function parameters in Solidity are passed by value, meaning they are essentially local copies. Mutating them can lead to confusion and errors because the changes don't persist outside the function. By keeping function parameters immutable, you ensure clarity in code behavior, preventing unintended side-effects. If you need to modify a value based on a parameter, use a local variable inside the function, leaving the original parameter unaltered. By adhering to this practice, you maintain a clear distinction between input data and the internal processing logic, improving code readability and reducing the potential for bugs.

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol
258                 _lastCommittedBatchData = _commitOneBatch(_lastCommittedBatchData, _newBatchesData[i], bytes32(0));

292                 _lastCommittedBatchData = _commitOneBatch(
```
https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L292:292


## NC005 - Event is not properly indexed:

Index event fields make the field more quickly accessible to off-chain tools that parse events. This is especially useful when it comes to filtering based on an address. However, note that each index field costs extra gas during emission, so it's not necessarily best to index the maximum allowed per event (three fields). Where applicable, each event should use three indexed fields if there are three or more fields, and gas usage is not particularly of concern for the events in question. If there are fewer than three applicable fields, all of the applicable fields should be indexed.


<details>
<summary>Click to show 4 findings</summary>

```solidity
File: contracts/ethereum/contracts/governance/IGovernance.sol


77          event ChangeSecurityCouncil(address _securityCouncilBefore, address _securityCouncilAfter);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L77:77

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


32          event ValidatorAdded(uint256 _chainId, address _addedValidator);


35          event ValidatorRemoved(uint256 _chainId, address _removedValidator);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L35:35

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


24          event DiamondCut(FacetCut[] facetCuts, address initAddress, bytes initCalldata);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L24:24

</details>

## NC006 - Function ordering does not follow the Solidity style guide:

According to the [Solidity style guide](https://docs.soliditylang.org/en/v0.8.17/style-guide.html#order-of-functions), functions should be laid out in the following order :`constructor()`, `receive()`, `fallback()`, `external`, `public`, `internal`, `private`, but the cases below do not follow this pattern.


<details>
<summary>Click to show 41 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


176         function claimFailedDeposit(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L176:176

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


182         function bridgehubDeposit(


277         function claimFailedDeposit(


385         function finalizeWithdrawal(


554         function depositLegacyErc20Bridge(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L554:554

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


82          function addStateTransitionManager(address _stateTransitionManager) external onlyOwner {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L82:82

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


129         function scheduleTransparent(Operation calldata _operation, uint256 _delay) external onlyOwner {


249         function updateDelay(uint256 _newDelay) external onlySelf {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L249:249

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


230         function registerAlreadyDeployedStateTransition(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L230:230

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


199         function commitBatches(


337         function executeBatchesSharedBridge(


368         function proveBatches(


472         function revertBatches(uint256 _newLastBatch) external nonReentrant onlyValidatorOrStateTransitionManager {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L472:472

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


64          function proveL2LogInclusion(


143         function l2TransactionBaseCost(


178         function finalizeEthWithdrawal(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L178:178

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


163         function _upgradeVerifier(address _newVerifier, VerifierParams calldata _verifierParams) internal {


236         function _setNewProtocolVersion(uint256 _newProtocolVersion) internal virtual {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L236:236

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol


47          function upgrade(ProposedUpgrade calldata _proposedUpgrade) public virtual override returns (bytes32) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L47:47

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


123         function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external override {


149         function l2TokenAddress(address _l1Token) public view override returns (address) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L149:149

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


178         function decodeString(bytes memory _input) external pure returns (string memory result) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L178:178

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


78          function getRawCodeHash(address _address) public view override returns (bytes32 codeHash) {


89          function getCodeHash(uint256 _input) external view override returns (bytes32) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L89:89

```solidity
File: system-contracts/contracts/ContractDeployer.sol


65          function updateAccountVersion(AccountAbstractionVersion _version) external onlySystemCall {


132         function create2(


213         function forceDeployOnAddress(ForceDeployment calldata _deployment, address _sender) external payable onlySelf {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L213:213

```solidity
File: system-contracts/contracts/DefaultAccount.sol


112         function executeTransaction(


196         function payForTransaction(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L196:196

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


65          function getMarker(bytes32 _hash) public view override returns (uint256 marker) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L65:65

```solidity
File: system-contracts/contracts/L1Messenger.sol


70          function sendL2ToL1Log(


116         function sendToL1(bytes calldata _message) external override returns (bytes32 hash) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L116:116

```solidity
File: system-contracts/contracts/L2BaseToken.sol


128         function name() external pure override returns (string memory) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L128:128

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


47          fallback(bytes calldata _data) external onlySystemCall returns (bytes memory) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L47:47

```solidity
File: system-contracts/contracts/NonceHolder.sol


110         function incrementMinNonceIfEquals(uint256 _expectedNonce) external onlySystemCall {


166         function validateNonceUsage(address _address, uint256 _key, bool _shouldBeUsed) external view {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L166:166

```solidity
File: system-contracts/contracts/SystemContext.sol


122         function getCurrentPubdataCost() external view returns (uint256) {


341         function setL2Block(


444         function setNewBatch(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L444:444

```solidity
File: system-contracts/contracts/libraries/EfficientCall.sol


232         function propagateRevert() internal pure {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L232:232

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


362         function processPaymasterInput(Transaction calldata _transaction) internal {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L362:362

</details>

## NC007 - Imports could be organized more systematically:

This issue arises when the contract's interface is not imported first, followed by each of the interfaces it uses, followed by all other files.


<details>
<summary>Click to show 20 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


22      import {IBridgehub, L2TransactionRequestTwoBridgesInner, L2TransactionRequestDirect} from "../bridgehub/IBridgehub.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L22:22

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


11      import "../state-transition/chain-interfaces/IZkSyncStateTransition.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L11:11

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


7       import "../state-transition/IStateTransitionManager.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L7:7

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


7       import {IAdmin} from "./chain-interfaces/IAdmin.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L7:7

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


7       import {IExecutor} from "./chain-interfaces/IExecutor.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L7:7

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


9       import {InitializeData, IDiamondInit} from "../chain-interfaces/IDiamondInit.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L9:9

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


10      import {IStateTransitionManager} from "../../IStateTransitionManager.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L10:10

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


7       import {IExecutor, L2_LOG_ADDRESS_OFFSET, L2_LOG_KEY_OFFSET, L2_LOG_VALUE_OFFSET, SystemLogKey, LogProcessingOutput, PubdataSource, BLS_MODULUS, PUBDATA_COMMITMENT_SIZE, PUBDATA_COMMITMENT_CLAIMED_VALUE_OFFSET, PUBDATA_COMMITMENT_COMMITMENT_OFFSET, MAX_NUMBER_OF_BLOBS, TOTAL_BLOBS_IN_COMMITMENT} from "../../chain-interfaces/IExecutor.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L7:7

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


7       import {VerifierParams} from "../../../state-transition/chain-interfaces/IVerifier.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L7:7

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


21      import {IBridgehub} from "../../../bridgehub/IBridgehub.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L21:21

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol


6       import {IVerifier, VerifierParams} from "./IVerifier.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L6:6

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol


6       import {VerifierParams} from "../chain-interfaces/IVerifier.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L6:6

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol


10      import {VerifierParams} from "./IVerifier.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol#L10:10

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


6       import {IMailbox} from "../state-transition/chain-interfaces/IMailbox.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L6:6

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol


6       import "../state-transition/chain-interfaces/IMailbox.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L6:6

```solidity
File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol


7       import "./IDefaultUpgrade.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L7:7

```solidity
File: system-contracts/contracts/ContractDeployer.sol


12      import {ISystemContract} from "./interfaces/ISystemContract.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L12:12

```solidity
File: system-contracts/contracts/L2BaseToken.sol


8       import {IMailbox} from "./interfaces/IMailbox.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L8:8

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


7       import {ISystemContract} from "./interfaces/ISystemContract.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L7:7

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


8       import "../interfaces/IPaymasterFlow.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L8:8

</details>

## NC008 - Constants in comparisons should appear on the left side:

This issue arises when constants in comparisons appear on the right side, which can lead to typo bugs.


<details>
<summary>Click to show 145 findings</summary>

```solidity
File: contracts/GasBoundCaller.sol


73              if (pubdataCost != 0) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L73:73

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


141             require(_amount != 0, "0T"); // empty deposit


186             require(amount != 0, "2T"); // empty deposit


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L186:186

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


129                 require(amount > 0, "ShB: 0 amount to transfer");


158                 require(msg.value == 0, "ShB m.v > 0 b d.it");


200                 require(_depositAmount == 0, "ShB wrong withdraw amount");


202                 require(msg.value == 0, "ShB m.v > 0 for BH d.it 2");


208             require(amount != 0, "6T"); // empty deposit amount


237             require(depositHappened[_chainId][_txHash] == 0x00, "ShB tx hap");


327             require(_amount > 0, "y1");


501             require(_l2ToL1message.length >= 56, "ShB wrong msg len"); // wrong messsage length


517                 require(_l2ToL1message.length == 76, "ShB wrong msg len 2");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L517:517

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


122             require(_chainId != 0, "Bridgehub: chainId cannot be 0");


225                     require(msg.value == 0, "Bridgehub: non-eth bridge with msg.value");


329             } else if (_refundRecipient.code.length > 0) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L329:329

```solidity
File: contracts/ethereum/contracts/common/ReentrancyGuard.sol


58              require(lockSlotOldValue == 0, "1B");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L58:58

```solidity
File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol


23              require(_bytecode.length % 32 == 0, "pq");


27              require(bytecodeLenInWords % 2 == 1, "ps"); // bytecode length in words must be odd


41              require(version == 1 && _bytecodeHash[1] == bytes1(0), "zf"); // Incorrectly formatted bytecodeHash


43              require(bytecodeLen(_bytecodeHash) % 2 == 1, "uy"); // Code length in words must be odd


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L43:43

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


107             if (timestamp == 0) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L107:107

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


68              require(validators[_chainId][msg.sender] == true, "ValidatorTimelock: only validator");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L68:68

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol


25              require(msg.data.length >= 4 || msg.data.length == 0, "Ut");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L25:25

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


90              require(s.totalBatchesCommitted == 0, "AdminFacet: set validium only after genesis"); // Validium mode can be set only before the first batch is committed


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L90:90

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


50                  require(logOutput.pubdataHash == 0x00, "v0h");


51                  require(_newBatch.pubdataCommitments.length == 1);


192                 require(processedLogs == 511, "b7");


194                 require(processedLogs == 1023, "b8");


231             require(_newBatchesData.length == 1, "e4");


237             if (systemContractsUpgradeTxHash == bytes32(0) || s.l2SystemContractsUpgradeBatchNumber != 0) {


284             require(s.l2SystemContractsUpgradeBatchNumber == 0, "ik");


291                 bytes32 expectedUpgradeTxHash = i == 0 ? _systemContractUpgradeTxHash : bytes32(0);


361             if (batchWhenUpgradeHappened != 0 && batchWhenUpgradeHappened <= newTotalBatchesExecuted) {


426             assert(block.chainid != 1);


429             if (_proof.serializedProof.length > 0) {


442             require(proofPublicInput.length == 1, "t4");


593             return (_bitMap & (1 << _index)) > 0;


631             require(_pubdataCommitments.length > 0, "pl");


633             require(_pubdataCommitments.length % PUBDATA_COMMITMENT_SIZE == 0, "bs");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L633:633

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


169             if (selectorsArrayLen != 0) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L169:169

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


158             require(s.baseTokenGasPriceMultiplierDenominator > 0, "Mailbox: baseTokenGasPriceDenominator not set");


277             if (refundRecipient.code.length > 0) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L277:277

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


107                 require(selectors.length > 0, "B"); // no functions for diamond cut


132             require(_facet.code.length > 0, "G");


155             require(_facet.code.length > 0, "K");


194             if (selectorsLength == 0) {


213             if (selectorPosition != 0) {


250             if (lastSelectorPosition == 0) {


280                 require(_calldata.length == 0, "H"); // Non-empty calldata for zero address


286                     if (data.length <= 4) {


297                 require(data.length == 32, "lp");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L297:297

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol


24              require(pathLength > 0, "xc");


25              require(pathLength < 256, "bt");


30                  currentHash = (_index % 2 == 0)


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L30:30

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol


50              require(_transaction.paymaster == 0, "uc");


51              require(_transaction.value == 0, "ud");


52              require(_transaction.maxFeePerGas == 0, "uq");


53              require(_transaction.maxPriorityFeePerGas == 0, "ux");


54              require(_transaction.reserved[0] == 0, "ue");


56              require(_transaction.reserved[2] == 0, "ug");


57              require(_transaction.reserved[3] == 0, "uo");


58              require(_transaction.signature.length == 0, "uh");


59              require(_transaction.paymasterInput.length == 0, "ul1");


60              require(_transaction.reservedDynamic.length == 0, "um");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L60:60

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


186             if (_l2ProtocolUpgradeTx.txType == 0) {


251                 s.l2SystemContractsUpgradeBatchNumber == 0,


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L251:251

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol


35                  s.l2SystemContractsUpgradeBatchNumber == 0,


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L35:35

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


59              if (value == 0) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L59:59

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


92              require(msg.value == 0, "Value should be 0 for ERC20 bridge");


124             require(_amount > 0, "Amount cannot be zero");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L124:124

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


102             if (codeHash == 0x00 && NONCE_HOLDER_SYSTEM_CONTRACT.getRawNonce(account) > 0) {


133                 codeHash != 0x00 &&


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L133:133

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


69                  if (txDataLen != 1) {


72                  } else if (_transaction.data[0] >= 0x80) {


92                  require(vInt == 27 || vInt == 28, "Invalid v value");


96                  if (_transaction.reserved[0] != 0) {


165                 if (txDataLen != 1) {


168                 } else if (_transaction.data[0] >= 0x80) {


191                 require(vInt == 27 || vInt == 28, "Invalid v value");


260                 if (txDataLen != 1) {


263                 } else if (_transaction.data[0] >= 0x80) {


286                 require(vInt == 27 || vInt == 28, "Invalid v value");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L286:286

```solidity
File: system-contracts/contracts/ComplexUpgrader.sol


24              require(_delegateTo.code.length > 0, "Delegatee is an EOA");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L24:24

```solidity
File: system-contracts/contracts/Compressor.sol


130                 if (enumIndex != 0) {


146                 uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;


162                 if (enumIndex == 0) {


177                 uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;


229                 if (_operation == 0 || _operation == 3) {


231                 } else if (_operation == 1) {


236                 } else if (_operation == 2) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L236:236

```solidity
File: system-contracts/contracts/ContractDeployer.sol


49                  ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.getRawCodeHash(_address) == 0


269                 ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.getCodeHash(uint256(uint160(_newAddress))) == 0x0,


273             require(NONCE_HOLDER_SYSTEM_CONTRACT.getRawNonce(_newAddress) == 0x00, "Account is occupied");


303             require(knownCodeMarker > 0, "The code hash is not known");


332                 if (value > 0) {


339                 if (value > 0) {


350                 require(value == 0, "The value must be zero if we do not call the constructor");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L350:350

```solidity
File: system-contracts/contracts/DefaultAccount.sol


139             if (to == address(DEPLOYER_SYSTEM_CONTRACT) && data.length >= 4) {


160             require(_signature.length == 65, "Signature length is incorrect");


173             require(v == 27 || v == 28, "v is neither 27 nor 28");


184             require(uint256(s) <= 0x7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5D576E7357A4501DDFE92F46681B20A0, "Invalid s");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L184:184

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


47              if (getMarker(_bytecodeHash) == 0) {


76              require(version == 1 && _bytecodeHash[1] == bytes1(0), "Incorrectly formatted bytecodeHash");


78              require(Utils.bytecodeLenInWords(_bytecodeHash) % 2 == 1, "Code length in words must be odd");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L78:78

```solidity
File: system-contracts/contracts/L1Messenger.sol


222             while (nodesOnCurrentLevel > 1) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L222:222

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


30              isSystemCall = (mask & MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT) != 0;


62              if (value != 0) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L62:62

```solidity
File: system-contracts/contracts/NonceHolder.sol


85              require(_value != 0, "Nonce value cannot be set to 0");


88              if (accountInfo.nonceOrdering == IContractDeployer.AccountNonceOrdering.Sequential && _key != 0) {


156             return (_nonce < getMinNonce(_address) || nonceValues[addressAsKey][_nonce] > 0);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L156:156

```solidity
File: system-contracts/contracts/SystemContext.sol


144             if (blockNumber <= _block || blockNumber - _block > 256) {


152                 currentVirtualBlockUpgradeInfo.virtualBlockFinishL2Block > 0


245             require(_l2BlockNumber > 0, "L2 block number is never expected to be zero");


268             if (virtualBlockUpgradeInfo.virtualBlockFinishL2Block != 0) {


277             if (currentVirtualL2BlockInfo.number == 0 && virtualBlockInfo.timestamp == 0) {


287                 require(_maxVirtualBlocksToCreate > 0, "Can't initialize the first virtual block");


289             } else if (_maxVirtualBlocksToCreate == 0) {


355                 require(_maxVirtualBlocksToCreate > 0, "There must be a virtual block created at the start of the batch");


360             if (currentL2BlockNumber == 0 && currentL2BlockTimestamp == 0) {


373                 require(_maxVirtualBlocksToCreate == 0, "Can not create virtual blocks in the middle of the miniblock");


413             require(currentBatchNumber > 0, "The current batch number must be greater than 0");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L413:413

```solidity
File: system-contracts/contracts/libraries/EfficientCall.sol


38              require(returnData.length == 32, "keccak256 returned invalid data");


47              require(returnData.length == 32, "sha returned invalid data");


131             if (_value == 0) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L131:131

```solidity
File: system-contracts/contracts/libraries/RLPEncoder.sol


26                  if (_val < 128) {


29                      encoded[0] = (_val == 0) ? bytes1(uint8(128)) : bytes1(uint8(_val));


50              assert(_len != 1);


62                  if (_len < 56) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L62:62

```solidity
File: system-contracts/contracts/libraries/SystemContractHelper.sol


319             require(index < 10, "There are only 10 accessible registers");


332             return (callFlags & 2) != 0;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L332:332

```solidity
File: system-contracts/contracts/libraries/SystemContractsCaller.sol


98              if (value == 0) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L98:98

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


95              return _addr == uint256(uint160(address(BASE_TOKEN_SYSTEM_CONTRACT))) || _addr == 0;


172                 if (txDataLen != 1) {


175                 } else if (_transaction.data[0] >= 0x80) {


184             if (_transaction.reserved[0] != 0) {


250                 if (txDataLen != 1) {


253                 } else if (_transaction.data[0] >= 0x80) {


322                 if (txDataLen != 1) {


325                 } else if (_transaction.data[0] >= 0x80) {


363             require(_transaction.paymasterInput.length >= 4, "The standard paymaster input must be at least 4 bytes long");


368                     _transaction.paymasterInput.length >= 68,


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L368:368

```solidity
File: system-contracts/contracts/libraries/Utils.sol


52              return _bytecodeHash[1] == 0x00;


57              return _bytecodeHash[1] == 0x01;


84              require(_bytecode.length % 32 == 0, "po");


88              require(lengthInWords % 2 == 1, "pr"); // bytecode length in words must be odd


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L88:88

</details>

## NC009 - else-block not required:

One level of nesting can be removed by not having an else block when the if-block returns


```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


107             if (timestamp == 0) {
108                 return OperationState.Unset;
109             } else if (timestamp == EXECUTED_PROPOSAL_TIMESTAMP) {
110                 return OperationState.Done;
111             } else if (timestamp > block.timestamp) {
112                 return OperationState.Waiting;
113             } else {
114                 return OperationState.Ready;
115             }


109             } else if (timestamp == EXECUTED_PROPOSAL_TIMESTAMP) {
110                 return OperationState.Done;
111             } else if (timestamp > block.timestamp) {
112                 return OperationState.Waiting;
113             } else {
114                 return OperationState.Ready;
115             }


111             } else if (timestamp > block.timestamp) {
112                 return OperationState.Waiting;
113             } else {
114                 return OperationState.Ready;
115             }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L111:115

## NC010 - Events may be emitted out of order due to reentrancy:

Ensure that events follow the best practice of check-effects-interaction, and are emitted before external calls


```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


/// @audit safeTransfer() called before event
454             emit WithdrawalFinalizedSharedBridge(_chainId, l1Receiver, l1Token, amount);


/// @audit safeTransfer() called before event
367             emit ClaimedFailedDepositSharedBridge(_chainId, _depositSender, _l1Token, _amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L367:367

## NC011 - If-statement can be converted to a ternary:

The code can be made more compact while also increasing readability by converting the following if-statements to ternaries (e.g. foo += (x > y) ? a : b)


```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


406             if (address(uint160(_transaction.paymaster)) != address(0)) {
407                 // Paymaster pays for the fee
408                 requiredBalance = _transaction.value;
409             } else {
410                 // The user should have enough balance for both the fee and the value of the transaction
411                 requiredBalance = _transaction.maxFeePerGas * _transaction.gasLimit + _transaction.value;
412             }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L406:412

## NC012 - Import declarations should import specific identifiers, rather than the whole file:

Using import declarations of the form import {<identifier_name>} from 'some/file.sol' avoids polluting the symbol namespace making flattened files smaller, and speeds up compilation


```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


5       import "../openzeppelin/token/ERC20/IERC20.sol";


6       import "../openzeppelin/token/ERC20/utils/SafeERC20.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L6:6

## NC013 - Adding a return statement when the function defines a named return variable, is redundant:

If a function defines a named return variable, it is not necessary to explicitly return it. It will automatically be returned at the end of the function.


```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


146             return _chainId;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L146:146

```solidity
File: system-contracts/contracts/NonceHolder.sol


129             return deploymentNonce;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L129:129

## NC014 - Public functions not called by the contract should be declared external instead:

Contracts [are allowed](https://docs.soliditylang.org/en/latest/contracts.html#function-overriding) to override their parents' functions and change the visibility from `external` to `public`.


<details>
<summary>Click to show 11 findings</summary>

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


54          function proveL2MessageInclusion(
55              uint256 _batchNumber,
56              uint256 _index,
57              L2Message memory _message,
58              bytes32[] calldata _proof
59          ) public view returns (bool) {
60              return _proveL2LogInclusion(_batchNumber, _index, _L2MessageToLog(_message), _proof);
61          }


74          function proveL1ToL2TransactionStatus(
75              bytes32 _l2TxHash,
76              uint256 _l2BatchNumber,
77              uint256 _l2MessageIndex,
78              uint16 _l2TxNumberInBatch,
79              bytes32[] calldata _merkleProof,
80              TxStatus _status
81          ) public view returns (bool) {
82              // Bootloader sends an L2 -> L1 log only after processing the L1 -> L2 transaction.
83              // Thus, we can verify that the L1 -> L2 transaction was included in the L2 batch with specified status.
84              //
85              // The semantics of such L2 -> L1 log is always:
86              // - sender = L2_BOOTLOADER_ADDRESS
87              // - key = hash(L1ToL2Transaction)
88              // - value = status of the processing transaction (1 - success & 0 - fail)
89              // - isService = true (just a conventional value)
90              // - l2ShardId = 0 (means that L1 -> L2 transaction was processed in a rollup shard, other shards are not available yet anyway)
91              // - txNumberInBatch = number of transaction in the batch
92              L2Log memory l2Log = L2Log({
93                  l2ShardId: 0,
94                  isService: true,
95                  txNumberInBatch: _l2TxNumberInBatch,
96                  sender: L2_BOOTLOADER_ADDRESS,
97                  key: _l2TxHash,
98                  value: bytes32(uint256(_status))
99              });
100             return _proveL2LogInclusion(_l2BatchNumber, _l2MessageIndex, l2Log, _merkleProof);
101         }


143         function l2TransactionBaseCost(
144             uint256 _gasPrice,
145             uint256 _l2GasLimit,
146             uint256 _l2GasPerPubdataByteLimit
147         ) public view returns (uint256) {
148             uint256 l2GasPrice = _deriveL2GasPrice(_gasPrice, _l2GasPerPubdataByteLimit);
149             return l2GasPrice * _l2GasLimit;
150         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L143:150

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


171         function decimals() public view override returns (uint8) {
172             // If method is not available, behave like a token that does not implement this method - revert on call.
173             if (availableGetters.ignoreDecimals) revert();
174             return decimals_;
175         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L171:175

```solidity
File: system-contracts/contracts/ContractDeployer.sol


40          function extendedAccountVersion(address _address) public view returns (AccountAbstractionVersion) {
41              AccountInfo memory info = accountInfo[_address];
42              if (info.supportedAAVersion != AccountAbstractionVersion.None) {
43                  return info.supportedAAVersion;
44              }
45      
46              // It is an EOA, it is still an account.
47              if (
48                  _address > address(MAX_SYSTEM_CONTRACT_ADDRESS) &&
49                  ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.getRawCodeHash(_address) == 0
50              ) {
51                  return AccountAbstractionVersion.Version1;
52              }
53      
54              return AccountAbstractionVersion.None;
55          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L40:55

```solidity
File: system-contracts/contracts/NonceHolder.sol


57          function getRawNonce(address _address) public view returns (uint256) {
58              uint256 addressAsKey = uint256(uint160(_address));
59              return rawNonces[addressAsKey];
60          }


65          function increaseMinNonce(uint256 _value) public onlySystemCall returns (uint256 oldMinNonce) {
66              require(_value <= MAXIMAL_MIN_NONCE_INCREMENT, "The value for incrementing the nonce is too high");
67      
68              uint256 addressAsKey = uint256(uint160(msg.sender));
69              uint256 oldRawNonce = rawNonces[addressAsKey];
70      
71              unchecked {
72                  rawNonces[addressAsKey] = (oldRawNonce + _value);
73              }
74      
75              (, oldMinNonce) = _splitRawNonce(oldRawNonce);
76          }


82          function setValueUnderNonce(uint256 _key, uint256 _value) public onlySystemCall {
83              IContractDeployer.AccountInfo memory accountInfo = DEPLOYER_SYSTEM_CONTRACT.getAccountInfo(msg.sender);
84      
85              require(_value != 0, "Nonce value cannot be set to 0");
86              // If an account has sequential nonce ordering, we enforce that the previous
87              // nonce has already been used.
88              if (accountInfo.nonceOrdering == IContractDeployer.AccountNonceOrdering.Sequential && _key != 0) {
89                  require(isNonceUsed(msg.sender, _key - 1), "Previous nonce has not been used");
90              }
91      
92              uint256 addressAsKey = uint256(uint160(msg.sender));
93      
94              nonceValues[addressAsKey][_key] = _value;
95      
96              emit ValueSetUnderNonce(msg.sender, _key, _value);
97          }


102         function getValueUnderNonce(uint256 _key) public view returns (uint256) {
103             uint256 addressAsKey = uint256(uint160(msg.sender));
104             return nonceValues[addressAsKey][_key];
105         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L102:105

```solidity
File: system-contracts/contracts/SystemContext.sol


190         function getBlockNumber() public view returns (uint128) {
191             return currentVirtualL2BlockInfo.number;
192         }


198         function getBlockTimestamp() public view returns (uint128) {
199             return currentVirtualL2BlockInfo.timestamp;
200         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L198:200

</details>

## NC015 - `2**<n> - 1` should be re-written as `type(uint<n>).max`:

Earlier versions of solidity can use uint<n>(-1) instead. Expressions not including the - 1 can often be re-written to accommodate the change (e.g. by using a > rather than a >=, which will also save some gas)


<details>
<summary>Click to show 4 findings</summary>

```solidity
File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol


26              require(bytecodeLenInWords < 2 ** 16, "pp"); // bytecode length must be less than 2^16 words


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L26:26

```solidity
File: system-contracts/contracts/NonceHolder.sol


28          uint256 private constant DEPLOY_NONCE_MULTIPLIER = 2 ** 128;


31          uint256 private constant MAXIMAL_MIN_NONCE_INCREMENT = 2 ** 32;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L31:31

```solidity
File: system-contracts/contracts/libraries/Utils.sol


87              require(lengthInWords < 2 ** 16, "pp"); // bytecode length must be less than 2^16 words


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L87:87

</details>

## NC016 - Constant redefined elsewhere:

Consider defining in only one contract so that values cannot become out of sync when only one location is updated. A cheap way to store constants in a single location is to create an internal constant in a library. If the variable is a local cache of another contract's value, consider making the cache variable internal or private, which will require external users to query the contract with the source of truth, so that callers don't get out of sync.


<details>
<summary>Click to show 5 findings</summary>

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


    address public immutable bridgehub;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L27:27

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


    string public constant override getName = "AdminFacet";

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


    string public constant override getName = "ExecutorFacet";

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L27:27

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


    string public constant override getName = "GettersFacet";

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L25:25

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


    string public constant override getName = "MailboxFacet";

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L35:35

</details>


## NC017 - Defining All External/Public Functions in Contract Interfaces:

It is preferable to have all the external and public function in an interface to make using them easier by developers. This helps ensure the whole API is extracted in a interface.


<details>
<summary>Click to show 4 findings</summary>

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


159         function name() public view override returns (string memory) {


165         function symbol() public view override returns (string memory) {


171         function decimals() public view override returns (uint8) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L171:171

```solidity
File: system-contracts/contracts/ContractDeployer.sol


40          function extendedAccountVersion(address _address) public view returns (AccountAbstractionVersion) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L40:40

</details>


## NC018 - Avoid defining a function in a single line including it's contents:




<details>
<summary>Click to show 8 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


60          function initialize() external reentrancyGuardInitializer {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L60:60

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


38          constructor() reentrancyGuardInitializer {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L38:38

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


262         receive() external payable {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L262:262

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


19          constructor() reentrancyGuardInitializer {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L19:19

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


263         function _upgradeL1Contract(bytes calldata _customCallDataForUpgrade) internal virtual {}


269         function _postUpgrade(bytes calldata _customCallDataForUpgrade) internal virtual {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L269:269

```solidity
File: system-contracts/contracts/EmptyContract.sol


11          fallback() external payable {}


13          receive() external payable {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L13:13

</details>

## NC019 - Use a struct to encapsulate multiple function parameters:

Using a struct to encapsulate multiple parameters in Solidity functions can significantly enhance code readability and maintainability. Instead of passing a long list of arguments, which can be error-prone and hard to manage, a struct allows grouping related data into a single, coherent entity. This approach simplifies function signatures and makes the code more organized. It also enhances code clarity, as developers can easily understand the relationship between the parameters. Moreover, it aids in future code modifications and expansions, as adding or modifying a parameter only requires changes in the struct definition, rather than in every function that uses these parameters.


<details>
<summary>Click to show 55 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


98          function deposit(
99              address _l2Receiver,
100             address _l1Token,
101             uint256 _amount,
102             uint256 _l2TxGasLimit,
103             uint256 _l2TxGasPerPubdataByte
104         ) external payable returns (bytes32 l2TxHash) {


133         function deposit(
134             address _l2Receiver,
135             address _l1Token,
136             uint256 _amount,
137             uint256 _l2TxGasLimit,
138             uint256 _l2TxGasPerPubdataByte,
139             address _refundRecipient
140         ) public payable nonReentrant returns (bytes32 l2TxHash) {


176         function claimFailedDeposit(
177             address _depositSender,
178             address _l1Token,
179             bytes32 _l2TxHash,
180             uint256 _l2BatchNumber,
181             uint256 _l2MessageIndex,
182             uint16 _l2TxNumberInBatch,
183             bytes32[] calldata _merkleProof
184         ) external nonReentrant {


208         function finalizeWithdrawal(
209             uint256 _l2BatchNumber,
210             uint256 _l2MessageIndex,
211             uint16 _l2TxNumberInBatch,
212             bytes calldata _message,
213             bytes32[] calldata _merkleProof
214         ) external nonReentrant {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L208:214

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


277         function claimFailedDeposit(
278             uint256 _chainId,
279             address _depositSender,
280             address _l1Token,
281             uint256 _amount,
282             bytes32 _l2TxHash,
283             uint256 _l2BatchNumber,
284             uint256 _l2MessageIndex,
285             uint16 _l2TxNumberInBatch,
286             bytes32[] calldata _merkleProof
287         ) external override {


303         function _claimFailedDeposit(
304             bool _checkedInLegacyBridge,
305             uint256 _chainId,
306             address _depositSender,
307             address _l1Token,
308             uint256 _amount,
309             bytes32 _l2TxHash,
310             uint256 _l2BatchNumber,
311             uint256 _l2MessageIndex,
312             uint16 _l2TxNumberInBatch,
313             bytes32[] calldata _merkleProof
314         ) internal nonReentrant {


385         function finalizeWithdrawal(
386             uint256 _chainId,
387             uint256 _l2BatchNumber,
388             uint256 _l2MessageIndex,
389             uint16 _l2TxNumberInBatch,
390             bytes calldata _message,
391             bytes32[] calldata _merkleProof
392         ) external override {


409         function _finalizeWithdrawal(
410             uint256 _chainId,
411             uint256 _l2BatchNumber,
412             uint256 _l2MessageIndex,
413             uint16 _l2TxNumberInBatch,
414             bytes calldata _message,
415             bytes32[] calldata _merkleProof
416         ) internal nonReentrant returns (address l1Receiver, address l1Token, uint256 amount) {


554         function depositLegacyErc20Bridge(
555             address _prevMsgSender,
556             address _l2Receiver,
557             address _l1Token,
558             uint256 _amount,
559             uint256 _l2TxGasLimit,
560             uint256 _l2TxGasPerPubdataByte,
561             address _refundRecipient
562         ) external payable override onlyLegacyBridge nonReentrant returns (bytes32 l2TxHash) {


615         function finalizeWithdrawalLegacyErc20Bridge(
616             uint256 _l2BatchNumber,
617             uint256 _l2MessageIndex,
618             uint16 _l2TxNumberInBatch,
619             bytes calldata _message,
620             bytes32[] calldata _merkleProof
621         ) external override onlyLegacyBridge returns (address l1Receiver, address l1Token, uint256 amount) {


644         function claimFailedDepositLegacyErc20Bridge(
645             address _depositSender,
646             address _l1Token,
647             uint256 _amount,
648             bytes32 _l2TxHash,
649             uint256 _l2BatchNumber,
650             uint256 _l2MessageIndex,
651             uint16 _l2TxNumberInBatch,
652             bytes32[] calldata _merkleProof
653         ) external override onlyLegacyBridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L644:653

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol


26          function deposit(
27              address _l2Receiver,
28              address _l1Token,
29              uint256 _amount,
30              uint256 _l2TxGasLimit,
31              uint256 _l2TxGasPerPubdataByte,
32              address _refundRecipient


35          function deposit(
36              address _l2Receiver,
37              address _l1Token,
38              uint256 _amount,
39              uint256 _l2TxGasLimit,
40              uint256 _l2TxGasPerPubdataByte


43          function claimFailedDeposit(
44              address _depositSender,
45              address _l1Token,
46              bytes32 _l2TxHash,
47              uint256 _l2BatchNumber,
48              uint256 _l2MessageIndex,
49              uint16 _l2TxNumberInBatch,
50              bytes32[] calldata _merkleProof


53          function finalizeWithdrawal(
54              uint256 _l2BatchNumber,
55              uint256 _l2MessageIndex,
56              uint16 _l2TxNumberInBatch,
57              bytes calldata _message,
58              bytes32[] calldata _merkleProof


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L53:58

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol


64          function depositLegacyErc20Bridge(
65              address _msgSender,
66              address _l2Receiver,
67              address _l1Token,
68              uint256 _amount,
69              uint256 _l2TxGasLimit,
70              uint256 _l2TxGasPerPubdataByte,
71              address _refundRecipient


74          function claimFailedDepositLegacyErc20Bridge(
75              address _depositSender,
76              address _l1Token,
77              uint256 _amount,
78              bytes32 _l2TxHash,
79              uint256 _l2BatchNumber,
80              uint256 _l2MessageIndex,
81              uint16 _l2TxNumberInBatch,
82              bytes32[] calldata _merkleProof


85          function claimFailedDeposit(
86              uint256 _chainId,
87              address _depositSender,
88              address _l1Token,
89              uint256 _amount,
90              bytes32 _l2TxHash,
91              uint256 _l2BatchNumber,
92              uint256 _l2MessageIndex,
93              uint16 _l2TxNumberInBatch,
94              bytes32[] calldata _merkleProof


97          function finalizeWithdrawalLegacyErc20Bridge(
98              uint256 _l2BatchNumber,
99              uint256 _l2MessageIndex,
100             uint16 _l2TxNumberInBatch,
101             bytes calldata _message,
102             bytes32[] calldata _merkleProof


105         function finalizeWithdrawal(
106             uint256 _chainId,
107             uint256 _l2BatchNumber,
108             uint256 _l2MessageIndex,
109             uint16 _l2TxNumberInBatch,
110             bytes calldata _message,
111             bytes32[] calldata _merkleProof


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L105:111

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol


7           function finalizeDeposit(
8               address _l1Sender,
9               address _l2Receiver,
10              address _l1Token,
11              uint256 _amount,
12              bytes calldata _data


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L7:12

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


114         function createNewChain(
115             uint256 _chainId,
116             address _stateTransitionManager,
117             address _baseToken,
118             uint256, //_salt
119             address _admin,
120             bytes calldata _initData
121         ) external onlyOwnerOrAdmin nonReentrant returns (uint256 chainId) {


152         function proveL2MessageInclusion(
153             uint256 _chainId,
154             uint256 _batchNumber,
155             uint256 _index,
156             L2Message calldata _message,
157             bytes32[] calldata _proof
158         ) external view override returns (bool) {


164         function proveL2LogInclusion(
165             uint256 _chainId,
166             uint256 _batchNumber,
167             uint256 _index,
168             L2Log memory _log,
169             bytes32[] calldata _proof
170         ) external view override returns (bool) {


176         function proveL1ToL2TransactionStatus(
177             uint256 _chainId,
178             bytes32 _l2TxHash,
179             uint256 _l2BatchNumber,
180             uint256 _l2MessageIndex,
181             uint16 _l2TxNumberInBatch,
182             bytes32[] calldata _merkleProof,
183             TxStatus _status
184         ) external view override returns (bool) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L176:184

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


73          function proveL2MessageInclusion(
74              uint256 _chainId,
75              uint256 _batchNumber,
76              uint256 _index,
77              L2Message calldata _message,
78              bytes32[] calldata _proof


81          function proveL2LogInclusion(
82              uint256 _chainId,
83              uint256 _batchNumber,
84              uint256 _index,
85              L2Log memory _log,
86              bytes32[] calldata _proof


89          function proveL1ToL2TransactionStatus(
90              uint256 _chainId,
91              bytes32 _l2TxHash,
92              uint256 _l2BatchNumber,
93              uint256 _l2MessageIndex,
94              uint16 _l2TxNumberInBatch,
95              bytes32[] calldata _merkleProof,
96              TxStatus _status


116         function createNewChain(
117             uint256 _chainId,
118             address _stateTransitionManager,
119             address _baseToken,
120             uint256 _salt,
121             address _admin,
122             bytes calldata _initData


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L116:122

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


74          function createNewChain(
75              uint256 _chainId,
76              address _baseToken,
77              address _sharedBridge,
78              address _admin,
79              bytes calldata _diamondCut


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L74:79

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


239         function createNewChain(
240             uint256 _chainId,
241             address _baseToken,
242             address _sharedBridge,
243             address _admin,
244             bytes calldata _diamondCut
245         ) external onlyBridgehub {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L239:245

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


74          function proveL1ToL2TransactionStatus(
75              bytes32 _l2TxHash,
76              uint256 _l2BatchNumber,
77              uint256 _l2MessageIndex,
78              uint16 _l2TxNumberInBatch,
79              bytes32[] calldata _merkleProof,
80              TxStatus _status
81          ) public view returns (bool) {


178         function finalizeEthWithdrawal(
179             uint256 _l2BatchNumber,
180             uint256 _l2MessageIndex,
181             uint16 _l2TxNumberInBatch,
182             bytes calldata _message,
183             bytes32[] calldata _merkleProof
184         ) external nonReentrant {


197         function requestL2Transaction(
198             address _contractL2,
199             uint256 _l2Value,
200             bytes calldata _calldata,
201             uint256 _l2GasLimit,
202             uint256 _l2GasPerPubdataByteLimit,
203             bytes[] calldata _factoryDeps,
204             address _refundRecipient
205         ) external payable returns (bytes32 canonicalTxHash) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L197:205

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol


47          function proveL1ToL2TransactionStatus(
48              bytes32 _l2TxHash,
49              uint256 _l2BatchNumber,
50              uint256 _l2MessageIndex,
51              uint16 _l2TxNumberInBatch,
52              bytes32[] calldata _merkleProof,
53              TxStatus _status


62          function finalizeEthWithdrawal(
63              uint256 _l2BatchNumber,
64              uint256 _l2MessageIndex,
65              uint16 _l2TxNumberInBatch,
66              bytes calldata _message,
67              bytes32[] calldata _merkleProof


88          function requestL2Transaction(
89              address _contractL2,
90              uint256 _l2Value,
91              bytes calldata _calldata,
92              uint256 _l2GasLimit,
93              uint256 _l2GasPerPubdataByteLimit,
94              bytes[] calldata _factoryDeps,
95              address _refundRecipient


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L88:95

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


95          function getFarCallABI(
96              uint32 dataOffset,
97              uint32 memoryPage,
98              uint32 dataStart,
99              uint32 dataLength,
100             uint32 gasPassed,
101             uint8 shardId,
102             CalldataForwardingMode forwardingMode,
103             bool isConstructorCall,
104             bool isSystemCall
105         ) internal pure returns (uint256 farCallAbi) {


121         function getFarCallABIWithEmptyFatPointer(
122             uint32 gasPassed,
123             uint8 shardId,
124             CalldataForwardingMode forwardingMode,
125             bool isConstructorCall,
126             bool isSystemCall
127         ) internal pure returns (uint256 farCallAbiWithEmptyFatPtr) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L121:127

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


79          function finalizeDeposit(
80              address _l1Sender,
81              address _l2Receiver,
82              address _l1Token,
83              uint256 _amount,
84              bytes calldata _data
85          ) external payable override {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L79:85

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol


9           function finalizeWithdrawal(
10              uint256 _l2BatchNumber,
11              uint256 _l2MessageIndex,
12              uint16 _l2TxNumberInBatch,
13              bytes calldata _message,
14              bytes32[] calldata _merkleProof


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L9:14

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol


9           function finalizeWithdrawal(
10              uint256 _chainId,
11              uint256 _l2BatchNumber,
12              uint256 _l2MessageIndex,
13              uint16 _l2TxNumberInBatch,
14              bytes calldata _message,
15              bytes32[] calldata _merkleProof


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol#L9:15

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol


24          function finalizeDeposit(
25              address _l1Sender,
26              address _l2Receiver,
27              address _l1Token,
28              uint256 _amount,
29              bytes calldata _data


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L24:29

```solidity
File: contracts/zksync/contracts/interfaces/IPaymaster.sol


43          function postTransaction(
44              bytes calldata _context,
45              Transaction calldata _transaction,
46              bytes32 _txHash,
47              bytes32 _suggestedSignedHash,
48              ExecutionResult _txResult,
49              uint256 _maxRefundedGas


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymaster.sol#L43:49

```solidity
File: system-contracts/contracts/ContractDeployer.sol


321         function _constructContract(
322             address _sender,
323             address _newAddress,
324             bytes32 _bytecodeHash,
325             bytes calldata _input,
326             bool _isSystem,
327             bool _callConstructor
328         ) internal {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L321:328

```solidity
File: system-contracts/contracts/SystemContext.sol


341         function setL2Block(
342             uint128 _l2BlockNumber,
343             uint128 _l2BlockTimestamp,
344             bytes32 _expectedPrevL2BlockHash,
345             bool _isFirstInBatch,
346             uint128 _maxVirtualBlocksToCreate
347         ) external onlyCallFromBootloader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L341:347

```solidity
File: system-contracts/contracts/interfaces/IMailbox.sol


6           function finalizeEthWithdrawal(
7               uint256 _l2BatchNumber,
8               uint256 _l2MessageIndex,
9               uint16 _l2TxNumberInBlock,
10              bytes calldata _message,
11              bytes32[] calldata _merkleProof


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IMailbox.sol#L6:11

```solidity
File: system-contracts/contracts/interfaces/IPaymaster.sol


43          function postTransaction(
44              bytes calldata _context,
45              Transaction calldata _transaction,
46              bytes32 _txHash,
47              bytes32 _suggestedSignedHash,
48              ExecutionResult _txResult,
49              uint256 _maxRefundedGas


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L43:49

```solidity
File: system-contracts/contracts/libraries/EfficientCall.sol


58          function call(
59              uint256 _gas,
60              address _address,
61              uint256 _value,
62              bytes calldata _data,
63              bool _isSystem
64          ) internal returns (bytes memory returnData) {


105         function mimicCall(
106             uint256 _gas,
107             address _address,
108             bytes calldata _data,
109             address _whoToMimic,
110             bool _isConstructor,
111             bool _isSystem
112         ) internal returns (bytes memory returnData) {


124         function rawCall(
125             uint256 _gas,
126             address _address,
127             uint256 _value,
128             bytes calldata _data,
129             bool _isSystem
130         ) internal returns (bool success) {


191         function rawMimicCall(
192             uint256 _gas,
193             address _address,
194             bytes calldata _data,
195             address _whoToMimic,
196             bool _isConstructor,
197             bool _isSystem
198         ) internal returns (bool success) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L191:198

```solidity
File: system-contracts/contracts/libraries/SystemContractHelper.sol


124         function packPrecompileParams(
125             uint32 _inputMemoryOffset,
126             uint32 _inputMemoryLength,
127             uint32 _outputMemoryOffset,
128             uint32 _outputMemoryLength,
129             uint64 _perPrecompileInterpreted
130         ) internal pure returns (uint256 rawParams) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L124:130

```solidity
File: system-contracts/contracts/libraries/SystemContractsCaller.sol


214         function getFarCallABI(
215             uint32 dataOffset,
216             uint32 memoryPage,
217             uint32 dataStart,
218             uint32 dataLength,
219             uint32 gasPassed,
220             uint8 shardId,
221             CalldataForwardingMode forwardingMode,
222             bool isConstructorCall,
223             bool isSystemCall
224         ) internal pure returns (uint256 farCallAbi) {


250         function getFarCallABIWithEmptyFatPointer(
251             uint32 gasPassed,
252             uint8 shardId,
253             CalldataForwardingMode forwardingMode,
254             bool isConstructorCall,
255             bool isSystemCall
256         ) internal pure returns (uint256 farCallAbiWithEmptyFatPtr) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L250:256

</details>

## NC020 - Consider only defining one library/interface/contract per sol file:

Combining multiple libraries, interfaces, or contracts in a single  file can lead to clutter, reduced readability, and versioning issues. **Resolution**: Adopt the best practice of defining only one library, interface, or contract per Solidity file. This modular approach enhances clarity, simplifies unit testing, and streamlines code review. Furthermore, segregating components makes version management easier, as updates to one component won't necessitate changes to a file housing multiple unrelated components. Structured file management can further assist in avoiding naming collisions and ensure smoother integration into larger systems or DApps.


```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


18      interface IL2Messenger {
19          /// @notice Sends an arbitrary length message to L1.
20          /// @param _message The variable length message to be sent to L1.
21          /// @return Returns the keccak256 hashed value of the message.
22          function sendToL1(bytes memory _message) external returns (bytes32);
23      }
24      
25      /**
26       * @author Matter Labs
27       * @custom:security-contact security@matterlabs.dev
28       * @notice Interface for the contract that is used to deploy contracts on L2.
29       */
30      interface IContractDeployer {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L18:30

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


26      library Utils {
27          function safeCastToU32(uint256 _x) internal pure returns (uint32) {
28              require(_x <= type(uint32).max, "Overflow");
29      
30              return uint32(_x);
31          }
32      }
33      
34      /// @notice The library contains the functions to make system calls.
35      /// @dev A more detailed description of the library and its methods can be found in the `system-contracts` repo.
36      library SystemContractsCaller {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L26:36


## NC021 - Contracts with only unimplemented functions can be labeled as abstract:

A contract that's not meant to be deployed on its own but is intended to be inherited by other contracts should be marked as abstract. If a contract does not have any functions, mark it as abstract.  This ensures that developers recognize the contract's incomplete or intended-to-be-extended nature.


```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol


11      contract ZkSyncStateTransitionBase is ReentrancyGuard {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L11:11


## NC022 - Variable names for `immutable`s should use CONSTANT_CASE:

For `immutable` variable names, each word should use all capital letters, with underscores separating each word (CONSTANT_CASE).


<details>
<summary>Click to show 5 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


23          IL1SharedBridge public immutable override sharedBridge;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L23:23

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


34          address public immutable override l1WethAddress;


37          IBridgehub public immutable override bridgehub;


40          IL1ERC20Bridge public immutable override legacyBridge;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L40:40

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


27          address public immutable bridgehub;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L27:27

</details>


## NC023 - It is best practice to use linear inheritance:

In Solidity, complex inheritance structures can obfuscate code understanding, introducing potential security risks. Multiple inheritance, especially with overlapping function names or state variables, can cause unintentional overrides or ambiguous behavior. Resolution: Strive for linear and simple inheritance chains. Avoid diamond or circular inheritance patterns. Clearly document the purpose and relationships of base contracts, ensuring that overrides are intentional. Tools like Remix or Hardhat can visualize inheritance chains, assisting in verification. Keeping inheritance streamlined aids in better code readability, reduces potential errors, and ensures smoother audits and upgrades.


<details>
<summary>Click to show 21 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


19      contract L1ERC20Bridge is IL1ERC20Bridge, ReentrancyGuard {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L19:19

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


30      contract L1SharedBridge is IL1SharedBridge, ReentrancyGuard, Initializable, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L30:30

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


16      contract Bridgehub is IBridgehub, ReentrancyGuard, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L16:16

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


20      contract Governance is IGovernance, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


25      contract StateTransitionManager is IStateTransitionManager, ReentrancyGuard, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L25:25

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


22      contract ValidatorTimelock is IExecutor, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L22:22

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


17      contract DiamondInit is ZkSyncStateTransitionBase, IDiamondInit {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L17:17

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


18      contract AdminFacet is ZkSyncStateTransitionBase, IAdmin {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L18:18

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


22      contract ExecutorFacet is ZkSyncStateTransitionBase, IExecutor {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L22:22

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


20      contract GettersFacet is ZkSyncStateTransitionBase, IGetters, ILegacyGetters {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


30      contract MailboxFacet is ZkSyncStateTransitionBase, IMailbox {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L30:30

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


23      contract L2SharedBridge is IL2SharedBridge, Initializable {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L23:23

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


15      contract L2StandardERC20 is ERC20PermitUpgradeable, IL2StandardToken, ERC1967Upgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L15:15

```solidity
File: system-contracts/contracts/Compressor.sol


22      contract Compressor is ICompressor, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L22:22

```solidity
File: system-contracts/contracts/ContractDeployer.sol


23      contract ContractDeployer is IContractDeployer, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L23:23

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


18      contract KnownCodesStorage is IKnownCodesStorage, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L18:18

```solidity
File: system-contracts/contracts/L1Messenger.sol


25      contract L1Messenger is IL1Messenger, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L25:25

```solidity
File: system-contracts/contracts/L2BaseToken.sol


18      contract L2BaseToken is IBaseToken, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L18:18

```solidity
File: system-contracts/contracts/NonceHolder.sol


27      contract NonceHolder is INonceHolder, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L27:27

```solidity
File: system-contracts/contracts/PubdataChunkPublisher.sol


16      contract PubdataChunkPublisher is IPubdataChunkPublisher, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L16:16

```solidity
File: system-contracts/contracts/SystemContext.sol


17      contract SystemContext is ISystemContext, ISystemContextDeprecated, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L17:17

</details>


## NC024 - File is missing NatSpec comments:

The file does not contain any of the NatSpec comments (@inheritdoc, @param, @return, @notice), which are important for documentation and user confirmation.


<details>
<summary>Click to show 24 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

import {L2TransactionRequestTwoBridgesInner} from "../../bridgehub/IBridgehub.sol";
import {IBridgehub} from "../../bridgehub/IBridgehub.sol";
import {IL1ERC20Bridge} from "./IL1ERC20Bridge.sol";

/// @title L1 Bridge contract interface
/// @author Matter Labs
/// @custom:security-contact security@matterlabs.dev
interface IL1SharedBridge {
    event LegacyDepositInitiated(
        uint256 indexed chainId,
        bytes32 indexed l2DepositTxHash,
        address indexed from,
        address to,
        address l1Token,
        uint256 amount
    );

    event BridgehubDepositInitiated(
        uint256 indexed chainId,
        bytes32 indexed txDataHash,
        address indexed from,
        address to,
        address l1Token,
        uint256 amount
    );

    event BridgehubDepositBaseTokenInitiated(
        uint256 indexed chainId,
        address indexed from,
        address l1Token,
        uint256 amount
    );

    event BridgehubDepositFinalized(
        uint256 indexed chainId,
        bytes32 indexed txDataHash,
        bytes32 indexed l2DepositTxHash
    );

    event WithdrawalFinalizedSharedBridge(
        uint256 indexed chainId,
        address indexed to,
        address indexed l1Token,
        uint256 amount
    );

    event ClaimedFailedDepositSharedBridge(
        uint256 indexed chainId,
        address indexed to,
        address indexed l1Token,
        uint256 amount
    );

    function isWithdrawalFinalized(
        uint256 _chainId,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex
    ) external view returns (bool);

    function depositLegacyErc20Bridge(
        address _msgSender,
        address _l2Receiver,
        address _l1Token,
        uint256 _amount,
        uint256 _l2TxGasLimit,
        uint256 _l2TxGasPerPubdataByte,
        address _refundRecipient
    ) external payable returns (bytes32 txHash);

    function claimFailedDepositLegacyErc20Bridge(
        address _depositSender,
        address _l1Token,
        uint256 _amount,
        bytes32 _l2TxHash,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes32[] calldata _merkleProof
    ) external;

    function claimFailedDeposit(
        uint256 _chainId,
        address _depositSender,
        address _l1Token,
        uint256 _amount,
        bytes32 _l2TxHash,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes32[] calldata _merkleProof
    ) external;

    function finalizeWithdrawalLegacyErc20Bridge(
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external returns (address l1Receiver, address l1Token, uint256 amount);

    function finalizeWithdrawal(
        uint256 _chainId,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external;

    function l1WethAddress() external view returns (address);

    function bridgehub() external view returns (IBridgehub);

    function legacyBridge() external view returns (IL1ERC20Bridge);

    function l2BridgeAddress(uint256 _chainId) external view returns (address);

    function depositHappened(uint256 _chainId, bytes32 _l2TxHash) external view returns (bytes32);

    /// data is abi encoded :
    /// address _l1Token,
    /// uint256 _amount,
    /// address _l2Receiver
    function bridgehubDeposit(
        uint256 _chainId,
        address _prevMsgSender,
        uint256 _l2Value,
        bytes calldata _data
    ) external payable returns (L2TransactionRequestTwoBridgesInner memory request);

    function bridgehubDepositBaseToken(
        uint256 _chainId,
        address _prevMsgSender,
        address _l1Token,
        uint256 _amount
    ) external payable;

    function bridgehubConfirmL2Transaction(uint256 _chainId, bytes32 _txDataHash, bytes32 _txHash) external;

    function receiveEth(uint256 _chainId) external payable;
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L1:1

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

/// @author Matter Labs
interface IL2Bridge {
    function finalizeDeposit(
        address _l1Sender,
        address _l2Receiver,
        address _l1Token,
        uint256 _amount,
        bytes calldata _data
    ) external payable;

    function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external;

    function l1TokenAddress(address _l2Token) external view returns (address);

    function l2TokenAddress(address _l1Token) external view returns (address);

    function l1Bridge() external view returns (address);
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L1:1

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol


// SPDX-License-Identifier: Apache-2.0
pragma solidity 0.8.20;

interface IWETH9 {
    function deposit() external payable;

    function withdraw(uint256 wad) external;
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol#L1:1

```solidity
File: contracts/ethereum/contracts/common/Config.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

/// @dev `keccak256("")`
bytes32 constant EMPTY_STRING_KECCAK = 0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470;

/// @dev Bytes in raw L2 log
/// @dev Equal to the bytes size of the tuple - (uint8 ShardId, bool isService, uint16 txNumberInBatch, address sender,
/// bytes32 key, bytes32 value)
uint256 constant L2_TO_L1_LOG_SERIALIZE_SIZE = 88;

/// @dev The maximum length of the bytes array with L2 -> L1 logs
uint256 constant MAX_L2_TO_L1_LOGS_COMMITMENT_BYTES = 4 + L2_TO_L1_LOG_SERIALIZE_SIZE * 512;

/// @dev The value of default leaf hash for L2 -> L1 logs Merkle tree
/// @dev An incomplete fixed-size tree is filled with this value to be a full binary tree
/// @dev Actually equal to the `keccak256(new bytes(L2_TO_L1_LOG_SERIALIZE_SIZE))`
bytes32 constant L2_L1_LOGS_TREE_DEFAULT_LEAF_HASH = 0x72abee45b59e344af8a6e520241c4744aff26ed411f4c4b00f8af09adada43ba;

// TODO: change constant to the real root hash of empty Merkle tree (SMA-184)
bytes32 constant DEFAULT_L2_LOGS_TREE_ROOT_HASH = bytes32(0);

/// @dev Denotes the type of the zkSync transaction that came from L1.
uint256 constant PRIORITY_OPERATION_L2_TX_TYPE = 255;

/// @dev Denotes the type of the zkSync transaction that is used for system upgrades.
uint256 constant SYSTEM_UPGRADE_L2_TX_TYPE = 254;

/// @dev The maximal allowed difference between protocol versions in an upgrade. The 100 gap is needed
/// in case a protocol version has been tested on testnet, but then not launched on mainnet, e.g.
/// due to a bug found.
uint256 constant MAX_ALLOWED_PROTOCOL_VERSION_DELTA = 100;

/// @dev The amount of time in seconds the validator has to process the priority transaction
/// NOTE: The constant is set to zero for the Alpha release period
uint256 constant PRIORITY_EXPIRATION = 0 days;

/// @dev Timestamp - seconds since unix epoch.
uint256 constant COMMIT_TIMESTAMP_NOT_OLDER = 3 days;

/// @dev Maximum available error between real commit batch timestamp and analog used in the verifier (in seconds)
/// @dev Must be used cause miner's `block.timestamp` value can differ on some small value (as we know - 12 seconds)
uint256 constant COMMIT_TIMESTAMP_APPROXIMATION_DELTA = 1 hours;

/// @dev Shift to apply to verify public input before verifying.
uint256 constant PUBLIC_INPUT_SHIFT = 32;

/// @dev The maximum number of L2 gas that a user can request for an L2 transaction
uint256 constant MAX_GAS_PER_TRANSACTION = $(MAX_GAS_PER_TRANSACTION);

/// @dev Even though the price for 1 byte of pubdata is 16 L1 gas, we have a slightly increased
/// value.
uint256 constant L1_GAS_PER_PUBDATA_BYTE = $(L1_GAS_PER_PUBDATA_BYTE);

/// @dev The intrinsic cost of the L1->l2 transaction in computational L2 gas
uint256 constant L1_TX_INTRINSIC_L2_GAS = $(L1_TX_INTRINSIC_L2_GAS);

/// @dev The intrinsic cost of the L1->l2 transaction in pubdata
uint256 constant L1_TX_INTRINSIC_PUBDATA = $(L1_TX_INTRINSIC_PUBDATA);

/// @dev The minimal base price for L1 transaction
uint256 constant L1_TX_MIN_L2_GAS_BASE = $(L1_TX_MIN_L2_GAS_BASE);

/// @dev The number of L2 gas the transaction starts costing more with each 544 bytes of encoding
uint256 constant L1_TX_DELTA_544_ENCODING_BYTES = $(L1_TX_DELTA_544_ENCODING_BYTES);

/// @dev The number of L2 gas an L1->L2 transaction gains with each new factory dependency
uint256 constant L1_TX_DELTA_FACTORY_DEPS_L2_GAS = $(L1_TX_DELTA_FACTORY_DEPS_L2_GAS);

/// @dev The number of L2 gas an L1->L2 transaction gains with each new factory dependency
uint256 constant L1_TX_DELTA_FACTORY_DEPS_PUBDATA = $(L1_TX_DELTA_FACTORY_DEPS_PUBDATA);

/// @dev The number of pubdata an L1->L2 transaction requires with each new factory dependency
uint256 constant MAX_NEW_FACTORY_DEPS = $(MAX_NEW_FACTORY_DEPS);

/// @dev The L2 gasPricePerPubdata required to be used in bridges.
uint256 constant REQUIRED_L2_GAS_PRICE_PER_PUBDATA = $(REQUIRED_L2_GAS_PRICE_PER_PUBDATA);

/// @dev The mask which should be applied to the packed batch and L2 block timestamp in order
/// to obtain the L2 block timestamp. Applying this mask is equivalent to calculating modulo 2**128
uint256 constant PACKED_L2_BLOCK_TIMESTAMP_MASK = 0xffffffffffffffffffffffffffffffff;

/// @dev Address of the point evaluation precompile used for EIP-4844 blob verification.
address constant POINT_EVALUATION_PRECOMPILE_ADDR = address(0x0A);

/// @dev The overhead for a transaction slot in L2 gas.
/// It is roughly equal to 80kk/MAX_TRANSACTIONS_IN_BATCH, i.e. how many gas would an L1->L2 transaction
/// need to pay to compensate for the batch being closed.
/// @dev It is expected that the L1 contracts will enforce that the L2 gas price will be high enough to compensate
/// the operator in case the batch is closed because of tx slots filling up.
uint256 constant TX_SLOT_OVERHEAD_L2_GAS = 10000;

/// @dev The overhead for each byte of the bootloader memory that the encoding of the transaction.
/// It is roughly equal to 80kk/BOOTLOADER_MEMORY_FOR_TXS, i.e. how many gas would an L1->L2 transaction
/// need to pay to compensate for the batch being closed.
/// @dev It is expected that the L1 contracts will enforce that the L2 gas price will be high enough to compensate
/// the operator in case the batch is closed because of the memory for transactions being filled up.
uint256 constant MEMORY_OVERHEAD_GAS = 10;

address constant ETH_TOKEN_ADDRESS = address(1);

/// @dev Era's chainID
uint256 constant ERA_CHAIN_ID = $(ERA_CHAIN_ID);

/// @dev The address of legacy L1 ERC20 bridge.
address constant ERA_ERC20_BRIDGE_ADDRESS = $(ERA_ERC20_BRIDGE_ADDRESS);

/// @dev The address of zkSync Era diamond proxy contract.
address constant ERA_DIAMOND_PROXY = $(ERA_DIAMOND_PROXY);

bytes32 constant TWO_BRIDGES_MAGIC_VALUE = bytes32(uint256(keccak256("TWO_BRIDGES_MAGIC_VALUE")) - 1);

/// @dev https://eips.ethereum.org/EIPS/eip-1352
address constant BRIDGEHUB_MIN_SECOND_BRIDGE_ADDRESS = address(uint160(type(uint16).max));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/Config.sol#L1:1

```solidity
File: contracts/ethereum/contracts/common/L2ContractAddresses.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

/// @dev The formal address of the initial program of the system: the bootloader
address constant L2_BOOTLOADER_ADDRESS = address(0x8001);

/// @dev The address of the known code storage system contract
address constant L2_KNOWN_CODE_STORAGE_SYSTEM_CONTRACT_ADDR = address(0x8004);

/// @dev The address of the L2 deployer system contract.
address constant L2_DEPLOYER_SYSTEM_CONTRACT_ADDR = address(0x8006);

/// @dev The special reserved L2 address. It is located in the system contracts space but doesn't have deployed
/// bytecode.
/// @dev The L2 deployer system contract allows changing bytecodes on any address if the `msg.sender` is this address.
/// @dev So, whenever the governor wants to redeploy system contracts, it just initiates the L1 upgrade call deployer
/// system contract
/// via the L1 -> L2 transaction with `sender == L2_FORCE_DEPLOYER_ADDR`. For more details see the
/// `diamond-initializers` contracts.
address constant L2_FORCE_DEPLOYER_ADDR = address(0x8007);

/// @dev The address of the special smart contract that can send arbitrary length message as an L2 log
address constant L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR = address(0x8008);

/// @dev The address of the eth token system contract
address constant L2_BASE_TOKEN_SYSTEM_CONTRACT_ADDR = address(0x800a);

/// @dev The address of the context system contract
address constant L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR = address(0x800b);

/// @dev The address of the pubdata chunk publisher contract
address constant L2_PUBDATA_CHUNK_PUBLISHER_ADDR = address(0x8011);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/L2ContractAddresses.sol#L1:1

```solidity
File: contracts/ethereum/contracts/common/ReentrancyGuard.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

/**
 * @custom:security-contact security@matterlabs.dev
 * @dev Contract module that helps prevent reentrant calls to a function.
 *
 * Inheriting from `ReentrancyGuard` will make the {nonReentrant} modifier
 * available, which can be applied to functions to make sure there are no nested
 * (reentrant) calls to them.
 *
 * Note that because there is a single `nonReentrant` guard, functions marked as
 * `nonReentrant` may not call one another. This can be worked around by making
 * those functions `private`, and then adding `external` `nonReentrant` entry
 * points to them.
 *
 * TIP: If you would like to learn more about reentrancy and alternative ways
 * to protect against it, check out our blog post
 * https://blog.openzeppelin.com/reentrancy-after-istanbul/[Reentrancy After Istanbul].
 *
 * _Since v2.5.0:_ this module is now much more gas efficient, given net gas
 * metering changes introduced in the Istanbul hardfork.
 */
abstract contract ReentrancyGuard {
    /// @dev Address of lock flag variable.
    /// @dev Flag is placed at random memory location to not interfere with Storage contract.
    // keccak256("ReentrancyGuard") - 1;
    uint256 private constant LOCK_FLAG_ADDRESS = 0x8e94fed44239eb2314ab7a406345e6c5a8f0ccedf3b600de3d004e672c33abf4;

    // solhint-disable-next-line max-line-length
    // https://github.com/OpenZeppelin/openzeppelin-contracts/blob/566a774222707e424896c0c390a84dc3c13bdcb2/contracts/security/ReentrancyGuard.sol
    // The values being non-zero value makes deployment a bit more expensive,
    // but in exchange the refund on every call to nonReentrant will be lower in
    // amount. Since refunds are capped to a percentage of the total
    // transaction's gas, it is best to keep them low in cases like this one, to
    // increase the likelihood of the full refund coming into effect.
    uint256 private constant _NOT_ENTERED = 1;
    uint256 private constant _ENTERED = 2;

    modifier reentrancyGuardInitializer() {
        _initializeReentrancyGuard();
        _;
    }

    function _initializeReentrancyGuard() private {
        uint256 lockSlotOldValue;

        // Storing an initial non-zero value makes deployment a bit more
        // expensive but in exchange every call to nonReentrant
        // will be cheaper.
        assembly {
            lockSlotOldValue := sload(LOCK_FLAG_ADDRESS)
            sstore(LOCK_FLAG_ADDRESS, _NOT_ENTERED)
        }

        // Check that storage slot for reentrancy guard is empty to rule out possibility of slot conflict
        require(lockSlotOldValue == 0, "1B");
    }

    /**
     * @dev Prevents a contract from calling itself, directly or indirectly.
     * Calling a `nonReentrant` function from another `nonReentrant`
     * function is not supported. It is possible to prevent this from happening
     * by making the `nonReentrant` function external, and make it call a
     * `private` function that does the actual work.
     */
    modifier nonReentrant() {
        uint256 _status;
        assembly {
            _status := sload(LOCK_FLAG_ADDRESS)
        }

        // On the first call to nonReentrant, _notEntered will be true
        require(_status == _NOT_ENTERED, "r1");

        // Any calls to nonReentrant after this point will fail
        assembly {
            sstore(LOCK_FLAG_ADDRESS, _ENTERED)
        }

        _;

        // By storing the original value once again, a refund is triggered (see
        // https://eips.ethereum.org/EIPS/eip-2200)
        assembly {
            sstore(LOCK_FLAG_ADDRESS, _NOT_ENTERED)
        }
    }
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L1:1

```solidity
File: contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

/**
 * @author Matter Labs
 * @custom:security-contact security@matterlabs.dev
 * @dev The library provides a set of functions that help read data from an "abi.encodePacked" byte array.
 * @dev Each of the functions accepts the `bytes memory` and the offset where data should be read and returns a value of a certain type.
 *
 * @dev WARNING!
 * 1) Functions don't check the length of the bytes array, so it can go out of bounds.
 * The user of the library must check for bytes length before using any functions from the library!
 *
 * 2) Read variables are not cleaned up - https://docs.soliditylang.org/en/v0.8.16/internals/variable_cleanup.html.
 * Using data in inline assembly can lead to unexpected behavior!
 */
library UnsafeBytes {
    function readUint32(bytes memory _bytes, uint256 _start) internal pure returns (uint32 result, uint256 offset) {
        assembly {
            offset := add(_start, 4)
            result := mload(add(_bytes, offset))
        }
    }

    function readAddress(bytes memory _bytes, uint256 _start) internal pure returns (address result, uint256 offset) {
        assembly {
            offset := add(_start, 20)
            result := mload(add(_bytes, offset))
        }
    }

    function readUint256(bytes memory _bytes, uint256 _start) internal pure returns (uint256 result, uint256 offset) {
        assembly {
            offset := add(_start, 32)
            result := mload(add(_bytes, offset))
        }
    }

    function readBytes32(bytes memory _bytes, uint256 _start) internal pure returns (bytes32 result, uint256 offset) {
        assembly {
            offset := add(_start, 32)
            result := mload(add(_bytes, offset))
        }
    }
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L1:1

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

import {Diamond} from "../libraries/Diamond.sol";

/// @title Diamond Proxy Contract (EIP-2535)
/// @author Matter Labs
/// @custom:security-contact security@matterlabs.dev
contract DiamondProxy {
    constructor(uint256 _chainId, Diamond.DiamondCutData memory _diamondCut) {
        // Check that the contract is deployed on the expected chain.
        // Thus, the contract deployed by the same Create2 factory on the different chain will have different addresses!
        require(_chainId == block.chainid, "pr");
        Diamond.diamondCut(_diamondCut);
    }

    /// @dev 1. Find the facet for the function that is called.
    /// @dev 2. Delegate the execution to the found facet via `delegatecall`.
    fallback() external payable {
        Diamond.DiamondStorage storage diamondStorage = Diamond.getDiamondStorage();
        // Check whether the data contains a "full" selector or it is empty.
        // Required because Diamond proxy finds a facet by function signature,
        // which is not defined for data length in range [1, 3].
        require(msg.data.length >= 4 || msg.data.length == 0, "Ut");
        // Get facet from function selector
        Diamond.SelectorToFacet memory facet = diamondStorage.selectorToFacet[msg.sig];
        address facetAddress = facet.facetAddress;

        require(facetAddress != address(0), "F"); // Proxy has no facet for this selector
        require(!diamondStorage.isFrozen || !facet.isFreezable, "q1"); // Facet is frozen

        assembly {
            // The pointer to the free memory slot
            let ptr := mload(0x40)
            // Copy function signature and arguments from calldata at zero position into memory at pointer position
            calldatacopy(ptr, 0, calldatasize())
            // Delegatecall method of the implementation contract returns 0 on error
            let result := delegatecall(gas(), facetAddress, ptr, calldatasize(), 0, 0)
            // Get the size of the last return data
            let size := returndatasize()
            // Copy the size length of bytes from return data at zero position to pointer position
            returndatacopy(ptr, 0, size)
            // Depending on the result value
            switch result
            case 0 {
                // End execution and revert state changes
                revert(ptr, size)
            }
            default {
                // Return data with length of size at pointers position
                return(ptr, size)
            }
        }
    }
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L1:1

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

import {IAdmin} from "./IAdmin.sol";
import {IExecutor} from "./IExecutor.sol";
import {IGetters} from "./IGetters.sol";
import {IMailbox} from "./IMailbox.sol";
import {Verifier} from "../Verifier.sol";
import {VerifierParams} from "./IVerifier.sol";

// kl to do remove this, needed for the server for now
import "../libraries/Diamond.sol";

interface IZkSyncStateTransition is IAdmin, IExecutor, IGetters, IMailbox {
    // KL todo: need this in the server for now
    event ProposeTransparentUpgrade(
        Diamond.DiamondCutData diamondCut,
        uint256 indexed proposalId,
        bytes32 proposalSalt
    );
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol#L1:1

```solidity
File: contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol


// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.0;

interface ISystemContext {
    function setChainId(uint256 _newChainId) external;
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol#L1:1

```solidity
File: contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

import {ProposedUpgrade} from "./BaseZkSyncUpgrade.sol";

interface IDefaultUpgrade {
    function upgrade(ProposedUpgrade calldata _upgrade) external returns (bytes32);
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol#L1:1

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

/// @author Matter Labs
// note we use the IL1ERC20Bridge only to send L1<>L2 messages,
// and we use this interface so that when the switch happened the old messages could be processed
interface IL1ERC20Bridge {
    function finalizeWithdrawal(
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external;
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L1:1

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

/// @title L1 Bridge contract interface
/// @author Matter Labs
/// @custom:security-contact security@matterlabs.dev
interface IL1SharedBridge {
    function finalizeWithdrawal(
        uint256 _chainId,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external;
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol#L1:1

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

/// @author Matter Labs
interface IL2SharedBridge {
    event FinalizeDeposit(
        address indexed l1Sender,
        address indexed l2Receiver,
        address indexed l2Token,
        uint256 amount
    );

    event WithdrawalInitiated(
        address indexed l2Sender,
        address indexed l1Receiver,
        address indexed l2Token,
        uint256 amount
    );

    /// @dev Event emitted when baseToken is received by the contract.
    event BaseTokenReceived(uint256 amount);

    function finalizeDeposit(
        address _l1Sender,
        address _l2Receiver,
        address _l1Token,
        uint256 _amount,
        bytes calldata _data
    ) external payable;

    function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external;

    function l1TokenAddress(address _l2Token) external view returns (address);

    function l2TokenAddress(address _l1Token) external view returns (address);

    function l1Bridge() external view returns (address);
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L1:1

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

interface IL2StandardToken {
    event BridgeInitialize(address indexed l1Token, string name, string symbol, uint8 decimals);

    event BridgeMint(address indexed _account, uint256 _amount);

    event BridgeBurn(address indexed _account, uint256 _amount);

    function bridgeMint(address _account, uint256 _amount) external;

    function bridgeBurn(address _account, uint256 _amount) external;

    function l1Address() external view returns (address);

    function l2Bridge() external view returns (address);
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L1:1

```solidity
File: system-contracts/contracts/Constants.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

import {IAccountCodeStorage} from "./interfaces/IAccountCodeStorage.sol";
import {INonceHolder} from "./interfaces/INonceHolder.sol";
import {IContractDeployer} from "./interfaces/IContractDeployer.sol";
import {IKnownCodesStorage} from "./interfaces/IKnownCodesStorage.sol";
import {IImmutableSimulator} from "./interfaces/IImmutableSimulator.sol";
import {IBaseToken} from "./interfaces/IBaseToken.sol";
import {IL1Messenger} from "./interfaces/IL1Messenger.sol";
import {ISystemContext} from "./interfaces/ISystemContext.sol";
import {ICompressor} from "./interfaces/ICompressor.sol";
import {IComplexUpgrader} from "./interfaces/IComplexUpgrader.sol";
import {IBootloaderUtilities} from "./interfaces/IBootloaderUtilities.sol";
import {IPubdataChunkPublisher} from "./interfaces/IPubdataChunkPublisher.sol";

/// @dev All the system contracts introduced by zkSync have their addresses
/// started from 2^15 in order to avoid collision with Ethereum precompiles.
uint160 constant SYSTEM_CONTRACTS_OFFSET = {{SYSTEM_CONTRACTS_OFFSET}}; // 2^15

/// @dev Unlike the value above, it is not overridden for the purpose of testing and 
/// is identical to the constant value actually used as the system contracts offset on 
/// mainnet. 
uint160 constant REAL_SYSTEM_CONTRACTS_OFFSET = 0x8000;

/// @dev All the system contracts must be located in the kernel space,
/// i.e. their addresses must be below 2^16.
uint160 constant MAX_SYSTEM_CONTRACT_ADDRESS = 0xffff; // 2^16 - 1

address constant ECRECOVER_SYSTEM_CONTRACT = address(0x01);
address constant SHA256_SYSTEM_CONTRACT = address(0x02);
address constant ECADD_SYSTEM_CONTRACT = address(0x06);
address constant ECMUL_SYSTEM_CONTRACT = address(0x07);


/// @dev The number of ergs that need to be spent for a single byte of pubdata regardless of the pubdata price.
/// This variable is used to ensure the following:
/// - That the long-term storage of the operator is compensated properly.
/// - That it is not possible that the pubdata counter grows too high without spending proportional amount of computation.
uint256 constant COMPUTATIONAL_PRICE_FOR_PUBDATA = 80;

/// @dev The maximal possible address of an L1-like precompie. These precompiles maintain the following properties:
/// - Their extcodehash is EMPTY_STRING_KECCAK
/// - Their extcodesize is 0 despite having a bytecode formally deployed there.
uint256 constant CURRENT_MAX_PRECOMPILE_ADDRESS = 0xff;

address payable constant BOOTLOADER_FORMAL_ADDRESS = payable(address(SYSTEM_CONTRACTS_OFFSET + 0x01));
IAccountCodeStorage constant ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT = IAccountCodeStorage(
    address(SYSTEM_CONTRACTS_OFFSET + 0x02)
);
INonceHolder constant NONCE_HOLDER_SYSTEM_CONTRACT = INonceHolder(address(SYSTEM_CONTRACTS_OFFSET + 0x03));
IKnownCodesStorage constant KNOWN_CODE_STORAGE_CONTRACT = IKnownCodesStorage(address(SYSTEM_CONTRACTS_OFFSET + 0x04));
IImmutableSimulator constant IMMUTABLE_SIMULATOR_SYSTEM_CONTRACT = IImmutableSimulator(
    address(SYSTEM_CONTRACTS_OFFSET + 0x05)
);
IContractDeployer constant DEPLOYER_SYSTEM_CONTRACT = IContractDeployer(address(SYSTEM_CONTRACTS_OFFSET + 0x06));

// A contract that is allowed to deploy any codehash
// on any address. To be used only during an upgrade.
address constant FORCE_DEPLOYER = address(SYSTEM_CONTRACTS_OFFSET + 0x07);
IL1Messenger constant L1_MESSENGER_CONTRACT = IL1Messenger(address(SYSTEM_CONTRACTS_OFFSET + 0x08));
address constant MSG_VALUE_SYSTEM_CONTRACT = address(SYSTEM_CONTRACTS_OFFSET + 0x09);

IBaseToken constant BASE_TOKEN_SYSTEM_CONTRACT = IBaseToken(address(SYSTEM_CONTRACTS_OFFSET + 0x0a));
IBaseToken constant REAL_BASE_TOKEN_SYSTEM_CONTRACT = IBaseToken(address(REAL_SYSTEM_CONTRACTS_OFFSET + 0x0a));

// Hardcoded because even for tests we should keep the address. (Instead `SYSTEM_CONTRACTS_OFFSET + 0x10`)
// Precompile call depends on it.
// And we don't want to mock this contract.
address constant KECCAK256_SYSTEM_CONTRACT = address(0x8010);

ISystemContext constant SYSTEM_CONTEXT_CONTRACT = ISystemContext(payable(address(SYSTEM_CONTRACTS_OFFSET + 0x0b)));
ISystemContext constant REAL_SYSTEM_CONTEXT_CONTRACT = ISystemContext(payable(address(REAL_SYSTEM_CONTRACTS_OFFSET + 0x0b)));

IBootloaderUtilities constant BOOTLOADER_UTILITIES = IBootloaderUtilities(address(SYSTEM_CONTRACTS_OFFSET + 0x0c));

// It will be a different value for tests, while shouldn't. But for now, this constant is not used by other contracts, so that's fine.
address constant EVENT_WRITER_CONTRACT = address(SYSTEM_CONTRACTS_OFFSET + 0x0d);

ICompressor constant COMPRESSOR_CONTRACT = ICompressor(address(SYSTEM_CONTRACTS_OFFSET + 0x0e));

IComplexUpgrader constant COMPLEX_UPGRADER_CONTRACT = IComplexUpgrader(address(SYSTEM_CONTRACTS_OFFSET + 0x0f));

IPubdataChunkPublisher constant PUBDATA_CHUNK_PUBLISHER = IPubdataChunkPublisher(
    address(SYSTEM_CONTRACTS_OFFSET + 0x11)
);

/// @dev If the bitwise AND of the extraAbi[2] param when calling the MSG_VALUE_SIMULATOR
/// is non-zero, the call will be assumed to be a system one.
uint256 constant MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT = 1;

/// @dev The maximal msg.value that context can have
uint256 constant MAX_MSG_VALUE = 2 ** 128 - 1;

/// @dev Prefix used during derivation of account addresses using CREATE2
/// @dev keccak256("zksyncCreate2")
bytes32 constant CREATE2_PREFIX = 0x2020dba91b30cc0006188af794c2fb30dd8520db7e2c088b7fc7c103c00ca494;
/// @dev Prefix used during derivation of account addresses using CREATE
/// @dev keccak256("zksyncCreate")
bytes32 constant CREATE_PREFIX = 0x63bae3a9951d38e8a3fbb7b70909afc1200610fc5bc55ade242f815974674f23;

/// @dev Each state diff consists of 156 bytes of actual data and 116 bytes of unused padding, needed for circuit efficiency.
uint256 constant STATE_DIFF_ENTRY_SIZE = 272;

/// @dev While the "real" amount of pubdata that can be sent rarely exceeds the BLOB_SIZE_BYTES * MAX_NUMBER_OF_BLOBS, it is better to
/// allow the operator to provide any reasonably large value in order to avoid unneeded constraints on the operator.
uint256 constant MAX_ALLOWED_PUBDATA_PER_BATCH = 520000;

enum SystemLogKey {
    L2_TO_L1_LOGS_TREE_ROOT_KEY,
    TOTAL_L2_TO_L1_PUBDATA_KEY,
    STATE_DIFF_HASH_KEY,
    PACKED_BATCH_AND_L2_BLOCK_TIMESTAMP_KEY,
    PREV_BATCH_HASH_KEY,
    CHAINED_PRIORITY_TXN_HASH_KEY,
    NUMBER_OF_LAYER_1_TXS_KEY,
    BLOB_ONE_HASH_KEY,
    BLOB_TWO_HASH_KEY,
    EXPECTED_SYSTEM_CONTRACT_UPGRADE_TX_HASH_KEY
}

/// @dev The number of leaves in the L2->L1 log Merkle tree.
/// While formally a tree of any length is acceptable, the node supports only a constant length of 4096 leaves.
uint256 constant L2_TO_L1_LOGS_MERKLE_TREE_LEAVES = 4096;

/// @dev The length of the derived key in bytes inside compressed state diffs.
uint256 constant DERIVED_KEY_LENGTH = 32;
/// @dev The length of the enum index in bytes inside compressed state diffs.
uint256 constant ENUM_INDEX_LENGTH = 8;
/// @dev The length of value in bytes inside compressed state diffs.
uint256 constant VALUE_LENGTH = 32;

/// @dev The length of the compressed initial storage write in bytes.
uint256 constant COMPRESSED_INITIAL_WRITE_SIZE = DERIVED_KEY_LENGTH + VALUE_LENGTH;
/// @dev The length of the compressed repeated storage write in bytes.
uint256 constant COMPRESSED_REPEATED_WRITE_SIZE = ENUM_INDEX_LENGTH + VALUE_LENGTH;

/// @dev The position from which the initial writes start in the compressed state diffs.
uint256 constant INITIAL_WRITE_STARTING_POSITION = 4;

/// @dev Each storage diffs consists of the following elements:
/// [20bytes address][32bytes key][32bytes derived key][8bytes enum index][32bytes initial value][32bytes final value]
/// @dev The offset of the deriived key in a storage diff.
uint256 constant STATE_DIFF_DERIVED_KEY_OFFSET = 52;
/// @dev The offset of the enum index in a storage diff.
uint256 constant STATE_DIFF_ENUM_INDEX_OFFSET = 84;
/// @dev The offset of the final value in a storage diff.
uint256 constant STATE_DIFF_FINAL_VALUE_OFFSET = 124;

/// @dev Total number of bytes in a blob. Blob = 4096 field elements * 31 bytes per field element
/// @dev EIP-4844 defines it as 131_072 but we use 4096 * 31 within our circuits to always fit within a field element
/// @dev Our circuits will prove that a EIP-4844 blob and our internal blob are the same.
uint256 constant BLOB_SIZE_BYTES = 126_976;

/// @dev Max number of blobs currently supported
uint256 constant MAX_NUMBER_OF_BLOBS = 2;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L1:1

```solidity
File: system-contracts/contracts/interfaces/IAccountCodeStorage.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

interface IAccountCodeStorage {
    function storeAccountConstructingCodeHash(address _address, bytes32 _hash) external;

    function storeAccountConstructedCodeHash(address _address, bytes32 _hash) external;

    function markAccountCodeHashAsConstructed(address _address) external;

    function getRawCodeHash(address _address) external view returns (bytes32 codeHash);

    function getCodeHash(uint256 _input) external view returns (bytes32 codeHash);

    function getCodeSize(uint256 _input) external view returns (uint256 codeSize);
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L1:1

```solidity
File: system-contracts/contracts/interfaces/IBaseToken.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

interface IBaseToken {
    function balanceOf(uint256) external view returns (uint256);

    function transferFromTo(address _from, address _to, uint256 _amount) external;

    function totalSupply() external view returns (uint256);

    function name() external pure returns (string memory);

    function symbol() external pure returns (string memory);

    function decimals() external pure returns (uint8);

    function mint(address _account, uint256 _amount) external;

    function withdraw(address _l1Receiver) external payable;

    function withdrawWithMessage(address _l1Receiver, bytes calldata _additionalData) external payable;

    event Mint(address indexed account, uint256 amount);

    event Transfer(address indexed from, address indexed to, uint256 value);

    event Withdrawal(address indexed _l2Sender, address indexed _l1Receiver, uint256 _amount);

    event WithdrawalWithMessage(
        address indexed _l2Sender,
        address indexed _l1Receiver,
        uint256 _amount,
        bytes _additionalData
    );
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L1:1

```solidity
File: system-contracts/contracts/interfaces/IBootloaderUtilities.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

import "../libraries/TransactionHelper.sol";

interface IBootloaderUtilities {
    function getTransactionHashes(
        Transaction calldata _transaction
    ) external view returns (bytes32 txHash, bytes32 signedTxHash);
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBootloaderUtilities.sol#L1:1

```solidity
File: system-contracts/contracts/interfaces/IImmutableSimulator.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

struct ImmutableData {
    uint256 index;
    bytes32 value;
}

interface IImmutableSimulator {
    function getImmutable(address _dest, uint256 _index) external view returns (bytes32);

    function setImmutables(address _dest, ImmutableData[] calldata _immutables) external;
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L1:1

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

interface IL2StandardToken {
    event BridgeMint(address indexed _account, uint256 _amount);

    event BridgeBurn(address indexed _account, uint256 _amount);

    function bridgeMint(address _account, uint256 _amount) external;

    function bridgeBurn(address _account, uint256 _amount) external;

    function l1Address() external view returns (address);

    function l2Bridge() external view returns (address);
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L1:1

```solidity
File: system-contracts/contracts/interfaces/IMailbox.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

interface IMailbox {
    function finalizeEthWithdrawal(
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBlock,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external;
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IMailbox.sol#L1:1

```solidity
File: system-contracts/contracts/interfaces/INonceHolder.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

/**
 * @author Matter Labs
 * @dev Interface of the nonce holder contract -- a contract used by the system to ensure
 * that there is always a unique identifier for a transaction with a particular account (we call it nonce).
 * In other words, the pair of (address, nonce) should always be unique.
 * @dev Custom accounts should use methods of this contract to store nonces or other possible unique identifiers
 * for the transaction.
 */
interface INonceHolder {
    event ValueSetUnderNonce(address indexed accountAddress, uint256 indexed key, uint256 value);

    /// @dev Returns the current minimal nonce for account.
    function getMinNonce(address _address) external view returns (uint256);

    /// @dev Returns the raw version of the current minimal nonce
    /// (equal to minNonce + 2^128 * deployment nonce).
    function getRawNonce(address _address) external view returns (uint256);

    /// @dev Increases the minimal nonce for the msg.sender.
    function increaseMinNonce(uint256 _value) external returns (uint256);

    /// @dev Sets the nonce value `key` as used.
    function setValueUnderNonce(uint256 _key, uint256 _value) external;

    /// @dev Gets the value stored inside a custom nonce.
    function getValueUnderNonce(uint256 _key) external view returns (uint256);

    /// @dev A convenience method to increment the minimal nonce if it is equal
    /// to the `_expectedNonce`.
    function incrementMinNonceIfEquals(uint256 _expectedNonce) external;

    /// @dev Returns the deployment nonce for the accounts used for CREATE opcode.
    function getDeploymentNonce(address _address) external view returns (uint256);

    /// @dev Increments the deployment nonce for the account and returns the previous one.
    function incrementDeploymentNonce(address _address) external returns (uint256);

    /// @dev Determines whether a certain nonce has been already used for an account.
    function validateNonceUsage(address _address, uint256 _key, bool _shouldBeUsed) external view;

    /// @dev Returns whether a nonce has been used for an account.
    function isNonceUsed(address _address, uint256 _nonce) external view returns (bool);
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L1:1

```solidity
File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol


// SPDX-License-Identifier: MIT

pragma solidity 0.8.20;

/**
 * @author Matter Labs
 * @custom:security-contact security@matterlabs.dev
 * @dev The library provides a set of functions that help read data from calldata bytes.
 * @dev Each of the functions accepts the `bytes calldata` and the offset where data should be read and returns a value of a certain type.
 *
 * @dev WARNING!
 * 1) Functions don't check the length of the bytes array, so it can go out of bounds.
 * The user of the library must check for bytes length before using any functions from the library!
 *
 * 2) Read variables are not cleaned up - https://docs.soliditylang.org/en/v0.8.16/internals/variable_cleanup.html.
 * Using data in inline assembly can lead to unexpected behavior!
 */
library UnsafeBytesCalldata {
    function readUint16(bytes calldata _bytes, uint256 _start) internal pure returns (uint16 result) {
        assembly {
            let offset := sub(_bytes.offset, 30)
            result := calldataload(add(offset, _start))
        }
    }

    function readUint32(bytes calldata _bytes, uint256 _start) internal pure returns (uint32 result) {
        assembly {
            let offset := sub(_bytes.offset, 28)
            result := calldataload(add(offset, _start))
        }
    }

    function readUint64(bytes calldata _bytes, uint256 _start) internal pure returns (uint64 result) {
        assembly {
            let offset := sub(_bytes.offset, 24)
            result := calldataload(add(offset, _start))
        }
    }

    function readBytes32(bytes calldata _bytes, uint256 _start) internal pure returns (bytes32 result) {
        assembly {
            result := calldataload(add(_bytes.offset, _start))
        }
    }

    function readUint256(bytes calldata _bytes, uint256 _start) internal pure returns (uint256 result) {
        assembly {
            result := calldataload(add(_bytes.offset, _start))
        }
    }
}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L1:1

</details>

## NC025 - Function declarations should have NatSpec descriptions:

Function declarations should be preceded by a NatSpec comment.


<details>
<summary>Click to show 200 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


137         function receiveEth(uint256 _chainId) external payable {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L137:137

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol


24          function isWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool);


26          function deposit(


35          function deposit(


43          function claimFailedDeposit(


53          function finalizeWithdrawal(


61          function l2TokenAddress(address _l1Token) external view returns (address);


63          function sharedBridge() external view returns (IL1SharedBridge);


65          function l2TokenBeacon() external view returns (address);


67          function l2Bridge() external view returns (address);


69          function depositAmount(


75          function tranferTokenToSharedBridge(address _token, uint256 _amount) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L75:75

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol


58          function isWithdrawalFinalized(


64          function depositLegacyErc20Bridge(


74          function claimFailedDepositLegacyErc20Bridge(


85          function claimFailedDeposit(


97          function finalizeWithdrawalLegacyErc20Bridge(


105         function finalizeWithdrawal(


114         function l1WethAddress() external view returns (address);


116         function bridgehub() external view returns (IBridgehub);


118         function legacyBridge() external view returns (IL1ERC20Bridge);


120         function l2BridgeAddress(uint256 _chainId) external view returns (address);


122         function depositHappened(uint256 _chainId, bytes32 _l2TxHash) external view returns (bytes32);


128         function bridgehubDeposit(


135         function bridgehubDepositBaseToken(


142         function bridgehubConfirmL2Transaction(uint256 _chainId, bytes32 _txDataHash, bytes32 _txHash) external;


144         function receiveEth(uint256 _chainId) external payable;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L144:144

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol


7           function finalizeDeposit(


15          function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external;


17          function l1TokenAddress(address _l2Token) external view returns (address);


19          function l2TokenAddress(address _l1Token) external view returns (address);


21          function l1Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L21:21

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol


5           function deposit() external payable;


7           function withdraw(uint256 wad) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol#L7:7

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


59          function stateTransitionManagerIsRegistered(address _stateTransitionManager) external view returns (bool);


61          function stateTransitionManager(uint256 _chainId) external view returns (address);


63          function tokenIsRegistered(address _baseToken) external view returns (bool);


65          function baseToken(uint256 _chainId) external view returns (address);


67          function sharedBridge() external view returns (IL1SharedBridge);


69          function getStateTransition(uint256 _chainId) external view returns (address);


73          function proveL2MessageInclusion(


81          function proveL2LogInclusion(


89          function proveL1ToL2TransactionStatus(


99          function requestL2TransactionDirect(


103         function requestL2TransactionTwoBridges(


107         function l2TransactionBaseCost(


116         function createNewChain(


125         function addStateTransitionManager(address _stateTransitionManager) external;


127         function removeStateTransitionManager(address _stateTransitionManager) external;


129         function addToken(address _token) external;


131         function setSharedBridge(address _sharedBridge) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L131:131

```solidity
File: contracts/ethereum/contracts/common/libraries/UncheckedMath.sol


11          function uncheckedInc(uint256 _number) internal pure returns (uint256) {


17          function uncheckedAdd(uint256 _lhs, uint256 _rhs) internal pure returns (uint256) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UncheckedMath.sol#L17:17

```solidity
File: contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol


19          function readUint32(bytes memory _bytes, uint256 _start) internal pure returns (uint32 result, uint256 offset) {


26          function readAddress(bytes memory _bytes, uint256 _start) internal pure returns (address result, uint256 offset) {


33          function readUint256(bytes memory _bytes, uint256 _start) internal pure returns (uint256 result, uint256 offset) {


40          function readBytes32(bytes memory _bytes, uint256 _start) internal pure returns (bytes32 result, uint256 offset) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L40:40

```solidity
File: contracts/ethereum/contracts/governance/IGovernance.sol


41          function isOperation(bytes32 _id) external view returns (bool);


43          function isOperationPending(bytes32 _id) external view returns (bool);


45          function isOperationReady(bytes32 _id) external view returns (bool);


47          function isOperationDone(bytes32 _id) external view returns (bool);


49          function getOperationState(bytes32 _id) external view returns (OperationState);


51          function scheduleTransparent(Operation calldata _operation, uint256 _delay) external;


53          function scheduleShadow(bytes32 _id, uint256 _delay) external;


55          function cancel(bytes32 _id) external;


57          function execute(Operation calldata _operation) external payable;


59          function executeInstant(Operation calldata _operation) external payable;


61          function hashOperation(Operation calldata _operation) external pure returns (bytes32);


63          function updateDelay(uint256 _newDelay) external;


65          function updateSecurityCouncil(address _newSecurityCouncil) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L65:65

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


43          function bridgehub() external view returns (address);


53          function stateTransition(uint256 _chainId) external view returns (address);


55          function storedBatchZero() external view returns (bytes32);


57          function initialCutHash() external view returns (bytes32);


59          function genesisUpgrade() external view returns (address);


61          function upgradeCutHash(uint256 _protocolVersion) external view returns (bytes32);


63          function protocolVersion() external view returns (uint256);


65          function initialize(StateTransitionManagerInitializeData calldata _initalizeData) external;


67          function setInitialCutHash(Diamond.DiamondCutData calldata _diamondCut) external;


69          function setValidatorTimelock(address _validatorTimelock) external;


71          function getChainAdmin(uint256 _chainId) external view returns (address);


82          function registerAlreadyDeployedStateTransition(uint256 _chainId, address _stateTransitionContract) external;


84          function setNewVersionUpgrade(


90          function setUpgradeDiamondCut(Diamond.DiamondCutData calldata _cutData, uint256 _oldProtocolVersion) external;


92          function freezeChain(uint256 _chainId) external;


94          function unfreezeChain(uint256 _chainId) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L94:94

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


74          function getChainAdmin(uint256 _chainId) external view override returns (address) {


230         function registerAlreadyDeployedStateTransition(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L230:230

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


55          constructor(address _initialOwner, uint32 _executionDelay) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L55:55

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol


11          constructor(uint256 _chainId, Diamond.DiamondCutData memory _diamondCut) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L11:11

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


89          function setValidiumMode(PubdataPricingMode _validiumMode) external onlyAdmin {


100         function upgradeChainFromVersion(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L100:100

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol


45          function upgradeChainFromVersion(uint256 _protocolVersion, Diamond.DiamondCutData calldata _cutData) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L45:45

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol


62          function initialize(InitializeData calldata _initData) external returns (bytes32);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L62:62

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol


98          function bridgehubRequestL2Transaction(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L98:98

```solidity
File: contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol


5           function setChainId(uint256 _newChainId) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol#L5:5

```solidity
File: contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol


8           function upgrade(ProposedUpgrade calldata _upgrade) external returns (bytes32);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol#L8:8

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


27          function safeCastToU32(uint256 _x) internal pure returns (uint32) {


37          function systemCall(uint32 gasLimit, address to, uint256 value, bytes memory data) internal returns (bool success) {


76          function systemCallWithReturndata(


95          function getFarCallABI(


121         function getFarCallABIWithEmptyFatPointer(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L121:121

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


159         function name() public view override returns (string memory) {


165         function symbol() public view override returns (string memory) {


171         function decimals() public view override returns (uint8) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L171:171

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol


9           function finalizeWithdrawal(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L9:9

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol


9           function finalizeWithdrawal(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol#L9:9

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol


24          function finalizeDeposit(


32          function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external;


34          function l1TokenAddress(address _l2Token) external view returns (address);


36          function l2TokenAddress(address _l1Token) external view returns (address);


38          function l1Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L38:38

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol


12          function bridgeMint(address _account, uint256 _amount) external;


14          function bridgeBurn(address _account, uint256 _amount) external;


16          function l1Address() external view returns (address);


18          function l2Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L18:18

```solidity
File: contracts/zksync/contracts/interfaces/IPaymasterFlow.sol


14          function general(bytes calldata input) external;


16          function approvalBased(address _token, uint256 _minAllowance, bytes calldata _innerInput) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymasterFlow.sol#L16:16

```solidity
File: system-contracts/contracts/DefaultAccount.sol


220         fallback() external payable ignoreInDelegateCall {


227         receive() external payable {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L227:227

```solidity
File: system-contracts/contracts/EmptyContract.sol


11          fallback() external payable {}


13          receive() external payable {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L13:13

```solidity
File: system-contracts/contracts/L1Messenger.sol


50          function keccakGasCost(uint256 _length) internal pure returns (uint256) {


61          function sha256GasCost(uint256 _length) internal pure returns (uint256) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L61:61

```solidity
File: system-contracts/contracts/SystemContext.sol


117         function getCurrentPubdataSpent() public view returns (uint256) {


122         function getCurrentPubdataCost() external view returns (uint256) {


482         function incrementTxNumberInBatch() external onlyCallFromBootloader {


486         function resetTxNumberInBatch() external onlyCallFromBootloader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L486:486

```solidity
File: system-contracts/contracts/interfaces/IAccount.sol


26          function executeTransaction(


34          function executeTransactionFromOutside(Transaction calldata _transaction) external payable;


36          function payForTransaction(


42          function prepareForPaymaster(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccount.sol#L42:42

```solidity
File: system-contracts/contracts/interfaces/IAccountCodeStorage.sol


6           function storeAccountConstructingCodeHash(address _address, bytes32 _hash) external;


8           function storeAccountConstructedCodeHash(address _address, bytes32 _hash) external;


10          function markAccountCodeHashAsConstructed(address _address) external;


12          function getRawCodeHash(address _address) external view returns (bytes32 codeHash);


14          function getCodeHash(uint256 _input) external view returns (bytes32 codeHash);


16          function getCodeSize(uint256 _input) external view returns (uint256 codeSize);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L16:16

```solidity
File: system-contracts/contracts/interfaces/IBaseToken.sol


6           function balanceOf(uint256) external view returns (uint256);


8           function transferFromTo(address _from, address _to, uint256 _amount) external;


10          function totalSupply() external view returns (uint256);


12          function name() external pure returns (string memory);


14          function symbol() external pure returns (string memory);


16          function decimals() external pure returns (uint8);


18          function mint(address _account, uint256 _amount) external;


20          function withdraw(address _l1Receiver) external payable;


22          function withdrawWithMessage(address _l1Receiver, bytes calldata _additionalData) external payable;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L22:22

```solidity
File: system-contracts/contracts/interfaces/IBootloaderUtilities.sol


8           function getTransactionHashes(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBootloaderUtilities.sol#L8:8

```solidity
File: system-contracts/contracts/interfaces/IComplexUpgrader.sol


11          function upgrade(address _delegateTo, bytes calldata _calldata) external payable;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IComplexUpgrader.sol#L11:11

```solidity
File: system-contracts/contracts/interfaces/ICompressor.sol


19          function publishCompressedBytecode(


24          function verifyCompressedStateDiffs(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ICompressor.sol#L24:24

```solidity
File: system-contracts/contracts/interfaces/IContractDeployer.sol


43          function getNewAddressCreate2(


50          function getNewAddressCreate(address _sender, uint256 _senderNonce) external pure returns (address newAddress);


52          function create2(


58          function create2Account(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L58:58

```solidity
File: system-contracts/contracts/interfaces/IImmutableSimulator.sol


11          function getImmutable(address _dest, uint256 _index) external view returns (bytes32);


13          function setImmutables(address _dest, ImmutableData[] calldata _immutables) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L13:13

```solidity
File: system-contracts/contracts/interfaces/IKnownCodesStorage.sol


14          function markFactoryDeps(bool _shouldSendToL1, bytes32[] calldata _hashes) external;


16          function markBytecodeAsPublished(bytes32 _bytecodeHash) external;


18          function getMarker(bytes32 _hash) external view returns (uint256);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IKnownCodesStorage.sol#L18:18

```solidity
File: system-contracts/contracts/interfaces/IL1Messenger.sol


49          function sendToL1(bytes memory _message) external returns (bytes32);


51          function sendL2ToL1Log(bool _isService, bytes32 _key, bytes32 _value) external returns (uint256 logIdInMerkleTree);


54          function requestBytecodeL1Publication(bytes32 _bytecodeHash) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L54:54

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


10          function bridgeMint(address _account, uint256 _amount) external;


12          function bridgeBurn(address _account, uint256 _amount) external;


14          function l1Address() external view returns (address);


16          function l2Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L16:16

```solidity
File: system-contracts/contracts/interfaces/IMailbox.sol


6           function finalizeEthWithdrawal(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IMailbox.sol#L6:6

```solidity
File: system-contracts/contracts/interfaces/IPaymasterFlow.sol


13          function general(bytes calldata input) external;


15          function approvalBased(address _token, uint256 _minAllowance, bytes calldata _innerInput) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymasterFlow.sol#L15:15

```solidity
File: system-contracts/contracts/interfaces/ISystemContext.sol


30          function chainId() external view returns (uint256);


32          function origin() external view returns (address);


34          function gasPrice() external view returns (uint256);


36          function blockGasLimit() external view returns (uint256);


38          function coinbase() external view returns (address);


40          function difficulty() external view returns (uint256);


42          function baseFee() external view returns (uint256);


44          function txNumberInBlock() external view returns (uint16);


46          function getBlockHashEVM(uint256 _block) external view returns (bytes32);


48          function getBatchHash(uint256 _batchNumber) external view returns (bytes32 hash);


50          function getBlockNumber() external view returns (uint128);


52          function getBlockTimestamp() external view returns (uint128);


54          function getBatchNumberAndTimestamp() external view returns (uint128 blockNumber, uint128 blockTimestamp);


56          function getL2BlockNumberAndTimestamp() external view returns (uint128 blockNumber, uint128 blockTimestamp);


58          function gasPerPubdataByte() external view returns (uint256 gasPerPubdataByte);


60          function getCurrentPubdataSpent() external view returns (uint256 currentPubdataSpent);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L60:60

```solidity
File: system-contracts/contracts/interfaces/ISystemContextDeprecated.sol


11          function currentBlockInfo() external view returns (uint256);


13          function getBlockNumberAndTimestamp() external view returns (uint256 blockNumber, uint256 blockTimestamp);


15          function blockHash(uint256 _blockNumber) external view returns (bytes32 hash);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContextDeprecated.sol#L15:15

```solidity
File: system-contracts/contracts/libraries/RLPEncoder.sol


11          function encodeAddress(address _val) internal pure returns (bytes memory encoded) {


24          function encodeUint256(uint256 _val) internal pure returns (bytes memory encoded) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L24:24

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


405         function totalRequiredBalance(Transaction calldata _transaction) internal pure returns (uint256 requiredBalance) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L405:405

```solidity
File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol


19          function readUint16(bytes calldata _bytes, uint256 _start) internal pure returns (uint16 result) {


26          function readUint32(bytes calldata _bytes, uint256 _start) internal pure returns (uint32 result) {


33          function readUint64(bytes calldata _bytes, uint256 _start) internal pure returns (uint64 result) {


40          function readBytes32(bytes calldata _bytes, uint256 _start) internal pure returns (bytes32 result) {


46          function readUint256(bytes calldata _bytes, uint256 _start) internal pure returns (uint256 result) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L46:46

```solidity
File: system-contracts/contracts/libraries/Utils.sol


20          function safeCastToU128(uint256 _x) internal pure returns (uint128) {


26          function safeCastToU32(uint256 _x) internal pure returns (uint32) {


32          function safeCastToU24(uint256 _x) internal pure returns (uint24) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L32:32

</details>

## NC026 - Contract declarations should have `@notice` tags:

`@notice` is used to explain to end users what the contract does, and the compiler interprets `///` or `/**` comments as this tag if one wasn't explicitly provided.


<details>
<summary>Click to show 92 findings</summary>

```solidity
File: contracts/GasBoundCaller.sol


15      contract GasBoundCaller {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L15:15

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


30      contract L1SharedBridge is IL1SharedBridge, ReentrancyGuard, Initializable, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L30:30

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol


12      interface IL1SharedBridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L12:12

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol


6       interface IL2Bridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L6:6

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol


4       interface IWETH9 {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol#L4:4

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


16      contract Bridgehub is IBridgehub, ReentrancyGuard, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L16:16

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


42      interface IBridgehub {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L42:42

```solidity
File: contracts/ethereum/contracts/common/ReentrancyGuard.sol


25      abstract contract ReentrancyGuard {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L25:25

```solidity
File: contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol


9       interface IL2ContractDeployer {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol#L9:9

```solidity
File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol


10      library L2ContractHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L10:10

```solidity
File: contracts/ethereum/contracts/common/libraries/UncheckedMath.sol


10      library UncheckedMath {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UncheckedMath.sol#L10:10

```solidity
File: contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol


18      library UnsafeBytes {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L18:18

```solidity
File: contracts/ethereum/contracts/governance/IGovernance.sol


8       interface IGovernance {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L8:8

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


26      interface IStateTransitionManager {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L26:26

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


25      contract StateTransitionManager is IStateTransitionManager, ReentrancyGuard, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L25:25

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


17      contract DiamondInit is ZkSyncStateTransitionBase, IDiamondInit {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L17:17

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol


10      contract DiamondProxy {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L10:10

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


18      contract AdminFacet is ZkSyncStateTransitionBase, IAdmin {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L18:18

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


22      contract ExecutorFacet is ZkSyncStateTransitionBase, IExecutor {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L22:22

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


20      contract GettersFacet is ZkSyncStateTransitionBase, IGetters, ILegacyGetters {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


30      contract MailboxFacet is ZkSyncStateTransitionBase, IMailbox {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L30:30

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol


11      contract ZkSyncStateTransitionBase is ReentrancyGuard {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L11:11

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol


13      interface IAdmin is IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L13:13

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol


61      interface IDiamondInit {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L61:61

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol


73      interface IExecutor is IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L73:73

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol


13      interface IGetters is IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L13:13

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol


11      interface ILegacyGetters is IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol#L11:11

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol


11      interface IMailbox is IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L11:11

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol


15      interface IVerifier {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol#L15:15

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol


15      interface IZkSyncStateTransition is IAdmin, IExecutor, IGetters, IMailbox {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol#L15:15

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol


7       interface IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol#L7:7

```solidity
File: contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol


4       interface ISystemContext {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol#L4:4

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol


9       library Merkle {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L9:9

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol


20      library PriorityQueue {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol


13      library TransactionValidator {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L13:13

```solidity
File: contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol


10      contract DefaultUpgrade is BaseZkSyncUpgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol#L10:10

```solidity
File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol


11      contract GenesisUpgrade is BaseZkSyncUpgradeGenesis {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L11:11

```solidity
File: contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol


7       interface IDefaultUpgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol#L7:7

```solidity
File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol


21      library AddressAliasHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L21:21

```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


18      interface IL2Messenger {


30      interface IContractDeployer {


61      interface IBaseToken {


83      library L2ContractHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L83:83

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


26      library Utils {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L26:26

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol


8       interface IL1ERC20Bridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L8:8

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol


8       interface IL1SharedBridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol#L8:8

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol


6       interface IL2SharedBridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L6:6

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol


5       interface IL2StandardToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L5:5

```solidity
File: contracts/zksync/contracts/interfaces/IPaymaster.sol


14      interface IPaymaster {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymaster.sol#L14:14

```solidity
File: contracts/zksync/contracts/interfaces/IPaymasterFlow.sol


13      interface IPaymasterFlow {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymasterFlow.sol#L13:13

```solidity
File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol


21      library AddressAliasHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L21:21

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


22      contract AccountCodeStorage is IAccountCodeStorage {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L22:22

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


16      contract BootloaderUtilities is IBootloaderUtilities {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L16:16

```solidity
File: system-contracts/contracts/ComplexUpgrader.sol


14      contract ComplexUpgrader is IComplexUpgrader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L14:14

```solidity
File: system-contracts/contracts/Compressor.sol


22      contract Compressor is ICompressor, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L22:22

```solidity
File: system-contracts/contracts/ContractDeployer.sol


23      contract ContractDeployer is IContractDeployer, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L23:23

```solidity
File: system-contracts/contracts/DefaultAccount.sol


19      contract DefaultAccount is IAccount {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L19:19

```solidity
File: system-contracts/contracts/EmptyContract.sol


10      contract EmptyContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L10:10

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


18      contract ImmutableSimulator is IImmutableSimulator {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L18:18

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


18      contract KnownCodesStorage is IKnownCodesStorage, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L18:18

```solidity
File: system-contracts/contracts/L1Messenger.sol


25      contract L1Messenger is IL1Messenger, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L25:25

```solidity
File: system-contracts/contracts/L2BaseToken.sol


18      contract L2BaseToken is IBaseToken, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L18:18

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


19      contract MsgValueSimulator is ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L19:19

```solidity
File: system-contracts/contracts/NonceHolder.sol


27      contract NonceHolder is INonceHolder, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L27:27

```solidity
File: system-contracts/contracts/PubdataChunkPublisher.sol


16      contract PubdataChunkPublisher is IPubdataChunkPublisher, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L16:16

```solidity
File: system-contracts/contracts/SystemContext.sol


17      contract SystemContext is ISystemContext, ISystemContextDeprecated, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L17:17

```solidity
File: system-contracts/contracts/interfaces/IAccount.sol


9       interface IAccount {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccount.sol#L9:9

```solidity
File: system-contracts/contracts/interfaces/IAccountCodeStorage.sol


5       interface IAccountCodeStorage {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IBaseToken.sol


5       interface IBaseToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IBootloaderUtilities.sol


7       interface IBootloaderUtilities {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBootloaderUtilities.sol#L7:7

```solidity
File: system-contracts/contracts/interfaces/IComplexUpgrader.sol


10      interface IComplexUpgrader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IComplexUpgrader.sol#L10:10

```solidity
File: system-contracts/contracts/interfaces/ICompressor.sol


18      interface ICompressor {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ICompressor.sol#L18:18

```solidity
File: system-contracts/contracts/interfaces/IContractDeployer.sol


5       interface IContractDeployer {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IImmutableSimulator.sol


10      interface IImmutableSimulator {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L10:10

```solidity
File: system-contracts/contracts/interfaces/IKnownCodesStorage.sol


11      interface IKnownCodesStorage {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IKnownCodesStorage.sol#L11:11

```solidity
File: system-contracts/contracts/interfaces/IL1Messenger.sol


40      interface IL1Messenger {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L40:40

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


5       interface IL2StandardToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IMailbox.sol


5       interface IMailbox {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IMailbox.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/INonceHolder.sol


13      interface INonceHolder {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L13:13

```solidity
File: system-contracts/contracts/interfaces/IPaymaster.sol


14      interface IPaymaster {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L14:14

```solidity
File: system-contracts/contracts/interfaces/IPaymasterFlow.sol


12      interface IPaymasterFlow {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymasterFlow.sol#L12:12

```solidity
File: system-contracts/contracts/interfaces/IPubdataChunkPublisher.sol


9       interface IPubdataChunkPublisher {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPubdataChunkPublisher.sol#L9:9

```solidity
File: system-contracts/contracts/interfaces/ISystemContext.sol


11      interface ISystemContext {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L11:11

```solidity
File: system-contracts/contracts/interfaces/ISystemContextDeprecated.sol


10      interface ISystemContextDeprecated {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContextDeprecated.sol#L10:10

```solidity
File: system-contracts/contracts/interfaces/ISystemContract.sol


17      abstract contract ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L17:17

```solidity
File: system-contracts/contracts/libraries/EfficientCall.sol


32      library EfficientCall {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L32:32

```solidity
File: system-contracts/contracts/libraries/RLPEncoder.sol


10      library RLPEncoder {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L10:10

```solidity
File: system-contracts/contracts/libraries/SystemContractHelper.sol


41      library SystemContractHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L41:41

```solidity
File: system-contracts/contracts/libraries/SystemContractsCaller.sol


68      library SystemContractsCaller {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L68:68

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


78      library TransactionHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L78:78

```solidity
File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol


18      library UnsafeBytesCalldata {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L18:18

```solidity
File: system-contracts/contracts/libraries/Utils.sol


11      library Utils {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L11:11

</details>

## NC027 - Contract does not follow the Solidity style guide's suggested layout ordering:

The [style guide](https://docs.soliditylang.org/en/v0.8.16/style-guide.html#order-of-layout) says that, within a contract, the ordering should be 1) Type declarations, 2) State variables, 3) Events, 4) Modifiers, and 5) Functions, but the contract(s) below do not follow this ordering.


<details>
<summary>Click to show 16 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


401         struct MessageParams {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L401:401

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


45          modifier onlyOwnerOrAdmin() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L45:45

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


133         event NewChain(uint256 indexed chainId, address stateTransitionManager, address indexed chainGovernance);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L133:133

```solidity
File: contracts/ethereum/contracts/common/ReentrancyGuard.sol


68          modifier nonReentrant() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L68:68

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


58          modifier onlySelf() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L58:58

```solidity
File: contracts/ethereum/contracts/governance/IGovernance.sol


68          event TransparentOperationScheduled(bytes32 indexed _id, uint256 delay, Operation _operation);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L68:68

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


63          modifier onlyBridgehub() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L63:63

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


61          modifier onlyChainAdmin(uint256 _chainId) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L61:61

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol


61          event IsPorterAvailableStatusUpdate(bool isPorterAvailable);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L61:61

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol


191         event BlockCommit(uint256 indexed batchNumber, bytes32 indexed batchHash, bytes32 indexed commitment);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L191:191

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol


124         struct Facet {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L124:124

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol


123         event NewPriorityRequest(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L123:123

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


30          struct SelectorToFacet {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L30:30

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


129         modifier onlyBridge() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L129:129

```solidity
File: system-contracts/contracts/ContractDeployer.sol


197         struct ForceDeployment {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L197:197

```solidity
File: system-contracts/contracts/interfaces/IBaseToken.sol


24          event Mint(address indexed account, uint256 amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L24:24

</details>

## NC028 - Non-external/public variable names should begin with an underscore:

According to the Solidity Style Guide, non-external/public variable names should begin with an underscore


<details>
<summary>Click to show 28 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


45          uint256 internal eraFirstPostUpgradeBatch;


61          mapping(uint256 chainId => bool enabled) internal hyperbridgingEnabled;


65          mapping(uint256 chainId => mapping(address l1Token => uint256 balance)) internal chainBalance;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L65:65

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


35          address private pendingAdmin;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L35:35

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


54          address private pendingAdmin;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L54:54

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


47          mapping(uint256 => LibMap.Uint32Map) internal committedBatchTimestamp;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L47:47

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol


12          ZkSyncStateTransitionStorage internal s;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L12:12

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


32          bytes32 internal l2TokenProxyBytecodeHash;


37          address private l1LegacyBridge;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L37:37

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


26          ERC20Getters private availableGetters;


31          uint8 private decimals_;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L31:31

```solidity
File: system-contracts/contracts/ContractDeployer.sol


26          mapping(address => AccountInfo) internal accountInfo;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L26:26

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


21          mapping(uint256 contractAddress => mapping(uint256 index => bytes32 value)) internal immutableDataStorage;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L21:21

```solidity
File: system-contracts/contracts/L1Messenger.sol


28          bytes32 internal chainedLogsHash;


32          uint256 internal numberOfLogsToProcess;


36          bytes32 internal chainedMessagesHash;


41          bytes32 internal chainedL1BytecodesRevealDataHash;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L41:41

```solidity
File: system-contracts/contracts/L2BaseToken.sol


20          mapping(address account => uint256 balance) internal balance;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L20:20

```solidity
File: system-contracts/contracts/NonceHolder.sol


36          mapping(uint256 account => uint256 packedMinAndDeploymentNonce) internal rawNonces;


41          mapping(uint256 account => mapping(uint256 nonceKey => uint256 value)) internal nonceValues;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L41:41

```solidity
File: system-contracts/contracts/SystemContext.sol


51          BlockInfo internal currentBatchInfo;


55          mapping(uint256 batchNumber => bytes32 batchHash) internal batchHashes;


58          BlockInfo internal currentL2BlockInfo;


61          bytes32 internal currentL2BlockTxsRollingHash;


70          bytes32[MINIBLOCK_HASHES_TO_STORE] internal l2BlockHash;


77          BlockInfo internal currentVirtualL2BlockInfo;


80          VirtualBlockUpgradeInfo internal virtualBlockUpgradeInfo;


95          uint256 internal basePubdataSpent;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L95:95

</details>

## NC029 - Unused file:

The file is never imported by any other source file. If the file is needed for tests, it should be moved to a test directory


<details>
<summary>Click to show 7 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol


/// @auditbase `zksync/contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol` not used in any contracts


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol#L1:1

```solidity
File: contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol


/// @auditbase `zksync/contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol` not used in any contracts


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol#L1:1

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol


/// @auditbase `zksync/contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol` not used in any contracts


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol#L1:1

```solidity
File: contracts/zksync/contracts/interfaces/IPaymaster.sol


/// @auditbase `zksync/contracts/zksync/contracts/interfaces/IPaymaster.sol` not used in any contracts


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymaster.sol#L1:1

```solidity
File: contracts/zksync/contracts/interfaces/IPaymasterFlow.sol


/// @auditbase `zksync/contracts/zksync/contracts/interfaces/IPaymasterFlow.sol` not used in any contracts


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymasterFlow.sol#L1:1

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


/// @auditbase `zksync/system-contracts/contracts/interfaces/IL2StandardToken.sol` not used in any contracts


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L1:1

```solidity
File: system-contracts/contracts/interfaces/IPaymaster.sol


/// @auditbase `zksync/system-contracts/contracts/interfaces/IPaymaster.sol` not used in any contracts


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L1:1

</details>



## NC030 - Not using the named return variables anywhere in the function is confusing:

Consider changing the return variable to be an unnamed one, since the variable is never assigned, nor is it returned by name


<details>
<summary>Click to show 4 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


121         ) external onlyOwnerOrAdmin nonReentrant returns (uint256 chainId) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L121:121

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


87          function getDiamondStorage() internal pure returns (DiamondStorage storage diamondStorage) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L87:87

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


44          function encodeLegacyTransactionHash(Transaction calldata _transaction) internal view returns (bytes32 txHash) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L44:44

```solidity
File: system-contracts/contracts/ContractDeployer.sol


34          function getAccountInfo(address _address) external view returns (AccountInfo memory info) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L34:34

</details>

## NC031 - Unused arguments in override functions:

Arguments in overridden functions that are unused should have their names removed or commented out to avoid compiler warnings.


```solidity
File: system-contracts/contracts/DefaultAccount.sol


125         function executeTransactionFromOutside(Transaction calldata _transaction) external payable override {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L125:125

## NC032 - Expressions for constant values such as a call to `keccak256()`, should use `immutable` rather than `constant`:

While it **doesn't save any gas** because the compiler knows that developers often make this mistake, it's still best to use the right tool for the task at hand. There is a difference between `constant` variables and `immutable` variables, and they should each be used in their appropriate contexts. `constants` should be used for literal values written into the code, and `immutable` variables should be used for expressions, or values calculated in, or passed into the constructor.


<details>
<summary>Click to show 4 findings</summary>

```solidity
File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol


12          bytes32 private constant CREATE2_PREFIX = keccak256("zksyncCreate2");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L12:12

```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


85          bytes32 private constant CREATE2_PREFIX = keccak256("zksyncCreate2");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L85:85

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


82          bytes32 constant EIP712_DOMAIN_TYPEHASH = keccak256("EIP712Domain(string name,string version,uint256 chainId)");


84          bytes32 constant EIP712_TRANSACTION_TYPE_HASH =
85              keccak256(
86                  "Transaction(uint256 txType,uint256 from,uint256 to,uint256 gasLimit,uint256 gasPerPubdataByteLimit,uint256 maxFeePerGas,uint256 maxPriorityFeePerGas,uint256 paymaster,uint256 nonce,uint256 value,bytes data,bytes32[] factoryDeps,bytes paymasterInput)"
87              );


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L84:87

</details>

## NC033 - Empty Function Body - Consider commenting why:




<details>
<summary>Click to show 4 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


60          function initialize() external reentrancyGuardInitializer {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L60:60

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


263         function _upgradeL1Contract(bytes calldata _customCallDataForUpgrade) internal virtual {}


269         function _postUpgrade(bytes calldata _customCallDataForUpgrade) internal virtual {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L269:269

```solidity
File: system-contracts/contracts/DefaultAccount.sol


125         function executeTransactionFromOutside(Transaction calldata _transaction) external payable override {
126             // Behave the same as for fallback/receive, just execute nothing, returns nothing
127         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L125:127

</details>

## NC034 - Contracts should have full test coverage:

While 100% code coverage does not guarantee that there are no bugs, it often will catch easy-to-find bugs, and will ensure that there are fewer regressions when the code invariably has to be modified. Furthermore, in order to get full coverage, code authors will often have to re-organize their code so that it is more modular, so that each component can be tested separately, which reduces interdependencies between modules and layers, and makes for code that is easier to reason about and audit.


```solidity
File: Various Files


None

```

## NC035 - A event should be emitted if a non immutable state variable is set in a constructor:




```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


55          constructor(address _initialOwner, uint32 _executionDelay) {
56              _transferOwnership(_initialOwner);
57              executionDelay = _executionDelay;
58          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L55:58



## NC036 - Missing events in sensitive functions:

Sensitive setter functions in smart contracts often alter critical state variables. Without events emitted in these functions, external observers or dApps cannot easily track or react to these state changes. Missing events can obscure contract activity, hampering transparency and making integration more challenging. To resolve this, incorporate appropriate event emissions within these functions. Events offer an efficient way to log crucial changes, aiding in real-time tracking and post-transaction verification..


<details>
<summary>Click to show 17 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


108         function setSharedBridge(address _sharedBridge) external onlyOwner {
109             sharedBridge = IL1SharedBridge(_sharedBridge);
110         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L108:110

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


132         function setValidatorTimelock(address _validatorTimelock) external onlyOwnerOrAdmin {
133             validatorTimelock = _validatorTimelock;
134         }


137         function setInitialCutHash(Diamond.DiamondCutData calldata _diamondCut) external onlyOwner {
138             initialCutHash = keccak256(abi.encode(_diamondCut));
139         }


142         function setNewVersionUpgrade(
143             Diamond.DiamondCutData calldata _cutData,
144             uint256 _oldProtocolVersion,
145             uint256 _newProtocolVersion
146         ) external onlyOwner {
147             upgradeCutHash[_oldProtocolVersion] = keccak256(abi.encode(_cutData));
148             protocolVersion = _newProtocolVersion;
149         }


152         function setUpgradeDiamondCut(
153             Diamond.DiamondCutData calldata _cutData,
154             uint256 _oldProtocolVersion
155         ) external onlyOwner {
156             upgradeCutHash[_oldProtocolVersion] = keccak256(abi.encode(_cutData));
157         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L152:157

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


73          function setStateTransitionManager(IStateTransitionManager _stateTransitionManager) external onlyOwner {
74              stateTransitionManager = _stateTransitionManager;
75          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L73:75

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


597         function _setBit(uint256 _bitMap, uint8 _index) internal pure returns (uint256) {
598             return _bitMap | (1 << _index);
599         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L597:599

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


34          function setImmutables(address _dest, ImmutableData[] calldata _immutables) external override {
35              require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract");
36              unchecked {
37                  uint256 immutablesLength = _immutables.length;
38                  for (uint256 i = 0; i < immutablesLength; ++i) {
39                      uint256 index = _immutables[i].index;
40                      bytes32 value = _immutables[i].value;
41                      immutableDataStorage[uint256(uint160(_dest))][index] = value;
42                  }
43              }
44          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L34:44

```solidity
File: system-contracts/contracts/SystemContext.sol


84          function setChainId(uint256 _newChainId) external onlyCallFromForceDeployer {
85              chainId = _newChainId;
86          }


99          function setTxOrigin(address _newOrigin) external onlyCallFromBootloader {
100             origin = _newOrigin;
101         }


105         function setGasPrice(uint256 _gasPrice) external onlyCallFromBootloader {
106             gasPrice = _gasPrice;
107         }


112         function setPubdataInfo(uint256 _gasPerPubdataByte, uint256 _basePubdataSpent) external onlyCallFromBootloader {
113             basePubdataSpent = _basePubdataSpent;
114             gasPerPubdataByte = _gasPerPubdataByte;
115         }


212         function _setL2BlockHash(uint256 _block, bytes32 _hash) internal {
213             l2BlockHash[_block % MINIBLOCK_HASHES_TO_STORE] = _hash;
214         }


263         function _setVirtualBlock(
264             uint128 _l2BlockNumber,
265             uint128 _maxVirtualBlocksToCreate,
266             uint128 _newTimestamp
267         ) internal {
268             if (virtualBlockUpgradeInfo.virtualBlockFinishL2Block != 0) {
269                 // No need to to do anything about virtual blocks anymore
270                 // All the info is the same as for L2 blocks.
271                 currentVirtualL2BlockInfo = currentL2BlockInfo;
272                 return;
273             }
274     
275             BlockInfo memory virtualBlockInfo = currentVirtualL2BlockInfo;
276     
277             if (currentVirtualL2BlockInfo.number == 0 && virtualBlockInfo.timestamp == 0) {
278                 uint128 currentBatchNumber = currentBatchInfo.number;
279     
280                 // The virtual block is set for the first time. We can count it as 1 creation of a virtual block.
281                 // Note, that when setting the virtual block number we use the batch number to make a smoother upgrade from batch number to
282                 // the L2 block number.
283                 virtualBlockInfo.number = currentBatchNumber;
284                 // Remembering the batch number on which the upgrade to the virtual blocks has been done.
285                 virtualBlockUpgradeInfo.virtualBlockStartBatch = currentBatchNumber;
286     
287                 require(_maxVirtualBlocksToCreate > 0, "Can't initialize the first virtual block");
288                 _maxVirtualBlocksToCreate -= 1;
289             } else if (_maxVirtualBlocksToCreate == 0) {
290                 // The virtual blocks have been already initialized, but the operator didn't ask to create
291                 // any new virtual blocks. So we can just return.
292                 return;
293             }
294     
295             virtualBlockInfo.number += _maxVirtualBlocksToCreate;
296             virtualBlockInfo.timestamp = _newTimestamp;
297     
298             // The virtual block number must never exceed the L2 block number.
299             // We do not use a `require` here, since the virtual blocks are a temporary solution to let the Solidity's `block.number`
300             // catch up with the L2 block number and so the situation where virtualBlockInfo.number starts getting larger
301             // than _l2BlockNumber is expected once virtual blocks have caught up the L2 blocks.
302             if (virtualBlockInfo.number >= _l2BlockNumber) {
303                 virtualBlockUpgradeInfo.virtualBlockFinishL2Block = _l2BlockNumber;
304                 virtualBlockInfo.number = _l2BlockNumber;
305             }
306     
307             currentVirtualL2BlockInfo = virtualBlockInfo;
308         }


314         function _setNewL2BlockData(uint128 _l2BlockNumber, uint128 _l2BlockTimestamp, bytes32 _prevL2BlockHash) internal {
315             // In the unsafe version we do not check that the block data is correct
316             currentL2BlockInfo = BlockInfo({number: _l2BlockNumber, timestamp: _l2BlockTimestamp});
317     
318             // It is always assumed in production that _l2BlockNumber > 0
319             _setL2BlockHash(_l2BlockNumber - 1, _prevL2BlockHash);
320     
321             // Reseting the rolling hash
322             currentL2BlockTxsRollingHash = bytes32(0);
323         }


341         function setL2Block(
342             uint128 _l2BlockNumber,
343             uint128 _l2BlockTimestamp,
344             bytes32 _expectedPrevL2BlockHash,
345             bool _isFirstInBatch,
346             uint128 _maxVirtualBlocksToCreate
347         ) external onlyCallFromBootloader {
348             // We check that the timestamp of the L2 block is consistent with the timestamp of the batch.
349             if (_isFirstInBatch) {
350                 uint128 currentBatchTimestamp = currentBatchInfo.timestamp;
351                 require(
352                     _l2BlockTimestamp >= currentBatchTimestamp,
353                     "The timestamp of the L2 block must be greater than or equal to the timestamp of the current batch"
354                 );
355                 require(_maxVirtualBlocksToCreate > 0, "There must be a virtual block created at the start of the batch");
356             }
357     
358             (uint128 currentL2BlockNumber, uint128 currentL2BlockTimestamp) = getL2BlockNumberAndTimestamp();
359     
360             if (currentL2BlockNumber == 0 && currentL2BlockTimestamp == 0) {
361                 // Since currentL2BlockNumber and currentL2BlockTimestamp are zero it means that it is
362                 // the first ever batch with L2 blocks, so we need to initialize those.
363                 _upgradeL2Blocks(_l2BlockNumber, _expectedPrevL2BlockHash, _isFirstInBatch);
364     
365                 _setNewL2BlockData(_l2BlockNumber, _l2BlockTimestamp, _expectedPrevL2BlockHash);
366             } else if (currentL2BlockNumber == _l2BlockNumber) {
367                 require(!_isFirstInBatch, "Can not reuse L2 block number from the previous batch");
368                 require(currentL2BlockTimestamp == _l2BlockTimestamp, "The timestamp of the same L2 block must be same");
369                 require(
370                     _expectedPrevL2BlockHash == _getLatest257L2blockHash(_l2BlockNumber - 1),
371                     "The previous hash of the same L2 block must be same"
372                 );
373                 require(_maxVirtualBlocksToCreate == 0, "Can not create virtual blocks in the middle of the miniblock");
374             } else if (currentL2BlockNumber + 1 == _l2BlockNumber) {
375                 // From the checks in _upgradeL2Blocks it is known that currentL2BlockNumber can not be 0
376                 bytes32 prevL2BlockHash = _getLatest257L2blockHash(currentL2BlockNumber - 1);
377     
378                 bytes32 pendingL2BlockHash = _calculateL2BlockHash(
379                     currentL2BlockNumber,
380                     currentL2BlockTimestamp,
381                     prevL2BlockHash,
382                     currentL2BlockTxsRollingHash
383                 );
384     
385                 require(_expectedPrevL2BlockHash == pendingL2BlockHash, "The current L2 block hash is incorrect");
386                 require(
387                     _l2BlockTimestamp > currentL2BlockTimestamp,
388                     "The timestamp of the new L2 block must be greater than the timestamp of the previous L2 block"
389                 );
390     
391                 // Since the new block is created, we'll clear out the rolling hash
392                 _setNewL2BlockData(_l2BlockNumber, _l2BlockTimestamp, _expectedPrevL2BlockHash);
393             } else {
394                 revert("Invalid new L2 block number");
395             }
396     
397             _setVirtualBlock(_l2BlockNumber, _maxVirtualBlocksToCreate, _l2BlockTimestamp);
398         }


444         function setNewBatch(
445             bytes32 _prevBatchHash,
446             uint128 _newTimestamp,
447             uint128 _expectedNewNumber,
448             uint256 _baseFee
449         ) external onlyCallFromBootloader {
450             (uint128 previousBatchNumber, uint128 previousBatchTimestamp) = getBatchNumberAndTimestamp();
451             require(_newTimestamp > previousBatchTimestamp, "Timestamps should be incremental");
452             require(previousBatchNumber + 1 == _expectedNewNumber, "The provided block number is not correct");
453     
454             _ensureBatchConsistentWithL2Block(_newTimestamp);
455     
456             batchHashes[previousBatchNumber] = _prevBatchHash;
457     
458             // Setting new block number and timestamp
459             BlockInfo memory newBlockInfo = BlockInfo({number: previousBatchNumber + 1, timestamp: _newTimestamp});
460     
461             currentBatchInfo = newBlockInfo;
462     
463             baseFee = _baseFee;
464     
465             // The correctness of this block hash:
466             SystemContractHelper.toL1(false, bytes32(uint256(SystemLogKey.PREV_BATCH_HASH_KEY)), _prevBatchHash);
467         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L444:467

</details>


## NC037 - Functions should have Natspec @param annotations:

Documents a parameter just like in Doxygen (must be followed by parameter name)


<details>
<summary>Click to show 285 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


55          constructor(IL1SharedBridge _sharedBridge) reentrancyGuardInitializer {


60          function initialize() external reentrancyGuardInitializer {}


63          function tranferTokenToSharedBridge(address _token, uint256 _amount) external {


75          function l2TokenAddress(address _l1Token) external view returns (address) {


160         function _depositFundsToSharedBridge(address _from, IERC20 _token, uint256 _amount) internal returns (uint256) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L160:160

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


90          constructor(


116         function transferFundsFromLegacy(address _token, address _target, uint256 _targetChainId) external onlyOwner {


137         function receiveEth(uint256 _chainId) external payable {


142         function initializeChainGovernance(uint256 _chainId, address _l2BridgeAddress) external onlyOwner {


148         function bridgehubDepositBaseToken(


173         function _depositFunds(address _from, IERC20 _token, uint256 _amount) internal returns (uint256) {


182         function bridgehubDeposit(


232         function bridgehubConfirmL2Transaction(


243         function _getDepositL2Calldata(


254         function _getERC20Getters(address _token) internal view returns (bytes memory) {


303         function _claimFailedDeposit(


409         function _finalizeWithdrawal(


458         function _checkWithdrawal(


487         function _parseL2WithdrawalMessage(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L487:487

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


38          constructor() reentrancyGuardInitializer {}


41          function initialize(address _owner) external reentrancyGuardInitializer {


51          function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin {


60          function acceptAdmin() external {


75          function getStateTransition(uint256 _chainId) public view returns (address) {


82          function addStateTransitionManager(address _stateTransitionManager) external onlyOwner {


92          function removeStateTransitionManager(address _stateTransitionManager) external onlyOwner {


101         function addToken(address _token) external onlyOwner {


108         function setSharedBridge(address _sharedBridge) external onlyOwner {


114         function createNewChain(


152         function proveL2MessageInclusion(


164         function proveL2LogInclusion(


176         function proveL1ToL2TransactionStatus(


198         function l2TransactionBaseCost(


217         function requestL2TransactionDirect(


262         function requestL2TransactionTwoBridges(


325         function _actualRefundRecipient(address _refundRecipient) internal view returns (address _recipient) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L325:325

```solidity
File: contracts/ethereum/contracts/common/ReentrancyGuard.sol


46          function _initializeReentrancyGuard() private {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L46:46

```solidity
File: contracts/ethereum/contracts/common/libraries/UncheckedMath.sol


11          function uncheckedInc(uint256 _number) internal pure returns (uint256) {


17          function uncheckedAdd(uint256 _lhs, uint256 _rhs) internal pure returns (uint256) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UncheckedMath.sol#L17:17

```solidity
File: contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol


19          function readUint32(bytes memory _bytes, uint256 _start) internal pure returns (uint32 result, uint256 offset) {


26          function readAddress(bytes memory _bytes, uint256 _start) internal pure returns (address result, uint256 offset) {


33          function readUint256(bytes memory _bytes, uint256 _start) internal pure returns (uint256 result, uint256 offset) {


40          function readBytes32(bytes memory _bytes, uint256 _start) internal pure returns (bytes32 result, uint256 offset) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L40:40

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


84          function isOperation(bytes32 _id) public view returns (bool) {


89          function isOperationPending(bytes32 _id) public view returns (bool) {


95          function isOperationReady(bytes32 _id) public view returns (bool) {


100         function isOperationDone(bytes32 _id) public view returns (bool) {


105         function getOperationState(bytes32 _id) public view returns (OperationState) {


262         receive() external payable {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L262:262

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


58          constructor(address _bridgehub) reentrancyGuardInitializer {


74          function getChainAdmin(uint256 _chainId) external view override returns (address) {


79          function initialize(


110         function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin {


119         function acceptAdmin() external {


132         function setValidatorTimelock(address _validatorTimelock) external onlyOwnerOrAdmin {


137         function setInitialCutHash(Diamond.DiamondCutData calldata _diamondCut) external onlyOwner {


142         function setNewVersionUpgrade(


152         function setUpgradeDiamondCut(


160         function freezeChain(uint256 _chainId) external onlyOwner {


165         function unfreezeChain(uint256 _chainId) external onlyOwner {


170         function revertBatches(uint256 _chainId, uint256 _newLastBatch) external onlyOwnerOrAdmin {


177         function _setChainIdUpgrade(uint256 _chainId, address _chainContract) internal {


230         function registerAlreadyDeployedStateTransition(


239         function createNewChain(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L239:239

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


55          constructor(address _initialOwner, uint32 _executionDelay) {


73          function setStateTransitionManager(IStateTransitionManager _stateTransitionManager) external onlyOwner {


78          function addValidator(uint256 _chainId, address _newValidator) external onlyChainAdmin(_chainId) {


87          function removeValidator(uint256 _chainId, address _validator) external onlyChainAdmin(_chainId) {


96          function setExecutionDelay(uint32 _executionDelay) external onlyOwner {


102         function getCommittedBatchTimestamp(uint256 _chainId, uint256 _l2BatchNumber) external view returns (uint256) {


108         function commitBatches(


126         function commitBatchesSharedBridge(


146         function revertBatches(uint256) external onlyValidator(ERA_CHAIN_ID) {


153         function revertBatchesSharedBridge(uint256 _chainId, uint256) external onlyValidator(_chainId) {


160         function proveBatches(


171         function proveBatchesSharedBridge(


182         function executeBatches(StoredBatchInfo[] calldata _newBatchesData) external onlyValidator(ERA_CHAIN_ID) {


203         function executeBatchesSharedBridge(


225         function _propagateToZkSyncStateTransition(uint256 _chainId) internal {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L225:225

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


19          constructor() reentrancyGuardInitializer {}


24          function initialize(InitializeData calldata _initializeData) external reentrancyGuardInitializer returns (bytes32) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L24:24

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol


11          constructor(uint256 _chainId, Diamond.DiamondCutData memory _diamondCut) {


20          fallback() external payable {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


23          function setPendingAdmin(address _newPendingAdmin) external onlyAdmin {


32          function acceptAdmin() external {


45          function setValidator(address _validator, bool _active) external onlyStateTransitionManager {


51          function setPorterAvailability(bool _zkPorterIsAvailable) external onlyStateTransitionManager {


58          function setPriorityTxMaxGasLimit(uint256 _newPriorityTxMaxGasLimit) external onlyStateTransitionManager {


67          function changeFeeParams(FeeParams calldata _newFeeParams) external onlyAdminOrStateTransitionManager {


79          function setTokenMultiplier(uint128 _nominator, uint128 _denominator) external onlyAdminOrStateTransitionManager {


89          function setValidiumMode(PubdataPricingMode _validiumMode) external onlyAdmin {


100         function upgradeChainFromVersion(


123         function executeUpgrade(Diamond.DiamondCutData calldata _diamondCut) external onlyStateTransitionManager {


133         function freezeDiamond() external onlyAdminOrStateTransitionManager {


143         function unfreezeDiamond() external onlyAdminOrStateTransitionManager {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L143:143

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


32          function _commitOneBatch(


130         function _processL2Logs(


199         function commitBatches(


207         function commitBatchesSharedBridge(


215         function _commitBatches(


308         function _collectOperationsFromPriorityQueue(uint256 _nPriorityOps) internal returns (bytes32 concatHash) {


321         function _executeOneBatch(StoredBatchInfo memory _storedBatch, uint256 _executedBatchIdx) internal {


337         function executeBatchesSharedBridge(


345         function executeBatches(StoredBatchInfo[] calldata _batchesData) external nonReentrant onlyValidator {


349         function _executeBatches(StoredBatchInfo[] calldata _batchesData) internal {


368         function proveBatches(


377         function proveBatchesSharedBridge(


386         function _proveBatches(


440         function _verifyProof(uint256[] memory proofPublicInput, ProofInput calldata _proof) internal view {


453         function _getBatchProofPublicInput(


472         function revertBatches(uint256 _newLastBatch) external nonReentrant onlyValidatorOrStateTransitionManager {


477         function revertBatchesSharedBridge(uint256, uint256 _newLastBatch) external nonReentrant onlyValidator {


481         function _revertBatches(uint256 _newLastBatch) internal {


500         function _createBatchCommitment(


515         function _batchPassThroughData(CommitBatchInfo calldata _batch) internal pure returns (bytes memory) {


525         function _batchMetaParameters() internal view returns (bytes memory) {


537         function _batchAuxiliaryOutput(


587         function _hashStoredBatchInfo(StoredBatchInfo memory _storedBatchInfo) internal pure returns (bytes32) {


592         function _checkBit(uint256 _bitMap, uint8 _index) internal pure returns (bool) {


597         function _setBit(uint256 _bitMap, uint8 _index) internal pure returns (uint256) {


605         function _pointEvaluationPrecompile(


625         function _verifyBlobInformation(


679         function _getBlobVersionedHash(uint256 _index) internal view returns (bytes32 versionedHash) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L679:679

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


32          function getVerifier() external view returns (address) {


37          function getAdmin() external view returns (address) {


42          function getPendingAdmin() external view returns (address) {


47          function getBridgehub() external view returns (address) {


52          function getStateTransitionManager() external view returns (address) {


57          function getBaseToken() external view returns (address) {


62          function getBaseTokenBridge() external view returns (address) {


67          function baseTokenGasPriceMultiplierNominator() external view returns (uint128) {


72          function baseTokenGasPriceMultiplierDenominator() external view returns (uint128) {


77          function getTotalBatchesCommitted() external view returns (uint256) {


82          function getTotalBatchesVerified() external view returns (uint256) {


87          function getTotalBatchesExecuted() external view returns (uint256) {


92          function getTotalPriorityTxs() external view returns (uint256) {


97          function getFirstUnprocessedPriorityTx() external view returns (uint256) {


102         function getPriorityQueueSize() external view returns (uint256) {


107         function priorityQueueFrontOperation() external view returns (PriorityOperation memory) {


112         function isValidator(address _address) external view returns (bool) {


117         function l2LogsRootHash(uint256 _batchNumber) external view returns (bytes32) {


122         function storedBatchHash(uint256 _batchNumber) external view returns (bytes32) {


127         function getL2BootloaderBytecodeHash() external view returns (bytes32) {


132         function getL2DefaultAccountBytecodeHash() external view returns (bytes32) {


137         function getVerifierParams() external view returns (VerifierParams memory) {


142         function getProtocolVersion() external view returns (uint256) {


147         function getL2SystemContractsUpgradeTxHash() external view returns (bytes32) {


152         function getL2SystemContractsUpgradeBatchNumber() external view returns (uint256) {


157         function isDiamondStorageFrozen() external view returns (bool) {


163         function isFacetFreezable(address _facet) external view returns (bool isFreezable) {


176         function getPriorityTxMaxGasLimit() external view returns (uint256) {


181         function isFunctionFreezable(bytes4 _selector) external view returns (bool) {


188         function isEthWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool) {


193         function getPubdataPricingMode() external view returns (PubdataPricingMode) {


202         function facets() external view returns (Facet[] memory result) {


217         function facetFunctionSelectors(address _facet) external view returns (bytes4[] memory) {


223         function facetAddresses() external view returns (address[] memory) {


229         function facetAddress(bytes4 _selector) external view returns (address) {


239         function getTotalBlocksCommitted() external view returns (uint256) {


244         function getTotalBlocksVerified() external view returns (uint256) {


249         function getTotalBlocksExecuted() external view returns (uint256) {


254         function storedBlockHash(uint256 _batchNumber) external view returns (bytes32) {


259         function getL2SystemContractsUpgradeBlockNumber() external view returns (uint256) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L259:259

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


38          function transferEthToSharedBridge() external onlyBaseTokenBridge {


47          function bridgehubRequestL2Transaction(


54          function proveL2MessageInclusion(


64          function proveL2LogInclusion(


74          function proveL1ToL2TransactionStatus(


104         function _proveL2LogInclusion(


130         function _L2MessageToLog(L2Message memory _message) internal pure returns (L2Log memory) {


143         function l2TransactionBaseCost(


178         function finalizeEthWithdrawal(


197         function requestL2Transaction(


228         function _requestL2TransactionSender(


258         function _requestL2Transaction(


289         function _serializeL2Transaction(


316         function _writePriorityOp(


353         function _hashFactoryDeps(bytes[] memory _factoryDeps) internal pure returns (uint256[] memory hashedFactoryDeps) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L353:353

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


87          function getDiamondStorage() internal pure returns (DiamondStorage storage diamondStorage) {


126         function _addFunctions(address _facet, bytes4[] memory _selectors, bool _isFacetFreezable) private {


149         function _replaceFunctions(address _facet, bytes4[] memory _selectors, bool _isFacetFreezable) private {


172         function _removeFunctions(address _facet, bytes4[] memory _selectors) private {


189         function _saveFacetIfNew(address _facet) private {


205         function _addOneFunction(address _facet, bytes4 _selector, bool _isSelectorFreezable) private {


228         function _removeOneFunction(address _facet, bytes4 _selector) private {


257         function _removeFacet(address _facet) private {


278         function _initializeDiamondCut(address _init, bytes memory _calldata) private {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L278:278

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol


40          function _efficientHash(bytes32 _lhs, bytes32 _rhs) private pure returns (bytes32 result) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L40:40

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol


35          function getFirstUnprocessedPriorityTx(Queue storage _queue) internal view returns (uint256) {


40          function getTotalPriorityTxs(Queue storage _queue) internal view returns (uint256) {


45          function getSize(Queue storage _queue) internal view returns (uint256) {


50          function isEmpty(Queue storage _queue) internal view returns (bool) {


55          function pushBack(Queue storage _queue, PriorityOperation memory _operation) internal {


64          function front(Queue storage _queue) internal view returns (PriorityOperation memory) {


72          function popFront(Queue storage _queue) internal returns (PriorityOperation memory priorityOperation) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L72:72

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


27          function safeCastToU32(uint256 _x) internal pure returns (uint32) {


37          function systemCall(uint32 gasLimit, address to, uint256 value, bytes memory data) internal returns (bool success) {


76          function systemCallWithReturndata(


95          function getFarCallABI(


121         function getFarCallABIWithEmptyFatPointer(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L121:121

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


41          constructor() {


109         function _deployL2Token(address _l1Token, bytes calldata _data) internal returns (address) {


138         function _getL1WithdrawMessage(


149         function l2TokenAddress(address _l1Token) public view override returns (address) {


157         function _getCreate2Salt(address _l1Token) internal pure returns (bytes32 salt) {


164         function _deployBeaconProxy(bytes32 salt) internal returns (BeaconProxy proxy) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L164:164

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


40          constructor() {


159         function name() public view override returns (string memory) {


165         function symbol() public view override returns (string memory) {


171         function decimals() public view override returns (uint8) {


178         function decodeString(bytes memory _input) external pure returns (string memory result) {


183         function decodeUint8(bytes memory _input) external pure returns (uint8 result) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L183:183

```solidity
File: system-contracts/contracts/ContractDeployer.sol


34          function getAccountInfo(address _address) external view returns (AccountInfo memory info) {


40          function extendedAccountVersion(address _address) public view returns (AccountAbstractionVersion) {


58          function _storeAccountInfo(address _address, AccountInfo memory _newInfo) internal {


238         function forceDeployOnAddresses(ForceDeployment[] calldata _deployments) external payable {


258         function _nonSystemDeployOnAddress(


301         function _ensureBytecodeIsKnown(bytes32 _bytecodeHash) internal view {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L301:301

```solidity
File: system-contracts/contracts/DefaultAccount.sol


220         fallback() external payable ignoreInDelegateCall {


227         receive() external payable {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L227:227

```solidity
File: system-contracts/contracts/EmptyContract.sol


11          fallback() external payable {}


13          receive() external payable {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L13:13

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


65          function getMarker(bytes32 _hash) public view override returns (uint256 marker) {


74          function _validateBytecode(bytes32 _bytecodeHash) internal pure {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L74:74

```solidity
File: system-contracts/contracts/L1Messenger.sol


50          function keccakGasCost(uint256 _length) internal pure returns (uint256) {


61          function sha256GasCost(uint256 _length) internal pure returns (uint256) {


94          function _processL2ToL1Log(L2ToL1Log memory _l2ToL1Log) internal returns (uint256 logIdInMerkleTree) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L94:94

```solidity
File: system-contracts/contracts/L2BaseToken.sol


99          function _burnMsgValue() internal returns (uint256 amount) {


112         function _getL1WithdrawMessage(address _to, uint256 _amount) internal pure returns (bytes memory) {


117         function _getExtendedWithdrawMessage(


128         function name() external pure override returns (string memory) {


134         function symbol() external pure override returns (string memory) {


140         function decimals() external pure override returns (uint8) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L140:140

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


25          function _getAbiParams() internal view returns (uint256 value, bool isSystemCall, address to) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L25:25

```solidity
File: system-contracts/contracts/SystemContext.sol


112         function setPubdataInfo(uint256 _gasPerPubdataByte, uint256 _basePubdataSpent) external onlyCallFromBootloader {


117         function getCurrentPubdataSpent() public view returns (uint256) {


122         function getCurrentPubdataCost() external view returns (uint256) {


132         function getBlockHashEVM(uint256 _block) external view returns (bytes32 hash) {


172         function getBatchNumberAndTimestamp() public view returns (uint128 batchNumber, uint128 batchTimestamp) {


180         function getL2BlockNumberAndTimestamp() public view returns (uint128 blockNumber, uint128 blockTimestamp) {


190         function getBlockNumber() public view returns (uint128) {


198         function getBlockTimestamp() public view returns (uint128) {


408         function publishTimestampDataToL1() external onlyCallFromBootloader {


471         function unsafeOverrideBatch(


482         function incrementTxNumberInBatch() external onlyCallFromBootloader {


486         function resetTxNumberInBatch() external onlyCallFromBootloader {


496         function currentBlockInfo() external view returns (uint256 blockInfo) {


503         function getBlockNumberAndTimestamp() external view returns (uint256 blockNumber, uint256 blockTimestamp) {


509         function blockHash(uint256 _blockNumber) external view returns (bytes32 hash) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L509:509

```solidity
File: system-contracts/contracts/libraries/EfficientCall.sol


232         function propagateRevert() internal pure {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L232:232

```solidity
File: system-contracts/contracts/libraries/RLPEncoder.sol


11          function encodeAddress(address _val) internal pure returns (bytes memory encoded) {


24          function encodeUint256(uint256 _val) internal pure returns (bytes memory encoded) {


60          function _encodeLength(uint64 _len, uint256 _offset) private pure returns (bytes memory encoded) {


84          function _highestByteSet(uint256 _number) private pure returns (uint256 hbs) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L84:84

```solidity
File: system-contracts/contracts/libraries/SystemContractHelper.sol


63          function getCodeAddress() internal view returns (address addr) {


74          function loadCalldataIntoActivePtr() internal view {


85          function ptrPackIntoActivePtr(uint256 _farCallAbi) internal view {


94          function ptrAddIntoActive(uint32 _value) internal view {


106         function ptrShrinkIntoActive(uint32 _shrink) internal view {


203         function getZkSyncMetaBytes() internal view returns (uint256 meta) {


279         function getZkSyncMeta() internal view returns (ZkSyncMeta memory meta) {


296         function getCallFlags() internal view returns (uint256 callFlags) {


307         function getCalldataPtr() internal view returns (uint256 ptr) {


318         function getExtraAbiData(uint256 index) internal view returns (uint256 extraAbiData) {


329         function isSystemCall() internal view returns (bool) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L329:329

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


100         function encodeHash(Transaction calldata _transaction) internal view returns (bytes32 resultHash) {


118         function _encodeHashEIP712Transaction(Transaction calldata _transaction) private view returns (bytes32) {


147         function _encodeHashLegacyTransaction(Transaction calldata _transaction) private view returns (bytes32) {


219         function _encodeHashEIP2930Transaction(Transaction calldata _transaction) private view returns (bytes32) {


289         function _encodeHashEIP1559Transaction(Transaction calldata _transaction) private view returns (bytes32) {


362         function processPaymasterInput(Transaction calldata _transaction) internal {


395         function payToTheBootloader(Transaction calldata _transaction) internal returns (bool success) {


405         function totalRequiredBalance(Transaction calldata _transaction) internal pure returns (uint256 requiredBalance) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L405:405

```solidity
File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol


19          function readUint16(bytes calldata _bytes, uint256 _start) internal pure returns (uint16 result) {


26          function readUint32(bytes calldata _bytes, uint256 _start) internal pure returns (uint32 result) {


33          function readUint64(bytes calldata _bytes, uint256 _start) internal pure returns (uint64 result) {


40          function readBytes32(bytes calldata _bytes, uint256 _start) internal pure returns (bytes32 result) {


46          function readUint256(bytes calldata _bytes, uint256 _start) internal pure returns (uint256 result) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L46:46

```solidity
File: system-contracts/contracts/libraries/Utils.sol


20          function safeCastToU128(uint256 _x) internal pure returns (uint128) {


26          function safeCastToU32(uint256 _x) internal pure returns (uint32) {


32          function safeCastToU24(uint256 _x) internal pure returns (uint24) {


39          function bytecodeLenInBytes(bytes32 _bytecodeHash) internal pure returns (uint256 codeLength) {


44          function bytecodeLenInWords(bytes32 _bytecodeHash) internal pure returns (uint256 codeLengthInWords) {


51          function isContractConstructed(bytes32 _bytecodeHash) internal pure returns (bool) {


56          function isContractConstructing(bytes32 _bytecodeHash) internal pure returns (bool) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L56:56

</details>



## NC038 - Consider using `block.number` instead of `block.timestamp`:

`block.timestamp` is vulnerable to miner manipulation and creates a potential front-running vulnerability. Consider using `block.number` instead.


<details>
<summary>Click to show 11 findings</summary>

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


111             } else if (timestamp > block.timestamp) {


219             timestamps[_id] = block.timestamp + _delay;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L219:219

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


115                 uint32 timestamp = uint32(block.timestamp);


134                 uint32 timestamp = uint32(block.timestamp);


195                     require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed


217                     require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L217:217

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


122             require(block.timestamp - COMMIT_TIMESTAMP_NOT_OLDER <= batchTimestamp, "h1"); // New batch timestamp is too small


123             require(lastL2BlockTimestamp <= block.timestamp + COMMIT_TIMESTAMP_APPROXIMATION_DELTA, "h2"); // The last L2 block timestamp is too big


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L123:123

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


283             _params.expirationTimestamp = uint64(block.timestamp + PRIORITY_EXPIRATION); // Safe to cast


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L283:283

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


72              require(block.timestamp >= _proposedUpgrade.upgradeTimestamp, "Upgrade is not ready yet");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L72:72

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol


52              require(block.timestamp >= _proposedUpgrade.upgradeTimestamp, "Upgrade is not ready yet");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L52:52

</details>

## NC039 - Consider bounding input array length:

The functions below take in an unbounded array, and make function calls for entries in the array. While the function will revert if it eventually runs out of gas, it may be a nicer user experience to `require()` that the length of the array is below some reasonable maximum, so that the user doesn't have to use up a full transaction's gas only to see that the transaction reverts.


<details>
<summary>Click to show 16 findings</summary>

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


225             for (uint256 i = 0; i < _calls.length; ++i) {
226                 (bool success, bytes memory returnData) = _calls[i].target.call{value: _calls[i].value}(_calls[i].data);
227                 if (!success) {
228                     // Propagate an error if the call fails.
229                     assembly {
230                         revert(add(returnData, 0x20), mload(returnData))
231                     }
232                 }
233             }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L225:233

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


116                 for (uint256 i = 0; i < _newBatchesData.length; ++i) {
117                     committedBatchTimestamp[ERA_CHAIN_ID].set(_newBatchesData[i].batchNumber, timestamp);
118                 }


135                 for (uint256 i = 0; i < _newBatchesData.length; ++i) {
136                     committedBatchTimestamp[_chainId].set(_newBatchesData[i].batchNumber, timestamp);
137                 }


185                 for (uint256 i = 0; i < _newBatchesData.length; ++i) {
186                     uint256 commitBatchTimestamp = committedBatchTimestamp[ERA_CHAIN_ID].get(
187                         _newBatchesData[i].batchNumber
188                     );
189     
190                     // Note: if the `commitBatchTimestamp` is zero, that means either:
191                     // * The batch was committed, but not through this contract.
192                     // * The batch wasn't committed at all, so execution will fail in the zkSync contract.
193                     // We allow executing such batches.
194     
195                     require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed
196                 }


209                 for (uint256 i = 0; i < _newBatchesData.length; ++i) {
210                     uint256 commitBatchTimestamp = committedBatchTimestamp[_chainId].get(_newBatchesData[i].batchNumber);
211     
212                     // Note: if the `commitBatchTimestamp` is zero, that means either:
213                     // * The batch was committed, but not through this contract.
214                     // * The batch wasn't committed at all, so execution will fail in the zkSync contract.
215                     // We allow executing such batches.
216     
217                     require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed
218                 }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L209:218

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


257             for (uint256 i = 0; i < _newBatchesData.length; i = i.uncheckedInc()) {
258                 _lastCommittedBatchData = _commitOneBatch(_lastCommittedBatchData, _newBatchesData[i], bytes32(0));
259     
260                 s.storedBatchHashes[_lastCommittedBatchData.batchNumber] = _hashStoredBatchInfo(_lastCommittedBatchData);
261                 emit BlockCommit(
262                     _lastCommittedBatchData.batchNumber,
263                     _lastCommittedBatchData.batchHash,
264                     _lastCommittedBatchData.commitment
265                 );
266             }


289             for (uint256 i = 0; i < _newBatchesData.length; i = i.uncheckedInc()) {
290                 // The upgrade transaction must only be included in the first batch.
291                 bytes32 expectedUpgradeTxHash = i == 0 ? _systemContractUpgradeTxHash : bytes32(0);
292                 _lastCommittedBatchData = _commitOneBatch(
293                     _lastCommittedBatchData,
294                     _newBatchesData[i],
295                     expectedUpgradeTxHash
296                 );
297     
298                 s.storedBatchHashes[_lastCommittedBatchData.batchNumber] = _hashStoredBatchInfo(_lastCommittedBatchData);
299                 emit BlockCommit(
300                     _lastCommittedBatchData.batchNumber,
301                     _lastCommittedBatchData.batchHash,
302                     _lastCommittedBatchData.commitment
303                 );
304             }


351             for (uint256 i = 0; i < nBatches; i = i.uncheckedInc()) {
352                 _executeOneBatch(_batchesData[i], i);
353                 emit BlockExecution(_batchesData[i].batchNumber, _batchesData[i].batchHash, _batchesData[i].commitment);
354             }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L351:354

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


356             for (uint256 i = 0; i < factoryDepsLen; i = i.uncheckedInc()) {
357                 bytes32 hashedBytecode = L2ContractHelper.hashL2Bytecode(_factoryDeps[i]);
358     
359                 // Store the resulting hash sequentially in bytes.
360                 assembly {
361                     mstore(add(hashedFactoryDeps, mul(add(i, 1), 32)), hashedBytecode)
362                 }
363             }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L356:363

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


138             for (uint256 i = 0; i < selectorsLength; i = i.uncheckedInc()) {
139                 bytes4 selector = _selectors[i];
140                 SelectorToFacet memory oldFacet = ds.selectorToFacet[selector];
141                 require(oldFacet.facetAddress == address(0), "J"); // facet for this selector already exists
142     
143                 _addOneFunction(_facet, selector, _isFacetFreezable);
144             }


158             for (uint256 i = 0; i < selectorsLength; i = i.uncheckedInc()) {
159                 bytes4 selector = _selectors[i];
160                 SelectorToFacet memory oldFacet = ds.selectorToFacet[selector];
161                 require(oldFacet.facetAddress != address(0), "L"); // it is impossible to replace the facet with zero address
162     
163                 _removeOneFunction(oldFacet.facetAddress, selector);
164                 // Add facet to the list of facets if the facet address is a new one
165                 _saveFacetIfNew(_facet);
166                 _addOneFunction(_facet, selector, _isFacetFreezable);
167             }


178             for (uint256 i = 0; i < selectorsLength; i = i.uncheckedInc()) {
179                 bytes4 selector = _selectors[i];
180                 SelectorToFacet memory oldFacet = ds.selectorToFacet[selector];
181                 require(oldFacet.facetAddress != address(0), "a2"); // Can't delete a non-existent facet
182     
183                 _removeOneFunction(oldFacet.facetAddress, selector);
184             }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L178:184

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol


29              for (uint256 i; i < pathLength; i = i.uncheckedInc()) {
30                  currentHash = (_index % 2 == 0)
31                      ? _efficientHash(currentHash, _path[i])
32                      : _efficientHash(_path[i], currentHash);
33                  _index /= 2;
34              }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L29:34

```solidity
File: system-contracts/contracts/ContractDeployer.sol


253             for (uint256 i = 0; i < deploymentsLength; ++i) {
254                 this.forceDeployOnAddress{value: _deployments[i].value}(_deployments[i], msg.sender);
255             }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L253:255

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


38                  for (uint256 i = 0; i < immutablesLength; ++i) {
39                      uint256 index = _immutables[i].index;
40                      bytes32 value = _immutables[i].value;
41                      immutableDataStorage[uint256(uint160(_dest))][index] = value;
42                  }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L38:42

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


30                  for (uint256 i = 0; i < hashesLen; ++i) {
31                      _markBytecodeAsPublished(_hashes[i], _shouldSendToL1);
32                  }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L30:32

</details>

## NC040 - Large numeric literals should use underscores for readability:

At a glance, it's quite difficult to understand how big this number is. Use underscores to make values more clear.


```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


194                 require(processedLogs == 1023, "b8");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L194:194

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


41          uint256 constant MSG_VALUE_SIMULATOR_STIPEND_GAS = 27000;


36          uint256 constant GAS_TO_PASS = 2300;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L36:36

## NC041 - Cast to `bytes` or `bytes32` for clearer semantic meaning:

Using a [cast](https://ethereum.stackexchange.com/questions/30912/how-to-compare-strings-in-solidity#answer-82739) on a single argument, rather than `abi.encodePacked()` makes the intended operation more clear, leading to less reviewer confusion.


```solidity
File: system-contracts/contracts/SystemContext.sol


234             return keccak256(abi.encodePacked(uint32(_blockNumber)));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L234:234

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


133                     keccak256(abi.encodePacked(_transaction.factoryDeps)),


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L133:133

## NC042 - Variables should be named in mixedCase style:

As the [Solidity Style Guide](https://docs.soliditylang.org/en/latest/style-guide.html#naming-styles) suggests: arguments, local variables and mutable state variables should be named in mixedCase style.


<details>
<summary>Click to show 13 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


45          mapping(address => uint256) private __DEPRECATED_lastWithdrawalLimitReset;


51          mapping(address => mapping(address => uint256)) private __DEPRECATED_totalDepositedAmountPerUser;


48          mapping(address => uint256) private __DEPRECATED_withdrawnAmountInWindow;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L48:48

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol


68          uint256[7] __DEPRECATED_diamondCutStorage;


72          address __DEPRECATED_pendingGovernor;


70          address __DEPRECATED_governor;


116         uint256 __DEPRECATED_lastWithdrawalLimitReset;


109         UpgradeStorage __DEPRECATED_upgrades;


92          address __DEPRECATED_allowList;


118         uint256 __DEPRECATED_withdrawnAmountInWindow;


120         mapping(address => uint256) __DEPRECATED_totalDepositedAmountPerUser;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol#L120:120

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


31          uint8 private decimals_;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L31:31

```solidity
File: system-contracts/contracts/interfaces/IContractDeployer.sol


29              AccountAbstractionVersion supportedAAVersion;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L29:29

</details>

## NC043 - Consider using named mappings:

Consider moving to solidity version 0.8.18 or later, and using [named mappings](https://ethereum.stackexchange.com/a/145555) to make it easier to understand the purpose of each mapping.


<details>
<summary>Click to show 14 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


45          mapping(address => uint256) private __DEPRECATED_lastWithdrawalLimitReset;


48          mapping(address => uint256) private __DEPRECATED_withdrawnAmountInWindow;


51          mapping(address => mapping(address => uint256)) private __DEPRECATED_totalDepositedAmountPerUser;


51          mapping(address => mapping(address => uint256)) private __DEPRECATED_totalDepositedAmountPerUser;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L51:51

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


21          mapping(address _stateTransitionManager => bool) public stateTransitionManagerIsRegistered;


23          mapping(address _token => bool) public tokenIsRegistered;


26          mapping(uint256 _chainId => address) public stateTransitionManager;


29          mapping(uint256 _chainId => address) public baseToken;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L29:29

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


30          mapping(uint256 => address) public stateTransition;


48          mapping(uint256 => bytes32) public upgradeCutHash;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L48:48

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


50          mapping(uint256 _chainId => mapping(address _validator => bool)) public validators;


50          mapping(uint256 _chainId => mapping(address _validator => bool)) public validators;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L50:50

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol


120         mapping(address => uint256) __DEPRECATED_totalDepositedAmountPerUser;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol#L120:120

```solidity
File: system-contracts/contracts/ContractDeployer.sol


26          mapping(address => AccountInfo) internal accountInfo;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L26:26

</details>

## NC044 - Use allowlist/denylist rather than whitelist/blacklist:

Use alternative variants, e.g. allowlist/denylist instead of whitelist/blacklist.


<details>
<summary>Click to show 66 findings</summary>

```solidity
File: contracts/ethereum/contracts/common/Messaging.sol


86      /// @param paymaster The address of the EIP-4337 paymaster, that will pay fees for the


96      /// @param paymasterInput The arbitrary-length data that is used as a calldata to the paymaster pre-call


106         uint256 paymaster;


121         bytes paymasterInput;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/Messaging.sol#L121:121

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


190                 paymaster: uint256(0),


198                 paymasterInput: new bytes(0),


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L198:198

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


302                 paymaster: uint256(0),


310                 paymasterInput: new bytes(0),


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L310:310

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol


50              require(_transaction.paymaster == 0, "uc");


59              require(_transaction.paymasterInput.length == 0, "ul1");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L59:59

```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


135         // The transaction's paymaster. If there is no paymaster, it is equal to 0.


136         uint256 paymaster;


158         // The input to the paymaster.


159         bytes paymasterInput;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L159:159

```solidity
File: contracts/zksync/contracts/interfaces/IPaymaster.sol


12      bytes4 constant PAYMASTER_VALIDATION_SUCCESS_MAGIC = IPaymaster.validateAndPayForPaymasterTransaction.selector;


14      interface IPaymaster {


15          /// @dev Called by the bootloader to verify that the paymaster agrees to pay for the


21          /// @return magic The value that should be equal to the signature of the validateAndPayForPaymasterTransaction


22          /// if the paymaster agrees to pay for the transaction.


28          function validateAndPayForPaymasterTransaction(


37          /// @param _context, the context of the execution, returned by the "validateAndPayForPaymasterTransaction" method.


40          /// @param _maxRefundedGas, the upper bound on the amout of gas that could be refunded to the paymaster.


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymaster.sol#L40:40

```solidity
File: contracts/zksync/contracts/interfaces/IPaymasterFlow.sol


9        * different types of paymaster flows.


13      interface IPaymasterFlow {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymasterFlow.sol#L13:13

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


231             // https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1559.md


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L231:231

```solidity
File: system-contracts/contracts/DefaultAccount.sol


206         /// paid for by a paymaster.


212         function prepareForPaymaster(


217             _transaction.processPaymasterInput();


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L217:217

```solidity
File: system-contracts/contracts/interfaces/IAccount.sol


42          function prepareForPaymaster(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccount.sol#L42:42

```solidity
File: system-contracts/contracts/interfaces/IPaymaster.sol


12      bytes4 constant PAYMASTER_VALIDATION_SUCCESS_MAGIC = IPaymaster.validateAndPayForPaymasterTransaction.selector;


14      interface IPaymaster {


15          /// @dev Called by the bootloader to verify that the paymaster agrees to pay for the


21          /// @return magic The value that should be equal to the signature of the validateAndPayForPaymasterTransaction


22          /// if the paymaster agrees to pay for the transaction.


28          function validateAndPayForPaymasterTransaction(


37          /// @param _context, the context of the execution, returned by the "validateAndPayForPaymasterTransaction" method.


40          /// @param _maxRefundedGas, the upper bound on the amout of gas that could be refunded to the paymaster.


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L40:40

```solidity
File: system-contracts/contracts/interfaces/IPaymasterFlow.sol


8        * different types of paymaster flows.


12      interface IPaymasterFlow {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymasterFlow.sol#L12:12

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


8       import "../interfaces/IPaymasterFlow.sol";


43          // The transaction's paymaster. If there is no paymaster, it is equal to 0.


44          uint256 paymaster;


66          // The input to the paymaster.


67          bytes paymasterInput;


86                  "Transaction(uint256 txType,uint256 from,uint256 to,uint256 gasLimit,uint256 gasPerPubdataByteLimit,uint256 maxFeePerGas,uint256 maxPriorityFeePerGas,uint256 paymaster,uint256 nonce,uint256 value,bytes data,bytes32[] factoryDeps,bytes paymasterInput)"


129                     _transaction.paymaster,


134                     EfficientCall.keccak(_transaction.paymasterInput)


359         /// @notice Processes the common paymaster flows, e.g. setting proper allowance


361         /// the "Paymaster flows" section in the documentation.


362         function processPaymasterInput(Transaction calldata _transaction) internal {


363             require(_transaction.paymasterInput.length >= 4, "The standard paymaster input must be at least 4 bytes long");


365             bytes4 paymasterInputSelector = bytes4(_transaction.paymasterInput[0:4]);


366             if (paymasterInputSelector == IPaymasterFlow.approvalBased.selector) {


368                     _transaction.paymasterInput.length >= 68,


369                     "The approvalBased paymaster input must be at least 68 bytes long"


373                 // the data is needed only for the paymaster, so we ignore it here for the sake of optimization


374                 (address token, uint256 minAllowance) = abi.decode(_transaction.paymasterInput[4:68], (address, uint256));


375                 address paymaster = address(uint160(_transaction.paymaster));


377                 uint256 currentAllowance = IERC20(token).allowance(address(this), paymaster);


382                     IERC20(token).safeApprove(paymaster, 0);


383                     IERC20(token).safeApprove(paymaster, minAllowance);


385             } else if (paymasterInputSelector == IPaymasterFlow.general.selector) {


386                 // Do nothing. general(bytes) paymaster flow means that the paymaster must interpret these bytes on his own.


388                 revert("Unsupported paymaster flow");


406             if (address(uint160(_transaction.paymaster)) != address(0)) {


407                 // Paymaster pays for the fee


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L407:407

</details>

## NC045 - Contracts containing only utility functions should be made into libraries:




```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol


11      contract ZkSyncStateTransitionBase is ReentrancyGuard {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L11:11

```solidity
File: system-contracts/contracts/interfaces/ISystemContract.sol


17      abstract contract ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L17:17

## NC046 - Function names should use lowerCamelCase:

According to the Solidity [style guide](https://docs.soliditylang.org/en/latest/style-guide.html#function-names) function names should be in `mixedCase` (lowerCamelCase).


<details>
<summary>Click to show 13 findings</summary>

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


130         function _L2MessageToLog(L2Message memory _message) internal pure returns (L2Log memory) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L130:130

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


95          function getFarCallABI(


121         function getFarCallABIWithEmptyFatPointer(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L121:121

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


139         function encodeEIP2930TransactionHash(Transaction calldata _transaction) internal view returns (bytes32) {


229         function encodeEIP1559TransactionHash(Transaction calldata _transaction) internal view returns (bytes32) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L229:229

```solidity
File: system-contracts/contracts/SystemContext.sol


132         function getBlockHashEVM(uint256 _block) external view returns (bytes32 hash) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L132:132

```solidity
File: system-contracts/contracts/interfaces/ISystemContext.sol


46          function getBlockHashEVM(uint256 _block) external view returns (bytes32);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L46:46

```solidity
File: system-contracts/contracts/libraries/EfficientCall.sol


245         function _loadFarCallABIIntoActivePtr(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L245:245

```solidity
File: system-contracts/contracts/libraries/SystemContractsCaller.sol


214         function getFarCallABI(


250         function getFarCallABIWithEmptyFatPointer(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L250:250

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


118         function _encodeHashEIP712Transaction(Transaction calldata _transaction) private view returns (bytes32) {


219         function _encodeHashEIP2930Transaction(Transaction calldata _transaction) private view returns (bytes32) {


289         function _encodeHashEIP1559Transaction(Transaction calldata _transaction) private view returns (bytes32) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L289:289

</details>

## NC047 - Consider adding a deny-list:

Doing so will significantly increase centralization, but will help to prevent hackers from using stolen tokens.


<details>
<summary>Click to show 33 findings</summary>

```solidity
File: contracts/GasBoundCaller.sol


15      contract GasBoundCaller {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L15:15

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


19      contract L1ERC20Bridge is IL1ERC20Bridge, ReentrancyGuard {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L19:19

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


30      contract L1SharedBridge is IL1SharedBridge, ReentrancyGuard, Initializable, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L30:30

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


16      contract Bridgehub is IBridgehub, ReentrancyGuard, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L16:16

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


20      contract Governance is IGovernance, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


25      contract StateTransitionManager is IStateTransitionManager, ReentrancyGuard, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L25:25

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


22      contract ValidatorTimelock is IExecutor, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L22:22

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


17      contract DiamondInit is ZkSyncStateTransitionBase, IDiamondInit {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L17:17

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol


10      contract DiamondProxy {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L10:10

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


18      contract AdminFacet is ZkSyncStateTransitionBase, IAdmin {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L18:18

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


22      contract ExecutorFacet is ZkSyncStateTransitionBase, IExecutor {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L22:22

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


20      contract GettersFacet is ZkSyncStateTransitionBase, IGetters, ILegacyGetters {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


30      contract MailboxFacet is ZkSyncStateTransitionBase, IMailbox {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L30:30

```solidity
File: contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol


10      contract DefaultUpgrade is BaseZkSyncUpgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol#L10:10

```solidity
File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol


11      contract GenesisUpgrade is BaseZkSyncUpgradeGenesis {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L11:11

```solidity
File: contracts/zksync/contracts/ForceDeployUpgrader.sol


10      contract ForceDeployUpgrader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/ForceDeployUpgrader.sol#L10:10

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


23      contract L2SharedBridge is IL2SharedBridge, Initializable {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L23:23

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


15      contract L2StandardERC20 is ERC20PermitUpgradeable, IL2StandardToken, ERC1967Upgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L15:15

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


22      contract AccountCodeStorage is IAccountCodeStorage {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L22:22

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


16      contract BootloaderUtilities is IBootloaderUtilities {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L16:16

```solidity
File: system-contracts/contracts/ComplexUpgrader.sol


14      contract ComplexUpgrader is IComplexUpgrader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L14:14

```solidity
File: system-contracts/contracts/Compressor.sol


22      contract Compressor is ICompressor, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L22:22

```solidity
File: system-contracts/contracts/ContractDeployer.sol


23      contract ContractDeployer is IContractDeployer, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L23:23

```solidity
File: system-contracts/contracts/DefaultAccount.sol


19      contract DefaultAccount is IAccount {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L19:19

```solidity
File: system-contracts/contracts/EmptyContract.sol


10      contract EmptyContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L10:10

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


18      contract ImmutableSimulator is IImmutableSimulator {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L18:18

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


18      contract KnownCodesStorage is IKnownCodesStorage, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L18:18

```solidity
File: system-contracts/contracts/L1Messenger.sol


25      contract L1Messenger is IL1Messenger, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L25:25

```solidity
File: system-contracts/contracts/L2BaseToken.sol


18      contract L2BaseToken is IBaseToken, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L18:18

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


19      contract MsgValueSimulator is ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L19:19

```solidity
File: system-contracts/contracts/NonceHolder.sol


27      contract NonceHolder is INonceHolder, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L27:27

```solidity
File: system-contracts/contracts/PubdataChunkPublisher.sol


16      contract PubdataChunkPublisher is IPubdataChunkPublisher, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L16:16

```solidity
File: system-contracts/contracts/SystemContext.sol


17      contract SystemContext is ISystemContext, ISystemContextDeprecated, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L17:17

</details>

## NC048 - Custom errors should be used rather than `revert()`/`require()`:

Custom errors are available from solidity version 0.8.4. Custom errors are more easily processed in `try`-`catch` blocks, and are easier to re-use and maintain.


<details>
<summary>Click to show 255 findings</summary>

```solidity
File: contracts/GasBoundCaller.sol


46              require(_maxTotalGas >= gasleft(), "Gas limit is too low");


76                  require(pubdataAllowance + gasleft() >= pubdataCost + CALL_RETURN_OVERHEAD, "Not enough gas for pubdata");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L76:76

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


64              require(msg.sender == address(sharedBridge), "Not shared bridge");


66              require(amount == _amount, "Incorrect amount");


141             require(_amount != 0, "0T"); // empty deposit


143             require(amount == _amount, "3T"); // The token has non-standard transfer logic


186             require(amount != 0, "2T"); // empty deposit


215             require(!isWithdrawalFinalized[_l2BatchNumber][_l2MessageIndex], "pw");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L215:215

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


69              require(msg.sender == address(bridgehub), "ShB not BH");


75              require(


84              require(msg.sender == address(legacyBridge), "ShB not legacy bridge");


108             require(_owner != address(0), "ShB owner 0");


121                 require(balanceAfter > balanceBefore, "ShB: 0 eth transferred");


129                 require(amount > 0, "ShB: 0 amount to transfer");


132                 require(balanceAfter - balanceBefore == amount, "ShB: wrong amount transferred");


138             require(bridgehub.getStateTransition(_chainId) == msg.sender, "receiveEth not state transition");


155                 require(msg.value == _amount, "L1SharedBridge: msg.value not equal to amount");


158                 require(msg.value == 0, "ShB m.v > 0 b d.it");


161                 require(amount == _amount, "3T"); // The token has non-standard transfer logic


188             require(l2BridgeAddress[_chainId] != address(0), "ShB l2 bridge not deployed");


194             require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported");


195             require(bridgehub.baseToken(_chainId) != _l1Token, "ShB: baseToken deposit not supported");


200                 require(_depositAmount == 0, "ShB wrong withdraw amount");


202                 require(msg.value == 0, "ShB m.v > 0 for BH d.it 2");


206                 require(withdrawAmount == _depositAmount, "5T"); // The token has non-standard transfer logic


208             require(amount != 0, "6T"); // empty deposit amount


237             require(depositHappened[_chainId][_txHash] == 0x00, "ShB tx hap");


325                 require(proofValid, "yn");


327             require(_amount > 0, "y1");


342                     require(dataHash == txDataHash, "ShB: d.it not hap");


349                 require(chainBalance[_chainId][_l1Token] >= _amount, "ShB n funds");


360                 require(callSuccess, "ShB: claimFailedDeposit failed");


396                 require(!legacyBridge.isWithdrawalFinalized(_l2BatchNumber, _l2MessageIndex), "ShB: legacy withdrawal");


417             require(!isWithdrawalFinalized[_chainId][_l2BatchNumber][_l2MessageIndex], "Withdrawal is already finalized");


427                 require(!alreadyFinalized, "Withdrawal is already finalized 2");


439                 require(chainBalance[_chainId][l1Token] >= amount, "ShB not enough funds 2"); // not enought funds


449                 require(callSuccess, "ShB: withdraw failed");


484             require(success, "ShB withd w proof"); // withdrawal wrong proof


501             require(_l2ToL1message.length >= 56, "ShB wrong msg len"); // wrong messsage length


517                 require(_l2ToL1message.length == 76, "ShB wrong msg len 2");


563             require(l2BridgeAddress[ERA_CHAIN_ID] != address(0), "ShB b. n dep");


564             require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported 2");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L564:564

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


46              require(msg.sender == admin || msg.sender == owner(), "Bridgehub: not owner or admin");


62              require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights


83              require(


93              require(


102             require(!tokenIsRegistered[_token], "Bridgehub: token already registered");


122             require(_chainId != 0, "Bridgehub: chainId cannot be 0");


123             require(_chainId <= type(uint48).max, "Bridgehub: chainId too large");


125             require(


129             require(tokenIsRegistered[_baseToken], "Bridgehub: token not registered");


130             require(address(sharedBridge) != address(0), "Bridgehub: weth bridge not set");


132             require(stateTransitionManager[_chainId] == address(0), "Bridgehub: chainId already registered");


223                     require(msg.value == _request.mintValue, "Bridgehub: msg.value mismatch 1");


225                     require(msg.value == 0, "Bridgehub: non-eth bridge with msg.value");


269                     require(


275                     require(msg.value == _request.secondBridgeValue, "Bridgehub: msg.value mismatch 3");


296             require(outputRequest.magicValue == TWO_BRIDGES_MAGIC_VALUE, "Bridgehub: magic value mismatch");


300             require(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L300:300

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


42              require(_admin != address(0), "Admin should be non zero address");


59              require(msg.sender == address(this), "Only governance contract itself is allowed to call this function");


65              require(msg.sender == securityCouncil, "Only security council is allowed to call this function");


71              require(


155             require(isOperationPending(_id), "Operation must be pending");


172             require(isOperationReady(id), "Operation must be ready before execution");


177             require(isOperationReady(id), "Operation must be ready after execution");


191             require(isOperationPending(id), "Operation must be pending before execution");


196             require(isOperationPending(id), "Operation must be pending after execution");


216             require(!isOperation(_id), "Operation with this proposal id already exists");


217             require(_delay >= minDelay, "Proposed delay is less than minimum delay");


240             require(_predecessorId == bytes32(0) || isOperationDone(_predecessorId), "Predecessor operation not completed");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L240:240

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


64              require(msg.sender == bridgehub, "StateTransition: only bridgehub");


70              require(msg.sender == admin || msg.sender == owner(), "Bridgehub: not owner or admin");


82              require(_initializeData.governor != address(0), "StateTransition: governor zero");


121             require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights


256             require(cutHashInput == initialCutHash, "StateTransition: initial cutHash mismatch");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L256:256

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


62              require(msg.sender == stateTransitionManager.getChainAdmin(_chainId), "ValidatorTimelock: only chain admin");


68              require(validators[_chainId][msg.sender] == true, "ValidatorTimelock: only validator");


195                     require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed


217                     require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L217:217

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


25              require(address(_initializeData.verifier) != address(0), "vt");


26              require(_initializeData.admin != address(0), "vy");


27              require(_initializeData.validatorTimelock != address(0), "hc");


28              require(_initializeData.priorityTxMaxGasLimit <= MAX_GAS_PER_TRANSACTION, "vu");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L28:28

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol


14              require(_chainId == block.chainid, "pr");


25              require(msg.data.length >= 4 || msg.data.length == 0, "Ut");


30              require(facetAddress != address(0), "F"); // Proxy has no facet for this selector


31              require(!diamondStorage.isFrozen || !facet.isFreezable, "q1"); // Facet is frozen


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L31:31

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


34              require(msg.sender == pendingAdmin, "n4"); // Only proposed by current admin address can claim the admin rights


59              require(_newPriorityTxMaxGasLimit <= MAX_GAS_PER_TRANSACTION, "n5");


70              require(_newFeeParams.maxPubdataPerBatch >= _newFeeParams.priorityTxMaxPubdata, "n6");


90              require(s.totalBatchesCommitted == 0, "AdminFacet: set validium only after genesis"); // Validium mode can be set only before the first batch is committed


105             require(


110             require(


116             require(


136             require(!diamondStorage.isFrozen, "a9"); // diamond proxy is frozen already


146             require(diamondStorage.isFrozen, "a7"); // diamond proxy is not frozen


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L146:146

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


37              require(_newBatch.batchNumber == _previousBatch.batchNumber + 1, "f"); // only commit next batch


40              require(pubdataSource == uint8(PubdataSource.Calldata) || pubdataSource == uint8(PubdataSource.Blob), "us");


50                  require(logOutput.pubdataHash == 0x00, "v0h");


51                  require(_newBatch.pubdataCommitments.length == 1);


61                  require(


74              require(_previousBatch.batchHash == logOutput.previousBatchHash, "l");


76              require(logOutput.chainedPriorityTxsHash == _newBatch.priorityOperationsHash, "t");


78              require(logOutput.numberOfLayer1Txs == _newBatch.numberOfLayer1Txs, "ta");


110             require(batchTimestamp == _expectedBatchTimestamp, "tb");


114             require(_previousBatchTimestamp < batchTimestamp, "h3");


122             require(block.timestamp - COMMIT_TIMESTAMP_NOT_OLDER <= batchTimestamp, "h1"); // New batch timestamp is too small


123             require(lastL2BlockTimestamp <= block.timestamp + COMMIT_TIMESTAMP_APPROXIMATION_DELTA, "h2"); // The last L2 block timestamp is too big


149                 require(!_checkBit(processedLogs, uint8(logKey)), "kp");


154                     require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "lm");


157                     require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "ln");


160                     require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "lb");


163                     require(logSender == L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR, "sc");


166                     require(logSender == L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR, "sv");


169                     require(logSender == L2_BOOTLOADER_ADDRESS, "bl");


172                     require(logSender == L2_BOOTLOADER_ADDRESS, "bk");


175                     require(logSender == L2_PUBDATA_CHUNK_PUBLISHER_ADDR, "pc");


178                     require(logSender == L2_PUBDATA_CHUNK_PUBLISHER_ADDR, "pd");


181                     require(logSender == L2_BOOTLOADER_ADDRESS, "bu");


182                     require(_expectedSystemContractUpgradeTxHash == logValue, "ut");


192                 require(processedLogs == 511, "b7");


194                 require(processedLogs == 1023, "b8");


226             require(


231             require(_newBatchesData.length == 1, "e4");


233             require(s.storedBatchHashes[s.totalBatchesCommitted] == _hashStoredBatchInfo(_lastCommittedBatchData), "i"); // incorrect previous batch data


284             require(s.l2SystemContractsUpgradeBatchNumber == 0, "ik");


323             require(currentBatchNumber == s.totalBatchesExecuted + _executedBatchIdx + 1, "k"); // Execute batches in order


324             require(


330             require(priorityOperationsHash == _storedBatch.priorityOperationsHash, "x"); // priority operations hash does not match to expected


358             require(newTotalBatchesExecuted <= s.totalBatchesVerified, "n"); // Can't execute batches more than committed and proven currently.


402             require(_hashStoredBatchInfo(_prevBatch) == s.storedBatchHashes[currentTotalBatchesVerified], "t1");


407                 require(


421             require(currentTotalBatchesVerified <= s.totalBatchesCommitted, "q");


442             require(proofPublicInput.length == 1, "t4");


449             require(successVerifyProof, "p"); // Proof verification fail


482             require(s.totalBatchesCommitted > _newLastBatch, "v1"); // The last committed batch is less than new last batch


483             require(_newLastBatch >= s.totalBatchesExecuted, "v2"); // Already executed batches cannot be reverted


543             require(_batch.systemLogs.length <= MAX_L2_TO_L1_LOGS_COMMITMENT_BYTES, "pu");


567             require(_blobCommitments.length == MAX_NUMBER_OF_BLOBS, "b10");


568             require(_blobHashes.length == MAX_NUMBER_OF_BLOBS, "b11");


616             require(success, "failed to call point evaluation precompile");


618             require(result == BLS_MODULUS, "precompile unexpected output");


631             require(_pubdataCommitments.length > 0, "pl");


632             require(_pubdataCommitments.length <= PUBDATA_COMMITMENT_SIZE * MAX_NUMBER_OF_BLOBS, "bd");


633             require(_pubdataCommitments.length % PUBDATA_COMMITMENT_SIZE == 0, "bs");


639                 require(blobVersionedHash != bytes32(0), "vh");


663             require(versionedHash == bytes32(0), "lh");


668                 require(


681             require(success, "vc");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L681:681

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


183             require(ds.selectorToFacet[_selector].facetAddress != address(0), "g2");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L183:183

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


39              require(s.chainId == ERA_CHAIN_ID, "transferEthToSharedBridge only available for Era on mailbox");


110             require(_batchNumber <= s.totalBatchesExecuted, "xx");


117             require(hashedLog != L2_L1_LOGS_TREE_DEFAULT_LEAF_HASH, "tw");


158             require(s.baseTokenGasPriceMultiplierDenominator > 0, "Mailbox: baseTokenGasPriceDenominator not set");


185             require(s.chainId == ERA_CHAIN_ID, "finalizeEthWithdrawal only available for Era on mailbox");


206             require(s.chainId == ERA_CHAIN_ID, "legacy interface only available for era token");


243             require(_request.l2GasPerPubdataByteLimit == REQUIRED_L2_GAS_PRICE_PER_PUBDATA, "qp");


264             require(_factoryDeps.length <= MAX_NEW_FACTORY_DEPS, "uj");


272             require(_mintValue >= baseCost + _params.l2Value, "mv"); // The `msg.value` doesn't cover the transaction cost


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L272:272

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol


16              require(msg.sender == s.admin, "StateTransition Chain: not admin");


22              require(s.validators[msg.sender], "StateTransition Chain: not validator");


27              require(msg.sender == s.stateTransitionManager, "StateTransition Chain: not state transition manager");


32              require(msg.sender == s.bridgehub, "StateTransition Chain: not bridgehub");


37              require(


45              require(


53              require(msg.sender == s.baseTokenBridge, "Only shared bridge can call this function");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L53:53

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


55              require(_l1Bridge != address(0), "bf");


56              require(_l2TokenProxyBytecodeHash != bytes32(0), "df");


57              require(_aliasedOwner != address(0), "sf");


58              require(_l2TokenProxyBytecodeHash != bytes32(0), "df");


68                  require(_l1LegecyBridge != address(0), "bf2");


87              require(


92              require(msg.value == 0, "Value should be 0 for ERC20 bridge");


98                  require(deployedToken == expectedL2Token, "mt");


101                 require(currentL1Token == _l1Token, "gg"); // Double check that the expected value equal to real one


124             require(_amount > 0, "Amount cannot be zero");


129             require(l1Token != address(0), "yh");


176             require(success, "mk");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L176:176

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


51              require(_l1Address != address(0), "in6"); // Should be non-zero address


120             require(msg.sender == UpgradeableBeacon(beaconAddress).owner(), "tt");


130             require(msg.sender == l2Bridge, "xnt"); // Only L2 bridge can call this method


137             require(_version == _getInitializedVersion() + 1, "v");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L137:137

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


26              require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract");


37              require(Utils.isContractConstructing(_hash), "Code hash is not for a contract on constructor");


48              require(Utils.isContractConstructed(_hash), "Code hash is not for a constructed contract");


57              require(Utils.isContractConstructing(codeHash), "Code hash is not for a contract on constructor");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L57:57

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


92                  require(vInt == 27 || vInt == 28, "Invalid v value");


191                 require(vInt == 27 || vInt == 28, "Invalid v value");


286                 require(vInt == 27 || vInt == 28, "Invalid v value");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L286:286

```solidity
File: system-contracts/contracts/ComplexUpgrader.sol


22              require(msg.sender == FORCE_DEPLOYER, "Can only be called by FORCE_DEPLOYER");


24              require(_delegateTo.code.length > 0, "Delegatee is an EOA");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L24:24

```solidity
File: system-contracts/contracts/Compressor.sol


51                  require(


56                  require(


63                      require(indexOfEncodedChunk < dictionary.length, "Encoded chunk index is out of bounds");


68                      require(encodedChunk == realChunk, "Encoded chunk does not match the original bytecode");


119             require(_enumerationIndexSize <= MAX_ENUMERATION_INDEX_SIZE, "enumeration index size is too large");


140                 require(derivedKey == _compressedStateDiffs.readBytes32(stateDiffPtr), "iw: initial key mismatch");


156             require(numInitialWritesProcessed == numberOfInitialWrites, "Incorrect number of initial storage diffs");


171                 require(enumIndex == compressedEnumIndex, "rw: enum key mismatch");


187             require(stateDiffPtr == _compressedStateDiffs.length, "Extra data in _compressedStateDiffs");


230                     require(convertedValue == _finalValue, "transform or no compression: compressed and final mismatch");


232                     require(


237                     require(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L237:237

```solidity
File: system-contracts/contracts/ContractDeployer.sol


29              require(msg.sender == address(this), "Callable only by self");


77              require(


239             require(


251             require(msg.value == sumOfValues, "`value` provided is not equal to the combined `value`s of deployments");


264             require(_bytecodeHash != bytes32(0x0), "BytecodeHash cannot be zero");


265             require(uint160(_newAddress) > MAX_SYSTEM_CONTRACT_ADDRESS, "Can not deploy contracts in kernel space");


268             require(


273             require(NONCE_HOLDER_SYSTEM_CONTRACT.getRawNonce(_newAddress) == 0x00, "Account is occupied");


303             require(knownCodeMarker > 0, "The code hash is not known");


350                 require(value == 0, "The value must be zero if we do not call the constructor");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L350:350

```solidity
File: system-contracts/contracts/DefaultAccount.sol


100             require(totalRequiredBalance <= address(this).balance, "Not enough balance for fee + value");


160             require(_signature.length == 65, "Signature length is incorrect");


173             require(v == 27 || v == 28, "v is neither 27 nor 28");


184             require(uint256(s) <= 0x7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5D576E7357A4501DDFE92F46681B20A0, "Invalid s");


202             require(success, "Failed to pay the fee to the operator");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L202:202

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


35              require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L35:35

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


20              require(msg.sender == address(COMPRESSOR_CONTRACT), "Callable only by the compressor");


76              require(version == 1 && _bytecodeHash[1] == bytes1(0), "Incorrectly formatted bytecodeHash");


78              require(Utils.bytecodeLenInWords(_bytecodeHash) % 2 == 1, "Code length in words must be odd");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L78:78

```solidity
File: system-contracts/contracts/L1Messenger.sol


201             require(numberOfL2ToL1Logs <= L2_TO_L1_LOGS_MERKLE_TREE_LEAVES, "Too many L2->L1 logs");


214             require(


245             require(


269             require(


279             require(


298             require(calldataPtr <= MAX_ALLOWED_PUBDATA_PER_BATCH, "L1 Messenger pubdata is too long");


315             require(calldataPtr == _totalL2ToL1PubdataAndStateDiffs.length, "Extra data in the totalL2ToL1Pubdata array");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L315:315

```solidity
File: system-contracts/contracts/L2BaseToken.sol


33              require(


41              require(fromBalance >= _amount, "Transfer amount exceeds balance");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L41:41

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


60              require(to != address(this), "MsgValueSimulator calls itself");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L60:60

```solidity
File: system-contracts/contracts/NonceHolder.sol


66              require(_value <= MAXIMAL_MIN_NONCE_INCREMENT, "The value for incrementing the nonce is too high");


85              require(_value != 0, "Nonce value cannot be set to 0");


89                  require(isNonceUsed(msg.sender, _key - 1), "Previous nonce has not been used");


115             require(oldMinNonce == _expectedNonce, "Incorrect nonce");


136             require(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L136:136

```solidity
File: system-contracts/contracts/PubdataChunkPublisher.sol


22              require(_pubdata.length <= BLOB_SIZE_BYTES * MAX_NUMBER_OF_BLOBS, "pubdata should fit in 2 blobs");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L22:22

```solidity
File: system-contracts/contracts/SystemContext.sol


242             require(_isFirstInBatch, "Upgrade transaction must be first");


245             require(_l2BlockNumber > 0, "L2 block number is never expected to be zero");


249                 require(correctPrevBlockHash == _expectedPrevL2BlockHash, "The previous L2 block hash is incorrect");


287                 require(_maxVirtualBlocksToCreate > 0, "Can't initialize the first virtual block");


351                 require(


355                 require(_maxVirtualBlocksToCreate > 0, "There must be a virtual block created at the start of the batch");


367                 require(!_isFirstInBatch, "Can not reuse L2 block number from the previous batch");


368                 require(currentL2BlockTimestamp == _l2BlockTimestamp, "The timestamp of the same L2 block must be same");


369                 require(


373                 require(_maxVirtualBlocksToCreate == 0, "Can not create virtual blocks in the middle of the miniblock");


385                 require(_expectedPrevL2BlockHash == pendingL2BlockHash, "The current L2 block hash is incorrect");


386                 require(


413             require(currentBatchNumber > 0, "The current batch number must be greater than 0");


429             require(


451             require(_newTimestamp > previousBatchTimestamp, "Timestamps should be incremental");


452             require(previousBatchNumber + 1 == _expectedNewNumber, "The provided block number is not correct");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L452:452

</details>

## NC049 - Top level declarations should be separated by two blank lines:




<details>
<summary>Click to show 7 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


41      


21      


33      


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L33:33

```solidity
File: contracts/ethereum/contracts/common/Messaging.sol


126     


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/Messaging.sol#L126:126

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


25      


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L25:25

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol


60      


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L60:60

```solidity
File: system-contracts/contracts/interfaces/IImmutableSimulator.sol


9       


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L9:9

</details>

## NC050 - Duplicate import statements:

This issue arises when the same file is imported multiple times.


```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol


6       import {IBridgehub} from "../../bridgehub/IBridgehub.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L6:6

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


8       import {IVerifier} from "../state-transition/chain-interfaces/IVerifier.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L8:8

```solidity
File: system-contracts/contracts/PubdataChunkPublisher.sol


9       import {SystemLogKey} from "./Constants.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L9:9

## NC051 - Contract uses both `require()`/`revert()` as well as custom errors:

Consider using just one method in a single file


```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


22      contract ValidatorTimelock is IExecutor, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L22:22


## NC052 - Functions should have Natspec @return annotations:

Documents the return variables of a contracts function


<details>
<summary>Click to show 274 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


182         function bridgehubDeposit(


243         function _getDepositL2Calldata(


254         function _getERC20Getters(address _token) internal view returns (bytes memory) {


409         function _finalizeWithdrawal(


458         function _checkWithdrawal(


487         function _parseL2WithdrawalMessage(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L487:487

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol


24          function isWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool);


26          function deposit(


35          function deposit(


61          function l2TokenAddress(address _l1Token) external view returns (address);


63          function sharedBridge() external view returns (IL1SharedBridge);


65          function l2TokenBeacon() external view returns (address);


67          function l2Bridge() external view returns (address);


69          function depositAmount(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L69:69

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol


58          function isWithdrawalFinalized(


64          function depositLegacyErc20Bridge(


97          function finalizeWithdrawalLegacyErc20Bridge(


114         function l1WethAddress() external view returns (address);


116         function bridgehub() external view returns (IBridgehub);


118         function legacyBridge() external view returns (IL1ERC20Bridge);


120         function l2BridgeAddress(uint256 _chainId) external view returns (address);


122         function depositHappened(uint256 _chainId, bytes32 _l2TxHash) external view returns (bytes32);


128         function bridgehubDeposit(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L128:128

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol


17          function l1TokenAddress(address _l2Token) external view returns (address);


19          function l2TokenAddress(address _l1Token) external view returns (address);


21          function l1Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L21:21

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


75          function getStateTransition(uint256 _chainId) public view returns (address) {


114         function createNewChain(


152         function proveL2MessageInclusion(


164         function proveL2LogInclusion(


176         function proveL1ToL2TransactionStatus(


198         function l2TransactionBaseCost(


217         function requestL2TransactionDirect(


262         function requestL2TransactionTwoBridges(


325         function _actualRefundRecipient(address _refundRecipient) internal view returns (address _recipient) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L325:325

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


59          function stateTransitionManagerIsRegistered(address _stateTransitionManager) external view returns (bool);


61          function stateTransitionManager(uint256 _chainId) external view returns (address);


63          function tokenIsRegistered(address _baseToken) external view returns (bool);


65          function baseToken(uint256 _chainId) external view returns (address);


67          function sharedBridge() external view returns (IL1SharedBridge);


69          function getStateTransition(uint256 _chainId) external view returns (address);


73          function proveL2MessageInclusion(


81          function proveL2LogInclusion(


89          function proveL1ToL2TransactionStatus(


99          function requestL2TransactionDirect(


103         function requestL2TransactionTwoBridges(


107         function l2TransactionBaseCost(


116         function createNewChain(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L116:116

```solidity
File: contracts/ethereum/contracts/common/libraries/UncheckedMath.sol


11          function uncheckedInc(uint256 _number) internal pure returns (uint256) {


17          function uncheckedAdd(uint256 _lhs, uint256 _rhs) internal pure returns (uint256) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UncheckedMath.sol#L17:17

```solidity
File: contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol


19          function readUint32(bytes memory _bytes, uint256 _start) internal pure returns (uint32 result, uint256 offset) {


26          function readAddress(bytes memory _bytes, uint256 _start) internal pure returns (address result, uint256 offset) {


33          function readUint256(bytes memory _bytes, uint256 _start) internal pure returns (uint256 result, uint256 offset) {


40          function readBytes32(bytes memory _bytes, uint256 _start) internal pure returns (bytes32 result, uint256 offset) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L40:40

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


84          function isOperation(bytes32 _id) public view returns (bool) {


89          function isOperationPending(bytes32 _id) public view returns (bool) {


95          function isOperationReady(bytes32 _id) public view returns (bool) {


100         function isOperationDone(bytes32 _id) public view returns (bool) {


105         function getOperationState(bytes32 _id) public view returns (OperationState) {


204         function hashOperation(Operation calldata _operation) public pure returns (bytes32) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L204:204

```solidity
File: contracts/ethereum/contracts/governance/IGovernance.sol


41          function isOperation(bytes32 _id) external view returns (bool);


43          function isOperationPending(bytes32 _id) external view returns (bool);


45          function isOperationReady(bytes32 _id) external view returns (bool);


47          function isOperationDone(bytes32 _id) external view returns (bool);


49          function getOperationState(bytes32 _id) external view returns (OperationState);


61          function hashOperation(Operation calldata _operation) external pure returns (bytes32);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L61:61

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


43          function bridgehub() external view returns (address);


53          function stateTransition(uint256 _chainId) external view returns (address);


55          function storedBatchZero() external view returns (bytes32);


57          function initialCutHash() external view returns (bytes32);


59          function genesisUpgrade() external view returns (address);


61          function upgradeCutHash(uint256 _protocolVersion) external view returns (bytes32);


63          function protocolVersion() external view returns (uint256);


71          function getChainAdmin(uint256 _chainId) external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L71:71

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


74          function getChainAdmin(uint256 _chainId) external view override returns (address) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L74:74

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


102         function getCommittedBatchTimestamp(uint256 _chainId, uint256 _l2BatchNumber) external view returns (uint256) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L102:102

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


32          function _commitOneBatch(


130         function _processL2Logs(


308         function _collectOperationsFromPriorityQueue(uint256 _nPriorityOps) internal returns (bytes32 concatHash) {


453         function _getBatchProofPublicInput(


500         function _createBatchCommitment(


515         function _batchPassThroughData(CommitBatchInfo calldata _batch) internal pure returns (bytes memory) {


525         function _batchMetaParameters() internal view returns (bytes memory) {


537         function _batchAuxiliaryOutput(


561         function _encodeBlobAuxilaryOutput(


587         function _hashStoredBatchInfo(StoredBatchInfo memory _storedBatchInfo) internal pure returns (bytes32) {


592         function _checkBit(uint256 _bitMap, uint8 _index) internal pure returns (bool) {


597         function _setBit(uint256 _bitMap, uint8 _index) internal pure returns (uint256) {


625         function _verifyBlobInformation(


679         function _getBlobVersionedHash(uint256 _index) internal view returns (bytes32 versionedHash) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L679:679

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


32          function getVerifier() external view returns (address) {


37          function getAdmin() external view returns (address) {


42          function getPendingAdmin() external view returns (address) {


47          function getBridgehub() external view returns (address) {


52          function getStateTransitionManager() external view returns (address) {


57          function getBaseToken() external view returns (address) {


62          function getBaseTokenBridge() external view returns (address) {


67          function baseTokenGasPriceMultiplierNominator() external view returns (uint128) {


72          function baseTokenGasPriceMultiplierDenominator() external view returns (uint128) {


77          function getTotalBatchesCommitted() external view returns (uint256) {


82          function getTotalBatchesVerified() external view returns (uint256) {


87          function getTotalBatchesExecuted() external view returns (uint256) {


92          function getTotalPriorityTxs() external view returns (uint256) {


97          function getFirstUnprocessedPriorityTx() external view returns (uint256) {


102         function getPriorityQueueSize() external view returns (uint256) {


107         function priorityQueueFrontOperation() external view returns (PriorityOperation memory) {


112         function isValidator(address _address) external view returns (bool) {


117         function l2LogsRootHash(uint256 _batchNumber) external view returns (bytes32) {


122         function storedBatchHash(uint256 _batchNumber) external view returns (bytes32) {


127         function getL2BootloaderBytecodeHash() external view returns (bytes32) {


132         function getL2DefaultAccountBytecodeHash() external view returns (bytes32) {


137         function getVerifierParams() external view returns (VerifierParams memory) {


142         function getProtocolVersion() external view returns (uint256) {


147         function getL2SystemContractsUpgradeTxHash() external view returns (bytes32) {


152         function getL2SystemContractsUpgradeBatchNumber() external view returns (uint256) {


157         function isDiamondStorageFrozen() external view returns (bool) {


163         function isFacetFreezable(address _facet) external view returns (bool isFreezable) {


176         function getPriorityTxMaxGasLimit() external view returns (uint256) {


181         function isFunctionFreezable(bytes4 _selector) external view returns (bool) {


188         function isEthWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool) {


193         function getPubdataPricingMode() external view returns (PubdataPricingMode) {


202         function facets() external view returns (Facet[] memory result) {


217         function facetFunctionSelectors(address _facet) external view returns (bytes4[] memory) {


223         function facetAddresses() external view returns (address[] memory) {


229         function facetAddress(bytes4 _selector) external view returns (address) {


239         function getTotalBlocksCommitted() external view returns (uint256) {


244         function getTotalBlocksVerified() external view returns (uint256) {


249         function getTotalBlocksExecuted() external view returns (uint256) {


254         function storedBlockHash(uint256 _batchNumber) external view returns (bytes32) {


259         function getL2SystemContractsUpgradeBlockNumber() external view returns (uint256) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L259:259

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


47          function bridgehubRequestL2Transaction(


54          function proveL2MessageInclusion(


64          function proveL2LogInclusion(


74          function proveL1ToL2TransactionStatus(


104         function _proveL2LogInclusion(


130         function _L2MessageToLog(L2Message memory _message) internal pure returns (L2Log memory) {


143         function l2TransactionBaseCost(


197         function requestL2Transaction(


228         function _requestL2TransactionSender(


258         function _requestL2Transaction(


289         function _serializeL2Transaction(


316         function _writePriorityOp(


353         function _hashFactoryDeps(bytes[] memory _factoryDeps) internal pure returns (uint256[] memory hashedFactoryDeps) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L353:353

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol


62          function initialize(InitializeData calldata _initData) external returns (bytes32);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L62:62

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol


98          function bridgehubRequestL2Transaction(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L98:98

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol


40          function _efficientHash(bytes32 _lhs, bytes32 _rhs) private pure returns (bytes32 result) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L40:40

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol


109         function getTransactionBodyGasLimit(


128         function getOverheadForTransaction(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L128:128

```solidity
File: contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol


13          function upgrade(ProposedUpgrade calldata _proposedUpgrade) public override returns (bytes32) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol#L13:13

```solidity
File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol


14          function upgrade(ProposedUpgrade calldata _proposedUpgrade) public override returns (bytes32) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L14:14

```solidity
File: contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol


8           function upgrade(ProposedUpgrade calldata _upgrade) external returns (bytes32);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol#L8:8

```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


53          function create2(bytes32 _salt, bytes32 _bytecodeHash, bytes calldata _input) external returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L53:53

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


27          function safeCastToU32(uint256 _x) internal pure returns (uint32) {


37          function systemCall(uint32 gasLimit, address to, uint256 value, bytes memory data) internal returns (bool success) {


76          function systemCallWithReturndata(


95          function getFarCallABI(


121         function getFarCallABIWithEmptyFatPointer(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L121:121

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


109         function _deployL2Token(address _l1Token, bytes calldata _data) internal returns (address) {


138         function _getL1WithdrawMessage(


157         function _getCreate2Salt(address _l1Token) internal pure returns (bytes32 salt) {


164         function _deployBeaconProxy(bytes32 salt) internal returns (BeaconProxy proxy) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L164:164

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


159         function name() public view override returns (string memory) {


165         function symbol() public view override returns (string memory) {


171         function decimals() public view override returns (uint8) {


178         function decodeString(bytes memory _input) external pure returns (string memory result) {


183         function decodeUint8(bytes memory _input) external pure returns (uint8 result) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L183:183

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol


34          function l1TokenAddress(address _l2Token) external view returns (address);


36          function l2TokenAddress(address _l1Token) external view returns (address);


38          function l1Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L38:38

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol


16          function l1Address() external view returns (address);


18          function l2Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L18:18

```solidity
File: system-contracts/contracts/Compressor.sol


197         function _decodeRawBytecode(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L197:197

```solidity
File: system-contracts/contracts/ContractDeployer.sol


34          function getAccountInfo(address _address) external view returns (AccountInfo memory info) {


40          function extendedAccountVersion(address _address) public view returns (AccountAbstractionVersion) {


115         function getNewAddressCreate(


132         function create2(


147         function create(


162         function create2Account(


182         function createAccount(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L182:182

```solidity
File: system-contracts/contracts/DefaultAccount.sol


67          function validateTransaction(


78          function _validateTransaction(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L78:78

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


65          function getMarker(bytes32 _hash) public view override returns (uint256 marker) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L65:65

```solidity
File: system-contracts/contracts/L1Messenger.sol


50          function keccakGasCost(uint256 _length) internal pure returns (uint256) {


61          function sha256GasCost(uint256 _length) internal pure returns (uint256) {


70          function sendL2ToL1Log(


94          function _processL2ToL1Log(L2ToL1Log memory _l2ToL1Log) internal returns (uint256 logIdInMerkleTree) {


116         function sendToL1(bytes calldata _message) external override returns (bytes32 hash) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L116:116

```solidity
File: system-contracts/contracts/L2BaseToken.sol


56          function balanceOf(uint256 _account) external view override returns (uint256) {


99          function _burnMsgValue() internal returns (uint256 amount) {


112         function _getL1WithdrawMessage(address _to, uint256 _amount) internal pure returns (bytes memory) {


117         function _getExtendedWithdrawMessage(


128         function name() external pure override returns (string memory) {


134         function symbol() external pure override returns (string memory) {


140         function decimals() external pure override returns (uint8) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L140:140

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


25          function _getAbiParams() internal view returns (uint256 value, bool isSystemCall, address to) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L25:25

```solidity
File: system-contracts/contracts/SystemContext.sol


117         function getCurrentPubdataSpent() public view returns (uint256) {


122         function getCurrentPubdataCost() external view returns (uint256) {


221         function _calculateL2BlockHash(


233         function _calculateLegacyL2BlockHash(uint128 _blockNumber) internal pure returns (bytes32) {


496         function currentBlockInfo() external view returns (uint256 blockInfo) {


503         function getBlockNumberAndTimestamp() external view returns (uint256 blockNumber, uint256 blockTimestamp) {


509         function blockHash(uint256 _blockNumber) external view returns (bytes32 hash) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L509:509

```solidity
File: system-contracts/contracts/interfaces/IAccountCodeStorage.sol


12          function getRawCodeHash(address _address) external view returns (bytes32 codeHash);


14          function getCodeHash(uint256 _input) external view returns (bytes32 codeHash);


16          function getCodeSize(uint256 _input) external view returns (uint256 codeSize);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L16:16

```solidity
File: system-contracts/contracts/interfaces/IBaseToken.sol


6           function balanceOf(uint256) external view returns (uint256);


10          function totalSupply() external view returns (uint256);


12          function name() external pure returns (string memory);


14          function symbol() external pure returns (string memory);


16          function decimals() external pure returns (uint8);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L16:16

```solidity
File: system-contracts/contracts/interfaces/IBootloaderUtilities.sol


8           function getTransactionHashes(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBootloaderUtilities.sol#L8:8

```solidity
File: system-contracts/contracts/interfaces/ICompressor.sol


19          function publishCompressedBytecode(


24          function verifyCompressedStateDiffs(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ICompressor.sol#L24:24

```solidity
File: system-contracts/contracts/interfaces/IContractDeployer.sol


43          function getNewAddressCreate2(


50          function getNewAddressCreate(address _sender, uint256 _senderNonce) external pure returns (address newAddress);


52          function create2(


58          function create2Account(


68          function create(


76          function createAccount(


84          function getAccountInfo(address _address) external view returns (AccountInfo memory info);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L84:84

```solidity
File: system-contracts/contracts/interfaces/IImmutableSimulator.sol


11          function getImmutable(address _dest, uint256 _index) external view returns (bytes32);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L11:11

```solidity
File: system-contracts/contracts/interfaces/IKnownCodesStorage.sol


18          function getMarker(bytes32 _hash) external view returns (uint256);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IKnownCodesStorage.sol#L18:18

```solidity
File: system-contracts/contracts/interfaces/IL1Messenger.sol


49          function sendToL1(bytes memory _message) external returns (bytes32);


51          function sendL2ToL1Log(bool _isService, bytes32 _key, bytes32 _value) external returns (uint256 logIdInMerkleTree);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L51:51

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


14          function l1Address() external view returns (address);


16          function l2Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L16:16

```solidity
File: system-contracts/contracts/interfaces/INonceHolder.sol


17          function getMinNonce(address _address) external view returns (uint256);


21          function getRawNonce(address _address) external view returns (uint256);


24          function increaseMinNonce(uint256 _value) external returns (uint256);


30          function getValueUnderNonce(uint256 _key) external view returns (uint256);


37          function getDeploymentNonce(address _address) external view returns (uint256);


40          function incrementDeploymentNonce(address _address) external returns (uint256);


46          function isNonceUsed(address _address, uint256 _nonce) external view returns (bool);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L46:46

```solidity
File: system-contracts/contracts/interfaces/ISystemContext.sol


30          function chainId() external view returns (uint256);


32          function origin() external view returns (address);


34          function gasPrice() external view returns (uint256);


36          function blockGasLimit() external view returns (uint256);


38          function coinbase() external view returns (address);


40          function difficulty() external view returns (uint256);


42          function baseFee() external view returns (uint256);


44          function txNumberInBlock() external view returns (uint16);


46          function getBlockHashEVM(uint256 _block) external view returns (bytes32);


48          function getBatchHash(uint256 _batchNumber) external view returns (bytes32 hash);


50          function getBlockNumber() external view returns (uint128);


52          function getBlockTimestamp() external view returns (uint128);


54          function getBatchNumberAndTimestamp() external view returns (uint128 blockNumber, uint128 blockTimestamp);


56          function getL2BlockNumberAndTimestamp() external view returns (uint128 blockNumber, uint128 blockTimestamp);


58          function gasPerPubdataByte() external view returns (uint256 gasPerPubdataByte);


60          function getCurrentPubdataSpent() external view returns (uint256 currentPubdataSpent);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L60:60

```solidity
File: system-contracts/contracts/interfaces/ISystemContextDeprecated.sol


11          function currentBlockInfo() external view returns (uint256);


13          function getBlockNumberAndTimestamp() external view returns (uint256 blockNumber, uint256 blockTimestamp);


15          function blockHash(uint256 _blockNumber) external view returns (bytes32 hash);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContextDeprecated.sol#L15:15

```solidity
File: system-contracts/contracts/libraries/RLPEncoder.sol


11          function encodeAddress(address _val) internal pure returns (bytes memory encoded) {


24          function encodeUint256(uint256 _val) internal pure returns (bytes memory encoded) {


49          function encodeNonSingleBytesLen(uint64 _len) internal pure returns (bytes memory) {


56          function encodeListLen(uint64 _len) internal pure returns (bytes memory) {


60          function _encodeLength(uint64 _len, uint256 _offset) private pure returns (bytes memory encoded) {


84          function _highestByteSet(uint256 _number) private pure returns (uint256 hbs) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L84:84

```solidity
File: system-contracts/contracts/libraries/SystemContractHelper.sol


63          function getCodeAddress() internal view returns (address addr) {


124         function packPrecompileParams(


168         function setValueForNextFarCall(uint128 _value) internal returns (bool success) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L168:168

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


100         function encodeHash(Transaction calldata _transaction) internal view returns (bytes32 resultHash) {


395         function payToTheBootloader(Transaction calldata _transaction) internal returns (bool success) {


405         function totalRequiredBalance(Transaction calldata _transaction) internal pure returns (uint256 requiredBalance) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L405:405

```solidity
File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol


19          function readUint16(bytes calldata _bytes, uint256 _start) internal pure returns (uint16 result) {


26          function readUint32(bytes calldata _bytes, uint256 _start) internal pure returns (uint32 result) {


33          function readUint64(bytes calldata _bytes, uint256 _start) internal pure returns (uint64 result) {


40          function readBytes32(bytes calldata _bytes, uint256 _start) internal pure returns (bytes32 result) {


46          function readUint256(bytes calldata _bytes, uint256 _start) internal pure returns (uint256 result) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L46:46

```solidity
File: system-contracts/contracts/libraries/Utils.sol


20          function safeCastToU128(uint256 _x) internal pure returns (uint128) {


26          function safeCastToU32(uint256 _x) internal pure returns (uint32) {


32          function safeCastToU24(uint256 _x) internal pure returns (uint24) {


51          function isContractConstructed(bytes32 _bytecodeHash) internal pure returns (bool) {


56          function isContractConstructing(bytes32 _bytecodeHash) internal pure returns (bool) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L56:56

</details>


## NC053 - Overridden function has no body:

Consider adding a NatSpec comment describing why the function doesn't need a body and or the purpose it serves.


```solidity
File: system-contracts/contracts/DefaultAccount.sol


125         function executeTransactionFromOutside(Transaction calldata _transaction) external payable override {
126             // Behave the same as for fallback/receive, just execute nothing, returns nothing
127         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L125:127

## NC054 - Consider moving `msg.sender` checks to a common authorization `modifier`:




<details>
<summary>Click to show 13 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


64              require(msg.sender == address(sharedBridge), "Not shared bridge");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L64:64

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


138             require(bridgehub.getStateTransition(_chainId) == msg.sender, "receiveEth not state transition");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L138:138

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


62              require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L62:62

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


121             require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L121:121

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


34              require(msg.sender == pendingAdmin, "n4"); // Only proposed by current admin address can claim the admin rights


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L34:34

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


87              require(
88                  AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1Bridge ||
89                      AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1LegacyBridge,
90                  "mq"
91              );


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L87:91

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


120             require(msg.sender == UpgradeableBeacon(beaconAddress).owner(), "tt");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L120:120

```solidity
File: system-contracts/contracts/ComplexUpgrader.sol


22              require(msg.sender == FORCE_DEPLOYER, "Can only be called by FORCE_DEPLOYER");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L22:22

```solidity
File: system-contracts/contracts/ContractDeployer.sol


239             require(
240                 msg.sender == FORCE_DEPLOYER || msg.sender == address(COMPLEX_UPGRADER_CONTRACT),
241                 "Can only be called by FORCE_DEPLOYER or COMPLEX_UPGRADER_CONTRACT"
242             );


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L239:242

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


35              require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L35:35

```solidity
File: system-contracts/contracts/L2BaseToken.sol


33              require(
34                  msg.sender == MSG_VALUE_SYSTEM_CONTRACT ||
35                      msg.sender == address(DEPLOYER_SYSTEM_CONTRACT) ||
36                      msg.sender == BOOTLOADER_FORMAL_ADDRESS,
37                  "Only system contracts with special access can call this method"
38              );


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L33:38

```solidity
File: system-contracts/contracts/NonceHolder.sol


89                  require(isNonceUsed(msg.sender, _key - 1), "Previous nonce has not been used");


136             require(
137                 msg.sender == address(DEPLOYER_SYSTEM_CONTRACT),
138                 "Only the contract deployer can increment the deployment nonce"
139             );


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L136:139

</details>

## NC055 - Unused `struct` definition:

Note that there may be cases where a struct superficially appears to be used, but this is only because there are multiple definitions of the struct in different files. In such cases, the struct definition should be moved into a separate file. The instances below are the unused definitions.


```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol


struct InitializeDataNewChain {
    IVerifier verifier;
    VerifierParams verifierParams;
    bytes32 l2BootloaderBytecodeHash;
    bytes32 l2DefaultAccountBytecodeHash;
    uint256 priorityTxMaxGasLimit;
    FeeParams feeParams;
    address blobVersionedHashRetriever;
}

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L51:59

## NC056 - Events are missing sender information:

When an action is triggered based on a user's action, not being able to filter based on who triggered the action makes event processing a lot more cumbersome. Including the msg.sender the events of these types of action will make events much more useful to end users. Include `msg.sender` in the event output.


<details>
<summary>Click to show 44 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


199             emit ClaimedFailedDeposit(_depositSender, _l1Token, amount);


225             emit WithdrawalFinalized(l1Receiver, l1Token, amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L225:225

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


168             emit BridgehubDepositBaseTokenInitiated(_chainId, _prevMsgSender, _l1Token, _amount);


227             emit BridgehubDepositInitiated(_chainId, txDataHash, _prevMsgSender, _l2Receiver, _l1Token, amount);


239             emit BridgehubDepositFinalized(_chainId, _txDataHash, _txHash);


602             emit LegacyDepositInitiated(ERA_CHAIN_ID, l2TxHash, _prevMsgSender, _l2Receiver, _l1Token, _amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L602:602

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


56              emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);


68              emit NewPendingAdmin(currentPendingAdmin, address(0));


69              emit NewAdmin(previousAdmin, pendingAdmin);


145             emit NewChain(_chainId, _stateTransitionManager, _admin);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L145:145

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


132             emit TransparentOperationScheduled(id, _delay, _operation);


144             emit ShadowOperationScheduled(_id, _delay);


157             emit OperationCancelled(_id);


180             emit OperationExecuted(id);


199             emit OperationExecuted(id);


250             emit ChangeMinDelay(minDelay, _newDelay);


257             emit ChangeSecurityCouncil(securityCouncil, _newSecurityCouncil);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L257:257

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


115             emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);


127             emit NewPendingAdmin(currentPendingAdmin, address(0));


128             emit NewAdmin(previousAdmin, pendingAdmin);


235             emit StateTransitionNewChain(_chainId, _stateTransitionContract);


287             emit StateTransitionNewChain(_chainId, stateTransitionAddress);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L287:287

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


83              emit ValidatorAdded(_chainId, _newValidator);


92              emit ValidatorRemoved(_chainId, _validator);


98              emit NewExecutionDelay(_executionDelay);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L98:98

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


28              emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);


40              emit NewPendingAdmin(pendingAdmin, address(0));


41              emit NewAdmin(previousAdmin, pendingAdmin);


47              emit ValidatorStatusUpdate(_validator, _active);


54              emit IsPorterAvailableStatusUpdate(_zkPorterIsAvailable);


63              emit NewPriorityTxMaxGasLimit(oldPriorityTxMaxGasLimit, _newPriorityTxMaxGasLimit);


75              emit NewFeeParams(oldFeeParams, _newFeeParams);


86              emit NewBaseTokenMultiplier(oldNominator, oldDenominator, _nominator, _denominator);


92              emit ValidiumModeStatusUpdate(_validiumMode);


115             emit ExecuteUpgrade(_diamondCut);


125             emit ExecuteUpgrade(_diamondCut);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L125:125

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


105             emit FinalizeDeposit(_l1Sender, _l2Receiver, expectedL2Token, _amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L105:105

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


101             emit BridgeInitialize(_l1Address, decodedName, decodedSymbol, decimals_);


126             emit BridgeInitialize(l1Address, _newName, _newSymbol, decimals_);


147             emit BridgeMint(_to, _amount);


156             emit BridgeBurn(_from, _amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L156:156

```solidity
File: system-contracts/contracts/L1Messenger.sol


181             emit BytecodeL1PublicationRequested(_bytecodeHash);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L181:181

```solidity
File: system-contracts/contracts/L2BaseToken.sol


49              emit Transfer(_from, _to, _amount);


67              emit Mint(_account, _amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L67:67

</details>

## NC057 - Enum values should be used in place of constant array indexes:

Create a commented enum value to use in place of constant array indexes, this makes the code far easier to understand.


<details>
<summary>Click to show 41 findings</summary>

```solidity
File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol


40              uint8 version = uint8(_bytecodeHash[0]);


41              require(version == 1 && _bytecodeHash[1] == bytes1(0), "zf"); // Incorrectly formatted bytecodeHash


50              codeLengthInWords = uint256(uint8(_bytecodeHash[2])) * 256 + uint256(uint8(_bytecodeHash[3]));


50              codeLengthInWords = uint256(uint8(_bytecodeHash[2])) * 256 + uint256(uint8(_bytecodeHash[3]));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L50:50

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


41              s.storedBatchHashes[0] = _initializeData.storedBatchZero;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L41:41

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


39              uint8 pubdataSource = uint8(bytes1(_newBatch.pubdataCommitments[0]));


55                  blobHashes[0] = logOutput.blob1Hash;


56                  blobHashes[1] = logOutput.blob2Hash;


66                  blobHashes[0] = logOutput.blob1Hash;


67                  blobCommitments[0] = bytes32(


287             s.l2SystemContractsUpgradeBatchNumber = _newBatchesData[0].batchNumber;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L287:287

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


170                 bytes4 selector0 = ds.facetToSelectors[_facet].selectors[0];


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L170:170

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


214                 bytes4 selector0 = ds.facetToSelectors[_facet].selectors[0];


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L214:214

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol


54              require(_transaction.reserved[0] == 0, "ue");


55              require(_transaction.reserved[1] <= type(uint160).max, "uf");


56              require(_transaction.reserved[2] == 0, "ug");


57              require(_transaction.reserved[3] == 0, "uo");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L57:57

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


72                  } else if (_transaction.data[0] >= 0x80) {


91                  uint256 vInt = uint256(uint8(_transaction.signature[64]));


96                  if (_transaction.reserved[0] != 0) {


168                 } else if (_transaction.data[0] >= 0x80) {


190                 uint256 vInt = uint256(uint8(_transaction.signature[64]));


263                 } else if (_transaction.data[0] >= 0x80) {


285                 uint256 vInt = uint256(uint8(_transaction.signature[64]));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L285:285

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


75              uint8 version = uint8(_bytecodeHash[0]);


76              require(version == 1 && _bytecodeHash[1] == bytes1(0), "Incorrectly formatted bytecodeHash");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L76:76

```solidity
File: system-contracts/contracts/L1Messenger.sol


230             bytes32 l2ToL1LogsTreeRoot = l2ToL1LogsTreeArray[0];


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L230:230

```solidity
File: system-contracts/contracts/PubdataChunkPublisher.sol


55              SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.BLOB_ONE_HASH_KEY)), blobHashes[0]);


56              SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.BLOB_TWO_HASH_KEY)), blobHashes[1]);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L56:56

```solidity
File: system-contracts/contracts/libraries/RLPEncoder.sol


29                      encoded[0] = (_val == 0) ? bytes1(uint8(128)) : bytes1(uint8(_val));


34                      encoded[0] = bytes1(uint8(hbs + 0x81));


64                      encoded[0] = bytes1(uint8(_len + _offset));


69                      encoded[0] = bytes1(uint8(_offset + hbs + 56));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L69:69

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


175                 } else if (_transaction.data[0] >= 0x80) {


184             if (_transaction.reserved[0] != 0) {


253                 } else if (_transaction.data[0] >= 0x80) {


325                 } else if (_transaction.data[0] >= 0x80) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L325:325

```solidity
File: system-contracts/contracts/libraries/Utils.sol


46                  codeLengthInWords = uint256(uint8(_bytecodeHash[2])) * 256 + uint256(uint8(_bytecodeHash[3]));


46                  codeLengthInWords = uint256(uint8(_bytecodeHash[2])) * 256 + uint256(uint8(_bytecodeHash[3]));


52              return _bytecodeHash[1] == 0x00;


57              return _bytecodeHash[1] == 0x01;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L57:57

</details>

## NC058 - Zero as a function argument should have a descriptive meaning:

Consider using descriptive constants or an enum instead of passing zero directly on function calls, as that might be error-prone, to fully describe the caller's intention.


<details>
<summary>Click to show 114 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


223                     factoryDeps: new bytes[](0),


258                 bytes memory decimals = abi.encode(uint8(18));


503             (uint32 functionSignature, uint256 offset) = UnsafeBytes.readUint32(_l2ToL1message, 0);


584                 L2TransactionRequestDirect memory request = L2TransactionRequestDirect({
585                     chainId: ERA_CHAIN_ID,
586                     l2Contract: l2BridgeAddress[ERA_CHAIN_ID],
587                     mintValue: msg.value, // l2 gas + l2 msg.Value the bridgehub will withdraw the mintValue from the base token bridge for gas
588                     l2Value: 0, // L2 msg.value, this contract doesn't support base token deposits or wrapping functionality, for direct deposits use bridgehub
589                     l2Calldata: l2TxCalldata,
590                     l2GasLimit: _l2TxGasLimit,
591                     l2GasPerPubdataByteLimit: _l2TxGasPerPubdataByte,
592                     factoryDeps: new bytes[](0),
593                     refundRecipient: refundRecipient
594                 });


592                     factoryDeps: new bytes[](0),


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L592:592

```solidity
File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol


41              require(version == 1 && _bytecodeHash[1] == bytes1(0), "zf"); // Incorrectly formatted bytecodeHash


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L41:41

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


22          uint256 internal constant EXECUTED_PROPOSAL_TIMESTAMP = uint256(1);


22          uint256 internal constant EXECUTED_PROPOSAL_TIMESTAMP = uint256(1);


50              emit ChangeMinDelay(0, _minDelay);


240             require(_predecessorId == bytes32(0) || isOperationDone(_predecessorId), "Predecessor operation not completed");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L240:240

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


90              IExecutor.StoredBatchInfo memory batchZero = IExecutor.StoredBatchInfo(
91                  0,
92                  _initializeData.genesisBatchHash,
93                  _initializeData.genesisIndexRepeatedStorageChanges,
94                  0,
95                  EMPTY_STRING_KECCAK,
96                  DEFAULT_L2_LOGS_TREE_ROOT_HASH,
97                  0,
98                  _initializeData.genesisBatchCommitment
99              );


182             L2CanonicalTransaction memory l2ProtocolUpgradeTx = L2CanonicalTransaction({
183                 txType: SYSTEM_UPGRADE_L2_TX_TYPE,
184                 from: uint256(uint160(L2_FORCE_DEPLOYER_ADDR)),
185                 to: uint256(uint160(L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR)),
186                 gasLimit: $(PRIORITY_TX_MAX_GAS_LIMIT),
187                 gasPerPubdataByteLimit: REQUIRED_L2_GAS_PRICE_PER_PUBDATA,
188                 maxFeePerGas: uint256(0),
189                 maxPriorityFeePerGas: uint256(0),
190                 paymaster: uint256(0),
191                 // Note, that the priority operation id is used as "nonce" for L1->L2 transactions
192                 nonce: protocolVersion,
193                 value: 0,
194                 reserved: [uint256(0), 0, 0, 0],
195                 data: systemContextCalldata,
196                 signature: new bytes(0),
197                 factoryDeps: uintEmptyArray,
198                 paymasterInput: new bytes(0),
199                 reservedDynamic: new bytes(0)
200             });


188                 maxFeePerGas: uint256(0),


189                 maxPriorityFeePerGas: uint256(0),


190                 paymaster: uint256(0),


194                 reserved: [uint256(0), 0, 0, 0],


196                 signature: new bytes(0),


198                 paymasterInput: new bytes(0),


199                 reservedDynamic: new bytes(0)


202             ProposedUpgrade memory proposedUpgrade = ProposedUpgrade({
203                 l2ProtocolUpgradeTx: l2ProtocolUpgradeTx,
204                 factoryDeps: bytesEmptyArray,
205                 bootloaderHash: bytes32(0),
206                 defaultAccountHash: bytes32(0),
207                 verifier: address(0),
208                 verifierParams: VerifierParams({
209                     recursionNodeLevelVkHash: bytes32(0),
210                     recursionLeafLevelVkHash: bytes32(0),
211                     recursionCircuitsSetVksHash: bytes32(0)
212                 }),
213                 l1ContractsUpgradeCalldata: new bytes(0),
214                 postUpgradeCalldata: new bytes(0),
215                 upgradeTimestamp: 0,
216                 newProtocolVersion: protocolVersion
217             });


205                 bootloaderHash: bytes32(0),


206                 defaultAccountHash: bytes32(0),


209                     recursionNodeLevelVkHash: bytes32(0),


210                     recursionLeafLevelVkHash: bytes32(0),


211                     recursionCircuitsSetVksHash: bytes32(0)


213                 l1ContractsUpgradeCalldata: new bytes(0),


214                 postUpgradeCalldata: new bytes(0),


277             DiamondProxy stateTransitionContract = new DiamondProxy{salt: bytes32(0)}(block.chainid, diamondCut);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L277:277

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


191             if (_expectedSystemContractUpgradeTxHash == bytes32(0)) {


237             if (systemContractsUpgradeTxHash == bytes32(0) || s.l2SystemContractsUpgradeBatchNumber != 0) {


258                 _lastCommittedBatchData = _commitOneBatch(_lastCommittedBatchData, _newBatchesData[i], bytes32(0));


291                 bytes32 expectedUpgradeTxHash = i == 0 ? _systemContractUpgradeTxHash : bytes32(0);


520                     uint64(0), // index repeated storage changes in zkPorter


521                     bytes32(0) // zkPorter batch hash


639                 require(blobVersionedHash != bytes32(0), "vh");


663             require(versionedHash == bytes32(0), "lh");


669                     (_blobHashes[i] == bytes32(0) && blobCommitments[i] == bytes32(0)) ||


669                     (_blobHashes[i] == bytes32(0) && blobCommitments[i] == bytes32(0)) ||


670                         (_blobHashes[i] != bytes32(0) && blobCommitments[i] != bytes32(0)),


670                         (_blobHashes[i] != bytes32(0) && blobCommitments[i] != bytes32(0)),


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L670:670

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


92              L2Log memory l2Log = L2Log({
93                  l2ShardId: 0,
94                  isService: true,
95                  txNumberInBatch: _l2TxNumberInBatch,
96                  sender: L2_BOOTLOADER_ADDRESS,
97                  key: _l2TxHash,
98                  value: bytes32(uint256(_status))
99              });


132                 L2Log({
133                     l2ShardId: 0,
134                     isService: true,
135                     txNumberInBatch: _message.txNumberInBatch,
136                     sender: L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR,
137                     key: bytes32(uint256(uint160(_message.sender))),
138                     value: keccak256(_message.data)
139                 });


301                 maxPriorityFeePerGas: uint256(0),


302                 paymaster: uint256(0),


308                 signature: new bytes(0),


310                 paymasterInput: new bytes(0),


311                 reservedDynamic: new bytes(0)


338                     layer2Tip: uint192(0) // TODO: Restore after fee modeling will be stable. (SMA-1230)


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L338:338

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol


83                  costForComputation += Math.ceilDiv(_encodingLength * L1_TX_DELTA_544_ENCODING_BYTES, 544);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L83:83

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


93              if (_l2DefaultAccountBytecodeHash == bytes32(0)) {


110             if (_l2BootloaderBytecodeHash == bytes32(0)) {


148                 _newVerifierParams.recursionNodeLevelVkHash == bytes32(0) &&


149                 _newVerifierParams.recursionLeafLevelVkHash == bytes32(0) &&


150                 _newVerifierParams.recursionCircuitsSetVksHash == bytes32(0)


187                 return bytes32(0);


249             require(s.l2SystemContractsUpgradeTxHash == bytes32(0), "Previous upgrade has not been finalized");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L249:249

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol


33              require(s.l2SystemContractsUpgradeTxHash == bytes32(0), "Previous upgrade has not been finalized");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L33:33

```solidity
File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol


22          uint160 constant offset = uint160(0x1111000000000000000000000000000000001111);


22          uint160 constant offset = uint160(0x1111000000000000000000000000000000001111);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L22:22

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


46              uint256 farCallAbi = getFarCallABI(
47                  0,
48                  0,
49                  dataStart,
50                  dataLength,
51                  gasLimit,
52                  // Only rollup is supported for now
53                  0,
54                  CalldataForwardingMode.UseHeap,
55                  false,
56                  true
57              );


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L46:57

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


56              require(_l2TokenProxyBytecodeHash != bytes32(0), "df");


58              require(_l2TokenProxyBytecodeHash != bytes32(0), "df");


64                  address l2StandardToken = address(new L2StandardERC20{salt: bytes32(0)}());


65                  l2TokenBeacon = new UpgradeableBeacon{salt: bytes32(0)}(l2StandardToken);


165             (bool success, bytes memory returndata) = SystemContractsCaller.systemCallWithReturndata(
166                 uint32(gasleft()),
167                 DEPLOYER_SYSTEM_CONTRACT,
168                 0,
169                 abi.encodeCall(
170                     IContractDeployer.create2,
171                     (salt, l2TokenProxyBytecodeHash, abi.encode(address(l2TokenBeacon), ""))
172                 )
173             );


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L165:173

```solidity
File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol


22          uint160 constant offset = uint160(0x1111000000000000000000000000000000001111);


22          uint160 constant offset = uint160(0x1111000000000000000000000000000000001111);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L22:22

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


176             bytes memory encodedAccessListLength = RLPEncoder.encodeListLen(0);


271             bytes memory encodedAccessListLength = RLPEncoder.encodeListLen(0);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L271:271

```solidity
File: system-contracts/contracts/Compressor.sol


121             uint256 numberOfInitialWrites = uint256(_compressedStateDiffs.readUint16(0));


129                 uint64 enumIndex = stateDiff.readUint64(84);


137                 bytes32 derivedKey = stateDiff.readBytes32(52);


138                 uint256 initValue = stateDiff.readUint256(92);


139                 uint256 finalValue = stateDiff.readUint256(124);


161                 uint64 enumIndex = stateDiff.readUint64(84);


166                 uint256 initValue = stateDiff.readUint256(92);


167                 uint256 finalValue = stateDiff.readUint256(124);


202                 uint256 dictionaryLen = uint256(_rawCompressedData.readUint16(0));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L202:202

```solidity
File: system-contracts/contracts/ContractDeployer.sol


264             require(_bytecodeHash != bytes32(0x0), "BytecodeHash cannot be zero");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L264:264

```solidity
File: system-contracts/contracts/DefaultAccount.sol


83              SystemContractsCaller.systemCallWithPropagatedRevert(
84                  uint32(gasleft()),
85                  address(NONCE_HOLDER_SYSTEM_CONTRACT),
86                  0,
87                  abi.encodeCall(INonceHolder.incrementMinNonceIfEquals, (_transaction.nonce))
88              );


94              bytes32 txHash = _suggestedSignedHash != bytes32(0) ? _suggestedSignedHash : _transaction.encodeHash();


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L94:94

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


76              require(version == 1 && _bytecodeHash[1] == bytes1(0), "Incorrectly formatted bytecodeHash");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L76:76

```solidity
File: system-contracts/contracts/L1Messenger.sol


75              L2ToL1Log memory l2ToL1Log = L2ToL1Log({
76                  l2ShardId: 0,
77                  isService: _isService,
78                  txNumberInBlock: SYSTEM_CONTEXT_CONTRACT.txNumberInBlock(),
79                  sender: msg.sender,
80                  key: _key,
81                  value: _value
82              });


89              uint256 gasToPay = keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) + 2 * keccakGasCost(64);


90              SystemContractHelper.burnGas(Utils.safeCastToU32(gasToPay), 0);


125             L2ToL1Log memory l2ToL1Log = L2ToL1Log({
126                 l2ShardId: 0,
127                 isService: true,
128                 txNumberInBlock: SYSTEM_CONTEXT_CONTRACT.txNumberInBlock(),
129                 sender: address(this),
130                 key: bytes32(uint256(uint160(msg.sender))),
131                 value: hash
132             });


150                 keccakGasCost(64) +


176                 keccakGasCost(64) +


329             chainedLogsHash = bytes32(0);


331             chainedMessagesHash = bytes32(0);


332             chainedL1BytecodesRevealDataHash = bytes32(0);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L332:332

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


26              value = SystemContractHelper.getExtraAbiData(0);


27              uint256 addressAsUint = SystemContractHelper.getExtraAbiData(1);


28              uint256 mask = SystemContractHelper.getExtraAbiData(2);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L28:28

```solidity
File: system-contracts/contracts/SystemContext.sol


145                 hash = bytes32(0);


322             currentL2BlockTxsRollingHash = bytes32(0);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L322:322

```solidity
File: system-contracts/contracts/libraries/EfficientCall.sol


265             uint256 farCallAbi = SystemContractsCaller.getFarCallABIWithEmptyFatPointer(
266                 gas,
267                 // Only rollup is supported for now
268                 0,
269                 CalldataForwardingMode.ForwardFatPointer,
270                 _isConstructor,
271                 _isSystem
272             );


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L265:272

```solidity
File: system-contracts/contracts/libraries/RLPEncoder.sol


13              encoded = new bytes(0x15);


27                      encoded = new bytes(1);


29                      encoded[0] = (_val == 0) ? bytes1(uint8(128)) : bytes1(uint8(_val));


51              return _encodeLength(_len, 0x80);


57              return _encodeLength(_len, 0xc0);


63                      encoded = new bytes(1);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L63:63

```solidity
File: system-contracts/contracts/libraries/SystemContractHelper.sol


228             pubdataPublished = uint32(extractNumberFromMeta(meta, META_GAS_PER_PUBDATA_BYTE_OFFSET, 32));


238             heapSize = uint32(extractNumberFromMeta(meta, META_HEAP_SIZE_OFFSET, 32));


247             auxHeapSize = uint32(extractNumberFromMeta(meta, META_AUX_HEAP_SIZE_OFFSET, 32));


255             shardId = uint8(extractNumberFromMeta(meta, META_SHARD_ID_OFFSET, 8));


264             callerShardId = uint8(extractNumberFromMeta(meta, META_CALLER_SHARD_ID_OFFSET, 8));


273             codeShardId = uint8(extractNumberFromMeta(meta, META_CODE_SHARD_ID_OFFSET, 8));


345             bool precompileCallSuccess = unsafePrecompileCall(
346                 0, // The precompile parameters are formal ones. We only need the precompile call to burn gas.
347                 _gasToPay,
348                 _pubdataToSpend
349             );


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L345:349

```solidity
File: system-contracts/contracts/libraries/SystemContractsCaller.sol


85              uint256 farCallAbi = SystemContractsCaller.getFarCallABI(
86                  0,
87                  0,
88                  dataStart,
89                  dataLength,
90                  gasLimit,
91                  // Only rollup is supported for now
92                  0,
93                  CalldataForwardingMode.UseHeap,
94                  false,
95                  true
96              );


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L85:96

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


261             bytes memory encodedAccessListLength = RLPEncoder.encodeListLen(0);


333             bytes memory encodedAccessListLength = RLPEncoder.encodeListLen(0);


382                     IERC20(token).safeApprove(paymaster, 0);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L382:382

</details>

## NC059 - Function names should differ to make the code more readable:

In Solidity, while function overriding allows for functions with the same name to coexist, it is advisable to avoid this practice to enhance code readability and maintainability. Having multiple functions with the same name, even with different parameters or in inherited contracts, can cause confusion and increase the likelihood of errors during development, testing, and debugging. Using distinct and descriptive function names not only clarifies the purpose and behavior of each function, but also helps prevent unintended function calls or incorrect overriding. By adopting a clear and consistent naming convention, developers can create more comprehensible and maintainable smart contracts.


<details>
<summary>Click to show 480 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


    function initialize() external reentrancyGuardInitializer {}

    function tranferTokenToSharedBridge(address _token, uint256 _amount) external {
        require(msg.sender == address(sharedBridge), "Not shared bridge");
        uint256 amount = IERC20(_token).balanceOf(address(this));
        require(amount == _amount, "Incorrect amount");
        IERC20(_token).safeTransfer(address(sharedBridge), amount);
    }

    function l2TokenAddress(address _l1Token) external view returns (address) {
        bytes32 constructorInputHash = keccak256(abi.encode(l2TokenBeacon, ""));
        bytes32 salt = bytes32(uint256(uint160(_l1Token)));

        return L2ContractHelper.computeCreate2Address(l2Bridge, salt, l2TokenProxyBytecodeHash, constructorInputHash);
    }

    function deposit(
        address _l2Receiver,
        address _l1Token,
        uint256 _amount,
        uint256 _l2TxGasLimit,
        uint256 _l2TxGasPerPubdataByte
    ) external payable returns (bytes32 l2TxHash) {
        l2TxHash = deposit(_l2Receiver, _l1Token, _amount, _l2TxGasLimit, _l2TxGasPerPubdataByte, address(0));
    }

    function deposit(
        address _l2Receiver,
        address _l1Token,
        uint256 _amount,
        uint256 _l2TxGasLimit,
        uint256 _l2TxGasPerPubdataByte,
        address _refundRecipient
    ) public payable nonReentrant returns (bytes32 l2TxHash) {
        require(_amount != 0, "0T"); // empty deposit
        uint256 amount = _depositFundsToSharedBridge(msg.sender, IERC20(_l1Token), _amount);
        require(amount == _amount, "3T"); // The token has non-standard transfer logic

        l2TxHash = sharedBridge.depositLegacyErc20Bridge{value: msg.value}(
            msg.sender,
            _l2Receiver,
            _l1Token,
            _amount,
            _l2TxGasLimit,
            _l2TxGasPerPubdataByte,
            _refundRecipient
        );
        depositAmount[msg.sender][_l1Token][l2TxHash] = _amount;
        emit DepositInitiated(l2TxHash, msg.sender, _l2Receiver, _l1Token, _amount);
    }

    function claimFailedDeposit(
        address _depositSender,
        address _l1Token,
        bytes32 _l2TxHash,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes32[] calldata _merkleProof
    ) external nonReentrant {
        uint256 amount = depositAmount[_depositSender][_l1Token][_l2TxHash];
        require(amount != 0, "2T"); // empty deposit
        delete depositAmount[_depositSender][_l1Token][_l2TxHash];

        sharedBridge.claimFailedDepositLegacyErc20Bridge(
            _depositSender,
            _l1Token,
            amount,
            _l2TxHash,
            _l2BatchNumber,
            _l2MessageIndex,
            _l2TxNumberInBatch,
            _merkleProof
        );
        emit ClaimedFailedDeposit(_depositSender, _l1Token, amount);
    }

    function finalizeWithdrawal(
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external nonReentrant {
        require(!isWithdrawalFinalized[_l2BatchNumber][_l2MessageIndex], "pw");
        // We don't need to set finalizeWithdrawal here, as we set it in the shared bridge

        (address l1Receiver, address l1Token, uint256 amount) = sharedBridge.finalizeWithdrawalLegacyErc20Bridge(
            _l2BatchNumber,
            _l2MessageIndex,
            _l2TxNumberInBatch,
            _message,
            _merkleProof
        );
        emit WithdrawalFinalized(l1Receiver, l1Token, amount);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L208:226

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


    function initialize(
        address _owner,
        uint256 _eraFirstPostUpgradeBatch
    ) external reentrancyGuardInitializer initializer {
        require(_owner != address(0), "ShB owner 0");
        _transferOwnership(_owner);

        eraFirstPostUpgradeBatch = _eraFirstPostUpgradeBatch;
        l2BridgeAddress[ERA_CHAIN_ID] = ERA_ERC20_BRIDGE_ADDRESS;
    }

    function claimFailedDeposit(
        uint256 _chainId,
        address _depositSender,
        address _l1Token,
        uint256 _amount,
        bytes32 _l2TxHash,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes32[] calldata _merkleProof
    ) external override {
        _claimFailedDeposit(
            false,
            _chainId,
            _depositSender,
            _l1Token,
            _amount,
            _l2TxHash,
            _l2BatchNumber,
            _l2MessageIndex,
            _l2TxNumberInBatch,
            _merkleProof
        );
    }

    function finalizeWithdrawal(
        uint256 _chainId,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external override {
        // To avoid rewithdrawing txs that have already happened on the legacy bridge.
        // Note: new withdraws are all recorded here, so double withdrawing them is not possible.
        if (_isEraLegacyWithdrawal(_chainId, _l2BatchNumber)) {
            require(!legacyBridge.isWithdrawalFinalized(_l2BatchNumber, _l2MessageIndex), "ShB: legacy withdrawal");
        }
        _finalizeWithdrawal(_chainId, _l2BatchNumber, _l2MessageIndex, _l2TxNumberInBatch, _message, _merkleProof);
    }

    function receiveEth(uint256 _chainId) external payable {
        require(bridgehub.getStateTransition(_chainId) == msg.sender, "receiveEth not state transition");
    }

    function bridgehubDepositBaseToken(
        uint256 _chainId,
        address _prevMsgSender,
        address _l1Token,
        uint256 _amount
    ) external payable virtual onlyBridgehubOrEra(_chainId) {
        if (_l1Token == ETH_TOKEN_ADDRESS) {
            require(msg.value == _amount, "L1SharedBridge: msg.value not equal to amount");
        } else {
            // The Bridgehub also checks this, but we want to be sure
            require(msg.value == 0, "ShB m.v > 0 b d.it");

            uint256 amount = _depositFunds(_prevMsgSender, IERC20(_l1Token), _amount); // note if _prevMsgSender is this contract, this will return 0. This does not happen.
            require(amount == _amount, "3T"); // The token has non-standard transfer logic
        }

        if (!hyperbridgingEnabled[_chainId]) {
            chainBalance[_chainId][_l1Token] += _amount;
        }
        // Note that we don't save the deposited amount, as this is for the base token, which gets sent to the refundRecipient if the tx fails
        emit BridgehubDepositBaseTokenInitiated(_chainId, _prevMsgSender, _l1Token, _amount);
    }

    function bridgehubDeposit(
        uint256 _chainId,
        address _prevMsgSender,
        uint256, // l2Value, needed for Weth deposits in the future
        bytes calldata _data
    ) external payable override onlyBridgehub returns (L2TransactionRequestTwoBridgesInner memory request) {
        require(l2BridgeAddress[_chainId] != address(0), "ShB l2 bridge not deployed");

        (address _l1Token, uint256 _depositAmount, address _l2Receiver) = abi.decode(
            _data,
            (address, uint256, address)
        );
        require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported");
        require(bridgehub.baseToken(_chainId) != _l1Token, "ShB: baseToken deposit not supported");

        uint256 amount;
        if (_l1Token == ETH_TOKEN_ADDRESS) {
            amount = msg.value;
            require(_depositAmount == 0, "ShB wrong withdraw amount");
        } else {
            require(msg.value == 0, "ShB m.v > 0 for BH d.it 2");
            amount = _depositAmount;

            uint256 withdrawAmount = _depositFunds(_prevMsgSender, IERC20(_l1Token), _depositAmount);
            require(withdrawAmount == _depositAmount, "5T"); // The token has non-standard transfer logic
        }
        require(amount != 0, "6T"); // empty deposit amount

        bytes32 txDataHash = keccak256(abi.encode(_prevMsgSender, _l1Token, amount));
        if (!hyperbridgingEnabled[_chainId]) {
            chainBalance[_chainId][_l1Token] += amount;
        }

        {
            // Request the finalization of the deposit on the L2 side
            bytes memory l2TxCalldata = _getDepositL2Calldata(_prevMsgSender, _l2Receiver, _l1Token, amount);

            request = L2TransactionRequestTwoBridgesInner({
                magicValue: TWO_BRIDGES_MAGIC_VALUE,
                l2Contract: l2BridgeAddress[_chainId],
                l2Calldata: l2TxCalldata,
                factoryDeps: new bytes[](0),
                txDataHash: txDataHash
            });
        }
        emit BridgehubDepositInitiated(_chainId, txDataHash, _prevMsgSender, _l2Receiver, _l1Token, amount);
    }

    function bridgehubConfirmL2Transaction(
        uint256 _chainId,
        bytes32 _txDataHash,
        bytes32 _txHash
    ) external override onlyBridgehub {
        require(depositHappened[_chainId][_txHash] == 0x00, "ShB tx hap");
        depositHappened[_chainId][_txHash] = _txDataHash;
        emit BridgehubDepositFinalized(_chainId, _txDataHash, _txHash);
    }

    function depositLegacyErc20Bridge(
        address _prevMsgSender,
        address _l2Receiver,
        address _l1Token,
        uint256 _amount,
        uint256 _l2TxGasLimit,
        uint256 _l2TxGasPerPubdataByte,
        address _refundRecipient
    ) external payable override onlyLegacyBridge nonReentrant returns (bytes32 l2TxHash) {
        require(l2BridgeAddress[ERA_CHAIN_ID] != address(0), "ShB b. n dep");
        require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported 2");

        // Note that funds have been transferred to this contract in the legacy ERC20 bridge.
        if (!hyperbridgingEnabled[ERA_CHAIN_ID]) {
            chainBalance[ERA_CHAIN_ID][_l1Token] += _amount;
        }

        bytes memory l2TxCalldata = _getDepositL2Calldata(_prevMsgSender, _l2Receiver, _l1Token, _amount);

        {
            // If the refund recipient is not specified, the refund will be sent to the sender of the transaction.
            // Otherwise, the refund will be sent to the specified address.
            // If the recipient is a contract on L1, the address alias will be applied.
            address refundRecipient = _refundRecipient;
            if (_refundRecipient == address(0)) {
                refundRecipient = _prevMsgSender != tx.origin
                    ? AddressAliasHelper.applyL1ToL2Alias(_prevMsgSender)
                    : _prevMsgSender;
            }

            L2TransactionRequestDirect memory request = L2TransactionRequestDirect({
                chainId: ERA_CHAIN_ID,
                l2Contract: l2BridgeAddress[ERA_CHAIN_ID],
                mintValue: msg.value, // l2 gas + l2 msg.Value the bridgehub will withdraw the mintValue from the base token bridge for gas
                l2Value: 0, // L2 msg.value, this contract doesn't support base token deposits or wrapping functionality, for direct deposits use bridgehub
                l2Calldata: l2TxCalldata,
                l2GasLimit: _l2TxGasLimit,
                l2GasPerPubdataByteLimit: _l2TxGasPerPubdataByte,
                factoryDeps: new bytes[](0),
                refundRecipient: refundRecipient
            });
            l2TxHash = bridgehub.requestL2TransactionDirect{value: msg.value}(request);
        }

        bytes32 txDataHash = keccak256(abi.encode(_prevMsgSender, _l1Token, _amount));
        // Save the deposited amount to claim funds on L1 if the deposit failed on L2
        depositHappened[ERA_CHAIN_ID][l2TxHash] = txDataHash;

        emit LegacyDepositInitiated(ERA_CHAIN_ID, l2TxHash, _prevMsgSender, _l2Receiver, _l1Token, _amount);
    }

    function finalizeWithdrawalLegacyErc20Bridge(
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external override onlyLegacyBridge returns (address l1Receiver, address l1Token, uint256 amount) {
        (l1Receiver, l1Token, amount) = _finalizeWithdrawal(
            ERA_CHAIN_ID,
            _l2BatchNumber,
            _l2MessageIndex,
            _l2TxNumberInBatch,
            _message,
            _merkleProof
        );
    }

    function claimFailedDepositLegacyErc20Bridge(
        address _depositSender,
        address _l1Token,
        uint256 _amount,
        bytes32 _l2TxHash,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes32[] calldata _merkleProof
    ) external override onlyLegacyBridge {
        _claimFailedDeposit(
            true,
            ERA_CHAIN_ID,
            _depositSender,
            _l1Token,
            _amount,
            _l2TxHash,
            _l2BatchNumber,
            _l2MessageIndex,
            _l2TxNumberInBatch,
            _merkleProof
        );
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L644:666

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


    function initialize(address _owner) external reentrancyGuardInitializer {
        _transferOwnership(_owner);
    }

    function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin {
        // Save previous value into the stack to put it into the event later
        address oldPendingAdmin = pendingAdmin;
        // Change pending admin
        pendingAdmin = _newPendingAdmin;
        emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
    }

    function acceptAdmin() external {
        address currentPendingAdmin = pendingAdmin;
        require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights

        address previousAdmin = admin;
        admin = currentPendingAdmin;
        delete pendingAdmin;

        emit NewPendingAdmin(currentPendingAdmin, address(0));
        emit NewAdmin(previousAdmin, pendingAdmin);
    }

    function getStateTransition(uint256 _chainId) public view returns (address) {
        return IStateTransitionManager(stateTransitionManager[_chainId]).stateTransition(_chainId);
    }

    function addStateTransitionManager(address _stateTransitionManager) external onlyOwner {
        require(
            !stateTransitionManagerIsRegistered[_stateTransitionManager],
            "Bridgehub: state transition already registered"
        );
        stateTransitionManagerIsRegistered[_stateTransitionManager] = true;
    }

    function removeStateTransitionManager(address _stateTransitionManager) external onlyOwner {
        require(
            stateTransitionManagerIsRegistered[_stateTransitionManager],
            "Bridgehub: state transition not registered yet"
        );
        stateTransitionManagerIsRegistered[_stateTransitionManager] = false;
    }

    function addToken(address _token) external onlyOwner {
        require(!tokenIsRegistered[_token], "Bridgehub: token already registered");
        tokenIsRegistered[_token] = true;
    }

    function setSharedBridge(address _sharedBridge) external onlyOwner {
        sharedBridge = IL1SharedBridge(_sharedBridge);
    }

    function createNewChain(
        uint256 _chainId,
        address _stateTransitionManager,
        address _baseToken,
        uint256, //_salt
        address _admin,
        bytes calldata _initData
    ) external onlyOwnerOrAdmin nonReentrant returns (uint256 chainId) {
        require(_chainId != 0, "Bridgehub: chainId cannot be 0");
        require(_chainId <= type(uint48).max, "Bridgehub: chainId too large");

        require(
            stateTransitionManagerIsRegistered[_stateTransitionManager],
            "Bridgehub: state transition not registered"
        );
        require(tokenIsRegistered[_baseToken], "Bridgehub: token not registered");
        require(address(sharedBridge) != address(0), "Bridgehub: weth bridge not set");

        require(stateTransitionManager[_chainId] == address(0), "Bridgehub: chainId already registered");

        stateTransitionManager[_chainId] = _stateTransitionManager;
        baseToken[_chainId] = _baseToken;

        IStateTransitionManager(_stateTransitionManager).createNewChain(
            _chainId,
            _baseToken,
            address(sharedBridge),
            _admin,
            _initData
        );

        emit NewChain(_chainId, _stateTransitionManager, _admin);
        return _chainId;
    }

    function proveL2MessageInclusion(
        uint256 _chainId,
        uint256 _batchNumber,
        uint256 _index,
        L2Message calldata _message,
        bytes32[] calldata _proof
    ) external view override returns (bool) {
        address stateTransition = getStateTransition(_chainId);
        return IZkSyncStateTransition(stateTransition).proveL2MessageInclusion(_batchNumber, _index, _message, _proof);
    }

    function proveL2LogInclusion(
        uint256 _chainId,
        uint256 _batchNumber,
        uint256 _index,
        L2Log memory _log,
        bytes32[] calldata _proof
    ) external view override returns (bool) {
        address stateTransition = getStateTransition(_chainId);
        return IZkSyncStateTransition(stateTransition).proveL2LogInclusion(_batchNumber, _index, _log, _proof);
    }

    function proveL1ToL2TransactionStatus(
        uint256 _chainId,
        bytes32 _l2TxHash,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes32[] calldata _merkleProof,
        TxStatus _status
    ) external view override returns (bool) {
        address stateTransition = getStateTransition(_chainId);
        return
            IZkSyncStateTransition(stateTransition).proveL1ToL2TransactionStatus(
                _l2TxHash,
                _l2BatchNumber,
                _l2MessageIndex,
                _l2TxNumberInBatch,
                _merkleProof,
                _status
            );
    }

    function l2TransactionBaseCost(
        uint256 _chainId,
        uint256 _gasPrice,
        uint256 _l2GasLimit,
        uint256 _l2GasPerPubdataByteLimit
    ) external view returns (uint256) {
        address stateTransition = getStateTransition(_chainId);
        return
            IZkSyncStateTransition(stateTransition).l2TransactionBaseCost(
                _gasPrice,
                _l2GasLimit,
                _l2GasPerPubdataByteLimit
            );
    }

    function requestL2TransactionDirect(
        L2TransactionRequestDirect calldata _request
    ) external payable override nonReentrant returns (bytes32 canonicalTxHash) {
        {
            address token = baseToken[_request.chainId];
            if (token == ETH_TOKEN_ADDRESS) {
                require(msg.value == _request.mintValue, "Bridgehub: msg.value mismatch 1");
            } else {
                require(msg.value == 0, "Bridgehub: non-eth bridge with msg.value");
            }

            sharedBridge.bridgehubDepositBaseToken{value: msg.value}(
                _request.chainId,
                msg.sender,
                token,
                _request.mintValue
            );
        }

        address stateTransition = getStateTransition(_request.chainId);
        address refundRecipient = _actualRefundRecipient(_request.refundRecipient);
        canonicalTxHash = IZkSyncStateTransition(stateTransition).bridgehubRequestL2Transaction(
            BridgehubL2TransactionRequest({
                sender: msg.sender,
                contractL2: _request.l2Contract,
                mintValue: _request.mintValue,
                l2Value: _request.l2Value,
                l2Calldata: _request.l2Calldata,
                l2GasLimit: _request.l2GasLimit,
                l2GasPerPubdataByteLimit: _request.l2GasPerPubdataByteLimit,
                factoryDeps: _request.factoryDeps,
                refundRecipient: refundRecipient
            })
        );
    }

    function requestL2TransactionTwoBridges(
        L2TransactionRequestTwoBridgesOuter calldata _request
    ) external payable override nonReentrant returns (bytes32 canonicalTxHash) {
        {
            address token = baseToken[_request.chainId];
            uint256 baseTokenMsgValue;
            if (token == ETH_TOKEN_ADDRESS) {
                require(
                    msg.value == _request.mintValue + _request.secondBridgeValue,
                    "Bridgehub: msg.value mismatch 2"
                );
                baseTokenMsgValue = _request.mintValue;
            } else {
                require(msg.value == _request.secondBridgeValue, "Bridgehub: msg.value mismatch 3");
                baseTokenMsgValue = 0;
            }
            sharedBridge.bridgehubDepositBaseToken{value: baseTokenMsgValue}(
                _request.chainId,
                msg.sender,
                token,
                _request.mintValue
            );
        }

        address stateTransition = getStateTransition(_request.chainId);

        L2TransactionRequestTwoBridgesInner memory outputRequest = IL1SharedBridge(_request.secondBridgeAddress)
            .bridgehubDeposit{value: _request.secondBridgeValue}(
            _request.chainId,
            msg.sender,
            _request.l2Value,
            _request.secondBridgeCalldata
        );

        require(outputRequest.magicValue == TWO_BRIDGES_MAGIC_VALUE, "Bridgehub: magic value mismatch");

        address refundRecipient = _actualRefundRecipient(_request.refundRecipient);

        require(
            _request.secondBridgeAddress > BRIDGEHUB_MIN_SECOND_BRIDGE_ADDRESS,
            "Bridgehub: second bridge address too low"
        ); // to avoid calls to precompiles
        canonicalTxHash = IZkSyncStateTransition(stateTransition).bridgehubRequestL2Transaction(
            BridgehubL2TransactionRequest({
                sender: _request.secondBridgeAddress,
                contractL2: outputRequest.l2Contract,
                mintValue: _request.mintValue,
                l2Value: _request.l2Value,
                l2Calldata: outputRequest.l2Calldata,
                l2GasLimit: _request.l2GasLimit,
                l2GasPerPubdataByteLimit: _request.l2GasPerPubdataByteLimit,
                factoryDeps: outputRequest.factoryDeps,
                refundRecipient: refundRecipient
            })
        );

        IL1SharedBridge(_request.secondBridgeAddress).bridgehubConfirmL2Transaction(
            _request.chainId,
            outputRequest.txDataHash,
            canonicalTxHash
        );
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L262:323

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


    function initialize(StateTransitionManagerInitializeData calldata _initalizeData) external;

    function bridgehub() external view returns (address);

    function setPendingAdmin(address _newPendingAdmin) external;

    function acceptAdmin() external;

    function createNewChain(
        uint256 _chainId,
        address _baseToken,
        address _sharedBridge,
        address _admin,
        bytes calldata _diamondCut
    ) external;

    function setInitialCutHash(Diamond.DiamondCutData calldata _diamondCut) external;

    function setValidatorTimelock(address _validatorTimelock) external;

    function getChainAdmin(uint256 _chainId) external view returns (address);

    function registerAlreadyDeployedStateTransition(uint256 _chainId, address _stateTransitionContract) external;

    function setNewVersionUpgrade(
        Diamond.DiamondCutData calldata _cutData,
        uint256 _oldProtocolVersion,
        uint256 _newProtocolVersion
    ) external;

    function setUpgradeDiamondCut(Diamond.DiamondCutData calldata _cutData, uint256 _oldProtocolVersion) external;

    function freezeChain(uint256 _chainId) external;

    function unfreezeChain(uint256 _chainId) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L94:94

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


    function initialize(
        StateTransitionManagerInitializeData calldata _initializeData
    ) external reentrancyGuardInitializer {
        require(_initializeData.governor != address(0), "StateTransition: governor zero");
        _transferOwnership(_initializeData.governor);

        genesisUpgrade = _initializeData.genesisUpgrade;
        protocolVersion = _initializeData.protocolVersion;
        validatorTimelock = _initializeData.validatorTimelock;

        // We need to initialize the state hash because it is used in the commitment of the next batch
        IExecutor.StoredBatchInfo memory batchZero = IExecutor.StoredBatchInfo(
            0,
            _initializeData.genesisBatchHash,
            _initializeData.genesisIndexRepeatedStorageChanges,
            0,
            EMPTY_STRING_KECCAK,
            DEFAULT_L2_LOGS_TREE_ROOT_HASH,
            0,
            _initializeData.genesisBatchCommitment
        );
        storedBatchZero = keccak256(abi.encode(batchZero));

        initialCutHash = keccak256(abi.encode(_initializeData.diamondCut));

        // While this does not provide a protection in the production, it is needed for local testing
        // Length of the L2Log encoding should not be equal to the length of other L2Logs' tree nodes preimages
        assert(L2_TO_L1_LOG_SERIALIZE_SIZE != 2 * 32);
    }

    function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin {
        // Save previous value into the stack to put it into the event later
        address oldPendingAdmin = pendingAdmin;
        // Change pending admin
        pendingAdmin = _newPendingAdmin;
        emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
    }

    function acceptAdmin() external {
        address currentPendingAdmin = pendingAdmin;
        require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights

        address previousAdmin = admin;
        admin = currentPendingAdmin;
        delete pendingAdmin;

        emit NewPendingAdmin(currentPendingAdmin, address(0));
        emit NewAdmin(previousAdmin, pendingAdmin);
    }

    function createNewChain(
        uint256 _chainId,
        address _baseToken,
        address _sharedBridge,
        address _admin,
        bytes calldata _diamondCut
    ) external onlyBridgehub {
        if (stateTransition[_chainId] != address(0)) {
            // StateTransition chain already registered
            return;
        }

        // check not registered
        Diamond.DiamondCutData memory diamondCut = abi.decode(_diamondCut, (Diamond.DiamondCutData));

        // check input
        bytes32 cutHashInput = keccak256(_diamondCut);
        require(cutHashInput == initialCutHash, "StateTransition: initial cutHash mismatch");

        // construct init data
        bytes memory initData;
        /// all together 4+9*32=292 bytes
        initData = bytes.concat(
            IDiamondInit.initialize.selector,
            bytes32(_chainId),
            bytes32(uint256(uint160(bridgehub))),
            bytes32(uint256(uint160(address(this)))),
            bytes32(uint256(protocolVersion)),
            bytes32(uint256(uint160(_admin))),
            bytes32(uint256(uint160(validatorTimelock))),
            bytes32(uint256(uint160(_baseToken))),
            bytes32(uint256(uint160(_sharedBridge))),
            bytes32(storedBatchZero),
            diamondCut.initCalldata
        );

        diamondCut.initCalldata = initData;
        // deploy stateTransitionContract
        DiamondProxy stateTransitionContract = new DiamondProxy{salt: bytes32(0)}(block.chainid, diamondCut);

        // save data
        address stateTransitionAddress = address(stateTransitionContract);

        stateTransition[_chainId] = stateTransitionAddress;

        // set chainId in VM
        _setChainIdUpgrade(_chainId, stateTransitionAddress);

        emit StateTransitionNewChain(_chainId, stateTransitionAddress);
    }

    function setInitialCutHash(Diamond.DiamondCutData calldata _diamondCut) external onlyOwner {
        initialCutHash = keccak256(abi.encode(_diamondCut));
    }

    function setValidatorTimelock(address _validatorTimelock) external onlyOwnerOrAdmin {
        validatorTimelock = _validatorTimelock;
    }

    function getChainAdmin(uint256 _chainId) external view override returns (address) {
        return IZkSyncStateTransition(stateTransition[_chainId]).getAdmin();
    }

    function registerAlreadyDeployedStateTransition(
        uint256 _chainId,
        address _stateTransitionContract
    ) external onlyOwner {
        stateTransition[_chainId] = _stateTransitionContract;
        emit StateTransitionNewChain(_chainId, _stateTransitionContract);
    }

    function setNewVersionUpgrade(
        Diamond.DiamondCutData calldata _cutData,
        uint256 _oldProtocolVersion,
        uint256 _newProtocolVersion
    ) external onlyOwner {
        upgradeCutHash[_oldProtocolVersion] = keccak256(abi.encode(_cutData));
        protocolVersion = _newProtocolVersion;
    }

    function setUpgradeDiamondCut(
        Diamond.DiamondCutData calldata _cutData,
        uint256 _oldProtocolVersion
    ) external onlyOwner {
        upgradeCutHash[_oldProtocolVersion] = keccak256(abi.encode(_cutData));
    }

    function freezeChain(uint256 _chainId) external onlyOwner {
        IZkSyncStateTransition(stateTransition[_chainId]).freezeDiamond();
    }

    function unfreezeChain(uint256 _chainId) external onlyOwner {
        IZkSyncStateTransition(stateTransition[_chainId]).freezeDiamond();
    }

    function revertBatches(uint256 _chainId, uint256 _newLastBatch) external onlyOwnerOrAdmin {
        IZkSyncStateTransition(stateTransition[_chainId]).revertBatches(_newLastBatch);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L170:172

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


    function initialize(InitializeData calldata _initializeData) external reentrancyGuardInitializer returns (bytes32) {
        require(address(_initializeData.verifier) != address(0), "vt");
        require(_initializeData.admin != address(0), "vy");
        require(_initializeData.validatorTimelock != address(0), "hc");
        require(_initializeData.priorityTxMaxGasLimit <= MAX_GAS_PER_TRANSACTION, "vu");

        s.chainId = _initializeData.chainId;
        s.bridgehub = _initializeData.bridgehub;
        s.stateTransitionManager = _initializeData.stateTransitionManager;
        s.baseToken = _initializeData.baseToken;
        s.baseTokenBridge = _initializeData.baseTokenBridge;
        s.protocolVersion = _initializeData.protocolVersion;

        s.verifier = _initializeData.verifier;
        s.admin = _initializeData.admin;
        s.validators[_initializeData.validatorTimelock] = true;

        s.storedBatchHashes[0] = _initializeData.storedBatchZero;
        s.verifierParams = _initializeData.verifierParams;
        s.l2BootloaderBytecodeHash = _initializeData.l2BootloaderBytecodeHash;
        s.l2DefaultAccountBytecodeHash = _initializeData.l2DefaultAccountBytecodeHash;
        s.priorityTxMaxGasLimit = _initializeData.priorityTxMaxGasLimit;
        s.feeParams = _initializeData.feeParams;
        s.blobVersionedHashRetriever = _initializeData.blobVersionedHashRetriever;

        // While this does not provide a protection in the production, it is needed for local testing
        // Length of the L2Log encoding should not be equal to the length of other L2Logs' tree nodes preimages
        assert(L2_TO_L1_LOG_SERIALIZE_SIZE != 2 * 32);

        return Diamond.DIAMOND_INIT_SUCCESS_RETURN_VALUE;
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L24:54

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol


    function initialize(InitializeData calldata _initData) external returns (bytes32);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L62:62

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


    function initialize(
        address _l1Bridge,
        address _l1LegecyBridge,
        bytes32 _l2TokenProxyBytecodeHash,
        address _aliasedOwner
    ) external reinitializer(2) {
        require(_l1Bridge != address(0), "bf");
        require(_l2TokenProxyBytecodeHash != bytes32(0), "df");
        require(_aliasedOwner != address(0), "sf");
        require(_l2TokenProxyBytecodeHash != bytes32(0), "df");

        l1Bridge = _l1Bridge;
        l2TokenProxyBytecodeHash = _l2TokenProxyBytecodeHash;

        if (block.chainid != ERA_CHAIN_ID) {
            address l2StandardToken = address(new L2StandardERC20{salt: bytes32(0)}());
            l2TokenBeacon = new UpgradeableBeacon{salt: bytes32(0)}(l2StandardToken);
            l2TokenBeacon.transferOwnership(_aliasedOwner);
        } else {
            require(_l1LegecyBridge != address(0), "bf2");
            // l2StandardToken and l2TokenBeacon are already deployed on ERA, and stored in the proxy
        }
    }

    function l2TokenAddress(address _l1Token) public view override returns (address) {
        bytes32 constructorInputHash = keccak256(abi.encode(address(l2TokenBeacon), ""));
        bytes32 salt = _getCreate2Salt(_l1Token);
        return
            L2ContractHelper.computeCreate2Address(address(this), salt, l2TokenProxyBytecodeHash, constructorInputHash);
    }

    function finalizeDeposit(
        address _l1Sender,
        address _l2Receiver,
        address _l1Token,
        uint256 _amount,
        bytes calldata _data
    ) external payable override {
        // Only the L1 bridge counterpart can initiate and finalize the deposit.
        require(
            AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1Bridge ||
                AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1LegacyBridge,
            "mq"
        );
        require(msg.value == 0, "Value should be 0 for ERC20 bridge");

        address expectedL2Token = l2TokenAddress(_l1Token);
        address currentL1Token = l1TokenAddress[expectedL2Token];
        if (currentL1Token == address(0)) {
            address deployedToken = _deployL2Token(_l1Token, _data);
            require(deployedToken == expectedL2Token, "mt");
            l1TokenAddress[expectedL2Token] = _l1Token;
        } else {
            require(currentL1Token == _l1Token, "gg"); // Double check that the expected value equal to real one
        }

        IL2StandardToken(expectedL2Token).bridgeMint(_l2Receiver, _amount);
        emit FinalizeDeposit(_l1Sender, _l2Receiver, expectedL2Token, _amount);
    }

    function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external override {
        require(_amount > 0, "Amount cannot be zero");

        IL2StandardToken(_l2Token).bridgeBurn(msg.sender, _amount);

        address l1Token = l1TokenAddress[_l2Token];
        require(l1Token != address(0), "yh");

        bytes memory message = _getL1WithdrawMessage(_l1Receiver, l1Token, _amount);
        L2ContractHelper.sendMessageToL1(message);

        emit WithdrawalInitiated(msg.sender, _l1Receiver, _l2Token, _amount);
    }

    function _getL1WithdrawMessage(
        address _to,
        address _l1Token,
        uint256 _amount
    ) internal pure returns (bytes memory) {
        // note we use the IL1ERC20Bridge.finalizeWithdrawal function selector to specify the selector for L1<>L2 messages,
        // and we use this interface so that when the switch happened the old messages could be processed
        return abi.encodePacked(IL1ERC20Bridge.finalizeWithdrawal.selector, _to, _l1Token, _amount);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L138:146

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol


    function tranferTokenToSharedBridge(address _token, uint256 _amount) external;

    function l2TokenAddress(address _l1Token) external view returns (address);

    function deposit(
        address _l2Receiver,
        address _l1Token,
        uint256 _amount,
        uint256 _l2TxGasLimit,
        uint256 _l2TxGasPerPubdataByte,
        address _refundRecipient
    ) external payable returns (bytes32 txHash);

    function deposit(
        address _l2Receiver,
        address _l1Token,
        uint256 _amount,
        uint256 _l2TxGasLimit,
        uint256 _l2TxGasPerPubdataByte
    ) external payable returns (bytes32 txHash);

    function claimFailedDeposit(
        address _depositSender,
        address _l1Token,
        bytes32 _l2TxHash,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes32[] calldata _merkleProof
    ) external;

    function finalizeWithdrawal(
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external;

    function isWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool);

    function sharedBridge() external view returns (IL1SharedBridge);

    function l2Bridge() external view returns (address);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L67:67

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol


    function l2TokenAddress(address _l1Token) external view returns (address);

    function finalizeDeposit(
        address _l1Sender,
        address _l2Receiver,
        address _l1Token,
        uint256 _amount,
        bytes calldata _data
    ) external payable;

    function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external;

    function l1TokenAddress(address _l2Token) external view returns (address);

    function l1Bridge() external view returns (address);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L21:21

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol


    function l2TokenAddress(address _l1Token) external view returns (address);

    function finalizeDeposit(
        address _l1Sender,
        address _l2Receiver,
        address _l1Token,
        uint256 _amount,
        bytes calldata _data
    ) external payable;

    function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external;

    function l1TokenAddress(address _l2Token) external view returns (address);

    function l1Bridge() external view returns (address);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L38:38

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol


    function deposit() external payable;

    function withdraw(uint256 wad) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol#L7:7

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol


    function claimFailedDeposit(
        uint256 _chainId,
        address _depositSender,
        address _l1Token,
        uint256 _amount,
        bytes32 _l2TxHash,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes32[] calldata _merkleProof
    ) external;

    function finalizeWithdrawal(
        uint256 _chainId,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external;

    function receiveEth(uint256 _chainId) external payable;

    function bridgehubDepositBaseToken(
        uint256 _chainId,
        address _prevMsgSender,
        address _l1Token,
        uint256 _amount
    ) external payable;

    function bridgehubDeposit(
        uint256 _chainId,
        address _prevMsgSender,
        uint256 _l2Value,
        bytes calldata _data
    ) external payable returns (L2TransactionRequestTwoBridgesInner memory request);

    function bridgehubConfirmL2Transaction(uint256 _chainId, bytes32 _txDataHash, bytes32 _txHash) external;

    function depositLegacyErc20Bridge(
        address _msgSender,
        address _l2Receiver,
        address _l1Token,
        uint256 _amount,
        uint256 _l2TxGasLimit,
        uint256 _l2TxGasPerPubdataByte,
        address _refundRecipient
    ) external payable returns (bytes32 txHash);

    function finalizeWithdrawalLegacyErc20Bridge(
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external returns (address l1Receiver, address l1Token, uint256 amount);

    function claimFailedDepositLegacyErc20Bridge(
        address _depositSender,
        address _l1Token,
        uint256 _amount,
        bytes32 _l2TxHash,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes32[] calldata _merkleProof
    ) external;

    function isWithdrawalFinalized(
        uint256 _chainId,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex
    ) external view returns (bool);

    function bridgehub() external view returns (IBridgehub);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L116:116

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol


    function finalizeWithdrawal(
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L9:15

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol


    function finalizeWithdrawal(
        uint256 _chainId,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol#L9:16

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


    function sharedBridge() external view returns (IL1SharedBridge);

    function setPendingAdmin(address _newPendingAdmin) external;

    function acceptAdmin() external;

    function getStateTransition(uint256 _chainId) external view returns (address);

    function addStateTransitionManager(address _stateTransitionManager) external;

    function removeStateTransitionManager(address _stateTransitionManager) external;

    function addToken(address _token) external;

    function setSharedBridge(address _sharedBridge) external;

    function createNewChain(
        uint256 _chainId,
        address _stateTransitionManager,
        address _baseToken,
        uint256 _salt,
        address _admin,
        bytes calldata _initData
    ) external returns (uint256 chainId);

    function proveL2MessageInclusion(
        uint256 _chainId,
        uint256 _batchNumber,
        uint256 _index,
        L2Message calldata _message,
        bytes32[] calldata _proof
    ) external view returns (bool);

    function proveL2LogInclusion(
        uint256 _chainId,
        uint256 _batchNumber,
        uint256 _index,
        L2Log memory _log,
        bytes32[] calldata _proof
    ) external view returns (bool);

    function proveL1ToL2TransactionStatus(
        uint256 _chainId,
        bytes32 _l2TxHash,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes32[] calldata _merkleProof,
        TxStatus _status
    ) external view returns (bool);

    function l2TransactionBaseCost(
        uint256 _chainId,
        uint256 _gasPrice,
        uint256 _l2GasLimit,
        uint256 _l2GasPerPubdataByteLimit
    ) external view returns (uint256);

    function requestL2TransactionDirect(
        L2TransactionRequestDirect calldata _request
    ) external payable returns (bytes32 canonicalTxHash);

    function requestL2TransactionTwoBridges(
        L2TransactionRequestTwoBridgesOuter calldata _request
    ) external payable returns (bytes32 canonicalTxHash);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L103:105

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol


    function l2Bridge() external view returns (address);

    function bridgeMint(address _account, uint256 _amount) external;

    function bridgeBurn(address _account, uint256 _amount) external;

    function l1Address() external view returns (address);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L16:16

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


    function l2Bridge() external view returns (address);

    function bridgeMint(address _account, uint256 _amount) external;

    function bridgeBurn(address _account, uint256 _amount) external;

    function l1Address() external view returns (address);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L14:14

```solidity
File: system-contracts/contracts/L2BaseToken.sol


    function withdraw(address _l1Receiver) external payable override {
        uint256 amount = _burnMsgValue();

        // Send the L2 log, a user could use it as proof of the withdrawal
        bytes memory message = _getL1WithdrawMessage(_l1Receiver, amount);
        L1_MESSENGER_CONTRACT.sendToL1(message);

        emit Withdrawal(msg.sender, _l1Receiver, amount);
    }

    function withdrawWithMessage(address _l1Receiver, bytes memory _additionalData) external payable override {
        uint256 amount = _burnMsgValue();

        // Send the L2 log, a user could use it as proof of the withdrawal
        bytes memory message = _getExtendedWithdrawMessage(_l1Receiver, amount, msg.sender, _additionalData);
        L1_MESSENGER_CONTRACT.sendToL1(message);

        emit WithdrawalWithMessage(msg.sender, _l1Receiver, amount, _additionalData);
    }

    function _getL1WithdrawMessage(address _to, uint256 _amount) internal pure returns (bytes memory) {
        return abi.encodePacked(IMailbox.finalizeEthWithdrawal.selector, _to, _amount);
    }

    function name() external pure override returns (string memory) {
        return "Ether";
    }

    function symbol() external pure override returns (string memory) {
        return "ETH";
    }

    function decimals() external pure override returns (uint8) {
        return 18;
    }

    function transferFromTo(address _from, address _to, uint256 _amount) external override {
        require(
            msg.sender == MSG_VALUE_SYSTEM_CONTRACT ||
                msg.sender == address(DEPLOYER_SYSTEM_CONTRACT) ||
                msg.sender == BOOTLOADER_FORMAL_ADDRESS,
            "Only system contracts with special access can call this method"
        );

        uint256 fromBalance = balance[_from];
        require(fromBalance >= _amount, "Transfer amount exceeds balance");
        unchecked {
            balance[_from] = fromBalance - _amount;
            // Overflow not possible: the sum of all balances is capped by totalSupply, and the sum is preserved by
            // decrementing then incrementing.
            balance[_to] += _amount;
        }

        emit Transfer(_from, _to, _amount);
    }

    function balanceOf(uint256 _account) external view override returns (uint256) {
        return balance[address(uint160(_account))];
    }

    function mint(address _account, uint256 _amount) external override onlyCallFromBootloader {
        totalSupply += _amount;
        balance[_account] += _amount;
        emit Mint(_account, _amount);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L64:68

```solidity
File: system-contracts/contracts/interfaces/IBaseToken.sol


    function withdraw(address _l1Receiver) external payable;

    function withdrawWithMessage(address _l1Receiver, bytes calldata _additionalData) external payable;

    function name() external pure returns (string memory);

    function symbol() external pure returns (string memory);

    function decimals() external pure returns (uint8);

    function transferFromTo(address _from, address _to, uint256 _amount) external;

    function balanceOf(uint256) external view returns (uint256);

    function mint(address _account, uint256 _amount) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L18:18

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


    function setPendingAdmin(address _newPendingAdmin) external onlyAdmin {
        // Save previous value into the stack to put it into the event later
        address oldPendingAdmin = s.pendingAdmin;
        // Change pending admin
        s.pendingAdmin = _newPendingAdmin;
        emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
    }

    function acceptAdmin() external {
        address pendingAdmin = s.pendingAdmin;
        require(msg.sender == pendingAdmin, "n4"); // Only proposed by current admin address can claim the admin rights

        address previousAdmin = s.admin;
        s.admin = pendingAdmin;
        delete s.pendingAdmin;

        emit NewPendingAdmin(pendingAdmin, address(0));
        emit NewAdmin(previousAdmin, pendingAdmin);
    }

    function setValidator(address _validator, bool _active) external onlyStateTransitionManager {
        s.validators[_validator] = _active;
        emit ValidatorStatusUpdate(_validator, _active);
    }

    function setPorterAvailability(bool _zkPorterIsAvailable) external onlyStateTransitionManager {
        // Change the porter availability
        s.zkPorterIsAvailable = _zkPorterIsAvailable;
        emit IsPorterAvailableStatusUpdate(_zkPorterIsAvailable);
    }

    function setPriorityTxMaxGasLimit(uint256 _newPriorityTxMaxGasLimit) external onlyStateTransitionManager {
        require(_newPriorityTxMaxGasLimit <= MAX_GAS_PER_TRANSACTION, "n5");

        uint256 oldPriorityTxMaxGasLimit = s.priorityTxMaxGasLimit;
        s.priorityTxMaxGasLimit = _newPriorityTxMaxGasLimit;
        emit NewPriorityTxMaxGasLimit(oldPriorityTxMaxGasLimit, _newPriorityTxMaxGasLimit);
    }

    function changeFeeParams(FeeParams calldata _newFeeParams) external onlyAdminOrStateTransitionManager {
        // Double checking that the new fee params are valid, i.e.
        // the maximal pubdata per batch is not less than the maximal pubdata per priority transaction.
        require(_newFeeParams.maxPubdataPerBatch >= _newFeeParams.priorityTxMaxPubdata, "n6");

        FeeParams memory oldFeeParams = s.feeParams;
        s.feeParams = _newFeeParams;

        emit NewFeeParams(oldFeeParams, _newFeeParams);
    }

    function setTokenMultiplier(uint128 _nominator, uint128 _denominator) external onlyAdminOrStateTransitionManager {
        uint128 oldNominator = s.baseTokenGasPriceMultiplierNominator;
        uint128 oldDenominator = s.baseTokenGasPriceMultiplierDenominator;

        s.baseTokenGasPriceMultiplierNominator = _nominator;
        s.baseTokenGasPriceMultiplierDenominator = _denominator;

        emit NewBaseTokenMultiplier(oldNominator, oldDenominator, _nominator, _denominator);
    }

    function setValidiumMode(PubdataPricingMode _validiumMode) external onlyAdmin {
        require(s.totalBatchesCommitted == 0, "AdminFacet: set validium only after genesis"); // Validium mode can be set only before the first batch is committed
        s.feeParams.pubdataPricingMode = _validiumMode;
        emit ValidiumModeStatusUpdate(_validiumMode);
    }

    function upgradeChainFromVersion(
        uint256 _oldProtocolVersion,
        Diamond.DiamondCutData calldata _diamondCut
    ) external onlyAdminOrStateTransitionManager {
        bytes32 cutHashInput = keccak256(abi.encode(_diamondCut));
        require(
            cutHashInput == IStateTransitionManager(s.stateTransitionManager).upgradeCutHash(_oldProtocolVersion),
            "StateTransition: cutHash mismatch"
        );

        require(
            s.protocolVersion == _oldProtocolVersion,
            "StateTransition: protocolVersion mismatch in STC when upgrading"
        );
        Diamond.diamondCut(_diamondCut);
        emit ExecuteUpgrade(_diamondCut);
        require(
            s.protocolVersion > _oldProtocolVersion,
            "StateTransition: protocolVersion mismatch in STC after upgrading"
        );
    }

    function executeUpgrade(Diamond.DiamondCutData calldata _diamondCut) external onlyStateTransitionManager {
        Diamond.diamondCut(_diamondCut);
        emit ExecuteUpgrade(_diamondCut);
    }

    function freezeDiamond() external onlyAdminOrStateTransitionManager {
        Diamond.DiamondStorage storage diamondStorage = Diamond.getDiamondStorage();

        require(!diamondStorage.isFrozen, "a9"); // diamond proxy is frozen already
        diamondStorage.isFrozen = true;

        emit Freeze();
    }

    function unfreezeDiamond() external onlyAdminOrStateTransitionManager {
        Diamond.DiamondStorage storage diamondStorage = Diamond.getDiamondStorage();

        require(diamondStorage.isFrozen, "a7"); // diamond proxy is not frozen
        diamondStorage.isFrozen = false;

        emit Unfreeze();
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L143:150

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol


    function setPendingAdmin(address _newPendingAdmin) external;

    function acceptAdmin() external;

    function setValidator(address _validator, bool _active) external;

    function setPorterAvailability(bool _zkPorterIsAvailable) external;

    function setPriorityTxMaxGasLimit(uint256 _newPriorityTxMaxGasLimit) external;

    function changeFeeParams(FeeParams calldata _newFeeParams) external;

    function setTokenMultiplier(uint128 _nominator, uint128 _denominator) external;

    function setValidiumMode(PubdataPricingMode _validiumMode) external;

    function upgradeChainFromVersion(uint256 _protocolVersion, Diamond.DiamondCutData calldata _cutData) external;

    function executeUpgrade(Diamond.DiamondCutData calldata _diamondCut) external;

    function freezeDiamond() external;

    function unfreezeDiamond() external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L58:58

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


    function proveL2MessageInclusion(
        uint256 _batchNumber,
        uint256 _index,
        L2Message memory _message,
        bytes32[] calldata _proof
    ) public view returns (bool) {
        return _proveL2LogInclusion(_batchNumber, _index, _L2MessageToLog(_message), _proof);
    }

    function proveL2LogInclusion(
        uint256 _batchNumber,
        uint256 _index,
        L2Log memory _log,
        bytes32[] calldata _proof
    ) external view returns (bool) {
        return _proveL2LogInclusion(_batchNumber, _index, _log, _proof);
    }

    function proveL1ToL2TransactionStatus(
        bytes32 _l2TxHash,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes32[] calldata _merkleProof,
        TxStatus _status
    ) public view returns (bool) {
        // Bootloader sends an L2 -> L1 log only after processing the L1 -> L2 transaction.
        // Thus, we can verify that the L1 -> L2 transaction was included in the L2 batch with specified status.
        //
        // The semantics of such L2 -> L1 log is always:
        // - sender = L2_BOOTLOADER_ADDRESS
        // - key = hash(L1ToL2Transaction)
        // - value = status of the processing transaction (1 - success & 0 - fail)
        // - isService = true (just a conventional value)
        // - l2ShardId = 0 (means that L1 -> L2 transaction was processed in a rollup shard, other shards are not available yet anyway)
        // - txNumberInBatch = number of transaction in the batch
        L2Log memory l2Log = L2Log({
            l2ShardId: 0,
            isService: true,
            txNumberInBatch: _l2TxNumberInBatch,
            sender: L2_BOOTLOADER_ADDRESS,
            key: _l2TxHash,
            value: bytes32(uint256(_status))
        });
        return _proveL2LogInclusion(_l2BatchNumber, _l2MessageIndex, l2Log, _merkleProof);
    }

    function l2TransactionBaseCost(
        uint256 _gasPrice,
        uint256 _l2GasLimit,
        uint256 _l2GasPerPubdataByteLimit
    ) public view returns (uint256) {
        uint256 l2GasPrice = _deriveL2GasPrice(_gasPrice, _l2GasPerPubdataByteLimit);
        return l2GasPrice * _l2GasLimit;
    }

    function transferEthToSharedBridge() external onlyBaseTokenBridge {
        require(s.chainId == ERA_CHAIN_ID, "transferEthToSharedBridge only available for Era on mailbox");

        uint256 amount = address(this).balance;
        address sharedBridgeAddress = s.baseTokenBridge;
        IL1SharedBridge(sharedBridgeAddress).receiveEth{value: amount}(ERA_CHAIN_ID);
    }

    function bridgehubRequestL2Transaction(
        BridgehubL2TransactionRequest memory _request
    ) external payable onlyBridgehub returns (bytes32 canonicalTxHash) {
        canonicalTxHash = _requestL2TransactionSender(_request);
    }

    function finalizeEthWithdrawal(
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external nonReentrant {
        require(s.chainId == ERA_CHAIN_ID, "finalizeEthWithdrawal only available for Era on mailbox");
        IL1SharedBridge(s.baseTokenBridge).finalizeWithdrawal(
            ERA_CHAIN_ID,
            _l2BatchNumber,
            _l2MessageIndex,
            _l2TxNumberInBatch,
            _message,
            _merkleProof
        );
    }

    function requestL2Transaction(
        address _contractL2,
        uint256 _l2Value,
        bytes calldata _calldata,
        uint256 _l2GasLimit,
        uint256 _l2GasPerPubdataByteLimit,
        bytes[] calldata _factoryDeps,
        address _refundRecipient
    ) external payable returns (bytes32 canonicalTxHash) {
        require(s.chainId == ERA_CHAIN_ID, "legacy interface only available for era token");
        canonicalTxHash = _requestL2TransactionSender(
            BridgehubL2TransactionRequest({
                sender: msg.sender,
                contractL2: _contractL2,
                mintValue: msg.value,
                l2Value: _l2Value,
                l2GasLimit: _l2GasLimit,
                l2Calldata: _calldata,
                l2GasPerPubdataByteLimit: _l2GasPerPubdataByteLimit,
                factoryDeps: _factoryDeps,
                refundRecipient: _refundRecipient
            })
        );
        IL1SharedBridge(s.baseTokenBridge).bridgehubDepositBaseToken{value: msg.value}(
            s.chainId,
            msg.sender,
            ETH_TOKEN_ADDRESS,
            msg.value
        );
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L197:226

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol


    function proveL2MessageInclusion(
        uint256 _batchNumber,
        uint256 _index,
        L2Message calldata _message,
        bytes32[] calldata _proof
    ) external view returns (bool);

    function proveL2LogInclusion(
        uint256 _batchNumber,
        uint256 _index,
        L2Log memory _log,
        bytes32[] calldata _proof
    ) external view returns (bool);

    function proveL1ToL2TransactionStatus(
        bytes32 _l2TxHash,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes32[] calldata _merkleProof,
        TxStatus _status
    ) external view returns (bool);

    function l2TransactionBaseCost(
        uint256 _gasPrice,
        uint256 _l2GasLimit,
        uint256 _l2GasPerPubdataByteLimit
    ) external view returns (uint256);

    function transferEthToSharedBridge() external;

    function bridgehubRequestL2Transaction(
        BridgehubL2TransactionRequest calldata _request
    ) external payable returns (bytes32 canonicalTxHash);

    function finalizeEthWithdrawal(
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external;

    function requestL2Transaction(
        address _contractL2,
        uint256 _l2Value,
        bytes calldata _calldata,
        uint256 _l2GasLimit,
        uint256 _l2GasPerPubdataByteLimit,
        bytes[] calldata _factoryDeps,
        address _refundRecipient
    ) external payable returns (bytes32 canonicalTxHash);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L88:96

```solidity
File: contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol


    function forceDeployOnAddresses(ForceDeployment[] calldata _deployParams) external;

    function create2(bytes32 _salt, bytes32 _bytecodeHash, bytes calldata _input) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol#L31:31

```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


    function forceDeployOnAddresses(ForceDeployment[] calldata _deployParams) external payable;

    function create2(bytes32 _salt, bytes32 _bytecodeHash, bytes calldata _input) external returns (address);

    function computeCreate2Address(
        address _sender,
        bytes32 _salt,
        bytes32 _bytecodeHash,
        bytes32 _constructorInputHash
    ) internal pure returns (address) {
        bytes32 senderBytes = bytes32(uint256(uint160(_sender)));
        bytes32 data = keccak256(
            bytes.concat(CREATE2_PREFIX, senderBytes, _salt, _bytecodeHash, _constructorInputHash)
        );

        return address(uint160(uint256(data)));
    }

    function sendToL1(bytes memory _message) external returns (bytes32);

    function withdrawWithMessage(address _l1Receiver, bytes memory _additionalData) external payable;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L65:65

```solidity
File: system-contracts/contracts/ContractDeployer.sol


    function forceDeployOnAddresses(ForceDeployment[] calldata _deployments) external payable {
        require(
            msg.sender == FORCE_DEPLOYER || msg.sender == address(COMPLEX_UPGRADER_CONTRACT),
            "Can only be called by FORCE_DEPLOYER or COMPLEX_UPGRADER_CONTRACT"
        );

        uint256 deploymentsLength = _deployments.length;
        // We need to ensure that the `value` provided by the call is enough to provide `value`
        // for all of the deployments
        uint256 sumOfValues = 0;
        for (uint256 i = 0; i < deploymentsLength; ++i) {
            sumOfValues += _deployments[i].value;
        }
        require(msg.value == sumOfValues, "`value` provided is not equal to the combined `value`s of deployments");

        for (uint256 i = 0; i < deploymentsLength; ++i) {
            this.forceDeployOnAddress{value: _deployments[i].value}(_deployments[i], msg.sender);
        }
    }

    function create2(
        bytes32 _salt,
        bytes32 _bytecodeHash,
        bytes calldata _input
    ) external payable override returns (address) {
        return create2Account(_salt, _bytecodeHash, _input, AccountAbstractionVersion.None);
    }

    function getAccountInfo(address _address) external view returns (AccountInfo memory info) {
        return accountInfo[_address];
    }

    function updateAccountVersion(AccountAbstractionVersion _version) external onlySystemCall {
        accountInfo[msg.sender].supportedAAVersion = _version;

        emit AccountVersionUpdated(msg.sender, _version);
    }

    function updateNonceOrdering(AccountNonceOrdering _nonceOrdering) external onlySystemCall {
        AccountInfo memory currentInfo = accountInfo[msg.sender];

        require(
            _nonceOrdering == AccountNonceOrdering.Arbitrary &&
                currentInfo.nonceOrdering == AccountNonceOrdering.Sequential,
            "It is only possible to change from sequential to arbitrary ordering"
        );

        currentInfo.nonceOrdering = _nonceOrdering;
        _storeAccountInfo(msg.sender, currentInfo);

        emit AccountNonceOrderingUpdated(msg.sender, _nonceOrdering);
    }

    function getNewAddressCreate2(
        address _sender,
        bytes32 _bytecodeHash,
        bytes32 _salt,
        bytes calldata _input
    ) public view override returns (address newAddress) {
        // No collision is possible with the Ethereum's CREATE2, since
        // the prefix begins with 0x20....
        bytes32 constructorInputHash = EfficientCall.keccak(_input);

        bytes32 hash = keccak256(
            bytes.concat(CREATE2_PREFIX, bytes32(uint256(uint160(_sender))), _salt, _bytecodeHash, constructorInputHash)
        );

        newAddress = address(uint160(uint256(hash)));
    }

    function getNewAddressCreate(
        address _sender,
        uint256 _senderNonce
    ) public pure override returns (address newAddress) {
        // No collision is possible with the Ethereum's CREATE, since
        // the prefix begins with 0x63....
        bytes32 hash = keccak256(
            bytes.concat(CREATE_PREFIX, bytes32(uint256(uint160(_sender))), bytes32(_senderNonce))
        );

        newAddress = address(uint160(uint256(hash)));
    }

    function create(
        bytes32 _salt,
        bytes32 _bytecodeHash,
        bytes calldata _input
    ) external payable override returns (address) {
        return createAccount(_salt, _bytecodeHash, _input, AccountAbstractionVersion.None);
    }

    function create2Account(
        bytes32 _salt,
        bytes32 _bytecodeHash,
        bytes calldata _input,
        AccountAbstractionVersion _aaVersion
    ) public payable override onlySystemCall returns (address) {
        NONCE_HOLDER_SYSTEM_CONTRACT.incrementDeploymentNonce(msg.sender);
        address newAddress = getNewAddressCreate2(msg.sender, _bytecodeHash, _salt, _input);

        _nonSystemDeployOnAddress(_bytecodeHash, newAddress, _aaVersion, _input);

        return newAddress;
    }

    function createAccount(
        bytes32, // salt
        bytes32 _bytecodeHash,
        bytes calldata _input,
        AccountAbstractionVersion _aaVersion
    ) public payable override onlySystemCall returns (address) {
        uint256 senderNonce = NONCE_HOLDER_SYSTEM_CONTRACT.incrementDeploymentNonce(msg.sender);
        address newAddress = getNewAddressCreate(msg.sender, senderNonce);

        _nonSystemDeployOnAddress(_bytecodeHash, newAddress, _aaVersion, _input);

        return newAddress;
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L182:194

```solidity
File: system-contracts/contracts/interfaces/IContractDeployer.sol


    function create2(
        bytes32 _salt,
        bytes32 _bytecodeHash,
        bytes calldata _input
    ) external payable returns (address newAddress);

    function getAccountInfo(address _address) external view returns (AccountInfo memory info);

    function updateAccountVersion(AccountAbstractionVersion _version) external;

    function updateNonceOrdering(AccountNonceOrdering _nonceOrdering) external;

    function getNewAddressCreate2(
        address _sender,
        bytes32 _bytecodeHash,
        bytes32 _salt,
        bytes calldata _input
    ) external view returns (address newAddress);

    function getNewAddressCreate(address _sender, uint256 _senderNonce) external pure returns (address newAddress);

    function create(
        bytes32 _salt,
        bytes32 _bytecodeHash,
        bytes calldata _input
    ) external payable returns (address newAddress);

    function create2Account(
        bytes32 _salt,
        bytes32 _bytecodeHash,
        bytes calldata _input,
        AccountAbstractionVersion _aaVersion
    ) external payable returns (address newAddress);

    function createAccount(
        bytes32 _salt,
        bytes32 _bytecodeHash,
        bytes calldata _input,
        AccountAbstractionVersion _aaVersion
    ) external payable returns (address newAddress);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L76:81

```solidity
File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol


    function hashL2Bytecode(bytes memory _bytecode) internal pure returns (bytes32 hashedBytecode) {
        // Note that the length of the bytecode must be provided in 32-byte words.
        require(_bytecode.length % 32 == 0, "pq");

        uint256 bytecodeLenInWords = _bytecode.length / 32;
        require(bytecodeLenInWords < 2 ** 16, "pp"); // bytecode length must be less than 2^16 words
        require(bytecodeLenInWords % 2 == 1, "ps"); // bytecode length in words must be odd
        hashedBytecode = sha256(_bytecode) & 0x00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;
        // Setting the version of the hash
        hashedBytecode = (hashedBytecode | bytes32(uint256(1 << 248)));
        // Setting the length
        hashedBytecode = hashedBytecode | bytes32(bytecodeLenInWords << 224);
    }

    function computeCreate2Address(
        address _sender,
        bytes32 _salt,
        bytes32 _bytecodeHash,
        bytes32 _constructorInputHash
    ) internal pure returns (address) {
        bytes32 senderBytes = bytes32(uint256(uint160(_sender)));
        bytes32 data = keccak256(
            bytes.concat(CREATE2_PREFIX, senderBytes, _salt, _bytecodeHash, _constructorInputHash)
        );

        return address(uint160(uint256(data)));
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L60:72

```solidity
File: system-contracts/contracts/libraries/Utils.sol


    function hashL2Bytecode(bytes calldata _bytecode) internal view returns (bytes32 hashedBytecode) {
        // Note that the length of the bytecode must be provided in 32-byte words.
        require(_bytecode.length % 32 == 0, "po");

        uint256 lengthInWords = _bytecode.length / 32;
        require(lengthInWords < 2 ** 16, "pp"); // bytecode length must be less than 2^16 words
        require(lengthInWords % 2 == 1, "pr"); // bytecode length in words must be odd
        hashedBytecode =
            EfficientCall.sha(_bytecode) &
            0x00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;
        // Setting the version of the hash
        hashedBytecode = (hashedBytecode | bytes32(uint256(1 << 248)));
        // Setting the length
        hashedBytecode = hashedBytecode | bytes32(lengthInWords << 224);
    }

    function safeCastToU32(uint256 _x) internal pure returns (uint32) {
        require(_x <= type(uint32).max, "Overflow");

        return uint32(_x);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L26:30

```solidity
File: contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol


    function readUint32(bytes memory _bytes, uint256 _start) internal pure returns (uint32 result, uint256 offset) {
        assembly {
            offset := add(_start, 4)
            result := mload(add(_bytes, offset))
        }
    }

    function readUint256(bytes memory _bytes, uint256 _start) internal pure returns (uint256 result, uint256 offset) {
        assembly {
            offset := add(_start, 32)
            result := mload(add(_bytes, offset))
        }
    }

    function readBytes32(bytes memory _bytes, uint256 _start) internal pure returns (bytes32 result, uint256 offset) {
        assembly {
            offset := add(_start, 32)
            result := mload(add(_bytes, offset))
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L40:45

```solidity
File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol


    function readUint32(bytes calldata _bytes, uint256 _start) internal pure returns (uint32 result) {
        assembly {
            let offset := sub(_bytes.offset, 28)
            result := calldataload(add(offset, _start))
        }
    }

    function readUint256(bytes calldata _bytes, uint256 _start) internal pure returns (uint256 result) {
        assembly {
            result := calldataload(add(_bytes.offset, _start))
        }
    }

    function readBytes32(bytes calldata _bytes, uint256 _start) internal pure returns (bytes32 result) {
        assembly {
            result := calldataload(add(_bytes.offset, _start))
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L40:44

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


    function isOperation(bytes32 _id) public view returns (bool) {
        return getOperationState(_id) != OperationState.Unset;
    }

    function isOperationPending(bytes32 _id) public view returns (bool) {
        OperationState state = getOperationState(_id);
        return state == OperationState.Waiting || state == OperationState.Ready;
    }

    function isOperationReady(bytes32 _id) public view returns (bool) {
        return getOperationState(_id) == OperationState.Ready;
    }

    function isOperationDone(bytes32 _id) public view returns (bool) {
        return getOperationState(_id) == OperationState.Done;
    }

    function getOperationState(bytes32 _id) public view returns (OperationState) {
        uint256 timestamp = timestamps[_id];
        if (timestamp == 0) {
            return OperationState.Unset;
        } else if (timestamp == EXECUTED_PROPOSAL_TIMESTAMP) {
            return OperationState.Done;
        } else if (timestamp > block.timestamp) {
            return OperationState.Waiting;
        } else {
            return OperationState.Ready;
        }
    }

    function scheduleTransparent(Operation calldata _operation, uint256 _delay) external onlyOwner {
        bytes32 id = hashOperation(_operation);
        _schedule(id, _delay);
        emit TransparentOperationScheduled(id, _delay, _operation);
    }

    function scheduleShadow(bytes32 _id, uint256 _delay) external onlyOwner {
        _schedule(_id, _delay);
        emit ShadowOperationScheduled(_id, _delay);
    }

    function cancel(bytes32 _id) external onlyOwner {
        require(isOperationPending(_id), "Operation must be pending");
        delete timestamps[_id];
        emit OperationCancelled(_id);
    }

    function execute(Operation calldata _operation) external payable onlyOwnerOrSecurityCouncil {
        bytes32 id = hashOperation(_operation);
        // Check if the predecessor operation is completed.
        _checkPredecessorDone(_operation.predecessor);
        // Ensure that the operation is ready to proceed.
        require(isOperationReady(id), "Operation must be ready before execution");
        // Execute operation.
        _execute(_operation.calls);
        // Reconfirming that the operation is still ready after execution.
        // This is needed to avoid unexpected reentrancy attacks of re-executing the same operation.
        require(isOperationReady(id), "Operation must be ready after execution");
        // Set operation to be done
        timestamps[id] = EXECUTED_PROPOSAL_TIMESTAMP;
        emit OperationExecuted(id);
    }

    function executeInstant(Operation calldata _operation) external payable onlySecurityCouncil {
        bytes32 id = hashOperation(_operation);
        // Check if the predecessor operation is completed.
        _checkPredecessorDone(_operation.predecessor);
        // Ensure that the operation is in a pending state before proceeding.
        require(isOperationPending(id), "Operation must be pending before execution");
        // Execute operation.
        _execute(_operation.calls);
        // Reconfirming that the operation is still pending before execution.
        // This is needed to avoid unexpected reentrancy attacks of re-executing the same operation.
        require(isOperationPending(id), "Operation must be pending after execution");
        // Set operation to be done
        timestamps[id] = EXECUTED_PROPOSAL_TIMESTAMP;
        emit OperationExecuted(id);
    }

    function hashOperation(Operation calldata _operation) public pure returns (bytes32) {
        return keccak256(abi.encode(_operation));
    }

    function _execute(Call[] calldata _calls) internal {
        for (uint256 i = 0; i < _calls.length; ++i) {
            (bool success, bytes memory returnData) = _calls[i].target.call{value: _calls[i].value}(_calls[i].data);
            if (!success) {
                // Propagate an error if the call fails.
                assembly {
                    revert(add(returnData, 0x20), mload(returnData))
                }
            }
        }
    }

    function updateDelay(uint256 _newDelay) external onlySelf {
        emit ChangeMinDelay(minDelay, _newDelay);
        minDelay = _newDelay;
    }

    function updateSecurityCouncil(address _newSecurityCouncil) external onlySelf {
        emit ChangeSecurityCouncil(securityCouncil, _newSecurityCouncil);
        securityCouncil = _newSecurityCouncil;
    }

    receive() external payable {}

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L262:262

```solidity
File: contracts/ethereum/contracts/governance/IGovernance.sol


    function isOperation(bytes32 _id) external view returns (bool);

    function isOperationPending(bytes32 _id) external view returns (bool);

    function isOperationReady(bytes32 _id) external view returns (bool);

    function isOperationDone(bytes32 _id) external view returns (bool);

    function getOperationState(bytes32 _id) external view returns (OperationState);

    function scheduleTransparent(Operation calldata _operation, uint256 _delay) external;

    function scheduleShadow(bytes32 _id, uint256 _delay) external;

    function cancel(bytes32 _id) external;

    function execute(Operation calldata _operation) external payable;

    function executeInstant(Operation calldata _operation) external payable;

    function hashOperation(Operation calldata _operation) external pure returns (bytes32);

    function updateDelay(uint256 _newDelay) external;

    function updateSecurityCouncil(address _newSecurityCouncil) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L65:65

```solidity
File: system-contracts/contracts/DefaultAccount.sol


    function _execute(Transaction calldata _transaction) internal {
        address to = address(uint160(_transaction.to));
        uint128 value = Utils.safeCastToU128(_transaction.value);
        bytes calldata data = _transaction.data;
        uint32 gas = Utils.safeCastToU32(gasleft());

        // Note, that the deployment method from the deployer contract can only be called with a "systemCall" flag.
        bool isSystemCall;
        if (to == address(DEPLOYER_SYSTEM_CONTRACT) && data.length >= 4) {
            bytes4 selector = bytes4(data[:4]);
            // Check that called function is the deployment method,
            // the others deployer method is not supposed to be called from the default account.
            isSystemCall =
                selector == DEPLOYER_SYSTEM_CONTRACT.create.selector ||
                selector == DEPLOYER_SYSTEM_CONTRACT.create2.selector ||
                selector == DEPLOYER_SYSTEM_CONTRACT.createAccount.selector ||
                selector == DEPLOYER_SYSTEM_CONTRACT.create2Account.selector;
        }
        bool success = EfficientCall.rawCall(gas, to, value, data, isSystemCall);
        if (!success) {
            EfficientCall.propagateRevert();
        }
    }

    receive() external payable {
        // If the contract is called directly, behave like an EOA
    }

    fallback() external payable ignoreInDelegateCall {
        // fallback of default account shouldn't be called by bootloader under no circumstances
        assert(msg.sender != BOOTLOADER_FORMAL_ADDRESS);

        // If the contract is called directly, behave like an EOA
    }

    function validateTransaction(
        bytes32, // _txHash
        bytes32 _suggestedSignedHash,
        Transaction calldata _transaction
    ) external payable override ignoreNonBootloader ignoreInDelegateCall returns (bytes4 magic) {
        magic = _validateTransaction(_suggestedSignedHash, _transaction);
    }

    function executeTransaction(
        bytes32, // _txHash
        bytes32, // _suggestedSignedHash
        Transaction calldata _transaction
    ) external payable override ignoreNonBootloader ignoreInDelegateCall {
        _execute(_transaction);
    }

    function executeTransactionFromOutside(Transaction calldata _transaction) external payable override {
        // Behave the same as for fallback/receive, just execute nothing, returns nothing
    }

    function payForTransaction(
        bytes32, // _txHash
        bytes32, // _suggestedSignedHash
        Transaction calldata _transaction
    ) external payable ignoreNonBootloader ignoreInDelegateCall {
        bool success = _transaction.payToTheBootloader();
        require(success, "Failed to pay the fee to the operator");
    }

    function prepareForPaymaster(
        bytes32, // _txHash
        bytes32, // _suggestedSignedHash
        Transaction calldata _transaction
    ) external payable ignoreNonBootloader ignoreInDelegateCall {
        _transaction.processPaymasterInput();
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L212:218

```solidity
File: system-contracts/contracts/EmptyContract.sol


    receive() external payable {}

    fallback() external payable {}

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L11:11

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


    function revertBatches(uint256) external onlyValidator(ERA_CHAIN_ID) {
        _propagateToZkSyncStateTransition(ERA_CHAIN_ID);
    }

    function commitBatches(
        StoredBatchInfo calldata,
        CommitBatchInfo[] calldata _newBatchesData
    ) external onlyValidator(ERA_CHAIN_ID) {
        unchecked {
            // This contract is only a temporary solution, that hopefully will be disabled until 2106 year, so...
            // It is safe to cast.
            uint32 timestamp = uint32(block.timestamp);
            for (uint256 i = 0; i < _newBatchesData.length; ++i) {
                committedBatchTimestamp[ERA_CHAIN_ID].set(_newBatchesData[i].batchNumber, timestamp);
            }
        }

        _propagateToZkSyncStateTransition(ERA_CHAIN_ID);
    }

    function commitBatchesSharedBridge(
        uint256 _chainId,
        StoredBatchInfo calldata,
        CommitBatchInfo[] calldata _newBatchesData
    ) external onlyValidator(_chainId) {
        unchecked {
            // This contract is only a temporary solution, that hopefully will be disabled until 2106 year, so...
            // It is safe to cast.
            uint32 timestamp = uint32(block.timestamp);
            for (uint256 i = 0; i < _newBatchesData.length; ++i) {
                committedBatchTimestamp[_chainId].set(_newBatchesData[i].batchNumber, timestamp);
            }
        }

        _propagateToZkSyncStateTransition(_chainId);
    }

    function revertBatchesSharedBridge(uint256 _chainId, uint256) external onlyValidator(_chainId) {
        _propagateToZkSyncStateTransition(_chainId);
    }

    function proveBatches(
        StoredBatchInfo calldata,
        StoredBatchInfo[] calldata,
        ProofInput calldata
    ) external onlyValidator(ERA_CHAIN_ID) {
        _propagateToZkSyncStateTransition(ERA_CHAIN_ID);
    }

    function proveBatchesSharedBridge(
        uint256 _chainId,
        StoredBatchInfo calldata,
        StoredBatchInfo[] calldata,
        ProofInput calldata
    ) external onlyValidator(_chainId) {
        _propagateToZkSyncStateTransition(_chainId);
    }

    function executeBatches(StoredBatchInfo[] calldata _newBatchesData) external onlyValidator(ERA_CHAIN_ID) {
        uint256 delay = executionDelay; // uint32
        unchecked {
            for (uint256 i = 0; i < _newBatchesData.length; ++i) {
                uint256 commitBatchTimestamp = committedBatchTimestamp[ERA_CHAIN_ID].get(
                    _newBatchesData[i].batchNumber
                );

                // Note: if the `commitBatchTimestamp` is zero, that means either:
                // * The batch was committed, but not through this contract.
                // * The batch wasn't committed at all, so execution will fail in the zkSync contract.
                // We allow executing such batches.

                require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed
            }
        }
        _propagateToZkSyncStateTransition(ERA_CHAIN_ID);
    }

    function executeBatchesSharedBridge(
        uint256 _chainId,
        StoredBatchInfo[] calldata _newBatchesData
    ) external onlyValidator(_chainId) {
        uint256 delay = executionDelay; // uint32
        unchecked {
            for (uint256 i = 0; i < _newBatchesData.length; ++i) {
                uint256 commitBatchTimestamp = committedBatchTimestamp[_chainId].get(_newBatchesData[i].batchNumber);

                // Note: if the `commitBatchTimestamp` is zero, that means either:
                // * The batch was committed, but not through this contract.
                // * The batch wasn't committed at all, so execution will fail in the zkSync contract.
                // We allow executing such batches.

                require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed
            }
        }
        _propagateToZkSyncStateTransition(_chainId);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L203:221

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


    function revertBatches(uint256 _newLastBatch) external nonReentrant onlyValidatorOrStateTransitionManager {
        _revertBatches(_newLastBatch);
    }

    function commitBatches(
        StoredBatchInfo memory _lastCommittedBatchData,
        CommitBatchInfo[] calldata _newBatchesData
    ) external nonReentrant onlyValidator {
        _commitBatches(_lastCommittedBatchData, _newBatchesData);
    }

    function commitBatchesSharedBridge(
        uint256, // _chainId
        StoredBatchInfo memory _lastCommittedBatchData,
        CommitBatchInfo[] calldata _newBatchesData
    ) external nonReentrant onlyValidator {
        _commitBatches(_lastCommittedBatchData, _newBatchesData);
    }

    function revertBatchesSharedBridge(uint256, uint256 _newLastBatch) external nonReentrant onlyValidator {
        _revertBatches(_newLastBatch);
    }

    function proveBatches(
        StoredBatchInfo calldata _prevBatch,
        StoredBatchInfo[] calldata _committedBatches,
        ProofInput calldata _proof
    ) external nonReentrant onlyValidator {
        _proveBatches(_prevBatch, _committedBatches, _proof);
    }

    function proveBatchesSharedBridge(
        uint256, // _chainId
        StoredBatchInfo calldata _prevBatch,
        StoredBatchInfo[] calldata _committedBatches,
        ProofInput calldata _proof
    ) external nonReentrant onlyValidator {
        _proveBatches(_prevBatch, _committedBatches, _proof);
    }

    function executeBatches(StoredBatchInfo[] calldata _batchesData) external nonReentrant onlyValidator {
        _executeBatches(_batchesData);
    }

    function executeBatchesSharedBridge(
        uint256,
        StoredBatchInfo[] calldata _batchesData
    ) external nonReentrant onlyValidator {
        _executeBatches(_batchesData);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L337:342

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol


    function revertBatches(uint256 _newLastBatch) external;

    function commitBatches(
        StoredBatchInfo calldata _lastCommittedBatchData,
        CommitBatchInfo[] calldata _newBatchesData
    ) external;

    function commitBatchesSharedBridge(
        uint256 _chainId,
        StoredBatchInfo calldata _lastCommittedBatchData,
        CommitBatchInfo[] calldata _newBatchesData
    ) external;

    function revertBatchesSharedBridge(uint256 _chainId, uint256 _newLastBatch) external;

    function proveBatches(
        StoredBatchInfo calldata _prevBatch,
        StoredBatchInfo[] calldata _committedBatches,
        ProofInput calldata _proof
    ) external;

    function proveBatchesSharedBridge(
        uint256 _chainId,
        StoredBatchInfo calldata _prevBatch,
        StoredBatchInfo[] calldata _committedBatches,
        ProofInput calldata _proof
    ) external;

    function executeBatches(StoredBatchInfo[] calldata _batchesData) external;

    function executeBatchesSharedBridge(uint256 _chainId, StoredBatchInfo[] calldata _batchesData) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L175:175

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol


    fallback() external payable {
        Diamond.DiamondStorage storage diamondStorage = Diamond.getDiamondStorage();
        // Check whether the data contains a "full" selector or it is empty.
        // Required because Diamond proxy finds a facet by function signature,
        // which is not defined for data length in range [1, 3].
        require(msg.data.length >= 4 || msg.data.length == 0, "Ut");
        // Get facet from function selector
        Diamond.SelectorToFacet memory facet = diamondStorage.selectorToFacet[msg.sig];
        address facetAddress = facet.facetAddress;

        require(facetAddress != address(0), "F"); // Proxy has no facet for this selector
        require(!diamondStorage.isFrozen || !facet.isFreezable, "q1"); // Facet is frozen

        assembly {
            // The pointer to the free memory slot
            let ptr := mload(0x40)
            // Copy function signature and arguments from calldata at zero position into memory at pointer position
            calldatacopy(ptr, 0, calldatasize())
            // Delegatecall method of the implementation contract returns 0 on error
            let result := delegatecall(gas(), facetAddress, ptr, calldatasize(), 0, 0)
            // Get the size of the last return data
            let size := returndatasize()
            // Copy the size length of bytes from return data at zero position to pointer position
            returndatacopy(ptr, 0, size)
            // Depending on the result value
            switch result
            case 0 {
                // End execution and revert state changes
                revert(ptr, size)
            }
            default {
                // Return data with length of size at pointers position
                return(ptr, size)
            }
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L20:55

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


    fallback(bytes calldata _data) external onlySystemCall returns (bytes memory) {
        // Firstly we calculate how much gas has been actually provided by the user to the inner call.
        // For that, we need to get the total gas available in this context and subtract the stipend from it.
        uint256 gasInContext = gasleft();
        // Note, that the `gasInContext` might be slightly less than the MSG_VALUE_SIMULATOR_STIPEND_GAS, since
        // by the time we retrieve it, some gas might have already been spent, e.g. on the `gasleft` opcode itself.
        uint256 userGas = gasInContext > MSG_VALUE_SIMULATOR_STIPEND_GAS
            ? gasInContext - MSG_VALUE_SIMULATOR_STIPEND_GAS
            : 0;

        (uint256 value, bool isSystemCall, address to) = _getAbiParams();

        // Prevent mimic call to the MsgValueSimulator to prevent an unexpected change of callee.
        require(to != address(this), "MsgValueSimulator calls itself");

        if (value != 0) {
            (bool success, ) = address(REAL_BASE_TOKEN_SYSTEM_CONTRACT).call(
                abi.encodeCall(REAL_BASE_TOKEN_SYSTEM_CONTRACT.transferFromTo, (msg.sender, to, value))
            );

            // If the transfer of ETH fails, we do the most Ethereum-like behaviour in such situation: revert(0,0)
            if (!success) {
                assembly {
                    revert(0, 0)
                }
            }

            // If value is non-zero, we also provide additional gas to the callee.
            userGas += GAS_TO_PASS;
        }

        // For the next call this `msg.value` will be used.
        SystemContractHelper.setValueForNextFarCall(Utils.safeCastToU128(value));

        return EfficientCall.mimicCall(userGas, to, _data, msg.sender, false, isSystemCall);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L47:82

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


    function getVerifier() external view returns (address) {
        return address(s.verifier);
    }

    function getAdmin() external view returns (address) {
        return s.admin;
    }

    function getPendingAdmin() external view returns (address) {
        return s.pendingAdmin;
    }

    function getBridgehub() external view returns (address) {
        return address(s.bridgehub);
    }

    function getStateTransitionManager() external view returns (address) {
        return address(s.stateTransitionManager);
    }

    function getBaseToken() external view returns (address) {
        return address(s.baseToken);
    }

    function getBaseTokenBridge() external view returns (address) {
        return address(s.baseTokenBridge);
    }

    function baseTokenGasPriceMultiplierNominator() external view returns (uint128) {
        return s.baseTokenGasPriceMultiplierNominator;
    }

    function baseTokenGasPriceMultiplierDenominator() external view returns (uint128) {
        return s.baseTokenGasPriceMultiplierDenominator;
    }

    function getTotalBatchesCommitted() external view returns (uint256) {
        return s.totalBatchesCommitted;
    }

    function getTotalBatchesVerified() external view returns (uint256) {
        return s.totalBatchesVerified;
    }

    function getTotalBatchesExecuted() external view returns (uint256) {
        return s.totalBatchesExecuted;
    }

    function getTotalPriorityTxs() external view returns (uint256) {
        return s.priorityQueue.getTotalPriorityTxs();
    }

    function getFirstUnprocessedPriorityTx() external view returns (uint256) {
        return s.priorityQueue.getFirstUnprocessedPriorityTx();
    }

    function getPriorityQueueSize() external view returns (uint256) {
        return s.priorityQueue.getSize();
    }

    function priorityQueueFrontOperation() external view returns (PriorityOperation memory) {
        return s.priorityQueue.front();
    }

    function isValidator(address _address) external view returns (bool) {
        return s.validators[_address];
    }

    function l2LogsRootHash(uint256 _batchNumber) external view returns (bytes32) {
        return s.l2LogsRootHashes[_batchNumber];
    }

    function storedBatchHash(uint256 _batchNumber) external view returns (bytes32) {
        return s.storedBatchHashes[_batchNumber];
    }

    function getL2BootloaderBytecodeHash() external view returns (bytes32) {
        return s.l2BootloaderBytecodeHash;
    }

    function getL2DefaultAccountBytecodeHash() external view returns (bytes32) {
        return s.l2DefaultAccountBytecodeHash;
    }

    function getVerifierParams() external view returns (VerifierParams memory) {
        return s.verifierParams;
    }

    function getProtocolVersion() external view returns (uint256) {
        return s.protocolVersion;
    }

    function getL2SystemContractsUpgradeTxHash() external view returns (bytes32) {
        return s.l2SystemContractsUpgradeTxHash;
    }

    function getL2SystemContractsUpgradeBatchNumber() external view returns (uint256) {
        return s.l2SystemContractsUpgradeBatchNumber;
    }

    function isDiamondStorageFrozen() external view returns (bool) {
        Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();
        return ds.isFrozen;
    }

    function isFacetFreezable(address _facet) external view returns (bool isFreezable) {
        Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();

        // There is no direct way to get whether the facet address is freezable,
        // so we get it from one of the selectors that are associated with the facet.
        uint256 selectorsArrayLen = ds.facetToSelectors[_facet].selectors.length;
        if (selectorsArrayLen != 0) {
            bytes4 selector0 = ds.facetToSelectors[_facet].selectors[0];
            isFreezable = ds.selectorToFacet[selector0].isFreezable;
        }
    }

    function getPriorityTxMaxGasLimit() external view returns (uint256) {
        return s.priorityTxMaxGasLimit;
    }

    function isFunctionFreezable(bytes4 _selector) external view returns (bool) {
        Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();
        require(ds.selectorToFacet[_selector].facetAddress != address(0), "g2");
        return ds.selectorToFacet[_selector].isFreezable;
    }

    function isEthWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool) {
        return s.isEthWithdrawalFinalized[_l2BatchNumber][_l2MessageIndex];
    }

    function getPubdataPricingMode() external view returns (PubdataPricingMode) {
        return s.feeParams.pubdataPricingMode;
    }

    function facets() external view returns (Facet[] memory result) {
        Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();

        uint256 facetsLen = ds.facets.length;
        result = new Facet[](facetsLen);

        for (uint256 i = 0; i < facetsLen; i = i.uncheckedInc()) {
            address facetAddr = ds.facets[i];
            Diamond.FacetToSelectors memory facetToSelectors = ds.facetToSelectors[facetAddr];

            result[i] = Facet(facetAddr, facetToSelectors.selectors);
        }
    }

    function facetFunctionSelectors(address _facet) external view returns (bytes4[] memory) {
        Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();
        return ds.facetToSelectors[_facet].selectors;
    }

    function facetAddresses() external view returns (address[] memory) {
        Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();
        return ds.facets;
    }

    function facetAddress(bytes4 _selector) external view returns (address) {
        Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();
        return ds.selectorToFacet[_selector].facetAddress;
    }

    function getTotalBlocksCommitted() external view returns (uint256) {
        return s.totalBatchesCommitted;
    }

    function getTotalBlocksVerified() external view returns (uint256) {
        return s.totalBatchesVerified;
    }

    function getTotalBlocksExecuted() external view returns (uint256) {
        return s.totalBatchesExecuted;
    }

    function storedBlockHash(uint256 _batchNumber) external view returns (bytes32) {
        return s.storedBatchHashes[_batchNumber];
    }

    function getL2SystemContractsUpgradeBlockNumber() external view returns (uint256) {
        return s.l2SystemContractsUpgradeBatchNumber;
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L259:261

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol


    function getVerifier() external view returns (address);

    function getAdmin() external view returns (address);

    function getPendingAdmin() external view returns (address);

    function getBridgehub() external view returns (address);

    function getStateTransitionManager() external view returns (address);

    function getBaseToken() external view returns (address);

    function getBaseTokenBridge() external view returns (address);

    function baseTokenGasPriceMultiplierNominator() external view returns (uint128);

    function baseTokenGasPriceMultiplierDenominator() external view returns (uint128);

    function getTotalBatchesCommitted() external view returns (uint256);

    function getTotalBatchesVerified() external view returns (uint256);

    function getTotalBatchesExecuted() external view returns (uint256);

    function getTotalPriorityTxs() external view returns (uint256);

    function getFirstUnprocessedPriorityTx() external view returns (uint256);

    function getPriorityQueueSize() external view returns (uint256);

    function priorityQueueFrontOperation() external view returns (PriorityOperation memory);

    function isValidator(address _address) external view returns (bool);

    function l2LogsRootHash(uint256 _batchNumber) external view returns (bytes32 merkleRoot);

    function storedBatchHash(uint256 _batchNumber) external view returns (bytes32);

    function getL2BootloaderBytecodeHash() external view returns (bytes32);

    function getL2DefaultAccountBytecodeHash() external view returns (bytes32);

    function getVerifierParams() external view returns (VerifierParams memory);

    function getProtocolVersion() external view returns (uint256);

    function getL2SystemContractsUpgradeTxHash() external view returns (bytes32);

    function getL2SystemContractsUpgradeBatchNumber() external view returns (uint256);

    function isDiamondStorageFrozen() external view returns (bool);

    function isFacetFreezable(address _facet) external view returns (bool isFreezable);

    function getPriorityTxMaxGasLimit() external view returns (uint256);

    function isFunctionFreezable(bytes4 _selector) external view returns (bool);

    function isEthWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool);

    function getPubdataPricingMode() external view returns (PubdataPricingMode);

    function facets() external view returns (Facet[] memory);

    function facetFunctionSelectors(address _facet) external view returns (bytes4[] memory);

    function facetAddresses() external view returns (address[] memory facets);

    function facetAddress(bytes4 _selector) external view returns (address facet);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L139:139

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol


    function getTotalPriorityTxs(Queue storage _queue) internal view returns (uint256) {
        return _queue.tail;
    }

    function getFirstUnprocessedPriorityTx(Queue storage _queue) internal view returns (uint256) {
        return _queue.head;
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L35:37

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol


    function getTotalBlocksCommitted() external view returns (uint256);

    function getTotalBlocksVerified() external view returns (uint256);

    function getTotalBlocksExecuted() external view returns (uint256);

    function storedBlockHash(uint256 _batchNumber) external view returns (bytes32);

    function getL2SystemContractsUpgradeBlockNumber() external view returns (uint256);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol#L36:36

```solidity
File: system-contracts/contracts/interfaces/IMailbox.sol


    function finalizeEthWithdrawal(
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBlock,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IMailbox.sol#L6:12

```solidity
File: contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol


    function setChainId(uint256 _newChainId) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol#L5:5

```solidity
File: system-contracts/contracts/SystemContext.sol


    function setChainId(uint256 _newChainId) external onlyCallFromForceDeployer {
        chainId = _newChainId;
    }

    function getCurrentPubdataSpent() public view returns (uint256) {
        uint256 pubdataPublished = SystemContractHelper.getZkSyncMeta().pubdataPublished;
        return pubdataPublished > basePubdataSpent ? pubdataPublished - basePubdataSpent : 0;
    }

    function getBlockHashEVM(uint256 _block) external view returns (bytes32 hash) {
        uint128 blockNumber = currentVirtualL2BlockInfo.number;

        VirtualBlockUpgradeInfo memory currentVirtualBlockUpgradeInfo = virtualBlockUpgradeInfo;

        // Due to virtual blocks upgrade, we'll have to use the following logic for retreiving the blockhash:
        // 1. If the block number is out of the 256-block supported range, return 0.
        // 2. If the block was created before the upgrade for the virtual blocks (i.e. there we used to use hashes of the batches),
        // we return the hash of the batch.
        // 3. If the block was created after the day when the virtual blocks have caught up with the L2 blocks, i.e.
        // all the information which is returned for users should be for L2 blocks, we return the hash of the corresponding L2 block.
        // 4. If the block queried is a virtual blocks, calculate it on the fly.
        if (blockNumber <= _block || blockNumber - _block > 256) {
            hash = bytes32(0);
        } else if (_block < currentVirtualBlockUpgradeInfo.virtualBlockStartBatch) {
            // Note, that we will get into this branch only for a brief moment of time, right after the upgrade
            // for virtual blocks before 256 virtual blocks are produced.
            hash = batchHashes[_block];
        } else if (
            _block >= currentVirtualBlockUpgradeInfo.virtualBlockFinishL2Block &&
            currentVirtualBlockUpgradeInfo.virtualBlockFinishL2Block > 0
        ) {
            hash = _getLatest257L2blockHash(_block);
        } else {
            // Important: we do not want this number to ever collide with the L2 block hash (either new or old one) and so
            // that's why the legacy L2 blocks' hashes are keccak256(abi.encodePacked(uint32(_block))), while these are equivalent to
            // keccak256(abi.encodePacked(_block))
            hash = keccak256(abi.encode(_block));
        }
    }

    function getBatchHash(uint256 _batchNumber) external view returns (bytes32 hash) {
        hash = batchHashes[_batchNumber];
    }

    function getBatchNumberAndTimestamp() public view returns (uint128 batchNumber, uint128 batchTimestamp) {
        BlockInfo memory batchInfo = currentBatchInfo;
        batchNumber = batchInfo.number;
        batchTimestamp = batchInfo.timestamp;
    }

    function getL2BlockNumberAndTimestamp() public view returns (uint128 blockNumber, uint128 blockTimestamp) {
        BlockInfo memory blockInfo = currentL2BlockInfo;
        blockNumber = blockInfo.number;
        blockTimestamp = blockInfo.timestamp;
    }

    function getBlockNumber() public view returns (uint128) {
        return currentVirtualL2BlockInfo.number;
    }

    function getBlockTimestamp() public view returns (uint128) {
        return currentVirtualL2BlockInfo.timestamp;
    }

    function currentBlockInfo() external view returns (uint256 blockInfo) {
        (uint128 blockNumber, uint128 blockTimestamp) = getBatchNumberAndTimestamp();
        blockInfo = (uint256(blockNumber) << 128) | uint256(blockTimestamp);
    }

    function getBlockNumberAndTimestamp() external view returns (uint256 blockNumber, uint256 blockTimestamp) {
        (blockNumber, blockTimestamp) = getBatchNumberAndTimestamp();
    }

    function blockHash(uint256 _blockNumber) external view returns (bytes32 hash) {
        hash = batchHashes[_blockNumber];
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L509:511

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


    function upgrade(ProposedUpgrade calldata _proposedUpgrade) public virtual returns (bytes32 txHash) {
        // Note that due to commitment delay, the timestamp of the L2 upgrade batch may be earlier than the timestamp
        // of the L1 block at which the upgrade occurred. This means that using timestamp as a signifier of "upgraded"
        // on the L2 side would be inaccurate. The effects of this "back-dating" of L2 upgrade batches will be reduced
        // as the permitted delay window is reduced in the future.
        require(block.timestamp >= _proposedUpgrade.upgradeTimestamp, "Upgrade is not ready yet");

        _setNewProtocolVersion(_proposedUpgrade.newProtocolVersion);
        _upgradeL1Contract(_proposedUpgrade.l1ContractsUpgradeCalldata);
        _upgradeVerifier(_proposedUpgrade.verifier, _proposedUpgrade.verifierParams);
        _setBaseSystemContracts(_proposedUpgrade.bootloaderHash, _proposedUpgrade.defaultAccountHash);

        txHash = _setL2SystemContractUpgrade(
            _proposedUpgrade.l2ProtocolUpgradeTx,
            _proposedUpgrade.factoryDeps,
            _proposedUpgrade.newProtocolVersion
        );

        _postUpgrade(_proposedUpgrade.postUpgradeCalldata);

        emit UpgradeComplete(_proposedUpgrade.newProtocolVersion, txHash, _proposedUpgrade);
    }

    function _setNewProtocolVersion(uint256 _newProtocolVersion) internal virtual {
        uint256 previousProtocolVersion = s.protocolVersion;
        require(
            _newProtocolVersion > previousProtocolVersion,
            "New protocol version is not greater than the current one"
        );
        require(
            _newProtocolVersion - previousProtocolVersion <= MAX_ALLOWED_PROTOCOL_VERSION_DELTA,
            "Too big protocol version difference"
        );

        // If the previous upgrade had an L2 system upgrade transaction, we require that it is finalized.
        // Note it is important to keep this check, as otherwise hyperchains might skip upgrades by overwriting
        require(s.l2SystemContractsUpgradeTxHash == bytes32(0), "Previous upgrade has not been finalized");
        require(
            s.l2SystemContractsUpgradeBatchNumber == 0,
            "The batch number of the previous upgrade has not been cleaned"
        );

        s.protocolVersion = _newProtocolVersion;
        emit NewProtocolVersion(previousProtocolVersion, _newProtocolVersion);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L236:257

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol


    function upgrade(ProposedUpgrade calldata _proposedUpgrade) public virtual override returns (bytes32) {
        // Note that due to commitment delay, the timestamp of the L2 upgrade batch may be earlier than the timestamp
        // of the L1 block at which the upgrade occurred. This means that using timestamp as a signifier of "upgraded"
        // on the L2 side would be inaccurate. The effects of this "back-dating" of L2 upgrade batches will be reduced
        // as the permitted delay window is reduced in the future.
        require(block.timestamp >= _proposedUpgrade.upgradeTimestamp, "Upgrade is not ready yet");

        _setNewProtocolVersion(_proposedUpgrade.newProtocolVersion);
        _upgradeL1Contract(_proposedUpgrade.l1ContractsUpgradeCalldata);
        _upgradeVerifier(_proposedUpgrade.verifier, _proposedUpgrade.verifierParams);
        _setBaseSystemContracts(_proposedUpgrade.bootloaderHash, _proposedUpgrade.defaultAccountHash);

        bytes32 txHash = _setL2SystemContractUpgrade(
            _proposedUpgrade.l2ProtocolUpgradeTx,
            _proposedUpgrade.factoryDeps,
            _proposedUpgrade.newProtocolVersion
        );

        _postUpgrade(_proposedUpgrade.postUpgradeCalldata);

        emit UpgradeComplete(_proposedUpgrade.newProtocolVersion, txHash, _proposedUpgrade);
    }

    function _setNewProtocolVersion(uint256 _newProtocolVersion) internal override {
        uint256 previousProtocolVersion = s.protocolVersion;
        require(
            // Genesis Upgrade difference: Note this is the only thing change > to >=
            _newProtocolVersion >= previousProtocolVersion,
            "New protocol version is not greater than the current one"
        );
        require(
            _newProtocolVersion - previousProtocolVersion <= MAX_ALLOWED_PROTOCOL_VERSION_DELTA,
            "Too big protocol version difference"
        );

        // If the previous upgrade had an L2 system upgrade transaction, we require that it is finalized.
        require(s.l2SystemContractsUpgradeTxHash == bytes32(0), "Previous upgrade has not been finalized");
        require(
            s.l2SystemContractsUpgradeBatchNumber == 0,
            "The batch number of the previous upgrade has not been cleaned"
        );

        s.protocolVersion = _newProtocolVersion;
        emit NewProtocolVersion(previousProtocolVersion, _newProtocolVersion);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L20:41

```solidity
File: contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol


    function upgrade(ProposedUpgrade calldata _proposedUpgrade) public override returns (bytes32) {
        super.upgrade(_proposedUpgrade);
        return Diamond.DIAMOND_INIT_SUCCESS_RETURN_VALUE;
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol#L13:16

```solidity
File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol


    function upgrade(ProposedUpgrade calldata _proposedUpgrade) public override returns (bytes32) {
        super.upgrade(_proposedUpgrade);
        return Diamond.DIAMOND_INIT_SUCCESS_RETURN_VALUE;
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L14:17

```solidity
File: contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol


    function upgrade(ProposedUpgrade calldata _upgrade) external returns (bytes32);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol#L8:8

```solidity
File: system-contracts/contracts/ComplexUpgrader.sol


    function upgrade(address _delegateTo, bytes calldata _calldata) external payable {
        require(msg.sender == FORCE_DEPLOYER, "Can only be called by FORCE_DEPLOYER");

        require(_delegateTo.code.length > 0, "Delegatee is an EOA");
        (bool success, bytes memory returnData) = _delegateTo.delegatecall(_calldata);
        assembly {
            if iszero(success) {
                revert(add(returnData, 0x20), mload(returnData))
            }
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L21:31

```solidity
File: system-contracts/contracts/interfaces/IComplexUpgrader.sol


    function upgrade(address _delegateTo, bytes calldata _calldata) external payable;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IComplexUpgrader.sol#L11:11

```solidity
File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol


    function applyL1ToL2Alias(address l1Address) internal pure returns (address l2Address) {
        unchecked {
            l2Address = address(uint160(l1Address) + offset);
        }
    }

    function undoL1ToL2Alias(address l2Address) internal pure returns (address l1Address) {
        unchecked {
            l1Address = address(uint160(l2Address) - offset);
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L38:42

```solidity
File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol


    function applyL1ToL2Alias(address l1Address) internal pure returns (address l2Address) {
        unchecked {
            l2Address = address(uint160(l1Address) + offset);
        }
    }

    function undoL1ToL2Alias(address l2Address) internal pure returns (address l1Address) {
        unchecked {
            l1Address = address(uint160(l2Address) - offset);
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L38:42

```solidity
File: system-contracts/contracts/L1Messenger.sol


    function sendToL1(bytes calldata _message) external override returns (bytes32 hash) {
        uint256 gasBeforeMessageHashing = gasleft();
        hash = EfficientCall.keccak(_message);
        uint256 gasSpentOnMessageHashing = gasBeforeMessageHashing - gasleft();

        /// Store message record
        chainedMessagesHash = keccak256(abi.encode(chainedMessagesHash, hash));

        /// Store log record
        L2ToL1Log memory l2ToL1Log = L2ToL1Log({
            l2ShardId: 0,
            isService: true,
            txNumberInBlock: SYSTEM_CONTEXT_CONTRACT.txNumberInBlock(),
            sender: address(this),
            key: bytes32(uint256(uint160(msg.sender))),
            value: hash
        });
        _processL2ToL1Log(l2ToL1Log);

        // Get cost of one byte pubdata in gas from context.
        uint256 pubdataLen;
        unchecked {
            // 4 bytes used to encode the length of the message (see `publishPubdataAndClearState`)
            // L2_TO_L1_LOG_SERIALIZE_SIZE bytes used to encode L2ToL1Log
            pubdataLen = 4 + _message.length + L2_TO_L1_LOG_SERIALIZE_SIZE;
        }

        // We need to charge cost of hashing, as it will be used in `publishPubdataAndClearState`:
        // - keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) and keccakGasCost(64) when reconstructing L2ToL1Log
        // - keccakGasCost(64) and gasSpentOnMessageHashing when reconstructing Messages
        // - at most 1 time keccakGasCost(64) when building the Merkle tree (as merkle tree can contain
        // ~2*N nodes, where the first N nodes are leaves the hash of which is calculated on the previous step).
        uint256 gasToPay = keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) +
            3 *
            keccakGasCost(64) +
            gasSpentOnMessageHashing +
            COMPUTATIONAL_PRICE_FOR_PUBDATA *
            pubdataLen;
        SystemContractHelper.burnGas(Utils.safeCastToU32(gasToPay), uint32(pubdataLen));

        emit L1MessageSent(msg.sender, hash, _message);
    }

    function sendL2ToL1Log(
        bool _isService,
        bytes32 _key,
        bytes32 _value
    ) external onlyCallFromSystemContract returns (uint256 logIdInMerkleTree) {
        L2ToL1Log memory l2ToL1Log = L2ToL1Log({
            l2ShardId: 0,
            isService: _isService,
            txNumberInBlock: SYSTEM_CONTEXT_CONTRACT.txNumberInBlock(),
            sender: msg.sender,
            key: _key,
            value: _value
        });
        logIdInMerkleTree = _processL2ToL1Log(l2ToL1Log);

        // We need to charge cost of hashing, as it will be used in `publishPubdataAndClearState`:
        // - keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) and keccakGasCost(64) when reconstructing L2ToL1Log
        // - at most 1 time keccakGasCost(64) when building the Merkle tree (as merkle tree can contain
        // ~2*N nodes, where the first N nodes are leaves the hash of which is calculated on the previous step).
        uint256 gasToPay = keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) + 2 * keccakGasCost(64);
        SystemContractHelper.burnGas(Utils.safeCastToU32(gasToPay), 0);
    }

    function requestBytecodeL1Publication(
        bytes32 _bytecodeHash
    ) external override onlyCallFrom(address(KNOWN_CODE_STORAGE_CONTRACT)) {
        chainedL1BytecodesRevealDataHash = keccak256(abi.encode(chainedL1BytecodesRevealDataHash, _bytecodeHash));

        uint256 bytecodeLen = Utils.bytecodeLenInBytes(_bytecodeHash);

        uint256 pubdataLen;
        unchecked {
            // 4 bytes used to encode the length of the bytecode (see `publishPubdataAndClearState`)
            pubdataLen = 4 + bytecodeLen;
        }

        // We need to charge cost of hashing, as it will be used in `publishPubdataAndClearState`
        uint256 gasToPay = sha256GasCost(bytecodeLen) +
            keccakGasCost(64) +
            COMPUTATIONAL_PRICE_FOR_PUBDATA *
            pubdataLen;
        SystemContractHelper.burnGas(Utils.safeCastToU32(gasToPay), uint32(pubdataLen));

        emit BytecodeL1PublicationRequested(_bytecodeHash);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L161:182

```solidity
File: system-contracts/contracts/interfaces/IL1Messenger.sol


    function sendToL1(bytes memory _message) external returns (bytes32);

    function sendL2ToL1Log(bool _isService, bytes32 _key, bytes32 _value) external returns (uint256 logIdInMerkleTree);

    function requestBytecodeL1Publication(bytes32 _bytecodeHash) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L54:54

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


    function safeCastToU32(uint256 _x) internal pure returns (uint32) {
        require(_x <= type(uint32).max, "Overflow");

        return uint32(_x);
    }

    function systemCall(uint32 gasLimit, address to, uint256 value, bytes memory data) internal returns (bool success) {
        address callAddr = SYSTEM_CALL_CALL_ADDRESS;

        uint32 dataStart;
        assembly {
            dataStart := add(data, 0x20)
        }
        uint32 dataLength = uint32(Utils.safeCastToU32(data.length));

        uint256 farCallAbi = getFarCallABI(
            0,
            0,
            dataStart,
            dataLength,
            gasLimit,
            // Only rollup is supported for now
            0,
            CalldataForwardingMode.UseHeap,
            false,
            true
        );

        if (value == 0) {
            // Doing the system call directly
            assembly {
                success := call(to, callAddr, 0, 0, farCallAbi, 0, 0)
            }
        } else {
            address msgValueSimulator = MSG_VALUE_SYSTEM_CONTRACT;
            // We need to supply the mask to the MsgValueSimulator to denote
            // that the call should be a system one.
            uint256 forwardMask = MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT;

            assembly {
                success := call(msgValueSimulator, callAddr, value, to, farCallAbi, forwardMask, 0)
            }
        }
    }

    function systemCallWithReturndata(
        uint32 gasLimit,
        address to,
        uint128 value,
        bytes memory data
    ) internal returns (bool success, bytes memory returnData) {
        success = systemCall(gasLimit, to, value, data);

        uint256 size;
        assembly {
            size := returndatasize()
        }

        returnData = new bytes(size);
        assembly {
            returndatacopy(add(returnData, 0x20), 0, size)
        }
    }

    function getFarCallABI(
        uint32 dataOffset,
        uint32 memoryPage,
        uint32 dataStart,
        uint32 dataLength,
        uint32 gasPassed,
        uint8 shardId,
        CalldataForwardingMode forwardingMode,
        bool isConstructorCall,
        bool isSystemCall
    ) internal pure returns (uint256 farCallAbi) {
        // Fill in the call parameter fields
        farCallAbi = getFarCallABIWithEmptyFatPointer(
            gasPassed,
            shardId,
            forwardingMode,
            isConstructorCall,
            isSystemCall
        );
        // Fill in the fat pointer fields
        farCallAbi |= dataOffset;
        farCallAbi |= (uint256(memoryPage) << 32);
        farCallAbi |= (uint256(dataStart) << 64);
        farCallAbi |= (uint256(dataLength) << 96);
    }

    function getFarCallABIWithEmptyFatPointer(
        uint32 gasPassed,
        uint8 shardId,
        CalldataForwardingMode forwardingMode,
        bool isConstructorCall,
        bool isSystemCall
    ) internal pure returns (uint256 farCallAbiWithEmptyFatPtr) {
        farCallAbiWithEmptyFatPtr |= (uint256(gasPassed) << 192);
        farCallAbiWithEmptyFatPtr |= (uint256(forwardingMode) << 224);
        farCallAbiWithEmptyFatPtr |= (uint256(shardId) << 232);
        if (isConstructorCall) {
            farCallAbiWithEmptyFatPtr |= (1 << 240);
        }
        if (isSystemCall) {
            farCallAbiWithEmptyFatPtr |= (1 << 248);
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L121:137

```solidity
File: system-contracts/contracts/libraries/SystemContractsCaller.sol


    function systemCall(uint32 gasLimit, address to, uint256 value, bytes memory data) internal returns (bool success) {
        address callAddr = SYSTEM_CALL_CALL_ADDRESS;

        uint32 dataStart;
        assembly {
            dataStart := add(data, 0x20)
        }
        uint32 dataLength = uint32(Utils.safeCastToU32(data.length));

        uint256 farCallAbi = SystemContractsCaller.getFarCallABI(
            0,
            0,
            dataStart,
            dataLength,
            gasLimit,
            // Only rollup is supported for now
            0,
            CalldataForwardingMode.UseHeap,
            false,
            true
        );

        if (value == 0) {
            // Doing the system call directly
            assembly {
                success := call(to, callAddr, 0, 0, farCallAbi, 0, 0)
            }
        } else {
            address msgValueSimulator = MSG_VALUE_SYSTEM_CONTRACT;
            // We need to supply the mask to the MsgValueSimulator to denote
            // that the call should be a system one.
            uint256 forwardMask = MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT;

            assembly {
                success := call(msgValueSimulator, callAddr, value, to, farCallAbi, forwardMask, 0)
            }
        }
    }

    function systemCallWithReturndata(
        uint32 gasLimit,
        address to,
        uint128 value,
        bytes memory data
    ) internal returns (bool success, bytes memory returnData) {
        success = systemCall(gasLimit, to, value, data);

        uint256 size;
        assembly {
            size := returndatasize()
        }

        returnData = new bytes(size);
        assembly {
            returndatacopy(add(returnData, 0x20), 0, size)
        }
    }

    function getFarCallABI(
        uint32 dataOffset,
        uint32 memoryPage,
        uint32 dataStart,
        uint32 dataLength,
        uint32 gasPassed,
        uint8 shardId,
        CalldataForwardingMode forwardingMode,
        bool isConstructorCall,
        bool isSystemCall
    ) internal pure returns (uint256 farCallAbi) {
        // Fill in the call parameter fields
        farCallAbi = getFarCallABIWithEmptyFatPointer(
            gasPassed,
            shardId,
            forwardingMode,
            isConstructorCall,
            isSystemCall
        );
        // Fill in the fat pointer fields
        farCallAbi |= dataOffset;
        farCallAbi |= (uint256(memoryPage) << 32);
        farCallAbi |= (uint256(dataStart) << 64);
        farCallAbi |= (uint256(dataLength) << 96);
    }

    function getFarCallABIWithEmptyFatPointer(
        uint32 gasPassed,
        uint8 shardId,
        CalldataForwardingMode forwardingMode,
        bool isConstructorCall,
        bool isSystemCall
    ) internal pure returns (uint256 farCallAbiWithEmptyFatPtr) {
        farCallAbiWithEmptyFatPtr |= (uint256(gasPassed) << 192);
        farCallAbiWithEmptyFatPtr |= (uint256(forwardingMode) << 224);
        farCallAbiWithEmptyFatPtr |= (uint256(shardId) << 232);
        if (isConstructorCall) {
            farCallAbiWithEmptyFatPtr |= (1 << 240);
        }
        if (isSystemCall) {
            farCallAbiWithEmptyFatPtr |= (1 << 248);
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L250:266

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


    function bridgeMint(address _to, uint256 _amount) external override onlyBridge {
        _mint(_to, _amount);
        emit BridgeMint(_to, _amount);
    }

    function bridgeBurn(address _from, uint256 _amount) external override onlyBridge {
        _burn(_from, _amount);
        emit BridgeBurn(_from, _amount);
    }

    function name() public view override returns (string memory) {
        // If method is not available, behave like a token that does not implement this method - revert on call.
        if (availableGetters.ignoreName) revert();
        return super.name();
    }

    function symbol() public view override returns (string memory) {
        // If method is not available, behave like a token that does not implement this method - revert on call.
        if (availableGetters.ignoreSymbol) revert();
        return super.symbol();
    }

    function decimals() public view override returns (uint8) {
        // If method is not available, behave like a token that does not implement this method - revert on call.
        if (availableGetters.ignoreDecimals) revert();
        return decimals_;
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L171:175

```solidity
File: contracts/zksync/contracts/interfaces/IPaymaster.sol


    function validateAndPayForPaymasterTransaction(
        bytes32 _txHash,
        bytes32 _suggestedSignedHash,
        Transaction calldata _transaction
    ) external payable returns (bytes4 magic, bytes memory context);

    function postTransaction(
        bytes calldata _context,
        Transaction calldata _transaction,
        bytes32 _txHash,
        bytes32 _suggestedSignedHash,
        ExecutionResult _txResult,
        uint256 _maxRefundedGas
    ) external payable;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymaster.sol#L43:50

```solidity
File: system-contracts/contracts/interfaces/IPaymaster.sol


    function validateAndPayForPaymasterTransaction(
        bytes32 _txHash,
        bytes32 _suggestedSignedHash,
        Transaction calldata _transaction
    ) external payable returns (bytes4 magic, bytes memory context);

    function postTransaction(
        bytes calldata _context,
        Transaction calldata _transaction,
        bytes32 _txHash,
        bytes32 _suggestedSignedHash,
        ExecutionResult _txResult,
        uint256 _maxRefundedGas
    ) external payable;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L43:50

```solidity
File: contracts/zksync/contracts/interfaces/IPaymasterFlow.sol


    function general(bytes calldata input) external;

    function approvalBased(address _token, uint256 _minAllowance, bytes calldata _innerInput) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymasterFlow.sol#L16:16

```solidity
File: system-contracts/contracts/interfaces/IPaymasterFlow.sol


    function general(bytes calldata input) external;

    function approvalBased(address _token, uint256 _minAllowance, bytes calldata _innerInput) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymasterFlow.sol#L15:15

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


    function storeAccountConstructingCodeHash(address _address, bytes32 _hash) external override onlyDeployer {
        // Check that code hash corresponds to the deploying smart contract
        require(Utils.isContractConstructing(_hash), "Code hash is not for a contract on constructor");
        _storeCodeHash(_address, _hash);
    }

    function storeAccountConstructedCodeHash(address _address, bytes32 _hash) external override onlyDeployer {
        // Check that code hash corresponds to the deploying smart contract
        require(Utils.isContractConstructed(_hash), "Code hash is not for a constructed contract");
        _storeCodeHash(_address, _hash);
    }

    function markAccountCodeHashAsConstructed(address _address) external override onlyDeployer {
        bytes32 codeHash = getRawCodeHash(_address);

        require(Utils.isContractConstructing(codeHash), "Code hash is not for a contract on constructor");

        // Get the bytecode hash with "isConstructor" flag equal to false
        bytes32 constructedBytecodeHash = Utils.constructedBytecodeHash(codeHash);

        _storeCodeHash(_address, constructedBytecodeHash);
    }

    function getRawCodeHash(address _address) public view override returns (bytes32 codeHash) {
        uint256 addressAsKey = uint256(uint160(_address));

        assembly {
            codeHash := sload(addressAsKey)
        }
    }

    function getCodeHash(uint256 _input) external view override returns (bytes32) {
        // We consider the account bytecode hash of the last 20 bytes of the input, because
        // according to the spec "If EXTCODEHASH of A is X, then EXTCODEHASH of A + 2**160 is X".
        address account = address(uint160(_input));
        if (uint160(account) <= CURRENT_MAX_PRECOMPILE_ADDRESS) {
            return EMPTY_STRING_KECCAK;
        }

        bytes32 codeHash = getRawCodeHash(account);

        // The code hash is equal to the `keccak256("")` if the account is an EOA with at least one transaction.
        // Otherwise, the account is either deployed smart contract or an empty account,
        // for both cases the code hash is equal to the raw code hash.
        if (codeHash == 0x00 && NONCE_HOLDER_SYSTEM_CONTRACT.getRawNonce(account) > 0) {
            codeHash = EMPTY_STRING_KECCAK;
        }
        // The contract is still on the constructor, which means it is not deployed yet,
        // so set `keccak256("")` as a code hash. The EVM has the same behavior.
        else if (Utils.isContractConstructing(codeHash)) {
            codeHash = EMPTY_STRING_KECCAK;
        }

        return codeHash;
    }

    function getCodeSize(uint256 _input) external view override returns (uint256 codeSize) {
        // We consider the account bytecode size of the last 20 bytes of the input, because
        // according to the spec "If EXTCODESIZE of A is X, then EXTCODESIZE of A + 2**160 is X".
        address account = address(uint160(_input));
        bytes32 codeHash = getRawCodeHash(account);

        // If the contract is a default account or is on constructor the code size is zero,
        // otherwise extract the proper value for it from the bytecode hash.
        // NOTE: zero address and precompiles are a special case, they are contracts, but we
        // want to preserve EVM invariants (see EIP-1052 specification). That's why we automatically
        // return `0` length in the following cases:
        // - `codehash(0) == 0`
        // - `account` is a precompile.
        // - `account` is currently being constructed
        if (
            uint160(account) > CURRENT_MAX_PRECOMPILE_ADDRESS &&
            codeHash != 0x00 &&
            !Utils.isContractConstructing(codeHash)
        ) {
            codeSize = Utils.bytecodeLenInBytes(codeHash);
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L117:138

```solidity
File: system-contracts/contracts/interfaces/IAccountCodeStorage.sol


    function storeAccountConstructingCodeHash(address _address, bytes32 _hash) external;

    function storeAccountConstructedCodeHash(address _address, bytes32 _hash) external;

    function markAccountCodeHashAsConstructed(address _address) external;

    function getRawCodeHash(address _address) external view returns (bytes32 codeHash);

    function getCodeHash(uint256 _input) external view returns (bytes32 codeHash);

    function getCodeSize(uint256 _input) external view returns (uint256 codeSize);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L16:16

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


    function getTransactionHashes(
        Transaction calldata _transaction
    ) external view override returns (bytes32 txHash, bytes32 signedTxHash) {
        signedTxHash = _transaction.encodeHash();
        if (_transaction.txType == EIP_712_TX_TYPE) {
            txHash = keccak256(bytes.concat(signedTxHash, EfficientCall.keccak(_transaction.signature)));
        } else if (_transaction.txType == LEGACY_TX_TYPE) {
            txHash = encodeLegacyTransactionHash(_transaction);
        } else if (_transaction.txType == EIP_1559_TX_TYPE) {
            txHash = encodeEIP1559TransactionHash(_transaction);
        } else if (_transaction.txType == EIP_2930_TX_TYPE) {
            txHash = encodeEIP2930TransactionHash(_transaction);
        } else {
            revert("Unsupported tx type");
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L24:39

```solidity
File: system-contracts/contracts/interfaces/IBootloaderUtilities.sol


    function getTransactionHashes(
        Transaction calldata _transaction
    ) external view returns (bytes32 txHash, bytes32 signedTxHash);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBootloaderUtilities.sol#L8:10

```solidity
File: system-contracts/contracts/Compressor.sol


    function publishCompressedBytecode(
        bytes calldata _bytecode,
        bytes calldata _rawCompressedData
    ) external payable onlyCallFromBootloader returns (bytes32 bytecodeHash) {
        unchecked {
            (bytes calldata dictionary, bytes calldata encodedData) = _decodeRawBytecode(_rawCompressedData);

            require(
                encodedData.length * 4 == _bytecode.length,
                "Encoded data length should be 4 times shorter than the original bytecode"
            );

            require(
                dictionary.length / 8 <= encodedData.length / 2,
                "Dictionary should have at most the same number of entries as the encoded data"
            );

            for (uint256 encodedDataPointer = 0; encodedDataPointer < encodedData.length; encodedDataPointer += 2) {
                uint256 indexOfEncodedChunk = uint256(encodedData.readUint16(encodedDataPointer)) * 8;
                require(indexOfEncodedChunk < dictionary.length, "Encoded chunk index is out of bounds");

                uint64 encodedChunk = dictionary.readUint64(indexOfEncodedChunk);
                uint64 realChunk = _bytecode.readUint64(encodedDataPointer * 4);

                require(encodedChunk == realChunk, "Encoded chunk does not match the original bytecode");
            }
        }

        bytecodeHash = Utils.hashL2Bytecode(_bytecode);
        L1_MESSENGER_CONTRACT.sendToL1(_rawCompressedData);
        KNOWN_CODE_STORAGE_CONTRACT.markBytecodeAsPublished(bytecodeHash);
    }

    function verifyCompressedStateDiffs(
        uint256 _numberOfStateDiffs,
        uint256 _enumerationIndexSize,
        bytes calldata _stateDiffs,
        bytes calldata _compressedStateDiffs
    ) external payable onlyCallFrom(address(L1_MESSENGER_CONTRACT)) returns (bytes32 stateDiffHash) {
        // We do not enforce the operator to use the optimal, i.e. the minimally possible _enumerationIndexSize.
        // We do enforce however, that the _enumerationIndexSize is not larger than 8 bytes long, which is the
        // maximal ever possible size for enumeration index.
        require(_enumerationIndexSize <= MAX_ENUMERATION_INDEX_SIZE, "enumeration index size is too large");

        uint256 numberOfInitialWrites = uint256(_compressedStateDiffs.readUint16(0));

        uint256 stateDiffPtr = 2;
        uint256 numInitialWritesProcessed = 0;

        // Process initial writes
        for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) {
            bytes calldata stateDiff = _stateDiffs[i:i + STATE_DIFF_ENTRY_SIZE];
            uint64 enumIndex = stateDiff.readUint64(84);
            if (enumIndex != 0) {
                // It is a repeated write, so we skip it.
                continue;
            }

            numInitialWritesProcessed++;

            bytes32 derivedKey = stateDiff.readBytes32(52);
            uint256 initValue = stateDiff.readUint256(92);
            uint256 finalValue = stateDiff.readUint256(124);
            require(derivedKey == _compressedStateDiffs.readBytes32(stateDiffPtr), "iw: initial key mismatch");
            stateDiffPtr += 32;

            uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr]));
            stateDiffPtr++;
            uint8 operation = metadata & OPERATION_BITMASK;
            uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;
            _verifyValueCompression(
                initValue,
                finalValue,
                operation,
                _compressedStateDiffs[stateDiffPtr:stateDiffPtr + len]
            );
            stateDiffPtr += len;
        }

        require(numInitialWritesProcessed == numberOfInitialWrites, "Incorrect number of initial storage diffs");

        // Process repeated writes
        for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) {
            bytes calldata stateDiff = _stateDiffs[i:i + STATE_DIFF_ENTRY_SIZE];
            uint64 enumIndex = stateDiff.readUint64(84);
            if (enumIndex == 0) {
                continue;
            }

            uint256 initValue = stateDiff.readUint256(92);
            uint256 finalValue = stateDiff.readUint256(124);
            uint256 compressedEnumIndex = _sliceToUint256(
                _compressedStateDiffs[stateDiffPtr:stateDiffPtr + _enumerationIndexSize]
            );
            require(enumIndex == compressedEnumIndex, "rw: enum key mismatch");
            stateDiffPtr += _enumerationIndexSize;

            uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr]));
            stateDiffPtr += 1;
            uint8 operation = metadata & OPERATION_BITMASK;
            uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;
            _verifyValueCompression(
                initValue,
                finalValue,
                operation,
                _compressedStateDiffs[stateDiffPtr:stateDiffPtr + len]
            );
            stateDiffPtr += len;
        }

        require(stateDiffPtr == _compressedStateDiffs.length, "Extra data in _compressedStateDiffs");

        stateDiffHash = EfficientCall.keccak(_stateDiffs);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L110:190

```solidity
File: system-contracts/contracts/interfaces/ICompressor.sol


    function publishCompressedBytecode(
        bytes calldata _bytecode,
        bytes calldata _rawCompressedData
    ) external payable returns (bytes32 bytecodeHash);

    function verifyCompressedStateDiffs(
        uint256 _numberOfStateDiffs,
        uint256 _enumerationIndexSize,
        bytes calldata _stateDiffs,
        bytes calldata _compressedStateDiffs
    ) external payable returns (bytes32 stateDiffHash);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ICompressor.sol#L24:29

```solidity
File: system-contracts/contracts/interfaces/IAccount.sol


    function validateTransaction(
        bytes32 _txHash,
        bytes32 _suggestedSignedHash,
        Transaction calldata _transaction
    ) external payable returns (bytes4 magic);

    function executeTransaction(
        bytes32 _txHash,
        bytes32 _suggestedSignedHash,
        Transaction calldata _transaction
    ) external payable;

    function executeTransactionFromOutside(Transaction calldata _transaction) external payable;

    function payForTransaction(
        bytes32 _txHash,
        bytes32 _suggestedSignedHash,
        Transaction calldata _transaction
    ) external payable;

    function prepareForPaymaster(
        bytes32 _txHash,
        bytes32 _possibleSignedHash,
        Transaction calldata _transaction
    ) external payable;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccount.sol#L42:46

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


    function getImmutable(address _dest, uint256 _index) external view override returns (bytes32) {
        return immutableDataStorage[uint256(uint160(_dest))][_index];
    }

    function setImmutables(address _dest, ImmutableData[] calldata _immutables) external override {
        require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract");
        unchecked {
            uint256 immutablesLength = _immutables.length;
            for (uint256 i = 0; i < immutablesLength; ++i) {
                uint256 index = _immutables[i].index;
                bytes32 value = _immutables[i].value;
                immutableDataStorage[uint256(uint160(_dest))][index] = value;
            }
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L34:44

```solidity
File: system-contracts/contracts/interfaces/IImmutableSimulator.sol


    function getImmutable(address _dest, uint256 _index) external view returns (bytes32);

    function setImmutables(address _dest, ImmutableData[] calldata _immutables) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L13:13

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


    function markFactoryDeps(bool _shouldSendToL1, bytes32[] calldata _hashes) external onlyCallFromBootloader {
        unchecked {
            uint256 hashesLen = _hashes.length;
            for (uint256 i = 0; i < hashesLen; ++i) {
                _markBytecodeAsPublished(_hashes[i], _shouldSendToL1);
            }
        }
    }

    function markBytecodeAsPublished(bytes32 _bytecodeHash) external onlyCompressor {
        _markBytecodeAsPublished(_bytecodeHash, false);
    }

    function getMarker(bytes32 _hash) public view override returns (uint256 marker) {
        assembly {
            marker := sload(_hash)
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L65:69

```solidity
File: system-contracts/contracts/interfaces/IKnownCodesStorage.sol


    function markFactoryDeps(bool _shouldSendToL1, bytes32[] calldata _hashes) external;

    function markBytecodeAsPublished(bytes32 _bytecodeHash) external;

    function getMarker(bytes32 _hash) external view returns (uint256);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IKnownCodesStorage.sol#L18:18

```solidity
File: system-contracts/contracts/NonceHolder.sol


    function getMinNonce(address _address) public view returns (uint256) {
        uint256 addressAsKey = uint256(uint160(_address));
        (, uint256 minNonce) = _splitRawNonce(rawNonces[addressAsKey]);

        return minNonce;
    }

    function getRawNonce(address _address) public view returns (uint256) {
        uint256 addressAsKey = uint256(uint160(_address));
        return rawNonces[addressAsKey];
    }

    function increaseMinNonce(uint256 _value) public onlySystemCall returns (uint256 oldMinNonce) {
        require(_value <= MAXIMAL_MIN_NONCE_INCREMENT, "The value for incrementing the nonce is too high");

        uint256 addressAsKey = uint256(uint160(msg.sender));
        uint256 oldRawNonce = rawNonces[addressAsKey];

        unchecked {
            rawNonces[addressAsKey] = (oldRawNonce + _value);
        }

        (, oldMinNonce) = _splitRawNonce(oldRawNonce);
    }

    function setValueUnderNonce(uint256 _key, uint256 _value) public onlySystemCall {
        IContractDeployer.AccountInfo memory accountInfo = DEPLOYER_SYSTEM_CONTRACT.getAccountInfo(msg.sender);

        require(_value != 0, "Nonce value cannot be set to 0");
        // If an account has sequential nonce ordering, we enforce that the previous
        // nonce has already been used.
        if (accountInfo.nonceOrdering == IContractDeployer.AccountNonceOrdering.Sequential && _key != 0) {
            require(isNonceUsed(msg.sender, _key - 1), "Previous nonce has not been used");
        }

        uint256 addressAsKey = uint256(uint160(msg.sender));

        nonceValues[addressAsKey][_key] = _value;

        emit ValueSetUnderNonce(msg.sender, _key, _value);
    }

    function getValueUnderNonce(uint256 _key) public view returns (uint256) {
        uint256 addressAsKey = uint256(uint160(msg.sender));
        return nonceValues[addressAsKey][_key];
    }

    function incrementMinNonceIfEquals(uint256 _expectedNonce) external onlySystemCall {
        uint256 addressAsKey = uint256(uint160(msg.sender));
        uint256 oldRawNonce = rawNonces[addressAsKey];

        (, uint256 oldMinNonce) = _splitRawNonce(oldRawNonce);
        require(oldMinNonce == _expectedNonce, "Incorrect nonce");

        unchecked {
            rawNonces[addressAsKey] = oldRawNonce + 1;
        }
    }

    function getDeploymentNonce(address _address) external view returns (uint256 deploymentNonce) {
        uint256 addressAsKey = uint256(uint160(_address));
        (deploymentNonce, ) = _splitRawNonce(rawNonces[addressAsKey]);

        return deploymentNonce;
    }

    function incrementDeploymentNonce(address _address) external returns (uint256 prevDeploymentNonce) {
        require(
            msg.sender == address(DEPLOYER_SYSTEM_CONTRACT),
            "Only the contract deployer can increment the deployment nonce"
        );
        uint256 addressAsKey = uint256(uint160(_address));
        uint256 oldRawNonce = rawNonces[addressAsKey];

        unchecked {
            rawNonces[addressAsKey] = (oldRawNonce + DEPLOY_NONCE_MULTIPLIER);
        }

        (prevDeploymentNonce, ) = _splitRawNonce(oldRawNonce);
    }

    function isNonceUsed(address _address, uint256 _nonce) public view returns (bool) {
        uint256 addressAsKey = uint256(uint160(_address));
        return (_nonce < getMinNonce(_address) || nonceValues[addressAsKey][_nonce] > 0);
    }

    function validateNonceUsage(address _address, uint256 _key, bool _shouldBeUsed) external view {
        bool isUsed = isNonceUsed(_address, _key);

        if (isUsed && !_shouldBeUsed) {
            revert("Reusing the same nonce twice");
        } else if (!isUsed && _shouldBeUsed) {
            revert("The nonce was not set as used");
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L166:174

```solidity
File: system-contracts/contracts/interfaces/INonceHolder.sol


    function getMinNonce(address _address) external view returns (uint256);

    function getRawNonce(address _address) external view returns (uint256);

    function increaseMinNonce(uint256 _value) external returns (uint256);

    function setValueUnderNonce(uint256 _key, uint256 _value) external;

    function getValueUnderNonce(uint256 _key) external view returns (uint256);

    function incrementMinNonceIfEquals(uint256 _expectedNonce) external;

    function getDeploymentNonce(address _address) external view returns (uint256);

    function incrementDeploymentNonce(address _address) external returns (uint256);

    function isNonceUsed(address _address, uint256 _nonce) external view returns (bool);

    function validateNonceUsage(address _address, uint256 _key, bool _shouldBeUsed) external view;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L43:43

```solidity
File: system-contracts/contracts/PubdataChunkPublisher.sol


    function chunkAndPublishPubdata(bytes calldata _pubdata) external onlyCallFrom(address(L1_MESSENGER_CONTRACT)) {
        require(_pubdata.length <= BLOB_SIZE_BYTES * MAX_NUMBER_OF_BLOBS, "pubdata should fit in 2 blobs");

        bytes32[] memory blobHashes = new bytes32[](MAX_NUMBER_OF_BLOBS);

        // We allocate to the full size of MAX_NUMBER_OF_BLOBS * BLOB_SIZE_BYTES because we need to pad
        // the data on the right with 0s if it doesn't take up the full blob
        bytes memory totalBlobs = new bytes(BLOB_SIZE_BYTES * MAX_NUMBER_OF_BLOBS);

        assembly {
            // The pointer to the allocated memory above. We skip 32 bytes to avoid overwriting the length.
            let ptr := add(totalBlobs, 0x20)
            calldatacopy(ptr, _pubdata.offset, _pubdata.length)
        }

        for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) {
            uint256 start = BLOB_SIZE_BYTES * i;

            // We break if the pubdata isn't enough to cover 2 blobs. On L1 it is expected that the hash
            // will be bytes32(0) if a blob isn't going to be used.
            if (start >= _pubdata.length) {
                break;
            }

            bytes32 blobHash;
            assembly {
                // The pointer to the allocated memory above skipping the length.
                let ptr := add(totalBlobs, 0x20)
                blobHash := keccak256(add(ptr, start), BLOB_SIZE_BYTES)
            }

            blobHashes[i] = blobHash;
        }

        SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.BLOB_ONE_HASH_KEY)), blobHashes[0]);
        SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.BLOB_TWO_HASH_KEY)), blobHashes[1]);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L21:57

```solidity
File: system-contracts/contracts/interfaces/IPubdataChunkPublisher.sol


    function chunkAndPublishPubdata(bytes calldata _pubdata) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPubdataChunkPublisher.sol#L12:12

```solidity
File: system-contracts/contracts/interfaces/ISystemContext.sol


    function getCurrentPubdataSpent() external view returns (uint256 currentPubdataSpent);

    function getBlockHashEVM(uint256 _block) external view returns (bytes32);

    function getBatchHash(uint256 _batchNumber) external view returns (bytes32 hash);

    function getBatchNumberAndTimestamp() external view returns (uint128 blockNumber, uint128 blockTimestamp);

    function getL2BlockNumberAndTimestamp() external view returns (uint128 blockNumber, uint128 blockTimestamp);

    function getBlockNumber() external view returns (uint128);

    function getBlockTimestamp() external view returns (uint128);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L52:52

```solidity
File: system-contracts/contracts/interfaces/ISystemContextDeprecated.sol


    function currentBlockInfo() external view returns (uint256);

    function getBlockNumberAndTimestamp() external view returns (uint256 blockNumber, uint256 blockTimestamp);

    function blockHash(uint256 _blockNumber) external view returns (bytes32 hash);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContextDeprecated.sol#L15:15

</details>

## NC060 - Use EIP-5627 to describe EIP-712 domains:

EIP-5267 is a standard which allows for the retrieval and description of EIP-712 hash domains. This enable external tools to allow users to view the fields and values that describe their domain.


```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


82          bytes32 constant EIP712_DOMAIN_TYPEHASH = keccak256("EIP712Domain(string name,string version,uint256 chainId)");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L82:82

## NC061 - It is standard for all external and public functions to be override from an interface:

This is to ensure the whole API is extracted in an interface


<details>
<summary>Click to show 243 findings</summary>

```solidity
File: contracts/GasBoundCaller.sol


35          function gasBoundCall(address _to, uint256 _maxTotalGas, bytes calldata _data) external payable {
36              // At the start of the execution we deduce how much gas be spent on things that will be
37              // paid for later on by the transaction.
38              // The `expectedForCompute` variable is an upper bound of how much this contract can spend on compute and
39              // MUST be higher or equal to the `gas` passed into the call.
40              uint256 expectedForCompute = gasleft() + CALL_ENTRY_OVERHEAD;
41      
42              // We expect that the `_maxTotalGas` at least includes the `gas` required for the call.
43              // This require is more of a safety protection for the users that call this function with incorrect parameters.
44              //
45              // Ultimately, the entire `gas` sent to this call can be spent on compute regardless of the `_maxTotalGas` parameter.
46              require(_maxTotalGas >= gasleft(), "Gas limit is too low");
47      
48              // This is the amount of gas that can be spent *exclusively* on pubdata in addition to the `gas` provided to this function.
49              uint256 pubdataAllowance = _maxTotalGas > expectedForCompute ? _maxTotalGas - expectedForCompute : 0;
50      
51              uint256 pubdataPublishedBefore = REAL_SYSTEM_CONTEXT_CONTRACT.getCurrentPubdataSpent();
52      
53              // We never permit system contract calls.
54              // If the call fails, the `EfficientCall.call` will propagate the revert.
55              // Since the revert is propagated, the pubdata published wouldn't change and so no
56              // other checks are needed.
57              bytes memory returnData = EfficientCall.call(gasleft(), _to, msg.value, _data, false);
58      
59              uint256 pubdataPublishedAfter = REAL_SYSTEM_CONTEXT_CONTRACT.getCurrentPubdataSpent();
60      
61              // It is possible that pubdataPublishedAfter < pubdataPublishedBefore if the call, e.g. removes
62              // some of the previously created state diffs
63              uint256 pubdataSpent = pubdataPublishedAfter > pubdataPublishedBefore
64                  ? pubdataPublishedAfter - pubdataPublishedBefore
65                  : 0;
66      
67              uint256 pubdataPrice = REAL_SYSTEM_CONTEXT_CONTRACT.gasPerPubdataByte();
68      
69              // In case there is an overflow here, the `_maxTotalGas` wouldbn't be able to cover it anyway, so
70              // we don't mind the contract panicking here in case of it.
71              uint256 pubdataCost = pubdataPrice * pubdataSpent;
72      
73              if (pubdataCost != 0) {
74                  // Here we double check that the additional cost is not higher than the maximum allowed.
75                  // Note, that the `gasleft()` can be spent on pubdata too.
76                  require(pubdataAllowance + gasleft() >= pubdataCost + CALL_RETURN_OVERHEAD, "Not enough gas for pubdata");
77              }
78      
79              assembly {
80                  // We just relay the return data from the call.
81                  return(add(returnData, 0x20), mload(returnData))
82              }
83          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L35:83

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


60          function initialize() external reentrancyGuardInitializer {}


63          function tranferTokenToSharedBridge(address _token, uint256 _amount) external {
64              require(msg.sender == address(sharedBridge), "Not shared bridge");
65              uint256 amount = IERC20(_token).balanceOf(address(this));
66              require(amount == _amount, "Incorrect amount");
67              IERC20(_token).safeTransfer(address(sharedBridge), amount);
68          }


75          function l2TokenAddress(address _l1Token) external view returns (address) {
76              bytes32 constructorInputHash = keccak256(abi.encode(l2TokenBeacon, ""));
77              bytes32 salt = bytes32(uint256(uint160(_l1Token)));
78      
79              return L2ContractHelper.computeCreate2Address(l2Bridge, salt, l2TokenProxyBytecodeHash, constructorInputHash);
80          }


98          function deposit(
99              address _l2Receiver,
100             address _l1Token,
101             uint256 _amount,
102             uint256 _l2TxGasLimit,
103             uint256 _l2TxGasPerPubdataByte
104         ) external payable returns (bytes32 l2TxHash) {
105             l2TxHash = deposit(_l2Receiver, _l1Token, _amount, _l2TxGasLimit, _l2TxGasPerPubdataByte, address(0));
106         }


133         function deposit(
134             address _l2Receiver,
135             address _l1Token,
136             uint256 _amount,
137             uint256 _l2TxGasLimit,
138             uint256 _l2TxGasPerPubdataByte,
139             address _refundRecipient
140         ) public payable nonReentrant returns (bytes32 l2TxHash) {
141             require(_amount != 0, "0T"); // empty deposit
142             uint256 amount = _depositFundsToSharedBridge(msg.sender, IERC20(_l1Token), _amount);
143             require(amount == _amount, "3T"); // The token has non-standard transfer logic
144     
145             l2TxHash = sharedBridge.depositLegacyErc20Bridge{value: msg.value}(
146                 msg.sender,
147                 _l2Receiver,
148                 _l1Token,
149                 _amount,
150                 _l2TxGasLimit,
151                 _l2TxGasPerPubdataByte,
152                 _refundRecipient
153             );
154             depositAmount[msg.sender][_l1Token][l2TxHash] = _amount;
155             emit DepositInitiated(l2TxHash, msg.sender, _l2Receiver, _l1Token, _amount);
156         }


176         function claimFailedDeposit(
177             address _depositSender,
178             address _l1Token,
179             bytes32 _l2TxHash,
180             uint256 _l2BatchNumber,
181             uint256 _l2MessageIndex,
182             uint16 _l2TxNumberInBatch,
183             bytes32[] calldata _merkleProof
184         ) external nonReentrant {
185             uint256 amount = depositAmount[_depositSender][_l1Token][_l2TxHash];
186             require(amount != 0, "2T"); // empty deposit
187             delete depositAmount[_depositSender][_l1Token][_l2TxHash];
188     
189             sharedBridge.claimFailedDepositLegacyErc20Bridge(
190                 _depositSender,
191                 _l1Token,
192                 amount,
193                 _l2TxHash,
194                 _l2BatchNumber,
195                 _l2MessageIndex,
196                 _l2TxNumberInBatch,
197                 _merkleProof
198             );
199             emit ClaimedFailedDeposit(_depositSender, _l1Token, amount);
200         }


208         function finalizeWithdrawal(
209             uint256 _l2BatchNumber,
210             uint256 _l2MessageIndex,
211             uint16 _l2TxNumberInBatch,
212             bytes calldata _message,
213             bytes32[] calldata _merkleProof
214         ) external nonReentrant {
215             require(!isWithdrawalFinalized[_l2BatchNumber][_l2MessageIndex], "pw");
216             // We don't need to set finalizeWithdrawal here, as we set it in the shared bridge
217     
218             (address l1Receiver, address l1Token, uint256 amount) = sharedBridge.finalizeWithdrawalLegacyErc20Bridge(
219                 _l2BatchNumber,
220                 _l2MessageIndex,
221                 _l2TxNumberInBatch,
222                 _message,
223                 _merkleProof
224             );
225             emit WithdrawalFinalized(l1Receiver, l1Token, amount);
226         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L208:226

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


104         function initialize(
105             address _owner,
106             uint256 _eraFirstPostUpgradeBatch
107         ) external reentrancyGuardInitializer initializer {
108             require(_owner != address(0), "ShB owner 0");
109             _transferOwnership(_owner);
110     
111             eraFirstPostUpgradeBatch = _eraFirstPostUpgradeBatch;
112             l2BridgeAddress[ERA_CHAIN_ID] = ERA_ERC20_BRIDGE_ADDRESS;
113         }


116         function transferFundsFromLegacy(address _token, address _target, uint256 _targetChainId) external onlyOwner {
117             if (_token == ETH_TOKEN_ADDRESS) {
118                 uint256 balanceBefore = address(this).balance;
119                 IMailbox(_target).transferEthToSharedBridge();
120                 uint256 balanceAfter = address(this).balance;
121                 require(balanceAfter > balanceBefore, "ShB: 0 eth transferred");
122                 chainBalance[_targetChainId][ETH_TOKEN_ADDRESS] =
123                     chainBalance[_targetChainId][ETH_TOKEN_ADDRESS] +
124                     balanceAfter -
125                     balanceBefore;
126             } else {
127                 uint256 balanceBefore = IERC20(_token).balanceOf(address(this));
128                 uint256 amount = IERC20(_token).balanceOf(address(legacyBridge));
129                 require(amount > 0, "ShB: 0 amount to transfer");
130                 IL1ERC20Bridge(_target).tranferTokenToSharedBridge(_token, amount);
131                 uint256 balanceAfter = IERC20(_token).balanceOf(address(this));
132                 require(balanceAfter - balanceBefore == amount, "ShB: wrong amount transferred");
133                 chainBalance[_targetChainId][_token] = chainBalance[_targetChainId][_token] + amount;
134             }
135         }


137         function receiveEth(uint256 _chainId) external payable {
138             require(bridgehub.getStateTransition(_chainId) == msg.sender, "receiveEth not state transition");
139         }


142         function initializeChainGovernance(uint256 _chainId, address _l2BridgeAddress) external onlyOwner {
143             l2BridgeAddress[_chainId] = _l2BridgeAddress;
144         }


148         function bridgehubDepositBaseToken(
149             uint256 _chainId,
150             address _prevMsgSender,
151             address _l1Token,
152             uint256 _amount
153         ) external payable virtual onlyBridgehubOrEra(_chainId) {
154             if (_l1Token == ETH_TOKEN_ADDRESS) {
155                 require(msg.value == _amount, "L1SharedBridge: msg.value not equal to amount");
156             } else {
157                 // The Bridgehub also checks this, but we want to be sure
158                 require(msg.value == 0, "ShB m.v > 0 b d.it");
159     
160                 uint256 amount = _depositFunds(_prevMsgSender, IERC20(_l1Token), _amount); // note if _prevMsgSender is this contract, this will return 0. This does not happen.
161                 require(amount == _amount, "3T"); // The token has non-standard transfer logic
162             }
163     
164             if (!hyperbridgingEnabled[_chainId]) {
165                 chainBalance[_chainId][_l1Token] += _amount;
166             }
167             // Note that we don't save the deposited amount, as this is for the base token, which gets sent to the refundRecipient if the tx fails
168             emit BridgehubDepositBaseTokenInitiated(_chainId, _prevMsgSender, _l1Token, _amount);
169         }


182         function bridgehubDeposit(
183             uint256 _chainId,
184             address _prevMsgSender,
185             uint256, // l2Value, needed for Weth deposits in the future
186             bytes calldata _data
187         ) external payable override onlyBridgehub returns (L2TransactionRequestTwoBridgesInner memory request) {
188             require(l2BridgeAddress[_chainId] != address(0), "ShB l2 bridge not deployed");
189     
190             (address _l1Token, uint256 _depositAmount, address _l2Receiver) = abi.decode(
191                 _data,
192                 (address, uint256, address)
193             );
194             require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported");
195             require(bridgehub.baseToken(_chainId) != _l1Token, "ShB: baseToken deposit not supported");
196     
197             uint256 amount;
198             if (_l1Token == ETH_TOKEN_ADDRESS) {
199                 amount = msg.value;
200                 require(_depositAmount == 0, "ShB wrong withdraw amount");
201             } else {
202                 require(msg.value == 0, "ShB m.v > 0 for BH d.it 2");
203                 amount = _depositAmount;
204     
205                 uint256 withdrawAmount = _depositFunds(_prevMsgSender, IERC20(_l1Token), _depositAmount);
206                 require(withdrawAmount == _depositAmount, "5T"); // The token has non-standard transfer logic
207             }
208             require(amount != 0, "6T"); // empty deposit amount
209     
210             bytes32 txDataHash = keccak256(abi.encode(_prevMsgSender, _l1Token, amount));
211             if (!hyperbridgingEnabled[_chainId]) {
212                 chainBalance[_chainId][_l1Token] += amount;
213             }
214     
215             {
216                 // Request the finalization of the deposit on the L2 side
217                 bytes memory l2TxCalldata = _getDepositL2Calldata(_prevMsgSender, _l2Receiver, _l1Token, amount);
218     
219                 request = L2TransactionRequestTwoBridgesInner({
220                     magicValue: TWO_BRIDGES_MAGIC_VALUE,
221                     l2Contract: l2BridgeAddress[_chainId],
222                     l2Calldata: l2TxCalldata,
223                     factoryDeps: new bytes[](0),
224                     txDataHash: txDataHash
225                 });
226             }
227             emit BridgehubDepositInitiated(_chainId, txDataHash, _prevMsgSender, _l2Receiver, _l1Token, amount);
228         }


232         function bridgehubConfirmL2Transaction(
233             uint256 _chainId,
234             bytes32 _txDataHash,
235             bytes32 _txHash
236         ) external override onlyBridgehub {
237             require(depositHappened[_chainId][_txHash] == 0x00, "ShB tx hap");
238             depositHappened[_chainId][_txHash] = _txDataHash;
239             emit BridgehubDepositFinalized(_chainId, _txDataHash, _txHash);
240         }


277         function claimFailedDeposit(
278             uint256 _chainId,
279             address _depositSender,
280             address _l1Token,
281             uint256 _amount,
282             bytes32 _l2TxHash,
283             uint256 _l2BatchNumber,
284             uint256 _l2MessageIndex,
285             uint16 _l2TxNumberInBatch,
286             bytes32[] calldata _merkleProof
287         ) external override {
288             _claimFailedDeposit(
289                 false,
290                 _chainId,
291                 _depositSender,
292                 _l1Token,
293                 _amount,
294                 _l2TxHash,
295                 _l2BatchNumber,
296                 _l2MessageIndex,
297                 _l2TxNumberInBatch,
298                 _merkleProof
299             );
300         }


385         function finalizeWithdrawal(
386             uint256 _chainId,
387             uint256 _l2BatchNumber,
388             uint256 _l2MessageIndex,
389             uint16 _l2TxNumberInBatch,
390             bytes calldata _message,
391             bytes32[] calldata _merkleProof
392         ) external override {
393             // To avoid rewithdrawing txs that have already happened on the legacy bridge.
394             // Note: new withdraws are all recorded here, so double withdrawing them is not possible.
395             if (_isEraLegacyWithdrawal(_chainId, _l2BatchNumber)) {
396                 require(!legacyBridge.isWithdrawalFinalized(_l2BatchNumber, _l2MessageIndex), "ShB: legacy withdrawal");
397             }
398             _finalizeWithdrawal(_chainId, _l2BatchNumber, _l2MessageIndex, _l2TxNumberInBatch, _message, _merkleProof);
399         }


554         function depositLegacyErc20Bridge(
555             address _prevMsgSender,
556             address _l2Receiver,
557             address _l1Token,
558             uint256 _amount,
559             uint256 _l2TxGasLimit,
560             uint256 _l2TxGasPerPubdataByte,
561             address _refundRecipient
562         ) external payable override onlyLegacyBridge nonReentrant returns (bytes32 l2TxHash) {
563             require(l2BridgeAddress[ERA_CHAIN_ID] != address(0), "ShB b. n dep");
564             require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported 2");
565     
566             // Note that funds have been transferred to this contract in the legacy ERC20 bridge.
567             if (!hyperbridgingEnabled[ERA_CHAIN_ID]) {
568                 chainBalance[ERA_CHAIN_ID][_l1Token] += _amount;
569             }
570     
571             bytes memory l2TxCalldata = _getDepositL2Calldata(_prevMsgSender, _l2Receiver, _l1Token, _amount);
572     
573             {
574                 // If the refund recipient is not specified, the refund will be sent to the sender of the transaction.
575                 // Otherwise, the refund will be sent to the specified address.
576                 // If the recipient is a contract on L1, the address alias will be applied.
577                 address refundRecipient = _refundRecipient;
578                 if (_refundRecipient == address(0)) {
579                     refundRecipient = _prevMsgSender != tx.origin
580                         ? AddressAliasHelper.applyL1ToL2Alias(_prevMsgSender)
581                         : _prevMsgSender;
582                 }
583     
584                 L2TransactionRequestDirect memory request = L2TransactionRequestDirect({
585                     chainId: ERA_CHAIN_ID,
586                     l2Contract: l2BridgeAddress[ERA_CHAIN_ID],
587                     mintValue: msg.value, // l2 gas + l2 msg.Value the bridgehub will withdraw the mintValue from the base token bridge for gas
588                     l2Value: 0, // L2 msg.value, this contract doesn't support base token deposits or wrapping functionality, for direct deposits use bridgehub
589                     l2Calldata: l2TxCalldata,
590                     l2GasLimit: _l2TxGasLimit,
591                     l2GasPerPubdataByteLimit: _l2TxGasPerPubdataByte,
592                     factoryDeps: new bytes[](0),
593                     refundRecipient: refundRecipient
594                 });
595                 l2TxHash = bridgehub.requestL2TransactionDirect{value: msg.value}(request);
596             }
597     
598             bytes32 txDataHash = keccak256(abi.encode(_prevMsgSender, _l1Token, _amount));
599             // Save the deposited amount to claim funds on L1 if the deposit failed on L2
600             depositHappened[ERA_CHAIN_ID][l2TxHash] = txDataHash;
601     
602             emit LegacyDepositInitiated(ERA_CHAIN_ID, l2TxHash, _prevMsgSender, _l2Receiver, _l1Token, _amount);
603         }


615         function finalizeWithdrawalLegacyErc20Bridge(
616             uint256 _l2BatchNumber,
617             uint256 _l2MessageIndex,
618             uint16 _l2TxNumberInBatch,
619             bytes calldata _message,
620             bytes32[] calldata _merkleProof
621         ) external override onlyLegacyBridge returns (address l1Receiver, address l1Token, uint256 amount) {
622             (l1Receiver, l1Token, amount) = _finalizeWithdrawal(
623                 ERA_CHAIN_ID,
624                 _l2BatchNumber,
625                 _l2MessageIndex,
626                 _l2TxNumberInBatch,
627                 _message,
628                 _merkleProof
629             );
630         }


644         function claimFailedDepositLegacyErc20Bridge(
645             address _depositSender,
646             address _l1Token,
647             uint256 _amount,
648             bytes32 _l2TxHash,
649             uint256 _l2BatchNumber,
650             uint256 _l2MessageIndex,
651             uint16 _l2TxNumberInBatch,
652             bytes32[] calldata _merkleProof
653         ) external override onlyLegacyBridge {
654             _claimFailedDeposit(
655                 true,
656                 ERA_CHAIN_ID,
657                 _depositSender,
658                 _l1Token,
659                 _amount,
660                 _l2TxHash,
661                 _l2BatchNumber,
662                 _l2MessageIndex,
663                 _l2TxNumberInBatch,
664                 _merkleProof
665             );
666         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L644:666

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


41          function initialize(address _owner) external reentrancyGuardInitializer {
42              _transferOwnership(_owner);
43          }


51          function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin {
52              // Save previous value into the stack to put it into the event later
53              address oldPendingAdmin = pendingAdmin;
54              // Change pending admin
55              pendingAdmin = _newPendingAdmin;
56              emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
57          }


60          function acceptAdmin() external {
61              address currentPendingAdmin = pendingAdmin;
62              require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights
63      
64              address previousAdmin = admin;
65              admin = currentPendingAdmin;
66              delete pendingAdmin;
67      
68              emit NewPendingAdmin(currentPendingAdmin, address(0));
69              emit NewAdmin(previousAdmin, pendingAdmin);
70          }


75          function getStateTransition(uint256 _chainId) public view returns (address) {
76              return IStateTransitionManager(stateTransitionManager[_chainId]).stateTransition(_chainId);
77          }


82          function addStateTransitionManager(address _stateTransitionManager) external onlyOwner {
83              require(
84                  !stateTransitionManagerIsRegistered[_stateTransitionManager],
85                  "Bridgehub: state transition already registered"
86              );
87              stateTransitionManagerIsRegistered[_stateTransitionManager] = true;
88          }


92          function removeStateTransitionManager(address _stateTransitionManager) external onlyOwner {
93              require(
94                  stateTransitionManagerIsRegistered[_stateTransitionManager],
95                  "Bridgehub: state transition not registered yet"
96              );
97              stateTransitionManagerIsRegistered[_stateTransitionManager] = false;
98          }


101         function addToken(address _token) external onlyOwner {
102             require(!tokenIsRegistered[_token], "Bridgehub: token already registered");
103             tokenIsRegistered[_token] = true;
104         }


108         function setSharedBridge(address _sharedBridge) external onlyOwner {
109             sharedBridge = IL1SharedBridge(_sharedBridge);
110         }


114         function createNewChain(
115             uint256 _chainId,
116             address _stateTransitionManager,
117             address _baseToken,
118             uint256, //_salt
119             address _admin,
120             bytes calldata _initData
121         ) external onlyOwnerOrAdmin nonReentrant returns (uint256 chainId) {
122             require(_chainId != 0, "Bridgehub: chainId cannot be 0");
123             require(_chainId <= type(uint48).max, "Bridgehub: chainId too large");
124     
125             require(
126                 stateTransitionManagerIsRegistered[_stateTransitionManager],
127                 "Bridgehub: state transition not registered"
128             );
129             require(tokenIsRegistered[_baseToken], "Bridgehub: token not registered");
130             require(address(sharedBridge) != address(0), "Bridgehub: weth bridge not set");
131     
132             require(stateTransitionManager[_chainId] == address(0), "Bridgehub: chainId already registered");
133     
134             stateTransitionManager[_chainId] = _stateTransitionManager;
135             baseToken[_chainId] = _baseToken;
136     
137             IStateTransitionManager(_stateTransitionManager).createNewChain(
138                 _chainId,
139                 _baseToken,
140                 address(sharedBridge),
141                 _admin,
142                 _initData
143             );
144     
145             emit NewChain(_chainId, _stateTransitionManager, _admin);
146             return _chainId;
147         }


152         function proveL2MessageInclusion(
153             uint256 _chainId,
154             uint256 _batchNumber,
155             uint256 _index,
156             L2Message calldata _message,
157             bytes32[] calldata _proof
158         ) external view override returns (bool) {
159             address stateTransition = getStateTransition(_chainId);
160             return IZkSyncStateTransition(stateTransition).proveL2MessageInclusion(_batchNumber, _index, _message, _proof);
161         }


164         function proveL2LogInclusion(
165             uint256 _chainId,
166             uint256 _batchNumber,
167             uint256 _index,
168             L2Log memory _log,
169             bytes32[] calldata _proof
170         ) external view override returns (bool) {
171             address stateTransition = getStateTransition(_chainId);
172             return IZkSyncStateTransition(stateTransition).proveL2LogInclusion(_batchNumber, _index, _log, _proof);
173         }


176         function proveL1ToL2TransactionStatus(
177             uint256 _chainId,
178             bytes32 _l2TxHash,
179             uint256 _l2BatchNumber,
180             uint256 _l2MessageIndex,
181             uint16 _l2TxNumberInBatch,
182             bytes32[] calldata _merkleProof,
183             TxStatus _status
184         ) external view override returns (bool) {
185             address stateTransition = getStateTransition(_chainId);
186             return
187                 IZkSyncStateTransition(stateTransition).proveL1ToL2TransactionStatus(
188                     _l2TxHash,
189                     _l2BatchNumber,
190                     _l2MessageIndex,
191                     _l2TxNumberInBatch,
192                     _merkleProof,
193                     _status
194                 );
195         }


198         function l2TransactionBaseCost(
199             uint256 _chainId,
200             uint256 _gasPrice,
201             uint256 _l2GasLimit,
202             uint256 _l2GasPerPubdataByteLimit
203         ) external view returns (uint256) {
204             address stateTransition = getStateTransition(_chainId);
205             return
206                 IZkSyncStateTransition(stateTransition).l2TransactionBaseCost(
207                     _gasPrice,
208                     _l2GasLimit,
209                     _l2GasPerPubdataByteLimit
210                 );
211         }


217         function requestL2TransactionDirect(
218             L2TransactionRequestDirect calldata _request
219         ) external payable override nonReentrant returns (bytes32 canonicalTxHash) {
220             {
221                 address token = baseToken[_request.chainId];
222                 if (token == ETH_TOKEN_ADDRESS) {
223                     require(msg.value == _request.mintValue, "Bridgehub: msg.value mismatch 1");
224                 } else {
225                     require(msg.value == 0, "Bridgehub: non-eth bridge with msg.value");
226                 }
227     
228                 sharedBridge.bridgehubDepositBaseToken{value: msg.value}(
229                     _request.chainId,
230                     msg.sender,
231                     token,
232                     _request.mintValue
233                 );
234             }
235     
236             address stateTransition = getStateTransition(_request.chainId);
237             address refundRecipient = _actualRefundRecipient(_request.refundRecipient);
238             canonicalTxHash = IZkSyncStateTransition(stateTransition).bridgehubRequestL2Transaction(
239                 BridgehubL2TransactionRequest({
240                     sender: msg.sender,
241                     contractL2: _request.l2Contract,
242                     mintValue: _request.mintValue,
243                     l2Value: _request.l2Value,
244                     l2Calldata: _request.l2Calldata,
245                     l2GasLimit: _request.l2GasLimit,
246                     l2GasPerPubdataByteLimit: _request.l2GasPerPubdataByteLimit,
247                     factoryDeps: _request.factoryDeps,
248                     refundRecipient: refundRecipient
249                 })
250             );
251         }


262         function requestL2TransactionTwoBridges(
263             L2TransactionRequestTwoBridgesOuter calldata _request
264         ) external payable override nonReentrant returns (bytes32 canonicalTxHash) {
265             {
266                 address token = baseToken[_request.chainId];
267                 uint256 baseTokenMsgValue;
268                 if (token == ETH_TOKEN_ADDRESS) {
269                     require(
270                         msg.value == _request.mintValue + _request.secondBridgeValue,
271                         "Bridgehub: msg.value mismatch 2"
272                     );
273                     baseTokenMsgValue = _request.mintValue;
274                 } else {
275                     require(msg.value == _request.secondBridgeValue, "Bridgehub: msg.value mismatch 3");
276                     baseTokenMsgValue = 0;
277                 }
278                 sharedBridge.bridgehubDepositBaseToken{value: baseTokenMsgValue}(
279                     _request.chainId,
280                     msg.sender,
281                     token,
282                     _request.mintValue
283                 );
284             }
285     
286             address stateTransition = getStateTransition(_request.chainId);
287     
288             L2TransactionRequestTwoBridgesInner memory outputRequest = IL1SharedBridge(_request.secondBridgeAddress)
289                 .bridgehubDeposit{value: _request.secondBridgeValue}(
290                 _request.chainId,
291                 msg.sender,
292                 _request.l2Value,
293                 _request.secondBridgeCalldata
294             );
295     
296             require(outputRequest.magicValue == TWO_BRIDGES_MAGIC_VALUE, "Bridgehub: magic value mismatch");
297     
298             address refundRecipient = _actualRefundRecipient(_request.refundRecipient);
299     
300             require(
301                 _request.secondBridgeAddress > BRIDGEHUB_MIN_SECOND_BRIDGE_ADDRESS,
302                 "Bridgehub: second bridge address too low"
303             ); // to avoid calls to precompiles
304             canonicalTxHash = IZkSyncStateTransition(stateTransition).bridgehubRequestL2Transaction(
305                 BridgehubL2TransactionRequest({
306                     sender: _request.secondBridgeAddress,
307                     contractL2: outputRequest.l2Contract,
308                     mintValue: _request.mintValue,
309                     l2Value: _request.l2Value,
310                     l2Calldata: outputRequest.l2Calldata,
311                     l2GasLimit: _request.l2GasLimit,
312                     l2GasPerPubdataByteLimit: _request.l2GasPerPubdataByteLimit,
313                     factoryDeps: outputRequest.factoryDeps,
314                     refundRecipient: refundRecipient
315                 })
316             );
317     
318             IL1SharedBridge(_request.secondBridgeAddress).bridgehubConfirmL2Transaction(
319                 _request.chainId,
320                 outputRequest.txDataHash,
321                 canonicalTxHash
322             );
323         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L262:323

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


84          function isOperation(bytes32 _id) public view returns (bool) {
85              return getOperationState(_id) != OperationState.Unset;
86          }


89          function isOperationPending(bytes32 _id) public view returns (bool) {
90              OperationState state = getOperationState(_id);
91              return state == OperationState.Waiting || state == OperationState.Ready;
92          }


95          function isOperationReady(bytes32 _id) public view returns (bool) {
96              return getOperationState(_id) == OperationState.Ready;
97          }


100         function isOperationDone(bytes32 _id) public view returns (bool) {
101             return getOperationState(_id) == OperationState.Done;
102         }


105         function getOperationState(bytes32 _id) public view returns (OperationState) {
106             uint256 timestamp = timestamps[_id];
107             if (timestamp == 0) {
108                 return OperationState.Unset;
109             } else if (timestamp == EXECUTED_PROPOSAL_TIMESTAMP) {
110                 return OperationState.Done;
111             } else if (timestamp > block.timestamp) {
112                 return OperationState.Waiting;
113             } else {
114                 return OperationState.Ready;
115             }
116         }


129         function scheduleTransparent(Operation calldata _operation, uint256 _delay) external onlyOwner {
130             bytes32 id = hashOperation(_operation);
131             _schedule(id, _delay);
132             emit TransparentOperationScheduled(id, _delay, _operation);
133         }


142         function scheduleShadow(bytes32 _id, uint256 _delay) external onlyOwner {
143             _schedule(_id, _delay);
144             emit ShadowOperationScheduled(_id, _delay);
145         }


154         function cancel(bytes32 _id) external onlyOwner {
155             require(isOperationPending(_id), "Operation must be pending");
156             delete timestamps[_id];
157             emit OperationCancelled(_id);
158         }


167         function execute(Operation calldata _operation) external payable onlyOwnerOrSecurityCouncil {
168             bytes32 id = hashOperation(_operation);
169             // Check if the predecessor operation is completed.
170             _checkPredecessorDone(_operation.predecessor);
171             // Ensure that the operation is ready to proceed.
172             require(isOperationReady(id), "Operation must be ready before execution");
173             // Execute operation.
174             _execute(_operation.calls);
175             // Reconfirming that the operation is still ready after execution.
176             // This is needed to avoid unexpected reentrancy attacks of re-executing the same operation.
177             require(isOperationReady(id), "Operation must be ready after execution");
178             // Set operation to be done
179             timestamps[id] = EXECUTED_PROPOSAL_TIMESTAMP;
180             emit OperationExecuted(id);
181         }


186         function executeInstant(Operation calldata _operation) external payable onlySecurityCouncil {
187             bytes32 id = hashOperation(_operation);
188             // Check if the predecessor operation is completed.
189             _checkPredecessorDone(_operation.predecessor);
190             // Ensure that the operation is in a pending state before proceeding.
191             require(isOperationPending(id), "Operation must be pending before execution");
192             // Execute operation.
193             _execute(_operation.calls);
194             // Reconfirming that the operation is still pending before execution.
195             // This is needed to avoid unexpected reentrancy attacks of re-executing the same operation.
196             require(isOperationPending(id), "Operation must be pending after execution");
197             // Set operation to be done
198             timestamps[id] = EXECUTED_PROPOSAL_TIMESTAMP;
199             emit OperationExecuted(id);
200         }


204         function hashOperation(Operation calldata _operation) public pure returns (bytes32) {
205             return keccak256(abi.encode(_operation));
206         }


249         function updateDelay(uint256 _newDelay) external onlySelf {
250             emit ChangeMinDelay(minDelay, _newDelay);
251             minDelay = _newDelay;
252         }


256         function updateSecurityCouncil(address _newSecurityCouncil) external onlySelf {
257             emit ChangeSecurityCouncil(securityCouncil, _newSecurityCouncil);
258             securityCouncil = _newSecurityCouncil;
259         }


262         receive() external payable {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L262:262

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


74          function getChainAdmin(uint256 _chainId) external view override returns (address) {
75              return IZkSyncStateTransition(stateTransition[_chainId]).getAdmin();
76          }


79          function initialize(
80              StateTransitionManagerInitializeData calldata _initializeData
81          ) external reentrancyGuardInitializer {
82              require(_initializeData.governor != address(0), "StateTransition: governor zero");
83              _transferOwnership(_initializeData.governor);
84      
85              genesisUpgrade = _initializeData.genesisUpgrade;
86              protocolVersion = _initializeData.protocolVersion;
87              validatorTimelock = _initializeData.validatorTimelock;
88      
89              // We need to initialize the state hash because it is used in the commitment of the next batch
90              IExecutor.StoredBatchInfo memory batchZero = IExecutor.StoredBatchInfo(
91                  0,
92                  _initializeData.genesisBatchHash,
93                  _initializeData.genesisIndexRepeatedStorageChanges,
94                  0,
95                  EMPTY_STRING_KECCAK,
96                  DEFAULT_L2_LOGS_TREE_ROOT_HASH,
97                  0,
98                  _initializeData.genesisBatchCommitment
99              );
100             storedBatchZero = keccak256(abi.encode(batchZero));
101     
102             initialCutHash = keccak256(abi.encode(_initializeData.diamondCut));
103     
104             // While this does not provide a protection in the production, it is needed for local testing
105             // Length of the L2Log encoding should not be equal to the length of other L2Logs' tree nodes preimages
106             assert(L2_TO_L1_LOG_SERIALIZE_SIZE != 2 * 32);
107         }


110         function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin {
111             // Save previous value into the stack to put it into the event later
112             address oldPendingAdmin = pendingAdmin;
113             // Change pending admin
114             pendingAdmin = _newPendingAdmin;
115             emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
116         }


119         function acceptAdmin() external {
120             address currentPendingAdmin = pendingAdmin;
121             require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights
122     
123             address previousAdmin = admin;
124             admin = currentPendingAdmin;
125             delete pendingAdmin;
126     
127             emit NewPendingAdmin(currentPendingAdmin, address(0));
128             emit NewAdmin(previousAdmin, pendingAdmin);
129         }


132         function setValidatorTimelock(address _validatorTimelock) external onlyOwnerOrAdmin {
133             validatorTimelock = _validatorTimelock;
134         }


137         function setInitialCutHash(Diamond.DiamondCutData calldata _diamondCut) external onlyOwner {
138             initialCutHash = keccak256(abi.encode(_diamondCut));
139         }


142         function setNewVersionUpgrade(
143             Diamond.DiamondCutData calldata _cutData,
144             uint256 _oldProtocolVersion,
145             uint256 _newProtocolVersion
146         ) external onlyOwner {
147             upgradeCutHash[_oldProtocolVersion] = keccak256(abi.encode(_cutData));
148             protocolVersion = _newProtocolVersion;
149         }


152         function setUpgradeDiamondCut(
153             Diamond.DiamondCutData calldata _cutData,
154             uint256 _oldProtocolVersion
155         ) external onlyOwner {
156             upgradeCutHash[_oldProtocolVersion] = keccak256(abi.encode(_cutData));
157         }


160         function freezeChain(uint256 _chainId) external onlyOwner {
161             IZkSyncStateTransition(stateTransition[_chainId]).freezeDiamond();
162         }


165         function unfreezeChain(uint256 _chainId) external onlyOwner {
166             IZkSyncStateTransition(stateTransition[_chainId]).freezeDiamond();
167         }


170         function revertBatches(uint256 _chainId, uint256 _newLastBatch) external onlyOwnerOrAdmin {
171             IZkSyncStateTransition(stateTransition[_chainId]).revertBatches(_newLastBatch);
172         }


230         function registerAlreadyDeployedStateTransition(
231             uint256 _chainId,
232             address _stateTransitionContract
233         ) external onlyOwner {
234             stateTransition[_chainId] = _stateTransitionContract;
235             emit StateTransitionNewChain(_chainId, _stateTransitionContract);
236         }


239         function createNewChain(
240             uint256 _chainId,
241             address _baseToken,
242             address _sharedBridge,
243             address _admin,
244             bytes calldata _diamondCut
245         ) external onlyBridgehub {
246             if (stateTransition[_chainId] != address(0)) {
247                 // StateTransition chain already registered
248                 return;
249             }
250     
251             // check not registered
252             Diamond.DiamondCutData memory diamondCut = abi.decode(_diamondCut, (Diamond.DiamondCutData));
253     
254             // check input
255             bytes32 cutHashInput = keccak256(_diamondCut);
256             require(cutHashInput == initialCutHash, "StateTransition: initial cutHash mismatch");
257     
258             // construct init data
259             bytes memory initData;
260             /// all together 4+9*32=292 bytes
261             initData = bytes.concat(
262                 IDiamondInit.initialize.selector,
263                 bytes32(_chainId),
264                 bytes32(uint256(uint160(bridgehub))),
265                 bytes32(uint256(uint160(address(this)))),
266                 bytes32(uint256(protocolVersion)),
267                 bytes32(uint256(uint160(_admin))),
268                 bytes32(uint256(uint160(validatorTimelock))),
269                 bytes32(uint256(uint160(_baseToken))),
270                 bytes32(uint256(uint160(_sharedBridge))),
271                 bytes32(storedBatchZero),
272                 diamondCut.initCalldata
273             );
274     
275             diamondCut.initCalldata = initData;
276             // deploy stateTransitionContract
277             DiamondProxy stateTransitionContract = new DiamondProxy{salt: bytes32(0)}(block.chainid, diamondCut);
278     
279             // save data
280             address stateTransitionAddress = address(stateTransitionContract);
281     
282             stateTransition[_chainId] = stateTransitionAddress;
283     
284             // set chainId in VM
285             _setChainIdUpgrade(_chainId, stateTransitionAddress);
286     
287             emit StateTransitionNewChain(_chainId, stateTransitionAddress);
288         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L239:288

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


73          function setStateTransitionManager(IStateTransitionManager _stateTransitionManager) external onlyOwner {
74              stateTransitionManager = _stateTransitionManager;
75          }


78          function addValidator(uint256 _chainId, address _newValidator) external onlyChainAdmin(_chainId) {
79              if (validators[_chainId][_newValidator]) {
80                  revert AddressAlreadyValidator(_chainId);
81              }
82              validators[_chainId][_newValidator] = true;
83              emit ValidatorAdded(_chainId, _newValidator);
84          }


87          function removeValidator(uint256 _chainId, address _validator) external onlyChainAdmin(_chainId) {
88              if (!validators[_chainId][_validator]) {
89                  revert ValidatorDoesNotExist(_chainId);
90              }
91              validators[_chainId][_validator] = false;
92              emit ValidatorRemoved(_chainId, _validator);
93          }


96          function setExecutionDelay(uint32 _executionDelay) external onlyOwner {
97              executionDelay = _executionDelay;
98              emit NewExecutionDelay(_executionDelay);
99          }


102         function getCommittedBatchTimestamp(uint256 _chainId, uint256 _l2BatchNumber) external view returns (uint256) {
103             return committedBatchTimestamp[_chainId].get(_l2BatchNumber);
104         }


108         function commitBatches(
109             StoredBatchInfo calldata,
110             CommitBatchInfo[] calldata _newBatchesData
111         ) external onlyValidator(ERA_CHAIN_ID) {
112             unchecked {
113                 // This contract is only a temporary solution, that hopefully will be disabled until 2106 year, so...
114                 // It is safe to cast.
115                 uint32 timestamp = uint32(block.timestamp);
116                 for (uint256 i = 0; i < _newBatchesData.length; ++i) {
117                     committedBatchTimestamp[ERA_CHAIN_ID].set(_newBatchesData[i].batchNumber, timestamp);
118                 }
119             }
120     
121             _propagateToZkSyncStateTransition(ERA_CHAIN_ID);
122         }


126         function commitBatchesSharedBridge(
127             uint256 _chainId,
128             StoredBatchInfo calldata,
129             CommitBatchInfo[] calldata _newBatchesData
130         ) external onlyValidator(_chainId) {
131             unchecked {
132                 // This contract is only a temporary solution, that hopefully will be disabled until 2106 year, so...
133                 // It is safe to cast.
134                 uint32 timestamp = uint32(block.timestamp);
135                 for (uint256 i = 0; i < _newBatchesData.length; ++i) {
136                     committedBatchTimestamp[_chainId].set(_newBatchesData[i].batchNumber, timestamp);
137                 }
138             }
139     
140             _propagateToZkSyncStateTransition(_chainId);
141         }


146         function revertBatches(uint256) external onlyValidator(ERA_CHAIN_ID) {
147             _propagateToZkSyncStateTransition(ERA_CHAIN_ID);
148         }


153         function revertBatchesSharedBridge(uint256 _chainId, uint256) external onlyValidator(_chainId) {
154             _propagateToZkSyncStateTransition(_chainId);
155         }


160         function proveBatches(
161             StoredBatchInfo calldata,
162             StoredBatchInfo[] calldata,
163             ProofInput calldata
164         ) external onlyValidator(ERA_CHAIN_ID) {
165             _propagateToZkSyncStateTransition(ERA_CHAIN_ID);
166         }


171         function proveBatchesSharedBridge(
172             uint256 _chainId,
173             StoredBatchInfo calldata,
174             StoredBatchInfo[] calldata,
175             ProofInput calldata
176         ) external onlyValidator(_chainId) {
177             _propagateToZkSyncStateTransition(_chainId);
178         }


182         function executeBatches(StoredBatchInfo[] calldata _newBatchesData) external onlyValidator(ERA_CHAIN_ID) {
183             uint256 delay = executionDelay; // uint32
184             unchecked {
185                 for (uint256 i = 0; i < _newBatchesData.length; ++i) {
186                     uint256 commitBatchTimestamp = committedBatchTimestamp[ERA_CHAIN_ID].get(
187                         _newBatchesData[i].batchNumber
188                     );
189     
190                     // Note: if the `commitBatchTimestamp` is zero, that means either:
191                     // * The batch was committed, but not through this contract.
192                     // * The batch wasn't committed at all, so execution will fail in the zkSync contract.
193                     // We allow executing such batches.
194     
195                     require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed
196                 }
197             }
198             _propagateToZkSyncStateTransition(ERA_CHAIN_ID);
199         }


203         function executeBatchesSharedBridge(
204             uint256 _chainId,
205             StoredBatchInfo[] calldata _newBatchesData
206         ) external onlyValidator(_chainId) {
207             uint256 delay = executionDelay; // uint32
208             unchecked {
209                 for (uint256 i = 0; i < _newBatchesData.length; ++i) {
210                     uint256 commitBatchTimestamp = committedBatchTimestamp[_chainId].get(_newBatchesData[i].batchNumber);
211     
212                     // Note: if the `commitBatchTimestamp` is zero, that means either:
213                     // * The batch was committed, but not through this contract.
214                     // * The batch wasn't committed at all, so execution will fail in the zkSync contract.
215                     // We allow executing such batches.
216     
217                     require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed
218                 }
219             }
220             _propagateToZkSyncStateTransition(_chainId);
221         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L203:221

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


24          function initialize(InitializeData calldata _initializeData) external reentrancyGuardInitializer returns (bytes32) {
25              require(address(_initializeData.verifier) != address(0), "vt");
26              require(_initializeData.admin != address(0), "vy");
27              require(_initializeData.validatorTimelock != address(0), "hc");
28              require(_initializeData.priorityTxMaxGasLimit <= MAX_GAS_PER_TRANSACTION, "vu");
29      
30              s.chainId = _initializeData.chainId;
31              s.bridgehub = _initializeData.bridgehub;
32              s.stateTransitionManager = _initializeData.stateTransitionManager;
33              s.baseToken = _initializeData.baseToken;
34              s.baseTokenBridge = _initializeData.baseTokenBridge;
35              s.protocolVersion = _initializeData.protocolVersion;
36      
37              s.verifier = _initializeData.verifier;
38              s.admin = _initializeData.admin;
39              s.validators[_initializeData.validatorTimelock] = true;
40      
41              s.storedBatchHashes[0] = _initializeData.storedBatchZero;
42              s.verifierParams = _initializeData.verifierParams;
43              s.l2BootloaderBytecodeHash = _initializeData.l2BootloaderBytecodeHash;
44              s.l2DefaultAccountBytecodeHash = _initializeData.l2DefaultAccountBytecodeHash;
45              s.priorityTxMaxGasLimit = _initializeData.priorityTxMaxGasLimit;
46              s.feeParams = _initializeData.feeParams;
47              s.blobVersionedHashRetriever = _initializeData.blobVersionedHashRetriever;
48      
49              // While this does not provide a protection in the production, it is needed for local testing
50              // Length of the L2Log encoding should not be equal to the length of other L2Logs' tree nodes preimages
51              assert(L2_TO_L1_LOG_SERIALIZE_SIZE != 2 * 32);
52      
53              return Diamond.DIAMOND_INIT_SUCCESS_RETURN_VALUE;
54          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L24:54

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol


20          fallback() external payable {
21              Diamond.DiamondStorage storage diamondStorage = Diamond.getDiamondStorage();
22              // Check whether the data contains a "full" selector or it is empty.
23              // Required because Diamond proxy finds a facet by function signature,
24              // which is not defined for data length in range [1, 3].
25              require(msg.data.length >= 4 || msg.data.length == 0, "Ut");
26              // Get facet from function selector
27              Diamond.SelectorToFacet memory facet = diamondStorage.selectorToFacet[msg.sig];
28              address facetAddress = facet.facetAddress;
29      
30              require(facetAddress != address(0), "F"); // Proxy has no facet for this selector
31              require(!diamondStorage.isFrozen || !facet.isFreezable, "q1"); // Facet is frozen
32      
33              assembly {
34                  // The pointer to the free memory slot
35                  let ptr := mload(0x40)
36                  // Copy function signature and arguments from calldata at zero position into memory at pointer position
37                  calldatacopy(ptr, 0, calldatasize())
38                  // Delegatecall method of the implementation contract returns 0 on error
39                  let result := delegatecall(gas(), facetAddress, ptr, calldatasize(), 0, 0)
40                  // Get the size of the last return data
41                  let size := returndatasize()
42                  // Copy the size length of bytes from return data at zero position to pointer position
43                  returndatacopy(ptr, 0, size)
44                  // Depending on the result value
45                  switch result
46                  case 0 {
47                      // End execution and revert state changes
48                      revert(ptr, size)
49                  }
50                  default {
51                      // Return data with length of size at pointers position
52                      return(ptr, size)
53                  }
54              }
55          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L20:55

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


23          function setPendingAdmin(address _newPendingAdmin) external onlyAdmin {
24              // Save previous value into the stack to put it into the event later
25              address oldPendingAdmin = s.pendingAdmin;
26              // Change pending admin
27              s.pendingAdmin = _newPendingAdmin;
28              emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
29          }


32          function acceptAdmin() external {
33              address pendingAdmin = s.pendingAdmin;
34              require(msg.sender == pendingAdmin, "n4"); // Only proposed by current admin address can claim the admin rights
35      
36              address previousAdmin = s.admin;
37              s.admin = pendingAdmin;
38              delete s.pendingAdmin;
39      
40              emit NewPendingAdmin(pendingAdmin, address(0));
41              emit NewAdmin(previousAdmin, pendingAdmin);
42          }


45          function setValidator(address _validator, bool _active) external onlyStateTransitionManager {
46              s.validators[_validator] = _active;
47              emit ValidatorStatusUpdate(_validator, _active);
48          }


51          function setPorterAvailability(bool _zkPorterIsAvailable) external onlyStateTransitionManager {
52              // Change the porter availability
53              s.zkPorterIsAvailable = _zkPorterIsAvailable;
54              emit IsPorterAvailableStatusUpdate(_zkPorterIsAvailable);
55          }


58          function setPriorityTxMaxGasLimit(uint256 _newPriorityTxMaxGasLimit) external onlyStateTransitionManager {
59              require(_newPriorityTxMaxGasLimit <= MAX_GAS_PER_TRANSACTION, "n5");
60      
61              uint256 oldPriorityTxMaxGasLimit = s.priorityTxMaxGasLimit;
62              s.priorityTxMaxGasLimit = _newPriorityTxMaxGasLimit;
63              emit NewPriorityTxMaxGasLimit(oldPriorityTxMaxGasLimit, _newPriorityTxMaxGasLimit);
64          }


67          function changeFeeParams(FeeParams calldata _newFeeParams) external onlyAdminOrStateTransitionManager {
68              // Double checking that the new fee params are valid, i.e.
69              // the maximal pubdata per batch is not less than the maximal pubdata per priority transaction.
70              require(_newFeeParams.maxPubdataPerBatch >= _newFeeParams.priorityTxMaxPubdata, "n6");
71      
72              FeeParams memory oldFeeParams = s.feeParams;
73              s.feeParams = _newFeeParams;
74      
75              emit NewFeeParams(oldFeeParams, _newFeeParams);
76          }


79          function setTokenMultiplier(uint128 _nominator, uint128 _denominator) external onlyAdminOrStateTransitionManager {
80              uint128 oldNominator = s.baseTokenGasPriceMultiplierNominator;
81              uint128 oldDenominator = s.baseTokenGasPriceMultiplierDenominator;
82      
83              s.baseTokenGasPriceMultiplierNominator = _nominator;
84              s.baseTokenGasPriceMultiplierDenominator = _denominator;
85      
86              emit NewBaseTokenMultiplier(oldNominator, oldDenominator, _nominator, _denominator);
87          }


89          function setValidiumMode(PubdataPricingMode _validiumMode) external onlyAdmin {
90              require(s.totalBatchesCommitted == 0, "AdminFacet: set validium only after genesis"); // Validium mode can be set only before the first batch is committed
91              s.feeParams.pubdataPricingMode = _validiumMode;
92              emit ValidiumModeStatusUpdate(_validiumMode);
93          }


100         function upgradeChainFromVersion(
101             uint256 _oldProtocolVersion,
102             Diamond.DiamondCutData calldata _diamondCut
103         ) external onlyAdminOrStateTransitionManager {
104             bytes32 cutHashInput = keccak256(abi.encode(_diamondCut));
105             require(
106                 cutHashInput == IStateTransitionManager(s.stateTransitionManager).upgradeCutHash(_oldProtocolVersion),
107                 "StateTransition: cutHash mismatch"
108             );
109     
110             require(
111                 s.protocolVersion == _oldProtocolVersion,
112                 "StateTransition: protocolVersion mismatch in STC when upgrading"
113             );
114             Diamond.diamondCut(_diamondCut);
115             emit ExecuteUpgrade(_diamondCut);
116             require(
117                 s.protocolVersion > _oldProtocolVersion,
118                 "StateTransition: protocolVersion mismatch in STC after upgrading"
119             );
120         }


123         function executeUpgrade(Diamond.DiamondCutData calldata _diamondCut) external onlyStateTransitionManager {
124             Diamond.diamondCut(_diamondCut);
125             emit ExecuteUpgrade(_diamondCut);
126         }


133         function freezeDiamond() external onlyAdminOrStateTransitionManager {
134             Diamond.DiamondStorage storage diamondStorage = Diamond.getDiamondStorage();
135     
136             require(!diamondStorage.isFrozen, "a9"); // diamond proxy is frozen already
137             diamondStorage.isFrozen = true;
138     
139             emit Freeze();
140         }


143         function unfreezeDiamond() external onlyAdminOrStateTransitionManager {
144             Diamond.DiamondStorage storage diamondStorage = Diamond.getDiamondStorage();
145     
146             require(diamondStorage.isFrozen, "a7"); // diamond proxy is not frozen
147             diamondStorage.isFrozen = false;
148     
149             emit Unfreeze();
150         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L143:150

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


199         function commitBatches(
200             StoredBatchInfo memory _lastCommittedBatchData,
201             CommitBatchInfo[] calldata _newBatchesData
202         ) external nonReentrant onlyValidator {
203             _commitBatches(_lastCommittedBatchData, _newBatchesData);
204         }


207         function commitBatchesSharedBridge(
208             uint256, // _chainId
209             StoredBatchInfo memory _lastCommittedBatchData,
210             CommitBatchInfo[] calldata _newBatchesData
211         ) external nonReentrant onlyValidator {
212             _commitBatches(_lastCommittedBatchData, _newBatchesData);
213         }


337         function executeBatchesSharedBridge(
338             uint256,
339             StoredBatchInfo[] calldata _batchesData
340         ) external nonReentrant onlyValidator {
341             _executeBatches(_batchesData);
342         }


345         function executeBatches(StoredBatchInfo[] calldata _batchesData) external nonReentrant onlyValidator {
346             _executeBatches(_batchesData);
347         }


368         function proveBatches(
369             StoredBatchInfo calldata _prevBatch,
370             StoredBatchInfo[] calldata _committedBatches,
371             ProofInput calldata _proof
372         ) external nonReentrant onlyValidator {
373             _proveBatches(_prevBatch, _committedBatches, _proof);
374         }


377         function proveBatchesSharedBridge(
378             uint256, // _chainId
379             StoredBatchInfo calldata _prevBatch,
380             StoredBatchInfo[] calldata _committedBatches,
381             ProofInput calldata _proof
382         ) external nonReentrant onlyValidator {
383             _proveBatches(_prevBatch, _committedBatches, _proof);
384         }


472         function revertBatches(uint256 _newLastBatch) external nonReentrant onlyValidatorOrStateTransitionManager {
473             _revertBatches(_newLastBatch);
474         }


477         function revertBatchesSharedBridge(uint256, uint256 _newLastBatch) external nonReentrant onlyValidator {
478             _revertBatches(_newLastBatch);
479         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L477:479

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


32          function getVerifier() external view returns (address) {
33              return address(s.verifier);
34          }


37          function getAdmin() external view returns (address) {
38              return s.admin;
39          }


42          function getPendingAdmin() external view returns (address) {
43              return s.pendingAdmin;
44          }


47          function getBridgehub() external view returns (address) {
48              return address(s.bridgehub);
49          }


52          function getStateTransitionManager() external view returns (address) {
53              return address(s.stateTransitionManager);
54          }


57          function getBaseToken() external view returns (address) {
58              return address(s.baseToken);
59          }


62          function getBaseTokenBridge() external view returns (address) {
63              return address(s.baseTokenBridge);
64          }


67          function baseTokenGasPriceMultiplierNominator() external view returns (uint128) {
68              return s.baseTokenGasPriceMultiplierNominator;
69          }


72          function baseTokenGasPriceMultiplierDenominator() external view returns (uint128) {
73              return s.baseTokenGasPriceMultiplierDenominator;
74          }


77          function getTotalBatchesCommitted() external view returns (uint256) {
78              return s.totalBatchesCommitted;
79          }


82          function getTotalBatchesVerified() external view returns (uint256) {
83              return s.totalBatchesVerified;
84          }


87          function getTotalBatchesExecuted() external view returns (uint256) {
88              return s.totalBatchesExecuted;
89          }


92          function getTotalPriorityTxs() external view returns (uint256) {
93              return s.priorityQueue.getTotalPriorityTxs();
94          }


97          function getFirstUnprocessedPriorityTx() external view returns (uint256) {
98              return s.priorityQueue.getFirstUnprocessedPriorityTx();
99          }


102         function getPriorityQueueSize() external view returns (uint256) {
103             return s.priorityQueue.getSize();
104         }


107         function priorityQueueFrontOperation() external view returns (PriorityOperation memory) {
108             return s.priorityQueue.front();
109         }


112         function isValidator(address _address) external view returns (bool) {
113             return s.validators[_address];
114         }


117         function l2LogsRootHash(uint256 _batchNumber) external view returns (bytes32) {
118             return s.l2LogsRootHashes[_batchNumber];
119         }


122         function storedBatchHash(uint256 _batchNumber) external view returns (bytes32) {
123             return s.storedBatchHashes[_batchNumber];
124         }


127         function getL2BootloaderBytecodeHash() external view returns (bytes32) {
128             return s.l2BootloaderBytecodeHash;
129         }


132         function getL2DefaultAccountBytecodeHash() external view returns (bytes32) {
133             return s.l2DefaultAccountBytecodeHash;
134         }


137         function getVerifierParams() external view returns (VerifierParams memory) {
138             return s.verifierParams;
139         }


142         function getProtocolVersion() external view returns (uint256) {
143             return s.protocolVersion;
144         }


147         function getL2SystemContractsUpgradeTxHash() external view returns (bytes32) {
148             return s.l2SystemContractsUpgradeTxHash;
149         }


152         function getL2SystemContractsUpgradeBatchNumber() external view returns (uint256) {
153             return s.l2SystemContractsUpgradeBatchNumber;
154         }


157         function isDiamondStorageFrozen() external view returns (bool) {
158             Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();
159             return ds.isFrozen;
160         }


163         function isFacetFreezable(address _facet) external view returns (bool isFreezable) {
164             Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();
165     
166             // There is no direct way to get whether the facet address is freezable,
167             // so we get it from one of the selectors that are associated with the facet.
168             uint256 selectorsArrayLen = ds.facetToSelectors[_facet].selectors.length;
169             if (selectorsArrayLen != 0) {
170                 bytes4 selector0 = ds.facetToSelectors[_facet].selectors[0];
171                 isFreezable = ds.selectorToFacet[selector0].isFreezable;
172             }
173         }


176         function getPriorityTxMaxGasLimit() external view returns (uint256) {
177             return s.priorityTxMaxGasLimit;
178         }


181         function isFunctionFreezable(bytes4 _selector) external view returns (bool) {
182             Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();
183             require(ds.selectorToFacet[_selector].facetAddress != address(0), "g2");
184             return ds.selectorToFacet[_selector].isFreezable;
185         }


188         function isEthWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool) {
189             return s.isEthWithdrawalFinalized[_l2BatchNumber][_l2MessageIndex];
190         }


193         function getPubdataPricingMode() external view returns (PubdataPricingMode) {
194             return s.feeParams.pubdataPricingMode;
195         }


202         function facets() external view returns (Facet[] memory result) {
203             Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();
204     
205             uint256 facetsLen = ds.facets.length;
206             result = new Facet[](facetsLen);
207     
208             for (uint256 i = 0; i < facetsLen; i = i.uncheckedInc()) {
209                 address facetAddr = ds.facets[i];
210                 Diamond.FacetToSelectors memory facetToSelectors = ds.facetToSelectors[facetAddr];
211     
212                 result[i] = Facet(facetAddr, facetToSelectors.selectors);
213             }
214         }


217         function facetFunctionSelectors(address _facet) external view returns (bytes4[] memory) {
218             Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();
219             return ds.facetToSelectors[_facet].selectors;
220         }


223         function facetAddresses() external view returns (address[] memory) {
224             Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();
225             return ds.facets;
226         }


229         function facetAddress(bytes4 _selector) external view returns (address) {
230             Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();
231             return ds.selectorToFacet[_selector].facetAddress;
232         }


239         function getTotalBlocksCommitted() external view returns (uint256) {
240             return s.totalBatchesCommitted;
241         }


244         function getTotalBlocksVerified() external view returns (uint256) {
245             return s.totalBatchesVerified;
246         }


249         function getTotalBlocksExecuted() external view returns (uint256) {
250             return s.totalBatchesExecuted;
251         }


254         function storedBlockHash(uint256 _batchNumber) external view returns (bytes32) {
255             return s.storedBatchHashes[_batchNumber];
256         }


259         function getL2SystemContractsUpgradeBlockNumber() external view returns (uint256) {
260             return s.l2SystemContractsUpgradeBatchNumber;
261         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L259:261

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


38          function transferEthToSharedBridge() external onlyBaseTokenBridge {
39              require(s.chainId == ERA_CHAIN_ID, "transferEthToSharedBridge only available for Era on mailbox");
40      
41              uint256 amount = address(this).balance;
42              address sharedBridgeAddress = s.baseTokenBridge;
43              IL1SharedBridge(sharedBridgeAddress).receiveEth{value: amount}(ERA_CHAIN_ID);
44          }


47          function bridgehubRequestL2Transaction(
48              BridgehubL2TransactionRequest memory _request
49          ) external payable onlyBridgehub returns (bytes32 canonicalTxHash) {
50              canonicalTxHash = _requestL2TransactionSender(_request);
51          }


54          function proveL2MessageInclusion(
55              uint256 _batchNumber,
56              uint256 _index,
57              L2Message memory _message,
58              bytes32[] calldata _proof
59          ) public view returns (bool) {
60              return _proveL2LogInclusion(_batchNumber, _index, _L2MessageToLog(_message), _proof);
61          }


64          function proveL2LogInclusion(
65              uint256 _batchNumber,
66              uint256 _index,
67              L2Log memory _log,
68              bytes32[] calldata _proof
69          ) external view returns (bool) {
70              return _proveL2LogInclusion(_batchNumber, _index, _log, _proof);
71          }


74          function proveL1ToL2TransactionStatus(
75              bytes32 _l2TxHash,
76              uint256 _l2BatchNumber,
77              uint256 _l2MessageIndex,
78              uint16 _l2TxNumberInBatch,
79              bytes32[] calldata _merkleProof,
80              TxStatus _status
81          ) public view returns (bool) {
82              // Bootloader sends an L2 -> L1 log only after processing the L1 -> L2 transaction.
83              // Thus, we can verify that the L1 -> L2 transaction was included in the L2 batch with specified status.
84              //
85              // The semantics of such L2 -> L1 log is always:
86              // - sender = L2_BOOTLOADER_ADDRESS
87              // - key = hash(L1ToL2Transaction)
88              // - value = status of the processing transaction (1 - success & 0 - fail)
89              // - isService = true (just a conventional value)
90              // - l2ShardId = 0 (means that L1 -> L2 transaction was processed in a rollup shard, other shards are not available yet anyway)
91              // - txNumberInBatch = number of transaction in the batch
92              L2Log memory l2Log = L2Log({
93                  l2ShardId: 0,
94                  isService: true,
95                  txNumberInBatch: _l2TxNumberInBatch,
96                  sender: L2_BOOTLOADER_ADDRESS,
97                  key: _l2TxHash,
98                  value: bytes32(uint256(_status))
99              });
100             return _proveL2LogInclusion(_l2BatchNumber, _l2MessageIndex, l2Log, _merkleProof);
101         }


143         function l2TransactionBaseCost(
144             uint256 _gasPrice,
145             uint256 _l2GasLimit,
146             uint256 _l2GasPerPubdataByteLimit
147         ) public view returns (uint256) {
148             uint256 l2GasPrice = _deriveL2GasPrice(_gasPrice, _l2GasPerPubdataByteLimit);
149             return l2GasPrice * _l2GasLimit;
150         }


178         function finalizeEthWithdrawal(
179             uint256 _l2BatchNumber,
180             uint256 _l2MessageIndex,
181             uint16 _l2TxNumberInBatch,
182             bytes calldata _message,
183             bytes32[] calldata _merkleProof
184         ) external nonReentrant {
185             require(s.chainId == ERA_CHAIN_ID, "finalizeEthWithdrawal only available for Era on mailbox");
186             IL1SharedBridge(s.baseTokenBridge).finalizeWithdrawal(
187                 ERA_CHAIN_ID,
188                 _l2BatchNumber,
189                 _l2MessageIndex,
190                 _l2TxNumberInBatch,
191                 _message,
192                 _merkleProof
193             );
194         }


197         function requestL2Transaction(
198             address _contractL2,
199             uint256 _l2Value,
200             bytes calldata _calldata,
201             uint256 _l2GasLimit,
202             uint256 _l2GasPerPubdataByteLimit,
203             bytes[] calldata _factoryDeps,
204             address _refundRecipient
205         ) external payable returns (bytes32 canonicalTxHash) {
206             require(s.chainId == ERA_CHAIN_ID, "legacy interface only available for era token");
207             canonicalTxHash = _requestL2TransactionSender(
208                 BridgehubL2TransactionRequest({
209                     sender: msg.sender,
210                     contractL2: _contractL2,
211                     mintValue: msg.value,
212                     l2Value: _l2Value,
213                     l2GasLimit: _l2GasLimit,
214                     l2Calldata: _calldata,
215                     l2GasPerPubdataByteLimit: _l2GasPerPubdataByteLimit,
216                     factoryDeps: _factoryDeps,
217                     refundRecipient: _refundRecipient
218                 })
219             );
220             IL1SharedBridge(s.baseTokenBridge).bridgehubDepositBaseToken{value: msg.value}(
221                 s.chainId,
222                 msg.sender,
223                 ETH_TOKEN_ADDRESS,
224                 msg.value
225             );
226         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L197:226

```solidity
File: contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol


13          function upgrade(ProposedUpgrade calldata _proposedUpgrade) public override returns (bytes32) {
14              super.upgrade(_proposedUpgrade);
15              return Diamond.DIAMOND_INIT_SUCCESS_RETURN_VALUE;
16          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol#L13:16

```solidity
File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol


14          function upgrade(ProposedUpgrade calldata _proposedUpgrade) public override returns (bytes32) {
15              super.upgrade(_proposedUpgrade);
16              return Diamond.DIAMOND_INIT_SUCCESS_RETURN_VALUE;
17          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L14:17

```solidity
File: contracts/zksync/contracts/ForceDeployUpgrader.sol


13          function forceDeploy(IContractDeployer.ForceDeployment[] calldata _forceDeployments) external payable {
14              IContractDeployer(DEPLOYER_SYSTEM_CONTRACT).forceDeployOnAddresses{value: msg.value}(_forceDeployments);
15          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/ForceDeployUpgrader.sol#L13:15

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


49          function initialize(
50              address _l1Bridge,
51              address _l1LegecyBridge,
52              bytes32 _l2TokenProxyBytecodeHash,
53              address _aliasedOwner
54          ) external reinitializer(2) {
55              require(_l1Bridge != address(0), "bf");
56              require(_l2TokenProxyBytecodeHash != bytes32(0), "df");
57              require(_aliasedOwner != address(0), "sf");
58              require(_l2TokenProxyBytecodeHash != bytes32(0), "df");
59      
60              l1Bridge = _l1Bridge;
61              l2TokenProxyBytecodeHash = _l2TokenProxyBytecodeHash;
62      
63              if (block.chainid != ERA_CHAIN_ID) {
64                  address l2StandardToken = address(new L2StandardERC20{salt: bytes32(0)}());
65                  l2TokenBeacon = new UpgradeableBeacon{salt: bytes32(0)}(l2StandardToken);
66                  l2TokenBeacon.transferOwnership(_aliasedOwner);
67              } else {
68                  require(_l1LegecyBridge != address(0), "bf2");
69                  // l2StandardToken and l2TokenBeacon are already deployed on ERA, and stored in the proxy
70              }
71          }


79          function finalizeDeposit(
80              address _l1Sender,
81              address _l2Receiver,
82              address _l1Token,
83              uint256 _amount,
84              bytes calldata _data
85          ) external payable override {
86              // Only the L1 bridge counterpart can initiate and finalize the deposit.
87              require(
88                  AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1Bridge ||
89                      AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1LegacyBridge,
90                  "mq"
91              );
92              require(msg.value == 0, "Value should be 0 for ERC20 bridge");
93      
94              address expectedL2Token = l2TokenAddress(_l1Token);
95              address currentL1Token = l1TokenAddress[expectedL2Token];
96              if (currentL1Token == address(0)) {
97                  address deployedToken = _deployL2Token(_l1Token, _data);
98                  require(deployedToken == expectedL2Token, "mt");
99                  l1TokenAddress[expectedL2Token] = _l1Token;
100             } else {
101                 require(currentL1Token == _l1Token, "gg"); // Double check that the expected value equal to real one
102             }
103     
104             IL2StandardToken(expectedL2Token).bridgeMint(_l2Receiver, _amount);
105             emit FinalizeDeposit(_l1Sender, _l2Receiver, expectedL2Token, _amount);
106         }


123         function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external override {
124             require(_amount > 0, "Amount cannot be zero");
125     
126             IL2StandardToken(_l2Token).bridgeBurn(msg.sender, _amount);
127     
128             address l1Token = l1TokenAddress[_l2Token];
129             require(l1Token != address(0), "yh");
130     
131             bytes memory message = _getL1WithdrawMessage(_l1Receiver, l1Token, _amount);
132             L2ContractHelper.sendMessageToL1(message);
133     
134             emit WithdrawalInitiated(msg.sender, _l1Receiver, _l2Token, _amount);
135         }


149         function l2TokenAddress(address _l1Token) public view override returns (address) {
150             bytes32 constructorInputHash = keccak256(abi.encode(address(l2TokenBeacon), ""));
151             bytes32 salt = _getCreate2Salt(_l1Token);
152             return
153                 L2ContractHelper.computeCreate2Address(address(this), salt, l2TokenProxyBytecodeHash, constructorInputHash);
154         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L149:154

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


50          function bridgeInitialize(address _l1Address, bytes memory _data) external initializer {
51              require(_l1Address != address(0), "in6"); // Should be non-zero address
52              l1Address = _l1Address;
53      
54              l2Bridge = msg.sender;
55      
56              // We parse the data exactly as they were created on the L1 bridge
57              (bytes memory nameBytes, bytes memory symbolBytes, bytes memory decimalsBytes) = abi.decode(
58                  _data,
59                  (bytes, bytes, bytes)
60              );
61      
62              ERC20Getters memory getters;
63              string memory decodedName;
64              string memory decodedSymbol;
65      
66              // L1 bridge didn't check if the L1 token return values with proper types for `name`/`symbol`/`decimals`
67              // That's why we need to try to decode them, and if it works out, set the values as getters.
68      
69              // NOTE: Solidity doesn't have a convenient way to try to decode a value:
70              // - Decode them manually, i.e. write a function that will validate that data in the correct format
71              // and return decoded value and a boolean value - whether it was possible to decode.
72              // - Use the standard abi.decode method, but wrap it into an external call in which error can be handled.
73              // We use the second option here.
74      
75              try this.decodeString(nameBytes) returns (string memory nameString) {
76                  decodedName = nameString;
77              } catch {
78                  getters.ignoreName = true;
79              }
80      
81              try this.decodeString(symbolBytes) returns (string memory symbolString) {
82                  decodedSymbol = symbolString;
83              } catch {
84                  getters.ignoreSymbol = true;
85              }
86      
87              // Set decoded values for name and symbol.
88              __ERC20_init_unchained(decodedName, decodedSymbol);
89      
90              // Set the name for EIP-712 signature.
91              __ERC20Permit_init(decodedName);
92      
93              try this.decodeUint8(decimalsBytes) returns (uint8 decimalsUint8) {
94                  // Set decoded value for decimals.
95                  decimals_ = decimalsUint8;
96              } catch {
97                  getters.ignoreDecimals = true;
98              }
99      
100             availableGetters = getters;
101             emit BridgeInitialize(_l1Address, decodedName, decodedSymbol, decimals_);
102         }


111         function reinitializeToken(
112             ERC20Getters calldata _availableGetters,
113             string memory _newName,
114             string memory _newSymbol,
115             uint8 _version
116         ) external onlyNextVersion(_version) reinitializer(_version) {
117             // It is expected that this token is deployed as a beacon proxy, so we'll
118             // allow the governor of the beacon to reinitialize the token.
119             address beaconAddress = _getBeacon();
120             require(msg.sender == UpgradeableBeacon(beaconAddress).owner(), "tt");
121     
122             __ERC20_init_unchained(_newName, _newSymbol);
123             __ERC20Permit_init(_newName);
124             availableGetters = _availableGetters;
125     
126             emit BridgeInitialize(l1Address, _newName, _newSymbol, decimals_);
127         }


145         function bridgeMint(address _to, uint256 _amount) external override onlyBridge {
146             _mint(_to, _amount);
147             emit BridgeMint(_to, _amount);
148         }


154         function bridgeBurn(address _from, uint256 _amount) external override onlyBridge {
155             _burn(_from, _amount);
156             emit BridgeBurn(_from, _amount);
157         }


159         function name() public view override returns (string memory) {
160             // If method is not available, behave like a token that does not implement this method - revert on call.
161             if (availableGetters.ignoreName) revert();
162             return super.name();
163         }


165         function symbol() public view override returns (string memory) {
166             // If method is not available, behave like a token that does not implement this method - revert on call.
167             if (availableGetters.ignoreSymbol) revert();
168             return super.symbol();
169         }


171         function decimals() public view override returns (uint8) {
172             // If method is not available, behave like a token that does not implement this method - revert on call.
173             if (availableGetters.ignoreDecimals) revert();
174             return decimals_;
175         }


178         function decodeString(bytes memory _input) external pure returns (string memory result) {
179             (result) = abi.decode(_input, (string));
180         }


183         function decodeUint8(bytes memory _input) external pure returns (uint8 result) {
184             (result) = abi.decode(_input, (uint8));
185         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L183:185

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


35          function storeAccountConstructingCodeHash(address _address, bytes32 _hash) external override onlyDeployer {
36              // Check that code hash corresponds to the deploying smart contract
37              require(Utils.isContractConstructing(_hash), "Code hash is not for a contract on constructor");
38              _storeCodeHash(_address, _hash);
39          }


46          function storeAccountConstructedCodeHash(address _address, bytes32 _hash) external override onlyDeployer {
47              // Check that code hash corresponds to the deploying smart contract
48              require(Utils.isContractConstructed(_hash), "Code hash is not for a constructed contract");
49              _storeCodeHash(_address, _hash);
50          }


54          function markAccountCodeHashAsConstructed(address _address) external override onlyDeployer {
55              bytes32 codeHash = getRawCodeHash(_address);
56      
57              require(Utils.isContractConstructing(codeHash), "Code hash is not for a contract on constructor");
58      
59              // Get the bytecode hash with "isConstructor" flag equal to false
60              bytes32 constructedBytecodeHash = Utils.constructedBytecodeHash(codeHash);
61      
62              _storeCodeHash(_address, constructedBytecodeHash);
63          }


78          function getRawCodeHash(address _address) public view override returns (bytes32 codeHash) {
79              uint256 addressAsKey = uint256(uint160(_address));
80      
81              assembly {
82                  codeHash := sload(addressAsKey)
83              }
84          }


89          function getCodeHash(uint256 _input) external view override returns (bytes32) {
90              // We consider the account bytecode hash of the last 20 bytes of the input, because
91              // according to the spec "If EXTCODEHASH of A is X, then EXTCODEHASH of A + 2**160 is X".
92              address account = address(uint160(_input));
93              if (uint160(account) <= CURRENT_MAX_PRECOMPILE_ADDRESS) {
94                  return EMPTY_STRING_KECCAK;
95              }
96      
97              bytes32 codeHash = getRawCodeHash(account);
98      
99              // The code hash is equal to the `keccak256("")` if the account is an EOA with at least one transaction.
100             // Otherwise, the account is either deployed smart contract or an empty account,
101             // for both cases the code hash is equal to the raw code hash.
102             if (codeHash == 0x00 && NONCE_HOLDER_SYSTEM_CONTRACT.getRawNonce(account) > 0) {
103                 codeHash = EMPTY_STRING_KECCAK;
104             }
105             // The contract is still on the constructor, which means it is not deployed yet,
106             // so set `keccak256("")` as a code hash. The EVM has the same behavior.
107             else if (Utils.isContractConstructing(codeHash)) {
108                 codeHash = EMPTY_STRING_KECCAK;
109             }
110     
111             return codeHash;
112         }


117         function getCodeSize(uint256 _input) external view override returns (uint256 codeSize) {
118             // We consider the account bytecode size of the last 20 bytes of the input, because
119             // according to the spec "If EXTCODESIZE of A is X, then EXTCODESIZE of A + 2**160 is X".
120             address account = address(uint160(_input));
121             bytes32 codeHash = getRawCodeHash(account);
122     
123             // If the contract is a default account or is on constructor the code size is zero,
124             // otherwise extract the proper value for it from the bytecode hash.
125             // NOTE: zero address and precompiles are a special case, they are contracts, but we
126             // want to preserve EVM invariants (see EIP-1052 specification). That's why we automatically
127             // return `0` length in the following cases:
128             // - `codehash(0) == 0`
129             // - `account` is a precompile.
130             // - `account` is currently being constructed
131             if (
132                 uint160(account) > CURRENT_MAX_PRECOMPILE_ADDRESS &&
133                 codeHash != 0x00 &&
134                 !Utils.isContractConstructing(codeHash)
135             ) {
136                 codeSize = Utils.bytecodeLenInBytes(codeHash);
137             }
138         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L117:138

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


24          function getTransactionHashes(
25              Transaction calldata _transaction
26          ) external view override returns (bytes32 txHash, bytes32 signedTxHash) {
27              signedTxHash = _transaction.encodeHash();
28              if (_transaction.txType == EIP_712_TX_TYPE) {
29                  txHash = keccak256(bytes.concat(signedTxHash, EfficientCall.keccak(_transaction.signature)));
30              } else if (_transaction.txType == LEGACY_TX_TYPE) {
31                  txHash = encodeLegacyTransactionHash(_transaction);
32              } else if (_transaction.txType == EIP_1559_TX_TYPE) {
33                  txHash = encodeEIP1559TransactionHash(_transaction);
34              } else if (_transaction.txType == EIP_2930_TX_TYPE) {
35                  txHash = encodeEIP2930TransactionHash(_transaction);
36              } else {
37                  revert("Unsupported tx type");
38              }
39          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L24:39

```solidity
File: system-contracts/contracts/ComplexUpgrader.sol


21          function upgrade(address _delegateTo, bytes calldata _calldata) external payable {
22              require(msg.sender == FORCE_DEPLOYER, "Can only be called by FORCE_DEPLOYER");
23      
24              require(_delegateTo.code.length > 0, "Delegatee is an EOA");
25              (bool success, bytes memory returnData) = _delegateTo.delegatecall(_calldata);
26              assembly {
27                  if iszero(success) {
28                      revert(add(returnData, 0x20), mload(returnData))
29                  }
30              }
31          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L21:31

```solidity
File: system-contracts/contracts/Compressor.sol


44          function publishCompressedBytecode(
45              bytes calldata _bytecode,
46              bytes calldata _rawCompressedData
47          ) external payable onlyCallFromBootloader returns (bytes32 bytecodeHash) {
48              unchecked {
49                  (bytes calldata dictionary, bytes calldata encodedData) = _decodeRawBytecode(_rawCompressedData);
50      
51                  require(
52                      encodedData.length * 4 == _bytecode.length,
53                      "Encoded data length should be 4 times shorter than the original bytecode"
54                  );
55      
56                  require(
57                      dictionary.length / 8 <= encodedData.length / 2,
58                      "Dictionary should have at most the same number of entries as the encoded data"
59                  );
60      
61                  for (uint256 encodedDataPointer = 0; encodedDataPointer < encodedData.length; encodedDataPointer += 2) {
62                      uint256 indexOfEncodedChunk = uint256(encodedData.readUint16(encodedDataPointer)) * 8;
63                      require(indexOfEncodedChunk < dictionary.length, "Encoded chunk index is out of bounds");
64      
65                      uint64 encodedChunk = dictionary.readUint64(indexOfEncodedChunk);
66                      uint64 realChunk = _bytecode.readUint64(encodedDataPointer * 4);
67      
68                      require(encodedChunk == realChunk, "Encoded chunk does not match the original bytecode");
69                  }
70              }
71      
72              bytecodeHash = Utils.hashL2Bytecode(_bytecode);
73              L1_MESSENGER_CONTRACT.sendToL1(_rawCompressedData);
74              KNOWN_CODE_STORAGE_CONTRACT.markBytecodeAsPublished(bytecodeHash);
75          }


110         function verifyCompressedStateDiffs(
111             uint256 _numberOfStateDiffs,
112             uint256 _enumerationIndexSize,
113             bytes calldata _stateDiffs,
114             bytes calldata _compressedStateDiffs
115         ) external payable onlyCallFrom(address(L1_MESSENGER_CONTRACT)) returns (bytes32 stateDiffHash) {
116             // We do not enforce the operator to use the optimal, i.e. the minimally possible _enumerationIndexSize.
117             // We do enforce however, that the _enumerationIndexSize is not larger than 8 bytes long, which is the
118             // maximal ever possible size for enumeration index.
119             require(_enumerationIndexSize <= MAX_ENUMERATION_INDEX_SIZE, "enumeration index size is too large");
120     
121             uint256 numberOfInitialWrites = uint256(_compressedStateDiffs.readUint16(0));
122     
123             uint256 stateDiffPtr = 2;
124             uint256 numInitialWritesProcessed = 0;
125     
126             // Process initial writes
127             for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) {
128                 bytes calldata stateDiff = _stateDiffs[i:i + STATE_DIFF_ENTRY_SIZE];
129                 uint64 enumIndex = stateDiff.readUint64(84);
130                 if (enumIndex != 0) {
131                     // It is a repeated write, so we skip it.
132                     continue;
133                 }
134     
135                 numInitialWritesProcessed++;
136     
137                 bytes32 derivedKey = stateDiff.readBytes32(52);
138                 uint256 initValue = stateDiff.readUint256(92);
139                 uint256 finalValue = stateDiff.readUint256(124);
140                 require(derivedKey == _compressedStateDiffs.readBytes32(stateDiffPtr), "iw: initial key mismatch");
141                 stateDiffPtr += 32;
142     
143                 uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr]));
144                 stateDiffPtr++;
145                 uint8 operation = metadata & OPERATION_BITMASK;
146                 uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;
147                 _verifyValueCompression(
148                     initValue,
149                     finalValue,
150                     operation,
151                     _compressedStateDiffs[stateDiffPtr:stateDiffPtr + len]
152                 );
153                 stateDiffPtr += len;
154             }
155     
156             require(numInitialWritesProcessed == numberOfInitialWrites, "Incorrect number of initial storage diffs");
157     
158             // Process repeated writes
159             for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) {
160                 bytes calldata stateDiff = _stateDiffs[i:i + STATE_DIFF_ENTRY_SIZE];
161                 uint64 enumIndex = stateDiff.readUint64(84);
162                 if (enumIndex == 0) {
163                     continue;
164                 }
165     
166                 uint256 initValue = stateDiff.readUint256(92);
167                 uint256 finalValue = stateDiff.readUint256(124);
168                 uint256 compressedEnumIndex = _sliceToUint256(
169                     _compressedStateDiffs[stateDiffPtr:stateDiffPtr + _enumerationIndexSize]
170                 );
171                 require(enumIndex == compressedEnumIndex, "rw: enum key mismatch");
172                 stateDiffPtr += _enumerationIndexSize;
173     
174                 uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr]));
175                 stateDiffPtr += 1;
176                 uint8 operation = metadata & OPERATION_BITMASK;
177                 uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;
178                 _verifyValueCompression(
179                     initValue,
180                     finalValue,
181                     operation,
182                     _compressedStateDiffs[stateDiffPtr:stateDiffPtr + len]
183                 );
184                 stateDiffPtr += len;
185             }
186     
187             require(stateDiffPtr == _compressedStateDiffs.length, "Extra data in _compressedStateDiffs");
188     
189             stateDiffHash = EfficientCall.keccak(_stateDiffs);
190         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L110:190

```solidity
File: system-contracts/contracts/ContractDeployer.sol


34          function getAccountInfo(address _address) external view returns (AccountInfo memory info) {
35              return accountInfo[_address];
36          }


40          function extendedAccountVersion(address _address) public view returns (AccountAbstractionVersion) {
41              AccountInfo memory info = accountInfo[_address];
42              if (info.supportedAAVersion != AccountAbstractionVersion.None) {
43                  return info.supportedAAVersion;
44              }
45      
46              // It is an EOA, it is still an account.
47              if (
48                  _address > address(MAX_SYSTEM_CONTRACT_ADDRESS) &&
49                  ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.getRawCodeHash(_address) == 0
50              ) {
51                  return AccountAbstractionVersion.Version1;
52              }
53      
54              return AccountAbstractionVersion.None;
55          }


65          function updateAccountVersion(AccountAbstractionVersion _version) external onlySystemCall {
66              accountInfo[msg.sender].supportedAAVersion = _version;
67      
68              emit AccountVersionUpdated(msg.sender, _version);
69          }


74          function updateNonceOrdering(AccountNonceOrdering _nonceOrdering) external onlySystemCall {
75              AccountInfo memory currentInfo = accountInfo[msg.sender];
76      
77              require(
78                  _nonceOrdering == AccountNonceOrdering.Arbitrary &&
79                      currentInfo.nonceOrdering == AccountNonceOrdering.Sequential,
80                  "It is only possible to change from sequential to arbitrary ordering"
81              );
82      
83              currentInfo.nonceOrdering = _nonceOrdering;
84              _storeAccountInfo(msg.sender, currentInfo);
85      
86              emit AccountNonceOrderingUpdated(msg.sender, _nonceOrdering);
87          }


95          function getNewAddressCreate2(
96              address _sender,
97              bytes32 _bytecodeHash,
98              bytes32 _salt,
99              bytes calldata _input
100         ) public view override returns (address newAddress) {
101             // No collision is possible with the Ethereum's CREATE2, since
102             // the prefix begins with 0x20....
103             bytes32 constructorInputHash = EfficientCall.keccak(_input);
104     
105             bytes32 hash = keccak256(
106                 bytes.concat(CREATE2_PREFIX, bytes32(uint256(uint160(_sender))), _salt, _bytecodeHash, constructorInputHash)
107             );
108     
109             newAddress = address(uint160(uint256(hash)));
110         }


115         function getNewAddressCreate(
116             address _sender,
117             uint256 _senderNonce
118         ) public pure override returns (address newAddress) {
119             // No collision is possible with the Ethereum's CREATE, since
120             // the prefix begins with 0x63....
121             bytes32 hash = keccak256(
122                 bytes.concat(CREATE_PREFIX, bytes32(uint256(uint160(_sender))), bytes32(_senderNonce))
123             );
124     
125             newAddress = address(uint160(uint256(hash)));
126         }


132         function create2(
133             bytes32 _salt,
134             bytes32 _bytecodeHash,
135             bytes calldata _input
136         ) external payable override returns (address) {
137             return create2Account(_salt, _bytecodeHash, _input, AccountAbstractionVersion.None);
138         }


147         function create(
148             bytes32 _salt,
149             bytes32 _bytecodeHash,
150             bytes calldata _input
151         ) external payable override returns (address) {
152             return createAccount(_salt, _bytecodeHash, _input, AccountAbstractionVersion.None);
153         }


162         function create2Account(
163             bytes32 _salt,
164             bytes32 _bytecodeHash,
165             bytes calldata _input,
166             AccountAbstractionVersion _aaVersion
167         ) public payable override onlySystemCall returns (address) {
168             NONCE_HOLDER_SYSTEM_CONTRACT.incrementDeploymentNonce(msg.sender);
169             address newAddress = getNewAddressCreate2(msg.sender, _bytecodeHash, _salt, _input);
170     
171             _nonSystemDeployOnAddress(_bytecodeHash, newAddress, _aaVersion, _input);
172     
173             return newAddress;
174         }


182         function createAccount(
183             bytes32, // salt
184             bytes32 _bytecodeHash,
185             bytes calldata _input,
186             AccountAbstractionVersion _aaVersion
187         ) public payable override onlySystemCall returns (address) {
188             uint256 senderNonce = NONCE_HOLDER_SYSTEM_CONTRACT.incrementDeploymentNonce(msg.sender);
189             address newAddress = getNewAddressCreate(msg.sender, senderNonce);
190     
191             _nonSystemDeployOnAddress(_bytecodeHash, newAddress, _aaVersion, _input);
192     
193             return newAddress;
194         }


213         function forceDeployOnAddress(ForceDeployment calldata _deployment, address _sender) external payable onlySelf {
214             _ensureBytecodeIsKnown(_deployment.bytecodeHash);
215     
216             // Since the `forceDeployOnAddress` function is called only during upgrades, the Governance is trusted to correctly select
217             // the addresses to deploy the new bytecodes to and to assess whether overriding the AccountInfo for the "force-deployed"
218             // contract is acceptable.
219             AccountInfo memory newAccountInfo;
220             newAccountInfo.supportedAAVersion = AccountAbstractionVersion.None;
221             // Accounts have sequential nonces by default.
222             newAccountInfo.nonceOrdering = AccountNonceOrdering.Sequential;
223             _storeAccountInfo(_deployment.newAddress, newAccountInfo);
224     
225             _constructContract(
226                 _sender,
227                 _deployment.newAddress,
228                 _deployment.bytecodeHash,
229                 _deployment.input,
230                 false,
231                 _deployment.callConstructor
232             );
233         }


238         function forceDeployOnAddresses(ForceDeployment[] calldata _deployments) external payable {
239             require(
240                 msg.sender == FORCE_DEPLOYER || msg.sender == address(COMPLEX_UPGRADER_CONTRACT),
241                 "Can only be called by FORCE_DEPLOYER or COMPLEX_UPGRADER_CONTRACT"
242             );
243     
244             uint256 deploymentsLength = _deployments.length;
245             // We need to ensure that the `value` provided by the call is enough to provide `value`
246             // for all of the deployments
247             uint256 sumOfValues = 0;
248             for (uint256 i = 0; i < deploymentsLength; ++i) {
249                 sumOfValues += _deployments[i].value;
250             }
251             require(msg.value == sumOfValues, "`value` provided is not equal to the combined `value`s of deployments");
252     
253             for (uint256 i = 0; i < deploymentsLength; ++i) {
254                 this.forceDeployOnAddress{value: _deployments[i].value}(_deployments[i], msg.sender);
255             }
256         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L238:256

```solidity
File: system-contracts/contracts/DefaultAccount.sol


67          function validateTransaction(
68              bytes32, // _txHash
69              bytes32 _suggestedSignedHash,
70              Transaction calldata _transaction
71          ) external payable override ignoreNonBootloader ignoreInDelegateCall returns (bytes4 magic) {
72              magic = _validateTransaction(_suggestedSignedHash, _transaction);
73          }


112         function executeTransaction(
113             bytes32, // _txHash
114             bytes32, // _suggestedSignedHash
115             Transaction calldata _transaction
116         ) external payable override ignoreNonBootloader ignoreInDelegateCall {
117             _execute(_transaction);
118         }


125         function executeTransactionFromOutside(Transaction calldata _transaction) external payable override {
126             // Behave the same as for fallback/receive, just execute nothing, returns nothing
127         }


196         function payForTransaction(
197             bytes32, // _txHash
198             bytes32, // _suggestedSignedHash
199             Transaction calldata _transaction
200         ) external payable ignoreNonBootloader ignoreInDelegateCall {
201             bool success = _transaction.payToTheBootloader();
202             require(success, "Failed to pay the fee to the operator");
203         }


212         function prepareForPaymaster(
213             bytes32, // _txHash
214             bytes32, // _suggestedSignedHash
215             Transaction calldata _transaction
216         ) external payable ignoreNonBootloader ignoreInDelegateCall {
217             _transaction.processPaymasterInput();
218         }


220         fallback() external payable ignoreInDelegateCall {
221             // fallback of default account shouldn't be called by bootloader under no circumstances
222             assert(msg.sender != BOOTLOADER_FORMAL_ADDRESS);
223     
224             // If the contract is called directly, behave like an EOA
225         }


227         receive() external payable {
228             // If the contract is called directly, behave like an EOA
229         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L227:229

```solidity
File: system-contracts/contracts/EmptyContract.sol


11          fallback() external payable {}


13          receive() external payable {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L13:13

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


27          function getImmutable(address _dest, uint256 _index) external view override returns (bytes32) {
28              return immutableDataStorage[uint256(uint160(_dest))][_index];
29          }


34          function setImmutables(address _dest, ImmutableData[] calldata _immutables) external override {
35              require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract");
36              unchecked {
37                  uint256 immutablesLength = _immutables.length;
38                  for (uint256 i = 0; i < immutablesLength; ++i) {
39                      uint256 index = _immutables[i].index;
40                      bytes32 value = _immutables[i].value;
41                      immutableDataStorage[uint256(uint160(_dest))][index] = value;
42                  }
43              }
44          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L34:44

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


27          function markFactoryDeps(bool _shouldSendToL1, bytes32[] calldata _hashes) external onlyCallFromBootloader {
28              unchecked {
29                  uint256 hashesLen = _hashes.length;
30                  for (uint256 i = 0; i < hashesLen; ++i) {
31                      _markBytecodeAsPublished(_hashes[i], _shouldSendToL1);
32                  }
33              }
34          }


39          function markBytecodeAsPublished(bytes32 _bytecodeHash) external onlyCompressor {
40              _markBytecodeAsPublished(_bytecodeHash, false);
41          }


65          function getMarker(bytes32 _hash) public view override returns (uint256 marker) {
66              assembly {
67                  marker := sload(_hash)
68              }
69          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L65:69

```solidity
File: system-contracts/contracts/L1Messenger.sol


70          function sendL2ToL1Log(
71              bool _isService,
72              bytes32 _key,
73              bytes32 _value
74          ) external onlyCallFromSystemContract returns (uint256 logIdInMerkleTree) {
75              L2ToL1Log memory l2ToL1Log = L2ToL1Log({
76                  l2ShardId: 0,
77                  isService: _isService,
78                  txNumberInBlock: SYSTEM_CONTEXT_CONTRACT.txNumberInBlock(),
79                  sender: msg.sender,
80                  key: _key,
81                  value: _value
82              });
83              logIdInMerkleTree = _processL2ToL1Log(l2ToL1Log);
84      
85              // We need to charge cost of hashing, as it will be used in `publishPubdataAndClearState`:
86              // - keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) and keccakGasCost(64) when reconstructing L2ToL1Log
87              // - at most 1 time keccakGasCost(64) when building the Merkle tree (as merkle tree can contain
88              // ~2*N nodes, where the first N nodes are leaves the hash of which is calculated on the previous step).
89              uint256 gasToPay = keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) + 2 * keccakGasCost(64);
90              SystemContractHelper.burnGas(Utils.safeCastToU32(gasToPay), 0);
91          }


116         function sendToL1(bytes calldata _message) external override returns (bytes32 hash) {
117             uint256 gasBeforeMessageHashing = gasleft();
118             hash = EfficientCall.keccak(_message);
119             uint256 gasSpentOnMessageHashing = gasBeforeMessageHashing - gasleft();
120     
121             /// Store message record
122             chainedMessagesHash = keccak256(abi.encode(chainedMessagesHash, hash));
123     
124             /// Store log record
125             L2ToL1Log memory l2ToL1Log = L2ToL1Log({
126                 l2ShardId: 0,
127                 isService: true,
128                 txNumberInBlock: SYSTEM_CONTEXT_CONTRACT.txNumberInBlock(),
129                 sender: address(this),
130                 key: bytes32(uint256(uint160(msg.sender))),
131                 value: hash
132             });
133             _processL2ToL1Log(l2ToL1Log);
134     
135             // Get cost of one byte pubdata in gas from context.
136             uint256 pubdataLen;
137             unchecked {
138                 // 4 bytes used to encode the length of the message (see `publishPubdataAndClearState`)
139                 // L2_TO_L1_LOG_SERIALIZE_SIZE bytes used to encode L2ToL1Log
140                 pubdataLen = 4 + _message.length + L2_TO_L1_LOG_SERIALIZE_SIZE;
141             }
142     
143             // We need to charge cost of hashing, as it will be used in `publishPubdataAndClearState`:
144             // - keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) and keccakGasCost(64) when reconstructing L2ToL1Log
145             // - keccakGasCost(64) and gasSpentOnMessageHashing when reconstructing Messages
146             // - at most 1 time keccakGasCost(64) when building the Merkle tree (as merkle tree can contain
147             // ~2*N nodes, where the first N nodes are leaves the hash of which is calculated on the previous step).
148             uint256 gasToPay = keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) +
149                 3 *
150                 keccakGasCost(64) +
151                 gasSpentOnMessageHashing +
152                 COMPUTATIONAL_PRICE_FOR_PUBDATA *
153                 pubdataLen;
154             SystemContractHelper.burnGas(Utils.safeCastToU32(gasToPay), uint32(pubdataLen));
155     
156             emit L1MessageSent(msg.sender, hash, _message);
157         }


161         function requestBytecodeL1Publication(
162             bytes32 _bytecodeHash
163         ) external override onlyCallFrom(address(KNOWN_CODE_STORAGE_CONTRACT)) {
164             chainedL1BytecodesRevealDataHash = keccak256(abi.encode(chainedL1BytecodesRevealDataHash, _bytecodeHash));
165     
166             uint256 bytecodeLen = Utils.bytecodeLenInBytes(_bytecodeHash);
167     
168             uint256 pubdataLen;
169             unchecked {
170                 // 4 bytes used to encode the length of the bytecode (see `publishPubdataAndClearState`)
171                 pubdataLen = 4 + bytecodeLen;
172             }
173     
174             // We need to charge cost of hashing, as it will be used in `publishPubdataAndClearState`
175             uint256 gasToPay = sha256GasCost(bytecodeLen) +
176                 keccakGasCost(64) +
177                 COMPUTATIONAL_PRICE_FOR_PUBDATA *
178                 pubdataLen;
179             SystemContractHelper.burnGas(Utils.safeCastToU32(gasToPay), uint32(pubdataLen));
180     
181             emit BytecodeL1PublicationRequested(_bytecodeHash);
182         }


194         function publishPubdataAndClearState(
195             bytes calldata _totalL2ToL1PubdataAndStateDiffs
196         ) external onlyCallFromBootloader {
197             uint256 calldataPtr = 0;
198     
199             /// Check logs
200             uint32 numberOfL2ToL1Logs = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));
201             require(numberOfL2ToL1Logs <= L2_TO_L1_LOGS_MERKLE_TREE_LEAVES, "Too many L2->L1 logs");
202             calldataPtr += 4;
203     
204             bytes32[] memory l2ToL1LogsTreeArray = new bytes32[](L2_TO_L1_LOGS_MERKLE_TREE_LEAVES);
205             bytes32 reconstructedChainedLogsHash;
206             for (uint256 i = 0; i < numberOfL2ToL1Logs; ++i) {
207                 bytes32 hashedLog = EfficientCall.keccak(
208                     _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + L2_TO_L1_LOG_SERIALIZE_SIZE]
209                 );
210                 calldataPtr += L2_TO_L1_LOG_SERIALIZE_SIZE;
211                 l2ToL1LogsTreeArray[i] = hashedLog;
212                 reconstructedChainedLogsHash = keccak256(abi.encode(reconstructedChainedLogsHash, hashedLog));
213             }
214             require(
215                 reconstructedChainedLogsHash == chainedLogsHash,
216                 "reconstructedChainedLogsHash is not equal to chainedLogsHash"
217             );
218             for (uint256 i = numberOfL2ToL1Logs; i < L2_TO_L1_LOGS_MERKLE_TREE_LEAVES; ++i) {
219                 l2ToL1LogsTreeArray[i] = L2_L1_LOGS_TREE_DEFAULT_LEAF_HASH;
220             }
221             uint256 nodesOnCurrentLevel = L2_TO_L1_LOGS_MERKLE_TREE_LEAVES;
222             while (nodesOnCurrentLevel > 1) {
223                 nodesOnCurrentLevel /= 2;
224                 for (uint256 i = 0; i < nodesOnCurrentLevel; ++i) {
225                     l2ToL1LogsTreeArray[i] = keccak256(
226                         abi.encode(l2ToL1LogsTreeArray[2 * i], l2ToL1LogsTreeArray[2 * i + 1])
227                     );
228                 }
229             }
230             bytes32 l2ToL1LogsTreeRoot = l2ToL1LogsTreeArray[0];
231     
232             /// Check messages
233             uint32 numberOfMessages = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));
234             calldataPtr += 4;
235             bytes32 reconstructedChainedMessagesHash;
236             for (uint256 i = 0; i < numberOfMessages; ++i) {
237                 uint32 currentMessageLength = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));
238                 calldataPtr += 4;
239                 bytes32 hashedMessage = EfficientCall.keccak(
240                     _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + currentMessageLength]
241                 );
242                 calldataPtr += currentMessageLength;
243                 reconstructedChainedMessagesHash = keccak256(abi.encode(reconstructedChainedMessagesHash, hashedMessage));
244             }
245             require(
246                 reconstructedChainedMessagesHash == chainedMessagesHash,
247                 "reconstructedChainedMessagesHash is not equal to chainedMessagesHash"
248             );
249     
250             /// Check bytecodes
251             uint32 numberOfBytecodes = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));
252             calldataPtr += 4;
253             bytes32 reconstructedChainedL1BytecodesRevealDataHash;
254             for (uint256 i = 0; i < numberOfBytecodes; ++i) {
255                 uint32 currentBytecodeLength = uint32(
256                     bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4])
257                 );
258                 calldataPtr += 4;
259                 reconstructedChainedL1BytecodesRevealDataHash = keccak256(
260                     abi.encode(
261                         reconstructedChainedL1BytecodesRevealDataHash,
262                         Utils.hashL2Bytecode(
263                             _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + currentBytecodeLength]
264                         )
265                     )
266                 );
267                 calldataPtr += currentBytecodeLength;
268             }
269             require(
270                 reconstructedChainedL1BytecodesRevealDataHash == chainedL1BytecodesRevealDataHash,
271                 "reconstructedChainedL1BytecodesRevealDataHash is not equal to chainedL1BytecodesRevealDataHash"
272             );
273     
274             /// Check State Diffs
275             /// encoding is as follows:
276             /// header (1 byte version, 3 bytes total len of compressed, 1 byte enumeration index size)
277             /// body (`compressedStateDiffSize` bytes, 4 bytes number of state diffs, `numberOfStateDiffs` * `STATE_DIFF_ENTRY_SIZE` bytes for the uncompressed state diffs)
278             /// encoded state diffs: [20bytes address][32bytes key][32bytes derived key][8bytes enum index][32bytes initial value][32bytes final value]
279             require(
280                 uint256(uint8(bytes1(_totalL2ToL1PubdataAndStateDiffs[calldataPtr]))) ==
281                     STATE_DIFF_COMPRESSION_VERSION_NUMBER,
282                 "state diff compression version mismatch"
283             );
284             calldataPtr++;
285     
286             uint24 compressedStateDiffSize = uint24(bytes3(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 3]));
287             calldataPtr += 3;
288     
289             uint8 enumerationIndexSize = uint8(bytes1(_totalL2ToL1PubdataAndStateDiffs[calldataPtr]));
290             calldataPtr++;
291     
292             bytes calldata compressedStateDiffs = _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr +
293                 compressedStateDiffSize];
294             calldataPtr += compressedStateDiffSize;
295     
296             bytes calldata totalL2ToL1Pubdata = _totalL2ToL1PubdataAndStateDiffs[:calldataPtr];
297     
298             require(calldataPtr <= MAX_ALLOWED_PUBDATA_PER_BATCH, "L1 Messenger pubdata is too long");
299     
300             uint32 numberOfStateDiffs = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));
301             calldataPtr += 4;
302     
303             bytes calldata stateDiffs = _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr +
304                 (numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE)];
305             calldataPtr += numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE;
306     
307             bytes32 stateDiffHash = COMPRESSOR_CONTRACT.verifyCompressedStateDiffs(
308                 numberOfStateDiffs,
309                 enumerationIndexSize,
310                 stateDiffs,
311                 compressedStateDiffs
312             );
313     
314             /// Check for calldata strict format
315             require(calldataPtr == _totalL2ToL1PubdataAndStateDiffs.length, "Extra data in the totalL2ToL1Pubdata array");
316     
317             PUBDATA_CHUNK_PUBLISHER.chunkAndPublishPubdata(totalL2ToL1Pubdata);
318     
319             /// Native (VM) L2 to L1 log
320             SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.L2_TO_L1_LOGS_TREE_ROOT_KEY)), l2ToL1LogsTreeRoot);
321             SystemContractHelper.toL1(
322                 true,
323                 bytes32(uint256(SystemLogKey.TOTAL_L2_TO_L1_PUBDATA_KEY)),
324                 EfficientCall.keccak(totalL2ToL1Pubdata)
325             );
326             SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.STATE_DIFF_HASH_KEY)), stateDiffHash);
327     
328             /// Clear logs state
329             chainedLogsHash = bytes32(0);
330             numberOfLogsToProcess = 0;
331             chainedMessagesHash = bytes32(0);
332             chainedL1BytecodesRevealDataHash = bytes32(0);
333         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L194:333

```solidity
File: system-contracts/contracts/L2BaseToken.sol


32          function transferFromTo(address _from, address _to, uint256 _amount) external override {
33              require(
34                  msg.sender == MSG_VALUE_SYSTEM_CONTRACT ||
35                      msg.sender == address(DEPLOYER_SYSTEM_CONTRACT) ||
36                      msg.sender == BOOTLOADER_FORMAL_ADDRESS,
37                  "Only system contracts with special access can call this method"
38              );
39      
40              uint256 fromBalance = balance[_from];
41              require(fromBalance >= _amount, "Transfer amount exceeds balance");
42              unchecked {
43                  balance[_from] = fromBalance - _amount;
44                  // Overflow not possible: the sum of all balances is capped by totalSupply, and the sum is preserved by
45                  // decrementing then incrementing.
46                  balance[_to] += _amount;
47              }
48      
49              emit Transfer(_from, _to, _amount);
50          }


56          function balanceOf(uint256 _account) external view override returns (uint256) {
57              return balance[address(uint160(_account))];
58          }


64          function mint(address _account, uint256 _amount) external override onlyCallFromBootloader {
65              totalSupply += _amount;
66              balance[_account] += _amount;
67              emit Mint(_account, _amount);
68          }


72          function withdraw(address _l1Receiver) external payable override {
73              uint256 amount = _burnMsgValue();
74      
75              // Send the L2 log, a user could use it as proof of the withdrawal
76              bytes memory message = _getL1WithdrawMessage(_l1Receiver, amount);
77              L1_MESSENGER_CONTRACT.sendToL1(message);
78      
79              emit Withdrawal(msg.sender, _l1Receiver, amount);
80          }


85          function withdrawWithMessage(address _l1Receiver, bytes memory _additionalData) external payable override {
86              uint256 amount = _burnMsgValue();
87      
88              // Send the L2 log, a user could use it as proof of the withdrawal
89              bytes memory message = _getExtendedWithdrawMessage(_l1Receiver, amount, msg.sender, _additionalData);
90              L1_MESSENGER_CONTRACT.sendToL1(message);
91      
92              emit WithdrawalWithMessage(msg.sender, _l1Receiver, amount, _additionalData);
93          }


128         function name() external pure override returns (string memory) {
129             return "Ether";
130         }


134         function symbol() external pure override returns (string memory) {
135             return "ETH";
136         }


140         function decimals() external pure override returns (uint8) {
141             return 18;
142         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L140:142

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


47          fallback(bytes calldata _data) external onlySystemCall returns (bytes memory) {
48              // Firstly we calculate how much gas has been actually provided by the user to the inner call.
49              // For that, we need to get the total gas available in this context and subtract the stipend from it.
50              uint256 gasInContext = gasleft();
51              // Note, that the `gasInContext` might be slightly less than the MSG_VALUE_SIMULATOR_STIPEND_GAS, since
52              // by the time we retrieve it, some gas might have already been spent, e.g. on the `gasleft` opcode itself.
53              uint256 userGas = gasInContext > MSG_VALUE_SIMULATOR_STIPEND_GAS
54                  ? gasInContext - MSG_VALUE_SIMULATOR_STIPEND_GAS
55                  : 0;
56      
57              (uint256 value, bool isSystemCall, address to) = _getAbiParams();
58      
59              // Prevent mimic call to the MsgValueSimulator to prevent an unexpected change of callee.
60              require(to != address(this), "MsgValueSimulator calls itself");
61      
62              if (value != 0) {
63                  (bool success, ) = address(REAL_BASE_TOKEN_SYSTEM_CONTRACT).call(
64                      abi.encodeCall(REAL_BASE_TOKEN_SYSTEM_CONTRACT.transferFromTo, (msg.sender, to, value))
65                  );
66      
67                  // If the transfer of ETH fails, we do the most Ethereum-like behaviour in such situation: revert(0,0)
68                  if (!success) {
69                      assembly {
70                          revert(0, 0)
71                      }
72                  }
73      
74                  // If value is non-zero, we also provide additional gas to the callee.
75                  userGas += GAS_TO_PASS;
76              }
77      
78              // For the next call this `msg.value` will be used.
79              SystemContractHelper.setValueForNextFarCall(Utils.safeCastToU128(value));
80      
81              return EfficientCall.mimicCall(userGas, to, _data, msg.sender, false, isSystemCall);
82          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L47:82

```solidity
File: system-contracts/contracts/NonceHolder.sol


46          function getMinNonce(address _address) public view returns (uint256) {
47              uint256 addressAsKey = uint256(uint160(_address));
48              (, uint256 minNonce) = _splitRawNonce(rawNonces[addressAsKey]);
49      
50              return minNonce;
51          }


57          function getRawNonce(address _address) public view returns (uint256) {
58              uint256 addressAsKey = uint256(uint160(_address));
59              return rawNonces[addressAsKey];
60          }


65          function increaseMinNonce(uint256 _value) public onlySystemCall returns (uint256 oldMinNonce) {
66              require(_value <= MAXIMAL_MIN_NONCE_INCREMENT, "The value for incrementing the nonce is too high");
67      
68              uint256 addressAsKey = uint256(uint160(msg.sender));
69              uint256 oldRawNonce = rawNonces[addressAsKey];
70      
71              unchecked {
72                  rawNonces[addressAsKey] = (oldRawNonce + _value);
73              }
74      
75              (, oldMinNonce) = _splitRawNonce(oldRawNonce);
76          }


82          function setValueUnderNonce(uint256 _key, uint256 _value) public onlySystemCall {
83              IContractDeployer.AccountInfo memory accountInfo = DEPLOYER_SYSTEM_CONTRACT.getAccountInfo(msg.sender);
84      
85              require(_value != 0, "Nonce value cannot be set to 0");
86              // If an account has sequential nonce ordering, we enforce that the previous
87              // nonce has already been used.
88              if (accountInfo.nonceOrdering == IContractDeployer.AccountNonceOrdering.Sequential && _key != 0) {
89                  require(isNonceUsed(msg.sender, _key - 1), "Previous nonce has not been used");
90              }
91      
92              uint256 addressAsKey = uint256(uint160(msg.sender));
93      
94              nonceValues[addressAsKey][_key] = _value;
95      
96              emit ValueSetUnderNonce(msg.sender, _key, _value);
97          }


102         function getValueUnderNonce(uint256 _key) public view returns (uint256) {
103             uint256 addressAsKey = uint256(uint160(msg.sender));
104             return nonceValues[addressAsKey][_key];
105         }


110         function incrementMinNonceIfEquals(uint256 _expectedNonce) external onlySystemCall {
111             uint256 addressAsKey = uint256(uint160(msg.sender));
112             uint256 oldRawNonce = rawNonces[addressAsKey];
113     
114             (, uint256 oldMinNonce) = _splitRawNonce(oldRawNonce);
115             require(oldMinNonce == _expectedNonce, "Incorrect nonce");
116     
117             unchecked {
118                 rawNonces[addressAsKey] = oldRawNonce + 1;
119             }
120         }


125         function getDeploymentNonce(address _address) external view returns (uint256 deploymentNonce) {
126             uint256 addressAsKey = uint256(uint160(_address));
127             (deploymentNonce, ) = _splitRawNonce(rawNonces[addressAsKey]);
128     
129             return deploymentNonce;
130         }


135         function incrementDeploymentNonce(address _address) external returns (uint256 prevDeploymentNonce) {
136             require(
137                 msg.sender == address(DEPLOYER_SYSTEM_CONTRACT),
138                 "Only the contract deployer can increment the deployment nonce"
139             );
140             uint256 addressAsKey = uint256(uint160(_address));
141             uint256 oldRawNonce = rawNonces[addressAsKey];
142     
143             unchecked {
144                 rawNonces[addressAsKey] = (oldRawNonce + DEPLOY_NONCE_MULTIPLIER);
145             }
146     
147             (prevDeploymentNonce, ) = _splitRawNonce(oldRawNonce);
148         }


154         function isNonceUsed(address _address, uint256 _nonce) public view returns (bool) {
155             uint256 addressAsKey = uint256(uint160(_address));
156             return (_nonce < getMinNonce(_address) || nonceValues[addressAsKey][_nonce] > 0);
157         }


166         function validateNonceUsage(address _address, uint256 _key, bool _shouldBeUsed) external view {
167             bool isUsed = isNonceUsed(_address, _key);
168     
169             if (isUsed && !_shouldBeUsed) {
170                 revert("Reusing the same nonce twice");
171             } else if (!isUsed && _shouldBeUsed) {
172                 revert("The nonce was not set as used");
173             }
174         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L166:174

```solidity
File: system-contracts/contracts/PubdataChunkPublisher.sol


21          function chunkAndPublishPubdata(bytes calldata _pubdata) external onlyCallFrom(address(L1_MESSENGER_CONTRACT)) {
22              require(_pubdata.length <= BLOB_SIZE_BYTES * MAX_NUMBER_OF_BLOBS, "pubdata should fit in 2 blobs");
23      
24              bytes32[] memory blobHashes = new bytes32[](MAX_NUMBER_OF_BLOBS);
25      
26              // We allocate to the full size of MAX_NUMBER_OF_BLOBS * BLOB_SIZE_BYTES because we need to pad
27              // the data on the right with 0s if it doesn't take up the full blob
28              bytes memory totalBlobs = new bytes(BLOB_SIZE_BYTES * MAX_NUMBER_OF_BLOBS);
29      
30              assembly {
31                  // The pointer to the allocated memory above. We skip 32 bytes to avoid overwriting the length.
32                  let ptr := add(totalBlobs, 0x20)
33                  calldatacopy(ptr, _pubdata.offset, _pubdata.length)
34              }
35      
36              for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) {
37                  uint256 start = BLOB_SIZE_BYTES * i;
38      
39                  // We break if the pubdata isn't enough to cover 2 blobs. On L1 it is expected that the hash
40                  // will be bytes32(0) if a blob isn't going to be used.
41                  if (start >= _pubdata.length) {
42                      break;
43                  }
44      
45                  bytes32 blobHash;
46                  assembly {
47                      // The pointer to the allocated memory above skipping the length.
48                      let ptr := add(totalBlobs, 0x20)
49                      blobHash := keccak256(add(ptr, start), BLOB_SIZE_BYTES)
50                  }
51      
52                  blobHashes[i] = blobHash;
53              }
54      
55              SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.BLOB_ONE_HASH_KEY)), blobHashes[0]);
56              SystemContractHelper.toL1(true, bytes32(uint256(SystemLogKey.BLOB_TWO_HASH_KEY)), blobHashes[1]);
57          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L21:57

```solidity
File: system-contracts/contracts/SystemContext.sol


84          function setChainId(uint256 _newChainId) external onlyCallFromForceDeployer {
85              chainId = _newChainId;
86          }


99          function setTxOrigin(address _newOrigin) external onlyCallFromBootloader {
100             origin = _newOrigin;
101         }


105         function setGasPrice(uint256 _gasPrice) external onlyCallFromBootloader {
106             gasPrice = _gasPrice;
107         }


112         function setPubdataInfo(uint256 _gasPerPubdataByte, uint256 _basePubdataSpent) external onlyCallFromBootloader {
113             basePubdataSpent = _basePubdataSpent;
114             gasPerPubdataByte = _gasPerPubdataByte;
115         }


117         function getCurrentPubdataSpent() public view returns (uint256) {
118             uint256 pubdataPublished = SystemContractHelper.getZkSyncMeta().pubdataPublished;
119             return pubdataPublished > basePubdataSpent ? pubdataPublished - basePubdataSpent : 0;
120         }


122         function getCurrentPubdataCost() external view returns (uint256) {
123             return gasPerPubdataByte * getCurrentPubdataSpent();
124         }


132         function getBlockHashEVM(uint256 _block) external view returns (bytes32 hash) {
133             uint128 blockNumber = currentVirtualL2BlockInfo.number;
134     
135             VirtualBlockUpgradeInfo memory currentVirtualBlockUpgradeInfo = virtualBlockUpgradeInfo;
136     
137             // Due to virtual blocks upgrade, we'll have to use the following logic for retreiving the blockhash:
138             // 1. If the block number is out of the 256-block supported range, return 0.
139             // 2. If the block was created before the upgrade for the virtual blocks (i.e. there we used to use hashes of the batches),
140             // we return the hash of the batch.
141             // 3. If the block was created after the day when the virtual blocks have caught up with the L2 blocks, i.e.
142             // all the information which is returned for users should be for L2 blocks, we return the hash of the corresponding L2 block.
143             // 4. If the block queried is a virtual blocks, calculate it on the fly.
144             if (blockNumber <= _block || blockNumber - _block > 256) {
145                 hash = bytes32(0);
146             } else if (_block < currentVirtualBlockUpgradeInfo.virtualBlockStartBatch) {
147                 // Note, that we will get into this branch only for a brief moment of time, right after the upgrade
148                 // for virtual blocks before 256 virtual blocks are produced.
149                 hash = batchHashes[_block];
150             } else if (
151                 _block >= currentVirtualBlockUpgradeInfo.virtualBlockFinishL2Block &&
152                 currentVirtualBlockUpgradeInfo.virtualBlockFinishL2Block > 0
153             ) {
154                 hash = _getLatest257L2blockHash(_block);
155             } else {
156                 // Important: we do not want this number to ever collide with the L2 block hash (either new or old one) and so
157                 // that's why the legacy L2 blocks' hashes are keccak256(abi.encodePacked(uint32(_block))), while these are equivalent to
158                 // keccak256(abi.encodePacked(_block))
159                 hash = keccak256(abi.encode(_block));
160             }
161         }


166         function getBatchHash(uint256 _batchNumber) external view returns (bytes32 hash) {
167             hash = batchHashes[_batchNumber];
168         }


172         function getBatchNumberAndTimestamp() public view returns (uint128 batchNumber, uint128 batchTimestamp) {
173             BlockInfo memory batchInfo = currentBatchInfo;
174             batchNumber = batchInfo.number;
175             batchTimestamp = batchInfo.timestamp;
176         }


180         function getL2BlockNumberAndTimestamp() public view returns (uint128 blockNumber, uint128 blockTimestamp) {
181             BlockInfo memory blockInfo = currentL2BlockInfo;
182             blockNumber = blockInfo.number;
183             blockTimestamp = blockInfo.timestamp;
184         }


190         function getBlockNumber() public view returns (uint128) {
191             return currentVirtualL2BlockInfo.number;
192         }


198         function getBlockTimestamp() public view returns (uint128) {
199             return currentVirtualL2BlockInfo.timestamp;
200         }


341         function setL2Block(
342             uint128 _l2BlockNumber,
343             uint128 _l2BlockTimestamp,
344             bytes32 _expectedPrevL2BlockHash,
345             bool _isFirstInBatch,
346             uint128 _maxVirtualBlocksToCreate
347         ) external onlyCallFromBootloader {
348             // We check that the timestamp of the L2 block is consistent with the timestamp of the batch.
349             if (_isFirstInBatch) {
350                 uint128 currentBatchTimestamp = currentBatchInfo.timestamp;
351                 require(
352                     _l2BlockTimestamp >= currentBatchTimestamp,
353                     "The timestamp of the L2 block must be greater than or equal to the timestamp of the current batch"
354                 );
355                 require(_maxVirtualBlocksToCreate > 0, "There must be a virtual block created at the start of the batch");
356             }
357     
358             (uint128 currentL2BlockNumber, uint128 currentL2BlockTimestamp) = getL2BlockNumberAndTimestamp();
359     
360             if (currentL2BlockNumber == 0 && currentL2BlockTimestamp == 0) {
361                 // Since currentL2BlockNumber and currentL2BlockTimestamp are zero it means that it is
362                 // the first ever batch with L2 blocks, so we need to initialize those.
363                 _upgradeL2Blocks(_l2BlockNumber, _expectedPrevL2BlockHash, _isFirstInBatch);
364     
365                 _setNewL2BlockData(_l2BlockNumber, _l2BlockTimestamp, _expectedPrevL2BlockHash);
366             } else if (currentL2BlockNumber == _l2BlockNumber) {
367                 require(!_isFirstInBatch, "Can not reuse L2 block number from the previous batch");
368                 require(currentL2BlockTimestamp == _l2BlockTimestamp, "The timestamp of the same L2 block must be same");
369                 require(
370                     _expectedPrevL2BlockHash == _getLatest257L2blockHash(_l2BlockNumber - 1),
371                     "The previous hash of the same L2 block must be same"
372                 );
373                 require(_maxVirtualBlocksToCreate == 0, "Can not create virtual blocks in the middle of the miniblock");
374             } else if (currentL2BlockNumber + 1 == _l2BlockNumber) {
375                 // From the checks in _upgradeL2Blocks it is known that currentL2BlockNumber can not be 0
376                 bytes32 prevL2BlockHash = _getLatest257L2blockHash(currentL2BlockNumber - 1);
377     
378                 bytes32 pendingL2BlockHash = _calculateL2BlockHash(
379                     currentL2BlockNumber,
380                     currentL2BlockTimestamp,
381                     prevL2BlockHash,
382                     currentL2BlockTxsRollingHash
383                 );
384     
385                 require(_expectedPrevL2BlockHash == pendingL2BlockHash, "The current L2 block hash is incorrect");
386                 require(
387                     _l2BlockTimestamp > currentL2BlockTimestamp,
388                     "The timestamp of the new L2 block must be greater than the timestamp of the previous L2 block"
389                 );
390     
391                 // Since the new block is created, we'll clear out the rolling hash
392                 _setNewL2BlockData(_l2BlockNumber, _l2BlockTimestamp, _expectedPrevL2BlockHash);
393             } else {
394                 revert("Invalid new L2 block number");
395             }
396     
397             _setVirtualBlock(_l2BlockNumber, _maxVirtualBlocksToCreate, _l2BlockTimestamp);
398         }


402         function appendTransactionToCurrentL2Block(bytes32 _txHash) external onlyCallFromBootloader {
403             currentL2BlockTxsRollingHash = keccak256(abi.encode(currentL2BlockTxsRollingHash, _txHash));
404         }


408         function publishTimestampDataToL1() external onlyCallFromBootloader {
409             (uint128 currentBatchNumber, uint128 currentBatchTimestamp) = getBatchNumberAndTimestamp();
410             (, uint128 currentL2BlockTimestamp) = getL2BlockNumberAndTimestamp();
411     
412             // The structure of the "setNewBatch" implies that currentBatchNumber > 0, but we still double check it
413             require(currentBatchNumber > 0, "The current batch number must be greater than 0");
414     
415             // In order to spend less pubdata, the packed version is published
416             uint256 packedTimestamps = (uint256(currentBatchTimestamp) << 128) | currentL2BlockTimestamp;
417     
418             SystemContractHelper.toL1(
419                 false,
420                 bytes32(uint256(SystemLogKey.PACKED_BATCH_AND_L2_BLOCK_TIMESTAMP_KEY)),
421                 bytes32(packedTimestamps)
422             );
423         }


444         function setNewBatch(
445             bytes32 _prevBatchHash,
446             uint128 _newTimestamp,
447             uint128 _expectedNewNumber,
448             uint256 _baseFee
449         ) external onlyCallFromBootloader {
450             (uint128 previousBatchNumber, uint128 previousBatchTimestamp) = getBatchNumberAndTimestamp();
451             require(_newTimestamp > previousBatchTimestamp, "Timestamps should be incremental");
452             require(previousBatchNumber + 1 == _expectedNewNumber, "The provided block number is not correct");
453     
454             _ensureBatchConsistentWithL2Block(_newTimestamp);
455     
456             batchHashes[previousBatchNumber] = _prevBatchHash;
457     
458             // Setting new block number and timestamp
459             BlockInfo memory newBlockInfo = BlockInfo({number: previousBatchNumber + 1, timestamp: _newTimestamp});
460     
461             currentBatchInfo = newBlockInfo;
462     
463             baseFee = _baseFee;
464     
465             // The correctness of this block hash:
466             SystemContractHelper.toL1(false, bytes32(uint256(SystemLogKey.PREV_BATCH_HASH_KEY)), _prevBatchHash);
467         }


471         function unsafeOverrideBatch(
472             uint256 _newTimestamp,
473             uint256 _number,
474             uint256 _baseFee
475         ) external onlyCallFromBootloader {
476             BlockInfo memory newBlockInfo = BlockInfo({number: uint128(_number), timestamp: uint128(_newTimestamp)});
477             currentBatchInfo = newBlockInfo;
478     
479             baseFee = _baseFee;
480         }


482         function incrementTxNumberInBatch() external onlyCallFromBootloader {
483             txNumberInBlock += 1;
484         }


486         function resetTxNumberInBatch() external onlyCallFromBootloader {
487             txNumberInBlock = 0;
488         }


496         function currentBlockInfo() external view returns (uint256 blockInfo) {
497             (uint128 blockNumber, uint128 blockTimestamp) = getBatchNumberAndTimestamp();
498             blockInfo = (uint256(blockNumber) << 128) | uint256(blockTimestamp);
499         }


503         function getBlockNumberAndTimestamp() external view returns (uint256 blockNumber, uint256 blockTimestamp) {
504             (blockNumber, blockTimestamp) = getBatchNumberAndTimestamp();
505         }


509         function blockHash(uint256 _blockNumber) external view returns (bytes32 hash) {
510             hash = batchHashes[_blockNumber];
511         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L509:511

</details>

## NC062 - Consider adding formal verification proofs:

Consider using formal verification to mathematically prove that your code does what is intended, and does not have any edge cases with unexpected behavior. The solidity compiler itself has this functionality [built in based off of SMTChecker](https://docs.soliditylang.org/en/latest/smtchecker.html#smtchecker-and-formal-verification).


```solidity
File: Various Files


None

```

## NC063 - Assembly code blocks should be thoroughly commented:

In Solidity, assembly blocks are often harder to read and understand due to their low-level nature. Detailed comments can make the code's purpose and functionality clear, aiding in maintenance, debugging, and reviews. Moreover, comments can be crucial for auditors and other developers to understand the contract's security implications, reducing the risk of oversights and vulnerabilities.


<details>
<summary>Click to show 71 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


357                 assembly {
358                     callSuccess := call(gas(), _depositSender, _amount, 0, 0, 0, 0)
359                 }


446                 assembly {
447                     callSuccess := call(gas(), l1Receiver, amount, 0, 0, 0, 0)
448                 }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L446:448

```solidity
File: contracts/ethereum/contracts/common/ReentrancyGuard.sol


52              assembly {
53                  lockSlotOldValue := sload(LOCK_FLAG_ADDRESS)
54                  sstore(LOCK_FLAG_ADDRESS, _NOT_ENTERED)
55              }


70              assembly {
71                  _status := sload(LOCK_FLAG_ADDRESS)
72              }


78              assembly {
79                  sstore(LOCK_FLAG_ADDRESS, _ENTERED)
80              }


86              assembly {
87                  sstore(LOCK_FLAG_ADDRESS, _NOT_ENTERED)
88              }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L86:88

```solidity
File: contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol


20              assembly {
21                  offset := add(_start, 4)
22                  result := mload(add(_bytes, offset))
23              }


27              assembly {
28                  offset := add(_start, 20)
29                  result := mload(add(_bytes, offset))
30              }


34              assembly {
35                  offset := add(_start, 32)
36                  result := mload(add(_bytes, offset))
37              }


41              assembly {
42                  offset := add(_start, 32)
43                  result := mload(add(_bytes, offset))
44              }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L41:44

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


229                     assembly {
230                         revert(add(returnData, 0x20), mload(returnData))
231                     }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L229:231

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


238                 case 0 {
239                     // End execution and revert state changes
240                     revert(0, size)
241                 }


242                 default {
243                     // Return data with length of size at pointers position
244                     return(0, size)
245                 }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L242:245

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol


46                  case 0 {
47                      // End execution and revert state changes
48                      revert(ptr, size)
49                  }


50                  default {
51                      // Return data with length of size at pointers position
52                      return(ptr, size)
53                  }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L50:53

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


360                 assembly {
361                     mstore(add(hashedFactoryDeps, mul(add(i, 1), 32)), hashedBytecode)
362                 }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L360:362

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


89              assembly {
90                  diamondStorage.slot := position
91              }


290                     assembly {
291                         revert(add(data, 0x20), mload(data))
292                     }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L290:292

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol


41              assembly {
42                  mstore(0x00, _lhs)
43                  mstore(0x20, _rhs)
44                  result := keccak256(0x00, 0x40)
45              }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L41:45

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


41              assembly {
42                  dataStart := add(data, 0x20)
43              }


61                  assembly {
62                      success := call(to, callAddr, 0, 0, farCallAbi, 0, 0)
63                  }


70                  assembly {
71                      success := call(msgValueSimulator, callAddr, value, to, farCallAbi, forwardMask, 0)
72                  }


85              assembly {
86                  size := returndatasize()
87              }


90              assembly {
91                  returndatacopy(add(returnData, 0x20), 0, size)
92              }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L90:92

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


70              assembly {
71                  sstore(addressAsKey, _hash)
72              }


81              assembly {
82                  codeHash := sload(addressAsKey)
83              }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L81:83

```solidity
File: system-contracts/contracts/ComplexUpgrader.sol


26              assembly {
27                  if iszero(success) {
28                      revert(add(returnData, 0x20), mload(returnData))
29                  }
30              }


27                  if iszero(success) {
28                      revert(add(returnData, 0x20), mload(returnData))
29                  }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L27:29

```solidity
File: system-contracts/contracts/DefaultAccount.sol


31                  assembly {
32                      return(0, 0)
33                  }


49                  assembly {
50                      return(0, 0)
51                  }


168             assembly {
169                 r := mload(add(_signature, 0x20))
170                 s := mload(add(_signature, 0x40))
171                 v := and(mload(add(_signature, 0x41)), 0xff)
172             }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L168:172

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


55                  assembly {
56                      sstore(_bytecodeHash, 1)
57                  }


66              assembly {
67                  marker := sload(_hash)
68              }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L66:68

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


69                      assembly {
70                          revert(0, 0)
71                      }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L69:71

```solidity
File: system-contracts/contracts/PubdataChunkPublisher.sol


46                  assembly {
47                      // The pointer to the allocated memory above skipping the length.
48                      let ptr := add(totalBlobs, 0x20)
49                      blobHash := keccak256(add(ptr, start), BLOB_SIZE_BYTES)
50                  }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L46:50

```solidity
File: system-contracts/contracts/libraries/EfficientCall.sol


135                 assembly {
136                     success := call(_address, callAddr, 0, 0, 0xFFFF, 0, 0)
137                 }


148                 assembly {
149                     success := call(msgValueSimulator, callAddr, _value, _address, 0xFFFF, forwardMask, 0)
150                 }


163             assembly {
164                 success := staticcall(_address, callAddr, 0, 0xFFFF, 0, 0)
165             }


177             assembly {
178                 success := delegatecall(_address, callAddr, 0, 0xFFFF, 0, 0)
179             }


203             assembly {
204                 // Clearing values before usage in assembly, since Solidity
205                 // doesn't do it by default
206                 _whoToMimic := and(_whoToMimic, cleanupMask)
207     
208                 success := call(_address, callAddr, 0, 0, _whoToMimic, 0, 0)
209             }


218                 assembly {
219                     size := returndatasize()
220                 }


223                 assembly {
224                     returndatacopy(add(returnData, 0x20), 0, size)
225                 }


233             assembly {
234                 let size := returndatasize()
235                 returndatacopy(0, 0, size)
236                 revert(0, size)
237             }


254             assembly {
255                 dataOffset := _data.offset
256             }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L254:256

```solidity
File: system-contracts/contracts/libraries/RLPEncoder.sol


39                      assembly {
40                          mstore(add(encoded, 0x21), shiftedVal)
41                      }


74                      assembly {
75                          mstore(add(encoded, 0x21), shiftedVal)
76                      }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L74:76

```solidity
File: system-contracts/contracts/libraries/SystemContractHelper.sol


65              assembly {
66                  addr := staticcall(0, callAddr, 0, 0xFFFF, 0, 0)
67              }


76              assembly {
77                  pop(staticcall(0, callAddr, 0, 0xFFFF, 0, 0))
78              }


87              assembly {
88                  pop(staticcall(_farCallAbi, callAddr, 0, 0xFFFF, 0, 0))
89              }


97              assembly {
98                  // Clearing input params as they are not cleaned by Solidity by default
99                  _value := and(_value, cleanupMask)
100                 pop(staticcall(_value, callAddr, 0, 0xFFFF, 0, 0))
101             }


109             assembly {
110                 // Clearing input params as they are not cleaned by Solidity by default
111                 _shrink := and(_shrink, cleanupMask)
112                 pop(staticcall(_shrink, callAddr, 0, 0xFFFF, 0, 0))
113             }


158             assembly {
159                 // Clearing input params as they are not cleaned by Solidity by default
160                 params := and(params, cleanupMask)
161                 success := staticcall(_rawParams, callAddr, params, 0xFFFF, 0, 0)
162             }


171             assembly {
172                 // Clearing input params as they are not cleaned by Solidity by default
173                 _value := and(_value, cleanupMask)
174                 success := call(0, callAddr, _value, 0, 0xFFFF, 0, 0)
175             }


183             assembly {
184                 pop(call(initializer, callAddr, value1, 0, 0xFFFF, 0, 0))
185             }


193             assembly {
194                 pop(call(value1, callAddr, value2, 0, 0xFFFF, 0, 0))
195             }


205             assembly {
206                 meta := staticcall(0, callAddr, 0, 0xFFFF, 0, 0)
207             }


298             assembly {
299                 callFlags := staticcall(0, callAddr, 0, 0xFFFF, 0, 0)
300             }


309             assembly {
310                 ptr := staticcall(0, callAddr, 0, 0xFFFF, 0, 0)
311             }


322             assembly {
323                 extraAbiData := staticcall(index, callAddr, 0, 0xFFFF, 0, 0)
324             }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L322:324

```solidity
File: system-contracts/contracts/libraries/SystemContractsCaller.sol


80              assembly {
81                  dataStart := add(data, 0x20)
82              }


100                 assembly {
101                     success := call(to, callAddr, 0, 0, farCallAbi, 0, 0)
102                 }


109                 assembly {
110                     success := call(msgValueSimulator, callAddr, value, to, farCallAbi, forwardMask, 0)
111                 }


132             assembly {
133                 size := returndatasize()
134             }


137             assembly {
138                 returndatacopy(add(returnData, 0x20), 0, size)
139             }


160                 assembly {
161                     let size := mload(returnData)
162                     revert(add(returnData, 0x20), size)
163                 }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L160:163

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


399             assembly {
400                 success := call(gas(), bootloaderAddr, amount, 0, 0, 0, 0)
401             }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L399:401

```solidity
File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol


20              assembly {
21                  let offset := sub(_bytes.offset, 30)
22                  result := calldataload(add(offset, _start))
23              }


27              assembly {
28                  let offset := sub(_bytes.offset, 28)
29                  result := calldataload(add(offset, _start))
30              }


34              assembly {
35                  let offset := sub(_bytes.offset, 24)
36                  result := calldataload(add(offset, _start))
37              }


41              assembly {
42                  result := calldataload(add(_bytes.offset, _start))
43              }


47              assembly {
48                  result := calldataload(add(_bytes.offset, _start))
49              }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L47:49

</details>

## NC064 - Common functions should be refactored to a common base contract:

The functions below have the same implementation as is seen in other files. The functions should be refactored into functions of a common base contract.


<details>
<summary>Click to show 34 findings</summary>

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol


/// @audit seen in zksync/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol
    function finalizeWithdrawal(
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L9:15

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol


/// @audit seen in zksync/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol
    function l2TokenAddress(address _l1Token) external view returns (address);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L19:19

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol


/// @audit seen in zksync/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol
    function l2TokenAddress(address _l1Token) external view returns (address);

/// @audit seen in zksync/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol
    function finalizeDeposit(
        address _l1Sender,
        address _l2Receiver,
        address _l1Token,
        uint256 _amount,
        bytes calldata _data
    ) external payable;

/// @audit seen in zksync/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol
    function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external;

/// @audit seen in zksync/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol
    function l1TokenAddress(address _l2Token) external view returns (address);

/// @audit seen in zksync/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol
    function l1Bridge() external view returns (address);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L38:38

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


/// @audit seen in zksync/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol
    function sharedBridge() external view returns (IL1SharedBridge);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L67:67

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol


/// @audit seen in zksync/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol
    function l2Bridge() external view returns (address);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L18:18

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


/// @audit seen in zksync/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol
    function l2Bridge() external view returns (address);

/// @audit seen in zksync/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol
    function bridgeMint(address _account, uint256 _amount) external;

/// @audit seen in zksync/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol
    function bridgeBurn(address _account, uint256 _amount) external;

/// @audit seen in zksync/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol
    function l1Address() external view returns (address);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L14:14

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol


/// @audit seen in zksync/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol
    function finalizeWithdrawal(
        uint256 _chainId,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol#L9:16

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


/// @audit seen in zksync/contracts/ethereum/contracts/bridgehub/Bridgehub.sol
    function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin {
        // Save previous value into the stack to put it into the event later
        address oldPendingAdmin = pendingAdmin;
        // Change pending admin
        pendingAdmin = _newPendingAdmin;
        emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
    }

/// @audit seen in zksync/contracts/ethereum/contracts/bridgehub/Bridgehub.sol
    function acceptAdmin() external {
        address currentPendingAdmin = pendingAdmin;
        require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights

        address previousAdmin = admin;
        admin = currentPendingAdmin;
        delete pendingAdmin;

        emit NewPendingAdmin(currentPendingAdmin, address(0));
        emit NewAdmin(previousAdmin, pendingAdmin);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L119:129

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


/// @audit seen in zksync/contracts/ethereum/contracts/bridgehub/IBridgehub.sol
    function setPendingAdmin(address _newPendingAdmin) external;

/// @audit seen in zksync/contracts/ethereum/contracts/bridgehub/IBridgehub.sol
    function acceptAdmin() external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L51:51

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol


/// @audit seen in zksync/contracts/ethereum/contracts/bridgehub/IBridgehub.sol
    function setPendingAdmin(address _newPendingAdmin) external;

/// @audit seen in zksync/contracts/ethereum/contracts/bridgehub/IBridgehub.sol
    function acceptAdmin() external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L20:20

```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


/// @audit seen in zksync/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol
    function computeCreate2Address(
        address _sender,
        bytes32 _salt,
        bytes32 _bytecodeHash,
        bytes32 _constructorInputHash
    ) internal pure returns (address) {
        bytes32 senderBytes = bytes32(uint256(uint160(_sender)));
        bytes32 data = keccak256(
            bytes.concat(CREATE2_PREFIX, senderBytes, _salt, _bytecodeHash, _constructorInputHash)
        );

        return address(uint160(uint256(data)));
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L101:113

```solidity
File: system-contracts/contracts/EmptyContract.sol


/// @audit seen in zksync/contracts/ethereum/contracts/governance/Governance.sol
    receive() external payable {}

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L13:13

```solidity
File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol


/// @audit seen in zksync/contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol
    function upgrade(ProposedUpgrade calldata _proposedUpgrade) public override returns (bytes32) {
        super.upgrade(_proposedUpgrade);
        return Diamond.DIAMOND_INIT_SUCCESS_RETURN_VALUE;
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L14:17

```solidity
File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol


/// @audit seen in zksync/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol
    function applyL1ToL2Alias(address l1Address) internal pure returns (address l2Address) {
        unchecked {
            l2Address = address(uint160(l1Address) + offset);
        }
    }

/// @audit seen in zksync/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol
    function undoL1ToL2Alias(address l2Address) internal pure returns (address l1Address) {
        unchecked {
            l1Address = address(uint160(l2Address) - offset);
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L38:42

```solidity
File: system-contracts/contracts/interfaces/IL1Messenger.sol


/// @audit seen in zksync/contracts/zksync/contracts/L2ContractHelper.sol
    function sendToL1(bytes memory _message) external returns (bytes32);

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L49:49

```solidity
File: system-contracts/contracts/libraries/Utils.sol


/// @audit seen in zksync/contracts/zksync/contracts/SystemContractsCaller.sol
    function safeCastToU32(uint256 _x) internal pure returns (uint32) {
        require(_x <= type(uint32).max, "Overflow");

        return uint32(_x);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L26:30

```solidity
File: system-contracts/contracts/libraries/SystemContractsCaller.sol


/// @audit seen in zksync/contracts/zksync/contracts/SystemContractsCaller.sol
    function systemCallWithReturndata(
        uint32 gasLimit,
        address to,
        uint128 value,
        bytes memory data
    ) internal returns (bool success, bytes memory returnData) {
        success = systemCall(gasLimit, to, value, data);

        uint256 size;
        assembly {
            size := returndatasize()
        }

        returnData = new bytes(size);
        assembly {
            returndatacopy(add(returnData, 0x20), 0, size)
        }
    }

/// @audit seen in zksync/contracts/zksync/contracts/SystemContractsCaller.sol
    function getFarCallABI(
        uint32 dataOffset,
        uint32 memoryPage,
        uint32 dataStart,
        uint32 dataLength,
        uint32 gasPassed,
        uint8 shardId,
        CalldataForwardingMode forwardingMode,
        bool isConstructorCall,
        bool isSystemCall
    ) internal pure returns (uint256 farCallAbi) {
        // Fill in the call parameter fields
        farCallAbi = getFarCallABIWithEmptyFatPointer(
            gasPassed,
            shardId,
            forwardingMode,
            isConstructorCall,
            isSystemCall
        );
        // Fill in the fat pointer fields
        farCallAbi |= dataOffset;
        farCallAbi |= (uint256(memoryPage) << 32);
        farCallAbi |= (uint256(dataStart) << 64);
        farCallAbi |= (uint256(dataLength) << 96);
    }

/// @audit seen in zksync/contracts/zksync/contracts/SystemContractsCaller.sol
    function getFarCallABIWithEmptyFatPointer(
        uint32 gasPassed,
        uint8 shardId,
        CalldataForwardingMode forwardingMode,
        bool isConstructorCall,
        bool isSystemCall
    ) internal pure returns (uint256 farCallAbiWithEmptyFatPtr) {
        farCallAbiWithEmptyFatPtr |= (uint256(gasPassed) << 192);
        farCallAbiWithEmptyFatPtr |= (uint256(forwardingMode) << 224);
        farCallAbiWithEmptyFatPtr |= (uint256(shardId) << 232);
        if (isConstructorCall) {
            farCallAbiWithEmptyFatPtr |= (1 << 240);
        }
        if (isSystemCall) {
            farCallAbiWithEmptyFatPtr |= (1 << 248);
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L250:266

```solidity
File: system-contracts/contracts/interfaces/IPaymaster.sol


/// @audit seen in zksync/contracts/zksync/contracts/interfaces/IPaymaster.sol
    function validateAndPayForPaymasterTransaction(
        bytes32 _txHash,
        bytes32 _suggestedSignedHash,
        Transaction calldata _transaction
    ) external payable returns (bytes4 magic, bytes memory context);

/// @audit seen in zksync/contracts/zksync/contracts/interfaces/IPaymaster.sol
    function postTransaction(
        bytes calldata _context,
        Transaction calldata _transaction,
        bytes32 _txHash,
        bytes32 _suggestedSignedHash,
        ExecutionResult _txResult,
        uint256 _maxRefundedGas
    ) external payable;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L43:50

```solidity
File: system-contracts/contracts/interfaces/IPaymasterFlow.sol


/// @audit seen in zksync/contracts/zksync/contracts/interfaces/IPaymasterFlow.sol
    function general(bytes calldata input) external;

/// @audit seen in zksync/contracts/zksync/contracts/interfaces/IPaymasterFlow.sol
    function approvalBased(address _token, uint256 _minAllowance, bytes calldata _innerInput) external;

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymasterFlow.sol#L15:15

</details>

## NC065 - Polymorphic functions make security audits more time-consuming and error-prone:

The instances below point to one of two functions with the same name. Consider naming each function differently, in order to make code navigation and analysis easier.


```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


133         function deposit(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L133:133

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol


35          function deposit(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L35:35

## NC066 - Error messages should descriptive, rather that cryptic:




<details>
<summary>Click to show 96 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


141             require(_amount != 0, "0T"); // empty deposit


143             require(amount == _amount, "3T"); // The token has non-standard transfer logic


186             require(amount != 0, "2T"); // empty deposit


215             require(!isWithdrawalFinalized[_l2BatchNumber][_l2MessageIndex], "pw");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L215:215

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


161                 require(amount == _amount, "3T"); // The token has non-standard transfer logic


206                 require(withdrawAmount == _depositAmount, "5T"); // The token has non-standard transfer logic


208             require(amount != 0, "6T"); // empty deposit amount


325                 require(proofValid, "yn");


327             require(_amount > 0, "y1");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L327:327

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


62              require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L62:62

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


121             require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L121:121

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


195                     require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed


217                     require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L217:217

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


25              require(address(_initializeData.verifier) != address(0), "vt");


26              require(_initializeData.admin != address(0), "vy");


27              require(_initializeData.validatorTimelock != address(0), "hc");


28              require(_initializeData.priorityTxMaxGasLimit <= MAX_GAS_PER_TRANSACTION, "vu");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L28:28

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol


14              require(_chainId == block.chainid, "pr");


25              require(msg.data.length >= 4 || msg.data.length == 0, "Ut");


30              require(facetAddress != address(0), "F"); // Proxy has no facet for this selector


31              require(!diamondStorage.isFrozen || !facet.isFreezable, "q1"); // Facet is frozen


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L31:31

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


34              require(msg.sender == pendingAdmin, "n4"); // Only proposed by current admin address can claim the admin rights


59              require(_newPriorityTxMaxGasLimit <= MAX_GAS_PER_TRANSACTION, "n5");


70              require(_newFeeParams.maxPubdataPerBatch >= _newFeeParams.priorityTxMaxPubdata, "n6");


136             require(!diamondStorage.isFrozen, "a9"); // diamond proxy is frozen already


146             require(diamondStorage.isFrozen, "a7"); // diamond proxy is not frozen


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L146:146

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


37              require(_newBatch.batchNumber == _previousBatch.batchNumber + 1, "f"); // only commit next batch


40              require(pubdataSource == uint8(PubdataSource.Calldata) || pubdataSource == uint8(PubdataSource.Blob), "us");


50                  require(logOutput.pubdataHash == 0x00, "v0h");


61                  require(


74              require(_previousBatch.batchHash == logOutput.previousBatchHash, "l");


76              require(logOutput.chainedPriorityTxsHash == _newBatch.priorityOperationsHash, "t");


78              require(logOutput.numberOfLayer1Txs == _newBatch.numberOfLayer1Txs, "ta");


110             require(batchTimestamp == _expectedBatchTimestamp, "tb");


114             require(_previousBatchTimestamp < batchTimestamp, "h3");


122             require(block.timestamp - COMMIT_TIMESTAMP_NOT_OLDER <= batchTimestamp, "h1"); // New batch timestamp is too small


123             require(lastL2BlockTimestamp <= block.timestamp + COMMIT_TIMESTAMP_APPROXIMATION_DELTA, "h2"); // The last L2 block timestamp is too big


149                 require(!_checkBit(processedLogs, uint8(logKey)), "kp");


154                     require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "lm");


157                     require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "ln");


160                     require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "lb");


163                     require(logSender == L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR, "sc");


166                     require(logSender == L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR, "sv");


169                     require(logSender == L2_BOOTLOADER_ADDRESS, "bl");


172                     require(logSender == L2_BOOTLOADER_ADDRESS, "bk");


175                     require(logSender == L2_PUBDATA_CHUNK_PUBLISHER_ADDR, "pc");


178                     require(logSender == L2_PUBDATA_CHUNK_PUBLISHER_ADDR, "pd");


181                     require(logSender == L2_BOOTLOADER_ADDRESS, "bu");


182                     require(_expectedSystemContractUpgradeTxHash == logValue, "ut");


192                 require(processedLogs == 511, "b7");


194                 require(processedLogs == 1023, "b8");


231             require(_newBatchesData.length == 1, "e4");


233             require(s.storedBatchHashes[s.totalBatchesCommitted] == _hashStoredBatchInfo(_lastCommittedBatchData), "i"); // incorrect previous batch data


284             require(s.l2SystemContractsUpgradeBatchNumber == 0, "ik");


323             require(currentBatchNumber == s.totalBatchesExecuted + _executedBatchIdx + 1, "k"); // Execute batches in order


324             require(


330             require(priorityOperationsHash == _storedBatch.priorityOperationsHash, "x"); // priority operations hash does not match to expected


358             require(newTotalBatchesExecuted <= s.totalBatchesVerified, "n"); // Can't execute batches more than committed and proven currently.


402             require(_hashStoredBatchInfo(_prevBatch) == s.storedBatchHashes[currentTotalBatchesVerified], "t1");


407                 require(


421             require(currentTotalBatchesVerified <= s.totalBatchesCommitted, "q");


442             require(proofPublicInput.length == 1, "t4");


449             require(successVerifyProof, "p"); // Proof verification fail


482             require(s.totalBatchesCommitted > _newLastBatch, "v1"); // The last committed batch is less than new last batch


483             require(_newLastBatch >= s.totalBatchesExecuted, "v2"); // Already executed batches cannot be reverted


543             require(_batch.systemLogs.length <= MAX_L2_TO_L1_LOGS_COMMITMENT_BYTES, "pu");


567             require(_blobCommitments.length == MAX_NUMBER_OF_BLOBS, "b10");


568             require(_blobHashes.length == MAX_NUMBER_OF_BLOBS, "b11");


631             require(_pubdataCommitments.length > 0, "pl");


632             require(_pubdataCommitments.length <= PUBDATA_COMMITMENT_SIZE * MAX_NUMBER_OF_BLOBS, "bd");


633             require(_pubdataCommitments.length % PUBDATA_COMMITMENT_SIZE == 0, "bs");


639                 require(blobVersionedHash != bytes32(0), "vh");


663             require(versionedHash == bytes32(0), "lh");


668                 require(


681             require(success, "vc");


184                     revert("ul");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L184:184

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


183             require(ds.selectorToFacet[_selector].facetAddress != address(0), "g2");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L183:183

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


110             require(_batchNumber <= s.totalBatchesExecuted, "xx");


117             require(hashedLog != L2_L1_LOGS_TREE_DEFAULT_LEAF_HASH, "tw");


243             require(_request.l2GasPerPubdataByteLimit == REQUIRED_L2_GAS_PRICE_PER_PUBDATA, "qp");


264             require(_factoryDeps.length <= MAX_NEW_FACTORY_DEPS, "uj");


272             require(_mintValue >= baseCost + _params.l2Value, "mv"); // The `msg.value` doesn't cover the transaction cost


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L272:272

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


55              require(_l1Bridge != address(0), "bf");


56              require(_l2TokenProxyBytecodeHash != bytes32(0), "df");


57              require(_aliasedOwner != address(0), "sf");


58              require(_l2TokenProxyBytecodeHash != bytes32(0), "df");


68                  require(_l1LegecyBridge != address(0), "bf2");


87              require(


98                  require(deployedToken == expectedL2Token, "mt");


101                 require(currentL1Token == _l1Token, "gg"); // Double check that the expected value equal to real one


129             require(l1Token != address(0), "yh");


176             require(success, "mk");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L176:176

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


51              require(_l1Address != address(0), "in6"); // Should be non-zero address


120             require(msg.sender == UpgradeableBeacon(beaconAddress).owner(), "tt");


130             require(msg.sender == l2Bridge, "xnt"); // Only L2 bridge can call this method


137             require(_version == _getInitializedVersion() + 1, "v");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L137:137

</details>

## NC067 - Missing timelock for critical parameter change:

Timelocks prevent users from being surprised by changes.


<details>
<summary>Click to show 14 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


55              pendingAdmin = _newPendingAdmin;


109             sharedBridge = IL1SharedBridge(_sharedBridge);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L109:109

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


114             pendingAdmin = _newPendingAdmin;


138             initialCutHash = keccak256(abi.encode(_diamondCut));


148             protocolVersion = _newProtocolVersion;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L148:148

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


74              stateTransitionManager = _stateTransitionManager;


97              executionDelay = _executionDelay;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L97:97

```solidity
File: system-contracts/contracts/SystemContext.sol


85              chainId = _newChainId;


100             origin = _newOrigin;


106             gasPrice = _gasPrice;


113             basePubdataSpent = _basePubdataSpent;


114             gasPerPubdataByte = _gasPerPubdataByte;


461             currentBatchInfo = newBlockInfo;


463             baseFee = _baseFee;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L463:463

</details>

## NC068 - Setters should prevent re-setting of the same value:

This especially problematic when the setter also emits the same value, which may be confusing to offline parsers.


<details>
<summary>Click to show 29 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


51          function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin {
52              // Save previous value into the stack to put it into the event later
53              address oldPendingAdmin = pendingAdmin;
54              // Change pending admin
55              pendingAdmin = _newPendingAdmin;
56              emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
57          }


108         function setSharedBridge(address _sharedBridge) external onlyOwner {
109             sharedBridge = IL1SharedBridge(_sharedBridge);
110         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L108:110

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


110         function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin {
111             // Save previous value into the stack to put it into the event later
112             address oldPendingAdmin = pendingAdmin;
113             // Change pending admin
114             pendingAdmin = _newPendingAdmin;
115             emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
116         }


132         function setValidatorTimelock(address _validatorTimelock) external onlyOwnerOrAdmin {
133             validatorTimelock = _validatorTimelock;
134         }


137         function setInitialCutHash(Diamond.DiamondCutData calldata _diamondCut) external onlyOwner {
138             initialCutHash = keccak256(abi.encode(_diamondCut));
139         }


142         function setNewVersionUpgrade(
143             Diamond.DiamondCutData calldata _cutData,
144             uint256 _oldProtocolVersion,
145             uint256 _newProtocolVersion
146         ) external onlyOwner {
147             upgradeCutHash[_oldProtocolVersion] = keccak256(abi.encode(_cutData));
148             protocolVersion = _newProtocolVersion;
149         }


152         function setUpgradeDiamondCut(
153             Diamond.DiamondCutData calldata _cutData,
154             uint256 _oldProtocolVersion
155         ) external onlyOwner {
156             upgradeCutHash[_oldProtocolVersion] = keccak256(abi.encode(_cutData));
157         }


177         function _setChainIdUpgrade(uint256 _chainId, address _chainContract) internal {
178             bytes memory systemContextCalldata = abi.encodeCall(ISystemContext.setChainId, (_chainId));
179             uint256[] memory uintEmptyArray;
180             bytes[] memory bytesEmptyArray;
181     
182             L2CanonicalTransaction memory l2ProtocolUpgradeTx = L2CanonicalTransaction({
183                 txType: SYSTEM_UPGRADE_L2_TX_TYPE,
184                 from: uint256(uint160(L2_FORCE_DEPLOYER_ADDR)),
185                 to: uint256(uint160(L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR)),
186                 gasLimit: $(PRIORITY_TX_MAX_GAS_LIMIT),
187                 gasPerPubdataByteLimit: REQUIRED_L2_GAS_PRICE_PER_PUBDATA,
188                 maxFeePerGas: uint256(0),
189                 maxPriorityFeePerGas: uint256(0),
190                 paymaster: uint256(0),
191                 // Note, that the priority operation id is used as "nonce" for L1->L2 transactions
192                 nonce: protocolVersion,
193                 value: 0,
194                 reserved: [uint256(0), 0, 0, 0],
195                 data: systemContextCalldata,
196                 signature: new bytes(0),
197                 factoryDeps: uintEmptyArray,
198                 paymasterInput: new bytes(0),
199                 reservedDynamic: new bytes(0)
200             });
201     
202             ProposedUpgrade memory proposedUpgrade = ProposedUpgrade({
203                 l2ProtocolUpgradeTx: l2ProtocolUpgradeTx,
204                 factoryDeps: bytesEmptyArray,
205                 bootloaderHash: bytes32(0),
206                 defaultAccountHash: bytes32(0),
207                 verifier: address(0),
208                 verifierParams: VerifierParams({
209                     recursionNodeLevelVkHash: bytes32(0),
210                     recursionLeafLevelVkHash: bytes32(0),
211                     recursionCircuitsSetVksHash: bytes32(0)
212                 }),
213                 l1ContractsUpgradeCalldata: new bytes(0),
214                 postUpgradeCalldata: new bytes(0),
215                 upgradeTimestamp: 0,
216                 newProtocolVersion: protocolVersion
217             });
218     
219             Diamond.FacetCut[] memory emptyArray;
220             Diamond.DiamondCutData memory cutData = Diamond.DiamondCutData({
221                 facetCuts: emptyArray,
222                 initAddress: genesisUpgrade,
223                 initCalldata: abi.encodeCall(IDefaultUpgrade.upgrade, (proposedUpgrade))
224             });
225     
226             IAdmin(_chainContract).executeUpgrade(cutData);
227             emit SetChainIdUpgrade(_chainContract, l2ProtocolUpgradeTx, protocolVersion);
228         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L177:228

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


73          function setStateTransitionManager(IStateTransitionManager _stateTransitionManager) external onlyOwner {
74              stateTransitionManager = _stateTransitionManager;
75          }


96          function setExecutionDelay(uint32 _executionDelay) external onlyOwner {
97              executionDelay = _executionDelay;
98              emit NewExecutionDelay(_executionDelay);
99          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L96:99

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


23          function setPendingAdmin(address _newPendingAdmin) external onlyAdmin {
24              // Save previous value into the stack to put it into the event later
25              address oldPendingAdmin = s.pendingAdmin;
26              // Change pending admin
27              s.pendingAdmin = _newPendingAdmin;
28              emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
29          }


45          function setValidator(address _validator, bool _active) external onlyStateTransitionManager {
46              s.validators[_validator] = _active;
47              emit ValidatorStatusUpdate(_validator, _active);
48          }


51          function setPorterAvailability(bool _zkPorterIsAvailable) external onlyStateTransitionManager {
52              // Change the porter availability
53              s.zkPorterIsAvailable = _zkPorterIsAvailable;
54              emit IsPorterAvailableStatusUpdate(_zkPorterIsAvailable);
55          }


58          function setPriorityTxMaxGasLimit(uint256 _newPriorityTxMaxGasLimit) external onlyStateTransitionManager {
59              require(_newPriorityTxMaxGasLimit <= MAX_GAS_PER_TRANSACTION, "n5");
60      
61              uint256 oldPriorityTxMaxGasLimit = s.priorityTxMaxGasLimit;
62              s.priorityTxMaxGasLimit = _newPriorityTxMaxGasLimit;
63              emit NewPriorityTxMaxGasLimit(oldPriorityTxMaxGasLimit, _newPriorityTxMaxGasLimit);
64          }


67          function changeFeeParams(FeeParams calldata _newFeeParams) external onlyAdminOrStateTransitionManager {
68              // Double checking that the new fee params are valid, i.e.
69              // the maximal pubdata per batch is not less than the maximal pubdata per priority transaction.
70              require(_newFeeParams.maxPubdataPerBatch >= _newFeeParams.priorityTxMaxPubdata, "n6");
71      
72              FeeParams memory oldFeeParams = s.feeParams;
73              s.feeParams = _newFeeParams;
74      
75              emit NewFeeParams(oldFeeParams, _newFeeParams);
76          }


79          function setTokenMultiplier(uint128 _nominator, uint128 _denominator) external onlyAdminOrStateTransitionManager {
80              uint128 oldNominator = s.baseTokenGasPriceMultiplierNominator;
81              uint128 oldDenominator = s.baseTokenGasPriceMultiplierDenominator;
82      
83              s.baseTokenGasPriceMultiplierNominator = _nominator;
84              s.baseTokenGasPriceMultiplierDenominator = _denominator;
85      
86              emit NewBaseTokenMultiplier(oldNominator, oldDenominator, _nominator, _denominator);
87          }


89          function setValidiumMode(PubdataPricingMode _validiumMode) external onlyAdmin {
90              require(s.totalBatchesCommitted == 0, "AdminFacet: set validium only after genesis"); // Validium mode can be set only before the first batch is committed
91              s.feeParams.pubdataPricingMode = _validiumMode;
92              emit ValidiumModeStatusUpdate(_validiumMode);
93          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L89:93

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


597         function _setBit(uint256 _bitMap, uint8 _index) internal pure returns (uint256) {
598             return _bitMap | (1 << _index);
599         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L597:599

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


34          function setImmutables(address _dest, ImmutableData[] calldata _immutables) external override {
35              require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract");
36              unchecked {
37                  uint256 immutablesLength = _immutables.length;
38                  for (uint256 i = 0; i < immutablesLength; ++i) {
39                      uint256 index = _immutables[i].index;
40                      bytes32 value = _immutables[i].value;
41                      immutableDataStorage[uint256(uint160(_dest))][index] = value;
42                  }
43              }
44          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L34:44

```solidity
File: system-contracts/contracts/NonceHolder.sol


82          function setValueUnderNonce(uint256 _key, uint256 _value) public onlySystemCall {
83              IContractDeployer.AccountInfo memory accountInfo = DEPLOYER_SYSTEM_CONTRACT.getAccountInfo(msg.sender);
84      
85              require(_value != 0, "Nonce value cannot be set to 0");
86              // If an account has sequential nonce ordering, we enforce that the previous
87              // nonce has already been used.
88              if (accountInfo.nonceOrdering == IContractDeployer.AccountNonceOrdering.Sequential && _key != 0) {
89                  require(isNonceUsed(msg.sender, _key - 1), "Previous nonce has not been used");
90              }
91      
92              uint256 addressAsKey = uint256(uint160(msg.sender));
93      
94              nonceValues[addressAsKey][_key] = _value;
95      
96              emit ValueSetUnderNonce(msg.sender, _key, _value);
97          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L82:97

```solidity
File: system-contracts/contracts/SystemContext.sol


84          function setChainId(uint256 _newChainId) external onlyCallFromForceDeployer {
85              chainId = _newChainId;
86          }


99          function setTxOrigin(address _newOrigin) external onlyCallFromBootloader {
100             origin = _newOrigin;
101         }


105         function setGasPrice(uint256 _gasPrice) external onlyCallFromBootloader {
106             gasPrice = _gasPrice;
107         }


112         function setPubdataInfo(uint256 _gasPerPubdataByte, uint256 _basePubdataSpent) external onlyCallFromBootloader {
113             basePubdataSpent = _basePubdataSpent;
114             gasPerPubdataByte = _gasPerPubdataByte;
115         }


212         function _setL2BlockHash(uint256 _block, bytes32 _hash) internal {
213             l2BlockHash[_block % MINIBLOCK_HASHES_TO_STORE] = _hash;
214         }


263         function _setVirtualBlock(
264             uint128 _l2BlockNumber,
265             uint128 _maxVirtualBlocksToCreate,
266             uint128 _newTimestamp
267         ) internal {
268             if (virtualBlockUpgradeInfo.virtualBlockFinishL2Block != 0) {
269                 // No need to to do anything about virtual blocks anymore
270                 // All the info is the same as for L2 blocks.
271                 currentVirtualL2BlockInfo = currentL2BlockInfo;
272                 return;
273             }
274     
275             BlockInfo memory virtualBlockInfo = currentVirtualL2BlockInfo;
276     
277             if (currentVirtualL2BlockInfo.number == 0 && virtualBlockInfo.timestamp == 0) {
278                 uint128 currentBatchNumber = currentBatchInfo.number;
279     
280                 // The virtual block is set for the first time. We can count it as 1 creation of a virtual block.
281                 // Note, that when setting the virtual block number we use the batch number to make a smoother upgrade from batch number to
282                 // the L2 block number.
283                 virtualBlockInfo.number = currentBatchNumber;
284                 // Remembering the batch number on which the upgrade to the virtual blocks has been done.
285                 virtualBlockUpgradeInfo.virtualBlockStartBatch = currentBatchNumber;
286     
287                 require(_maxVirtualBlocksToCreate > 0, "Can't initialize the first virtual block");
288                 _maxVirtualBlocksToCreate -= 1;
289             } else if (_maxVirtualBlocksToCreate == 0) {
290                 // The virtual blocks have been already initialized, but the operator didn't ask to create
291                 // any new virtual blocks. So we can just return.
292                 return;
293             }
294     
295             virtualBlockInfo.number += _maxVirtualBlocksToCreate;
296             virtualBlockInfo.timestamp = _newTimestamp;
297     
298             // The virtual block number must never exceed the L2 block number.
299             // We do not use a `require` here, since the virtual blocks are a temporary solution to let the Solidity's `block.number`
300             // catch up with the L2 block number and so the situation where virtualBlockInfo.number starts getting larger
301             // than _l2BlockNumber is expected once virtual blocks have caught up the L2 blocks.
302             if (virtualBlockInfo.number >= _l2BlockNumber) {
303                 virtualBlockUpgradeInfo.virtualBlockFinishL2Block = _l2BlockNumber;
304                 virtualBlockInfo.number = _l2BlockNumber;
305             }
306     
307             currentVirtualL2BlockInfo = virtualBlockInfo;
308         }


314         function _setNewL2BlockData(uint128 _l2BlockNumber, uint128 _l2BlockTimestamp, bytes32 _prevL2BlockHash) internal {
315             // In the unsafe version we do not check that the block data is correct
316             currentL2BlockInfo = BlockInfo({number: _l2BlockNumber, timestamp: _l2BlockTimestamp});
317     
318             // It is always assumed in production that _l2BlockNumber > 0
319             _setL2BlockHash(_l2BlockNumber - 1, _prevL2BlockHash);
320     
321             // Reseting the rolling hash
322             currentL2BlockTxsRollingHash = bytes32(0);
323         }


341         function setL2Block(
342             uint128 _l2BlockNumber,
343             uint128 _l2BlockTimestamp,
344             bytes32 _expectedPrevL2BlockHash,
345             bool _isFirstInBatch,
346             uint128 _maxVirtualBlocksToCreate
347         ) external onlyCallFromBootloader {
348             // We check that the timestamp of the L2 block is consistent with the timestamp of the batch.
349             if (_isFirstInBatch) {
350                 uint128 currentBatchTimestamp = currentBatchInfo.timestamp;
351                 require(
352                     _l2BlockTimestamp >= currentBatchTimestamp,
353                     "The timestamp of the L2 block must be greater than or equal to the timestamp of the current batch"
354                 );
355                 require(_maxVirtualBlocksToCreate > 0, "There must be a virtual block created at the start of the batch");
356             }
357     
358             (uint128 currentL2BlockNumber, uint128 currentL2BlockTimestamp) = getL2BlockNumberAndTimestamp();
359     
360             if (currentL2BlockNumber == 0 && currentL2BlockTimestamp == 0) {
361                 // Since currentL2BlockNumber and currentL2BlockTimestamp are zero it means that it is
362                 // the first ever batch with L2 blocks, so we need to initialize those.
363                 _upgradeL2Blocks(_l2BlockNumber, _expectedPrevL2BlockHash, _isFirstInBatch);
364     
365                 _setNewL2BlockData(_l2BlockNumber, _l2BlockTimestamp, _expectedPrevL2BlockHash);
366             } else if (currentL2BlockNumber == _l2BlockNumber) {
367                 require(!_isFirstInBatch, "Can not reuse L2 block number from the previous batch");
368                 require(currentL2BlockTimestamp == _l2BlockTimestamp, "The timestamp of the same L2 block must be same");
369                 require(
370                     _expectedPrevL2BlockHash == _getLatest257L2blockHash(_l2BlockNumber - 1),
371                     "The previous hash of the same L2 block must be same"
372                 );
373                 require(_maxVirtualBlocksToCreate == 0, "Can not create virtual blocks in the middle of the miniblock");
374             } else if (currentL2BlockNumber + 1 == _l2BlockNumber) {
375                 // From the checks in _upgradeL2Blocks it is known that currentL2BlockNumber can not be 0
376                 bytes32 prevL2BlockHash = _getLatest257L2blockHash(currentL2BlockNumber - 1);
377     
378                 bytes32 pendingL2BlockHash = _calculateL2BlockHash(
379                     currentL2BlockNumber,
380                     currentL2BlockTimestamp,
381                     prevL2BlockHash,
382                     currentL2BlockTxsRollingHash
383                 );
384     
385                 require(_expectedPrevL2BlockHash == pendingL2BlockHash, "The current L2 block hash is incorrect");
386                 require(
387                     _l2BlockTimestamp > currentL2BlockTimestamp,
388                     "The timestamp of the new L2 block must be greater than the timestamp of the previous L2 block"
389                 );
390     
391                 // Since the new block is created, we'll clear out the rolling hash
392                 _setNewL2BlockData(_l2BlockNumber, _l2BlockTimestamp, _expectedPrevL2BlockHash);
393             } else {
394                 revert("Invalid new L2 block number");
395             }
396     
397             _setVirtualBlock(_l2BlockNumber, _maxVirtualBlocksToCreate, _l2BlockTimestamp);
398         }


444         function setNewBatch(
445             bytes32 _prevBatchHash,
446             uint128 _newTimestamp,
447             uint128 _expectedNewNumber,
448             uint256 _baseFee
449         ) external onlyCallFromBootloader {
450             (uint128 previousBatchNumber, uint128 previousBatchTimestamp) = getBatchNumberAndTimestamp();
451             require(_newTimestamp > previousBatchTimestamp, "Timestamps should be incremental");
452             require(previousBatchNumber + 1 == _expectedNewNumber, "The provided block number is not correct");
453     
454             _ensureBatchConsistentWithL2Block(_newTimestamp);
455     
456             batchHashes[previousBatchNumber] = _prevBatchHash;
457     
458             // Setting new block number and timestamp
459             BlockInfo memory newBlockInfo = BlockInfo({number: previousBatchNumber + 1, timestamp: _newTimestamp});
460     
461             currentBatchInfo = newBlockInfo;
462     
463             baseFee = _baseFee;
464     
465             // The correctness of this block hash:
466             SystemContractHelper.toL1(false, bytes32(uint256(SystemLogKey.PREV_BATCH_HASH_KEY)), _prevBatchHash);
467         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L444:467

</details>

## NC069 - Consider splitting long calculations:

The longer a string of operations is, the harder it is to understand it. Consider splitting the full calculation into more steps, with more descriptive temporary variable names, and add extensive comments.


<details>
<summary>Click to show 6 findings</summary>

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


198                 uint256 listLength = encodedFixedLengthParams.length +
199                     encodedDataLength.length +
200                     _transaction.data.length +
201                     encodedAccessListLength.length +
202                     rEncoded.length +
203                     sEncoded.length +
204                     vEncoded.length;


105                 uint256 listLength = encodedNonce.length +
106                     encodedGasParam.length +
107                     encodedTo.length +
108                     encodedValue.length +
109                     encodedDataLength.length +
110                     _transaction.data.length +
111                     rEncoded.length +
112                     sEncoded.length +
113                     vEncoded.length;


293                 uint256 listLength = encodedFixedLengthParams.length +
294                     encodedDataLength.length +
295                     _transaction.data.length +
296                     encodedAccessListLength.length +
297                     rEncoded.length +
298                     sEncoded.length +
299                     vEncoded.length;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L293:299

```solidity
File: system-contracts/contracts/DefaultAccount.sol


143                 isSystemCall =
144                     selector == DEPLOYER_SYSTEM_CONTRACT.create.selector ||
145                     selector == DEPLOYER_SYSTEM_CONTRACT.create2.selector ||
146                     selector == DEPLOYER_SYSTEM_CONTRACT.createAccount.selector ||
147                     selector == DEPLOYER_SYSTEM_CONTRACT.create2Account.selector;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L143:147

```solidity
File: system-contracts/contracts/L1Messenger.sol


148             uint256 gasToPay = keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) +
149                 3 *
150                 keccakGasCost(64) +
151                 gasSpentOnMessageHashing +
152                 COMPUTATIONAL_PRICE_FOR_PUBDATA *
153                 pubdataLen;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L148:153

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


190                 uint256 listLength = encodedNonce.length +
191                     encodedGasParam.length +
192                     encodedTo.length +
193                     encodedValue.length +
194                     encodedDataLength.length +
195                     _transaction.data.length +
196                     encodedChainId.length;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L190:196

</details>

## NC070 - High cyclomatic complexity:

Consider breaking down these blocks into more manageable units, by splitting things into utility functions, by reducing nesting, and by using early returns.


```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


130         function _processL2Logs(
131             CommitBatchInfo calldata _newBatch,
132             bytes32 _expectedSystemContractUpgradeTxHash
133         ) internal pure returns (LogProcessingOutput memory logOutput) {
134             // Copy L2 to L1 logs into memory.
135             bytes memory emittedL2Logs = _newBatch.systemLogs;
136     
137             // Used as bitmap to set/check log processing happens exactly once.
138             // See SystemLogKey enum in Constants.sol for ordering.
139             uint256 processedLogs;
140     
141             // linear traversal of the logs
142             for (uint256 i = 0; i < emittedL2Logs.length; i = i.uncheckedAdd(L2_TO_L1_LOG_SERIALIZE_SIZE)) {
143                 // Extract the values to be compared to/used such as the log sender, key, and value
144                 (address logSender, ) = UnsafeBytes.readAddress(emittedL2Logs, i + L2_LOG_ADDRESS_OFFSET);
145                 (uint256 logKey, ) = UnsafeBytes.readUint256(emittedL2Logs, i + L2_LOG_KEY_OFFSET);
146                 (bytes32 logValue, ) = UnsafeBytes.readBytes32(emittedL2Logs, i + L2_LOG_VALUE_OFFSET);
147     
148                 // Ensure that the log hasn't been processed already
149                 require(!_checkBit(processedLogs, uint8(logKey)), "kp");
150                 processedLogs = _setBit(processedLogs, uint8(logKey));
151     
152                 // Need to check that each log was sent by the correct address.
153                 if (logKey == uint256(SystemLogKey.L2_TO_L1_LOGS_TREE_ROOT_KEY)) {
154                     require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "lm");
155                     logOutput.l2LogsTreeRoot = logValue;
156                 } else if (logKey == uint256(SystemLogKey.TOTAL_L2_TO_L1_PUBDATA_KEY)) {
157                     require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "ln");
158                     logOutput.pubdataHash = logValue;
159                 } else if (logKey == uint256(SystemLogKey.STATE_DIFF_HASH_KEY)) {
160                     require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "lb");
161                     logOutput.stateDiffHash = logValue;
162                 } else if (logKey == uint256(SystemLogKey.PACKED_BATCH_AND_L2_BLOCK_TIMESTAMP_KEY)) {
163                     require(logSender == L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR, "sc");
164                     logOutput.packedBatchAndL2BlockTimestamp = uint256(logValue);
165                 } else if (logKey == uint256(SystemLogKey.PREV_BATCH_HASH_KEY)) {
166                     require(logSender == L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR, "sv");
167                     logOutput.previousBatchHash = logValue;
168                 } else if (logKey == uint256(SystemLogKey.CHAINED_PRIORITY_TXN_HASH_KEY)) {
169                     require(logSender == L2_BOOTLOADER_ADDRESS, "bl");
170                     logOutput.chainedPriorityTxsHash = logValue;
171                 } else if (logKey == uint256(SystemLogKey.NUMBER_OF_LAYER_1_TXS_KEY)) {
172                     require(logSender == L2_BOOTLOADER_ADDRESS, "bk");
173                     logOutput.numberOfLayer1Txs = uint256(logValue);
174                 } else if (logKey == uint256(SystemLogKey.BLOB_ONE_HASH_KEY)) {
175                     require(logSender == L2_PUBDATA_CHUNK_PUBLISHER_ADDR, "pc");
176                     logOutput.blob1Hash = logValue;
177                 } else if (logKey == uint256(SystemLogKey.BLOB_TWO_HASH_KEY)) {
178                     require(logSender == L2_PUBDATA_CHUNK_PUBLISHER_ADDR, "pd");
179                     logOutput.blob2Hash = logValue;
180                 } else if (logKey == uint256(SystemLogKey.EXPECTED_SYSTEM_CONTRACT_UPGRADE_TX_HASH_KEY)) {
181                     require(logSender == L2_BOOTLOADER_ADDRESS, "bu");
182                     require(_expectedSystemContractUpgradeTxHash == logValue, "ut");
183                 } else {
184                     revert("ul");
185                 }
186             }
187     
188             // We only require 9 logs to be checked, the 10th is if we are expecting a protocol upgrade
189             // Without the protocol upgrade we expect 9 logs: 2^9 - 1 = 511
190             // With the protocol upgrade we expect 8 logs: 2^10 - 1 = 1023
191             if (_expectedSystemContractUpgradeTxHash == bytes32(0)) {
192                 require(processedLogs == 511, "b7");
193             } else {
194                 require(processedLogs == 1023, "b8");
195             }
196         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L130:196

## NC071 - Use of override is unnecessary:

Starting with Solidity version 0.8.8, using the override keyword when the function solely overrides an interface function, and the function doesn't exist in multiple base contracts, is unnecessary.


<details>
<summary>Click to show 54 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


    function bridgehubDeposit(
        uint256 _chainId,
        address _prevMsgSender,
        uint256, // l2Value, needed for Weth deposits in the future
        bytes calldata _data
    ) external payable override onlyBridgehub returns (L2TransactionRequestTwoBridgesInner memory request) {
        require(l2BridgeAddress[_chainId] != address(0), "ShB l2 bridge not deployed");

        (address _l1Token, uint256 _depositAmount, address _l2Receiver) = abi.decode(
            _data,
            (address, uint256, address)
        );
        require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported");
        require(bridgehub.baseToken(_chainId) != _l1Token, "ShB: baseToken deposit not supported");

        uint256 amount;
        if (_l1Token == ETH_TOKEN_ADDRESS) {
            amount = msg.value;
            require(_depositAmount == 0, "ShB wrong withdraw amount");
        } else {
            require(msg.value == 0, "ShB m.v > 0 for BH d.it 2");
            amount = _depositAmount;

            uint256 withdrawAmount = _depositFunds(_prevMsgSender, IERC20(_l1Token), _depositAmount);
            require(withdrawAmount == _depositAmount, "5T"); // The token has non-standard transfer logic
        }
        require(amount != 0, "6T"); // empty deposit amount

        bytes32 txDataHash = keccak256(abi.encode(_prevMsgSender, _l1Token, amount));
        if (!hyperbridgingEnabled[_chainId]) {
            chainBalance[_chainId][_l1Token] += amount;
        }

        {
            // Request the finalization of the deposit on the L2 side
            bytes memory l2TxCalldata = _getDepositL2Calldata(_prevMsgSender, _l2Receiver, _l1Token, amount);

            request = L2TransactionRequestTwoBridgesInner({
                magicValue: TWO_BRIDGES_MAGIC_VALUE,
                l2Contract: l2BridgeAddress[_chainId],
                l2Calldata: l2TxCalldata,
                factoryDeps: new bytes[](0),
                txDataHash: txDataHash
            });
        }
        emit BridgehubDepositInitiated(_chainId, txDataHash, _prevMsgSender, _l2Receiver, _l1Token, amount);
    }

    function bridgehubConfirmL2Transaction(
        uint256 _chainId,
        bytes32 _txDataHash,
        bytes32 _txHash
    ) external override onlyBridgehub {
        require(depositHappened[_chainId][_txHash] == 0x00, "ShB tx hap");
        depositHappened[_chainId][_txHash] = _txDataHash;
        emit BridgehubDepositFinalized(_chainId, _txDataHash, _txHash);
    }

    function claimFailedDeposit(
        uint256 _chainId,
        address _depositSender,
        address _l1Token,
        uint256 _amount,
        bytes32 _l2TxHash,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes32[] calldata _merkleProof
    ) external override {
        _claimFailedDeposit(
            false,
            _chainId,
            _depositSender,
            _l1Token,
            _amount,
            _l2TxHash,
            _l2BatchNumber,
            _l2MessageIndex,
            _l2TxNumberInBatch,
            _merkleProof
        );
    }

    function finalizeWithdrawal(
        uint256 _chainId,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external override {
        // To avoid rewithdrawing txs that have already happened on the legacy bridge.
        // Note: new withdraws are all recorded here, so double withdrawing them is not possible.
        if (_isEraLegacyWithdrawal(_chainId, _l2BatchNumber)) {
            require(!legacyBridge.isWithdrawalFinalized(_l2BatchNumber, _l2MessageIndex), "ShB: legacy withdrawal");
        }
        _finalizeWithdrawal(_chainId, _l2BatchNumber, _l2MessageIndex, _l2TxNumberInBatch, _message, _merkleProof);
    }

    function depositLegacyErc20Bridge(
        address _prevMsgSender,
        address _l2Receiver,
        address _l1Token,
        uint256 _amount,
        uint256 _l2TxGasLimit,
        uint256 _l2TxGasPerPubdataByte,
        address _refundRecipient
    ) external payable override onlyLegacyBridge nonReentrant returns (bytes32 l2TxHash) {
        require(l2BridgeAddress[ERA_CHAIN_ID] != address(0), "ShB b. n dep");
        require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported 2");

        // Note that funds have been transferred to this contract in the legacy ERC20 bridge.
        if (!hyperbridgingEnabled[ERA_CHAIN_ID]) {
            chainBalance[ERA_CHAIN_ID][_l1Token] += _amount;
        }

        bytes memory l2TxCalldata = _getDepositL2Calldata(_prevMsgSender, _l2Receiver, _l1Token, _amount);

        {
            // If the refund recipient is not specified, the refund will be sent to the sender of the transaction.
            // Otherwise, the refund will be sent to the specified address.
            // If the recipient is a contract on L1, the address alias will be applied.
            address refundRecipient = _refundRecipient;
            if (_refundRecipient == address(0)) {
                refundRecipient = _prevMsgSender != tx.origin
                    ? AddressAliasHelper.applyL1ToL2Alias(_prevMsgSender)
                    : _prevMsgSender;
            }

            L2TransactionRequestDirect memory request = L2TransactionRequestDirect({
                chainId: ERA_CHAIN_ID,
                l2Contract: l2BridgeAddress[ERA_CHAIN_ID],
                mintValue: msg.value, // l2 gas + l2 msg.Value the bridgehub will withdraw the mintValue from the base token bridge for gas
                l2Value: 0, // L2 msg.value, this contract doesn't support base token deposits or wrapping functionality, for direct deposits use bridgehub
                l2Calldata: l2TxCalldata,
                l2GasLimit: _l2TxGasLimit,
                l2GasPerPubdataByteLimit: _l2TxGasPerPubdataByte,
                factoryDeps: new bytes[](0),
                refundRecipient: refundRecipient
            });
            l2TxHash = bridgehub.requestL2TransactionDirect{value: msg.value}(request);
        }

        bytes32 txDataHash = keccak256(abi.encode(_prevMsgSender, _l1Token, _amount));
        // Save the deposited amount to claim funds on L1 if the deposit failed on L2
        depositHappened[ERA_CHAIN_ID][l2TxHash] = txDataHash;

        emit LegacyDepositInitiated(ERA_CHAIN_ID, l2TxHash, _prevMsgSender, _l2Receiver, _l1Token, _amount);
    }

    function finalizeWithdrawalLegacyErc20Bridge(
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes calldata _message,
        bytes32[] calldata _merkleProof
    ) external override onlyLegacyBridge returns (address l1Receiver, address l1Token, uint256 amount) {
        (l1Receiver, l1Token, amount) = _finalizeWithdrawal(
            ERA_CHAIN_ID,
            _l2BatchNumber,
            _l2MessageIndex,
            _l2TxNumberInBatch,
            _message,
            _merkleProof
        );
    }

    function claimFailedDepositLegacyErc20Bridge(
        address _depositSender,
        address _l1Token,
        uint256 _amount,
        bytes32 _l2TxHash,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes32[] calldata _merkleProof
    ) external override onlyLegacyBridge {
        _claimFailedDeposit(
            true,
            ERA_CHAIN_ID,
            _depositSender,
            _l1Token,
            _amount,
            _l2TxHash,
            _l2BatchNumber,
            _l2MessageIndex,
            _l2TxNumberInBatch,
            _merkleProof
        );
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L644:666

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


    function proveL2MessageInclusion(
        uint256 _chainId,
        uint256 _batchNumber,
        uint256 _index,
        L2Message calldata _message,
        bytes32[] calldata _proof
    ) external view override returns (bool) {
        address stateTransition = getStateTransition(_chainId);
        return IZkSyncStateTransition(stateTransition).proveL2MessageInclusion(_batchNumber, _index, _message, _proof);
    }

    function proveL2LogInclusion(
        uint256 _chainId,
        uint256 _batchNumber,
        uint256 _index,
        L2Log memory _log,
        bytes32[] calldata _proof
    ) external view override returns (bool) {
        address stateTransition = getStateTransition(_chainId);
        return IZkSyncStateTransition(stateTransition).proveL2LogInclusion(_batchNumber, _index, _log, _proof);
    }

    function proveL1ToL2TransactionStatus(
        uint256 _chainId,
        bytes32 _l2TxHash,
        uint256 _l2BatchNumber,
        uint256 _l2MessageIndex,
        uint16 _l2TxNumberInBatch,
        bytes32[] calldata _merkleProof,
        TxStatus _status
    ) external view override returns (bool) {
        address stateTransition = getStateTransition(_chainId);
        return
            IZkSyncStateTransition(stateTransition).proveL1ToL2TransactionStatus(
                _l2TxHash,
                _l2BatchNumber,
                _l2MessageIndex,
                _l2TxNumberInBatch,
                _merkleProof,
                _status
            );
    }

    function requestL2TransactionDirect(
        L2TransactionRequestDirect calldata _request
    ) external payable override nonReentrant returns (bytes32 canonicalTxHash) {
        {
            address token = baseToken[_request.chainId];
            if (token == ETH_TOKEN_ADDRESS) {
                require(msg.value == _request.mintValue, "Bridgehub: msg.value mismatch 1");
            } else {
                require(msg.value == 0, "Bridgehub: non-eth bridge with msg.value");
            }

            sharedBridge.bridgehubDepositBaseToken{value: msg.value}(
                _request.chainId,
                msg.sender,
                token,
                _request.mintValue
            );
        }

        address stateTransition = getStateTransition(_request.chainId);
        address refundRecipient = _actualRefundRecipient(_request.refundRecipient);
        canonicalTxHash = IZkSyncStateTransition(stateTransition).bridgehubRequestL2Transaction(
            BridgehubL2TransactionRequest({
                sender: msg.sender,
                contractL2: _request.l2Contract,
                mintValue: _request.mintValue,
                l2Value: _request.l2Value,
                l2Calldata: _request.l2Calldata,
                l2GasLimit: _request.l2GasLimit,
                l2GasPerPubdataByteLimit: _request.l2GasPerPubdataByteLimit,
                factoryDeps: _request.factoryDeps,
                refundRecipient: refundRecipient
            })
        );
    }

    function requestL2TransactionTwoBridges(
        L2TransactionRequestTwoBridgesOuter calldata _request
    ) external payable override nonReentrant returns (bytes32 canonicalTxHash) {
        {
            address token = baseToken[_request.chainId];
            uint256 baseTokenMsgValue;
            if (token == ETH_TOKEN_ADDRESS) {
                require(
                    msg.value == _request.mintValue + _request.secondBridgeValue,
                    "Bridgehub: msg.value mismatch 2"
                );
                baseTokenMsgValue = _request.mintValue;
            } else {
                require(msg.value == _request.secondBridgeValue, "Bridgehub: msg.value mismatch 3");
                baseTokenMsgValue = 0;
            }
            sharedBridge.bridgehubDepositBaseToken{value: baseTokenMsgValue}(
                _request.chainId,
                msg.sender,
                token,
                _request.mintValue
            );
        }

        address stateTransition = getStateTransition(_request.chainId);

        L2TransactionRequestTwoBridgesInner memory outputRequest = IL1SharedBridge(_request.secondBridgeAddress)
            .bridgehubDeposit{value: _request.secondBridgeValue}(
            _request.chainId,
            msg.sender,
            _request.l2Value,
            _request.secondBridgeCalldata
        );

        require(outputRequest.magicValue == TWO_BRIDGES_MAGIC_VALUE, "Bridgehub: magic value mismatch");

        address refundRecipient = _actualRefundRecipient(_request.refundRecipient);

        require(
            _request.secondBridgeAddress > BRIDGEHUB_MIN_SECOND_BRIDGE_ADDRESS,
            "Bridgehub: second bridge address too low"
        ); // to avoid calls to precompiles
        canonicalTxHash = IZkSyncStateTransition(stateTransition).bridgehubRequestL2Transaction(
            BridgehubL2TransactionRequest({
                sender: _request.secondBridgeAddress,
                contractL2: outputRequest.l2Contract,
                mintValue: _request.mintValue,
                l2Value: _request.l2Value,
                l2Calldata: outputRequest.l2Calldata,
                l2GasLimit: _request.l2GasLimit,
                l2GasPerPubdataByteLimit: _request.l2GasPerPubdataByteLimit,
                factoryDeps: outputRequest.factoryDeps,
                refundRecipient: refundRecipient
            })
        );

        IL1SharedBridge(_request.secondBridgeAddress).bridgehubConfirmL2Transaction(
            _request.chainId,
            outputRequest.txDataHash,
            canonicalTxHash
        );
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L262:323

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


    function getChainAdmin(uint256 _chainId) external view override returns (address) {
        return IZkSyncStateTransition(stateTransition[_chainId]).getAdmin();
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L74:76

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol


    function _setNewProtocolVersion(uint256 _newProtocolVersion) internal override {
        uint256 previousProtocolVersion = s.protocolVersion;
        require(
            // Genesis Upgrade difference: Note this is the only thing change > to >=
            _newProtocolVersion >= previousProtocolVersion,
            "New protocol version is not greater than the current one"
        );
        require(
            _newProtocolVersion - previousProtocolVersion <= MAX_ALLOWED_PROTOCOL_VERSION_DELTA,
            "Too big protocol version difference"
        );

        // If the previous upgrade had an L2 system upgrade transaction, we require that it is finalized.
        require(s.l2SystemContractsUpgradeTxHash == bytes32(0), "Previous upgrade has not been finalized");
        require(
            s.l2SystemContractsUpgradeBatchNumber == 0,
            "The batch number of the previous upgrade has not been cleaned"
        );

        s.protocolVersion = _newProtocolVersion;
        emit NewProtocolVersion(previousProtocolVersion, _newProtocolVersion);
    }

    function upgrade(ProposedUpgrade calldata _proposedUpgrade) public virtual override returns (bytes32) {
        // Note that due to commitment delay, the timestamp of the L2 upgrade batch may be earlier than the timestamp
        // of the L1 block at which the upgrade occurred. This means that using timestamp as a signifier of "upgraded"
        // on the L2 side would be inaccurate. The effects of this "back-dating" of L2 upgrade batches will be reduced
        // as the permitted delay window is reduced in the future.
        require(block.timestamp >= _proposedUpgrade.upgradeTimestamp, "Upgrade is not ready yet");

        _setNewProtocolVersion(_proposedUpgrade.newProtocolVersion);
        _upgradeL1Contract(_proposedUpgrade.l1ContractsUpgradeCalldata);
        _upgradeVerifier(_proposedUpgrade.verifier, _proposedUpgrade.verifierParams);
        _setBaseSystemContracts(_proposedUpgrade.bootloaderHash, _proposedUpgrade.defaultAccountHash);

        bytes32 txHash = _setL2SystemContractUpgrade(
            _proposedUpgrade.l2ProtocolUpgradeTx,
            _proposedUpgrade.factoryDeps,
            _proposedUpgrade.newProtocolVersion
        );

        _postUpgrade(_proposedUpgrade.postUpgradeCalldata);

        emit UpgradeComplete(_proposedUpgrade.newProtocolVersion, txHash, _proposedUpgrade);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L47:68

```solidity
File: contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol


    function upgrade(ProposedUpgrade calldata _proposedUpgrade) public override returns (bytes32) {
        super.upgrade(_proposedUpgrade);
        return Diamond.DIAMOND_INIT_SUCCESS_RETURN_VALUE;
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol#L13:16

```solidity
File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol


    function upgrade(ProposedUpgrade calldata _proposedUpgrade) public override returns (bytes32) {
        super.upgrade(_proposedUpgrade);
        return Diamond.DIAMOND_INIT_SUCCESS_RETURN_VALUE;
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L14:17

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


    function finalizeDeposit(
        address _l1Sender,
        address _l2Receiver,
        address _l1Token,
        uint256 _amount,
        bytes calldata _data
    ) external payable override {
        // Only the L1 bridge counterpart can initiate and finalize the deposit.
        require(
            AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1Bridge ||
                AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1LegacyBridge,
            "mq"
        );
        require(msg.value == 0, "Value should be 0 for ERC20 bridge");

        address expectedL2Token = l2TokenAddress(_l1Token);
        address currentL1Token = l1TokenAddress[expectedL2Token];
        if (currentL1Token == address(0)) {
            address deployedToken = _deployL2Token(_l1Token, _data);
            require(deployedToken == expectedL2Token, "mt");
            l1TokenAddress[expectedL2Token] = _l1Token;
        } else {
            require(currentL1Token == _l1Token, "gg"); // Double check that the expected value equal to real one
        }

        IL2StandardToken(expectedL2Token).bridgeMint(_l2Receiver, _amount);
        emit FinalizeDeposit(_l1Sender, _l2Receiver, expectedL2Token, _amount);
    }

    function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external override {
        require(_amount > 0, "Amount cannot be zero");

        IL2StandardToken(_l2Token).bridgeBurn(msg.sender, _amount);

        address l1Token = l1TokenAddress[_l2Token];
        require(l1Token != address(0), "yh");

        bytes memory message = _getL1WithdrawMessage(_l1Receiver, l1Token, _amount);
        L2ContractHelper.sendMessageToL1(message);

        emit WithdrawalInitiated(msg.sender, _l1Receiver, _l2Token, _amount);
    }

    function l2TokenAddress(address _l1Token) public view override returns (address) {
        bytes32 constructorInputHash = keccak256(abi.encode(address(l2TokenBeacon), ""));
        bytes32 salt = _getCreate2Salt(_l1Token);
        return
            L2ContractHelper.computeCreate2Address(address(this), salt, l2TokenProxyBytecodeHash, constructorInputHash);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L149:154

```solidity
File: system-contracts/contracts/L2BaseToken.sol


    function withdraw(address _l1Receiver) external payable override {
        uint256 amount = _burnMsgValue();

        // Send the L2 log, a user could use it as proof of the withdrawal
        bytes memory message = _getL1WithdrawMessage(_l1Receiver, amount);
        L1_MESSENGER_CONTRACT.sendToL1(message);

        emit Withdrawal(msg.sender, _l1Receiver, amount);
    }

    function name() external pure override returns (string memory) {
        return "Ether";
    }

    function symbol() external pure override returns (string memory) {
        return "ETH";
    }

    function decimals() external pure override returns (uint8) {
        return 18;
    }

    function transferFromTo(address _from, address _to, uint256 _amount) external override {
        require(
            msg.sender == MSG_VALUE_SYSTEM_CONTRACT ||
                msg.sender == address(DEPLOYER_SYSTEM_CONTRACT) ||
                msg.sender == BOOTLOADER_FORMAL_ADDRESS,
            "Only system contracts with special access can call this method"
        );

        uint256 fromBalance = balance[_from];
        require(fromBalance >= _amount, "Transfer amount exceeds balance");
        unchecked {
            balance[_from] = fromBalance - _amount;
            // Overflow not possible: the sum of all balances is capped by totalSupply, and the sum is preserved by
            // decrementing then incrementing.
            balance[_to] += _amount;
        }

        emit Transfer(_from, _to, _amount);
    }

    function balanceOf(uint256 _account) external view override returns (uint256) {
        return balance[address(uint160(_account))];
    }

    function mint(address _account, uint256 _amount) external override onlyCallFromBootloader {
        totalSupply += _amount;
        balance[_account] += _amount;
        emit Mint(_account, _amount);
    }

    function withdrawWithMessage(address _l1Receiver, bytes memory _additionalData) external payable override {
        uint256 amount = _burnMsgValue();

        // Send the L2 log, a user could use it as proof of the withdrawal
        bytes memory message = _getExtendedWithdrawMessage(_l1Receiver, amount, msg.sender, _additionalData);
        L1_MESSENGER_CONTRACT.sendToL1(message);

        emit WithdrawalWithMessage(msg.sender, _l1Receiver, amount, _additionalData);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L85:93

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


    function bridgeMint(address _to, uint256 _amount) external override onlyBridge {
        _mint(_to, _amount);
        emit BridgeMint(_to, _amount);
    }

    function bridgeBurn(address _from, uint256 _amount) external override onlyBridge {
        _burn(_from, _amount);
        emit BridgeBurn(_from, _amount);
    }

    function name() public view override returns (string memory) {
        // If method is not available, behave like a token that does not implement this method - revert on call.
        if (availableGetters.ignoreName) revert();
        return super.name();
    }

    function symbol() public view override returns (string memory) {
        // If method is not available, behave like a token that does not implement this method - revert on call.
        if (availableGetters.ignoreSymbol) revert();
        return super.symbol();
    }

    function decimals() public view override returns (uint8) {
        // If method is not available, behave like a token that does not implement this method - revert on call.
        if (availableGetters.ignoreDecimals) revert();
        return decimals_;
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L171:175

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


    function storeAccountConstructingCodeHash(address _address, bytes32 _hash) external override onlyDeployer {
        // Check that code hash corresponds to the deploying smart contract
        require(Utils.isContractConstructing(_hash), "Code hash is not for a contract on constructor");
        _storeCodeHash(_address, _hash);
    }

    function storeAccountConstructedCodeHash(address _address, bytes32 _hash) external override onlyDeployer {
        // Check that code hash corresponds to the deploying smart contract
        require(Utils.isContractConstructed(_hash), "Code hash is not for a constructed contract");
        _storeCodeHash(_address, _hash);
    }

    function markAccountCodeHashAsConstructed(address _address) external override onlyDeployer {
        bytes32 codeHash = getRawCodeHash(_address);

        require(Utils.isContractConstructing(codeHash), "Code hash is not for a contract on constructor");

        // Get the bytecode hash with "isConstructor" flag equal to false
        bytes32 constructedBytecodeHash = Utils.constructedBytecodeHash(codeHash);

        _storeCodeHash(_address, constructedBytecodeHash);
    }

    function getRawCodeHash(address _address) public view override returns (bytes32 codeHash) {
        uint256 addressAsKey = uint256(uint160(_address));

        assembly {
            codeHash := sload(addressAsKey)
        }
    }

    function getCodeHash(uint256 _input) external view override returns (bytes32) {
        // We consider the account bytecode hash of the last 20 bytes of the input, because
        // according to the spec "If EXTCODEHASH of A is X, then EXTCODEHASH of A + 2**160 is X".
        address account = address(uint160(_input));
        if (uint160(account) <= CURRENT_MAX_PRECOMPILE_ADDRESS) {
            return EMPTY_STRING_KECCAK;
        }

        bytes32 codeHash = getRawCodeHash(account);

        // The code hash is equal to the `keccak256("")` if the account is an EOA with at least one transaction.
        // Otherwise, the account is either deployed smart contract or an empty account,
        // for both cases the code hash is equal to the raw code hash.
        if (codeHash == 0x00 && NONCE_HOLDER_SYSTEM_CONTRACT.getRawNonce(account) > 0) {
            codeHash = EMPTY_STRING_KECCAK;
        }
        // The contract is still on the constructor, which means it is not deployed yet,
        // so set `keccak256("")` as a code hash. The EVM has the same behavior.
        else if (Utils.isContractConstructing(codeHash)) {
            codeHash = EMPTY_STRING_KECCAK;
        }

        return codeHash;
    }

    function getCodeSize(uint256 _input) external view override returns (uint256 codeSize) {
        // We consider the account bytecode size of the last 20 bytes of the input, because
        // according to the spec "If EXTCODESIZE of A is X, then EXTCODESIZE of A + 2**160 is X".
        address account = address(uint160(_input));
        bytes32 codeHash = getRawCodeHash(account);

        // If the contract is a default account or is on constructor the code size is zero,
        // otherwise extract the proper value for it from the bytecode hash.
        // NOTE: zero address and precompiles are a special case, they are contracts, but we
        // want to preserve EVM invariants (see EIP-1052 specification). That's why we automatically
        // return `0` length in the following cases:
        // - `codehash(0) == 0`
        // - `account` is a precompile.
        // - `account` is currently being constructed
        if (
            uint160(account) > CURRENT_MAX_PRECOMPILE_ADDRESS &&
            codeHash != 0x00 &&
            !Utils.isContractConstructing(codeHash)
        ) {
            codeSize = Utils.bytecodeLenInBytes(codeHash);
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L117:138

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


    function getTransactionHashes(
        Transaction calldata _transaction
    ) external view override returns (bytes32 txHash, bytes32 signedTxHash) {
        signedTxHash = _transaction.encodeHash();
        if (_transaction.txType == EIP_712_TX_TYPE) {
            txHash = keccak256(bytes.concat(signedTxHash, EfficientCall.keccak(_transaction.signature)));
        } else if (_transaction.txType == LEGACY_TX_TYPE) {
            txHash = encodeLegacyTransactionHash(_transaction);
        } else if (_transaction.txType == EIP_1559_TX_TYPE) {
            txHash = encodeEIP1559TransactionHash(_transaction);
        } else if (_transaction.txType == EIP_2930_TX_TYPE) {
            txHash = encodeEIP2930TransactionHash(_transaction);
        } else {
            revert("Unsupported tx type");
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L24:39

```solidity
File: system-contracts/contracts/ContractDeployer.sol


    function getNewAddressCreate2(
        address _sender,
        bytes32 _bytecodeHash,
        bytes32 _salt,
        bytes calldata _input
    ) public view override returns (address newAddress) {
        // No collision is possible with the Ethereum's CREATE2, since
        // the prefix begins with 0x20....
        bytes32 constructorInputHash = EfficientCall.keccak(_input);

        bytes32 hash = keccak256(
            bytes.concat(CREATE2_PREFIX, bytes32(uint256(uint160(_sender))), _salt, _bytecodeHash, constructorInputHash)
        );

        newAddress = address(uint160(uint256(hash)));
    }

    function getNewAddressCreate(
        address _sender,
        uint256 _senderNonce
    ) public pure override returns (address newAddress) {
        // No collision is possible with the Ethereum's CREATE, since
        // the prefix begins with 0x63....
        bytes32 hash = keccak256(
            bytes.concat(CREATE_PREFIX, bytes32(uint256(uint160(_sender))), bytes32(_senderNonce))
        );

        newAddress = address(uint160(uint256(hash)));
    }

    function create2(
        bytes32 _salt,
        bytes32 _bytecodeHash,
        bytes calldata _input
    ) external payable override returns (address) {
        return create2Account(_salt, _bytecodeHash, _input, AccountAbstractionVersion.None);
    }

    function create(
        bytes32 _salt,
        bytes32 _bytecodeHash,
        bytes calldata _input
    ) external payable override returns (address) {
        return createAccount(_salt, _bytecodeHash, _input, AccountAbstractionVersion.None);
    }

    function create2Account(
        bytes32 _salt,
        bytes32 _bytecodeHash,
        bytes calldata _input,
        AccountAbstractionVersion _aaVersion
    ) public payable override onlySystemCall returns (address) {
        NONCE_HOLDER_SYSTEM_CONTRACT.incrementDeploymentNonce(msg.sender);
        address newAddress = getNewAddressCreate2(msg.sender, _bytecodeHash, _salt, _input);

        _nonSystemDeployOnAddress(_bytecodeHash, newAddress, _aaVersion, _input);

        return newAddress;
    }

    function createAccount(
        bytes32, // salt
        bytes32 _bytecodeHash,
        bytes calldata _input,
        AccountAbstractionVersion _aaVersion
    ) public payable override onlySystemCall returns (address) {
        uint256 senderNonce = NONCE_HOLDER_SYSTEM_CONTRACT.incrementDeploymentNonce(msg.sender);
        address newAddress = getNewAddressCreate(msg.sender, senderNonce);

        _nonSystemDeployOnAddress(_bytecodeHash, newAddress, _aaVersion, _input);

        return newAddress;
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L182:194

```solidity
File: system-contracts/contracts/DefaultAccount.sol


    function validateTransaction(
        bytes32, // _txHash
        bytes32 _suggestedSignedHash,
        Transaction calldata _transaction
    ) external payable override ignoreNonBootloader ignoreInDelegateCall returns (bytes4 magic) {
        magic = _validateTransaction(_suggestedSignedHash, _transaction);
    }

    function executeTransaction(
        bytes32, // _txHash
        bytes32, // _suggestedSignedHash
        Transaction calldata _transaction
    ) external payable override ignoreNonBootloader ignoreInDelegateCall {
        _execute(_transaction);
    }

    function executeTransactionFromOutside(Transaction calldata _transaction) external payable override {
        // Behave the same as for fallback/receive, just execute nothing, returns nothing
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L125:127

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


    function getImmutable(address _dest, uint256 _index) external view override returns (bytes32) {
        return immutableDataStorage[uint256(uint160(_dest))][_index];
    }

    function setImmutables(address _dest, ImmutableData[] calldata _immutables) external override {
        require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract");
        unchecked {
            uint256 immutablesLength = _immutables.length;
            for (uint256 i = 0; i < immutablesLength; ++i) {
                uint256 index = _immutables[i].index;
                bytes32 value = _immutables[i].value;
                immutableDataStorage[uint256(uint160(_dest))][index] = value;
            }
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L34:44

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


    function getMarker(bytes32 _hash) public view override returns (uint256 marker) {
        assembly {
            marker := sload(_hash)
        }
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L65:69

```solidity
File: system-contracts/contracts/L1Messenger.sol


    function sendToL1(bytes calldata _message) external override returns (bytes32 hash) {
        uint256 gasBeforeMessageHashing = gasleft();
        hash = EfficientCall.keccak(_message);
        uint256 gasSpentOnMessageHashing = gasBeforeMessageHashing - gasleft();

        /// Store message record
        chainedMessagesHash = keccak256(abi.encode(chainedMessagesHash, hash));

        /// Store log record
        L2ToL1Log memory l2ToL1Log = L2ToL1Log({
            l2ShardId: 0,
            isService: true,
            txNumberInBlock: SYSTEM_CONTEXT_CONTRACT.txNumberInBlock(),
            sender: address(this),
            key: bytes32(uint256(uint160(msg.sender))),
            value: hash
        });
        _processL2ToL1Log(l2ToL1Log);

        // Get cost of one byte pubdata in gas from context.
        uint256 pubdataLen;
        unchecked {
            // 4 bytes used to encode the length of the message (see `publishPubdataAndClearState`)
            // L2_TO_L1_LOG_SERIALIZE_SIZE bytes used to encode L2ToL1Log
            pubdataLen = 4 + _message.length + L2_TO_L1_LOG_SERIALIZE_SIZE;
        }

        // We need to charge cost of hashing, as it will be used in `publishPubdataAndClearState`:
        // - keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) and keccakGasCost(64) when reconstructing L2ToL1Log
        // - keccakGasCost(64) and gasSpentOnMessageHashing when reconstructing Messages
        // - at most 1 time keccakGasCost(64) when building the Merkle tree (as merkle tree can contain
        // ~2*N nodes, where the first N nodes are leaves the hash of which is calculated on the previous step).
        uint256 gasToPay = keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) +
            3 *
            keccakGasCost(64) +
            gasSpentOnMessageHashing +
            COMPUTATIONAL_PRICE_FOR_PUBDATA *
            pubdataLen;
        SystemContractHelper.burnGas(Utils.safeCastToU32(gasToPay), uint32(pubdataLen));

        emit L1MessageSent(msg.sender, hash, _message);
    }

    function requestBytecodeL1Publication(
        bytes32 _bytecodeHash
    ) external override onlyCallFrom(address(KNOWN_CODE_STORAGE_CONTRACT)) {
        chainedL1BytecodesRevealDataHash = keccak256(abi.encode(chainedL1BytecodesRevealDataHash, _bytecodeHash));

        uint256 bytecodeLen = Utils.bytecodeLenInBytes(_bytecodeHash);

        uint256 pubdataLen;
        unchecked {
            // 4 bytes used to encode the length of the bytecode (see `publishPubdataAndClearState`)
            pubdataLen = 4 + bytecodeLen;
        }

        // We need to charge cost of hashing, as it will be used in `publishPubdataAndClearState`
        uint256 gasToPay = sha256GasCost(bytecodeLen) +
            keccakGasCost(64) +
            COMPUTATIONAL_PRICE_FOR_PUBDATA *
            pubdataLen;
        SystemContractHelper.burnGas(Utils.safeCastToU32(gasToPay), uint32(pubdataLen));

        emit BytecodeL1PublicationRequested(_bytecodeHash);
    }

```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L161:182

</details>

## NC072 - Non-`external`/`public` function names should begin with an underscore:

According to the Solidity Style Guide, non-`external`/`public` function names should begin with an underscore


<details>
<summary>Click to show 5 findings</summary>

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


44          function encodeLegacyTransactionHash(Transaction calldata _transaction) internal view returns (bytes32 txHash) {


139         function encodeEIP2930TransactionHash(Transaction calldata _transaction) internal view returns (bytes32) {


229         function encodeEIP1559TransactionHash(Transaction calldata _transaction) internal view returns (bytes32) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L229:229

```solidity
File: system-contracts/contracts/L1Messenger.sol


50          function keccakGasCost(uint256 _length) internal pure returns (uint256) {


61          function sha256GasCost(uint256 _length) internal pure returns (uint256) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L61:61

</details>

## NC073 - Unused import:

The identifier is imported but never used within the file


<details>
<summary>Click to show 38 findings</summary>

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


5       import {Diamond} from "./libraries/Diamond.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L5:5

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


19      import {REQUIRED_L2_GAS_PRICE_PER_PUBDATA, L2_TO_L1_LOG_SERIALIZE_SIZE, DEFAULT_L2_LOGS_TREE_ROOT_HASH, EMPTY_STRING_KECCAK, SYSTEM_UPGRADE_L2_TX_TYPE, ERA_DIAMOND_PROXY, ERA_CHAIN_ID} from "../common/Config.sol";


19      import {REQUIRED_L2_GAS_PRICE_PER_PUBDATA, L2_TO_L1_LOG_SERIALIZE_SIZE, DEFAULT_L2_LOGS_TREE_ROOT_HASH, EMPTY_STRING_KECCAK, SYSTEM_UPGRADE_L2_TX_TYPE, ERA_DIAMOND_PROXY, ERA_CHAIN_ID} from "../common/Config.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L19:19

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


7       import {FeeParams} from "./ZkSyncStateTransitionStorage.sol";


10      import {VerifierParams} from "../chain-interfaces/IVerifier.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L10:10

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol


6       import {PriorityQueue} from "../../state-transition/libraries/PriorityQueue.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol#L6:6

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


13      import {IZkSyncStateTransitionBase} from "../../chain-interfaces/IZkSyncStateTransitionBase.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L13:13

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


17      import {IZkSyncStateTransitionBase} from "../../chain-interfaces/IZkSyncStateTransitionBase.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L17:17

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


15      import {IZkSyncStateTransitionBase} from "../../chain-interfaces/IZkSyncStateTransitionBase.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L15:15

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


14      import {UnsafeBytes} from "../../../common/libraries/UnsafeBytes.sol";


19      import {L2_BOOTLOADER_ADDRESS, L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, L2_BASE_TOKEN_SYSTEM_CONTRACT_ADDR} from "../../../common/L2ContractAddresses.sol";


21      import {IBridgehub} from "../../../bridgehub/IBridgehub.sol";


25      import {IZkSyncStateTransitionBase} from "../../chain-interfaces/IZkSyncStateTransitionBase.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L25:25

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol


7       import {Diamond} from "../libraries/Diamond.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L7:7

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol


5       import {L2CanonicalTransaction} from "../../common/Messaging.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L5:5

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol


9       import {Verifier} from "../Verifier.sol";


10      import {VerifierParams} from "./IVerifier.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol#L10:10

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


6       import {IMailbox} from "../state-transition/chain-interfaces/IMailbox.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L6:6

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol


11      import {MAX_NEW_FACTORY_DEPS, SYSTEM_UPGRADE_L2_TX_TYPE, MAX_ALLOWED_PROTOCOL_VERSION_DELTA} from "../common/Config.sol";


11      import {MAX_NEW_FACTORY_DEPS, SYSTEM_UPGRADE_L2_TX_TYPE, MAX_ALLOWED_PROTOCOL_VERSION_DELTA} from "../common/Config.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L11:11

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


15      import {L2ContractHelper, DEPLOYER_SYSTEM_CONTRACT, L2_BASE_TOKEN_ADDRESS, IContractDeployer} from "../L2ContractHelper.sol";


17      import {ERA_CHAIN_ID, ERA_WETH_ADDRESS} from "../Config.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L17:17

```solidity
File: system-contracts/contracts/Compressor.sol


10      import {L1_MESSENGER_CONTRACT, INITIAL_WRITE_STARTING_POSITION, COMPRESSED_INITIAL_WRITE_SIZE, STATE_DIFF_ENTRY_SIZE, STATE_DIFF_ENUM_INDEX_OFFSET, STATE_DIFF_FINAL_VALUE_OFFSET, STATE_DIFF_DERIVED_KEY_OFFSET, DERIVED_KEY_LENGTH, VALUE_LENGTH, ENUM_INDEX_LENGTH, KNOWN_CODE_STORAGE_CONTRACT} from "./Constants.sol";


10      import {L1_MESSENGER_CONTRACT, INITIAL_WRITE_STARTING_POSITION, COMPRESSED_INITIAL_WRITE_SIZE, STATE_DIFF_ENTRY_SIZE, STATE_DIFF_ENUM_INDEX_OFFSET, STATE_DIFF_FINAL_VALUE_OFFSET, STATE_DIFF_DERIVED_KEY_OFFSET, DERIVED_KEY_LENGTH, VALUE_LENGTH, ENUM_INDEX_LENGTH, KNOWN_CODE_STORAGE_CONTRACT} from "./Constants.sol";


10      import {L1_MESSENGER_CONTRACT, INITIAL_WRITE_STARTING_POSITION, COMPRESSED_INITIAL_WRITE_SIZE, STATE_DIFF_ENTRY_SIZE, STATE_DIFF_ENUM_INDEX_OFFSET, STATE_DIFF_FINAL_VALUE_OFFSET, STATE_DIFF_DERIVED_KEY_OFFSET, DERIVED_KEY_LENGTH, VALUE_LENGTH, ENUM_INDEX_LENGTH, KNOWN_CODE_STORAGE_CONTRACT} from "./Constants.sol";


10      import {L1_MESSENGER_CONTRACT, INITIAL_WRITE_STARTING_POSITION, COMPRESSED_INITIAL_WRITE_SIZE, STATE_DIFF_ENTRY_SIZE, STATE_DIFF_ENUM_INDEX_OFFSET, STATE_DIFF_FINAL_VALUE_OFFSET, STATE_DIFF_DERIVED_KEY_OFFSET, DERIVED_KEY_LENGTH, VALUE_LENGTH, ENUM_INDEX_LENGTH, KNOWN_CODE_STORAGE_CONTRACT} from "./Constants.sol";


10      import {L1_MESSENGER_CONTRACT, INITIAL_WRITE_STARTING_POSITION, COMPRESSED_INITIAL_WRITE_SIZE, STATE_DIFF_ENTRY_SIZE, STATE_DIFF_ENUM_INDEX_OFFSET, STATE_DIFF_FINAL_VALUE_OFFSET, STATE_DIFF_DERIVED_KEY_OFFSET, DERIVED_KEY_LENGTH, VALUE_LENGTH, ENUM_INDEX_LENGTH, KNOWN_CODE_STORAGE_CONTRACT} from "./Constants.sol";


10      import {L1_MESSENGER_CONTRACT, INITIAL_WRITE_STARTING_POSITION, COMPRESSED_INITIAL_WRITE_SIZE, STATE_DIFF_ENTRY_SIZE, STATE_DIFF_ENUM_INDEX_OFFSET, STATE_DIFF_FINAL_VALUE_OFFSET, STATE_DIFF_DERIVED_KEY_OFFSET, DERIVED_KEY_LENGTH, VALUE_LENGTH, ENUM_INDEX_LENGTH, KNOWN_CODE_STORAGE_CONTRACT} from "./Constants.sol";


10      import {L1_MESSENGER_CONTRACT, INITIAL_WRITE_STARTING_POSITION, COMPRESSED_INITIAL_WRITE_SIZE, STATE_DIFF_ENTRY_SIZE, STATE_DIFF_ENUM_INDEX_OFFSET, STATE_DIFF_FINAL_VALUE_OFFSET, STATE_DIFF_DERIVED_KEY_OFFSET, DERIVED_KEY_LENGTH, VALUE_LENGTH, ENUM_INDEX_LENGTH, KNOWN_CODE_STORAGE_CONTRACT} from "./Constants.sol";


10      import {L1_MESSENGER_CONTRACT, INITIAL_WRITE_STARTING_POSITION, COMPRESSED_INITIAL_WRITE_SIZE, STATE_DIFF_ENTRY_SIZE, STATE_DIFF_ENUM_INDEX_OFFSET, STATE_DIFF_FINAL_VALUE_OFFSET, STATE_DIFF_DERIVED_KEY_OFFSET, DERIVED_KEY_LENGTH, VALUE_LENGTH, ENUM_INDEX_LENGTH, KNOWN_CODE_STORAGE_CONTRACT} from "./Constants.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L10:10

```solidity
File: system-contracts/contracts/ContractDeployer.sol


7       import {CREATE2_PREFIX, CREATE_PREFIX, NONCE_HOLDER_SYSTEM_CONTRACT, ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT, FORCE_DEPLOYER, MAX_SYSTEM_CONTRACT_ADDRESS, KNOWN_CODE_STORAGE_CONTRACT, BASE_TOKEN_SYSTEM_CONTRACT, IMMUTABLE_SIMULATOR_SYSTEM_CONTRACT, COMPLEX_UPGRADER_CONTRACT, KECCAK256_SYSTEM_CONTRACT} from "./Constants.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L7:7

```solidity
File: system-contracts/contracts/PubdataChunkPublisher.sol


7       import {EfficientCall} from "./libraries/EfficientCall.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L7:7

```solidity
File: system-contracts/contracts/libraries/SystemContractHelper.sol


7       import {SystemContractsCaller, CalldataForwardingMode, CALLFLAGS_CALL_ADDRESS, CODE_ADDRESS_CALL_ADDRESS, EVENT_WRITE_ADDRESS, EVENT_INITIALIZE_ADDRESS, GET_EXTRA_ABI_DATA_ADDRESS, LOAD_CALLDATA_INTO_ACTIVE_PTR_CALL_ADDRESS, META_CODE_SHARD_ID_OFFSET, META_CALLER_SHARD_ID_OFFSET, META_SHARD_ID_OFFSET, META_AUX_HEAP_SIZE_OFFSET, META_HEAP_SIZE_OFFSET, META_GAS_PER_PUBDATA_BYTE_OFFSET, MIMIC_CALL_BY_REF_CALL_ADDRESS, META_CALL_ADDRESS, MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT, PTR_CALLDATA_CALL_ADDRESS, PTR_ADD_INTO_ACTIVE_CALL_ADDRESS, PTR_SHRINK_INTO_ACTIVE_CALL_ADDRESS, PTR_PACK_INTO_ACTIVE_CALL_ADDRESS, RAW_FAR_CALL_BY_REF_CALL_ADDRESS, PRECOMPILE_CALL_ADDRESS, SET_CONTEXT_VALUE_CALL_ADDRESS, SYSTEM_CALL_BY_REF_CALL_ADDRESS, TO_L1_CALL_ADDRESS} from "./SystemContractsCaller.sol";


7       import {SystemContractsCaller, CalldataForwardingMode, CALLFLAGS_CALL_ADDRESS, CODE_ADDRESS_CALL_ADDRESS, EVENT_WRITE_ADDRESS, EVENT_INITIALIZE_ADDRESS, GET_EXTRA_ABI_DATA_ADDRESS, LOAD_CALLDATA_INTO_ACTIVE_PTR_CALL_ADDRESS, META_CODE_SHARD_ID_OFFSET, META_CALLER_SHARD_ID_OFFSET, META_SHARD_ID_OFFSET, META_AUX_HEAP_SIZE_OFFSET, META_HEAP_SIZE_OFFSET, META_GAS_PER_PUBDATA_BYTE_OFFSET, MIMIC_CALL_BY_REF_CALL_ADDRESS, META_CALL_ADDRESS, MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT, PTR_CALLDATA_CALL_ADDRESS, PTR_ADD_INTO_ACTIVE_CALL_ADDRESS, PTR_SHRINK_INTO_ACTIVE_CALL_ADDRESS, PTR_PACK_INTO_ACTIVE_CALL_ADDRESS, RAW_FAR_CALL_BY_REF_CALL_ADDRESS, PRECOMPILE_CALL_ADDRESS, SET_CONTEXT_VALUE_CALL_ADDRESS, SYSTEM_CALL_BY_REF_CALL_ADDRESS, TO_L1_CALL_ADDRESS} from "./SystemContractsCaller.sol";


7       import {SystemContractsCaller, CalldataForwardingMode, CALLFLAGS_CALL_ADDRESS, CODE_ADDRESS_CALL_ADDRESS, EVENT_WRITE_ADDRESS, EVENT_INITIALIZE_ADDRESS, GET_EXTRA_ABI_DATA_ADDRESS, LOAD_CALLDATA_INTO_ACTIVE_PTR_CALL_ADDRESS, META_CODE_SHARD_ID_OFFSET, META_CALLER_SHARD_ID_OFFSET, META_SHARD_ID_OFFSET, META_AUX_HEAP_SIZE_OFFSET, META_HEAP_SIZE_OFFSET, META_GAS_PER_PUBDATA_BYTE_OFFSET, MIMIC_CALL_BY_REF_CALL_ADDRESS, META_CALL_ADDRESS, MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT, PTR_CALLDATA_CALL_ADDRESS, PTR_ADD_INTO_ACTIVE_CALL_ADDRESS, PTR_SHRINK_INTO_ACTIVE_CALL_ADDRESS, PTR_PACK_INTO_ACTIVE_CALL_ADDRESS, RAW_FAR_CALL_BY_REF_CALL_ADDRESS, PRECOMPILE_CALL_ADDRESS, SET_CONTEXT_VALUE_CALL_ADDRESS, SYSTEM_CALL_BY_REF_CALL_ADDRESS, TO_L1_CALL_ADDRESS} from "./SystemContractsCaller.sol";


7       import {SystemContractsCaller, CalldataForwardingMode, CALLFLAGS_CALL_ADDRESS, CODE_ADDRESS_CALL_ADDRESS, EVENT_WRITE_ADDRESS, EVENT_INITIALIZE_ADDRESS, GET_EXTRA_ABI_DATA_ADDRESS, LOAD_CALLDATA_INTO_ACTIVE_PTR_CALL_ADDRESS, META_CODE_SHARD_ID_OFFSET, META_CALLER_SHARD_ID_OFFSET, META_SHARD_ID_OFFSET, META_AUX_HEAP_SIZE_OFFSET, META_HEAP_SIZE_OFFSET, META_GAS_PER_PUBDATA_BYTE_OFFSET, MIMIC_CALL_BY_REF_CALL_ADDRESS, META_CALL_ADDRESS, MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT, PTR_CALLDATA_CALL_ADDRESS, PTR_ADD_INTO_ACTIVE_CALL_ADDRESS, PTR_SHRINK_INTO_ACTIVE_CALL_ADDRESS, PTR_PACK_INTO_ACTIVE_CALL_ADDRESS, RAW_FAR_CALL_BY_REF_CALL_ADDRESS, PRECOMPILE_CALL_ADDRESS, SET_CONTEXT_VALUE_CALL_ADDRESS, SYSTEM_CALL_BY_REF_CALL_ADDRESS, TO_L1_CALL_ADDRESS} from "./SystemContractsCaller.sol";


7       import {SystemContractsCaller, CalldataForwardingMode, CALLFLAGS_CALL_ADDRESS, CODE_ADDRESS_CALL_ADDRESS, EVENT_WRITE_ADDRESS, EVENT_INITIALIZE_ADDRESS, GET_EXTRA_ABI_DATA_ADDRESS, LOAD_CALLDATA_INTO_ACTIVE_PTR_CALL_ADDRESS, META_CODE_SHARD_ID_OFFSET, META_CALLER_SHARD_ID_OFFSET, META_SHARD_ID_OFFSET, META_AUX_HEAP_SIZE_OFFSET, META_HEAP_SIZE_OFFSET, META_GAS_PER_PUBDATA_BYTE_OFFSET, MIMIC_CALL_BY_REF_CALL_ADDRESS, META_CALL_ADDRESS, MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT, PTR_CALLDATA_CALL_ADDRESS, PTR_ADD_INTO_ACTIVE_CALL_ADDRESS, PTR_SHRINK_INTO_ACTIVE_CALL_ADDRESS, PTR_PACK_INTO_ACTIVE_CALL_ADDRESS, RAW_FAR_CALL_BY_REF_CALL_ADDRESS, PRECOMPILE_CALL_ADDRESS, SET_CONTEXT_VALUE_CALL_ADDRESS, SYSTEM_CALL_BY_REF_CALL_ADDRESS, TO_L1_CALL_ADDRESS} from "./SystemContractsCaller.sol";


7       import {SystemContractsCaller, CalldataForwardingMode, CALLFLAGS_CALL_ADDRESS, CODE_ADDRESS_CALL_ADDRESS, EVENT_WRITE_ADDRESS, EVENT_INITIALIZE_ADDRESS, GET_EXTRA_ABI_DATA_ADDRESS, LOAD_CALLDATA_INTO_ACTIVE_PTR_CALL_ADDRESS, META_CODE_SHARD_ID_OFFSET, META_CALLER_SHARD_ID_OFFSET, META_SHARD_ID_OFFSET, META_AUX_HEAP_SIZE_OFFSET, META_HEAP_SIZE_OFFSET, META_GAS_PER_PUBDATA_BYTE_OFFSET, MIMIC_CALL_BY_REF_CALL_ADDRESS, META_CALL_ADDRESS, MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT, PTR_CALLDATA_CALL_ADDRESS, PTR_ADD_INTO_ACTIVE_CALL_ADDRESS, PTR_SHRINK_INTO_ACTIVE_CALL_ADDRESS, PTR_PACK_INTO_ACTIVE_CALL_ADDRESS, RAW_FAR_CALL_BY_REF_CALL_ADDRESS, PRECOMPILE_CALL_ADDRESS, SET_CONTEXT_VALUE_CALL_ADDRESS, SYSTEM_CALL_BY_REF_CALL_ADDRESS, TO_L1_CALL_ADDRESS} from "./SystemContractsCaller.sol";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L7:7

</details>


## NC074 - State variable declarations should have Natspec @dev annotations:

Explain to a developer any extra details


<details>
<summary>Click to show 48 findings</summary>

```solidity
File: contracts/GasBoundCaller.sol


18          uint256 constant CALL_ENTRY_OVERHEAD = 800;


21          uint256 constant CALL_RETURN_OVERHEAD = 200;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L21:21

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


18          IL1SharedBridge public sharedBridge;


21          mapping(address _stateTransitionManager => bool) public stateTransitionManagerIsRegistered;


23          mapping(address _token => bool) public tokenIsRegistered;


26          mapping(uint256 _chainId => address) public stateTransitionManager;


29          mapping(uint256 _chainId => address) public baseToken;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L29:29

```solidity
File: contracts/ethereum/contracts/common/ReentrancyGuard.sol


38          uint256 private constant _NOT_ENTERED = 1;


39          uint256 private constant _ENTERED = 2;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L39:39

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


22          uint256 internal constant EXECUTED_PROPOSAL_TIMESTAMP = uint256(1);


35          uint256 public minDelay;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L35:35

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


27          address public immutable bridgehub;


30          mapping(uint256 => address) public stateTransition;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L30:30

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


20          string public constant override getName = "AdminFacet";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


27          string public constant override getName = "ExecutorFacet";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L27:27

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


25          string public constant override getName = "GettersFacet";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L25:25

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


35          string public constant override getName = "MailboxFacet";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L35:35

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol


12          ZkSyncStateTransitionStorage internal s;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L12:12

```solidity
File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol


22          uint160 constant offset = uint160(0x1111000000000000000000000000000000001111);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L22:22

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


37          address private l1LegacyBridge;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L37:37

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


26          ERC20Getters private availableGetters;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L26:26

```solidity
File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol


22          uint160 constant offset = uint160(0x1111000000000000000000000000000000001111);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L22:22

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


23          bytes32 constant EMPTY_STRING_KECCAK = 0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L23:23

```solidity
File: system-contracts/contracts/L1Messenger.sol


44          uint256 internal constant KECCAK_ROUND_GAS_COST = 40;


47          uint256 internal constant KECCAK_ROUND_NUMBER_OF_BYTES = 136;


55          uint256 internal constant SHA256_ROUND_GAS_COST = 7;


58          uint256 internal constant SHA256_ROUND_NUMBER_OF_BYTES = 64;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L58:58

```solidity
File: system-contracts/contracts/L2BaseToken.sol


20          mapping(address account => uint256 balance) internal balance;


23          uint256 public override totalSupply;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L23:23

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


36          uint256 constant GAS_TO_PASS = 2300;


41          uint256 constant MSG_VALUE_SIMULATOR_STIPEND_GAS = 27000;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L41:41

```solidity
File: system-contracts/contracts/NonceHolder.sol


28          uint256 private constant DEPLOY_NONCE_MULTIPLIER = 2 ** 128;


31          uint256 private constant MAXIMAL_MIN_NONCE_INCREMENT = 2 ** 32;


36          mapping(uint256 account => uint256 packedMinAndDeploymentNonce) internal rawNonces;


41          mapping(uint256 account => mapping(uint256 nonceKey => uint256 value)) internal nonceValues;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L41:41

```solidity
File: system-contracts/contracts/SystemContext.sol


26          uint256 public chainId;


37          uint256 public blockGasLimit = type(uint32).max;


44          uint256 public difficulty = 2.5e15;


51          BlockInfo internal currentBatchInfo;


58          BlockInfo internal currentL2BlockInfo;


61          bytes32 internal currentL2BlockTxsRollingHash;


77          BlockInfo internal currentVirtualL2BlockInfo;


80          VirtualBlockUpgradeInfo internal virtualBlockUpgradeInfo;


89          uint16 public txNumberInBlock;


92          uint256 public gasPerPubdataByte;


95          uint256 internal basePubdataSpent;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L95:95

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


82          bytes32 constant EIP712_DOMAIN_TYPEHASH = keccak256("EIP712Domain(string name,string version,uint256 chainId)");


84          bytes32 constant EIP712_TRANSACTION_TYPE_HASH =


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L84:84

</details>


## NC075 - Unused function parameter:

Comment out the variable name to suppress compiler warnings.


```solidity
File: system-contracts/contracts/DefaultAccount.sol


125         function executeTransactionFromOutside(Transaction calldata _transaction) external payable override {
126             // Behave the same as for fallback/receive, just execute nothing, returns nothing
127         }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L125:127

## NC076 - Put all system-wide constants in one file:

Putting all the system-wide constants in a single file improves code readability, makes it easier to understand the basic configuration and limitations of the system, and makes maintenance easier.


<details>
<summary>Click to show 5 findings</summary>

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


26          string public constant override getName = "ValidatorTimelock";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L26:26

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


20          string public constant override getName = "AdminFacet";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


27          string public constant override getName = "ExecutorFacet";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L27:27

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


25          string public constant override getName = "GettersFacet";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L25:25

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


35          string public constant override getName = "MailboxFacet";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L35:35

</details>

## NC077 - Add inline comments for unnamed variables:

`function foo(address x, address)` -> `function foo(address x, address /* y */)`


<details>
<summary>Click to show 13 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


182         function bridgehubDeposit(
183             uint256 _chainId,
184             address _prevMsgSender,
185             uint256, // l2Value, needed for Weth deposits in the future
186             bytes calldata _data
187         ) external payable override onlyBridgehub returns (L2TransactionRequestTwoBridgesInner memory request) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L182:187

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


114         function createNewChain(
115             uint256 _chainId,
116             address _stateTransitionManager,
117             address _baseToken,
118             uint256, //_salt
119             address _admin,
120             bytes calldata _initData
121         ) external onlyOwnerOrAdmin nonReentrant returns (uint256 chainId) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L114:121

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


153         function revertBatchesSharedBridge(uint256 _chainId, uint256) external onlyValidator(_chainId) {


146         function revertBatches(uint256) external onlyValidator(ERA_CHAIN_ID) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L146:146

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


477         function revertBatchesSharedBridge(uint256, uint256 _newLastBatch) external nonReentrant onlyValidator {


337         function executeBatchesSharedBridge(
338             uint256,
339             StoredBatchInfo[] calldata _batchesData
340         ) external nonReentrant onlyValidator {


207         function commitBatchesSharedBridge(
208             uint256, // _chainId
209             StoredBatchInfo memory _lastCommittedBatchData,
210             CommitBatchInfo[] calldata _newBatchesData
211         ) external nonReentrant onlyValidator {


377         function proveBatchesSharedBridge(
378             uint256, // _chainId
379             StoredBatchInfo calldata _prevBatch,
380             StoredBatchInfo[] calldata _committedBatches,
381             ProofInput calldata _proof
382         ) external nonReentrant onlyValidator {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L377:382

```solidity
File: system-contracts/contracts/ContractDeployer.sol


182         function createAccount(
183             bytes32, // salt
184             bytes32 _bytecodeHash,
185             bytes calldata _input,
186             AccountAbstractionVersion _aaVersion
187         ) public payable override onlySystemCall returns (address) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L182:187

```solidity
File: system-contracts/contracts/DefaultAccount.sol


67          function validateTransaction(
68              bytes32, // _txHash
69              bytes32 _suggestedSignedHash,
70              Transaction calldata _transaction
71          ) external payable override ignoreNonBootloader ignoreInDelegateCall returns (bytes4 magic) {


212         function prepareForPaymaster(
213             bytes32, // _txHash
214             bytes32, // _suggestedSignedHash
215             Transaction calldata _transaction
216         ) external payable ignoreNonBootloader ignoreInDelegateCall {


112         function executeTransaction(
113             bytes32, // _txHash
114             bytes32, // _suggestedSignedHash
115             Transaction calldata _transaction
116         ) external payable override ignoreNonBootloader ignoreInDelegateCall {


196         function payForTransaction(
197             bytes32, // _txHash
198             bytes32, // _suggestedSignedHash
199             Transaction calldata _transaction
200         ) external payable ignoreNonBootloader ignoreInDelegateCall {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L196:200

</details>

## NC078 - Consider adding emergency-stop functionality:

Adding a way to quickly halt protocol functionality in an emergency, rather than having to pause individual contracts one-by-one, will make in-progress hack mitigation faster and much less stressful.


<details>
<summary>Click to show 5 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


30      contract L1SharedBridge is IL1SharedBridge, ReentrancyGuard, Initializable, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L30:30

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


16      contract Bridgehub is IBridgehub, ReentrancyGuard, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L16:16

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


20      contract Governance is IGovernance, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


25      contract StateTransitionManager is IStateTransitionManager, ReentrancyGuard, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L25:25

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


22      contract ValidatorTimelock is IExecutor, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L22:22

</details>

## NC079 - Named imports of parent contracts are missing:




<details>
<summary>Click to show 4 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


16      contract Bridgehub is IBridgehub, ReentrancyGuard, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L16:16

```solidity
File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol


11      contract GenesisUpgrade is BaseZkSyncUpgradeGenesis {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L11:11

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


22      contract AccountCodeStorage is IAccountCodeStorage {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L22:22

```solidity
File: system-contracts/contracts/DefaultAccount.sol


19      contract DefaultAccount is IAccount {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L19:19

</details>

## NC080 - Use `bytes.concat()` on bytes instead of `abi.encodePacked()` for clearer semantic meaning:

Starting with version 0.8.4, Solidity has the `bytes.concat()` function, which allows one to concatenate a list of bytes/strings, without extra padding. Using this function rather than `abi.encodePacked()` makes the intended operation more clear, leading to less reviewer confusion.


<details>
<summary>Click to show 5 findings</summary>

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


517                 abi.encodePacked(
518                     _batch.indexRepeatedStorageChanges,
519                     _batch.newStateRoot,
520                     uint64(0), // index repeated storage changes in zkPorter
521                     bytes32(0) // zkPorter batch hash
522                 );


528                 abi.encodePacked(
529                     s.zkPorterIsAvailable,
530                     s.l2BootloaderBytecodeHash,
531                     l2DefaultAccountBytecodeHash,
532                     // VM 1.5.0 requires us to pass the EVM simulator code hash. For now it is the same as the default account.
533                     l2DefaultAccountBytecodeHash
534                 );


610             bytes memory precompileInput = abi.encodePacked(_versionedHash, _openingPoint, _openingValueCommitmentProof);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L610:610

```solidity
File: system-contracts/contracts/L2BaseToken.sol


123             return abi.encodePacked(IMailbox.finalizeEthWithdrawal.selector, _to, _amount, _sender, _additionalData);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L123:123

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


142             return keccak256(abi.encodePacked("\x19\x01", domainSeparator, structHash));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L142:142

</details>

## NC081 - Consider using `SafeTransferLib.safeTransferETH()` or `Address.sendValue()` for clearer semantic meaning:

These Functions indicate their purpose with their name more clearly than using low-level calls.


```solidity
File: contracts/GasBoundCaller.sol


57              bytes memory returnData = EfficientCall.call(gasleft(), _to, msg.value, _data, false);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L57:57

## NC082 - Style guide: State and local variables should be named using lowerCamelCase:

The Solidity style guide says to use mixedCase for local and state variable names. Note that while OpenZeppelin may not follow this advice, it still is the recommended way of naming variables.


```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


45          mapping(address => uint256) private __DEPRECATED_lastWithdrawalLimitReset;


48          mapping(address => uint256) private __DEPRECATED_withdrawnAmountInWindow;


51          mapping(address => mapping(address => uint256)) private __DEPRECATED_totalDepositedAmountPerUser;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L51:51

## NC083 - Pure function accesses storage:

While the compiler currently flags functions like these as being pure, this is a bug which will be fixed in a future version, so it's best to not use pure visibility, in order to not break when this bug is fixed.


```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


87          function getDiamondStorage() internal pure returns (DiamondStorage storage diamondStorage) {
88              bytes32 position = DIAMOND_STORAGE_POSITION;
89              assembly {
90                  diamondStorage.slot := position
91              }
92          }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L87:92

## NC084 - Unnecessary cast:

The variable is being cast to its own type


<details>
<summary>Click to show 5 findings</summary>

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


266                 bytes32(uint256(protocolVersion)),


271                 bytes32(storedBatchZero),


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L271:271

```solidity
File: system-contracts/contracts/Compressor.sol


252             number = uint256(bytes32(_calldataSlice));


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L252:252

```solidity
File: system-contracts/contracts/libraries/EfficientCall.sol


39              return bytes32(returnData);


48              return bytes32(returnData);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L48:48

</details>

## NC085 - Unusual loop variable:

The normal name for loop variables is i, and when there is a nested loop, to use j. Not following this convention may lead to some reviewer confusion.


```solidity
File: system-contracts/contracts/Compressor.sol


61                  for (uint256 encodedDataPointer = 0; encodedDataPointer < encodedData.length; encodedDataPointer += 2) {
62                      uint256 indexOfEncodedChunk = uint256(encodedData.readUint16(encodedDataPointer)) * 8;
63                      require(indexOfEncodedChunk < dictionary.length, "Encoded chunk index is out of bounds");
64      
65                      uint64 encodedChunk = dictionary.readUint64(indexOfEncodedChunk);
66                      uint64 realChunk = _bytecode.readUint64(encodedDataPointer * 4);
67      
68                      require(encodedChunk == realChunk, "Encoded chunk does not match the original bytecode");
69                  }


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L61:69

## NC086 - Use the latest solidity (prior to 0.8.20 if on L2s) for deployment:

Since deployed contracts should not use floating pragmas, I've flagged all instances where a version prior to 0.8.19 is allowed by the version pragma


```solidity
File: contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol


2       pragma solidity ^0.8.0;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol#L2:2

## NC087 - Events should use parameters to convey information:

For example, rather than using event Paused() and event Unpaused(), use event PauseState(address indexed whoChangedIt, bool wasPaused, bool isNowPaused)


```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


139             emit Freeze();


149             emit Unfreeze();


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L149:149


## NC088 - State variable declarations should have Natspec @notice annotations:

Explain to an end user what this does


<details>
<summary>Click to show 67 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


23          IL1SharedBridge public immutable override sharedBridge;


27          mapping(uint256 l2BatchNumber => mapping(uint256 l2ToL1MessageNumber => bool isFinalized))


32          mapping(address account => mapping(address l1Token => mapping(bytes32 depositL2TxHash => uint256 amount)))


36          address public l2Bridge;


39          address public l2TokenBeacon;


42          bytes32 public l2TokenProxyBytecodeHash;


45          mapping(address => uint256) private __DEPRECATED_lastWithdrawalLimitReset;


48          mapping(address => uint256) private __DEPRECATED_withdrawnAmountInWindow;


51          mapping(address => mapping(address => uint256)) private __DEPRECATED_totalDepositedAmountPerUser;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L51:51

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


34          address public immutable override l1WethAddress;


37          IBridgehub public immutable override bridgehub;


40          IL1ERC20Bridge public immutable override legacyBridge;


45          uint256 internal eraFirstPostUpgradeBatch;


48          mapping(uint256 chainId => address l2Bridge) public override l2BridgeAddress;


52          mapping(uint256 chainId => mapping(bytes32 l2DepositTxHash => bytes32 depositDataHash))


57          mapping(uint256 chainId => mapping(uint256 l2BatchNumber => mapping(uint256 l2ToL1MessageNumber => bool isFinalized)))


61          mapping(uint256 chainId => bool enabled) internal hyperbridgingEnabled;


65          mapping(uint256 chainId => mapping(address l1Token => uint256 balance)) internal chainBalance;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L65:65

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


32          address public admin;


35          address private pendingAdmin;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L35:35

```solidity
File: contracts/ethereum/contracts/common/ReentrancyGuard.sol


29          uint256 private constant LOCK_FLAG_ADDRESS = 0x8e94fed44239eb2314ab7a406345e6c5a8f0ccedf3b600de3d004e672c33abf4;


38          uint256 private constant _NOT_ENTERED = 1;


39          uint256 private constant _ENTERED = 2;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L39:39

```solidity
File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol


12          bytes32 private constant CREATE2_PREFIX = keccak256("zksyncCreate2");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L12:12

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


33          bytes32 public storedBatchZero;


36          bytes32 public initialCutHash;


39          address public genesisUpgrade;


42          uint256 public protocolVersion;


45          address public validatorTimelock;


48          mapping(uint256 => bytes32) public upgradeCutHash;


51          address public admin;


54          address private pendingAdmin;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L54:54

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


26          string public constant override getName = "ValidatorTimelock";


44          IStateTransitionManager public stateTransitionManager;


47          mapping(uint256 => LibMap.Uint32Map) internal committedBatchTimestamp;


50          mapping(uint256 _chainId => mapping(address _validator => bool)) public validators;


53          uint32 public executionDelay;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L53:53

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


20          string public constant override getName = "AdminFacet";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


27          string public constant override getName = "ExecutorFacet";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L27:27

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


25          string public constant override getName = "GettersFacet";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L25:25

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


35          string public constant override getName = "MailboxFacet";


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L35:35

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol


12          ZkSyncStateTransitionStorage internal s;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L12:12

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


17          bytes32 internal constant DIAMOND_INIT_SUCCESS_RETURN_VALUE =


21          bytes32 private constant DIAMOND_STORAGE_POSITION =


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L21:21

```solidity
File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol


22          uint160 constant offset = uint160(0x1111000000000000000000000000000000001111);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L22:22

```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


85          bytes32 private constant CREATE2_PREFIX = keccak256("zksyncCreate2");


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L85:85

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


25          address public override l1Bridge;


29          UpgradeableBeacon public l2TokenBeacon;


32          bytes32 internal l2TokenProxyBytecodeHash;


35          mapping(address l2TokenAddress => address l1TokenAddress) public override l1TokenAddress;


37          address private l1LegacyBridge;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L37:37

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


26          ERC20Getters private availableGetters;


34          address public override l2Bridge;


37          address public override l1Address;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L37:37

```solidity
File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol


22          uint160 constant offset = uint160(0x1111000000000000000000000000000000001111);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L22:22

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


23          bytes32 constant EMPTY_STRING_KECCAK = 0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L23:23

```solidity
File: system-contracts/contracts/L1Messenger.sol


44          uint256 internal constant KECCAK_ROUND_GAS_COST = 40;


47          uint256 internal constant KECCAK_ROUND_NUMBER_OF_BYTES = 136;


55          uint256 internal constant SHA256_ROUND_GAS_COST = 7;


58          uint256 internal constant SHA256_ROUND_NUMBER_OF_BYTES = 64;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L58:58

```solidity
File: system-contracts/contracts/NonceHolder.sol


28          uint256 private constant DEPLOY_NONCE_MULTIPLIER = 2 ** 128;


31          uint256 private constant MAXIMAL_MIN_NONCE_INCREMENT = 2 ** 32;


36          mapping(uint256 account => uint256 packedMinAndDeploymentNonce) internal rawNonces;


41          mapping(uint256 account => mapping(uint256 nonceKey => uint256 value)) internal nonceValues;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L41:41

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


84          bytes32 constant EIP712_TRANSACTION_TYPE_HASH =


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L84:84

```solidity
File: system-contracts/contracts/libraries/Utils.sol


13          bytes32 constant IS_CONSTRUCTOR_BYTECODE_HASH_BIT_MASK =


17          bytes32 constant SET_IS_CONSTRUCTOR_MARKER_BIT_MASK =


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L17:17

</details>



## NC089 - Use bit shifts in an imutable variable rather than long bit masks of a single bit, for readability:




```solidity
File: system-contracts/contracts/libraries/Utils.sol


18              0x0001000000000000000000000000000000000000000000000000000000000000;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L18:18

## NC090 - Event declarations should have NatSpec @param annotations:

Documents a parameter just like in Doxygen (must be followed by parameter name)


<details>
<summary>Click to show 62 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol


12          event DepositInitiated(


20          event WithdrawalFinalized(address indexed to, address indexed l1Token, uint256 amount);


22          event ClaimedFailedDeposit(address indexed to, address indexed l1Token, uint256 amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L22:22

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol


13          event LegacyDepositInitiated(


22          event BridgehubDepositInitiated(


31          event BridgehubDepositBaseTokenInitiated(


38          event BridgehubDepositFinalized(


44          event WithdrawalFinalizedSharedBridge(


51          event ClaimedFailedDepositSharedBridge(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L51:51

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


45          event NewPendingAdmin(address indexed oldPendingAdmin, address indexed newPendingAdmin);


48          event NewAdmin(address indexed oldAdmin, address indexed newAdmin);


133         event NewChain(uint256 indexed chainId, address stateTransitionManager, address indexed chainGovernance);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L133:133

```solidity
File: contracts/ethereum/contracts/governance/IGovernance.sol


68          event TransparentOperationScheduled(bytes32 indexed _id, uint256 delay, Operation _operation);


71          event ShadowOperationScheduled(bytes32 indexed _id, uint256 delay);


74          event OperationExecuted(bytes32 indexed _id);


77          event ChangeSecurityCouncil(address _securityCouncilBefore, address _securityCouncilAfter);


80          event ChangeMinDelay(uint256 _delayBefore, uint256 _delayAfter);


83          event OperationCancelled(bytes32 indexed _id);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L83:83

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


28          event StateTransitionNewChain(uint256 indexed _chainId, address indexed _stateTransitionContract);


30          event SetChainIdUpgrade(


38          event NewPendingAdmin(address indexed oldPendingAdmin, address indexed newPendingAdmin);


41          event NewAdmin(address indexed oldAdmin, address indexed newAdmin);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L41:41

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


29          event NewExecutionDelay(uint256 _newExecutionDelay);


32          event ValidatorAdded(uint256 _chainId, address _addedValidator);


35          event ValidatorRemoved(uint256 _chainId, address _removedValidator);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L35:35

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol


61          event IsPorterAvailableStatusUpdate(bool isPorterAvailable);


64          event ValidatorStatusUpdate(address indexed validatorAddress, bool isActive);


68          event NewPendingAdmin(address indexed oldPendingAdmin, address indexed newPendingAdmin);


71          event NewAdmin(address indexed oldAdmin, address indexed newAdmin);


74          event NewPriorityTxMaxGasLimit(uint256 oldPriorityTxMaxGasLimit, uint256 newPriorityTxMaxGasLimit);


77          event NewFeeParams(FeeParams oldFeeParams, FeeParams newFeeParams);


80          event ValidiumModeStatusUpdate(PubdataPricingMode validiumMode);


83          event NewBaseTokenMultiplier(


91          event ExecuteUpgrade(Diamond.DiamondCutData diamondCut);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L91:91

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol


17          event ProposeTransparentUpgrade(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol#L17:17

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


24          event DiamondCut(FacetCut[] facetCuts, address initAddress, bytes initCalldata);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L24:24

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


46          event NewProtocolVersion(uint256 indexed previousProtocolVersion, uint256 indexed newProtocolVersion);


49          event NewL2BootloaderBytecodeHash(bytes32 indexed previousBytecodeHash, bytes32 indexed newBytecodeHash);


52          event NewL2DefaultAccountBytecodeHash(bytes32 indexed previousBytecodeHash, bytes32 indexed newBytecodeHash);


55          event NewVerifier(address indexed oldVerifier, address indexed newVerifier);


58          event NewVerifierParams(VerifierParams oldVerifierParams, VerifierParams newVerifierParams);


61          event UpgradeComplete(uint256 indexed newProtocolVersion, bytes32 indexed l2UpgradeTxHash, ProposedUpgrade upgrade);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L61:61

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol


7           event FinalizeDeposit(


14          event WithdrawalInitiated(


22          event BaseTokenReceived(uint256 amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L22:22

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol


6           event BridgeInitialize(address indexed l1Token, string name, string symbol, uint8 decimals);


8           event BridgeMint(address indexed _account, uint256 _amount);


10          event BridgeBurn(address indexed _account, uint256 _amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L10:10

```solidity
File: system-contracts/contracts/interfaces/IBaseToken.sol


24          event Mint(address indexed account, uint256 amount);


26          event Transfer(address indexed from, address indexed to, uint256 value);


28          event Withdrawal(address indexed _l2Sender, address indexed _l1Receiver, uint256 _amount);


30          event WithdrawalWithMessage(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L30:30

```solidity
File: system-contracts/contracts/interfaces/IContractDeployer.sol


33          event ContractDeployed(


39          event AccountNonceOrderingUpdated(address indexed accountAddress, AccountNonceOrdering nonceOrdering);


41          event AccountVersionUpdated(address indexed accountAddress, AccountAbstractionVersion aaVersion);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L41:41

```solidity
File: system-contracts/contracts/interfaces/IKnownCodesStorage.sol


12          event MarkedAsKnown(bytes32 indexed bytecodeHash, bool indexed sendBytecodeToL1);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IKnownCodesStorage.sol#L12:12

```solidity
File: system-contracts/contracts/interfaces/IL1Messenger.sol


43          event L1MessageSent(address indexed _sender, bytes32 indexed _hash, bytes _message);


45          event L2ToL1LogSent(L2ToL1Log _l2log);


47          event BytecodeL1PublicationRequested(bytes32 _bytecodeHash);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L47:47

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


6           event BridgeMint(address indexed _account, uint256 _amount);


8           event BridgeBurn(address indexed _account, uint256 _amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L8:8

```solidity
File: system-contracts/contracts/interfaces/INonceHolder.sol


14          event ValueSetUnderNonce(address indexed accountAddress, uint256 indexed key, uint256 value);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L14:14

</details>

## NC091 - Event declarations should have NatSpec @dev annotations:

Explain to a developer any extra details


<details>
<summary>Click to show 62 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol


12          event DepositInitiated(


20          event WithdrawalFinalized(address indexed to, address indexed l1Token, uint256 amount);


22          event ClaimedFailedDeposit(address indexed to, address indexed l1Token, uint256 amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L22:22

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol


13          event LegacyDepositInitiated(


22          event BridgehubDepositInitiated(


31          event BridgehubDepositBaseTokenInitiated(


38          event BridgehubDepositFinalized(


44          event WithdrawalFinalizedSharedBridge(


51          event ClaimedFailedDepositSharedBridge(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L51:51

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


48          event NewAdmin(address indexed oldAdmin, address indexed newAdmin);


133         event NewChain(uint256 indexed chainId, address stateTransitionManager, address indexed chainGovernance);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L133:133

```solidity
File: contracts/ethereum/contracts/governance/IGovernance.sol


68          event TransparentOperationScheduled(bytes32 indexed _id, uint256 delay, Operation _operation);


71          event ShadowOperationScheduled(bytes32 indexed _id, uint256 delay);


74          event OperationExecuted(bytes32 indexed _id);


77          event ChangeSecurityCouncil(address _securityCouncilBefore, address _securityCouncilAfter);


80          event ChangeMinDelay(uint256 _delayBefore, uint256 _delayAfter);


83          event OperationCancelled(bytes32 indexed _id);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L83:83

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


28          event StateTransitionNewChain(uint256 indexed _chainId, address indexed _stateTransitionContract);


30          event SetChainIdUpgrade(


41          event NewAdmin(address indexed oldAdmin, address indexed newAdmin);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L41:41

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


29          event NewExecutionDelay(uint256 _newExecutionDelay);


32          event ValidatorAdded(uint256 _chainId, address _addedValidator);


35          event ValidatorRemoved(uint256 _chainId, address _removedValidator);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L35:35

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol


61          event IsPorterAvailableStatusUpdate(bool isPorterAvailable);


64          event ValidatorStatusUpdate(address indexed validatorAddress, bool isActive);


71          event NewAdmin(address indexed oldAdmin, address indexed newAdmin);


74          event NewPriorityTxMaxGasLimit(uint256 oldPriorityTxMaxGasLimit, uint256 newPriorityTxMaxGasLimit);


77          event NewFeeParams(FeeParams oldFeeParams, FeeParams newFeeParams);


80          event ValidiumModeStatusUpdate(PubdataPricingMode validiumMode);


83          event NewBaseTokenMultiplier(


91          event ExecuteUpgrade(Diamond.DiamondCutData diamondCut);


94          event Freeze();


97          event Unfreeze();


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L97:97

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol


123         event NewPriorityRequest(


134         event EthWithdrawalFinalized(address indexed to, uint256 amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L134:134

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol


17          event ProposeTransparentUpgrade(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol#L17:17

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


24          event DiamondCut(FacetCut[] facetCuts, address initAddress, bytes initCalldata);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L24:24

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


46          event NewProtocolVersion(uint256 indexed previousProtocolVersion, uint256 indexed newProtocolVersion);


49          event NewL2BootloaderBytecodeHash(bytes32 indexed previousBytecodeHash, bytes32 indexed newBytecodeHash);


52          event NewL2DefaultAccountBytecodeHash(bytes32 indexed previousBytecodeHash, bytes32 indexed newBytecodeHash);


55          event NewVerifier(address indexed oldVerifier, address indexed newVerifier);


58          event NewVerifierParams(VerifierParams oldVerifierParams, VerifierParams newVerifierParams);


61          event UpgradeComplete(uint256 indexed newProtocolVersion, bytes32 indexed l2UpgradeTxHash, ProposedUpgrade upgrade);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L61:61

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol


7           event FinalizeDeposit(


14          event WithdrawalInitiated(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L14:14

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol


6           event BridgeInitialize(address indexed l1Token, string name, string symbol, uint8 decimals);


8           event BridgeMint(address indexed _account, uint256 _amount);


10          event BridgeBurn(address indexed _account, uint256 _amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L10:10

```solidity
File: system-contracts/contracts/interfaces/IBaseToken.sol


24          event Mint(address indexed account, uint256 amount);


26          event Transfer(address indexed from, address indexed to, uint256 value);


28          event Withdrawal(address indexed _l2Sender, address indexed _l1Receiver, uint256 _amount);


30          event WithdrawalWithMessage(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L30:30

```solidity
File: system-contracts/contracts/interfaces/IContractDeployer.sol


33          event ContractDeployed(


39          event AccountNonceOrderingUpdated(address indexed accountAddress, AccountNonceOrdering nonceOrdering);


41          event AccountVersionUpdated(address indexed accountAddress, AccountAbstractionVersion aaVersion);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L41:41

```solidity
File: system-contracts/contracts/interfaces/IKnownCodesStorage.sol


12          event MarkedAsKnown(bytes32 indexed bytecodeHash, bool indexed sendBytecodeToL1);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IKnownCodesStorage.sol#L12:12

```solidity
File: system-contracts/contracts/interfaces/IL1Messenger.sol


43          event L1MessageSent(address indexed _sender, bytes32 indexed _hash, bytes _message);


45          event L2ToL1LogSent(L2ToL1Log _l2log);


47          event BytecodeL1PublicationRequested(bytes32 _bytecodeHash);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L47:47

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


6           event BridgeMint(address indexed _account, uint256 _amount);


8           event BridgeBurn(address indexed _account, uint256 _amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L8:8

```solidity
File: system-contracts/contracts/interfaces/INonceHolder.sol


14          event ValueSetUnderNonce(address indexed accountAddress, uint256 indexed key, uint256 value);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L14:14

</details>

## NC092 - Function definitions should have NatSpec @dev annotations:

Explain to a developer any extra details


<details>
<summary>Click to show 516 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


75          function l2TokenAddress(address _l1Token) external view returns (address) {


208         function finalizeWithdrawal(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L208:208

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


137         function receiveEth(uint256 _chainId) external payable {


182         function bridgehubDeposit(


232         function bridgehubConfirmL2Transaction(


385         function finalizeWithdrawal(


487         function _parseL2WithdrawalMessage(


615         function finalizeWithdrawalLegacyErc20Bridge(


644         function claimFailedDepositLegacyErc20Bridge(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L644:644

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol


24          function isWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool);


26          function deposit(


35          function deposit(


43          function claimFailedDeposit(


53          function finalizeWithdrawal(


61          function l2TokenAddress(address _l1Token) external view returns (address);


63          function sharedBridge() external view returns (IL1SharedBridge);


65          function l2TokenBeacon() external view returns (address);


67          function l2Bridge() external view returns (address);


69          function depositAmount(


75          function tranferTokenToSharedBridge(address _token, uint256 _amount) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L75:75

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol


58          function isWithdrawalFinalized(


64          function depositLegacyErc20Bridge(


74          function claimFailedDepositLegacyErc20Bridge(


85          function claimFailedDeposit(


97          function finalizeWithdrawalLegacyErc20Bridge(


105         function finalizeWithdrawal(


114         function l1WethAddress() external view returns (address);


116         function bridgehub() external view returns (IBridgehub);


118         function legacyBridge() external view returns (IL1ERC20Bridge);


120         function l2BridgeAddress(uint256 _chainId) external view returns (address);


122         function depositHappened(uint256 _chainId, bytes32 _l2TxHash) external view returns (bytes32);


128         function bridgehubDeposit(


135         function bridgehubDepositBaseToken(


142         function bridgehubConfirmL2Transaction(uint256 _chainId, bytes32 _txDataHash, bytes32 _txHash) external;


144         function receiveEth(uint256 _chainId) external payable;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L144:144

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol


7           function finalizeDeposit(


15          function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external;


17          function l1TokenAddress(address _l2Token) external view returns (address);


19          function l2TokenAddress(address _l1Token) external view returns (address);


21          function l1Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L21:21

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol


5           function deposit() external payable;


7           function withdraw(uint256 wad) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol#L7:7

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


38          constructor() reentrancyGuardInitializer {}


41          function initialize(address _owner) external reentrancyGuardInitializer {


51          function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin {


60          function acceptAdmin() external {


75          function getStateTransition(uint256 _chainId) public view returns (address) {


82          function addStateTransitionManager(address _stateTransitionManager) external onlyOwner {


92          function removeStateTransitionManager(address _stateTransitionManager) external onlyOwner {


101         function addToken(address _token) external onlyOwner {


108         function setSharedBridge(address _sharedBridge) external onlyOwner {


114         function createNewChain(


152         function proveL2MessageInclusion(


164         function proveL2LogInclusion(


176         function proveL1ToL2TransactionStatus(


198         function l2TransactionBaseCost(


217         function requestL2TransactionDirect(


262         function requestL2TransactionTwoBridges(


325         function _actualRefundRecipient(address _refundRecipient) internal view returns (address _recipient) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L325:325

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


53          function setPendingAdmin(address _newPendingAdmin) external;


56          function acceptAdmin() external;


59          function stateTransitionManagerIsRegistered(address _stateTransitionManager) external view returns (bool);


61          function stateTransitionManager(uint256 _chainId) external view returns (address);


63          function tokenIsRegistered(address _baseToken) external view returns (bool);


65          function baseToken(uint256 _chainId) external view returns (address);


67          function sharedBridge() external view returns (IL1SharedBridge);


69          function getStateTransition(uint256 _chainId) external view returns (address);


73          function proveL2MessageInclusion(


81          function proveL2LogInclusion(


89          function proveL1ToL2TransactionStatus(


99          function requestL2TransactionDirect(


103         function requestL2TransactionTwoBridges(


107         function l2TransactionBaseCost(


116         function createNewChain(


125         function addStateTransitionManager(address _stateTransitionManager) external;


127         function removeStateTransitionManager(address _stateTransitionManager) external;


129         function addToken(address _token) external;


131         function setSharedBridge(address _sharedBridge) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L131:131

```solidity
File: contracts/ethereum/contracts/common/ReentrancyGuard.sol


46          function _initializeReentrancyGuard() private {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L46:46

```solidity
File: contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol


25          function forceDeployOnAddresses(ForceDeployment[] calldata _deployParams) external;


31          function create2(bytes32 _salt, bytes32 _bytecodeHash, bytes calldata _input) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol#L31:31

```solidity
File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol


21          function hashL2Bytecode(bytes memory _bytecode) internal pure returns (bytes32 hashedBytecode) {


49          function bytecodeLen(bytes32 _bytecodeHash) internal pure returns (uint256 codeLengthInWords) {


60          function computeCreate2Address(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L60:60

```solidity
File: contracts/ethereum/contracts/common/libraries/UncheckedMath.sol


11          function uncheckedInc(uint256 _number) internal pure returns (uint256) {


17          function uncheckedAdd(uint256 _lhs, uint256 _rhs) internal pure returns (uint256) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UncheckedMath.sol#L17:17

```solidity
File: contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol


19          function readUint32(bytes memory _bytes, uint256 _start) internal pure returns (uint32 result, uint256 offset) {


26          function readAddress(bytes memory _bytes, uint256 _start) internal pure returns (address result, uint256 offset) {


33          function readUint256(bytes memory _bytes, uint256 _start) internal pure returns (uint256 result, uint256 offset) {


40          function readBytes32(bytes memory _bytes, uint256 _start) internal pure returns (bytes32 result, uint256 offset) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L40:40

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


41          constructor(address _admin, address _securityCouncil, uint256 _minDelay) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L41:41

```solidity
File: contracts/ethereum/contracts/governance/IGovernance.sol


41          function isOperation(bytes32 _id) external view returns (bool);


43          function isOperationPending(bytes32 _id) external view returns (bool);


45          function isOperationReady(bytes32 _id) external view returns (bool);


47          function isOperationDone(bytes32 _id) external view returns (bool);


49          function getOperationState(bytes32 _id) external view returns (OperationState);


51          function scheduleTransparent(Operation calldata _operation, uint256 _delay) external;


53          function scheduleShadow(bytes32 _id, uint256 _delay) external;


55          function cancel(bytes32 _id) external;


57          function execute(Operation calldata _operation) external payable;


59          function executeInstant(Operation calldata _operation) external payable;


61          function hashOperation(Operation calldata _operation) external pure returns (bytes32);


63          function updateDelay(uint256 _newDelay) external;


65          function updateSecurityCouncil(address _newSecurityCouncil) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L65:65

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


43          function bridgehub() external view returns (address);


48          function setPendingAdmin(address _newPendingAdmin) external;


51          function acceptAdmin() external;


53          function stateTransition(uint256 _chainId) external view returns (address);


55          function storedBatchZero() external view returns (bytes32);


57          function initialCutHash() external view returns (bytes32);


59          function genesisUpgrade() external view returns (address);


61          function upgradeCutHash(uint256 _protocolVersion) external view returns (bytes32);


63          function protocolVersion() external view returns (uint256);


65          function initialize(StateTransitionManagerInitializeData calldata _initalizeData) external;


67          function setInitialCutHash(Diamond.DiamondCutData calldata _diamondCut) external;


69          function setValidatorTimelock(address _validatorTimelock) external;


71          function getChainAdmin(uint256 _chainId) external view returns (address);


74          function createNewChain(


82          function registerAlreadyDeployedStateTransition(uint256 _chainId, address _stateTransitionContract) external;


84          function setNewVersionUpgrade(


90          function setUpgradeDiamondCut(Diamond.DiamondCutData calldata _cutData, uint256 _oldProtocolVersion) external;


92          function freezeChain(uint256 _chainId) external;


94          function unfreezeChain(uint256 _chainId) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L94:94

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


74          function getChainAdmin(uint256 _chainId) external view override returns (address) {


110         function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin {


119         function acceptAdmin() external {


230         function registerAlreadyDeployedStateTransition(


239         function createNewChain(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L239:239

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


55          constructor(address _initialOwner, uint32 _executionDelay) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L55:55

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


24          function initialize(InitializeData calldata _initializeData) external reentrancyGuardInitializer returns (bytes32) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L24:24

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol


11          constructor(uint256 _chainId, Diamond.DiamondCutData memory _diamondCut) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L11:11

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


23          function setPendingAdmin(address _newPendingAdmin) external onlyAdmin {


32          function acceptAdmin() external {


45          function setValidator(address _validator, bool _active) external onlyStateTransitionManager {


51          function setPorterAvailability(bool _zkPorterIsAvailable) external onlyStateTransitionManager {


58          function setPriorityTxMaxGasLimit(uint256 _newPriorityTxMaxGasLimit) external onlyStateTransitionManager {


67          function changeFeeParams(FeeParams calldata _newFeeParams) external onlyAdminOrStateTransitionManager {


79          function setTokenMultiplier(uint128 _nominator, uint128 _denominator) external onlyAdminOrStateTransitionManager {


89          function setValidiumMode(PubdataPricingMode _validiumMode) external onlyAdmin {


100         function upgradeChainFromVersion(


123         function executeUpgrade(Diamond.DiamondCutData calldata _diamondCut) external onlyStateTransitionManager {


133         function freezeDiamond() external onlyAdminOrStateTransitionManager {


143         function unfreezeDiamond() external onlyAdminOrStateTransitionManager {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L143:143

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


103         function _verifyBatchTimestamp(


199         function commitBatches(


207         function commitBatchesSharedBridge(


215         function _commitBatches(


337         function executeBatchesSharedBridge(


345         function executeBatches(StoredBatchInfo[] calldata _batchesData) external nonReentrant onlyValidator {


349         function _executeBatches(StoredBatchInfo[] calldata _batchesData) internal {


368         function proveBatches(


377         function proveBatchesSharedBridge(


386         function _proveBatches(


440         function _verifyProof(uint256[] memory proofPublicInput, ProofInput calldata _proof) internal view {


472         function revertBatches(uint256 _newLastBatch) external nonReentrant onlyValidatorOrStateTransitionManager {


477         function revertBatchesSharedBridge(uint256, uint256 _newLastBatch) external nonReentrant onlyValidator {


481         function _revertBatches(uint256 _newLastBatch) internal {


515         function _batchPassThroughData(CommitBatchInfo calldata _batch) internal pure returns (bytes memory) {


525         function _batchMetaParameters() internal view returns (bytes memory) {


537         function _batchAuxiliaryOutput(


587         function _hashStoredBatchInfo(StoredBatchInfo memory _storedBatchInfo) internal pure returns (bytes32) {


592         function _checkBit(uint256 _bitMap, uint8 _index) internal pure returns (bool) {


597         function _setBit(uint256 _bitMap, uint8 _index) internal pure returns (uint256) {


605         function _pointEvaluationPrecompile(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L605:605

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


32          function getVerifier() external view returns (address) {


37          function getAdmin() external view returns (address) {


42          function getPendingAdmin() external view returns (address) {


47          function getBridgehub() external view returns (address) {


52          function getStateTransitionManager() external view returns (address) {


57          function getBaseToken() external view returns (address) {


62          function getBaseTokenBridge() external view returns (address) {


67          function baseTokenGasPriceMultiplierNominator() external view returns (uint128) {


72          function baseTokenGasPriceMultiplierDenominator() external view returns (uint128) {


77          function getTotalBatchesCommitted() external view returns (uint256) {


82          function getTotalBatchesVerified() external view returns (uint256) {


87          function getTotalBatchesExecuted() external view returns (uint256) {


92          function getTotalPriorityTxs() external view returns (uint256) {


97          function getFirstUnprocessedPriorityTx() external view returns (uint256) {


102         function getPriorityQueueSize() external view returns (uint256) {


107         function priorityQueueFrontOperation() external view returns (PriorityOperation memory) {


112         function isValidator(address _address) external view returns (bool) {


117         function l2LogsRootHash(uint256 _batchNumber) external view returns (bytes32) {


122         function storedBatchHash(uint256 _batchNumber) external view returns (bytes32) {


127         function getL2BootloaderBytecodeHash() external view returns (bytes32) {


132         function getL2DefaultAccountBytecodeHash() external view returns (bytes32) {


137         function getVerifierParams() external view returns (VerifierParams memory) {


142         function getProtocolVersion() external view returns (uint256) {


147         function getL2SystemContractsUpgradeTxHash() external view returns (bytes32) {


152         function getL2SystemContractsUpgradeBatchNumber() external view returns (uint256) {


157         function isDiamondStorageFrozen() external view returns (bool) {


163         function isFacetFreezable(address _facet) external view returns (bool isFreezable) {


176         function getPriorityTxMaxGasLimit() external view returns (uint256) {


181         function isFunctionFreezable(bytes4 _selector) external view returns (bool) {


188         function isEthWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool) {


193         function getPubdataPricingMode() external view returns (PubdataPricingMode) {


202         function facets() external view returns (Facet[] memory result) {


217         function facetFunctionSelectors(address _facet) external view returns (bytes4[] memory) {


223         function facetAddresses() external view returns (address[] memory) {


229         function facetAddress(bytes4 _selector) external view returns (address) {


239         function getTotalBlocksCommitted() external view returns (uint256) {


244         function getTotalBlocksVerified() external view returns (uint256) {


249         function getTotalBlocksExecuted() external view returns (uint256) {


254         function storedBlockHash(uint256 _batchNumber) external view returns (bytes32) {


259         function getL2SystemContractsUpgradeBlockNumber() external view returns (uint256) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L259:259

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


38          function transferEthToSharedBridge() external onlyBaseTokenBridge {


47          function bridgehubRequestL2Transaction(


54          function proveL2MessageInclusion(


64          function proveL2LogInclusion(


74          function proveL1ToL2TransactionStatus(


143         function l2TransactionBaseCost(


156         function _deriveL2GasPrice(uint256 _l1GasPrice, uint256 _gasPerPubdata) internal view returns (uint256) {


178         function finalizeEthWithdrawal(


197         function requestL2Transaction(


228         function _requestL2TransactionSender(


258         function _requestL2Transaction(


289         function _serializeL2Transaction(


316         function _writePriorityOp(


353         function _hashFactoryDeps(bytes[] memory _factoryDeps) internal pure returns (uint256[] memory hashedFactoryDeps) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L353:353

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol


17          function setPendingAdmin(address _newPendingAdmin) external;


20          function acceptAdmin() external;


25          function setValidator(address _validator, bool _active) external;


29          function setPorterAvailability(bool _zkPorterIsAvailable) external;


33          function setPriorityTxMaxGasLimit(uint256 _newPriorityTxMaxGasLimit) external;


37          function changeFeeParams(FeeParams calldata _newFeeParams) external;


40          function setTokenMultiplier(uint128 _nominator, uint128 _denominator) external;


43          function setValidiumMode(PubdataPricingMode _validiumMode) external;


45          function upgradeChainFromVersion(uint256 _protocolVersion, Diamond.DiamondCutData calldata _cutData) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L45:45

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol


62          function initialize(InitializeData calldata _initData) external returns (bytes32);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L62:62

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol


137         function commitBatches(


143         function commitBatchesSharedBridge(


161         function proveBatchesSharedBridge(


172         function executeBatches(StoredBatchInfo[] calldata _batchesData) external;


175         function executeBatchesSharedBridge(uint256 _chainId, StoredBatchInfo[] calldata _batchesData) external;


181         function revertBatches(uint256 _newLastBatch) external;


184         function revertBatchesSharedBridge(uint256 _chainId, uint256 _newLastBatch) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L184:184

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol


19          function getVerifier() external view returns (address);


22          function getAdmin() external view returns (address);


25          function getPendingAdmin() external view returns (address);


28          function getBridgehub() external view returns (address);


31          function getStateTransitionManager() external view returns (address);


34          function getBaseToken() external view returns (address);


37          function getBaseTokenBridge() external view returns (address);


40          function getTotalBatchesCommitted() external view returns (uint256);


43          function getTotalBatchesVerified() external view returns (uint256);


46          function getTotalBatchesExecuted() external view returns (uint256);


49          function getTotalPriorityTxs() external view returns (uint256);


59          function getPriorityQueueSize() external view returns (uint256);


62          function priorityQueueFrontOperation() external view returns (PriorityOperation memory);


65          function isValidator(address _address) external view returns (bool);


68          function l2LogsRootHash(uint256 _batchNumber) external view returns (bytes32 merkleRoot);


76          function getL2BootloaderBytecodeHash() external view returns (bytes32);


79          function getL2DefaultAccountBytecodeHash() external view returns (bytes32);


82          function getVerifierParams() external view returns (VerifierParams memory);


85          function isDiamondStorageFrozen() external view returns (bool);


88          function getProtocolVersion() external view returns (uint256);


91          function getL2SystemContractsUpgradeTxHash() external view returns (bytes32);


101         function getPriorityTxMaxGasLimit() external view returns (uint256);


106         function isEthWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool);


109         function getPubdataPricingMode() external view returns (PubdataPricingMode);


112         function baseTokenGasPriceMultiplierNominator() external view returns (uint128);


115         function baseTokenGasPriceMultiplierDenominator() external view returns (uint128);


130         function facets() external view returns (Facet[] memory);


133         function facetFunctionSelectors(address _facet) external view returns (bytes4[] memory);


136         function facetAddresses() external view returns (address[] memory facets);


139         function facetAddress(bytes4 _selector) external view returns (address facet);


142         function isFunctionFreezable(bytes4 _selector) external view returns (bool);


145         function isFacetFreezable(address _facet) external view returns (bool isFreezable);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L145:145

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol


18          function proveL2MessageInclusion(


31          function proveL2LogInclusion(


47          function proveL1ToL2TransactionStatus(


62          function finalizeEthWithdrawal(


98          function bridgehubRequestL2Transaction(


107         function l2TransactionBaseCost(


114         function transferEthToSharedBridge() external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L114:114

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol


27          function verificationKeyHash() external pure returns (bytes32);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol#L27:27

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol


9           function getName() external view returns (string memory);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol#L9:9

```solidity
File: contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol


5           function setChainId(uint256 _newChainId) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol#L5:5

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


87          function getDiamondStorage() internal pure returns (DiamondStorage storage diamondStorage) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L87:87

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol


35          function getFirstUnprocessedPriorityTx(Queue storage _queue) internal view returns (uint256) {


40          function getTotalPriorityTxs(Queue storage _queue) internal view returns (uint256) {


45          function getSize(Queue storage _queue) internal view returns (uint256) {


50          function isEmpty(Queue storage _queue) internal view returns (bool) {


55          function pushBack(Queue storage _queue, PriorityOperation memory _operation) internal {


64          function front(Queue storage _queue) internal view returns (PriorityOperation memory) {


72          function popFront(Queue storage _queue) internal returns (PriorityOperation memory priorityOperation) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L72:72

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol


109         function getTransactionBodyGasLimit(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L109:109

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


92          function _setL2DefaultAccountBytecodeHash(bytes32 _l2DefaultAccountBytecodeHash) private {


109         function _setL2BootloaderBytecodeHash(bytes32 _l2BootloaderBytecodeHash) private {


126         function _setVerifier(IVerifier _newVerifier) private {


142         function _setVerifierParams(VerifierParams calldata _newVerifierParams) private {


163         function _upgradeVerifier(address _newVerifier, VerifierParams calldata _verifierParams) internal {


171         function _setBaseSystemContracts(bytes32 _bootloaderHash, bytes32 _defaultAccountHash) internal {


222         function _verifyFactoryDeps(bytes[] calldata _factoryDeps, uint256[] calldata _expectedHashes) private pure {


236         function _setNewProtocolVersion(uint256 _newProtocolVersion) internal virtual {


263         function _upgradeL1Contract(bytes calldata _customCallDataForUpgrade) internal virtual {}


269         function _postUpgrade(bytes calldata _customCallDataForUpgrade) internal virtual {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L269:269

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol


20          function _setNewProtocolVersion(uint256 _newProtocolVersion) internal override {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L20:20

```solidity
File: contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol


13          function upgrade(ProposedUpgrade calldata _proposedUpgrade) public override returns (bytes32) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol#L13:13

```solidity
File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol


14          function upgrade(ProposedUpgrade calldata _proposedUpgrade) public override returns (bytes32) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L14:14

```solidity
File: contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol


8           function upgrade(ProposedUpgrade calldata _upgrade) external returns (bytes32);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol#L8:8

```solidity
File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol


28          function applyL1ToL2Alias(address l1Address) internal pure returns (address l2Address) {


38          function undoL1ToL2Alias(address l2Address) internal pure returns (address l1Address) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L38:38

```solidity
File: contracts/zksync/contracts/ForceDeployUpgrader.sol


13          function forceDeploy(IContractDeployer.ForceDeployment[] calldata _forceDeployments) external payable {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/ForceDeployUpgrader.sol#L13:13

```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


22          function sendToL1(bytes memory _message) external returns (bytes32);


47          function forceDeployOnAddresses(ForceDeployment[] calldata _deployParams) external payable;


53          function create2(bytes32 _salt, bytes32 _bytecodeHash, bytes calldata _input) external returns (address);


65          function withdrawWithMessage(address _l1Receiver, bytes memory _additionalData) external payable;


90          function sendMessageToL1(bytes memory _message) internal returns (bytes32) {


101         function computeCreate2Address(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L101:101

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


27          function safeCastToU32(uint256 _x) internal pure returns (uint32) {


37          function systemCall(uint32 gasLimit, address to, uint256 value, bytes memory data) internal returns (bool success) {


76          function systemCallWithReturndata(


95          function getFarCallABI(


121         function getFarCallABIWithEmptyFatPointer(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L121:121

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


49          function initialize(


79          function finalizeDeposit(


123         function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external override {


149         function l2TokenAddress(address _l1Token) public view override returns (address) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L149:149

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


159         function name() public view override returns (string memory) {


165         function symbol() public view override returns (string memory) {


171         function decimals() public view override returns (uint8) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L171:171

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol


9           function finalizeWithdrawal(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L9:9

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol


9           function finalizeWithdrawal(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol#L9:9

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol


24          function finalizeDeposit(


32          function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external;


34          function l1TokenAddress(address _l2Token) external view returns (address);


36          function l2TokenAddress(address _l1Token) external view returns (address);


38          function l1Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L38:38

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol


12          function bridgeMint(address _account, uint256 _amount) external;


14          function bridgeBurn(address _account, uint256 _amount) external;


16          function l1Address() external view returns (address);


18          function l2Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L18:18

```solidity
File: contracts/zksync/contracts/interfaces/IPaymasterFlow.sol


14          function general(bytes calldata input) external;


16          function approvalBased(address _token, uint256 _minAllowance, bytes calldata _innerInput) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymasterFlow.sol#L16:16

```solidity
File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol


28          function applyL1ToL2Alias(address l1Address) internal pure returns (address l2Address) {


38          function undoL1ToL2Alias(address l2Address) internal pure returns (address l1Address) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L38:38

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


54          function markAccountCodeHashAsConstructed(address _address) external override onlyDeployer {


78          function getRawCodeHash(address _address) public view override returns (bytes32 codeHash) {


89          function getCodeHash(uint256 _input) external view override returns (bytes32) {


117         function getCodeSize(uint256 _input) external view override returns (uint256 codeSize) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L117:117

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


44          function encodeLegacyTransactionHash(Transaction calldata _transaction) internal view returns (bytes32 txHash) {


139         function encodeEIP2930TransactionHash(Transaction calldata _transaction) internal view returns (bytes32) {


229         function encodeEIP1559TransactionHash(Transaction calldata _transaction) internal view returns (bytes32) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L229:229

```solidity
File: system-contracts/contracts/Compressor.sol


197         function _decodeRawBytecode(


251         function _sliceToUint256(bytes calldata _calldataSlice) internal pure returns (uint256 number) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L251:251

```solidity
File: system-contracts/contracts/ContractDeployer.sol


34          function getAccountInfo(address _address) external view returns (AccountInfo memory info) {


40          function extendedAccountVersion(address _address) public view returns (AccountAbstractionVersion) {


58          function _storeAccountInfo(address _address, AccountInfo memory _newInfo) internal {


74          function updateNonceOrdering(AccountNonceOrdering _nonceOrdering) external onlySystemCall {


95          function getNewAddressCreate2(


115         function getNewAddressCreate(


132         function create2(


162         function create2Account(


213         function forceDeployOnAddress(ForceDeployment calldata _deployment, address _sender) external payable onlySelf {


258         function _nonSystemDeployOnAddress(


283         function _performDeployOnAddress(


301         function _ensureBytecodeIsKnown(bytes32 _bytecodeHash) internal view {


309         function _storeConstructingByteCodeHashOnAddress(address _newAddress, bytes32 _bytecodeHash) internal {


321         function _constructContract(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L321:321

```solidity
File: system-contracts/contracts/DefaultAccount.sol


78          function _validateTransaction(


131         function _execute(Transaction calldata _transaction) internal {


159         function _isValidSignature(bytes32 _hash, bytes memory _signature) internal view returns (bool) {


220         fallback() external payable ignoreInDelegateCall {


227         receive() external payable {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L227:227

```solidity
File: system-contracts/contracts/EmptyContract.sol


11          fallback() external payable {}


13          receive() external payable {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L13:13

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


27          function getImmutable(address _dest, uint256 _index) external view override returns (bytes32) {


34          function setImmutables(address _dest, ImmutableData[] calldata _immutables) external override {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L34:34

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


27          function markFactoryDeps(bool _shouldSendToL1, bytes32[] calldata _hashes) external onlyCallFromBootloader {


46          function _markBytecodeAsPublished(bytes32 _bytecodeHash, bool _shouldSendToL1) internal {


65          function getMarker(bytes32 _hash) public view override returns (uint256 marker) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L65:65

```solidity
File: system-contracts/contracts/L1Messenger.sol


50          function keccakGasCost(uint256 _length) internal pure returns (uint256) {


61          function sha256GasCost(uint256 _length) internal pure returns (uint256) {


94          function _processL2ToL1Log(L2ToL1Log memory _l2ToL1Log) internal returns (uint256 logIdInMerkleTree) {


116         function sendToL1(bytes calldata _message) external override returns (bytes32 hash) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L116:116

```solidity
File: system-contracts/contracts/L2BaseToken.sol


72          function withdraw(address _l1Receiver) external payable override {


85          function withdrawWithMessage(address _l1Receiver, bytes memory _additionalData) external payable override {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L85:85

```solidity
File: system-contracts/contracts/NonceHolder.sol


46          function getMinNonce(address _address) public view returns (uint256) {


65          function increaseMinNonce(uint256 _value) public onlySystemCall returns (uint256 oldMinNonce) {


102         function getValueUnderNonce(uint256 _key) public view returns (uint256) {


110         function incrementMinNonceIfEquals(uint256 _expectedNonce) external onlySystemCall {


125         function getDeploymentNonce(address _address) external view returns (uint256 deploymentNonce) {


135         function incrementDeploymentNonce(address _address) external returns (uint256 prevDeploymentNonce) {


154         function isNonceUsed(address _address, uint256 _nonce) public view returns (bool) {


179         function _splitRawNonce(uint256 _rawMinNonce) internal pure returns (uint256 deploymentNonce, uint256 minNonce) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L179:179

```solidity
File: system-contracts/contracts/SystemContext.sol


84          function setChainId(uint256 _newChainId) external onlyCallFromForceDeployer {


99          function setTxOrigin(address _newOrigin) external onlyCallFromBootloader {


105         function setGasPrice(uint256 _gasPrice) external onlyCallFromBootloader {


117         function getCurrentPubdataSpent() public view returns (uint256) {


122         function getCurrentPubdataCost() external view returns (uint256) {


166         function getBatchHash(uint256 _batchNumber) external view returns (bytes32 hash) {


172         function getBatchNumberAndTimestamp() public view returns (uint128 batchNumber, uint128 batchTimestamp) {


180         function getL2BlockNumberAndTimestamp() public view returns (uint128 blockNumber, uint128 blockTimestamp) {


205         function _getLatest257L2blockHash(uint256 _block) internal view returns (bytes32) {


212         function _setL2BlockHash(uint256 _block, bytes32 _hash) internal {


221         function _calculateL2BlockHash(


233         function _calculateLegacyL2BlockHash(uint128 _blockNumber) internal pure returns (bytes32) {


241         function _upgradeL2Blocks(uint128 _l2BlockNumber, bytes32 _expectedPrevL2BlockHash, bool _isFirstInBatch) internal {


263         function _setVirtualBlock(


314         function _setNewL2BlockData(uint128 _l2BlockNumber, uint128 _l2BlockTimestamp, bytes32 _prevL2BlockHash) internal {


402         function appendTransactionToCurrentL2Block(bytes32 _txHash) external onlyCallFromBootloader {


427         function _ensureBatchConsistentWithL2Block(uint128 _newTimestamp) internal view {


482         function incrementTxNumberInBatch() external onlyCallFromBootloader {


486         function resetTxNumberInBatch() external onlyCallFromBootloader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L486:486

```solidity
File: system-contracts/contracts/interfaces/IAccount.sol


26          function executeTransaction(


34          function executeTransactionFromOutside(Transaction calldata _transaction) external payable;


36          function payForTransaction(


42          function prepareForPaymaster(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccount.sol#L42:42

```solidity
File: system-contracts/contracts/interfaces/IAccountCodeStorage.sol


6           function storeAccountConstructingCodeHash(address _address, bytes32 _hash) external;


8           function storeAccountConstructedCodeHash(address _address, bytes32 _hash) external;


10          function markAccountCodeHashAsConstructed(address _address) external;


12          function getRawCodeHash(address _address) external view returns (bytes32 codeHash);


14          function getCodeHash(uint256 _input) external view returns (bytes32 codeHash);


16          function getCodeSize(uint256 _input) external view returns (uint256 codeSize);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L16:16

```solidity
File: system-contracts/contracts/interfaces/IBaseToken.sol


6           function balanceOf(uint256) external view returns (uint256);


8           function transferFromTo(address _from, address _to, uint256 _amount) external;


10          function totalSupply() external view returns (uint256);


12          function name() external pure returns (string memory);


14          function symbol() external pure returns (string memory);


16          function decimals() external pure returns (uint8);


18          function mint(address _account, uint256 _amount) external;


20          function withdraw(address _l1Receiver) external payable;


22          function withdrawWithMessage(address _l1Receiver, bytes calldata _additionalData) external payable;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L22:22

```solidity
File: system-contracts/contracts/interfaces/IBootloaderUtilities.sol


8           function getTransactionHashes(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBootloaderUtilities.sol#L8:8

```solidity
File: system-contracts/contracts/interfaces/IComplexUpgrader.sol


11          function upgrade(address _delegateTo, bytes calldata _calldata) external payable;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IComplexUpgrader.sol#L11:11

```solidity
File: system-contracts/contracts/interfaces/ICompressor.sol


19          function publishCompressedBytecode(


24          function verifyCompressedStateDiffs(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ICompressor.sol#L24:24

```solidity
File: system-contracts/contracts/interfaces/IContractDeployer.sol


43          function getNewAddressCreate2(


50          function getNewAddressCreate(address _sender, uint256 _senderNonce) external pure returns (address newAddress);


52          function create2(


58          function create2Account(


84          function getAccountInfo(address _address) external view returns (AccountInfo memory info);


87          function updateAccountVersion(AccountAbstractionVersion _version) external;


90          function updateNonceOrdering(AccountNonceOrdering _nonceOrdering) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L90:90

```solidity
File: system-contracts/contracts/interfaces/IImmutableSimulator.sol


11          function getImmutable(address _dest, uint256 _index) external view returns (bytes32);


13          function setImmutables(address _dest, ImmutableData[] calldata _immutables) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L13:13

```solidity
File: system-contracts/contracts/interfaces/IKnownCodesStorage.sol


14          function markFactoryDeps(bool _shouldSendToL1, bytes32[] calldata _hashes) external;


16          function markBytecodeAsPublished(bytes32 _bytecodeHash) external;


18          function getMarker(bytes32 _hash) external view returns (uint256);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IKnownCodesStorage.sol#L18:18

```solidity
File: system-contracts/contracts/interfaces/IL1Messenger.sol


49          function sendToL1(bytes memory _message) external returns (bytes32);


51          function sendL2ToL1Log(bool _isService, bytes32 _key, bytes32 _value) external returns (uint256 logIdInMerkleTree);


54          function requestBytecodeL1Publication(bytes32 _bytecodeHash) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L54:54

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


10          function bridgeMint(address _account, uint256 _amount) external;


12          function bridgeBurn(address _account, uint256 _amount) external;


14          function l1Address() external view returns (address);


16          function l2Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L16:16

```solidity
File: system-contracts/contracts/interfaces/IMailbox.sol


6           function finalizeEthWithdrawal(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IMailbox.sol#L6:6

```solidity
File: system-contracts/contracts/interfaces/IPaymasterFlow.sol


13          function general(bytes calldata input) external;


15          function approvalBased(address _token, uint256 _minAllowance, bytes calldata _innerInput) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymasterFlow.sol#L15:15

```solidity
File: system-contracts/contracts/interfaces/IPubdataChunkPublisher.sol


12          function chunkAndPublishPubdata(bytes calldata _pubdata) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPubdataChunkPublisher.sol#L12:12

```solidity
File: system-contracts/contracts/interfaces/ISystemContext.sol


30          function chainId() external view returns (uint256);


32          function origin() external view returns (address);


34          function gasPrice() external view returns (uint256);


36          function blockGasLimit() external view returns (uint256);


38          function coinbase() external view returns (address);


40          function difficulty() external view returns (uint256);


42          function baseFee() external view returns (uint256);


44          function txNumberInBlock() external view returns (uint16);


46          function getBlockHashEVM(uint256 _block) external view returns (bytes32);


48          function getBatchHash(uint256 _batchNumber) external view returns (bytes32 hash);


50          function getBlockNumber() external view returns (uint128);


52          function getBlockTimestamp() external view returns (uint128);


54          function getBatchNumberAndTimestamp() external view returns (uint128 blockNumber, uint128 blockTimestamp);


56          function getL2BlockNumberAndTimestamp() external view returns (uint128 blockNumber, uint128 blockTimestamp);


58          function gasPerPubdataByte() external view returns (uint256 gasPerPubdataByte);


60          function getCurrentPubdataSpent() external view returns (uint256 currentPubdataSpent);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L60:60

```solidity
File: system-contracts/contracts/interfaces/ISystemContextDeprecated.sol


11          function currentBlockInfo() external view returns (uint256);


13          function getBlockNumberAndTimestamp() external view returns (uint256 blockNumber, uint256 blockTimestamp);


15          function blockHash(uint256 _blockNumber) external view returns (bytes32 hash);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContextDeprecated.sol#L15:15

```solidity
File: system-contracts/contracts/libraries/EfficientCall.sol


36          function keccak(bytes calldata _data) internal view returns (bytes32) {


45          function sha(bytes calldata _data) internal view returns (bytes32) {


58          function call(


74          function staticCall(


88          function delegateCall(


105         function mimicCall(


124         function rawCall(


159         function rawStaticCall(uint256 _gas, address _address, bytes calldata _data) internal view returns (bool success) {


173         function rawDelegateCall(uint256 _gas, address _address, bytes calldata _data) internal returns (bool success) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L173:173

```solidity
File: system-contracts/contracts/libraries/RLPEncoder.sol


11          function encodeAddress(address _val) internal pure returns (bytes memory encoded) {


24          function encodeUint256(uint256 _val) internal pure returns (bytes memory encoded) {


49          function encodeNonSingleBytesLen(uint64 _len) internal pure returns (bytes memory) {


56          function encodeListLen(uint64 _len) internal pure returns (bytes memory) {


60          function _encodeLength(uint64 _len, uint256 _offset) private pure returns (bytes memory encoded) {


84          function _highestByteSet(uint256 _number) private pure returns (uint256 hbs) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L84:84

```solidity
File: system-contracts/contracts/libraries/SystemContractHelper.sol


124         function packPrecompileParams(


181         function eventInitialize(uint256 initializer, uint256 value1) internal {


191         function eventWrite(uint256 value1, uint256 value2) internal {


215         function extractNumberFromMeta(uint256 meta, uint256 offset, uint256 size) internal pure returns (uint256 result) {


227         function getPubdataPublishedFromMeta(uint256 meta) internal pure returns (uint32 pubdataPublished) {


279         function getZkSyncMeta() internal view returns (ZkSyncMeta memory meta) {


329         function isSystemCall() internal view returns (bool) {


338         function isSystemContract(address _address) internal pure returns (bool) {


344         function burnGas(uint32 _gasToPay, uint32 _pubdataToSpend) internal view {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L344:344

```solidity
File: system-contracts/contracts/libraries/SystemContractsCaller.sol


250         function getFarCallABIWithEmptyFatPointer(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L250:250

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


100         function encodeHash(Transaction calldata _transaction) internal view returns (bytes32 resultHash) {


118         function _encodeHashEIP712Transaction(Transaction calldata _transaction) private view returns (bytes32) {


147         function _encodeHashLegacyTransaction(Transaction calldata _transaction) private view returns (bytes32) {


219         function _encodeHashEIP2930Transaction(Transaction calldata _transaction) private view returns (bytes32) {


289         function _encodeHashEIP1559Transaction(Transaction calldata _transaction) private view returns (bytes32) {


362         function processPaymasterInput(Transaction calldata _transaction) internal {


405         function totalRequiredBalance(Transaction calldata _transaction) internal pure returns (uint256 requiredBalance) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L405:405

```solidity
File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol


19          function readUint16(bytes calldata _bytes, uint256 _start) internal pure returns (uint16 result) {


26          function readUint32(bytes calldata _bytes, uint256 _start) internal pure returns (uint32 result) {


33          function readUint64(bytes calldata _bytes, uint256 _start) internal pure returns (uint64 result) {


40          function readBytes32(bytes calldata _bytes, uint256 _start) internal pure returns (bytes32 result) {


46          function readUint256(bytes calldata _bytes, uint256 _start) internal pure returns (uint256 result) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L46:46

```solidity
File: system-contracts/contracts/libraries/Utils.sol


20          function safeCastToU128(uint256 _x) internal pure returns (uint128) {


26          function safeCastToU32(uint256 _x) internal pure returns (uint32) {


32          function safeCastToU24(uint256 _x) internal pure returns (uint24) {


39          function bytecodeLenInBytes(bytes32 _bytecodeHash) internal pure returns (uint256 codeLength) {


44          function bytecodeLenInWords(bytes32 _bytecodeHash) internal pure returns (uint256 codeLengthInWords) {


51          function isContractConstructed(bytes32 _bytecodeHash) internal pure returns (bool) {


56          function isContractConstructing(bytes32 _bytecodeHash) internal pure returns (bool) {


63          function constructingBytecodeHash(bytes32 _bytecodeHash) internal pure returns (bytes32) {


71          function constructedBytecodeHash(bytes32 _bytecodeHash) internal pure returns (bytes32) {


82          function hashL2Bytecode(bytes calldata _bytecode) internal view returns (bytes32 hashedBytecode) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L82:82

</details>

## NC093 - Function definitions should have NatSpec @notice annotations:

Explain to an end user what this does


<details>
<summary>Click to show 451 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


55          constructor(IL1SharedBridge _sharedBridge) reentrancyGuardInitializer {


60          function initialize() external reentrancyGuardInitializer {}


63          function tranferTokenToSharedBridge(address _token, uint256 _amount) external {


75          function l2TokenAddress(address _l1Token) external view returns (address) {


160         function _depositFundsToSharedBridge(address _from, IERC20 _token, uint256 _amount) internal returns (uint256) {


176         function claimFailedDeposit(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L176:176

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


90          constructor(


104         function initialize(


116         function transferFundsFromLegacy(address _token, address _target, uint256 _targetChainId) external onlyOwner {


137         function receiveEth(uint256 _chainId) external payable {


142         function initializeChainGovernance(uint256 _chainId, address _l2BridgeAddress) external onlyOwner {


173         function _depositFunds(address _from, IERC20 _token, uint256 _amount) internal returns (uint256) {


243         function _getDepositL2Calldata(


254         function _getERC20Getters(address _token) internal view returns (bytes memory) {


277         function claimFailedDeposit(


303         function _claimFailedDeposit(


374         function _isEraLegacyWithdrawal(uint256 _chainId, uint256 _l2BatchNumber) internal view returns (bool) {


409         function _finalizeWithdrawal(


458         function _checkWithdrawal(


487         function _parseL2WithdrawalMessage(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L487:487

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol


24          function isWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool);


26          function deposit(


35          function deposit(


43          function claimFailedDeposit(


53          function finalizeWithdrawal(


61          function l2TokenAddress(address _l1Token) external view returns (address);


63          function sharedBridge() external view returns (IL1SharedBridge);


65          function l2TokenBeacon() external view returns (address);


67          function l2Bridge() external view returns (address);


69          function depositAmount(


75          function tranferTokenToSharedBridge(address _token, uint256 _amount) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L75:75

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol


58          function isWithdrawalFinalized(


64          function depositLegacyErc20Bridge(


74          function claimFailedDepositLegacyErc20Bridge(


85          function claimFailedDeposit(


97          function finalizeWithdrawalLegacyErc20Bridge(


105         function finalizeWithdrawal(


114         function l1WethAddress() external view returns (address);


116         function bridgehub() external view returns (IBridgehub);


118         function legacyBridge() external view returns (IL1ERC20Bridge);


120         function l2BridgeAddress(uint256 _chainId) external view returns (address);


122         function depositHappened(uint256 _chainId, bytes32 _l2TxHash) external view returns (bytes32);


128         function bridgehubDeposit(


135         function bridgehubDepositBaseToken(


142         function bridgehubConfirmL2Transaction(uint256 _chainId, bytes32 _txDataHash, bytes32 _txHash) external;


144         function receiveEth(uint256 _chainId) external payable;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L144:144

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol


7           function finalizeDeposit(


15          function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external;


17          function l1TokenAddress(address _l2Token) external view returns (address);


19          function l2TokenAddress(address _l1Token) external view returns (address);


21          function l1Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L21:21

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol


5           function deposit() external payable;


7           function withdraw(uint256 wad) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol#L7:7

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


51          function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin {


60          function acceptAdmin() external {


325         function _actualRefundRecipient(address _refundRecipient) internal view returns (address _recipient) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L325:325

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


59          function stateTransitionManagerIsRegistered(address _stateTransitionManager) external view returns (bool);


61          function stateTransitionManager(uint256 _chainId) external view returns (address);


63          function tokenIsRegistered(address _baseToken) external view returns (bool);


65          function baseToken(uint256 _chainId) external view returns (address);


67          function sharedBridge() external view returns (IL1SharedBridge);


69          function getStateTransition(uint256 _chainId) external view returns (address);


73          function proveL2MessageInclusion(


81          function proveL2LogInclusion(


89          function proveL1ToL2TransactionStatus(


99          function requestL2TransactionDirect(


103         function requestL2TransactionTwoBridges(


107         function l2TransactionBaseCost(


116         function createNewChain(


125         function addStateTransitionManager(address _stateTransitionManager) external;


127         function removeStateTransitionManager(address _stateTransitionManager) external;


129         function addToken(address _token) external;


131         function setSharedBridge(address _sharedBridge) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L131:131

```solidity
File: contracts/ethereum/contracts/common/ReentrancyGuard.sol


46          function _initializeReentrancyGuard() private {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L46:46

```solidity
File: contracts/ethereum/contracts/common/libraries/UncheckedMath.sol


11          function uncheckedInc(uint256 _number) internal pure returns (uint256) {


17          function uncheckedAdd(uint256 _lhs, uint256 _rhs) internal pure returns (uint256) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UncheckedMath.sol#L17:17

```solidity
File: contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol


19          function readUint32(bytes memory _bytes, uint256 _start) internal pure returns (uint32 result, uint256 offset) {


26          function readAddress(bytes memory _bytes, uint256 _start) internal pure returns (address result, uint256 offset) {


33          function readUint256(bytes memory _bytes, uint256 _start) internal pure returns (uint256 result, uint256 offset) {


40          function readBytes32(bytes memory _bytes, uint256 _start) internal pure returns (bytes32 result, uint256 offset) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L40:40

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


84          function isOperation(bytes32 _id) public view returns (bool) {


89          function isOperationPending(bytes32 _id) public view returns (bool) {


95          function isOperationReady(bytes32 _id) public view returns (bool) {


100         function isOperationDone(bytes32 _id) public view returns (bool) {


105         function getOperationState(bytes32 _id) public view returns (OperationState) {


154         function cancel(bytes32 _id) external onlyOwner {


204         function hashOperation(Operation calldata _operation) public pure returns (bytes32) {


215         function _schedule(bytes32 _id, uint256 _delay) internal {


224         function _execute(Call[] calldata _calls) internal {


249         function updateDelay(uint256 _newDelay) external onlySelf {


256         function updateSecurityCouncil(address _newSecurityCouncil) external onlySelf {


262         receive() external payable {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L262:262

```solidity
File: contracts/ethereum/contracts/governance/IGovernance.sol


41          function isOperation(bytes32 _id) external view returns (bool);


43          function isOperationPending(bytes32 _id) external view returns (bool);


45          function isOperationReady(bytes32 _id) external view returns (bool);


47          function isOperationDone(bytes32 _id) external view returns (bool);


49          function getOperationState(bytes32 _id) external view returns (OperationState);


51          function scheduleTransparent(Operation calldata _operation, uint256 _delay) external;


53          function scheduleShadow(bytes32 _id, uint256 _delay) external;


55          function cancel(bytes32 _id) external;


57          function execute(Operation calldata _operation) external payable;


59          function executeInstant(Operation calldata _operation) external payable;


61          function hashOperation(Operation calldata _operation) external pure returns (bytes32);


63          function updateDelay(uint256 _newDelay) external;


65          function updateSecurityCouncil(address _newSecurityCouncil) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L65:65

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


43          function bridgehub() external view returns (address);


53          function stateTransition(uint256 _chainId) external view returns (address);


55          function storedBatchZero() external view returns (bytes32);


57          function initialCutHash() external view returns (bytes32);


59          function genesisUpgrade() external view returns (address);


61          function upgradeCutHash(uint256 _protocolVersion) external view returns (bytes32);


63          function protocolVersion() external view returns (uint256);


65          function initialize(StateTransitionManagerInitializeData calldata _initalizeData) external;


67          function setInitialCutHash(Diamond.DiamondCutData calldata _diamondCut) external;


69          function setValidatorTimelock(address _validatorTimelock) external;


71          function getChainAdmin(uint256 _chainId) external view returns (address);


82          function registerAlreadyDeployedStateTransition(uint256 _chainId, address _stateTransitionContract) external;


84          function setNewVersionUpgrade(


90          function setUpgradeDiamondCut(Diamond.DiamondCutData calldata _cutData, uint256 _oldProtocolVersion) external;


92          function freezeChain(uint256 _chainId) external;


94          function unfreezeChain(uint256 _chainId) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L94:94

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


58          constructor(address _bridgehub) reentrancyGuardInitializer {


74          function getChainAdmin(uint256 _chainId) external view override returns (address) {


79          function initialize(


110         function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin {


119         function acceptAdmin() external {


132         function setValidatorTimelock(address _validatorTimelock) external onlyOwnerOrAdmin {


137         function setInitialCutHash(Diamond.DiamondCutData calldata _diamondCut) external onlyOwner {


142         function setNewVersionUpgrade(


152         function setUpgradeDiamondCut(


160         function freezeChain(uint256 _chainId) external onlyOwner {


165         function unfreezeChain(uint256 _chainId) external onlyOwner {


170         function revertBatches(uint256 _chainId, uint256 _newLastBatch) external onlyOwnerOrAdmin {


177         function _setChainIdUpgrade(uint256 _chainId, address _chainContract) internal {


230         function registerAlreadyDeployedStateTransition(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L230:230

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


55          constructor(address _initialOwner, uint32 _executionDelay) {


73          function setStateTransitionManager(IStateTransitionManager _stateTransitionManager) external onlyOwner {


78          function addValidator(uint256 _chainId, address _newValidator) external onlyChainAdmin(_chainId) {


87          function removeValidator(uint256 _chainId, address _validator) external onlyChainAdmin(_chainId) {


96          function setExecutionDelay(uint32 _executionDelay) external onlyOwner {


102         function getCommittedBatchTimestamp(uint256 _chainId, uint256 _l2BatchNumber) external view returns (uint256) {


108         function commitBatches(


126         function commitBatchesSharedBridge(


146         function revertBatches(uint256) external onlyValidator(ERA_CHAIN_ID) {


153         function revertBatchesSharedBridge(uint256 _chainId, uint256) external onlyValidator(_chainId) {


160         function proveBatches(


171         function proveBatchesSharedBridge(


182         function executeBatches(StoredBatchInfo[] calldata _newBatchesData) external onlyValidator(ERA_CHAIN_ID) {


203         function executeBatchesSharedBridge(


225         function _propagateToZkSyncStateTransition(uint256 _chainId) internal {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L225:225

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


19          constructor() reentrancyGuardInitializer {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L19:19

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol


11          constructor(uint256 _chainId, Diamond.DiamondCutData memory _diamondCut) {


20          fallback() external payable {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


23          function setPendingAdmin(address _newPendingAdmin) external onlyAdmin {


32          function acceptAdmin() external {


45          function setValidator(address _validator, bool _active) external onlyStateTransitionManager {


51          function setPorterAvailability(bool _zkPorterIsAvailable) external onlyStateTransitionManager {


58          function setPriorityTxMaxGasLimit(uint256 _newPriorityTxMaxGasLimit) external onlyStateTransitionManager {


67          function changeFeeParams(FeeParams calldata _newFeeParams) external onlyAdminOrStateTransitionManager {


79          function setTokenMultiplier(uint128 _nominator, uint128 _denominator) external onlyAdminOrStateTransitionManager {


89          function setValidiumMode(PubdataPricingMode _validiumMode) external onlyAdmin {


100         function upgradeChainFromVersion(


123         function executeUpgrade(Diamond.DiamondCutData calldata _diamondCut) external onlyStateTransitionManager {


133         function freezeDiamond() external onlyAdminOrStateTransitionManager {


143         function unfreezeDiamond() external onlyAdminOrStateTransitionManager {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L143:143

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


130         function _processL2Logs(


199         function commitBatches(


207         function commitBatchesSharedBridge(


215         function _commitBatches(


253         function _commitBatchesWithoutSystemContractsUpgrade(


273         function _commitBatchesWithSystemContractsUpgrade(


308         function _collectOperationsFromPriorityQueue(uint256 _nPriorityOps) internal returns (bytes32 concatHash) {


321         function _executeOneBatch(StoredBatchInfo memory _storedBatch, uint256 _executedBatchIdx) internal {


337         function executeBatchesSharedBridge(


345         function executeBatches(StoredBatchInfo[] calldata _batchesData) external nonReentrant onlyValidator {


349         function _executeBatches(StoredBatchInfo[] calldata _batchesData) internal {


368         function proveBatches(


377         function proveBatchesSharedBridge(


386         function _proveBatches(


440         function _verifyProof(uint256[] memory proofPublicInput, ProofInput calldata _proof) internal view {


453         function _getBatchProofPublicInput(


472         function revertBatches(uint256 _newLastBatch) external nonReentrant onlyValidatorOrStateTransitionManager {


477         function revertBatchesSharedBridge(uint256, uint256 _newLastBatch) external nonReentrant onlyValidator {


481         function _revertBatches(uint256 _newLastBatch) internal {


500         function _createBatchCommitment(


515         function _batchPassThroughData(CommitBatchInfo calldata _batch) internal pure returns (bytes memory) {


525         function _batchMetaParameters() internal view returns (bytes memory) {


537         function _batchAuxiliaryOutput(


561         function _encodeBlobAuxilaryOutput(


625         function _verifyBlobInformation(


679         function _getBlobVersionedHash(uint256 _index) internal view returns (bytes32 versionedHash) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L679:679

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


32          function getVerifier() external view returns (address) {


37          function getAdmin() external view returns (address) {


42          function getPendingAdmin() external view returns (address) {


47          function getBridgehub() external view returns (address) {


52          function getStateTransitionManager() external view returns (address) {


57          function getBaseToken() external view returns (address) {


62          function getBaseTokenBridge() external view returns (address) {


67          function baseTokenGasPriceMultiplierNominator() external view returns (uint128) {


72          function baseTokenGasPriceMultiplierDenominator() external view returns (uint128) {


77          function getTotalBatchesCommitted() external view returns (uint256) {


82          function getTotalBatchesVerified() external view returns (uint256) {


87          function getTotalBatchesExecuted() external view returns (uint256) {


92          function getTotalPriorityTxs() external view returns (uint256) {


97          function getFirstUnprocessedPriorityTx() external view returns (uint256) {


102         function getPriorityQueueSize() external view returns (uint256) {


107         function priorityQueueFrontOperation() external view returns (PriorityOperation memory) {


112         function isValidator(address _address) external view returns (bool) {


117         function l2LogsRootHash(uint256 _batchNumber) external view returns (bytes32) {


122         function storedBatchHash(uint256 _batchNumber) external view returns (bytes32) {


127         function getL2BootloaderBytecodeHash() external view returns (bytes32) {


132         function getL2DefaultAccountBytecodeHash() external view returns (bytes32) {


137         function getVerifierParams() external view returns (VerifierParams memory) {


142         function getProtocolVersion() external view returns (uint256) {


147         function getL2SystemContractsUpgradeTxHash() external view returns (bytes32) {


152         function getL2SystemContractsUpgradeBatchNumber() external view returns (uint256) {


157         function isDiamondStorageFrozen() external view returns (bool) {


163         function isFacetFreezable(address _facet) external view returns (bool isFreezable) {


176         function getPriorityTxMaxGasLimit() external view returns (uint256) {


181         function isFunctionFreezable(bytes4 _selector) external view returns (bool) {


188         function isEthWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool) {


193         function getPubdataPricingMode() external view returns (PubdataPricingMode) {


202         function facets() external view returns (Facet[] memory result) {


217         function facetFunctionSelectors(address _facet) external view returns (bytes4[] memory) {


223         function facetAddresses() external view returns (address[] memory) {


229         function facetAddress(bytes4 _selector) external view returns (address) {


239         function getTotalBlocksCommitted() external view returns (uint256) {


244         function getTotalBlocksVerified() external view returns (uint256) {


249         function getTotalBlocksExecuted() external view returns (uint256) {


254         function storedBlockHash(uint256 _batchNumber) external view returns (bytes32) {


259         function getL2SystemContractsUpgradeBlockNumber() external view returns (uint256) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L259:259

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


38          function transferEthToSharedBridge() external onlyBaseTokenBridge {


54          function proveL2MessageInclusion(


64          function proveL2LogInclusion(


74          function proveL1ToL2TransactionStatus(


104         function _proveL2LogInclusion(


130         function _L2MessageToLog(L2Message memory _message) internal pure returns (L2Log memory) {


143         function l2TransactionBaseCost(


178         function finalizeEthWithdrawal(


197         function requestL2Transaction(


228         function _requestL2TransactionSender(


258         function _requestL2Transaction(


289         function _serializeL2Transaction(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L289:289

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol


45          function upgradeChainFromVersion(uint256 _protocolVersion, Diamond.DiamondCutData calldata _cutData) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L45:45

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol


62          function initialize(InitializeData calldata _initData) external returns (bytes32);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L62:62

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol


19          function getVerifier() external view returns (address);


22          function getAdmin() external view returns (address);


25          function getPendingAdmin() external view returns (address);


28          function getBridgehub() external view returns (address);


31          function getStateTransitionManager() external view returns (address);


34          function getBaseToken() external view returns (address);


37          function getBaseTokenBridge() external view returns (address);


40          function getTotalBatchesCommitted() external view returns (uint256);


43          function getTotalBatchesVerified() external view returns (uint256);


46          function getTotalBatchesExecuted() external view returns (uint256);


49          function getTotalPriorityTxs() external view returns (uint256);


59          function getPriorityQueueSize() external view returns (uint256);


62          function priorityQueueFrontOperation() external view returns (PriorityOperation memory);


65          function isValidator(address _address) external view returns (bool);


68          function l2LogsRootHash(uint256 _batchNumber) external view returns (bytes32 merkleRoot);


76          function getL2BootloaderBytecodeHash() external view returns (bytes32);


79          function getL2DefaultAccountBytecodeHash() external view returns (bytes32);


82          function getVerifierParams() external view returns (VerifierParams memory);


85          function isDiamondStorageFrozen() external view returns (bool);


88          function getProtocolVersion() external view returns (uint256);


91          function getL2SystemContractsUpgradeTxHash() external view returns (bytes32);


98          function getL2SystemContractsUpgradeBatchNumber() external view returns (uint256);


101         function getPriorityTxMaxGasLimit() external view returns (uint256);


106         function isEthWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool);


109         function getPubdataPricingMode() external view returns (PubdataPricingMode);


112         function baseTokenGasPriceMultiplierNominator() external view returns (uint128);


115         function baseTokenGasPriceMultiplierDenominator() external view returns (uint128);


130         function facets() external view returns (Facet[] memory);


133         function facetFunctionSelectors(address _facet) external view returns (bytes4[] memory);


136         function facetAddresses() external view returns (address[] memory facets);


139         function facetAddress(bytes4 _selector) external view returns (address facet);


142         function isFunctionFreezable(bytes4 _selector) external view returns (bool);


145         function isFacetFreezable(address _facet) external view returns (bool isFreezable);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L145:145

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol


14          function getTotalBlocksCommitted() external view returns (uint256);


18          function getTotalBlocksVerified() external view returns (uint256);


22          function getTotalBlocksExecuted() external view returns (uint256);


36          function getL2SystemContractsUpgradeBlockNumber() external view returns (uint256);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol#L36:36

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol


98          function bridgehubRequestL2Transaction(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L98:98

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol


19          function verify(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol#L19:19

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol


9           function getName() external view returns (string memory);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol#L9:9

```solidity
File: contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol


5           function setChainId(uint256 _newChainId) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol#L5:5

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


87          function getDiamondStorage() internal pure returns (DiamondStorage storage diamondStorage) {


96          function diamondCut(DiamondCutData memory _diamondCut) internal {


126         function _addFunctions(address _facet, bytes4[] memory _selectors, bool _isFacetFreezable) private {


149         function _replaceFunctions(address _facet, bytes4[] memory _selectors, bool _isFacetFreezable) private {


172         function _removeFunctions(address _facet, bytes4[] memory _selectors) private {


189         function _saveFacetIfNew(address _facet) private {


205         function _addOneFunction(address _facet, bytes4 _selector, bool _isSelectorFreezable) private {


228         function _removeOneFunction(address _facet, bytes4 _selector) private {


257         function _removeFacet(address _facet) private {


278         function _initializeDiamondCut(address _init, bytes memory _calldata) private {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L278:278

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/LibMap.sol


18          function get(Uint32Map storage _map, uint256 _index) internal view returns (uint32 result) {


38          function set(Uint32Map storage _map, uint256 _index, uint32 _value) internal {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L38:38

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol


18          function calculateRoot(


40          function _efficientHash(bytes32 _lhs, bytes32 _rhs) private pure returns (bytes32 result) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L40:40

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol


40          function getTotalPriorityTxs(Queue storage _queue) internal view returns (uint256) {


45          function getSize(Queue storage _queue) internal view returns (uint256) {


50          function isEmpty(Queue storage _queue) internal view returns (bool) {


64          function front(Queue storage _queue) internal view returns (PriorityOperation memory) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L64:64

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol


19          function validateL1ToL2Transaction(


46          function validateUpgradeTransaction(L2CanonicalTransaction memory _transaction) internal pure {


69          function getMinimalPriorityTransactionGasLimit(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L69:69

```solidity
File: contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol


8           function upgrade(ProposedUpgrade calldata _upgrade) external returns (bytes32);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol#L8:8

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


27          function safeCastToU32(uint256 _x) internal pure returns (uint32) {


37          function systemCall(uint32 gasLimit, address to, uint256 value, bytes memory data) internal returns (bool success) {


76          function systemCallWithReturndata(


95          function getFarCallABI(


121         function getFarCallABIWithEmptyFatPointer(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L121:121

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


41          constructor() {


109         function _deployL2Token(address _l1Token, bytes calldata _data) internal returns (address) {


138         function _getL1WithdrawMessage(


149         function l2TokenAddress(address _l1Token) public view override returns (address) {


157         function _getCreate2Salt(address _l1Token) internal pure returns (bytes32 salt) {


164         function _deployBeaconProxy(bytes32 salt) internal returns (BeaconProxy proxy) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L164:164

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


40          constructor() {


159         function name() public view override returns (string memory) {


165         function symbol() public view override returns (string memory) {


171         function decimals() public view override returns (uint8) {


178         function decodeString(bytes memory _input) external pure returns (string memory result) {


183         function decodeUint8(bytes memory _input) external pure returns (uint8 result) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L183:183

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol


9           function finalizeWithdrawal(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L9:9

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol


9           function finalizeWithdrawal(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol#L9:9

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol


24          function finalizeDeposit(


32          function withdraw(address _l1Receiver, address _l2Token, uint256 _amount) external;


34          function l1TokenAddress(address _l2Token) external view returns (address);


36          function l2TokenAddress(address _l1Token) external view returns (address);


38          function l1Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L38:38

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol


12          function bridgeMint(address _account, uint256 _amount) external;


14          function bridgeBurn(address _account, uint256 _amount) external;


16          function l1Address() external view returns (address);


18          function l2Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L18:18

```solidity
File: contracts/zksync/contracts/interfaces/IPaymaster.sol


28          function validateAndPayForPaymasterTransaction(


43          function postTransaction(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymaster.sol#L43:43

```solidity
File: contracts/zksync/contracts/interfaces/IPaymasterFlow.sol


14          function general(bytes calldata input) external;


16          function approvalBased(address _token, uint256 _minAllowance, bytes calldata _innerInput) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymasterFlow.sol#L16:16

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


68          function _storeCodeHash(address _address, bytes32 _hash) internal {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L68:68

```solidity
File: system-contracts/contracts/ContractDeployer.sol


258         function _nonSystemDeployOnAddress(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L258:258

```solidity
File: system-contracts/contracts/DefaultAccount.sol


220         fallback() external payable ignoreInDelegateCall {


227         receive() external payable {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L227:227

```solidity
File: system-contracts/contracts/EmptyContract.sol


11          fallback() external payable {}


13          receive() external payable {}


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L13:13

```solidity
File: system-contracts/contracts/L1Messenger.sol


50          function keccakGasCost(uint256 _length) internal pure returns (uint256) {


61          function sha256GasCost(uint256 _length) internal pure returns (uint256) {


161         function requestBytecodeL1Publication(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L161:161

```solidity
File: system-contracts/contracts/L2BaseToken.sol


99          function _burnMsgValue() internal returns (uint256 amount) {


112         function _getL1WithdrawMessage(address _to, uint256 _amount) internal pure returns (bytes memory) {


117         function _getExtendedWithdrawMessage(


128         function name() external pure override returns (string memory) {


134         function symbol() external pure override returns (string memory) {


140         function decimals() external pure override returns (uint8) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L140:140

```solidity
File: system-contracts/contracts/SystemContext.sol


117         function getCurrentPubdataSpent() public view returns (uint256) {


122         function getCurrentPubdataCost() external view returns (uint256) {


482         function incrementTxNumberInBatch() external onlyCallFromBootloader {


486         function resetTxNumberInBatch() external onlyCallFromBootloader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L486:486

```solidity
File: system-contracts/contracts/interfaces/IAccount.sol


26          function executeTransaction(


34          function executeTransactionFromOutside(Transaction calldata _transaction) external payable;


36          function payForTransaction(


42          function prepareForPaymaster(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccount.sol#L42:42

```solidity
File: system-contracts/contracts/interfaces/IAccountCodeStorage.sol


6           function storeAccountConstructingCodeHash(address _address, bytes32 _hash) external;


8           function storeAccountConstructedCodeHash(address _address, bytes32 _hash) external;


10          function markAccountCodeHashAsConstructed(address _address) external;


12          function getRawCodeHash(address _address) external view returns (bytes32 codeHash);


14          function getCodeHash(uint256 _input) external view returns (bytes32 codeHash);


16          function getCodeSize(uint256 _input) external view returns (uint256 codeSize);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L16:16

```solidity
File: system-contracts/contracts/interfaces/IBaseToken.sol


6           function balanceOf(uint256) external view returns (uint256);


8           function transferFromTo(address _from, address _to, uint256 _amount) external;


10          function totalSupply() external view returns (uint256);


12          function name() external pure returns (string memory);


14          function symbol() external pure returns (string memory);


16          function decimals() external pure returns (uint8);


18          function mint(address _account, uint256 _amount) external;


20          function withdraw(address _l1Receiver) external payable;


22          function withdrawWithMessage(address _l1Receiver, bytes calldata _additionalData) external payable;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L22:22

```solidity
File: system-contracts/contracts/interfaces/IBootloaderUtilities.sol


8           function getTransactionHashes(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBootloaderUtilities.sol#L8:8

```solidity
File: system-contracts/contracts/interfaces/IComplexUpgrader.sol


11          function upgrade(address _delegateTo, bytes calldata _calldata) external payable;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IComplexUpgrader.sol#L11:11

```solidity
File: system-contracts/contracts/interfaces/ICompressor.sol


19          function publishCompressedBytecode(


24          function verifyCompressedStateDiffs(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ICompressor.sol#L24:24

```solidity
File: system-contracts/contracts/interfaces/IContractDeployer.sol


43          function getNewAddressCreate2(


50          function getNewAddressCreate(address _sender, uint256 _senderNonce) external pure returns (address newAddress);


52          function create2(


58          function create2Account(


68          function create(


76          function createAccount(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L76:76

```solidity
File: system-contracts/contracts/interfaces/IImmutableSimulator.sol


11          function getImmutable(address _dest, uint256 _index) external view returns (bytes32);


13          function setImmutables(address _dest, ImmutableData[] calldata _immutables) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L13:13

```solidity
File: system-contracts/contracts/interfaces/IKnownCodesStorage.sol


14          function markFactoryDeps(bool _shouldSendToL1, bytes32[] calldata _hashes) external;


16          function markBytecodeAsPublished(bytes32 _bytecodeHash) external;


18          function getMarker(bytes32 _hash) external view returns (uint256);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IKnownCodesStorage.sol#L18:18

```solidity
File: system-contracts/contracts/interfaces/IL1Messenger.sol


49          function sendToL1(bytes memory _message) external returns (bytes32);


51          function sendL2ToL1Log(bool _isService, bytes32 _key, bytes32 _value) external returns (uint256 logIdInMerkleTree);


54          function requestBytecodeL1Publication(bytes32 _bytecodeHash) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L54:54

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


10          function bridgeMint(address _account, uint256 _amount) external;


12          function bridgeBurn(address _account, uint256 _amount) external;


14          function l1Address() external view returns (address);


16          function l2Bridge() external view returns (address);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L16:16

```solidity
File: system-contracts/contracts/interfaces/IMailbox.sol


6           function finalizeEthWithdrawal(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IMailbox.sol#L6:6

```solidity
File: system-contracts/contracts/interfaces/INonceHolder.sol


17          function getMinNonce(address _address) external view returns (uint256);


21          function getRawNonce(address _address) external view returns (uint256);


24          function increaseMinNonce(uint256 _value) external returns (uint256);


27          function setValueUnderNonce(uint256 _key, uint256 _value) external;


30          function getValueUnderNonce(uint256 _key) external view returns (uint256);


34          function incrementMinNonceIfEquals(uint256 _expectedNonce) external;


37          function getDeploymentNonce(address _address) external view returns (uint256);


40          function incrementDeploymentNonce(address _address) external returns (uint256);


43          function validateNonceUsage(address _address, uint256 _key, bool _shouldBeUsed) external view;


46          function isNonceUsed(address _address, uint256 _nonce) external view returns (bool);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L46:46

```solidity
File: system-contracts/contracts/interfaces/IPaymaster.sol


28          function validateAndPayForPaymasterTransaction(


43          function postTransaction(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L43:43

```solidity
File: system-contracts/contracts/interfaces/IPaymasterFlow.sol


13          function general(bytes calldata input) external;


15          function approvalBased(address _token, uint256 _minAllowance, bytes calldata _innerInput) external;


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymasterFlow.sol#L15:15

```solidity
File: system-contracts/contracts/interfaces/ISystemContext.sol


30          function chainId() external view returns (uint256);


32          function origin() external view returns (address);


34          function gasPrice() external view returns (uint256);


36          function blockGasLimit() external view returns (uint256);


38          function coinbase() external view returns (address);


40          function difficulty() external view returns (uint256);


42          function baseFee() external view returns (uint256);


44          function txNumberInBlock() external view returns (uint16);


46          function getBlockHashEVM(uint256 _block) external view returns (bytes32);


48          function getBatchHash(uint256 _batchNumber) external view returns (bytes32 hash);


50          function getBlockNumber() external view returns (uint128);


52          function getBlockTimestamp() external view returns (uint128);


54          function getBatchNumberAndTimestamp() external view returns (uint128 blockNumber, uint128 blockTimestamp);


56          function getL2BlockNumberAndTimestamp() external view returns (uint128 blockNumber, uint128 blockTimestamp);


58          function gasPerPubdataByte() external view returns (uint256 gasPerPubdataByte);


60          function getCurrentPubdataSpent() external view returns (uint256 currentPubdataSpent);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L60:60

```solidity
File: system-contracts/contracts/interfaces/ISystemContextDeprecated.sol


11          function currentBlockInfo() external view returns (uint256);


13          function getBlockNumberAndTimestamp() external view returns (uint256 blockNumber, uint256 blockTimestamp);


15          function blockHash(uint256 _blockNumber) external view returns (bytes32 hash);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContextDeprecated.sol#L15:15

```solidity
File: system-contracts/contracts/libraries/EfficientCall.sol


215         function _verifyCallResult(bool _success) private pure returns (bytes memory returnData) {


232         function propagateRevert() internal pure {


245         function _loadFarCallABIIntoActivePtr(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L245:245

```solidity
File: system-contracts/contracts/libraries/RLPEncoder.sol


11          function encodeAddress(address _val) internal pure returns (bytes memory encoded) {


24          function encodeUint256(uint256 _val) internal pure returns (bytes memory encoded) {


60          function _encodeLength(uint64 _len, uint256 _offset) private pure returns (bytes memory encoded) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L60:60

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


405         function totalRequiredBalance(Transaction calldata _transaction) internal pure returns (uint256 requiredBalance) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L405:405

```solidity
File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol


19          function readUint16(bytes calldata _bytes, uint256 _start) internal pure returns (uint16 result) {


26          function readUint32(bytes calldata _bytes, uint256 _start) internal pure returns (uint32 result) {


33          function readUint64(bytes calldata _bytes, uint256 _start) internal pure returns (uint64 result) {


40          function readBytes32(bytes calldata _bytes, uint256 _start) internal pure returns (bytes32 result) {


46          function readUint256(bytes calldata _bytes, uint256 _start) internal pure returns (uint256 result) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L46:46

```solidity
File: system-contracts/contracts/libraries/Utils.sol


20          function safeCastToU128(uint256 _x) internal pure returns (uint128) {


26          function safeCastToU32(uint256 _x) internal pure returns (uint32) {


32          function safeCastToU24(uint256 _x) internal pure returns (uint24) {


39          function bytecodeLenInBytes(bytes32 _bytecodeHash) internal pure returns (uint256 codeLength) {


44          function bytecodeLenInWords(bytes32 _bytecodeHash) internal pure returns (uint256 codeLengthInWords) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L44:44

</details>

## NC094 - Interface declarations should have NatSpec @title annotations:

A title that should describe the contract/interface


<details>
<summary>Click to show 36 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol


6       interface IL2Bridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L6:6

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol


4       interface IWETH9 {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol#L4:4

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


42      interface IBridgehub {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L42:42

```solidity
File: contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol


9       interface IL2ContractDeployer {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol#L9:9

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


26      interface IStateTransitionManager {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L26:26

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol


61      interface IDiamondInit {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L61:61

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol


11      interface ILegacyGetters is IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol#L11:11

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol


15      interface IZkSyncStateTransition is IAdmin, IExecutor, IGetters, IMailbox {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol#L15:15

```solidity
File: contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol


4       interface ISystemContext {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol#L4:4

```solidity
File: contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol


7       interface IDefaultUpgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol#L7:7

```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


18      interface IL2Messenger {


30      interface IContractDeployer {


61      interface IBaseToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L61:61

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol


8       interface IL1ERC20Bridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L8:8

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol


6       interface IL2SharedBridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L6:6

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol


5       interface IL2StandardToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L5:5

```solidity
File: contracts/zksync/contracts/interfaces/IPaymaster.sol


14      interface IPaymaster {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymaster.sol#L14:14

```solidity
File: contracts/zksync/contracts/interfaces/IPaymasterFlow.sol


13      interface IPaymasterFlow {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymasterFlow.sol#L13:13

```solidity
File: system-contracts/contracts/interfaces/IAccount.sol


9       interface IAccount {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccount.sol#L9:9

```solidity
File: system-contracts/contracts/interfaces/IAccountCodeStorage.sol


5       interface IAccountCodeStorage {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IBaseToken.sol


5       interface IBaseToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IBootloaderUtilities.sol


7       interface IBootloaderUtilities {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBootloaderUtilities.sol#L7:7

```solidity
File: system-contracts/contracts/interfaces/IComplexUpgrader.sol


10      interface IComplexUpgrader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IComplexUpgrader.sol#L10:10

```solidity
File: system-contracts/contracts/interfaces/ICompressor.sol


18      interface ICompressor {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ICompressor.sol#L18:18

```solidity
File: system-contracts/contracts/interfaces/IContractDeployer.sol


5       interface IContractDeployer {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IImmutableSimulator.sol


10      interface IImmutableSimulator {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L10:10

```solidity
File: system-contracts/contracts/interfaces/IKnownCodesStorage.sol


11      interface IKnownCodesStorage {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IKnownCodesStorage.sol#L11:11

```solidity
File: system-contracts/contracts/interfaces/IL1Messenger.sol


40      interface IL1Messenger {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L40:40

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


5       interface IL2StandardToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IMailbox.sol


5       interface IMailbox {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IMailbox.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/INonceHolder.sol


13      interface INonceHolder {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L13:13

```solidity
File: system-contracts/contracts/interfaces/IPaymaster.sol


14      interface IPaymaster {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L14:14

```solidity
File: system-contracts/contracts/interfaces/IPaymasterFlow.sol


12      interface IPaymasterFlow {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymasterFlow.sol#L12:12

```solidity
File: system-contracts/contracts/interfaces/IPubdataChunkPublisher.sol


9       interface IPubdataChunkPublisher {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPubdataChunkPublisher.sol#L9:9

```solidity
File: system-contracts/contracts/interfaces/ISystemContext.sol


11      interface ISystemContext {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L11:11

```solidity
File: system-contracts/contracts/interfaces/ISystemContextDeprecated.sol


10      interface ISystemContextDeprecated {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContextDeprecated.sol#L10:10

</details>

## NC095 - Interface declarations should have NatSpec @author annotations:

The name of the author


<details>
<summary>Click to show 18 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol


4       interface IWETH9 {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol#L4:4

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


42      interface IBridgehub {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L42:42

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


26      interface IStateTransitionManager {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L26:26

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol


61      interface IDiamondInit {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L61:61

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol


15      interface IZkSyncStateTransition is IAdmin, IExecutor, IGetters, IMailbox {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol#L15:15

```solidity
File: contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol


4       interface ISystemContext {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol#L4:4

```solidity
File: contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol


7       interface IDefaultUpgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol#L7:7

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol


5       interface IL2StandardToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L5:5

```solidity
File: contracts/zksync/contracts/interfaces/IPaymaster.sol


14      interface IPaymaster {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymaster.sol#L14:14

```solidity
File: system-contracts/contracts/interfaces/IAccount.sol


9       interface IAccount {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccount.sol#L9:9

```solidity
File: system-contracts/contracts/interfaces/IAccountCodeStorage.sol


5       interface IAccountCodeStorage {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IBaseToken.sol


5       interface IBaseToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IBootloaderUtilities.sol


7       interface IBootloaderUtilities {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBootloaderUtilities.sol#L7:7

```solidity
File: system-contracts/contracts/interfaces/IContractDeployer.sol


5       interface IContractDeployer {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IImmutableSimulator.sol


10      interface IImmutableSimulator {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L10:10

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


5       interface IL2StandardToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IMailbox.sol


5       interface IMailbox {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IMailbox.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IPaymaster.sol


14      interface IPaymaster {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L14:14

</details>

## NC096 - Interface declarations should have NatSpec @notice annotations:

Explain to an end user what this does


<details>
<summary>Click to show 32 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol


12      interface IL1SharedBridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L12:12

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol


6       interface IL2Bridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L6:6

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol


4       interface IWETH9 {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol#L4:4

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


42      interface IBridgehub {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L42:42

```solidity
File: contracts/ethereum/contracts/governance/IGovernance.sol


8       interface IGovernance {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L8:8

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


26      interface IStateTransitionManager {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L26:26

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol


13      interface IAdmin is IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L13:13

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol


61      interface IDiamondInit {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L61:61

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol


73      interface IExecutor is IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L73:73

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol


13      interface IGetters is IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L13:13

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol


11      interface ILegacyGetters is IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol#L11:11

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol


11      interface IMailbox is IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L11:11

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol


15      interface IVerifier {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol#L15:15

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol


15      interface IZkSyncStateTransition is IAdmin, IExecutor, IGetters, IMailbox {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol#L15:15

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol


7       interface IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol#L7:7

```solidity
File: contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol


4       interface ISystemContext {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol#L4:4

```solidity
File: contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol


7       interface IDefaultUpgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol#L7:7

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol


8       interface IL1ERC20Bridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L8:8

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol


8       interface IL1SharedBridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol#L8:8

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol


6       interface IL2SharedBridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L6:6

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol


5       interface IL2StandardToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L5:5

```solidity
File: contracts/zksync/contracts/interfaces/IPaymaster.sol


14      interface IPaymaster {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymaster.sol#L14:14

```solidity
File: system-contracts/contracts/interfaces/IAccount.sol


9       interface IAccount {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccount.sol#L9:9

```solidity
File: system-contracts/contracts/interfaces/IAccountCodeStorage.sol


5       interface IAccountCodeStorage {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IBaseToken.sol


5       interface IBaseToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IBootloaderUtilities.sol


7       interface IBootloaderUtilities {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBootloaderUtilities.sol#L7:7

```solidity
File: system-contracts/contracts/interfaces/IContractDeployer.sol


5       interface IContractDeployer {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IImmutableSimulator.sol


10      interface IImmutableSimulator {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L10:10

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


5       interface IL2StandardToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IMailbox.sol


5       interface IMailbox {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IMailbox.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/INonceHolder.sol


13      interface INonceHolder {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L13:13

```solidity
File: system-contracts/contracts/interfaces/IPaymaster.sol


14      interface IPaymaster {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L14:14

</details>

## NC097 - Interface declarations should have NatSpec @dev annotations:

Explain to a developer any extra details


<details>
<summary>Click to show 41 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol


11      interface IL1ERC20Bridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L11:11

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol


12      interface IL1SharedBridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L12:12

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol


6       interface IL2Bridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L6:6

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol


4       interface IWETH9 {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol#L4:4

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


42      interface IBridgehub {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L42:42

```solidity
File: contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol


9       interface IL2ContractDeployer {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol#L9:9

```solidity
File: contracts/ethereum/contracts/governance/IGovernance.sol


8       interface IGovernance {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L8:8

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


26      interface IStateTransitionManager {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L26:26

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol


13      interface IAdmin is IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L13:13

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol


61      interface IDiamondInit {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L61:61

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol


73      interface IExecutor is IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L73:73

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol


13      interface IGetters is IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L13:13

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol


11      interface IMailbox is IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L11:11

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol


15      interface IVerifier {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol#L15:15

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol


15      interface IZkSyncStateTransition is IAdmin, IExecutor, IGetters, IMailbox {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol#L15:15

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol


7       interface IZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol#L7:7

```solidity
File: contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol


4       interface ISystemContext {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol#L4:4

```solidity
File: contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol


7       interface IDefaultUpgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol#L7:7

```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


30      interface IContractDeployer {


61      interface IBaseToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L61:61

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol


8       interface IL1ERC20Bridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L8:8

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol


8       interface IL1SharedBridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol#L8:8

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol


6       interface IL2SharedBridge {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L6:6

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol


5       interface IL2StandardToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L5:5

```solidity
File: contracts/zksync/contracts/interfaces/IPaymaster.sol


14      interface IPaymaster {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymaster.sol#L14:14

```solidity
File: system-contracts/contracts/interfaces/IAccount.sol


9       interface IAccount {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccount.sol#L9:9

```solidity
File: system-contracts/contracts/interfaces/IAccountCodeStorage.sol


5       interface IAccountCodeStorage {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IBaseToken.sol


5       interface IBaseToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IBootloaderUtilities.sol


7       interface IBootloaderUtilities {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBootloaderUtilities.sol#L7:7

```solidity
File: system-contracts/contracts/interfaces/IComplexUpgrader.sol


10      interface IComplexUpgrader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IComplexUpgrader.sol#L10:10

```solidity
File: system-contracts/contracts/interfaces/ICompressor.sol


18      interface ICompressor {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ICompressor.sol#L18:18

```solidity
File: system-contracts/contracts/interfaces/IContractDeployer.sol


5       interface IContractDeployer {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IImmutableSimulator.sol


10      interface IImmutableSimulator {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L10:10

```solidity
File: system-contracts/contracts/interfaces/IKnownCodesStorage.sol


11      interface IKnownCodesStorage {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IKnownCodesStorage.sol#L11:11

```solidity
File: system-contracts/contracts/interfaces/IL1Messenger.sol


40      interface IL1Messenger {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L40:40

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


5       interface IL2StandardToken {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IMailbox.sol


5       interface IMailbox {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IMailbox.sol#L5:5

```solidity
File: system-contracts/contracts/interfaces/IPaymaster.sol


14      interface IPaymaster {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L14:14

```solidity
File: system-contracts/contracts/interfaces/IPubdataChunkPublisher.sol


9       interface IPubdataChunkPublisher {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPubdataChunkPublisher.sol#L9:9

```solidity
File: system-contracts/contracts/interfaces/ISystemContext.sol


11      interface ISystemContext {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L11:11

```solidity
File: system-contracts/contracts/interfaces/ISystemContextDeprecated.sol


10      interface ISystemContextDeprecated {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContextDeprecated.sol#L10:10

</details>

## NC098 - Abstract contract declarations should have NatSpec @title annotations:

A title that should describe the contract/interface


<details>
<summary>Click to show 4 findings</summary>

```solidity
File: contracts/ethereum/contracts/common/ReentrancyGuard.sol


25      abstract contract ReentrancyGuard {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L25:25

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


44      abstract contract BaseZkSyncUpgrade is ZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L44:44

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol


17      abstract contract BaseZkSyncUpgradeGenesis is BaseZkSyncUpgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L17:17

```solidity
File: system-contracts/contracts/interfaces/ISystemContract.sol


17      abstract contract ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L17:17

</details>

## NC099 - Abstract contract declarations should have NatSpec @author annotations:

The name of the author


```solidity
File: contracts/ethereum/contracts/common/ReentrancyGuard.sol


25      abstract contract ReentrancyGuard {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L25:25

## NC100 - Abstract contract declarations should have NatSpec @notice annotations:

Explain to an end user what this does


```solidity
File: contracts/ethereum/contracts/common/ReentrancyGuard.sol


25      abstract contract ReentrancyGuard {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L25:25

## NC101 - Abstract contract declarations should have Natspec @dev annotations:

Explain to a developer any extra details


```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol


44      abstract contract BaseZkSyncUpgrade is ZkSyncStateTransitionBase {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L44:44

```solidity
File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol


17      abstract contract BaseZkSyncUpgradeGenesis is BaseZkSyncUpgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L17:17

## NC102 - Library declarations should have Natspec @title annotations:

A title that should describe the contract/interface


<details>
<summary>Click to show 19 findings</summary>

```solidity
File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol


10      library L2ContractHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L10:10

```solidity
File: contracts/ethereum/contracts/common/libraries/UncheckedMath.sol


10      library UncheckedMath {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UncheckedMath.sol#L10:10

```solidity
File: contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol


18      library UnsafeBytes {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L18:18

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


11      library Diamond {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L11:11

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/LibMap.sol


8       library LibMap {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L8:8

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol


9       library Merkle {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L9:9

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol


20      library PriorityQueue {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L20:20

```solidity
File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol


21      library AddressAliasHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L21:21

```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


83      library L2ContractHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L83:83

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


26      library Utils {


36      library SystemContractsCaller {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L36:36

```solidity
File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol


21      library AddressAliasHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L21:21

```solidity
File: system-contracts/contracts/libraries/EfficientCall.sol


32      library EfficientCall {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L32:32

```solidity
File: system-contracts/contracts/libraries/RLPEncoder.sol


10      library RLPEncoder {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L10:10

```solidity
File: system-contracts/contracts/libraries/SystemContractHelper.sol


41      library SystemContractHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L41:41

```solidity
File: system-contracts/contracts/libraries/SystemContractsCaller.sol


68      library SystemContractsCaller {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L68:68

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


78      library TransactionHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L78:78

```solidity
File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol


18      library UnsafeBytesCalldata {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L18:18

```solidity
File: system-contracts/contracts/libraries/Utils.sol


11      library Utils {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L11:11

</details>

## NC103 - Library declarations should have Natspec @author annotations:

The name of the author


<details>
<summary>Click to show 4 findings</summary>

```solidity
File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol


21      library AddressAliasHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L21:21

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


26      library Utils {


36      library SystemContractsCaller {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L36:36

```solidity
File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol


21      library AddressAliasHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L21:21

</details>

## NC104 - Library declarations should have Natspec @notice annotations:

Explain to an end user what this does


<details>
<summary>Click to show 9 findings</summary>

```solidity
File: contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol


18      library UnsafeBytes {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L18:18

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol


9       library Merkle {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L9:9

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol


20      library PriorityQueue {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol


13      library TransactionValidator {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L13:13

```solidity
File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol


21      library AddressAliasHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L21:21

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


26      library Utils {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L26:26

```solidity
File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol


21      library AddressAliasHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L21:21

```solidity
File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol


18      library UnsafeBytesCalldata {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L18:18

```solidity
File: system-contracts/contracts/libraries/Utils.sol


11      library Utils {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L11:11

</details>

## NC105 - Library declarations should have Natspec @dev annotations:

Explain to a developer any extra details


<details>
<summary>Click to show 11 findings</summary>

```solidity
File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol


10      library L2ContractHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L10:10

```solidity
File: contracts/ethereum/contracts/common/libraries/UncheckedMath.sol


10      library UncheckedMath {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UncheckedMath.sol#L10:10

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


11      library Diamond {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L11:11

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol


9       library Merkle {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L9:9

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol


13      library TransactionValidator {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L13:13

```solidity
File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol


21      library AddressAliasHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L21:21

```solidity
File: contracts/zksync/contracts/L2ContractHelper.sol


83      library L2ContractHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L83:83

```solidity
File: contracts/zksync/contracts/SystemContractsCaller.sol


26      library Utils {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L26:26

```solidity
File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol


21      library AddressAliasHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L21:21

```solidity
File: system-contracts/contracts/libraries/RLPEncoder.sol


10      library RLPEncoder {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L10:10

```solidity
File: system-contracts/contracts/libraries/TransactionHelper.sol


78      library TransactionHelper {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L78:78

</details>

## NC106 - Modifier definitions should have Natspec @notice annotations:

Explain to an end user what this does


<details>
<summary>Click to show 15 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


45          modifier onlyOwnerOrAdmin() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L45:45

```solidity
File: contracts/ethereum/contracts/common/ReentrancyGuard.sol


41          modifier reentrancyGuardInitializer() {


68          modifier nonReentrant() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L68:68

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol


26          modifier onlyStateTransitionManager() {


31          modifier onlyBridgehub() {


36          modifier onlyAdminOrStateTransitionManager() {


44          modifier onlyValidatorOrStateTransitionManager() {


52          modifier onlyBaseTokenBridge() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L52:52

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


129         modifier onlyBridge() {


134         modifier onlyNextVersion(uint8 _version) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L134:134

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


25          modifier onlyDeployer() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L25:25

```solidity
File: system-contracts/contracts/ContractDeployer.sol


28          modifier onlySelf() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L28:28

```solidity
File: system-contracts/contracts/DefaultAccount.sol


28          modifier ignoreNonBootloader() {


45          modifier ignoreInDelegateCall() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L45:45

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


19          modifier onlyCompressor() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L19:19

</details>

## NC107 - Modifier definitions should have Natspec @dev annotations:

Explain to a developer any extra details


<details>
<summary>Click to show 29 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


68          modifier onlyBridgehub() {


74          modifier onlyBridgehubOrEra(uint256 _chainId) {


83          modifier onlyLegacyBridge() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L83:83

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


45          modifier onlyOwnerOrAdmin() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L45:45

```solidity
File: contracts/ethereum/contracts/common/ReentrancyGuard.sol


41          modifier reentrancyGuardInitializer() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L41:41

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


58          modifier onlySelf() {


64          modifier onlySecurityCouncil() {


70          modifier onlyOwnerOrSecurityCouncil() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L70:70

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


63          modifier onlyBridgehub() {


69          modifier onlyOwnerOrAdmin() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L69:69

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


61          modifier onlyChainAdmin(uint256 _chainId) {


67          modifier onlyValidator(uint256 _chainId) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L67:67

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol


15          modifier onlyAdmin() {


21          modifier onlyValidator() {


26          modifier onlyStateTransitionManager() {


31          modifier onlyBridgehub() {


36          modifier onlyAdminOrStateTransitionManager() {


44          modifier onlyValidatorOrStateTransitionManager() {


52          modifier onlyBaseTokenBridge() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L52:52

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


129         modifier onlyBridge() {


134         modifier onlyNextVersion(uint8 _version) {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L134:134

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


25          modifier onlyDeployer() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L25:25

```solidity
File: system-contracts/contracts/ContractDeployer.sol


28          modifier onlySelf() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L28:28

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


19          modifier onlyCompressor() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L19:19

```solidity
File: system-contracts/contracts/interfaces/ISystemContract.sol


20          modifier onlySystemCall() {


30          modifier onlyCallFromSystemContract() {


40          modifier onlyCallFrom(address caller) {


47          modifier onlyCallFromBootloader() {


54          modifier onlyCallFromForceDeployer() {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L54:54

</details>

## NC108 - Contract definitions should have Natspec @title annotations:

 title that should describe the contract


<details>
<summary>Click to show 27 findings</summary>

```solidity
File: contracts/GasBoundCaller.sol


15      contract GasBoundCaller {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L15:15

```solidity
File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol


19      contract L1ERC20Bridge is IL1ERC20Bridge, ReentrancyGuard {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L19:19

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


30      contract L1SharedBridge is IL1SharedBridge, ReentrancyGuard, Initializable, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L30:30

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


16      contract Bridgehub is IBridgehub, ReentrancyGuard, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L16:16

```solidity
File: contracts/ethereum/contracts/governance/Governance.sol


20      contract Governance is IGovernance, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol


22      contract ValidatorTimelock is IExecutor, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L22:22

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


17      contract DiamondInit is ZkSyncStateTransitionBase, IDiamondInit {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L17:17

```solidity
File: contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol


10      contract DefaultUpgrade is BaseZkSyncUpgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol#L10:10

```solidity
File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol


11      contract GenesisUpgrade is BaseZkSyncUpgradeGenesis {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L11:11

```solidity
File: contracts/zksync/contracts/ForceDeployUpgrader.sol


10      contract ForceDeployUpgrader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/ForceDeployUpgrader.sol#L10:10

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


23      contract L2SharedBridge is IL2SharedBridge, Initializable {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L23:23

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


15      contract L2StandardERC20 is ERC20PermitUpgradeable, IL2StandardToken, ERC1967Upgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L15:15

```solidity
File: system-contracts/contracts/AccountCodeStorage.sol


22      contract AccountCodeStorage is IAccountCodeStorage {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L22:22

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


16      contract BootloaderUtilities is IBootloaderUtilities {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L16:16

```solidity
File: system-contracts/contracts/ComplexUpgrader.sol


14      contract ComplexUpgrader is IComplexUpgrader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L14:14

```solidity
File: system-contracts/contracts/Compressor.sol


22      contract Compressor is ICompressor, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L22:22

```solidity
File: system-contracts/contracts/ContractDeployer.sol


23      contract ContractDeployer is IContractDeployer, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L23:23

```solidity
File: system-contracts/contracts/DefaultAccount.sol


19      contract DefaultAccount is IAccount {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L19:19

```solidity
File: system-contracts/contracts/EmptyContract.sol


10      contract EmptyContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L10:10

```solidity
File: system-contracts/contracts/ImmutableSimulator.sol


18      contract ImmutableSimulator is IImmutableSimulator {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L18:18

```solidity
File: system-contracts/contracts/KnownCodesStorage.sol


18      contract KnownCodesStorage is IKnownCodesStorage, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L18:18

```solidity
File: system-contracts/contracts/L1Messenger.sol


25      contract L1Messenger is IL1Messenger, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L25:25

```solidity
File: system-contracts/contracts/L2BaseToken.sol


18      contract L2BaseToken is IBaseToken, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L18:18

```solidity
File: system-contracts/contracts/MsgValueSimulator.sol


19      contract MsgValueSimulator is ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L19:19

```solidity
File: system-contracts/contracts/NonceHolder.sol


27      contract NonceHolder is INonceHolder, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L27:27

```solidity
File: system-contracts/contracts/PubdataChunkPublisher.sol


16      contract PubdataChunkPublisher is IPubdataChunkPublisher, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L16:16

```solidity
File: system-contracts/contracts/SystemContext.sol


17      contract SystemContext is ISystemContext, ISystemContextDeprecated, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L17:17

</details>

## NC109 - Contract definitions should have Natspec @author annotations:

The name of the author


```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


16      contract Bridgehub is IBridgehub, ReentrancyGuard, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L16:16

```solidity
File: contracts/zksync/contracts/ForceDeployUpgrader.sol


10      contract ForceDeployUpgrader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/ForceDeployUpgrader.sol#L10:10

## NC110 - Contract definitions should have Natspec @notice annotations:

Explain to an end user what this does


<details>
<summary>Click to show 12 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol


30      contract L1SharedBridge is IL1SharedBridge, ReentrancyGuard, Initializable, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L30:30

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


16      contract Bridgehub is IBridgehub, ReentrancyGuard, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L16:16

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


25      contract StateTransitionManager is IStateTransitionManager, ReentrancyGuard, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L25:25

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol


17      contract DiamondInit is ZkSyncStateTransitionBase, IDiamondInit {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L17:17

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol


10      contract DiamondProxy {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L10:10

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


18      contract AdminFacet is ZkSyncStateTransitionBase, IAdmin {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L18:18

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


22      contract ExecutorFacet is ZkSyncStateTransitionBase, IExecutor {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L22:22

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


20      contract GettersFacet is ZkSyncStateTransitionBase, IGetters, ILegacyGetters {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


30      contract MailboxFacet is ZkSyncStateTransitionBase, IMailbox {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L30:30

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol


11      contract ZkSyncStateTransitionBase is ReentrancyGuard {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L11:11

```solidity
File: contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol


10      contract DefaultUpgrade is BaseZkSyncUpgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol#L10:10

```solidity
File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol


11      contract GenesisUpgrade is BaseZkSyncUpgradeGenesis {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L11:11

</details>

## NC111 - Contract definitions should have Natspec @dev annotations:

Explain to a developer any extra details


<details>
<summary>Click to show 18 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol


16      contract Bridgehub is IBridgehub, ReentrancyGuard, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L16:16

```solidity
File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol


25      contract StateTransitionManager is IStateTransitionManager, ReentrancyGuard, Ownable2Step {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L25:25

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol


10      contract DiamondProxy {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L10:10

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol


18      contract AdminFacet is ZkSyncStateTransitionBase, IAdmin {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L18:18

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol


22      contract ExecutorFacet is ZkSyncStateTransitionBase, IExecutor {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L22:22

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol


20      contract GettersFacet is ZkSyncStateTransitionBase, IGetters, ILegacyGetters {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L20:20

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol


30      contract MailboxFacet is ZkSyncStateTransitionBase, IMailbox {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L30:30

```solidity
File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol


11      contract ZkSyncStateTransitionBase is ReentrancyGuard {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L11:11

```solidity
File: contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol


10      contract DefaultUpgrade is BaseZkSyncUpgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol#L10:10

```solidity
File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol


11      contract GenesisUpgrade is BaseZkSyncUpgradeGenesis {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L11:11

```solidity
File: contracts/zksync/contracts/ForceDeployUpgrader.sol


10      contract ForceDeployUpgrader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/ForceDeployUpgrader.sol#L10:10

```solidity
File: contracts/zksync/contracts/bridge/L2SharedBridge.sol


23      contract L2SharedBridge is IL2SharedBridge, Initializable {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L23:23

```solidity
File: contracts/zksync/contracts/bridge/L2StandardERC20.sol


15      contract L2StandardERC20 is ERC20PermitUpgradeable, IL2StandardToken, ERC1967Upgrade {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L15:15

```solidity
File: system-contracts/contracts/BootloaderUtilities.sol


16      contract BootloaderUtilities is IBootloaderUtilities {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L16:16

```solidity
File: system-contracts/contracts/ComplexUpgrader.sol


14      contract ComplexUpgrader is IComplexUpgrader {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L14:14

```solidity
File: system-contracts/contracts/EmptyContract.sol


10      contract EmptyContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L10:10

```solidity
File: system-contracts/contracts/PubdataChunkPublisher.sol


16      contract PubdataChunkPublisher is IPubdataChunkPublisher, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L16:16

```solidity
File: system-contracts/contracts/SystemContext.sol


17      contract SystemContext is ISystemContext, ISystemContextDeprecated, ISystemContract {


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L17:17

</details>

## NC112 - Event definitions should have Natspec @notice annotations:

Explain to an end user what this does


<details>
<summary>Click to show 34 findings</summary>

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol


12          event DepositInitiated(


20          event WithdrawalFinalized(address indexed to, address indexed l1Token, uint256 amount);


22          event ClaimedFailedDeposit(address indexed to, address indexed l1Token, uint256 amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L22:22

```solidity
File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol


13          event LegacyDepositInitiated(


22          event BridgehubDepositInitiated(


31          event BridgehubDepositBaseTokenInitiated(


38          event BridgehubDepositFinalized(


44          event WithdrawalFinalizedSharedBridge(


51          event ClaimedFailedDepositSharedBridge(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L51:51

```solidity
File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol


133         event NewChain(uint256 indexed chainId, address stateTransitionManager, address indexed chainGovernance);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L133:133

```solidity
File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol


28          event StateTransitionNewChain(uint256 indexed _chainId, address indexed _stateTransitionContract);


30          event SetChainIdUpgrade(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L30:30

```solidity
File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol


17          event ProposeTransparentUpgrade(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol#L17:17

```solidity
File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol


24          event DiamondCut(FacetCut[] facetCuts, address initAddress, bytes initCalldata);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L24:24

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol


7           event FinalizeDeposit(


14          event WithdrawalInitiated(


22          event BaseTokenReceived(uint256 amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L22:22

```solidity
File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol


6           event BridgeInitialize(address indexed l1Token, string name, string symbol, uint8 decimals);


8           event BridgeMint(address indexed _account, uint256 _amount);


10          event BridgeBurn(address indexed _account, uint256 _amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L10:10

```solidity
File: system-contracts/contracts/interfaces/IBaseToken.sol


24          event Mint(address indexed account, uint256 amount);


26          event Transfer(address indexed from, address indexed to, uint256 value);


28          event Withdrawal(address indexed _l2Sender, address indexed _l1Receiver, uint256 _amount);


30          event WithdrawalWithMessage(


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L30:30

```solidity
File: system-contracts/contracts/interfaces/IContractDeployer.sol


33          event ContractDeployed(


39          event AccountNonceOrderingUpdated(address indexed accountAddress, AccountNonceOrdering nonceOrdering);


41          event AccountVersionUpdated(address indexed accountAddress, AccountAbstractionVersion aaVersion);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L41:41

```solidity
File: system-contracts/contracts/interfaces/IKnownCodesStorage.sol


12          event MarkedAsKnown(bytes32 indexed bytecodeHash, bool indexed sendBytecodeToL1);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IKnownCodesStorage.sol#L12:12

```solidity
File: system-contracts/contracts/interfaces/IL1Messenger.sol


43          event L1MessageSent(address indexed _sender, bytes32 indexed _hash, bytes _message);


45          event L2ToL1LogSent(L2ToL1Log _l2log);


47          event BytecodeL1PublicationRequested(bytes32 _bytecodeHash);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L47:47

```solidity
File: system-contracts/contracts/interfaces/IL2StandardToken.sol


6           event BridgeMint(address indexed _account, uint256 _amount);


8           event BridgeBurn(address indexed _account, uint256 _amount);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L8:8

```solidity
File: system-contracts/contracts/interfaces/INonceHolder.sol


14          event ValueSetUnderNonce(address indexed accountAddress, uint256 indexed key, uint256 value);


```

https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L14:14

</details>



















