|Number|Issue|Instances|Estimated Gas Saved|
|-|:-|:-:|:-:|
| [GAS&#x2011;1](#GAS1--has-the-same-value-as-new-bytes0-but-costs-less-gas) | `""` has the same value as `new bytes(0)` but costs less gas | 8 | 1,280 |
| [GAS&#x2011;2](#GAS2-++i-costs-less-gas-than-i++/i-+=-1-same-for---i-vs-i--/i--+-1) | `++i` costs less gas than `i++`/`i += 1` (same for `--i` vs `i--`/`i -+ 1`) | 13 | 105 |
| [GAS&#x2011;3](#GAS3-++i/i++-should-be-unchecked-when-it-is-not-possible-for-them-to-overflow) | `++i`/`i++` should be `unchecked` when it is not possible for them to overflow | 12 | 720 |
| [GAS&#x2011;4](#GAS4->=/<=-costs-less-gas-than->/<) | `>=`/`<=` costs less gas than `>`/`<` | 97 | 291 |
| [GAS&#x2011;5](#GAS5-abiencode-is-less-efficient-than-abiencodepacked) | `abi.encode()` is less efficient than `abi.encodePacked()` | 34 | - |
| [GAS&#x2011;6](#GAS6-add-unchecked-{}-for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement) | Add `unchecked {}` for subtractions where the operands cannot underflow because of a previous `require()` or `if-statement` | 3 | 180 |
| [GAS&#x2011;7](#GAS7-addressthis-should-be-cached-when-used-multiple-times) | `address(this)` should be cached when used multiple times | 2 | - |
| [GAS&#x2011;8](#GAS8-alternative-solady-library-can-be-used-instead-of-openzeppelin-to-save-gas) | Alternative Solady library can be used instead of OpenZeppelin to save gas | 8 | 8,000 |
| [GAS&#x2011;9](#GAS9-arr[index]-+=-amount-is-cheaper-than-arr[index]-=-arr[index]-+-amount) | `arr[index] += amount` is cheaper than `arr[index] = arr[index] + amount` | 1 | - |
| [GAS&#x2011;10](#GAS10-assembly-let-var-only-used-on-once) | Assembly let var only used on once | 8 | - |
| [GAS&#x2011;11](#GAS11-assigning-state-variables-directly-with-named-struct-constructors-wastes-gas) | Assigning state variables directly with named struct constructors wastes gas | 15 | 420 |
| [GAS&#x2011;12](#GAS12-avoid-contract-existence-checks-by-using-low-level-calls) | Avoid contract existence checks by using low-level calls | 40 | 4,000 |
| [GAS&#x2011;13](#GAS13-avoid-unnecessary-public-variables) | Avoid unnecessary `public` variables | 34 | 748,000 |
| [GAS&#x2011;14](#GAS14-avoid-updating-storage-when-the-value-hasnt-changed) | Avoid updating storage when the value hasn't changed | 11 | 18,700 |
| [GAS&#x2011;15](#GAS15-avoid-zero-to-non-zero-storage-writes-where-possible) | Avoid zero to non-zero storage writes where possible | 22 | 486,200 |
| [GAS&#x2011;16](#GAS16-bytes-constants-are-more-efficient-than-string-constants) | Bytes constants are more efficient than string constants | 5 | 1,890 |
| [GAS&#x2011;17](#GAS17-bytesconcat-can-be-used-in-place-of-abiencodepacked) | `bytes.concat()` can be used in place of `abi.encodePacked` | 6 | - |
| [GAS&#x2011;18](#GAS18-cache-array-length-outside-of-loop) | Cache array length outside of loop | 11 | 44 |
| [GAS&#x2011;19](#GAS19-cache-external-calls-outside-of-loop-to-avoid-re-calling-function-on-each-iteration) | Cache external calls outside of loop to avoid re-calling function on each iteration | 14 | 1,400 |
| [GAS&#x2011;20](#GAS20-consider-activating-via-ir-for-deploying) | Consider activating `via-ir` for deploying | 0 | 250 |
| [GAS&#x2011;21](#GAS21-consider-caching-repeated-computations) | Consider caching repeated computations | 2 | 120 |
| [GAS&#x2011;22](#GAS22-consider-merging-sequential-for-loops) | Consider merging sequential for loops | 2 | - |
| [GAS&#x2011;23](#GAS23-consider-packing-small-uints-when-its-possible) | Consider packing small `uint`s when it's possible | 2 | 41,600 |
| [GAS&#x2011;24](#GAS24-consider-pre-calculating-the-address-of-addressthis) | Consider pre-calculating the address of `address(this)` | 21 | - |
| [GAS&#x2011;25](#GAS25-consider-using-openzeppelins-enumerateset-instead-of-nested-mappings) | Consider using OpenZeppelin's `EnumerateSet` instead of nested mappings | 10 | 10,000 |
| [GAS&#x2011;26](#GAS26-consider-using-soladys-gas-optimized-lib-for-math) | Consider using Solady's gas optimized lib for Math | 47 | - |
| [GAS&#x2011;27](#GAS27-constructors-can-be-marked-payable) | Constructors can be marked `payable` | 10 | 210 |
| [GAS&#x2011;28](#GAS28-counting-down-in-for-statements-is-more-gas-efficient) | Counting down in `for` statements is more gas efficient | 18 | 288 |
| [GAS&#x2011;29](#GAS29-declare-variables-outside-of-loops) | Declare variables outside of loops | 47 | 705 |
| [GAS&#x2011;30](#GAS30-do-not-calculate-constants) | Do not calculate constants | 65 | - |
| [GAS&#x2011;31](#GAS31-do-while-is-cheaper-than-for-loops-when-the-initial-check-can-be-skipped) | `do`-`while` is cheaper than `for`-loops when the initial check can be skipped | 35 | 8,925 |
| [GAS&#x2011;32](#GAS32-dont-compare-boolean-expressions-to-boolean-literals) | Don't compare boolean expressions to boolean literals | 1 | 20 |
| [GAS&#x2011;33](#GAS33-dont-transfer-with-zero-amount-to-save-gas) | Don't transfer with zero amount to save gas | 2 | 40 |
| [GAS&#x2011;34](#GAS34-duplicated-require/revert-checks-should-be-refactored-to-a-modifier-or-function) | Duplicated `require()/revert()` checks should be refactored to a modifier or function | 4782 | - |
| [GAS&#x2011;35](#GAS35-emitting-constants-wastes-gas) | Emitting constants wastes gas | 1 | 8 |
| [GAS&#x2011;36](#GAS36-empty-blocks-should-be-removed-or-emit-something) | Empty blocks should be removed or emit something | 8 | - |
| [GAS&#x2011;37](#GAS37-function-names-can-be-optimized) | Function names can be optimized | 47 | 6,016 |
| [GAS&#x2011;38](#GAS38-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable) | Functions guaranteed to revert when called by normal users can be marked `payable` | 88 | 1,848 |
| [GAS&#x2011;39](#GAS39-initializers-can-be-marked-payable) | Initializers can be marked `payable` | 6 | 126 |
| [GAS&#x2011;40](#GAS40-integer-increments-by-one-can-be-unchecked) | Integer increments by one can be unchecked | 22 | 1,320 |
| [GAS&#x2011;41](#GAS41-internal-functions-only-used-once-can-be-inlined-so-save-gas) | `internal` functions only used once can be inlined so save gas | 49 | 1,470 |
| [GAS&#x2011;42](#GAS42-low-level-call-can-be-optimized-with-assembly) | Low-level `call` can be optimized with assembly | 3 | 477 |
| [GAS&#x2011;43](#GAS43-mappings-are-cheaper-to-use-than-storage-arrays) | Mappings are cheaper to use than storage arrays | 9 | 18,900 |
| [GAS&#x2011;44](#GAS44-memory-safe-annotation-missing) | Memory-safe annotation missing | 6 | - |
| [GAS&#x2011;45](#GAS45-merge-events-to-save-gas) | Merge events to save gas | 4 | 1,500 |
| [GAS&#x2011;46](#GAS46-multiple-accesses-of-the-same-mapping/array-key/index-should-be-cached) | Multiple accesses of the same mapping/array key/index should be cached | 40 | 1,680 |
| [GAS&#x2011;47](#GAS47-multiple-address/id-mappings-can-be-combined-into-a-single-mapping-of-an-address/id-to-a-struct) | Multiple `address`/ID mappings can be combined into a single `mapping` of an `address`/ID to a `struct` | 19 | 380,000 |
| [GAS&#x2011;48](#GAS48-nested-for-loops-should-be-avoided-due-to-high-gas-costs-resulting-from-o^2-time-complexity) | Nested for loops should be avoided due to high gas costs resulting from O^2 time complexity | 2 | - |
| [GAS&#x2011;49](#GAS49-nesting-if-statements-is-cheaper-than-using-&&) | Nesting `if`-statements is cheaper than using `&&` | 13 | 390 |
| [GAS&#x2011;50](#GAS50-newer-versions-of-solidity-are-more-gas-efficient) | Newer versions of solidity are more gas efficient | 105 | - |
| [GAS&#x2011;51](#GAS51-not-using-the-named-return-variables-when-a-function-returns-wastes-deployment-gas) | Not using the named return variables when a function returns, wastes deployment gas | 459 | - |
| [GAS&#x2011;52](#GAS52-only-emit-event-in-setter-function-if-the-state-variable-was-changed) | Only emit event in setter function if the state variable was changed | 5 | - |
| [GAS&#x2011;53](#GAS53-optimize-deployment-size-by-fine-tuning-ipfs-hash) | Optimize Deployment Size by Fine-tuning IPFS Hash | 105 | 1,113,000 |
| [GAS&#x2011;54](#GAS54-optimize-ether-deposits-using-the-receive-function) | Optimize Ether deposits using the `receive()` function | 31 | 1,395 |
| [GAS&#x2011;55](#GAS55-order-of-initial-checks-in-a-function-can-be-optimized) | Order of initial checks in a function can be optimized | 3 | 6,300 |
| [GAS&#x2011;56](#GAS56-pre-increments/pre-decrements-are-cheaper-than-+1/+=1-or--1/-=1) | Pre-increments/pre-decrements are cheaper than `+1`/`+=1` or `-1`/`-=1` | 18 | 226.8 |
| [GAS&#x2011;57](#GAS57-prefer-using-storage-instead-of-memory-for-state-variables-saves-gas) | Prefer using `storage` instead of `memory` for state variables saves gas | 15 | 31,500 |
| [GAS&#x2011;58](#GAS58-private-functions-used-once-can-be-inlined) | `private` functions used once can be inlined | 15 | 450 |
| [GAS&#x2011;59](#GAS59-refactor-modifiers-to-call-a-local-function) | Refactor modifiers to call a local function | 32 | 19,200 |
| [GAS&#x2011;60](#GAS60-remove-or-replace-unused-state-variables) | Remove or replace unused state variables | 7 | 80,150 |
| [GAS&#x2011;61](#GAS61-reorder-modifiers-to-save-on-expensive-operations) | Reorder modifiers to save on expensive operations | 3 | 6,300 |
| [GAS&#x2011;62](#GAS62-require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function) | `require()` or `revert()` statements that check input arguments should be at the top of the function | 31 | - |
| [GAS&#x2011;63](#GAS63-require/revert-strings-longer-than-32-bytes-cost-extra-gas) | `require()`/`revert()` strings longer than 32 bytes cost extra gas | 104 | 312 |
| [GAS&#x2011;64](#GAS64-same-cast-is-done-multiple-times) | Same cast is done multiple times | 11 | - |
| [GAS&#x2011;65](#GAS65-simple-checks-for-zero-can-be-done-using-assembly-to-save-gas) | Simple checks for zero can be done using assembly to save gas | 125 | 750 |
| [GAS&#x2011;66](#GAS66-simplify-modulo-operations) | Simplify modulo operations | 5 | 505 |
| [GAS&#x2011;67](#GAS67-sort-solidity-operations-using-short-circuit-mode) | Sort Solidity operations using short-circuit mode | 64 | - |
| [GAS&#x2011;68](#GAS68-splitting-require-statements-that-use-&&-saves-gas) | Splitting `require()` statements that use `&&` saves gas | 5 | 15 |
| [GAS&#x2011;69](#GAS69-stack-variable-is-only-used-once) | Stack variable is only used once | 250 | 750 |
| [GAS&#x2011;70](#GAS70-stack-variable-used-as-a-cheaper-cache-for-a-state-variable-is-used-only-once) | Stack variable used as a cheaper cache for a state variable is used only once | 6 | 18 |
| [GAS&#x2011;71](#GAS71-state-variable-read-in-a-loop) | State variable read in a loop | 7 | 679 |
| [GAS&#x2011;72](#GAS72-state-variables-can-be-packed-into-fewer-storage-slots-by-truncating-timestamp-bytes) | State variables can be packed into fewer storage slots by truncating timestamp bytes | 3 | 160,000 |
| [GAS&#x2011;73](#GAS73-state-variables-can-be-reordered-to-fit-into-fewer-storage-slots) | State variables can be reordered to fit into fewer storage slots | 4 | 80,000 |
| [GAS&#x2011;74](#GAS74-state-variables-only-set-in-their-definitions-should-be-declared-constant) | State variables only set in their definitions should be declared `constant` | 7 | 14,679 |
| [GAS&#x2011;75](#GAS75-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage) | State variables should be cached in stack variables rather than re-reading them from storage | 42 | 4,200 |
| [GAS&#x2011;76](#GAS76-struct-can-be-reordered-to-fit-into-fewer-storage-slots) | Struct can be reordered to fit into fewer storage slots | 2 | 40,000 |
| [GAS&#x2011;77](#GAS77-structs-can-be-assigned-more-efficiently) | Structs can be assigned more efficiently | 18 | 2,340 |
| [GAS&#x2011;78](#GAS78-structs-can-be-packed-into-fewer-storage-slots-by-truncating-timestamp-bytes) | Structs can be packed into fewer storage slots by truncating timestamp bytes | 1 | 20,000 |
| [GAS&#x2011;79](#GAS79-the-result-of-a-function-call-should-be-cached-rather-than-re-calling-the-function) | The result of a function call should be cached rather than re-calling the function | 3 | 300 |
| [GAS&#x2011;80](#GAS80-unchecked-{}-can-be-used-on-the-division-of-two-uints-in-order-to-save-gas) | `unchecked {}` can be used on the division of two `uint`s in order to save gas | 5 | 300 |
| [GAS&#x2011;81](#GAS81-unnecessary-nonreentrant-modifier-in-certain-functions) | Unnecessary `nonReentrant` modifier in certain functions | 1 | 24,700 |
| [GAS&#x2011;82](#GAS82-update-openzeppelin-dependency-to-the-latest-version) | Update OpenZeppelin dependency to the latest version | 22 | - |
| [GAS&#x2011;83](#GAS83-usage-of-uints/ints-smaller-than-32-bytes-256-bits-incurs-overhead) | Usage of `uints`/`ints` smaller than 32 bytes (256 bits) incurs overhead | 121 | 726 |
| [GAS&#x2011;84](#GAS84-use-+=-for-mappings) | Use `+=` for `mapping`s | 1 | 40 |
| [GAS&#x2011;85](#GAS85-use-arrayunsafeaccess-to-avoid-repeated-array-length-checks) | Use `Array.unsafeAccess()` to avoid repeated array length checks | 34 | 71,400 |
| [GAS&#x2011;86](#GAS86-use-assembly-for-small-keccak256-hashes-in-order-to-save-gas) | Use assembly for small `keccak256` hashes, in order to save gas | 38 | 3,040 |
| [GAS&#x2011;87](#GAS87-use-assembly-in-place-of-abidecode-to-save-gas) | Use assembly in place of `abi.decode` to save gas | 11 | 1,232 |
| [GAS&#x2011;88](#GAS88-use-assembly-scratch-space-to-build-calldata-for-external-calls) | Use assembly scratch space to build calldata for external calls | 54 | 11,880 |
| [GAS&#x2011;89](#GAS89-use-assembly-to-perform-efficient-back-to-back-calls) | Use assembly to perform efficient back-to-back calls | 2 | 600 |
| [GAS&#x2011;90](#GAS90-use-assembly-to-validate-msgsender) | Use assembly to validate `msg.sender` | 17 | 204 |
| [GAS&#x2011;91](#GAS91-use-assembly-to-write-address/contract-storage-values) | Use `assembly` to write address/contract storage values | 52 | 2,600 |
| [GAS&#x2011;92](#GAS92-use-calldata-instead-of-memory-for-function-arguments-that-do-not-get-mutated) | Use `calldata` instead of `memory` for function arguments that do not get mutated | 18 | 5,400 |
| [GAS&#x2011;93](#GAS93-use-constants-instead-of-typeuint<n>max-/-min) | Use constants instead of `type(uint<n>).max` / `.min` | 19 | 76 |
| [GAS&#x2011;94](#GAS94-use-custom-errors-rather-than-revert/require-strings-to-save-gas) | Use custom errors rather than `revert()`/`require()` strings to save gas | 337 | 9,773 |
| [GAS&#x2011;95](#GAS95-use-if-statements-instead-of-ternary-operators) | Use `if` statements instead of ternary operators | 14 | - |
| [GAS&#x2011;96](#GAS96-use-immutable-when-you-have-storage-variable-that-is-not-going-to-change) | Use immutable when you have storage variable that is not going to change | 7 | - |
| [GAS&#x2011;97](#GAS97-use-local-variables-for-emitting) | Use local variables for emitting | 12 | 1,200 |
| [GAS&#x2011;98](#GAS98-use-of-emit-inside-a-loop) | Use of `emit` inside a loop | 4 | 1,500 |
| [GAS&#x2011;99](#GAS99-use-revert-to-gain-maximum-gas-savings) | Use `revert()` to gain maximum gas savings | 346 | 100,387 |
| [GAS&#x2011;100](#GAS100-use-sx-=-sx-+-y-instead-of-sx-+=-y-for-structs) | Use `s.x = s.x + y` instead of `s.x += y` for structs | 1 | 100 |
| [GAS&#x2011;101](#GAS101-use-scratch-space-when-building-emitted-events-with-two-data-arguments) | Use scratch space when building emitted events with two data arguments | 47 | 1,786 |
| [GAS&#x2011;102](#GAS102-use-selfbalance-instead-of-addressthisbalance) | Use `selfbalance()` instead of `address(this).balance` | 4 | - |
| [GAS&#x2011;103](#GAS103-use-shift-right/left-instead-of-division/multiplication-if-possible) | Use shift right/left instead of division/multiplication if possible | 12 | 240 |
| [GAS&#x2011;104](#GAS104-use-the-inputs/results-of-assignments-rather-than-re-reading-state-variables) | Use the inputs/results of assignments rather than re-reading state variables | 5 | 485 |
| [GAS&#x2011;105](#GAS105-use-uint2561/uint2562-instead-of-true/false-to-save-gas-for-changes) | Use `uint256(1)`/`uint256(2)` instead of `true`/`false` to save gas for changes | 6 | 102,600 |
| [GAS&#x2011;106](#GAS106-use-unchecked-for-divisions-on-constant-or-immutable-values) | Use `unchecked` for divisions on constant or immutable values | 3 | 180 |
| [GAS&#x2011;107](#GAS107-using-bools-for-storage-incurs-overhead) | Using `bool`s for storage incurs overhead | 22 | 376,200 |
| [GAS&#x2011;108](#GAS108-using-constants-directly-rather-than-caching-the-value-saves-gas) | Using `constant`s directly, rather than caching the value, saves gas | 21 | - |
| [GAS&#x2011;109](#GAS109-using-constants-instead-of-enum-can-save-gas) | Using `constant`s instead of `enum` can save gas | 15 | - |
| [GAS&#x2011;110](#GAS110-using-globals-directly-is-cheaper-than-assigning-them-to-variables) | Using globals directly is cheaper than assigning them to variables | 1 | 5 |
| [GAS&#x2011;111](#GAS111-using-private-rather-than-public-saves-gas) | Using `private` rather than `public`, saves gas | 53 | 191,118 |
| [GAS&#x2011;112](#GAS112-using-storage-instead-of-memory-for-structs/arrays-saves-gas) | Using `storage` instead of `memory` for structs/arrays saves gas | 48 | 100,800 |
| [GAS&#x2011;113](#GAS113-using-this<fn>-wastes-gas) | Using `this.<fn>()` wastes gas | 3 | 300 |
| [GAS&#x2011;114](#GAS114-x-+-y-is-more-efficient-than-using-+=-for-state-variables-likewise-for--=) | `x + y` is more efficient than using `+=` for state variables (likewise for `-=`) | 3 | 744 |




---
### [GAS&#x2011;1] `""` has the same value as `new bytes(0)` but costs less gas
https://gist.github.com/notbozho/9e204376b9ce6f8eeb4b630e2f133df7


Gas saved per Instance: ~160 *(Total: ~1,280)*
<details>
<summary><i>There are 8 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

196:             signature: new bytes(0), 

198:             paymasterInput: new bytes(0), 
199:             reservedDynamic: new bytes(0)

213:             l1ContractsUpgradeCalldata: new bytes(0), 
214:             postUpgradeCalldata: new bytes(0),
```
[196](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L196), [198](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L198-L199), [213](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L213-L214)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

308:             signature: new bytes(0), 

310:             paymasterInput: new bytes(0), 
311:             reservedDynamic: new bytes(0)
```
[308](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L308), [310](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L310-L311)

</details>


---
### [GAS&#x2011;2] `++i` costs less gas than `i++`/`i += 1` (same for `--i` vs `i--`/`i -+ 1`)

Gas saved per Instance: ~8.077 *(Total: ~105)*
<details>
<summary><i>There are 13 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

580:         for (uint i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 

657:             versionedHashIndex += 1; 

667:         for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 
```
[580](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L580), [657](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L657), [667](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L667)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

135:             numInitialWritesProcessed++; 

144:             stateDiffPtr++; 

175:             stateDiffPtr += 1; 
```
[135](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L135), [144](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L144), [175](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L175)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

109:         numberOfLogsToProcess++; 

284:         calldataPtr++; 

290:         calldataPtr++; 
```
[109](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L109), [284](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L284), [290](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L290)

```solidity
üìÅ File: system-contracts/contracts/PubdataChunkPublisher.sol

36:         for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 
```
[36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L36)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

288:             _maxVirtualBlocksToCreate -= 1; 

483:         txNumberInBlock += 1; 
```
[288](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L288), [483](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L483)

```solidity
üìÅ File: system-contracts/contracts/libraries/RLPEncoder.sol

103:                 hbs += 1; 
```
[103](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L103)

</details>


---
### [GAS&#x2011;3] `++i`/`i++` should be `unchecked` when it is not possible for them to overflow
The `unchecked` keyword is new in solidity version 0.8.0, so this only applies to that version or higher, which these instances are. This saves **30-40 gas [per loop](https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#the-increment-in-for-loop-post-condition-can-be-made-unchecked)**


Gas saved per Instance: ~60 *(Total: ~720)*
<details>
<summary><i>There are 12 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

225:         for (uint256 i = 0; i < _calls.length; ++i) { 
```
[225](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L225)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

580:         for (uint i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 

667:         for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 
```
[580](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L580), [667](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L667)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

226:         for (uint256 i = 0; i < _factoryDeps.length; ++i) { 
```
[226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L226)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

248:         for (uint256 i = 0; i < deploymentsLength; ++i) { 

253:         for (uint256 i = 0; i < deploymentsLength; ++i) { 
```
[248](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L248), [253](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L253)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

206:         for (uint256 i = 0; i < numberOfL2ToL1Logs; ++i) { 

218:         for (uint256 i = numberOfL2ToL1Logs; i < L2_TO_L1_LOGS_MERKLE_TREE_LEAVES; ++i) { 

224:             for (uint256 i = 0; i < nodesOnCurrentLevel; ++i) { 

236:         for (uint256 i = 0; i < numberOfMessages; ++i) { 

254:         for (uint256 i = 0; i < numberOfBytecodes; ++i) { 
```
[206](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L206), [218](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L218), [224](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L224), [236](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L236), [254](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L254)

```solidity
üìÅ File: system-contracts/contracts/PubdataChunkPublisher.sol

36:         for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 
```
[36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L36)

</details>


---
### [GAS&#x2011;4] `>=`/`<=` costs less gas than `>`/`<`
The compiler uses opcodes `GT` and `ISZERO` for code that uses `>`, but only requires `LT` for `>=`. A similar behaviour applies for `>`, which uses opcodes `LT` and `ISZERO`, but only requires `GT` for `<=`.


Gas saved per Instance: ~3 *(Total: ~291)*
<details>
<summary><i>There are 97 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

121:             require(balanceAfter > balanceBefore, "ShB: 0 eth transferred"); 

129:             require(amount > 0, "ShB: 0 amount to transfer"); 

327:         require(_amount > 0, "y1"); 

375:         return (_chainId == ERA_CHAIN_ID) && (_l2BatchNumber < eraFirstPostUpgradeBatch); 
```
[121](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L121), [129](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L129), [327](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L327), [375](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L375)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

301:             _request.secondBridgeAddress > BRIDGEHUB_MIN_SECOND_BRIDGE_ADDRESS, 

329:         } else if (_refundRecipient.code.length > 0) { 
```
[301](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L301), [329](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L329)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol

26:         require(bytecodeLenInWords < 2 ** 16, "pp"); // bytecode length must be less than 2^16 words 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L26)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

111:         } else if (timestamp > block.timestamp) { 

225:         for (uint256 i = 0; i < _calls.length; ++i) { 
```
[111](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L111), [225](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L225)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

116:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 

135:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 

185:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 

209:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 
```
[116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L116), [135](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L135), [185](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L185), [209](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L209)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

117:             s.protocolVersion > _oldProtocolVersion, 
```
[117](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L117)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

114:         require(_previousBatchTimestamp < batchTimestamp, "h3"); 

142:         for (uint256 i = 0; i < emittedL2Logs.length; i = i.uncheckedAdd(L2_TO_L1_LOG_SERIALIZE_SIZE)) { 

257:         for (uint256 i = 0; i < _newBatchesData.length; i = i.uncheckedInc()) { 

289:         for (uint256 i = 0; i < _newBatchesData.length; i = i.uncheckedInc()) { 

311:         for (uint256 i = 0; i < _nPriorityOps; i = i.uncheckedInc()) { 

351:         for (uint256 i = 0; i < nBatches; i = i.uncheckedInc()) { 

405:         for (uint256 i = 0; i < committedBatchesLength; i = i.uncheckedInc()) { 

429:         if (_proof.serializedProof.length > 0) { 

482:         require(s.totalBatchesCommitted > _newLastBatch, "v1"); // The last committed batch is less than new last batch 

485:         if (_newLastBatch < s.totalBatchesVerified) { 

492:         if (s.l2SystemContractsUpgradeBatchNumber > _newLastBatch) { 

580:         for (uint i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 

593:         return (_bitMap & (1 << _index)) > 0; 

631:         require(_pubdataCommitments.length > 0, "pl"); 

636:         for (uint256 i = 0; i < _pubdataCommitments.length; i += PUBDATA_COMMITMENT_SIZE) { 

667:         for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 
```
[114](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L114), [142](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L142), [257](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L257), [289](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L289), [311](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L311), [351](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L351), [405](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L405), [429](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L429), [482](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L482), [485](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L485), [492](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L492), [580](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L580), [593](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L593), [631](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L631), [636](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L636), [667](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L667)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

208:         for (uint256 i = 0; i < facetsLen; i = i.uncheckedInc()) { 
```
[208](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L208)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

158:         require(s.baseTokenGasPriceMultiplierDenominator > 0, "Mailbox: baseTokenGasPriceDenominator not set"); 

277:         if (refundRecipient.code.length > 0) { 

356:         for (uint256 i = 0; i < factoryDepsLen; i = i.uncheckedInc()) { 
```
[158](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L158), [277](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L277), [356](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L356)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

101:         for (uint256 i = 0; i < facetCutsLength; i = i.uncheckedInc()) { 

107:             require(selectors.length > 0, "B"); // no functions for diamond cut 

132:         require(_facet.code.length > 0, "G"); 

138:         for (uint256 i = 0; i < selectorsLength; i = i.uncheckedInc()) { 

155:         require(_facet.code.length > 0, "K"); 

158:         for (uint256 i = 0; i < selectorsLength; i = i.uncheckedInc()) { 

178:         for (uint256 i = 0; i < selectorsLength; i = i.uncheckedInc()) { 
```
[101](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L101), [107](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L107), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L132), [138](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L138), [155](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L155), [158](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L158), [178](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L178)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol

24:         require(pathLength > 0, "xc"); 
25:         require(pathLength < 256, "bt");
26:         require(_index < (1 << pathLength), "px");

29:         for (uint256 i; i < pathLength; i = i.uncheckedInc()) { 
```
[24](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L24-L26), [29](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L29)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

226:         for (uint256 i = 0; i < _factoryDeps.length; ++i) { 

239:             _newProtocolVersion > previousProtocolVersion, 
```
[226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L226), [239](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L239)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

124:         require(_amount > 0, "Amount cannot be zero"); 
```
[124](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L124)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

102:         if (codeHash == 0x00 && NONCE_HOLDER_SYSTEM_CONTRACT.getRawNonce(account) > 0) { 

132:             uint160(account) > CURRENT_MAX_PRECOMPILE_ADDRESS && 
```
[102](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L102), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L132)

```solidity
üìÅ File: system-contracts/contracts/ComplexUpgrader.sol

24:         require(_delegateTo.code.length > 0, "Delegatee is an EOA"); 
```
[24](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L24)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

61:             for (uint256 encodedDataPointer = 0; encodedDataPointer < encodedData.length; encodedDataPointer += 2) { 

63:                 require(indexOfEncodedChunk < dictionary.length, "Encoded chunk index is out of bounds"); 

127:         for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) { 

159:         for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) { 
```
[61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L61), [63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L63), [127](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L127), [159](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L159)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

48:             _address > address(MAX_SYSTEM_CONTRACT_ADDRESS) && 

248:         for (uint256 i = 0; i < deploymentsLength; ++i) { 

253:         for (uint256 i = 0; i < deploymentsLength; ++i) { 

265:         require(uint160(_newAddress) > MAX_SYSTEM_CONTRACT_ADDRESS, "Can not deploy contracts in kernel space"); 

303:         require(knownCodeMarker > 0, "The code hash is not known"); 

332:             if (value > 0) { 

339:             if (value > 0) { 
```
[48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L48), [248](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L248), [253](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L253), [265](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L265), [303](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L303), [332](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L332), [339](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L339)

```solidity
üìÅ File: system-contracts/contracts/GasBoundCaller.sol

49:         uint256 pubdataAllowance = _maxTotalGas > expectedForCompute ? _maxTotalGas - expectedForCompute : 0; 

63:         uint256 pubdataSpent = pubdataPublishedAfter > pubdataPublishedBefore 
```
[49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L49), [63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L63)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

38:             for (uint256 i = 0; i < immutablesLength; ++i) { 
```
[38](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L38)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

30:             for (uint256 i = 0; i < hashesLen; ++i) { 
```
[30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L30)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

206:         for (uint256 i = 0; i < numberOfL2ToL1Logs; ++i) { 

218:         for (uint256 i = numberOfL2ToL1Logs; i < L2_TO_L1_LOGS_MERKLE_TREE_LEAVES; ++i) { 

222:         while (nodesOnCurrentLevel > 1) { 

224:             for (uint256 i = 0; i < nodesOnCurrentLevel; ++i) { 

236:         for (uint256 i = 0; i < numberOfMessages; ++i) { 

254:         for (uint256 i = 0; i < numberOfBytecodes; ++i) { 
```
[206](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L206), [218](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L218), [222](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L222), [224](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L224), [236](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L236), [254](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L254)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

53:         uint256 userGas = gasInContext > MSG_VALUE_SIMULATOR_STIPEND_GAS 
```
[53](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L53)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

156:         return (_nonce < getMinNonce(_address) || nonceValues[addressAsKey][_nonce] > 0); 
```
[156](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L156)

```solidity
üìÅ File: system-contracts/contracts/PubdataChunkPublisher.sol

36:         for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 
```
[36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L36)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

119:         return pubdataPublished > basePubdataSpent ? pubdataPublished - basePubdataSpent : 0; 

144:         if (blockNumber <= _block || blockNumber - _block > 256) { 

146:         } else if (_block < currentVirtualBlockUpgradeInfo.virtualBlockStartBatch) { 

152:             currentVirtualBlockUpgradeInfo.virtualBlockFinishL2Block > 0 

245:         require(_l2BlockNumber > 0, "L2 block number is never expected to be zero"); 

287:             require(_maxVirtualBlocksToCreate > 0, "Can't initialize the first virtual block"); 

355:             require(_maxVirtualBlocksToCreate > 0, "There must be a virtual block created at the start of the batch"); 

387:                 _l2BlockTimestamp > currentL2BlockTimestamp, 

413:         require(currentBatchNumber > 0, "The current batch number must be greater than 0"); 

430:             _newTimestamp > currentBlockTimestamp, 

451:         require(_newTimestamp > previousBatchTimestamp, "Timestamps should be incremental"); 
```
[119](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L119), [144](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L144), [146](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L146), [152](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L152), [245](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L245), [287](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L287), [355](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L355), [387](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L387), [413](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L413), [430](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L430), [451](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L451)

```solidity
üìÅ File: system-contracts/contracts/libraries/RLPEncoder.sol

26:             if (_val < 128) { 

62:             if (_len < 56) { 

86:             if (_number > type(uint128).max) { 

90:             if (_number > type(uint64).max) { 

94:             if (_number > type(uint32).max) { 

98:             if (_number > type(uint16).max) { 

102:             if (_number > type(uint8).max) { 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L26), [62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L62), [86](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L86), [90](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L90), [94](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L94), [98](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L98), [102](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L102)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractHelper.sol

319:         require(index < 10, "There are only 10 accessible registers"); 
```
[319](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L319)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

378:             if (currentAllowance < minAllowance) { 
```
[378](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L378)

```solidity
üìÅ File: system-contracts/contracts/libraries/Utils.sol

87:         require(lengthInWords < 2 ** 16, "pp"); // bytecode length must be less than 2^16 words 
```
[87](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L87)

</details>


---
### [GAS&#x2011;5] `abi.encode()` is less efficient than `abi.encodePacked()`
See for more information: https://github.com/ConnorBlockchain/Solidity-Encode-Gas-Comparison

<details>
<summary><i>There are 34 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

76:         bytes32 constructorInputHash = keccak256(abi.encode(l2TokenBeacon, "")); 
```
[76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L76)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

210:         bytes32 txDataHash = keccak256(abi.encode(_prevMsgSender, _l1Token, amount)); 

258:             bytes memory decimals = abi.encode(uint8(18)); 
259:             return abi.encode(name, symbol, decimals); // when depositing eth to a non-eth based chain it is an ERC20

265:         return abi.encode(data1, data2, data3); 

341:                 bytes32 txDataHash = keccak256(abi.encode(_depositSender, _l1Token, _amount)); 

598:         bytes32 txDataHash = keccak256(abi.encode(_prevMsgSender, _l1Token, _amount)); 
```
[210](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L210), [258](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L258-L259), [265](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L265), [341](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L341), [598](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L598)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

205:         return keccak256(abi.encode(_operation)); 
```
[205](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L205)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

100:         storedBatchZero = keccak256(abi.encode(batchZero)); 

102:         initialCutHash = keccak256(abi.encode(_initializeData.diamondCut)); 

138:         initialCutHash = keccak256(abi.encode(_diamondCut)); 

147:         upgradeCutHash[_oldProtocolVersion] = keccak256(abi.encode(_cutData)); 

156:         upgradeCutHash[_oldProtocolVersion] = keccak256(abi.encode(_cutData)); 
```
[100](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L100), [102](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L102), [138](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L138), [147](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L147), [156](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L156)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

104:         bytes32 cutHashInput = keccak256(abi.encode(_diamondCut)); 
```
[104](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L104)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

313:             concatHash = keccak256(abi.encode(concatHash, priorityOp.canonicalTxHash)); 

512:         return keccak256(abi.encode(passThroughDataHash, metadataHash, auxiliaryOutputHash)); 

588:         return keccak256(abi.encode(_storedBatchInfo)); 

680:         (bool success, bytes memory data) = s.blobVersionedHashRetriever.staticcall(abi.encode(_index)); 
```
[313](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L313), [512](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L512), [588](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L588), [680](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L680)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

323:         bytes memory transactionEncoding = abi.encode(transaction); 
```
[323](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L323)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

192:         bytes memory encodedTransaction = abi.encode(_l2ProtocolUpgradeTx); 
```
[192](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L192)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

150:         bytes32 constructorInputHash = keccak256(abi.encode(address(l2TokenBeacon), "")); 

171:                 (salt, l2TokenProxyBytecodeHash, abi.encode(address(l2TokenBeacon), "")) 
```
[150](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L150), [171](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L171)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

106:         chainedLogsHash = keccak256(abi.encode(chainedLogsHash, hashedLog)); 

122:         chainedMessagesHash = keccak256(abi.encode(chainedMessagesHash, hash)); 

164:         chainedL1BytecodesRevealDataHash = keccak256(abi.encode(chainedL1BytecodesRevealDataHash, _bytecodeHash)); 

212:             reconstructedChainedLogsHash = keccak256(abi.encode(reconstructedChainedLogsHash, hashedLog)); 

226:                     abi.encode(l2ToL1LogsTreeArray[2 * i], l2ToL1LogsTreeArray[2 * i + 1]) 

243:             reconstructedChainedMessagesHash = keccak256(abi.encode(reconstructedChainedMessagesHash, hashedMessage)); 

260:                 abi.encode( 
```
[106](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L106), [122](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L122), [164](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L164), [212](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L212), [226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L226), [243](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L243), [260](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L260)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

159:             hash = keccak256(abi.encode(_block)); 

227:         return keccak256(abi.encode(_blockNumber, _blockTimestamp, _prevL2BlockHash, _blockTxsRollingHash)); 

403:         currentL2BlockTxsRollingHash = keccak256(abi.encode(currentL2BlockTxsRollingHash, _txHash)); 
```
[159](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L159), [227](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L227), [403](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L403)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

120:             abi.encode( 

139:             abi.encode(EIP712_DOMAIN_TYPEHASH, keccak256("zkSync"), keccak256("2"), block.chainid) 
```
[120](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L120), [139](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L139)

</details>


---
### [GAS&#x2011;6] Add `unchecked {}` for subtractions where the operands cannot underflow because of a previous `require()` or `if-statement`

1. `require(a <= b); x = b - a` => `require(a <= b); unchecked { x = b - a }`
2. `require(b >= a); x = b - a` => `require(a <= b); unchecked { x = b - a }`

3. `if (b < a) revert(...);  x = b - a` => `if (b < a) revert(...);  unchecked { x = b - a }`
4. `if (a > b) revert(...);  x = b - a` => `if (b < a) revert(...);  unchecked { x = b - a }`


Gas saved per Instance: ~60 *(Total: ~180)*
<details>
<summary><i>There are 3 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol

118:             txBodyGasLimit = _totalGasLimit - overhead; 
```
[118](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L118)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol

28:             _newProtocolVersion - previousProtocolVersion <= MAX_ALLOWED_PROTOCOL_VERSION_DELTA, 
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L28)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

43:             balance[_from] = fromBalance - _amount; 
```
[43](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L43)

</details>


---
### [GAS&#x2011;7] `address(this)` should be cached when used multiple times

<i>There are 2 instaces of this issue:</i>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

/// @audit 'address(this)' used 4 times
116:     function transferFundsFromLegacy(address _token, address _target, uint256 _targetChainId) external onlyOwner { 

/// @audit 'address(this)' used 3 times
173:     function _depositFunds(address _from, IERC20 _token, uint256 _amount) internal returns (uint256) { 
```
[116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L116), [173](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L173)


---
### [GAS&#x2011;8] Alternative Solady library can be used instead of OpenZeppelin to save gas
The following OpenZeppelin imports have a [Solady](https://github.com/Vectorized/solady) equivalent, as such they can be used to save GAS as Solady modules have been specifically designed to be as GAS efficient as possible.


Gas saved per Instance: ~1,000 *(Total: ~8,000)*
<details>
<summary><i>There are 8 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

6: import {SafeERC20} from "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol"; 
```
[6](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L6)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

5: import {Initializable} from "@openzeppelin/contracts/proxy/utils/Initializable.sol"; 

10: import {SafeERC20} from "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol"; 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L5), [10](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L10)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

5: import {Math} from "@openzeppelin/contracts/utils/math/Math.sol"; 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L5)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

5: import {SafeCast} from "@openzeppelin/contracts/utils/math/SafeCast.sol"; 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L5)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol

5: import {Math} from "@openzeppelin/contracts/utils/math/Math.sol"; 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L5)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

5: import {Initializable} from "@openzeppelin/contracts/proxy/utils/Initializable.sol"; 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L5)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

6: import "../openzeppelin/token/ERC20/utils/SafeERC20.sol"; 
```
[6](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L6)

</details>


---
### [GAS&#x2011;9] `arr[index] += amount` is cheaper than `arr[index] = arr[index] + amount`
When updating a value in an array with arithmetic, using `arr[index] += amount` is cheaper than `arr[index] = arr[index] + amount`.
This is because you avoid an additonal `mload` when the array is stored in memory, and an `sload` when the array is stored in storage.
This can be applied for any arithmetic operation including `+=`, `-=`,`/=`,`*=`,`^=`,`&=`, `%=`, `<<=`,`>>=`, and `>>>=`.
This optimization can be particularly significant if the pattern occurs during a loop.

*Saves 28 gas for a storage array, 38 for a memory array*


<i>There is one instance of this issue:</i>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

133:             chainBalance[_targetChainId][_token] = chainBalance[_targetChainId][_token] + amount; 
```
[133](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L133)


---
### [GAS&#x2011;10] Assembly let var only used on once
If a variable is only once, it makes more sense to use the value the variable holds directly.

<details>
<summary><i>There are 8 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

231:             let result := call(gas(), contractAddress, 0, 0, calldatasize(), 0, 0) 
```
[231](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L231)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol

39:             let result := delegatecall(gas(), facetAddress, ptr, calldatasize(), 0, 0) 
```
[39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L39)

```solidity
üìÅ File: system-contracts/contracts/PubdataChunkPublisher.sol

32:             let ptr := add(totalBlobs, 0x20) 

48:                 let ptr := add(totalBlobs, 0x20) 
```
[32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L32), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L48)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractsCaller.sol

161:                 let size := mload(returnData) 
```
[161](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L161)

```solidity
üìÅ File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol

21:             let offset := sub(_bytes.offset, 30) 

28:             let offset := sub(_bytes.offset, 28) 

35:             let offset := sub(_bytes.offset, 24) 
```
[21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L21), [28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L28), [35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L35)

</details>


---
### [GAS&#x2011;11] Assigning state variables directly with named struct constructors wastes gas
Using named arguments for struct means that the compiler needs to organize the fields in memory before doing the assignment, which wastes gas. Set each field directly in storage (use dot-notation), or use the unnamed version of the constructor.


Gas saved per Instance: ~28 *(Total: ~420)*
<details>
<summary><i>There are 15 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

219:             request = L2TransactionRequestTwoBridgesInner({ 
220:                 magicValue: TWO_BRIDGES_MAGIC_VALUE,
221:                 l2Contract: l2BridgeAddress[_chainId],
222:                 l2Calldata: l2TxCalldata,
223:                 factoryDeps: new bytes[](0),
224:                 txDataHash: txDataHash
225:             });

430:         MessageParams memory messageParams = MessageParams({ 
431:             l2BatchNumber: _l2BatchNumber,
432:             l2MessageIndex: _l2MessageIndex,
433:             l2TxNumberInBatch: _l2TxNumberInBatch
434:         });

470:             l2ToL1Message = L2Message({ 
471:                 txNumberInBatch: _messageParams.l2TxNumberInBatch,
472:                 sender: l2Sender,
473:                 data: _message
474:             });

584:             L2TransactionRequestDirect memory request = L2TransactionRequestDirect({ 
585:                 chainId: ERA_CHAIN_ID,
586:                 l2Contract: l2BridgeAddress[ERA_CHAIN_ID],
587:                 mintValue: msg.value, // l2 gas + l2 msg.Value the bridgehub will withdraw the mintValue from the base token bridge for gas
588:                 l2Value: 0, // L2 msg.value, this contract doesn't support base token deposits or wrapping functionality, for direct deposits use bridgehub
589:                 l2Calldata: l2TxCalldata,
590:                 l2GasLimit: _l2TxGasLimit,
591:                 l2GasPerPubdataByteLimit: _l2TxGasPerPubdataByte,
592:                 factoryDeps: new bytes[](0),
593:                 refundRecipient: refundRecipient
594:             });
```
[219](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L219-L225), [430](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L430-L434), [470](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L470-L474), [584](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L584-L594)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

182:         L2CanonicalTransaction memory l2ProtocolUpgradeTx = L2CanonicalTransaction({ 
183:             txType: SYSTEM_UPGRADE_L2_TX_TYPE,
184:             from: uint256(uint160(L2_FORCE_DEPLOYER_ADDR)),
185:             to: uint256(uint160(L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR)),
186:             gasLimit: 5,
187:             gasPerPubdataByteLimit: REQUIRED_L2_GAS_PRICE_PER_PUBDATA,
188:             maxFeePerGas: uint256(0),
189:             maxPriorityFeePerGas: uint256(0),
190:             paymaster: uint256(0),
191:             // Note, that the priority operation id is used as "nonce" for L1->L2 transactions
192:             nonce: protocolVersion,
193:             value: 0,
194:             reserved: [uint256(0), 0, 0, 0],
195:             data: systemContextCalldata,
196:             signature: new bytes(0),
197:             factoryDeps: uintEmptyArray,
198:             paymasterInput: new bytes(0),
199:             reservedDynamic: new bytes(0)
200:         });

202:         ProposedUpgrade memory proposedUpgrade = ProposedUpgrade({ 
203:             l2ProtocolUpgradeTx: l2ProtocolUpgradeTx,
204:             factoryDeps: bytesEmptyArray,
205:             bootloaderHash: bytes32(0),
206:             defaultAccountHash: bytes32(0),
207:             verifier: address(0),
208:             verifierParams: VerifierParams({
209:                 recursionNodeLevelVkHash: bytes32(0),
210:                 recursionLeafLevelVkHash: bytes32(0),
211:                 recursionCircuitsSetVksHash: bytes32(0)
212:             }),
213:             l1ContractsUpgradeCalldata: new bytes(0),
214:             postUpgradeCalldata: new bytes(0),
215:             upgradeTimestamp: 0,
216:             newProtocolVersion: protocolVersion
217:         });

220:         Diamond.DiamondCutData memory cutData = Diamond.DiamondCutData({ 
221:             facetCuts: emptyArray,
222:             initAddress: genesisUpgrade,
223:             initCalldata: abi.encodeCall(IDefaultUpgrade.upgrade, (proposedUpgrade))
224:         });
```
[182](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L182-L200), [202](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L202-L217), [220](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L220-L224)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

92:         L2Log memory l2Log = L2Log({ 
93:             l2ShardId: 0,
94:             isService: true,
95:             txNumberInBatch: _l2TxNumberInBatch,
96:             sender: L2_BOOTLOADER_ADDRESS,
97:             key: _l2TxHash,
98:             value: bytes32(uint256(_status))
99:         });

294:         transaction = L2CanonicalTransaction({ 
295:             txType: PRIORITY_OPERATION_L2_TX_TYPE,
296:             from: uint256(uint160(_priorityOpParams.sender)),
297:             to: uint256(uint160(_priorityOpParams.contractAddressL2)),
298:             gasLimit: _priorityOpParams.l2GasLimit,
299:             gasPerPubdataByteLimit: _priorityOpParams.l2GasPricePerPubdata,
300:             maxFeePerGas: uint256(_priorityOpParams.l2GasPrice),
301:             maxPriorityFeePerGas: uint256(0),
302:             paymaster: uint256(0),
303:             // Note, that the priority operation id is used as "nonce" for L1->L2 transactions
304:             nonce: uint256(_priorityOpParams.txId),
305:             value: _priorityOpParams.l2Value,
306:             reserved: [_priorityOpParams.valueToMint, uint256(uint160(_priorityOpParams.refundRecipient)), 0, 0],
307:             data: _calldata,
308:             signature: new bytes(0),
309:             factoryDeps: _hashFactoryDeps(_factoryDeps),
310:             paymasterInput: new bytes(0),
311:             reservedDynamic: new bytes(0)
312:         });
```
[92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L92-L99), [294](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L294-L312)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

218:         ds.selectorToFacet[_selector] = SelectorToFacet({ 
219:             facetAddress: _facet,
220:             selectorPosition: selectorPosition,
221:             isFreezable: _isSelectorFreezable
222:         });
```
[218](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L218-L222)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

75:         L2ToL1Log memory l2ToL1Log = L2ToL1Log({ 
76:             l2ShardId: 0,
77:             isService: _isService,
78:             txNumberInBlock: SYSTEM_CONTEXT_CONTRACT.txNumberInBlock(),
79:             sender: msg.sender,
80:             key: _key,
81:             value: _value
82:         });

125:         L2ToL1Log memory l2ToL1Log = L2ToL1Log({ 
126:             l2ShardId: 0,
127:             isService: true,
128:             txNumberInBlock: SYSTEM_CONTEXT_CONTRACT.txNumberInBlock(),
129:             sender: address(this),
130:             key: bytes32(uint256(uint160(msg.sender))),
131:             value: hash
132:         });
```
[75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L75-L82), [125](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L125-L132)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

316:         currentL2BlockInfo = BlockInfo({number: _l2BlockNumber, timestamp: _l2BlockTimestamp}); 

459:         BlockInfo memory newBlockInfo = BlockInfo({number: previousBatchNumber + 1, timestamp: _newTimestamp}); 

476:         BlockInfo memory newBlockInfo = BlockInfo({number: uint128(_number), timestamp: uint128(_newTimestamp)}); 
```
[316](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L316), [459](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L459), [476](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L476)

</details>


---
### [GAS&#x2011;12] Avoid contract existence checks by using low-level calls
Prior to 0.8.10 the compiler inserted extra code, including `EXTCODESIZE` (**100 gas**), to check for contract existence for external function calls. In more recent solidity versions, the compiler will not insert these checks if the external call has a return value. Similar behavior can be achieved in earlier versions by using low-level calls, since low-level calls never check for contract existence


Gas saved per Instance: ~100 *(Total: ~4,000)*
<details>
<summary><i>There are 40 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

65:         uint256 amount = IERC20(_token).balanceOf(address(this)); 

67:         IERC20(_token).safeTransfer(address(sharedBridge), amount); 
```
[65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L65), [67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L67)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

119:             IMailbox(_target).transferEthToSharedBridge(); 

127:             uint256 balanceBefore = IERC20(_token).balanceOf(address(this)); 
128:             uint256 amount = IERC20(_token).balanceOf(address(legacyBridge));

130:             IL1ERC20Bridge(_target).tranferTokenToSharedBridge(_token, amount); 
131:             uint256 balanceAfter = IERC20(_token).balanceOf(address(this));

362:             IERC20(_l1Token).safeTransfer(_depositSender, _amount); 

423:             bool alreadyFinalized = IGetters(ERA_DIAMOND_PROXY).isEthWithdrawalFinalized( 

452:             IERC20(l1Token).safeTransfer(l1Receiver, amount); 
```
[119](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L119), [127](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L127-L128), [130](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L130-L131), [362](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L362), [423](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L423), [452](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L452)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

76:         return IStateTransitionManager(stateTransitionManager[_chainId]).stateTransition(_chainId); 

137:         IStateTransitionManager(_stateTransitionManager).createNewChain( 

160:         return IZkSyncStateTransition(stateTransition).proveL2MessageInclusion(_batchNumber, _index, _message, _proof); 

172:         return IZkSyncStateTransition(stateTransition).proveL2LogInclusion(_batchNumber, _index, _log, _proof); 

187:             IZkSyncStateTransition(stateTransition).proveL1ToL2TransactionStatus( 

206:             IZkSyncStateTransition(stateTransition).l2TransactionBaseCost( 

238:         canonicalTxHash = IZkSyncStateTransition(stateTransition).bridgehubRequestL2Transaction( 

288:         L2TransactionRequestTwoBridgesInner memory outputRequest = IL1SharedBridge(_request.secondBridgeAddress) 
289:             .bridgehubDeposit{value: _request.secondBridgeValue}(

304:         canonicalTxHash = IZkSyncStateTransition(stateTransition).bridgehubRequestL2Transaction( 

318:         IL1SharedBridge(_request.secondBridgeAddress).bridgehubConfirmL2Transaction( 
```
[76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L76), [137](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L137), [160](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L160), [172](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L172), [187](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L187), [206](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L206), [238](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L238), [288](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L288-L289), [304](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L304), [318](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L318)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

75:         return IZkSyncStateTransition(stateTransition[_chainId]).getAdmin(); 

161:         IZkSyncStateTransition(stateTransition[_chainId]).freezeDiamond(); 

166:         IZkSyncStateTransition(stateTransition[_chainId]).freezeDiamond(); 

171:         IZkSyncStateTransition(stateTransition[_chainId]).revertBatches(_newLastBatch); 

226:         IAdmin(_chainContract).executeUpgrade(cutData); 
```
[75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L75), [161](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L161), [166](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L166), [171](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L171), [226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L226)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

106:             cutHashInput == IStateTransitionManager(s.stateTransitionManager).upgradeCutHash(_oldProtocolVersion), 
```
[106](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L106)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

227:             IStateTransitionManager(s.stateTransitionManager).protocolVersion() == s.protocolVersion, 
```
[227](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L227)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

43:         IL1SharedBridge(sharedBridgeAddress).receiveEth{value: amount}(ERA_CHAIN_ID); 

186:         IL1SharedBridge(s.baseTokenBridge).finalizeWithdrawal( 

220:         IL1SharedBridge(s.baseTokenBridge).bridgehubDepositBaseToken{value: msg.value}( 
```
[43](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L43), [186](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L186), [220](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L220)

```solidity
üìÅ File: contracts/zksync/contracts/ForceDeployUpgrader.sol

14:         IContractDeployer(DEPLOYER_SYSTEM_CONTRACT).forceDeployOnAddresses{value: msg.value}(_forceDeployments); 
```
[14](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/ForceDeployUpgrader.sol#L14)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

104:         IL2StandardToken(expectedL2Token).bridgeMint(_l2Receiver, _amount); 

113:         L2StandardERC20(address(l2Token)).bridgeInitialize(_l1Token, _data); 

126:         IL2StandardToken(_l2Token).bridgeBurn(msg.sender, _amount); 
```
[104](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L104), [113](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L113), [126](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L126)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

120:         require(msg.sender == UpgradeableBeacon(beaconAddress).owner(), "tt"); 
```
[120](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L120)

```solidity
üìÅ File: system-contracts/contracts/GasBoundCaller.sol

57:         bytes memory returnData = EfficientCall.call(gasleft(), _to, msg.value, _data, false); 
```
[57](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L57)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

63:             (bool success, ) = address(REAL_BASE_TOKEN_SYSTEM_CONTRACT).call( 
64:                 abi.encodeCall(REAL_BASE_TOKEN_SYSTEM_CONTRACT.transferFromTo, (msg.sender, to, value))
65:             );
```
[63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L63-L65)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

377:             uint256 currentAllowance = IERC20(token).allowance(address(this), paymaster); 

382:                 IERC20(token).safeApprove(paymaster, 0); 
383:                 IERC20(token).safeApprove(paymaster, minAllowance);
```
[377](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L377), [382](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L382-L383)

</details>


---
### [GAS&#x2011;13] Avoid unnecessary `public` variables
Public state variables in Solidity automatically generate getter functions, increasing contract size and potentially leading to higher deployment and interaction costs. To optimize gas usage and contract efficiency, minimize the use of public variables unless external access is necessary. Instead, use internal or private visibility combined with explicit getter functions when required. This practice not only reduces contract size but also provides better control over data access and manipulation, enhancing security and readability. Prioritize lean, efficient contracts to ensure cost-effectiveness and better performance on the blockchain.


Gas saved per Instance: ~22,000 *(Total: ~748,000)*
<details>
<summary><i>There are 34 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

23:     IL1SharedBridge public immutable override sharedBridge; 

36:     address public l2Bridge; 

39:     address public l2TokenBeacon; 

42:     bytes32 public l2TokenProxyBytecodeHash; 
```
[23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L23), [36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L36), [39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L39), [42](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L42)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

34:     address public immutable override l1WethAddress; 

37:     IBridgehub public immutable override bridgehub; 

40:     IL1ERC20Bridge public immutable override legacyBridge; 
```
[34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L34), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L37), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L40)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

18:     IL1SharedBridge public sharedBridge; 

32:     address public admin; 
```
[18](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L18), [32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L32)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

26:     address public securityCouncil; 

35:     uint256 public minDelay; 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L26), [35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L35)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

27:     address public immutable bridgehub; 

33:     bytes32 public storedBatchZero; 

36:     bytes32 public initialCutHash; 

39:     address public genesisUpgrade; 

42:     uint256 public protocolVersion; 

45:     address public validatorTimelock; 

51:     address public admin; 
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L27), [33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L33), [36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L36), [39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L39), [42](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L42), [45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L45), [51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L51)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

44:     IStateTransitionManager public stateTransitionManager; 

53:     uint32 public executionDelay; 
```
[44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L44), [53](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L53)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

25:     address public override l1Bridge; 

29:     UpgradeableBeacon public l2TokenBeacon; 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L25), [29](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L29)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

34:     address public override l2Bridge; 

37:     address public override l1Address; 
```
[34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L34), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L37)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

23:     uint256 public override totalSupply; 
```
[23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L23)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

26:     uint256 public chainId; 

30:     address public origin; 

34:     uint256 public gasPrice; 

37:     uint256 public blockGasLimit = type(uint32).max; 

41:     address public coinbase = BOOTLOADER_FORMAL_ADDRESS; 

44:     uint256 public difficulty = 2.5e15; 

48:     uint256 public baseFee; 

89:     uint16 public txNumberInBlock; 

92:     uint256 public gasPerPubdataByte; 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L26), [30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L30), [34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L34), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L37), [41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L41), [44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L44), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L48), [89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L89), [92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L92)

</details>


---
### [GAS&#x2011;14] Avoid updating storage when the value hasn't changed
If the old value is equal to the new value, not re-storing the value will avoid a Gsreset (2900 gas), potentially at the expense of a Gcoldsload (2100 gas) or a Gwarmaccess (100 gas)


Gas saved per Instance: ~1,700 *(Total: ~18,700)*
<details>
<summary><i>There are 11 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

256:     function updateSecurityCouncil(address _newSecurityCouncil) external onlySelf { 
257:         emit ChangeSecurityCouncil(securityCouncil, _newSecurityCouncil);
258:         securityCouncil = _newSecurityCouncil;
259:     }
```
[256](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L256-L259)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

132:     function setValidatorTimelock(address _validatorTimelock) external onlyOwnerOrAdmin { 
133:         validatorTimelock = _validatorTimelock;
134:     }
```
[132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L132-L134)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

73:     function setStateTransitionManager(IStateTransitionManager _stateTransitionManager) external onlyOwner { 
74:         stateTransitionManager = _stateTransitionManager;
75:     }

96:     function setExecutionDelay(uint32 _executionDelay) external onlyOwner { 
97:         executionDelay = _executionDelay;
98:         emit NewExecutionDelay(_executionDelay);
99:     }
```
[73](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L73-L75), [96](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L96-L99)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

49:     function initialize( 
50:         address _l1Bridge,
51:         address _l1LegecyBridge,
52:         bytes32 _l2TokenProxyBytecodeHash,
53:         address _aliasedOwner
54:     ) external reinitializer(2) {
55:         require(_l1Bridge != address(0), "bf");
56:         require(_l2TokenProxyBytecodeHash != bytes32(0), "df");
57:         require(_aliasedOwner != address(0), "sf");
58:         require(_l2TokenProxyBytecodeHash != bytes32(0), "df");
59: 
60:         l1Bridge = _l1Bridge;
61:         l2TokenProxyBytecodeHash = _l2TokenProxyBytecodeHash;
62: 
63:         if (block.chainid != ERA_CHAIN_ID) {
64:             address l2StandardToken = address(new L2StandardERC20{salt: bytes32(0)}());
65:             l2TokenBeacon = new UpgradeableBeacon{salt: bytes32(0)}(l2StandardToken);
66:             l2TokenBeacon.transferOwnership(_aliasedOwner);
67:         } else {
68:             require(_l1LegecyBridge != address(0), "bf2");
69:             // l2StandardToken and l2TokenBeacon are already deployed on ERA, and stored in the proxy
70:         }
71:     }
```
[49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L49-L71)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

50:     function bridgeInitialize(address _l1Address, bytes memory _data) external initializer { 
51:         require(_l1Address != address(0), "in6"); // Should be non-zero address
52:         l1Address = _l1Address;
53: 
54:         l2Bridge = msg.sender;
55: 
56:         // We parse the data exactly as they were created on the L1 bridge
57:         (bytes memory nameBytes, bytes memory symbolBytes, bytes memory decimalsBytes) = abi.decode(
58:             _data,
59:             (bytes, bytes, bytes)
60:         );
61: 
62:         ERC20Getters memory getters;
63:         string memory decodedName;
64:         string memory decodedSymbol;
65: 
66:         // L1 bridge didn't check if the L1 token return values with proper types for `name`/`symbol`/`decimals`
67:         // That's why we need to try to decode them, and if it works out, set the values as getters.
68: 
69:         // NOTE: Solidity doesn't have a convenient way to try to decode a value:
70:         // - Decode them manually, i.e. write a function that will validate that data in the correct format
71:         // and return decoded value and a boolean value - whether it was possible to decode.
72:         // - Use the standard abi.decode method, but wrap it into an external call in which error can be handled.
73:         // We use the second option here.
74: 
75:         try this.decodeString(nameBytes) returns (string memory nameString) {
76:             decodedName = nameString;
77:         } catch {
78:             getters.ignoreName = true;
79:         }
80: 
81:         try this.decodeString(symbolBytes) returns (string memory symbolString) {
82:             decodedSymbol = symbolString;
83:         } catch {
84:             getters.ignoreSymbol = true;
85:         }
86: 
87:         // Set decoded values for name and symbol.
88:         __ERC20_init_unchained(decodedName, decodedSymbol);
89: 
90:         // Set the name for EIP-712 signature.
91:         __ERC20Permit_init(decodedName);
92: 
93:         try this.decodeUint8(decimalsBytes) returns (uint8 decimalsUint8) {
94:             // Set decoded value for decimals.
95:             decimals_ = decimalsUint8;
96:         } catch {
97:             getters.ignoreDecimals = true;
98:         }
99: 
100:         availableGetters = getters;
101:         emit BridgeInitialize(_l1Address, decodedName, decodedSymbol, decimals_);
102:     }

111:     function reinitializeToken( 
112:         ERC20Getters calldata _availableGetters,
113:         string memory _newName,
114:         string memory _newSymbol,
115:         uint8 _version
116:     ) external onlyNextVersion(_version) reinitializer(_version) {
117:         // It is expected that this token is deployed as a beacon proxy, so we'll
118:         // allow the governor of the beacon to reinitialize the token.
119:         address beaconAddress = _getBeacon();
120:         require(msg.sender == UpgradeableBeacon(beaconAddress).owner(), "tt");
121: 
122:         __ERC20_init_unchained(_newName, _newSymbol);
123:         __ERC20Permit_init(_newName);
124:         availableGetters = _availableGetters;
125: 
126:         emit BridgeInitialize(l1Address, _newName, _newSymbol, decimals_);
127:     }
```
[50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L50-L102), [111](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L111-L127)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

84:     function setChainId(uint256 _newChainId) external onlyCallFromForceDeployer { 
85:         chainId = _newChainId;
86:     }

99:     function setTxOrigin(address _newOrigin) external onlyCallFromBootloader { 
100:         origin = _newOrigin;
101:     }

105:     function setGasPrice(uint256 _gasPrice) external onlyCallFromBootloader { 
106:         gasPrice = _gasPrice;
107:     }

112:     function setPubdataInfo(uint256 _gasPerPubdataByte, uint256 _basePubdataSpent) external onlyCallFromBootloader { 
113:         basePubdataSpent = _basePubdataSpent;
114:         gasPerPubdataByte = _gasPerPubdataByte;
115:     }
```
[84](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L84-L86), [99](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L99-L101), [105](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L105-L107), [112](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L112-L115)

</details>


---
### [GAS&#x2011;15] Avoid zero to non-zero storage writes where possible
Changing a storage variable from zero to non-zero costs **22,100 gas** in total. (20,000 gas for a zero to non-zero write and 2,100 for a cold storage access)

Consider using non-zero architecture to avoid high gas costs for zero to non-zero storage writes.


Gas saved per Instance: ~22,100 *(Total: ~486,200)*
<details>
<summary><i>There are 22 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

111:         eraFirstPostUpgradeBatch = _eraFirstPostUpgradeBatch; 
```
[111](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L111)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

49:         minDelay = _minDelay; 

251:         minDelay = _newDelay; 
```
[49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L49), [251](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L251)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

86:         protocolVersion = _initializeData.protocolVersion; 

148:         protocolVersion = _newProtocolVersion; 
```
[86](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L86), [148](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L148)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

57:         executionDelay = _executionDelay; 

97:         executionDelay = _executionDelay; 
```
[57](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L57), [97](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L97)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

239:             ds.facetToSelectors[_facet].selectors[selectorPosition] = lastSelector; 

268:             ds.facets[facetPosition] = lastFacet; 
```
[239](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L239), [268](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L268)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol

59:         _queue.data[tail] = _operation; 
```
[59](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L59)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

95:             decimals_ = decimalsUint8; 
```
[95](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L95)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

330:         numberOfLogsToProcess = 0; 
```
[330](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L330)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

65:         totalSupply += _amount; 

107:             totalSupply -= amount; 
```
[65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L65), [107](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L107)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

85:         chainId = _newChainId; 

106:         gasPrice = _gasPrice; 

113:         basePubdataSpent = _basePubdataSpent; 
114:         gasPerPubdataByte = _gasPerPubdataByte;

463:         baseFee = _baseFee; 

479:         baseFee = _baseFee; 

483:         txNumberInBlock += 1; 

487:         txNumberInBlock = 0; 
```
[85](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L85), [106](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L106), [113](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L113-L114), [463](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L463), [479](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L479), [483](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L483), [487](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L487)

</details>


---
### [GAS&#x2011;16] Bytes constants are more efficient than string constants
If a string can fit in 32 bytes is it better to use `bytes32` instead of `string`, as it is cheaper.


Gas saved per Instance: ~378 *(Total: ~1,890)*
<details>
<summary><i>There are 5 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

26:     string public constant override getName = "ValidatorTimelock"; 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L26)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

20:     string public constant override getName = "AdminFacet"; 
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L20)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

27:     string public constant override getName = "ExecutorFacet"; 
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L27)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

25:     string public constant override getName = "GettersFacet"; 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L25)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

35:     string public constant override getName = "MailboxFacet"; 
```
[35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L35)

</details>


---
### [GAS&#x2011;17] `bytes.concat()` can be used in place of `abi.encodePacked`
Given concatenation is not going to be used for hashing `bytes.concat` is the preferred method to use as its more gas efficient

<details>
<summary><i>There are 6 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

461:                     abi.encodePacked( 
462:                         _prevBatchCommitment,
463:                         _currentBatchCommitment,
464:                         _verifierParams.recursionNodeLevelVkHash,
465:                         _verifierParams.recursionLeafLevelVkHash
466:                     )

548:             abi.encodePacked( 
549:                 l2ToL1LogsHash,
550:                 _stateDiffHash,
551:                 _batch.bootloaderHeapInitialContentsHash,
552:                 _batch.eventsQueueStateHash,
553:                 _encodeBlobAuxilaryOutput(_blobCommitments, _blobHashes)
554:             );

610:         bytes memory precompileInput = abi.encodePacked(_versionedHash, _openingPoint, _openingValueCommitmentProof); 

655:                 abi.encodePacked(blobVersionedHash, _pubdataCommitments[i:i + PUBDATA_COMMITMENT_COMMITMENT_OFFSET]) 
```
[461](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L461-L466), [548](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L548-L554), [610](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L610), [655](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L655)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

133:                 keccak256(abi.encodePacked(_transaction.factoryDeps)), 

142:         return keccak256(abi.encodePacked("\x19\x01", domainSeparator, structHash)); 
```
[133](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L133), [142](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L142)

</details>


---
### [GAS&#x2011;18] Cache array length outside of loop
If not cached, the solidity compiler will always read the length of the array during each iteration. That is, if it is a storage array, this is an extra sload operation (100 additional extra gas for each iteration except for the first) and if it is a memory array, this is an extra mload operation (3 additional gas for each iteration except for the first).


Gas saved per Instance: ~4 *(Total: ~44)*
<details>
<summary><i>There are 11 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

225:         for (uint256 i = 0; i < _calls.length; ++i) { 
```
[225](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L225)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

116:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 

135:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 

185:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 

209:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 
```
[116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L116), [135](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L135), [185](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L185), [209](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L209)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

142:         for (uint256 i = 0; i < emittedL2Logs.length; i = i.uncheckedAdd(L2_TO_L1_LOG_SERIALIZE_SIZE)) { 

257:         for (uint256 i = 0; i < _newBatchesData.length; i = i.uncheckedInc()) { 

289:         for (uint256 i = 0; i < _newBatchesData.length; i = i.uncheckedInc()) { 

636:         for (uint256 i = 0; i < _pubdataCommitments.length; i += PUBDATA_COMMITMENT_SIZE) { 
```
[142](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L142), [257](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L257), [289](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L289), [636](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L636)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

226:         for (uint256 i = 0; i < _factoryDeps.length; ++i) { 
```
[226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L226)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

61:             for (uint256 encodedDataPointer = 0; encodedDataPointer < encodedData.length; encodedDataPointer += 2) { 
```
[61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L61)

</details>


---
### [GAS&#x2011;19] Cache external calls outside of loop to avoid re-calling function on each iteration
Performing `STATICCALL` that do not depend on variables incremented in loops should always try to be avoided within the loop. In the following instances, we are able to cache the external calls outside of the loop to save a `STATICCALL` (100 gas) per loop iteration.


Gas saved per Instance: ~100 *(Total: ~1,400)*
<details>
<summary><i>There are 14 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

/// @audit popFront() on line 312
311:         for (uint256 i = 0; i < _nPriorityOps; i = i.uncheckedInc()) { 
312:             PriorityOperation memory priorityOp = s.priorityQueue.popFront();
313:             concatHash = keccak256(abi.encode(concatHash, priorityOp.canonicalTxHash));
314:         }

/// @audit uncheckedInc() on line 406
405:         for (uint256 i = 0; i < committedBatchesLength; i = i.uncheckedInc()) { 
406:             currentTotalBatchesVerified = currentTotalBatchesVerified.uncheckedInc();
407:             require(
408:                 _hashStoredBatchInfo(_committedBatches[i]) == s.storedBatchHashes[currentTotalBatchesVerified],
409:                 "o1"
410:             );
411: 
412:             bytes32 currentBatchCommitment = _committedBatches[i].commitment;
413:             proofPublicInput[i] = _getBatchProofPublicInput(
414:                 prevBatchCommitment,
415:                 currentBatchCommitment,
416:                 verifierParams
417:             );
418: 
419:             prevBatchCommitment = currentBatchCommitment;
420:         }
```
[311](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L311-L314), [405](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L405-L420)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

/// @audit readUint64() on line 65
61:             for (uint256 encodedDataPointer = 0; encodedDataPointer < encodedData.length; encodedDataPointer += 2) { 
62:                 uint256 indexOfEncodedChunk = uint256(encodedData.readUint16(encodedDataPointer)) * 8;
63:                 require(indexOfEncodedChunk < dictionary.length, "Encoded chunk index is out of bounds");
64: 
65:                 uint64 encodedChunk = dictionary.readUint64(indexOfEncodedChunk);
66:                 uint64 realChunk = _bytecode.readUint64(encodedDataPointer * 4);
67: 
68:                 require(encodedChunk == realChunk, "Encoded chunk does not match the original bytecode");
69:             }

/// @audit readBytes32() on line 140
/// @audit readUint256() on line 139
/// @audit readUint256() on line 138
/// @audit readBytes32() on line 137
/// @audit readUint64() on line 129
127:         for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) { 
128:             bytes calldata stateDiff = _stateDiffs[i:i + STATE_DIFF_ENTRY_SIZE];
129:             uint64 enumIndex = stateDiff.readUint64(84);
130:             if (enumIndex != 0) {
131:                 // It is a repeated write, so we skip it.
132:                 continue;
133:             }
134: 
135:             numInitialWritesProcessed++;
136: 
137:             bytes32 derivedKey = stateDiff.readBytes32(52);
138:             uint256 initValue = stateDiff.readUint256(92);
139:             uint256 finalValue = stateDiff.readUint256(124);
140:             require(derivedKey == _compressedStateDiffs.readBytes32(stateDiffPtr), "iw: initial key mismatch");
141:             stateDiffPtr += 32;
142: 
143:             uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr]));
144:             stateDiffPtr++;
145:             uint8 operation = metadata & OPERATION_BITMASK;
146:             uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;
147:             _verifyValueCompression(
148:                 initValue,
149:                 finalValue,
150:                 operation,
151:                 _compressedStateDiffs[stateDiffPtr:stateDiffPtr + len]
152:             );
153:             stateDiffPtr += len;
154:         }

/// @audit readUint256() on line 167
/// @audit readUint256() on line 166
/// @audit readUint64() on line 161
159:         for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) { 
160:             bytes calldata stateDiff = _stateDiffs[i:i + STATE_DIFF_ENTRY_SIZE];
161:             uint64 enumIndex = stateDiff.readUint64(84);
162:             if (enumIndex == 0) {
163:                 continue;
164:             }
165: 
166:             uint256 initValue = stateDiff.readUint256(92);
167:             uint256 finalValue = stateDiff.readUint256(124);
168:             uint256 compressedEnumIndex = _sliceToUint256(
169:                 _compressedStateDiffs[stateDiffPtr:stateDiffPtr + _enumerationIndexSize]
170:             );
171:             require(enumIndex == compressedEnumIndex, "rw: enum key mismatch");
172:             stateDiffPtr += _enumerationIndexSize;
173: 
174:             uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr]));
175:             stateDiffPtr += 1;
176:             uint8 operation = metadata & OPERATION_BITMASK;
177:             uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;
178:             _verifyValueCompression(
179:                 initValue,
180:                 finalValue,
181:                 operation,
182:                 _compressedStateDiffs[stateDiffPtr:stateDiffPtr + len]
183:             );
184:             stateDiffPtr += len;
185:         }
```
[61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L61-L69), [127](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L127-L154), [159](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L159-L185)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

/// @audit keccak() on line 207
206:         for (uint256 i = 0; i < numberOfL2ToL1Logs; ++i) { 
207:             bytes32 hashedLog = EfficientCall.keccak(
208:                 _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + L2_TO_L1_LOG_SERIALIZE_SIZE]
209:             );
210:             calldataPtr += L2_TO_L1_LOG_SERIALIZE_SIZE;
211:             l2ToL1LogsTreeArray[i] = hashedLog;
212:             reconstructedChainedLogsHash = keccak256(abi.encode(reconstructedChainedLogsHash, hashedLog));
213:         }

/// @audit keccak() on line 239
236:         for (uint256 i = 0; i < numberOfMessages; ++i) { 
237:             uint32 currentMessageLength = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4]));
238:             calldataPtr += 4;
239:             bytes32 hashedMessage = EfficientCall.keccak(
240:                 _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + currentMessageLength]
241:             );
242:             calldataPtr += currentMessageLength;
243:             reconstructedChainedMessagesHash = keccak256(abi.encode(reconstructedChainedMessagesHash, hashedMessage));
244:         }

/// @audit hashL2Bytecode() on line 262
254:         for (uint256 i = 0; i < numberOfBytecodes; ++i) { 
255:             uint32 currentBytecodeLength = uint32(
256:                 bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4])
257:             );
258:             calldataPtr += 4;
259:             reconstructedChainedL1BytecodesRevealDataHash = keccak256(
260:                 abi.encode(
261:                     reconstructedChainedL1BytecodesRevealDataHash,
262:                     Utils.hashL2Bytecode(
263:                         _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + currentBytecodeLength]
264:                     )
265:                 )
266:             );
267:             calldataPtr += currentBytecodeLength;
268:         }
```
[206](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L206-L213), [236](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L236-L244), [254](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L254-L268)

</details>


---
### [GAS&#x2011;20] Consider activating `via-ir` for deploying
The IR-based code generator was introduced with an aim to not only allow code generation to be more transparent and auditable but also to enable more powerful optimization passes that span across functions.You can enable it on the command line using `--via-ir` or with the option `{"viaIR": true}`.This will take longer to compile, but you can just simple test it before deploying and if you got a better benchmark then you can add --via-ir to your deploy commandMore on: https://docs.soliditylang.org/en/v0.8.17/ir-breaking-changes.html


---
### [GAS&#x2011;21] Consider caching repeated computations
The result of repeated computations can be cached to avoid calculating it multiple times and wasting gas.


Gas saved per Instance: ~60 *(Total: ~120)*
<details>
<summary><i>There are 2 instances of this issue:</i></summary>

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

/// @audit 2+dictionaryLen*8 is seen 2 times
197:     function _decodeRawBytecode( 
```
[197](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L197)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

/// @audit calldataPtr+4 is seen 6 times
194:     function publishPubdataAndClearState( 
```
[194](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L194)

</details>


---
### [GAS&#x2011;22] Consider merging sequential for loops
Merging multiple `for` loops within a function in Solidity can enhance efficiency and reduce gas costs, especially when they share a common iterating variable or perform related operations. By minimizing redundant iterations over the same data set, execution becomes more cost-effective. However, while merging can optimize gas usage and simplify logic, it may also increase code complexity. Therefore, careful balance between optimization and maintainability is essential, along with thorough testing to ensure the refactored code behaves as expected.


<i>There are 2 instaces of this issue:</i>

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

/// @audit consider merging with loops from line: 253
248:         for (uint256 i = 0; i < deploymentsLength; ++i) { 

/// @audit consider merging with loops from line: 248
253:         for (uint256 i = 0; i < deploymentsLength; ++i) { 
```
[248](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L248), [253](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L253)


---
### [GAS&#x2011;23] Consider packing small `uint`s when it's possible
Packing uint variables into the same storage slot can help in reducing gas costs. This is particularly useful when storing or reading multiple smaller uints (e.g., uint80) in a single transaction. Consider using bit manipulation to pack these variables.

If you pack two uint variables into a single uint storage slot, you'd perform only one `SLOAD` operation (800 gas) instead of two (1,600 gas) when you read them. This saves **800 gas** for each read operation involving the two variables.

Similarly, when you need to update both variables, a single `SSTORE` operation would cost you 20,000 gas instead of 40,000 gas, saving you another **20,000 gas**.

Example:
```solidity
uint160 packedVariables;

function packVariables(uint80 x, uint80 y) external {
    packedVariables = uint160(x) << 80 | uint160(y);
}
```


Gas saved per Instance: ~20,800 *(Total: ~41,600)*

<i>There are 2 instaces of this issue:</i>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

32:         uint16 selectorPosition; 

41:         uint16 facetPosition; 
```
[32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L32), [41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L41)


---
### [GAS&#x2011;24] Consider pre-calculating the address of `address(this)`
It can be more gas-efficient to use a hardcoded address instead of the `address(this)` expression, especially if you need to use the same address multiple times in your contract.

The reason for this, is that using `address(this)` requires an additional `EXTCODESIZE` operation to retrieve the contract‚Äôs address from its bytecode, which can increase the gas cost of your contract. By pre-calculating and using a hardcoded address, you can avoid this additional operation and reduce the overall gas cost of your contract.

<details>
<summary><i>There are 21 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

65:         uint256 amount = IERC20(_token).balanceOf(address(this)); 
```
[65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L65)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

118:             uint256 balanceBefore = address(this).balance; 

120:             uint256 balanceAfter = address(this).balance; 

127:             uint256 balanceBefore = IERC20(_token).balanceOf(address(this)); 

131:             uint256 balanceAfter = IERC20(_token).balanceOf(address(this)); 

174:         uint256 balanceBefore = _token.balanceOf(address(this)); 
175:         _token.safeTransferFrom(_from, address(this), _amount);
176:         uint256 balanceAfter = _token.balanceOf(address(this));
```
[118](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L118), [120](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L120), [127](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L127), [131](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L131), [174](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L174-L176)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

59:         require(msg.sender == address(this), "Only governance contract itself is allowed to call this function"); 
```
[59](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L59)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

265:             bytes32(uint256(uint160(address(this)))), 
```
[265](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L265)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

41:         uint256 amount = address(this).balance; 
```
[41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L41)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

153:             L2ContractHelper.computeCreate2Address(address(this), salt, l2TokenProxyBytecodeHash, constructorInputHash); 
```
[153](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L153)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

29:         require(msg.sender == address(this), "Callable only by self"); 

333:                 BASE_TOKEN_SYSTEM_CONTRACT.transferFromTo(address(this), _newAddress, value); 
```
[29](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L29), [333](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L333)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

47:         if (codeAddress != address(this)) { 

100:         require(totalRequiredBalance <= address(this).balance, "Not enough balance for fee + value"); 

188:         return recoveredAddress == address(this) && recoveredAddress != address(0); 
```
[47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L47), [100](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L100), [188](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L188)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

129:             sender: address(this), 
```
[129](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L129)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

106:             balance[address(this)] -= amount; 
```
[106](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L106)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

60:         require(to != address(this), "MsgValueSimulator calls itself"); 
```
[60](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L60)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

377:             uint256 currentAllowance = IERC20(token).allowance(address(this), paymaster); 
```
[377](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L377)

</details>


---
### [GAS&#x2011;25] Consider using OpenZeppelin's `EnumerateSet` instead of nested mappings
Nested mappings and multi-dimensional arrays in Solidity operate through a process of double hashing, wherein the original storage slot and the first key are concatenated and hashed, and then this hash is again concatenated with the second key and hashed. This process can be quite gas expensive due to the double-hashing operation and subsequent storage operation (sstore).

OpenZeppelin's `EnumerableSet` provides a potential solution to this problem. It creates a data structure that combines the benefits of set operations with the ability to enumerate stored elements, which is not natively available in Solidity. EnumerableSet handles the element uniqueness internally and can therefore provide a more gas-efficient and collision-resistant alternative to nested mappings or multi-dimensional arrays in certain scenarios.


Gas saved per Instance: ~1,000 *(Total: ~10,000)*
<details>
<summary><i>There are 10 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

27:     mapping(uint256 l2BatchNumber => mapping(uint256 l2ToL1MessageNumber => bool isFinalized)) 

32:     mapping(address account => mapping(address l1Token => mapping(bytes32 depositL2TxHash => uint256 amount))) 

51:     mapping(address => mapping(address => uint256)) private __DEPRECATED_totalDepositedAmountPerUser; 
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L27), [32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L32), [51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L51)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

52:     mapping(uint256 chainId => mapping(bytes32 l2DepositTxHash => bytes32 depositDataHash)) 

57:     mapping(uint256 chainId => mapping(uint256 l2BatchNumber => mapping(uint256 l2ToL1MessageNumber => bool isFinalized))) 

65:     mapping(uint256 chainId => mapping(address l1Token => uint256 balance)) internal chainBalance; 
```
[52](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L52), [57](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L57), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L65)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

50:     mapping(uint256 _chainId => mapping(address _validator => bool)) public validators; 
```
[50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L50)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol

114:     mapping(uint256 l2BatchNumber => mapping(uint256 l2ToL1MessageNumber => bool isFinalized)) isEthWithdrawalFinalized; 
```
[114](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol#L114)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

21:     mapping(uint256 contractAddress => mapping(uint256 index => bytes32 value)) internal immutableDataStorage; 
```
[21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L21)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

41:     mapping(uint256 account => mapping(uint256 nonceKey => uint256 value)) internal nonceValues; 
```
[41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L41)

</details>


---
### [GAS&#x2011;26] Consider using Solady's gas optimized lib for Math
Utilizing gas-optimized math functions from libraries like [Solady](https://github.com/Vectorized/solady/blob/main/src/utils/FixedPointMathLib.sol) can lead to more efficient smart contracts.
This is particularly beneficial in contracts where these operations are frequently used.

<details>
<summary><i>There are 47 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

123:                 chainBalance[_targetChainId][ETH_TOKEN_ADDRESS] + 
124:                 balanceAfter -
125:                 balanceBefore;
```
[123](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L123-L125)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol

30:         hashedBytecode = (hashedBytecode | bytes32(uint256(1 << 248))); 

32:         hashedBytecode = hashedBytecode | bytes32(bytecodeLenInWords << 224); 

50:         codeLengthInWords = uint256(uint8(_bytecodeHash[2])) * 256 + uint256(uint8(_bytecodeHash[3])); 
```
[30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L30), [32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L32), [50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L50)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

323:         require(currentBatchNumber == s.totalBatchesExecuted + _executedBatchIdx + 1, "k"); // Execute batches in order 

582:             blobAuxOutputWords[i * 2 + 1] = _blobCommitments[i]; 

593:         return (_bitMap & (1 << _index)) > 0; 

598:         return _bitMap | (1 << _index); 
```
[323](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L323), [582](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L582), [593](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L593), [598](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L598)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

159:         uint256 l1GasPriceConverted = (_l1GasPrice * s.baseTokenGasPriceMultiplierNominator) / 
160:             s.baseTokenGasPriceMultiplierDenominator;

167:         uint256 fullPubdataPriceBaseToken = pubdataPriceBaseToken + 
168:             batchOverheadBaseToken /
169:             uint256(feeParams.maxPubdataPerBatch);

171:         uint256 l2GasPrice = feeParams.minimalL2GasPrice + batchOverheadBaseToken / uint256(feeParams.maxL2GasPerBatch); 
172:         uint256 minL2GasPriceBaseToken = (fullPubdataPriceBaseToken + _gasPerPubdata - 1) / _gasPerPubdata;
```
[159](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L159-L160), [167](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L167-L169), [171](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L171-L172)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/LibMap.sol

27:             uint256 bitOffset = (_index & 7) * 32; 

48:             uint256 bitOffset = (_index & 7) * 32; 

61:             _map.map[mapIndex] = (newValueXorOldValue << bitOffset) ^ mapValue; 
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L27), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L48), [61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L61)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol

98:             costForPubdata += _numberOfFactoryDependencies * L1_TX_DELTA_FACTORY_DEPS_PUBDATA * _l2GasPricePerPubdata; 
```
[98](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L98)

```solidity
üìÅ File: system-contracts/contracts/BootloaderUtilities.sol

97:                 vInt += 8 + block.chainid * 2; 

105:             uint256 listLength = encodedNonce.length + 
106:                 encodedGasParam.length +
107:                 encodedTo.length +
108:                 encodedValue.length +
109:                 encodedDataLength.length +
110:                 _transaction.data.length +
111:                 rEncoded.length +
112:                 sEncoded.length +
113:                 vEncoded.length;

198:             uint256 listLength = encodedFixedLengthParams.length + 
199:                 encodedDataLength.length +
200:                 _transaction.data.length +
201:                 encodedAccessListLength.length +
202:                 rEncoded.length +
203:                 sEncoded.length +
204:                 vEncoded.length;

293:             uint256 listLength = encodedFixedLengthParams.length + 
294:                 encodedDataLength.length +
295:                 _transaction.data.length +
296:                 encodedAccessListLength.length +
297:                 rEncoded.length +
298:                 sEncoded.length +
299:                 vEncoded.length;
```
[97](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L97), [105](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L105-L113), [198](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L198-L204), [293](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L293-L299)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

203:             dictionary = _rawCompressedData[2:2 + dictionaryLen * 8]; 
204:             encodedData = _rawCompressedData[2 + dictionaryLen * 8:];

253:         number >>= (256 - (_calldataSlice.length * 8)); 
```
[203](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L203-L204), [253](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L253)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

51:         return KECCAK_ROUND_GAS_COST * (_length / KECCAK_ROUND_NUMBER_OF_BYTES + 1); 

62:         return SHA256_ROUND_GAS_COST * ((_length + 8) / SHA256_ROUND_NUMBER_OF_BYTES + 1); 

89:         uint256 gasToPay = keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) + 2 * keccakGasCost(64); 

140:             pubdataLen = 4 + _message.length + L2_TO_L1_LOG_SERIALIZE_SIZE; 

148:         uint256 gasToPay = keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) + 
149:             3 *
150:             keccakGasCost(64) +
151:             gasSpentOnMessageHashing +
152:             COMPUTATIONAL_PRICE_FOR_PUBDATA *
153:             pubdataLen;

175:         uint256 gasToPay = sha256GasCost(bytecodeLen) + 
176:             keccakGasCost(64) +
177:             COMPUTATIONAL_PRICE_FOR_PUBDATA *
178:             pubdataLen;

226:                     abi.encode(l2ToL1LogsTreeArray[2 * i], l2ToL1LogsTreeArray[2 * i + 1]) 

303:         bytes calldata stateDiffs = _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 
304:             (numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE)];
```
[51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L51), [62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L62), [89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L89), [140](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L140), [148](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L148-L153), [175](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L175-L178), [226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L226), [303](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L303-L304)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

416:         uint256 packedTimestamps = (uint256(currentBatchTimestamp) << 128) | currentL2BlockTimestamp; 

498:         blockInfo = (uint256(blockNumber) << 128) | uint256(blockTimestamp); 
```
[416](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L416), [498](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L498)

```solidity
üìÅ File: system-contracts/contracts/libraries/EfficientCall.sol

261:         uint32 shrinkTo = uint32(msg.data.length - (_data.length + dataOffset)); 
```
[261](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L261)

```solidity
üìÅ File: system-contracts/contracts/libraries/RLPEncoder.sol

37:                 uint256 shiftedVal = _val << (lbs * 8); 

69:                 encoded[0] = bytes1(uint8(_offset + hbs + 56)); 

72:                 uint256 shiftedVal = uint256(_len) << (lbs * 8); 
```
[37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L37), [69](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L69), [72](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L72)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractHelper.sol

155:         uint256 params = uint256(_gasToBurn) + (uint256(_pubdataToSpend) << 32); 

217:         uint256 shifted = (meta << (256 - size - offset)); 

219:         result = (shifted >> (256 - size)); 
```
[155](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L155), [217](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L217), [219](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L219)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

190:             uint256 listLength = encodedNonce.length + 
191:                 encodedGasParam.length +
192:                 encodedTo.length +
193:                 encodedValue.length +
194:                 encodedDataLength.length +
195:                 _transaction.data.length +
196:                 encodedChainId.length;

265:             uint256 listLength = encodedFixedLengthParams.length + 
266:                 encodedDataLength.length +
267:                 _transaction.data.length +
268:                 encodedAccessListLength.length;

337:             uint256 listLength = encodedFixedLengthParams.length + 
338:                 encodedDataLength.length +
339:                 _transaction.data.length +
340:                 encodedAccessListLength.length;

411:             requiredBalance = _transaction.maxFeePerGas * _transaction.gasLimit + _transaction.value; 
```
[190](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L190-L196), [265](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L265-L268), [337](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L337-L340), [411](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L411)

```solidity
üìÅ File: system-contracts/contracts/libraries/Utils.sol

46:             codeLengthInWords = uint256(uint8(_bytecodeHash[2])) * 256 + uint256(uint8(_bytecodeHash[3])); 

93:         hashedBytecode = (hashedBytecode | bytes32(uint256(1 << 248))); 

95:         hashedBytecode = hashedBytecode | bytes32(lengthInWords << 224); 
```
[46](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L46), [93](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L93), [95](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L95)

</details>


---
### [GAS&#x2011;27] Constructors can be marked `payable`
Payable functions cost less gas to execute, since the compiler does not have to add extra checks to ensure that a payment wasn't provided. A constructor can safely be marked as payable, since only the deployer would be able to pass funds, and the project itself would not pass any funds.


Gas saved per Instance: ~21 *(Total: ~210)*
<details>
<summary><i>There are 10 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

55:     constructor(IL1SharedBridge _sharedBridge) reentrancyGuardInitializer { 
```
[55](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L55)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

90:     constructor( 
```
[90](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L90)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

38:     constructor() reentrancyGuardInitializer {} 
```
[38](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L38)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

41:     constructor(address _admin, address _securityCouncil, uint256 _minDelay) { 
```
[41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L41)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

58:     constructor(address _bridgehub) reentrancyGuardInitializer { 
```
[58](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L58)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

55:     constructor(address _initialOwner, uint32 _executionDelay) { 
```
[55](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L55)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol

19:     constructor() reentrancyGuardInitializer {} 
```
[19](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L19)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol

11:     constructor(uint256 _chainId, Diamond.DiamondCutData memory _diamondCut) { 
```
[11](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L11)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

41:     constructor() { 
```
[41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L41)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

40:     constructor() { 
```
[40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L40)

</details>


---
### [GAS&#x2011;28] Counting down in `for` statements is more gas efficient
Counting down is more gas efficient than counting up because neither we are making zero variable to non-zero variable and also we will get gas refund in the last transaction when making non-zero to zero variable. [More info](https://solodit.xyz/issues/g-02-counting-down-in-for-statements-is-more-gas-efficient-code4rena-pooltogether-pooltogether-git)


Gas saved per Instance: ~16 *(Total: ~288)*
<details>
<summary><i>There are 18 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

225:         for (uint256 i = 0; i < _calls.length; ++i) { 
```
[225](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L225)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

116:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 

135:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 

185:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 

209:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 
```
[116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L116), [135](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L135), [185](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L185), [209](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L209)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

580:         for (uint i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 

667:         for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 
```
[580](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L580), [667](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L667)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

226:         for (uint256 i = 0; i < _factoryDeps.length; ++i) { 
```
[226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L226)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

248:         for (uint256 i = 0; i < deploymentsLength; ++i) { 

253:         for (uint256 i = 0; i < deploymentsLength; ++i) { 
```
[248](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L248), [253](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L253)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

38:             for (uint256 i = 0; i < immutablesLength; ++i) { 
```
[38](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L38)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

30:             for (uint256 i = 0; i < hashesLen; ++i) { 
```
[30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L30)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

206:         for (uint256 i = 0; i < numberOfL2ToL1Logs; ++i) { 

218:         for (uint256 i = numberOfL2ToL1Logs; i < L2_TO_L1_LOGS_MERKLE_TREE_LEAVES; ++i) { 

224:             for (uint256 i = 0; i < nodesOnCurrentLevel; ++i) { 

236:         for (uint256 i = 0; i < numberOfMessages; ++i) { 

254:         for (uint256 i = 0; i < numberOfBytecodes; ++i) { 
```
[206](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L206), [218](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L218), [224](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L224), [236](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L236), [254](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L254)

```solidity
üìÅ File: system-contracts/contracts/PubdataChunkPublisher.sol

36:         for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 
```
[36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L36)

</details>


---
### [GAS&#x2011;29] Declare variables outside of loops
Variables should be declared outside of loops, and get overriden with each iteration of loop, By doing so we save gas cost for memory variable declaration in each iteration.


Gas saved per Instance: ~15 *(Total: ~705)*
<details>
<summary><i>There are 47 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

/// @audit loop from line 185 to line 196
186:                 uint256 commitBatchTimestamp = committedBatchTimestamp[ERA_CHAIN_ID].get( 

/// @audit loop from line 209 to line 218
210:                 uint256 commitBatchTimestamp = committedBatchTimestamp[_chainId].get(_newBatchesData[i].batchNumber); 
```
[186](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L186), [210](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L210)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

/// @audit loop from line 289 to line 304
291:             bytes32 expectedUpgradeTxHash = i == 0 ? _systemContractUpgradeTxHash : bytes32(0); 

/// @audit loop from line 311 to line 314
312:             PriorityOperation memory priorityOp = s.priorityQueue.popFront(); 

/// @audit loop from line 405 to line 420
412:             bytes32 currentBatchCommitment = _committedBatches[i].commitment; 

/// @audit loop from line 636 to line 658
637:             bytes32 blobVersionedHash = _getBlobVersionedHash(versionedHashIndex); 

/// @audit loop from line 636 to line 658
643:             bytes32 openingPoint = bytes32( 
```
[291](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L291), [312](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L312), [412](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L412), [637](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L637), [643](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L643)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

/// @audit loop from line 208 to line 213
209:             address facetAddr = ds.facets[i]; 
/// @audit loop from line 208 to line 213
210:             Diamond.FacetToSelectors memory facetToSelectors = ds.facetToSelectors[facetAddr];
```
[209](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L209-L210)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

/// @audit loop from line 356 to line 363
357:             bytes32 hashedBytecode = L2ContractHelper.hashL2Bytecode(_factoryDeps[i]); 
```
[357](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L357)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

/// @audit loop from line 101 to line 118
102:             Action action = facetCuts[i].action; 
/// @audit loop from line 101 to line 118
103:             address facet = facetCuts[i].facet;
/// @audit loop from line 101 to line 118
104:             bool isFacetFreezable = facetCuts[i].isFreezable;
/// @audit loop from line 101 to line 118
105:             bytes4[] memory selectors = facetCuts[i].selectors;

/// @audit loop from line 138 to line 144
139:             bytes4 selector = _selectors[i]; 
/// @audit loop from line 138 to line 144
140:             SelectorToFacet memory oldFacet = ds.selectorToFacet[selector];

/// @audit loop from line 158 to line 167
159:             bytes4 selector = _selectors[i]; 
/// @audit loop from line 158 to line 167
160:             SelectorToFacet memory oldFacet = ds.selectorToFacet[selector];

/// @audit loop from line 178 to line 184
179:             bytes4 selector = _selectors[i]; 
/// @audit loop from line 178 to line 184
180:             SelectorToFacet memory oldFacet = ds.selectorToFacet[selector];
```
[102](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L102-L105), [139](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L139-L140), [159](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L159-L160), [179](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L179-L180)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

/// @audit loop from line 61 to line 69
62:                 uint256 indexOfEncodedChunk = uint256(encodedData.readUint16(encodedDataPointer)) * 8; 

/// @audit loop from line 61 to line 69
65:                 uint64 encodedChunk = dictionary.readUint64(indexOfEncodedChunk); 
/// @audit loop from line 61 to line 69
66:                 uint64 realChunk = _bytecode.readUint64(encodedDataPointer * 4);

/// @audit loop from line 127 to line 154
128:             bytes calldata stateDiff = _stateDiffs[i:i + STATE_DIFF_ENTRY_SIZE]; 
/// @audit loop from line 127 to line 154
129:             uint64 enumIndex = stateDiff.readUint64(84);

/// @audit loop from line 127 to line 154
137:             bytes32 derivedKey = stateDiff.readBytes32(52); 
/// @audit loop from line 127 to line 154
138:             uint256 initValue = stateDiff.readUint256(92);
/// @audit loop from line 127 to line 154
139:             uint256 finalValue = stateDiff.readUint256(124);

/// @audit loop from line 127 to line 154
143:             uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr])); 

/// @audit loop from line 127 to line 154
145:             uint8 operation = metadata & OPERATION_BITMASK; 
/// @audit loop from line 127 to line 154
146:             uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;

/// @audit loop from line 159 to line 185
160:             bytes calldata stateDiff = _stateDiffs[i:i + STATE_DIFF_ENTRY_SIZE]; 
/// @audit loop from line 159 to line 185
161:             uint64 enumIndex = stateDiff.readUint64(84);

/// @audit loop from line 159 to line 185
166:             uint256 initValue = stateDiff.readUint256(92); 
/// @audit loop from line 159 to line 185
167:             uint256 finalValue = stateDiff.readUint256(124);
/// @audit loop from line 159 to line 185
168:             uint256 compressedEnumIndex = _sliceToUint256(

/// @audit loop from line 159 to line 185
174:             uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr])); 

/// @audit loop from line 159 to line 185
176:             uint8 operation = metadata & OPERATION_BITMASK; 
/// @audit loop from line 159 to line 185
177:             uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;
```
[62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L62), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L65-L66), [128](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L128-L129), [137](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L137-L139), [143](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L143), [145](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L145-L146), [160](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L160-L161), [166](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L166-L168), [174](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L174), [176](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L176-L177)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

/// @audit loop from line 38 to line 42
39:                 uint256 index = _immutables[i].index; 
/// @audit loop from line 38 to line 42
40:                 bytes32 value = _immutables[i].value;
```
[39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L39-L40)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

/// @audit loop from line 206 to line 213
207:             bytes32 hashedLog = EfficientCall.keccak( 

/// @audit loop from line 236 to line 244
237:             uint32 currentMessageLength = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4])); 

/// @audit loop from line 236 to line 244
239:             bytes32 hashedMessage = EfficientCall.keccak( 

/// @audit loop from line 254 to line 268
255:             uint32 currentBytecodeLength = uint32( 
```
[207](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L207), [237](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L237), [239](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L239), [255](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L255)

```solidity
üìÅ File: system-contracts/contracts/PubdataChunkPublisher.sol

/// @audit loop from line 36 to line 53
37:             uint256 start = BLOB_SIZE_BYTES * i; 

/// @audit loop from line 36 to line 53
45:             bytes32 blobHash; 
```
[37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L37), [45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L45)

</details>


---
### [GAS&#x2011;30] Do not calculate constants
Due to how constant variables are implemented (replacements at compile-time), an expression assigned to a constant variable is recomputed each time that the variable is used, which wastes some gas.

<details>
<summary><i>There are 65 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/common/Config.sol

14: uint256 constant MAX_L2_TO_L1_LOGS_COMMITMENT_BYTES = 4 + L2_TO_L1_LOG_SERIALIZE_SIZE * 512; 

112: bytes32 constant TWO_BRIDGES_MAGIC_VALUE = bytes32(uint256(keccak256("TWO_BRIDGES_MAGIC_VALUE")) - 1); 
```
[14](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/Config.sol#L14), [112](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/Config.sol#L112)

```solidity
üìÅ File: contracts/zksync/contracts/L2ContractHelper.sol

70: address constant BOOTLOADER_ADDRESS = address(SYSTEM_CONTRACTS_OFFSET + 0x01); 
71: address constant MSG_VALUE_SYSTEM_CONTRACT = address(SYSTEM_CONTRACTS_OFFSET + 0x09);
72: address constant DEPLOYER_SYSTEM_CONTRACT = address(SYSTEM_CONTRACTS_OFFSET + 0x06);

74: IL2Messenger constant L2_MESSENGER = IL2Messenger(address(SYSTEM_CONTRACTS_OFFSET + 0x08)); 

76: IBaseToken constant L2_BASE_TOKEN_ADDRESS = IBaseToken(address(SYSTEM_CONTRACTS_OFFSET + 0x0a)); 
```
[70](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L70-L72), [74](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L74), [76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L76)

```solidity
üìÅ File: contracts/zksync/contracts/SystemContractsCaller.sol

7: address constant SYSTEM_CALL_CALL_ADDRESS = address((1 << 16) - 11); 
```
[7](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L7)

```solidity
üìÅ File: system-contracts/contracts/Constants.sol

20: uint160 constant SYSTEM_CONTRACTS_OFFSET = 2^15; // 2^15 

48: address payable constant BOOTLOADER_FORMAL_ADDRESS = payable(address(SYSTEM_CONTRACTS_OFFSET + 0x01)); 
49: IAccountCodeStorage constant ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT = IAccountCodeStorage(
50:     address(SYSTEM_CONTRACTS_OFFSET + 0x02)
51: );
52: INonceHolder constant NONCE_HOLDER_SYSTEM_CONTRACT = INonceHolder(address(SYSTEM_CONTRACTS_OFFSET + 0x03));
53: IKnownCodesStorage constant KNOWN_CODE_STORAGE_CONTRACT = IKnownCodesStorage(address(SYSTEM_CONTRACTS_OFFSET + 0x04));
54: IImmutableSimulator constant IMMUTABLE_SIMULATOR_SYSTEM_CONTRACT = IImmutableSimulator(
55:     address(SYSTEM_CONTRACTS_OFFSET + 0x05)
56: );
57: IContractDeployer constant DEPLOYER_SYSTEM_CONTRACT = IContractDeployer(address(SYSTEM_CONTRACTS_OFFSET + 0x06));

61: address constant FORCE_DEPLOYER = address(SYSTEM_CONTRACTS_OFFSET + 0x07); 
62: IL1Messenger constant L1_MESSENGER_CONTRACT = IL1Messenger(address(SYSTEM_CONTRACTS_OFFSET + 0x08));
63: address constant MSG_VALUE_SYSTEM_CONTRACT = address(SYSTEM_CONTRACTS_OFFSET + 0x09);

65: IBaseToken constant BASE_TOKEN_SYSTEM_CONTRACT = IBaseToken(address(SYSTEM_CONTRACTS_OFFSET + 0x0a)); 
66: IBaseToken constant REAL_BASE_TOKEN_SYSTEM_CONTRACT = IBaseToken(address(REAL_SYSTEM_CONTRACTS_OFFSET + 0x0a));

73: ISystemContext constant SYSTEM_CONTEXT_CONTRACT = ISystemContext(payable(address(SYSTEM_CONTRACTS_OFFSET + 0x0b))); 
74: ISystemContext constant REAL_SYSTEM_CONTEXT_CONTRACT = ISystemContext(payable(address(REAL_SYSTEM_CONTRACTS_OFFSET + 0x0b)));

76: IBootloaderUtilities constant BOOTLOADER_UTILITIES = IBootloaderUtilities(address(SYSTEM_CONTRACTS_OFFSET + 0x0c)); 

79: address constant EVENT_WRITER_CONTRACT = address(SYSTEM_CONTRACTS_OFFSET + 0x0d); 

81: ICompressor constant COMPRESSOR_CONTRACT = ICompressor(address(SYSTEM_CONTRACTS_OFFSET + 0x0e)); 

83: IComplexUpgrader constant COMPLEX_UPGRADER_CONTRACT = IComplexUpgrader(address(SYSTEM_CONTRACTS_OFFSET + 0x0f)); 

85: IPubdataChunkPublisher constant PUBDATA_CHUNK_PUBLISHER = IPubdataChunkPublisher( 
86:     address(SYSTEM_CONTRACTS_OFFSET + 0x11)
87: );

94: uint256 constant MAX_MSG_VALUE = 2 ** 128 - 1; 

135: uint256 constant COMPRESSED_INITIAL_WRITE_SIZE = DERIVED_KEY_LENGTH + VALUE_LENGTH; 

137: uint256 constant COMPRESSED_REPEATED_WRITE_SIZE = ENUM_INDEX_LENGTH + VALUE_LENGTH; 
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L20), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L48-L57), [61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L61-L63), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L65-L66), [73](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L73-L74), [76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L76), [79](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L79), [81](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L81), [83](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L83), [85](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L85-L87), [94](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L94), [135](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L135), [137](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L137)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

28:     uint256 private constant DEPLOY_NONCE_MULTIPLIER = 2 ** 128; 

31:     uint256 private constant MAXIMAL_MIN_NONCE_INCREMENT = 2 ** 32; 
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L28), [31](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L31)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractsCaller.sol

12: address constant TO_L1_CALL_ADDRESS = address((1 << 16) - 1); 
13: address constant CODE_ADDRESS_CALL_ADDRESS = address((1 << 16) - 2);
14: address constant PRECOMPILE_CALL_ADDRESS = address((1 << 16) - 3);
15: address constant META_CALL_ADDRESS = address((1 << 16) - 4);
16: address constant MIMIC_CALL_CALL_ADDRESS = address((1 << 16) - 5);
17: address constant SYSTEM_MIMIC_CALL_CALL_ADDRESS = address((1 << 16) - 6);
18: address constant MIMIC_CALL_BY_REF_CALL_ADDRESS = address((1 << 16) - 7);
19: address constant SYSTEM_MIMIC_CALL_BY_REF_CALL_ADDRESS = address((1 << 16) - 8);
20: address constant RAW_FAR_CALL_CALL_ADDRESS = address((1 << 16) - 9);
21: address constant RAW_FAR_CALL_BY_REF_CALL_ADDRESS = address((1 << 16) - 10);
22: address constant SYSTEM_CALL_CALL_ADDRESS = address((1 << 16) - 11);
23: address constant SYSTEM_CALL_BY_REF_CALL_ADDRESS = address((1 << 16) - 12);
24: address constant SET_CONTEXT_VALUE_CALL_ADDRESS = address((1 << 16) - 13);
25: address constant SET_PUBDATA_PRICE_CALL_ADDRESS = address((1 << 16) - 14);
26: address constant INCREMENT_TX_COUNTER_CALL_ADDRESS = address((1 << 16) - 15);
27: address constant PTR_CALLDATA_CALL_ADDRESS = address((1 << 16) - 16);
28: address constant CALLFLAGS_CALL_ADDRESS = address((1 << 16) - 17);
29: address constant PTR_RETURNDATA_CALL_ADDRESS = address((1 << 16) - 18);
30: address constant EVENT_INITIALIZE_ADDRESS = address((1 << 16) - 19);
31: address constant EVENT_WRITE_ADDRESS = address((1 << 16) - 20);
32: address constant LOAD_CALLDATA_INTO_ACTIVE_PTR_CALL_ADDRESS = address((1 << 16) - 21);
33: address constant LOAD_LATEST_RETURNDATA_INTO_ACTIVE_PTR_CALL_ADDRESS = address((1 << 16) - 22);
34: address constant PTR_ADD_INTO_ACTIVE_CALL_ADDRESS = address((1 << 16) - 23);
35: address constant PTR_SHRINK_INTO_ACTIVE_CALL_ADDRESS = address((1 << 16) - 24);
36: address constant PTR_PACK_INTO_ACTIVE_CALL_ADDRESS = address((1 << 16) - 25);
37: address constant MULTIPLICATION_HIGH_ADDRESS = address((1 << 16) - 26);
38: address constant GET_EXTRA_ABI_DATA_ADDRESS = address((1 << 16) - 27);

41: uint256 constant META_GAS_PER_PUBDATA_BYTE_OFFSET = 0 * 8; 
42: uint256 constant META_HEAP_SIZE_OFFSET = 8 * 8;
43: uint256 constant META_AUX_HEAP_SIZE_OFFSET = 12 * 8;
44: uint256 constant META_SHARD_ID_OFFSET = 28 * 8;
45: uint256 constant META_CALLER_SHARD_ID_OFFSET = 29 * 8;
46: uint256 constant META_CODE_SHARD_ID_OFFSET = 30 * 8;
```
[12](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L12-L38), [41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L41-L46)

</details>


---
### [GAS&#x2011;31] `do`-`while` is cheaper than `for`-loops when the initial check can be skipped
Using `do-while` loops instead of `for` loops can be more gas-efficient.
Even if you add an `if` condition to account for the case where the loop doesn't execute at all, a `do-while` loop can still be cheaper in terms of gas.


Gas saved per Instance: ~255 *(Total: ~8,925)*
<details>
<summary><i>There are 35 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

225:         for (uint256 i = 0; i < _calls.length; ++i) { 
```
[225](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L225)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

116:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 

135:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 

185:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 

209:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 
```
[116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L116), [135](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L135), [185](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L185), [209](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L209)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

142:         for (uint256 i = 0; i < emittedL2Logs.length; i = i.uncheckedAdd(L2_TO_L1_LOG_SERIALIZE_SIZE)) { 

257:         for (uint256 i = 0; i < _newBatchesData.length; i = i.uncheckedInc()) { 

289:         for (uint256 i = 0; i < _newBatchesData.length; i = i.uncheckedInc()) { 

311:         for (uint256 i = 0; i < _nPriorityOps; i = i.uncheckedInc()) { 

351:         for (uint256 i = 0; i < nBatches; i = i.uncheckedInc()) { 

405:         for (uint256 i = 0; i < committedBatchesLength; i = i.uncheckedInc()) { 

580:         for (uint i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 

636:         for (uint256 i = 0; i < _pubdataCommitments.length; i += PUBDATA_COMMITMENT_SIZE) { 

667:         for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 
```
[142](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L142), [257](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L257), [289](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L289), [311](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L311), [351](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L351), [405](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L405), [580](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L580), [636](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L636), [667](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L667)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

208:         for (uint256 i = 0; i < facetsLen; i = i.uncheckedInc()) { 
```
[208](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L208)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

356:         for (uint256 i = 0; i < factoryDepsLen; i = i.uncheckedInc()) { 
```
[356](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L356)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

101:         for (uint256 i = 0; i < facetCutsLength; i = i.uncheckedInc()) { 

138:         for (uint256 i = 0; i < selectorsLength; i = i.uncheckedInc()) { 

158:         for (uint256 i = 0; i < selectorsLength; i = i.uncheckedInc()) { 

178:         for (uint256 i = 0; i < selectorsLength; i = i.uncheckedInc()) { 
```
[101](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L101), [138](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L138), [158](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L158), [178](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L178)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol

29:         for (uint256 i; i < pathLength; i = i.uncheckedInc()) { 
```
[29](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L29)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

226:         for (uint256 i = 0; i < _factoryDeps.length; ++i) { 
```
[226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L226)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

61:             for (uint256 encodedDataPointer = 0; encodedDataPointer < encodedData.length; encodedDataPointer += 2) { 

127:         for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) { 

159:         for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) { 
```
[61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L61), [127](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L127), [159](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L159)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

248:         for (uint256 i = 0; i < deploymentsLength; ++i) { 

253:         for (uint256 i = 0; i < deploymentsLength; ++i) { 
```
[248](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L248), [253](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L253)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

38:             for (uint256 i = 0; i < immutablesLength; ++i) { 
```
[38](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L38)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

30:             for (uint256 i = 0; i < hashesLen; ++i) { 
```
[30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L30)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

206:         for (uint256 i = 0; i < numberOfL2ToL1Logs; ++i) { 

218:         for (uint256 i = numberOfL2ToL1Logs; i < L2_TO_L1_LOGS_MERKLE_TREE_LEAVES; ++i) { 

224:             for (uint256 i = 0; i < nodesOnCurrentLevel; ++i) { 

236:         for (uint256 i = 0; i < numberOfMessages; ++i) { 

254:         for (uint256 i = 0; i < numberOfBytecodes; ++i) { 
```
[206](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L206), [218](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L218), [224](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L224), [236](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L236), [254](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L254)

```solidity
üìÅ File: system-contracts/contracts/PubdataChunkPublisher.sol

36:         for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 
```
[36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L36)

</details>


---
### [GAS&#x2011;32] Don't compare boolean expressions to boolean literals
For cases of: `if (<x> == true)`, use `if (<x>)` instead For cases of: `if (<x> == false)`, use `if (!<x>)` instead


Gas saved per Instance: ~20 

<i>There is one instance of this issue:</i>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

/// @audit Use if (validators[_chainId][msg.sender])
68:         require(validators[_chainId][msg.sender] == true, "ValidatorTimelock: only validator"); 
```
[68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L68)


---
### [GAS&#x2011;33] Don't transfer with zero amount to save gas
In Solidity, unnecessary operations can waste gas. For example, a transfer function without a zero amount check uses gas even if called with a zero amount, since the contract state remains unchanged. Implementing a zero amount check avoids these unnecessary function calls, saving gas and improving efficiency.


Gas saved per Instance: ~20 *(Total: ~40)*
<details>
<summary><i>There are 2 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

/// @audit check for zero amount on the '_amount' variable
162:         _token.safeTransferFrom(_from, address(sharedBridge), _amount); 
```
[162](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L162)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

/// @audit check for zero amount on the '_amount' variable
175:         _token.safeTransferFrom(_from, address(this), _amount); 
```
[175](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L175)

</details>


---
### [GAS&#x2011;34] Duplicated `require()/revert()` checks should be refactored to a modifier or function
Saves deployment costs

<details>
<summary><i>There are 4782 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

143:         require(amount == _amount, "3T"); // The token has non-standard transfer logic 
```
[143](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L143)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

75:         require( 

161:             require(amount == _amount, "3T"); // The token has non-standard transfer logic 
```
[75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L75), [161](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L161)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

46:         require(msg.sender == admin || msg.sender == owner(), "Bridgehub: not owner or admin"); 

62:         require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights 

83:         require( 

93:         require( 

125:         require( 

269:                 require( 

300:         require( 
```
[46](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L46), [62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L62), [83](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L83), [93](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L93), [125](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L125), [269](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L269), [300](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L300)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

71:         require( 
```
[71](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L71)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

70:         require(msg.sender == admin || msg.sender == owner(), "Bridgehub: not owner or admin"); 

121:         require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights 
```
[70](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L70), [121](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L121)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

195:                 require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed 

217:                 require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed 
```
[195](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L195), [217](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L217)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

105:         require( 

110:         require( 

116:         require( 
```
[105](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L105), [110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L110), [116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L116)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

61:             require( 

226:         require( 

324:         require( 

407:             require( 

668:             require( 
```
[61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L61), [226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L226), [324](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L324), [407](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L407), [668](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L668)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol

37:         require( 

45:         require( 
```
[37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L37), [45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L45)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol

34:         require( 
```
[34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L34)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

72:         require(block.timestamp >= _proposedUpgrade.upgradeTimestamp, "Upgrade is not ready yet"); 

205:         require( 

227:             require( 

238:         require( 

242:         require( 

249:         require(s.l2SystemContractsUpgradeTxHash == bytes32(0), "Previous upgrade has not been finalized"); 
250:         require(
```
[72](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L72), [205](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L205), [227](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L227), [238](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L238), [242](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L242), [249](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L249-L250)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol

22:         require( 

27:         require( 

33:         require(s.l2SystemContractsUpgradeTxHash == bytes32(0), "Previous upgrade has not been finalized"); 
34:         require(

52:         require(block.timestamp >= _proposedUpgrade.upgradeTimestamp, "Upgrade is not ready yet"); 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L22), [27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L27), [33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L33-L34), [52](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L52)

```solidity
üìÅ File: contracts/zksync/contracts/SystemContractsCaller.sol

28:         require(_x <= type(uint32).max, "Overflow"); 
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L28)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

56:         require(_l2TokenProxyBytecodeHash != bytes32(0), "df"); 

58:         require(_l2TokenProxyBytecodeHash != bytes32(0), "df"); 

87:         require( 
```
[56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L56), [58](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L58), [87](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L87)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

26:         require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract"); 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L26)

```solidity
üìÅ File: system-contracts/contracts/BootloaderUtilities.sol

92:             require(vInt == 27 || vInt == 28, "Invalid v value"); 

191:             require(vInt == 27 || vInt == 28, "Invalid v value"); 

286:             require(vInt == 27 || vInt == 28, "Invalid v value"); 
```
[92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L92), [191](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L191), [286](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L286)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

51:             require( 

56:             require( 

232:                 require( 

237:                 require( 
```
[51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L51), [56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L56), [232](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L232), [237](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L237)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

77:         require( 

239:         require( 

268:         require( 
```
[77](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L77), [239](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L239), [268](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L268)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

35:         require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract"); 
```
[35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L35)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

214:         require( 

245:         require( 

269:         require( 

279:         require( 
```
[214](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L214), [245](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L245), [269](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L269), [279](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L279)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

33:         require( 
```
[33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L33)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

136:         require( 
```
[136](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L136)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

351:             require( 

369:             require( 

386:             require( 

429:         require( 
```
[351](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L351), [369](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L369), [386](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L386), [429](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L429)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContract.sol

21:         require( 

31:         require( 
```
[21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L21), [31](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L31)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

367:             require( 
```
[367](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L367)

```solidity
üìÅ File: system-contracts/contracts/libraries/Utils.sol

27:         require(_x <= type(uint32).max, "Overflow"); 
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L27)

</details>


---
### [GAS&#x2011;35] Emitting constants wastes gas
Every event parameter costs `Glogdata` (**8 gas**) per byte. You can avoid this extra cost, in cases where you're emitting a constant, by creating a second version of the event, which doesn't have the parameter (and have users look to the contract's variables for its value instead), and using the new event in the cases shown below.


Gas saved per Instance: ~8 

<i>There is one instance of this issue:</i>

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

/// @audit 0
50:         emit ChangeMinDelay(0, _minDelay); 
```
[50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L50)


---
### [GAS&#x2011;36] Empty blocks should be removed or emit something
Some functions don't have a body: consider commenting why, or add some logic. Otherwise, refactor the code and remove these functions.

<details>
<summary><i>There are 8 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

60:     function initialize() external reentrancyGuardInitializer {} 
```
[60](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L60)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

262:     receive() external payable {} 
```
[262](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L262)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

263:     function _upgradeL1Contract(bytes calldata _customCallDataForUpgrade) internal virtual {} 

269:     function _postUpgrade(bytes calldata _customCallDataForUpgrade) internal virtual {} 
```
[263](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L263), [269](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L269)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

125:     function executeTransactionFromOutside(Transaction calldata _transaction) external payable override { 
126:         // Behave the same as for fallback/receive, just execute nothing, returns nothing
127:     }

227:     receive() external payable { 
228:         // If the contract is called directly, behave like an EOA
229:     }
```
[125](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L125-L127), [227](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L227-L229)

```solidity
üìÅ File: system-contracts/contracts/EmptyContract.sol

11:     fallback() external payable {} 

13:     receive() external payable {} 
```
[11](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L11), [13](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L13)

</details>


---
### [GAS&#x2011;37] Function names can be optimized
Function that are `public`/`external` and `public` state variable names can be optimized to save gas.

Method IDs that have two leading zero bytes can save **128 gas** each during deployment, and renaming functions to have lower method IDs will save **22 gas** per call, per sorted position shifted. [Reference](https://blog.emn178.cc/en/post/solidity-gas-optimization-function-name/)


Gas saved per Instance: ~128 *(Total: ~6,016)*
<details>
<summary><i>There are 47 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

/// @audit optimized order: l2TokenAddress(), deposit(), tranferTokenToSharedBridge(), deposit(), initialize(), _depositFundsToSharedBridge(), claimFailedDeposit(), finalizeWithdrawal()
19: contract L1ERC20Bridge is IL1ERC20Bridge, ReentrancyGuard { 
```
[19](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L19)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

/// @audit optimized order: initializeChainGovernance(), initialize(), bridgehubDeposit(), finalizeWithdrawal(), transferFundsFromLegacy(), receiveEth(), claimFailedDeposit(), depositLegacyErc20Bridge(), claimFailedDepositLegacyErc20Bridge(), bridgehubConfirmL2Transaction(), finalizeWithdrawalLegacyErc20Bridge(), bridgehubDepositBaseToken(), _depositFunds(), _getDepositL2Calldata(), _getERC20Getters(), _claimFailedDeposit(), _isEraLegacyWithdrawal(), _finalizeWithdrawal(), _checkWithdrawal(), _parseL2WithdrawalMessage()
30: contract L1SharedBridge is IL1SharedBridge, ReentrancyGuard, Initializable, Ownable2Step { 
```
[30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L30)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol

/// @audit optimized order: l2TokenAddress(), deposit(), tranferTokenToSharedBridge(), l2Bridge(), deposit(), l2TokenBeacon(), isWithdrawalFinalized(), sharedBridge(), claimFailedDeposit(), finalizeWithdrawal(), depositAmount()
11: interface IL1ERC20Bridge { 
```
[11](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L11)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol

/// @audit optimized order: bridgehubDeposit(), finalizeWithdrawal(), receiveEth(), claimFailedDeposit(), depositHappened(), depositLegacyErc20Bridge(), claimFailedDepositLegacyErc20Bridge(), isWithdrawalFinalized(), bridgehubConfirmL2Transaction(), finalizeWithdrawalLegacyErc20Bridge(), legacyBridge(), l1WethAddress(), bridgehub(), bridgehubDepositBaseToken(), l2BridgeAddress()
12: interface IL1SharedBridge { 
```
[12](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L12)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol

/// @audit optimized order: l2TokenAddress(), l1TokenAddress(), withdraw(), finalizeDeposit(), l1Bridge()
6: interface IL2Bridge { 
```
[6](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L6)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

/// @audit optimized order: removeStateTransitionManager(), proveL2LogInclusion(), requestL2TransactionDirect(), addToken(), setSharedBridge(), initialize(), getStateTransition(), proveL1ToL2TransactionStatus(), proveL2MessageInclusion(), addStateTransitionManager(), l2TransactionBaseCost(), setPendingAdmin(), createNewChain(), requestL2TransactionTwoBridges(), acceptAdmin(), _actualRefundRecipient()
16: contract Bridgehub is IBridgehub, ReentrancyGuard, Ownable2Step { 
```
[16](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L16)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol

/// @audit optimized order: removeStateTransitionManager(), proveL2LogInclusion(), requestL2TransactionDirect(), addToken(), setSharedBridge(), getStateTransition(), stateTransitionManagerIsRegistered(), proveL1ToL2TransactionStatus(), proveL2MessageInclusion(), tokenIsRegistered(), addStateTransitionManager(), l2TransactionBaseCost(), baseToken(), setPendingAdmin(), stateTransitionManager(), createNewChain(), sharedBridge(), requestL2TransactionTwoBridges(), acceptAdmin()
42: interface IBridgehub { 
```
[42](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L42)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

/// @audit optimized order: updateSecurityCouncil(), cancel(), hashOperation(), executeInstant(), getOperationState(), execute(), scheduleShadow(), updateDelay(), isOperationPending(), isOperation(), scheduleTransparent(), isOperationDone(), isOperationReady(), _schedule(), _execute(), _checkPredecessorDone()
20: contract Governance is IGovernance, Ownable2Step { 
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L20)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/IGovernance.sol

/// @audit optimized order: updateSecurityCouncil(), cancel(), hashOperation(), executeInstant(), getOperationState(), execute(), scheduleShadow(), updateDelay(), isOperationPending(), isOperation(), scheduleTransparent(), isOperationDone(), isOperationReady()
8: interface IGovernance { 
```
[8](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L8)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol

/// @audit optimized order: initialize(), storedBatchZero(), genesisUpgrade(), freezeChain(), stateTransition(), setUpgradeDiamondCut(), createNewChain(), setValidatorTimelock(), setNewVersionUpgrade(), bridgehub(), initialCutHash(), upgradeCutHash(), unfreezeChain(), setPendingAdmin(), getChainAdmin(), setInitialCutHash(), protocolVersion(), acceptAdmin(), registerAlreadyDeployedStateTransition()
26: interface IStateTransitionManager { 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L26)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

/// @audit optimized order: initialize(), freezeChain(), setUpgradeDiamondCut(), createNewChain(), setValidatorTimelock(), setNewVersionUpgrade(), revertBatches(), unfreezeChain(), setPendingAdmin(), getChainAdmin(), setInitialCutHash(), acceptAdmin(), _setChainIdUpgrade(), registerAlreadyDeployedStateTransition()
25: contract StateTransitionManager is IStateTransitionManager, ReentrancyGuard, Ownable2Step { 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L25)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

/// @audit optimized order: setExecutionDelay(), executeBatches(), proveBatchesSharedBridge(), getCommittedBatchTimestamp(), revertBatches(), proveBatches(), commitBatches(), executeBatchesSharedBridge(), commitBatchesSharedBridge(), removeValidator(), addValidator(), revertBatchesSharedBridge(), setStateTransitionManager(), _propagateToZkSyncStateTransition()
22: contract ValidatorTimelock is IExecutor, Ownable2Step { 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L22)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

/// @audit optimized order: upgradeChainFromVersion(), setPriorityTxMaxGasLimit(), executeUpgrade(), setValidiumMode(), changeFeeParams(), setPendingAdmin(), setValidator(), freezeDiamond(), setTokenMultiplier(), setPorterAvailability(), unfreezeDiamond(), acceptAdmin()
18: contract AdminFacet is ZkSyncStateTransitionBase, IAdmin { 
```
[18](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L18)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

/// @audit optimized order: _commitOneBatch(), _verifyBatchTimestamp(), _processL2Logs(), commitBatches(), commitBatchesSharedBridge(), _commitBatches(), _commitBatchesWithoutSystemContractsUpgrade(), _commitBatchesWithSystemContractsUpgrade(), _collectOperationsFromPriorityQueue(), _executeOneBatch(), executeBatches(), proveBatchesSharedBridge(), revertBatches(), executeBatchesSharedBridge(), _executeBatches(), proveBatches(), _proveBatches(), _verifyProof(), _getBatchProofPublicInput(), revertBatchesSharedBridge(), _revertBatches(), _createBatchCommitment(), _batchPassThroughData(), _batchMetaParameters(), _batchAuxiliaryOutput(), _encodeBlobAuxilaryOutput(), _hashStoredBatchInfo(), _checkBit(), _setBit(), _pointEvaluationPrecompile(), _verifyBlobInformation(), _getBlobVersionedHash()
22: contract ExecutorFacet is ZkSyncStateTransitionBase, IExecutor { 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L22)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

/// @audit optimized order: getTotalBlocksCommitted(), getL2DefaultAccountBytecodeHash(), isValidator(), getTotalBatchesVerified(), baseTokenGasPriceMultiplierNominator(), isFunctionFreezable(), getL2SystemContractsUpgradeBatchNumber(), getTotalBatchesCommitted(), getL2BootloaderBytecodeHash(), getPendingAdmin(), facetAddress(), isFacetFreezable(), isEthWithdrawalFinalized(), getTotalBatchesExecuted(), storedBatchHash(), getTotalBlocksVerified(), facetFunctionSelectors(), getTotalPriorityTxs(), getL2SystemContractsUpgradeBlockNumber(), l2LogsRootHash(), getBaseToken(), getL2SystemContractsUpgradeTxHash(), facets(), getFirstUnprocessedPriorityTx(), storedBlockHash(), getAdmin(), getPriorityQueueSize(), priorityQueueFrontOperation(), getStateTransitionManager(), facetAddresses(), getVerifier(), getTotalBlocksExecuted(), getBridgehub(), getProtocolVersion(), isDiamondStorageFrozen(), baseTokenGasPriceMultiplierDenominator(), getVerifierParams(), getPriorityTxMaxGasLimit(), getBaseTokenBridge(), getPubdataPricingMode()
20: contract GettersFacet is ZkSyncStateTransitionBase, IGetters, ILegacyGetters { 
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L20)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

/// @audit optimized order: requestL2Transaction(), proveL2MessageInclusion(), transferEthToSharedBridge(), l2TransactionBaseCost(), finalizeEthWithdrawal(), proveL2LogInclusion(), bridgehubRequestL2Transaction(), proveL1ToL2TransactionStatus(), _proveL2LogInclusion(), _L2MessageToLog(), _deriveL2GasPrice(), _requestL2TransactionSender(), _requestL2Transaction(), _serializeL2Transaction(), _writePriorityOp(), _hashFactoryDeps()
30: contract MailboxFacet is ZkSyncStateTransitionBase, IMailbox { 
```
[30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L30)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol

/// @audit optimized order: upgradeChainFromVersion(), setPriorityTxMaxGasLimit(), executeUpgrade(), setValidiumMode(), changeFeeParams(), setPendingAdmin(), setValidator(), freezeDiamond(), setTokenMultiplier(), setPorterAvailability(), unfreezeDiamond(), acceptAdmin()
13: interface IAdmin is IZkSyncStateTransitionBase { 
```
[13](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L13)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol

/// @audit optimized order: executeBatches(), proveBatchesSharedBridge(), revertBatches(), proveBatches(), commitBatches(), executeBatchesSharedBridge(), commitBatchesSharedBridge(), revertBatchesSharedBridge()
73: interface IExecutor is IZkSyncStateTransitionBase { 
```
[73](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L73)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol

/// @audit optimized order: getL2DefaultAccountBytecodeHash(), isValidator(), getTotalBatchesVerified(), baseTokenGasPriceMultiplierNominator(), isFunctionFreezable(), getL2SystemContractsUpgradeBatchNumber(), getTotalBatchesCommitted(), getL2BootloaderBytecodeHash(), getPendingAdmin(), facetAddress(), isFacetFreezable(), isEthWithdrawalFinalized(), getTotalBatchesExecuted(), storedBatchHash(), facetFunctionSelectors(), getTotalPriorityTxs(), l2LogsRootHash(), getBaseToken(), getL2SystemContractsUpgradeTxHash(), facets(), getFirstUnprocessedPriorityTx(), getAdmin(), getPriorityQueueSize(), priorityQueueFrontOperation(), getStateTransitionManager(), facetAddresses(), getVerifier(), getBridgehub(), getProtocolVersion(), isDiamondStorageFrozen(), baseTokenGasPriceMultiplierDenominator(), getVerifierParams(), getPriorityTxMaxGasLimit(), getBaseTokenBridge(), getPubdataPricingMode()
13: interface IGetters is IZkSyncStateTransitionBase { 
```
[13](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L13)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol

/// @audit optimized order: getTotalBlocksCommitted(), getTotalBlocksVerified(), getL2SystemContractsUpgradeBlockNumber(), storedBlockHash(), getTotalBlocksExecuted()
11: interface ILegacyGetters is IZkSyncStateTransitionBase { 
```
[11](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol#L11)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol

/// @audit optimized order: requestL2Transaction(), proveL2MessageInclusion(), transferEthToSharedBridge(), l2TransactionBaseCost(), finalizeEthWithdrawal(), proveL2LogInclusion(), bridgehubRequestL2Transaction(), proveL1ToL2TransactionStatus()
11: interface IMailbox is IZkSyncStateTransitionBase { 
```
[11](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L11)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol

/// @audit optimized order: verificationKeyHash(), verify()
15: interface IVerifier { 
```
[15](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol#L15)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

/// @audit optimized order: l2TokenAddress(), withdraw(), finalizeDeposit(), initialize(), _deployL2Token(), _getL1WithdrawMessage(), _getCreate2Salt(), _deployBeaconProxy()
23: contract L2SharedBridge is IL2SharedBridge, Initializable { 
```
[23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L23)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

/// @audit optimized order: reinitializeToken(), bridgeInitialize(), symbol(), decodeString(), bridgeMint(), decodeUint8(), bridgeBurn(), decimals(), name()
15: contract L2StandardERC20 is ERC20PermitUpgradeable, IL2StandardToken, ERC1967Upgrade { 
```
[15](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L15)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol

/// @audit optimized order: l2TokenAddress(), l1TokenAddress(), withdraw(), finalizeDeposit(), l1Bridge()
6: interface IL2SharedBridge { 
```
[6](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L6)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol

/// @audit optimized order: l1Address(), l2Bridge(), bridgeMint(), bridgeBurn()
5: interface IL2StandardToken { 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L5)

```solidity
üìÅ File: contracts/zksync/contracts/interfaces/IPaymaster.sol

/// @audit optimized order: postTransaction(), validateAndPayForPaymasterTransaction()
14: interface IPaymaster { 
```
[14](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymaster.sol#L14)

```solidity
üìÅ File: contracts/zksync/contracts/interfaces/IPaymasterFlow.sol

/// @audit optimized order: approvalBased(), general()
13: interface IPaymasterFlow { 
```
[13](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymasterFlow.sol#L13)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

/// @audit optimized order: getCodeHash(), markAccountCodeHashAsConstructed(), storeAccountConstructingCodeHash(), getRawCodeHash(), storeAccountConstructedCodeHash(), _storeCodeHash(), getCodeSize()
22: contract AccountCodeStorage is IAccountCodeStorage { 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L22)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

/// @audit optimized order: extendedAccountVersion(), getAccountInfo(), _storeAccountInfo(), forceDeployOnAddress(), createAccount(), updateNonceOrdering(), forceDeployOnAddresses(), create(), getNewAddressCreate2(), create2Account(), updateAccountVersion(), create2(), getNewAddressCreate(), _nonSystemDeployOnAddress(), _performDeployOnAddress(), _ensureBytecodeIsKnown(), _storeConstructingByteCodeHashOnAddress(), _constructContract()
23: contract ContractDeployer is IContractDeployer, ISystemContract { 
```
[23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L23)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

/// @audit optimized order: validateTransaction(), _validateTransaction(), executeTransactionFromOutside(), payForTransaction(), executeTransaction(), _execute(), _isValidSignature(), prepareForPaymaster()
19: contract DefaultAccount is IAccount { 
```
[19](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L19)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

/// @audit optimized order: setImmutables(), getImmutable()
18: contract ImmutableSimulator is IImmutableSimulator { 
```
[18](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L18)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

/// @audit optimized order: keccakGasCost(), sha256GasCost(), sendL2ToL1Log(), _processL2ToL1Log(), sendToL1(), publishPubdataAndClearState(), requestBytecodeL1Publication()
25: contract L1Messenger is IL1Messenger, ISystemContract { 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L25)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

/// @audit optimized order: balanceOf(), symbol(), withdrawWithMessage(), transferFromTo(), withdraw(), mint(), _burnMsgValue(), _getL1WithdrawMessage(), _getExtendedWithdrawMessage(), decimals(), name()
18: contract L2BaseToken is IBaseToken, ISystemContract { 
```
[18](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L18)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

/// @audit optimized order: getDeploymentNonce(), incrementMinNonceIfEquals(), isNonceUsed(), getMinNonce(), validateNonceUsage(), getRawNonce(), getValueUnderNonce(), increaseMinNonce(), incrementDeploymentNonce(), setValueUnderNonce(), _splitRawNonce()
27: contract NonceHolder is INonceHolder, ISystemContract { 
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L27)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

/// @audit optimized order: setChainId(), getBatchHash(), getBatchNumberAndTimestamp(), getCurrentPubdataSpent(), setGasPrice(), setTxOrigin(), setPubdataInfo(), getL2BlockNumberAndTimestamp(), getBlockHashEVM(), publishTimestampDataToL1(), getBlockTimestamp(), getCurrentPubdataCost(), getBlockNumber(), _getLatest257L2blockHash(), _setL2BlockHash(), _calculateL2BlockHash(), _calculateLegacyL2BlockHash(), _upgradeL2Blocks(), _setVirtualBlock(), _setNewL2BlockData(), getBlockNumberAndTimestamp(), currentBlockInfo(), blockHash(), resetTxNumberInBatch(), incrementTxNumberInBatch(), unsafeOverrideBatch(), appendTransactionToCurrentL2Block(), setL2Block(), _ensureBatchConsistentWithL2Block(), setNewBatch()
17: contract SystemContext is ISystemContext, ISystemContextDeprecated, ISystemContract { 
```
[17](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L17)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IAccount.sol

/// @audit optimized order: executeTransactionFromOutside(), payForTransaction(), executeTransaction(), prepareForPaymaster(), validateTransaction()
9: interface IAccount { 
```
[9](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccount.sol#L9)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IAccountCodeStorage.sol

/// @audit optimized order: getCodeHash(), markAccountCodeHashAsConstructed(), storeAccountConstructingCodeHash(), getRawCodeHash(), getCodeSize(), storeAccountConstructedCodeHash()
5: interface IAccountCodeStorage { 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L5)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IBaseToken.sol

/// @audit optimized order: balanceOf(), symbol(), withdrawWithMessage(), transferFromTo(), withdraw(), mint(), decimals(), totalSupply(), name()
5: interface IBaseToken { 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L5)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IContractDeployer.sol

/// @audit optimized order: createAccount(), updateNonceOrdering(), create(), getNewAddressCreate2(), getAccountInfo(), create2Account(), updateAccountVersion(), create2(), getNewAddressCreate()
5: interface IContractDeployer { 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L5)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IImmutableSimulator.sol

/// @audit optimized order: setImmutables(), getImmutable()
10: interface IImmutableSimulator { 
```
[10](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L10)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IL2StandardToken.sol

/// @audit optimized order: l1Address(), l2Bridge(), bridgeMint(), bridgeBurn()
5: interface IL2StandardToken { 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L5)

```solidity
üìÅ File: system-contracts/contracts/interfaces/INonceHolder.sol

/// @audit optimized order: getDeploymentNonce(), incrementMinNonceIfEquals(), isNonceUsed(), getMinNonce(), validateNonceUsage(), getRawNonce(), getValueUnderNonce(), increaseMinNonce(), incrementDeploymentNonce(), setValueUnderNonce()
13: interface INonceHolder { 
```
[13](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L13)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IPaymaster.sol

/// @audit optimized order: postTransaction(), validateAndPayForPaymasterTransaction()
14: interface IPaymaster { 
```
[14](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L14)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IPaymasterFlow.sol

/// @audit optimized order: approvalBased(), general()
12: interface IPaymasterFlow { 
```
[12](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymasterFlow.sol#L12)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContext.sol

/// @audit optimized order: gasPrice(), getBatchHash(), getBatchNumberAndTimestamp(), getCurrentPubdataSpent(), coinbase(), chainId(), origin(), getL2BlockNumberAndTimestamp(), txNumberInBlock(), getBlockHashEVM(), gasPerPubdataByte(), getBlockTimestamp(), blockGasLimit(), baseFee(), getBlockNumber(), difficulty()
11: interface ISystemContext { 
```
[11](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L11)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContextDeprecated.sol

/// @audit optimized order: getBlockNumberAndTimestamp(), currentBlockInfo(), blockHash()
10: interface ISystemContextDeprecated { 
```
[10](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContextDeprecated.sol#L10)

</details>


---
### [GAS&#x2011;38] Functions guaranteed to revert when called by normal users can be marked `payable`
If a function modifier such as `onlyOwner` is used, the function will revert if a normal user tries to pay the function. Marking the function as `payable` will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided.


Gas saved per Instance: ~21 *(Total: ~1,848)*
<details>
<summary><i>There are 88 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

116:     function transferFundsFromLegacy(address _token, address _target, uint256 _targetChainId) external onlyOwner { 

142:     function initializeChainGovernance(uint256 _chainId, address _l2BridgeAddress) external onlyOwner { 

232:     function bridgehubConfirmL2Transaction( 
233:         uint256 _chainId,
234:         bytes32 _txDataHash,
235:         bytes32 _txHash
236:     ) external override onlyBridgehub {

615:     function finalizeWithdrawalLegacyErc20Bridge( 
616:         uint256 _l2BatchNumber,
617:         uint256 _l2MessageIndex,
618:         uint16 _l2TxNumberInBatch,
619:         bytes calldata _message,
620:         bytes32[] calldata _merkleProof
621:     ) external override onlyLegacyBridge returns (address l1Receiver, address l1Token, uint256 amount) {

644:     function claimFailedDepositLegacyErc20Bridge( 
645:         address _depositSender,
646:         address _l1Token,
647:         uint256 _amount,
648:         bytes32 _l2TxHash,
649:         uint256 _l2BatchNumber,
650:         uint256 _l2MessageIndex,
651:         uint16 _l2TxNumberInBatch,
652:         bytes32[] calldata _merkleProof
653:     ) external override onlyLegacyBridge {
```
[116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L116), [142](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L142), [232](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L232-L236), [615](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L615-L621), [644](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L644-L653)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

51:     function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin { 

82:     function addStateTransitionManager(address _stateTransitionManager) external onlyOwner { 

92:     function removeStateTransitionManager(address _stateTransitionManager) external onlyOwner { 

101:     function addToken(address _token) external onlyOwner { 

108:     function setSharedBridge(address _sharedBridge) external onlyOwner { 

114:     function createNewChain( 
115:         uint256 _chainId,
116:         address _stateTransitionManager,
117:         address _baseToken,
118:         uint256, //_salt
119:         address _admin,
120:         bytes calldata _initData
121:     ) external onlyOwnerOrAdmin nonReentrant returns (uint256 chainId) {
```
[51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L51), [82](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L82), [92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L92), [101](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L101), [108](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L108), [114](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L114-L121)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

129:     function scheduleTransparent(Operation calldata _operation, uint256 _delay) external onlyOwner { 

142:     function scheduleShadow(bytes32 _id, uint256 _delay) external onlyOwner { 

154:     function cancel(bytes32 _id) external onlyOwner { 

249:     function updateDelay(uint256 _newDelay) external onlySelf { 

256:     function updateSecurityCouncil(address _newSecurityCouncil) external onlySelf { 
```
[129](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L129), [142](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L142), [154](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L154), [249](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L249), [256](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L256)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

110:     function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin { 

132:     function setValidatorTimelock(address _validatorTimelock) external onlyOwnerOrAdmin { 

137:     function setInitialCutHash(Diamond.DiamondCutData calldata _diamondCut) external onlyOwner { 

142:     function setNewVersionUpgrade( 
143:         Diamond.DiamondCutData calldata _cutData,
144:         uint256 _oldProtocolVersion,
145:         uint256 _newProtocolVersion
146:     ) external onlyOwner {

152:     function setUpgradeDiamondCut( 
153:         Diamond.DiamondCutData calldata _cutData,
154:         uint256 _oldProtocolVersion
155:     ) external onlyOwner {

160:     function freezeChain(uint256 _chainId) external onlyOwner { 

165:     function unfreezeChain(uint256 _chainId) external onlyOwner { 

170:     function revertBatches(uint256 _chainId, uint256 _newLastBatch) external onlyOwnerOrAdmin { 

230:     function registerAlreadyDeployedStateTransition( 
231:         uint256 _chainId,
232:         address _stateTransitionContract
233:     ) external onlyOwner {

239:     function createNewChain( 
240:         uint256 _chainId,
241:         address _baseToken,
242:         address _sharedBridge,
243:         address _admin,
244:         bytes calldata _diamondCut
245:     ) external onlyBridgehub {
```
[110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L110), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L132), [137](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L137), [142](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L142-L146), [152](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L152-L155), [160](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L160), [165](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L165), [170](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L170), [230](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L230-L233), [239](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L239-L245)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

73:     function setStateTransitionManager(IStateTransitionManager _stateTransitionManager) external onlyOwner { 

78:     function addValidator(uint256 _chainId, address _newValidator) external onlyChainAdmin(_chainId) { 

87:     function removeValidator(uint256 _chainId, address _validator) external onlyChainAdmin(_chainId) { 

96:     function setExecutionDelay(uint32 _executionDelay) external onlyOwner { 

108:     function commitBatches( 
109:         StoredBatchInfo calldata,
110:         CommitBatchInfo[] calldata _newBatchesData
111:     ) external onlyValidator(ERA_CHAIN_ID) {

126:     function commitBatchesSharedBridge( 
127:         uint256 _chainId,
128:         StoredBatchInfo calldata,
129:         CommitBatchInfo[] calldata _newBatchesData
130:     ) external onlyValidator(_chainId) {

146:     function revertBatches(uint256) external onlyValidator(ERA_CHAIN_ID) { 

153:     function revertBatchesSharedBridge(uint256 _chainId, uint256) external onlyValidator(_chainId) { 

160:     function proveBatches( 
161:         StoredBatchInfo calldata,
162:         StoredBatchInfo[] calldata,
163:         ProofInput calldata
164:     ) external onlyValidator(ERA_CHAIN_ID) {

171:     function proveBatchesSharedBridge( 
172:         uint256 _chainId,
173:         StoredBatchInfo calldata,
174:         StoredBatchInfo[] calldata,
175:         ProofInput calldata
176:     ) external onlyValidator(_chainId) {

182:     function executeBatches(StoredBatchInfo[] calldata _newBatchesData) external onlyValidator(ERA_CHAIN_ID) { 

203:     function executeBatchesSharedBridge( 
204:         uint256 _chainId,
205:         StoredBatchInfo[] calldata _newBatchesData
206:     ) external onlyValidator(_chainId) {
```
[73](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L73), [78](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L78), [87](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L87), [96](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L96), [108](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L108-L111), [126](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L126-L130), [146](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L146), [153](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L153), [160](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L160-L164), [171](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L171-L176), [182](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L182), [203](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L203-L206)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

23:     function setPendingAdmin(address _newPendingAdmin) external onlyAdmin { 

45:     function setValidator(address _validator, bool _active) external onlyStateTransitionManager { 

51:     function setPorterAvailability(bool _zkPorterIsAvailable) external onlyStateTransitionManager { 

58:     function setPriorityTxMaxGasLimit(uint256 _newPriorityTxMaxGasLimit) external onlyStateTransitionManager { 

67:     function changeFeeParams(FeeParams calldata _newFeeParams) external onlyAdminOrStateTransitionManager { 

79:     function setTokenMultiplier(uint128 _nominator, uint128 _denominator) external onlyAdminOrStateTransitionManager { 

89:     function setValidiumMode(PubdataPricingMode _validiumMode) external onlyAdmin { 

100:     function upgradeChainFromVersion( 
101:         uint256 _oldProtocolVersion,
102:         Diamond.DiamondCutData calldata _diamondCut
103:     ) external onlyAdminOrStateTransitionManager {

123:     function executeUpgrade(Diamond.DiamondCutData calldata _diamondCut) external onlyStateTransitionManager { 

133:     function freezeDiamond() external onlyAdminOrStateTransitionManager { 

143:     function unfreezeDiamond() external onlyAdminOrStateTransitionManager { 
```
[23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L23), [45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L45), [51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L51), [58](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L58), [67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L67), [79](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L79), [89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L89), [100](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L100-L103), [123](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L123), [133](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L133), [143](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L143)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

199:     function commitBatches( 
200:         StoredBatchInfo memory _lastCommittedBatchData,
201:         CommitBatchInfo[] calldata _newBatchesData
202:     ) external nonReentrant onlyValidator {

207:     function commitBatchesSharedBridge( 
208:         uint256, // _chainId
209:         StoredBatchInfo memory _lastCommittedBatchData,
210:         CommitBatchInfo[] calldata _newBatchesData
211:     ) external nonReentrant onlyValidator {

337:     function executeBatchesSharedBridge( 
338:         uint256,
339:         StoredBatchInfo[] calldata _batchesData
340:     ) external nonReentrant onlyValidator {

345:     function executeBatches(StoredBatchInfo[] calldata _batchesData) external nonReentrant onlyValidator { 

368:     function proveBatches( 
369:         StoredBatchInfo calldata _prevBatch,
370:         StoredBatchInfo[] calldata _committedBatches,
371:         ProofInput calldata _proof
372:     ) external nonReentrant onlyValidator {

377:     function proveBatchesSharedBridge( 
378:         uint256, // _chainId
379:         StoredBatchInfo calldata _prevBatch,
380:         StoredBatchInfo[] calldata _committedBatches,
381:         ProofInput calldata _proof
382:     ) external nonReentrant onlyValidator {

472:     function revertBatches(uint256 _newLastBatch) external nonReentrant onlyValidatorOrStateTransitionManager { 

477:     function revertBatchesSharedBridge(uint256, uint256 _newLastBatch) external nonReentrant onlyValidator { 
```
[199](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L199-L202), [207](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L207-L211), [337](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L337-L340), [345](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L345), [368](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L368-L372), [377](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L377-L382), [472](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L472), [477](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L477)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

38:     function transferEthToSharedBridge() external onlyBaseTokenBridge { 
```
[38](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L38)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

111:     function reinitializeToken( 
112:         ERC20Getters calldata _availableGetters,
113:         string memory _newName,
114:         string memory _newSymbol,
115:         uint8 _version
116:     ) external onlyNextVersion(_version) reinitializer(_version) {

145:     function bridgeMint(address _to, uint256 _amount) external override onlyBridge { 

154:     function bridgeBurn(address _from, uint256 _amount) external override onlyBridge { 
```
[111](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L111-L116), [145](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L145), [154](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L154)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

35:     function storeAccountConstructingCodeHash(address _address, bytes32 _hash) external override onlyDeployer { 

46:     function storeAccountConstructedCodeHash(address _address, bytes32 _hash) external override onlyDeployer { 

54:     function markAccountCodeHashAsConstructed(address _address) external override onlyDeployer { 
```
[35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L35), [46](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L46), [54](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L54)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

65:     function updateAccountVersion(AccountAbstractionVersion _version) external onlySystemCall { 

74:     function updateNonceOrdering(AccountNonceOrdering _nonceOrdering) external onlySystemCall { 
```
[65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L65), [74](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L74)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

27:     function markFactoryDeps(bool _shouldSendToL1, bytes32[] calldata _hashes) external onlyCallFromBootloader { 

39:     function markBytecodeAsPublished(bytes32 _bytecodeHash) external onlyCompressor { 
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L27), [39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L39)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

70:     function sendL2ToL1Log( 
71:         bool _isService,
72:         bytes32 _key,
73:         bytes32 _value
74:     ) external onlyCallFromSystemContract returns (uint256 logIdInMerkleTree) {

161:     function requestBytecodeL1Publication( 
162:         bytes32 _bytecodeHash
163:     ) external override onlyCallFrom(address(KNOWN_CODE_STORAGE_CONTRACT)) {

194:     function publishPubdataAndClearState( 
195:         bytes calldata _totalL2ToL1PubdataAndStateDiffs
196:     ) external onlyCallFromBootloader {
```
[70](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L70-L74), [161](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L161-L163), [194](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L194-L196)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

64:     function mint(address _account, uint256 _amount) external override onlyCallFromBootloader { 
```
[64](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L64)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

47:     fallback(bytes calldata _data) external onlySystemCall returns (bytes memory) { 
```
[47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L47)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

65:     function increaseMinNonce(uint256 _value) public onlySystemCall returns (uint256 oldMinNonce) { 

82:     function setValueUnderNonce(uint256 _key, uint256 _value) public onlySystemCall { 

110:     function incrementMinNonceIfEquals(uint256 _expectedNonce) external onlySystemCall { 
```
[65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L65), [82](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L82), [110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L110)

```solidity
üìÅ File: system-contracts/contracts/PubdataChunkPublisher.sol

21:     function chunkAndPublishPubdata(bytes calldata _pubdata) external onlyCallFrom(address(L1_MESSENGER_CONTRACT)) { 
```
[21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L21)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

84:     function setChainId(uint256 _newChainId) external onlyCallFromForceDeployer { 

99:     function setTxOrigin(address _newOrigin) external onlyCallFromBootloader { 

105:     function setGasPrice(uint256 _gasPrice) external onlyCallFromBootloader { 

112:     function setPubdataInfo(uint256 _gasPerPubdataByte, uint256 _basePubdataSpent) external onlyCallFromBootloader { 

341:     function setL2Block( 
342:         uint128 _l2BlockNumber,
343:         uint128 _l2BlockTimestamp,
344:         bytes32 _expectedPrevL2BlockHash,
345:         bool _isFirstInBatch,
346:         uint128 _maxVirtualBlocksToCreate
347:     ) external onlyCallFromBootloader {

402:     function appendTransactionToCurrentL2Block(bytes32 _txHash) external onlyCallFromBootloader { 

408:     function publishTimestampDataToL1() external onlyCallFromBootloader { 

444:     function setNewBatch( 
445:         bytes32 _prevBatchHash,
446:         uint128 _newTimestamp,
447:         uint128 _expectedNewNumber,
448:         uint256 _baseFee
449:     ) external onlyCallFromBootloader {

471:     function unsafeOverrideBatch( 
472:         uint256 _newTimestamp,
473:         uint256 _number,
474:         uint256 _baseFee
475:     ) external onlyCallFromBootloader {

482:     function incrementTxNumberInBatch() external onlyCallFromBootloader { 

486:     function resetTxNumberInBatch() external onlyCallFromBootloader { 
```
[84](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L84), [99](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L99), [105](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L105), [112](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L112), [341](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L341-L347), [402](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L402), [408](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L408), [444](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L444-L449), [471](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L471-L475), [482](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L482), [486](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L486)

</details>


---
### [GAS&#x2011;39] Initializers can be marked `payable`

Gas saved per Instance: ~21 *(Total: ~126)*
<details>
<summary><i>There are 6 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

60:     function initialize() external reentrancyGuardInitializer {} 
```
[60](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L60)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

104:     function initialize( 
105:         address _owner,
106:         uint256 _eraFirstPostUpgradeBatch
107:     ) external reentrancyGuardInitializer initializer {
```
[104](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L104-L107)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

41:     function initialize(address _owner) external reentrancyGuardInitializer { 
```
[41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L41)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

79:     function initialize( 
80:         StateTransitionManagerInitializeData calldata _initializeData
81:     ) external reentrancyGuardInitializer {
```
[79](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L79-L81)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol

24:     function initialize(InitializeData calldata _initializeData) external reentrancyGuardInitializer returns (bytes32) { 
```
[24](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L24)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

49:     function initialize( 
50:         address _l1Bridge,
51:         address _l1LegecyBridge,
52:         bytes32 _l2TokenProxyBytecodeHash,
53:         address _aliasedOwner
54:     ) external reinitializer(2) {
```
[49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L49-L54)

</details>


---
### [GAS&#x2011;40] Integer increments by one can be unchecked
Using unchecked increments in Solidity can save on gas fees by bypassing built-in overflow checks, thus optimizing gas usage, but requires careful assessment of potential risks and edge cases to avoid unintended consequences.


Gas saved per Instance: ~60 *(Total: ~1,320)*
<details>
<summary><i>There are 22 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

225:         for (uint256 i = 0; i < _calls.length; ++i) { 
```
[225](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L225)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

580:         for (uint i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 

657:             versionedHashIndex += 1; 

667:         for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 
```
[580](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L580), [657](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L657), [667](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L667)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol

60:         _queue.tail = tail + 1; 

80:         _queue.head = head + 1; 
```
[60](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L60), [80](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L80)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

226:         for (uint256 i = 0; i < _factoryDeps.length; ++i) { 
```
[226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L226)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

135:             numInitialWritesProcessed++; 

144:             stateDiffPtr++; 

175:             stateDiffPtr += 1; 
```
[135](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L135), [144](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L144), [175](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L175)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

248:         for (uint256 i = 0; i < deploymentsLength; ++i) { 

253:         for (uint256 i = 0; i < deploymentsLength; ++i) { 
```
[248](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L248), [253](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L253)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

109:         numberOfLogsToProcess++; 

206:         for (uint256 i = 0; i < numberOfL2ToL1Logs; ++i) { 

218:         for (uint256 i = numberOfL2ToL1Logs; i < L2_TO_L1_LOGS_MERKLE_TREE_LEAVES; ++i) { 

224:             for (uint256 i = 0; i < nodesOnCurrentLevel; ++i) { 

236:         for (uint256 i = 0; i < numberOfMessages; ++i) { 

254:         for (uint256 i = 0; i < numberOfBytecodes; ++i) { 

284:         calldataPtr++; 

290:         calldataPtr++; 
```
[109](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L109), [206](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L206), [218](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L218), [224](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L224), [236](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L236), [254](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L254), [284](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L284), [290](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L290)

```solidity
üìÅ File: system-contracts/contracts/PubdataChunkPublisher.sol

36:         for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) { 
```
[36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L36)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

483:         txNumberInBlock += 1; 
```
[483](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L483)

</details>


---
### [GAS&#x2011;41] `internal` functions only used once can be inlined so save gas
If a internal function is only used once it doesn't make sense to modularise it unless the function which does call the function would be overly long and complex otherwise


Gas saved per Instance: ~30 *(Total: ~1,470)*
<details>
<summary><i>There are 49 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

160:     function _depositFundsToSharedBridge(address _from, IERC20 _token, uint256 _amount) internal returns (uint256) { 
```
[160](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L160)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

254:     function _getERC20Getters(address _token) internal view returns (bytes memory) { 

458:     function _checkWithdrawal( 

487:     function _parseL2WithdrawalMessage( 
```
[254](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L254), [458](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L458), [487](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L487)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

177:     function _setChainIdUpgrade(uint256 _chainId, address _chainContract) internal { 
```
[177](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L177)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

103:     function _verifyBatchTimestamp( 

130:     function _processL2Logs( 

253:     function _commitBatchesWithoutSystemContractsUpgrade( 

273:     function _commitBatchesWithSystemContractsUpgrade( 

308:     function _collectOperationsFromPriorityQueue(uint256 _nPriorityOps) internal returns (bytes32 concatHash) { 

321:     function _executeOneBatch(StoredBatchInfo memory _storedBatch, uint256 _executedBatchIdx) internal { 

453:     function _getBatchProofPublicInput( 

500:     function _createBatchCommitment( 

515:     function _batchPassThroughData(CommitBatchInfo calldata _batch) internal pure returns (bytes memory) { 

525:     function _batchMetaParameters() internal view returns (bytes memory) { 

537:     function _batchAuxiliaryOutput( 

561:     function _encodeBlobAuxilaryOutput( 

592:     function _checkBit(uint256 _bitMap, uint8 _index) internal pure returns (bool) { 

597:     function _setBit(uint256 _bitMap, uint8 _index) internal pure returns (uint256) { 

605:     function _pointEvaluationPrecompile( 

625:     function _verifyBlobInformation( 
```
[103](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L103), [130](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L130), [253](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L253), [273](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L273), [308](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L308), [321](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L321), [453](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L453), [500](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L500), [515](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L515), [525](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L525), [537](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L537), [561](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L561), [592](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L592), [597](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L597), [605](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L605), [625](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L625)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

130:     function _L2MessageToLog(L2Message memory _message) internal pure returns (L2Log memory) { 

258:     function _requestL2Transaction( 

289:     function _serializeL2Transaction( 

316:     function _writePriorityOp( 

353:     function _hashFactoryDeps(bytes[] memory _factoryDeps) internal pure returns (uint256[] memory hashedFactoryDeps) { 
```
[130](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L130), [258](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L258), [289](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L289), [316](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L316), [353](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L353)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol

20:     function _setNewProtocolVersion(uint256 _newProtocolVersion) internal override { 
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L20)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

109:     function _deployL2Token(address _l1Token, bytes calldata _data) internal returns (address) { 

138:     function _getL1WithdrawMessage( 

164:     function _deployBeaconProxy(bytes32 salt) internal returns (BeaconProxy proxy) { 
```
[109](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L109), [138](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L138), [164](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L164)

```solidity
üìÅ File: system-contracts/contracts/BootloaderUtilities.sol

44:     function encodeLegacyTransactionHash(Transaction calldata _transaction) internal view returns (bytes32 txHash) { 

139:     function encodeEIP2930TransactionHash(Transaction calldata _transaction) internal view returns (bytes32) { 

229:     function encodeEIP1559TransactionHash(Transaction calldata _transaction) internal view returns (bytes32) { 
```
[44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L44), [139](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L139), [229](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L229)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

197:     function _decodeRawBytecode( 
```
[197](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L197)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

283:     function _performDeployOnAddress( 

309:     function _storeConstructingByteCodeHashOnAddress(address _newAddress, bytes32 _bytecodeHash) internal { 
```
[283](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L283), [309](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L309)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

78:     function _validateTransaction( 

131:     function _execute(Transaction calldata _transaction) internal { 

159:     function _isValidSignature(bytes32 _hash, bytes memory _signature) internal view returns (bool) { 
```
[78](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L78), [131](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L131), [159](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L159)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

74:     function _validateBytecode(bytes32 _bytecodeHash) internal pure { 
```
[74](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L74)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

61:     function sha256GasCost(uint256 _length) internal pure returns (uint256) { 
```
[61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L61)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

112:     function _getL1WithdrawMessage(address _to, uint256 _amount) internal pure returns (bytes memory) { 

117:     function _getExtendedWithdrawMessage( 
```
[112](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L112), [117](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L117)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

25:     function _getAbiParams() internal view returns (uint256 value, bool isSystemCall, address to) { 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L25)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

221:     function _calculateL2BlockHash( 

233:     function _calculateLegacyL2BlockHash(uint128 _blockNumber) internal pure returns (bytes32) { 

241:     function _upgradeL2Blocks(uint128 _l2BlockNumber, bytes32 _expectedPrevL2BlockHash, bool _isFirstInBatch) internal { 

263:     function _setVirtualBlock( 

427:     function _ensureBatchConsistentWithL2Block(uint128 _newTimestamp) internal view { 
```
[221](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L221), [233](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L233), [241](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L241), [263](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L263), [427](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L427)

</details>


---
### [GAS&#x2011;42] Low-level `call` can be optimized with assembly
`returnData` is copied to memory even if the variable is not utilized: the proper way to handle this is through a low level assembly call and save **159** [gas](https://gist.github.com/IllIllI000/0e18a40f3afb0b83f9a347b10ee89ad2).

```solidity
 // before (bool success,) = payable(receiver).call{gas: gas, value: value}("");
//after bool success; assembly { success := call(gas, receiver, value, 0, 0, 0, 0) }
```



Gas saved per Instance: ~159 *(Total: ~477)*
<details>
<summary><i>There are 3 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

612:         (bool success, bytes memory data) = POINT_EVALUATION_PRECOMPILE_ADDR.staticcall(precompileInput); 
```
[612](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L612)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

283:             (bool success, bytes memory data) = _init.delegatecall(_calldata); 
```
[283](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L283)

```solidity
üìÅ File: system-contracts/contracts/ComplexUpgrader.sol

25:         (bool success, bytes memory returnData) = _delegateTo.delegatecall(_calldata); 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L25)

</details>


---
### [GAS&#x2011;43] Mappings are cheaper to use than storage arrays
When using storage arrays, solidity adds an internal lookup of the array's length (a Gcoldsload **2100 gas**) to ensure you don't read past the array's end. You can avoid this lookup by using a `mapping` and storing the number of entries in a separate storage variable. In cases where you have sentinel values (e.g. 'zero' means invalid), you can avoid length checks


Gas saved per Instance: ~2,100 *(Total: ~18,900)*
<details>
<summary><i>There are 9 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/governance/IGovernance.sol

36:         Call[] calls; 
```
[36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L36)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol

127:         uint256[] recursiveAggregationInput; 
128:         uint256[] serializedProof;
```
[127](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L127-L128)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol

126:         bytes4[] selectors; 
```
[126](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L126)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

40:         bytes4[] selectors; 

53:         address[] facets; 

66:         bytes4[] selectors; 

74:         FacetCut[] facetCuts; 
```
[40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L40), [53](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L53), [66](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L66), [74](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L74)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

70:     bytes32[MINIBLOCK_HASHES_TO_STORE] internal l2BlockHash; 
```
[70](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L70)

</details>


---
### [GAS&#x2011;44] Memory-safe annotation missing
Use `assembly ("memory-safe") { ... }` for the assembly blocks below since they dont't read or modify memory, and therefore are [memory-safe](https://docs.soliditylang.org/en/latest/assembly.html#memory-safety). This will help the optimizer to create more optimal gas-efficient code. Use the comment variant if prior to Solidity version 0.8.13

<details>
<summary><i>There are 6 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

237:             switch result 
238:             case 0 {
239:                 // End execution and revert state changes
240:                 revert(0, size)
241:             }
242:             default {
243:                 // Return data with length of size at pointers position
244:                 return(0, size)
245:             }
```
[237](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L237-L245)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol

45:             switch result 
46:             case 0 {
47:                 // End execution and revert state changes
48:                 revert(ptr, size)
49:             }
50:             default {
51:                 // Return data with length of size at pointers position
52:                 return(ptr, size)
53:             }
```
[45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L45-L53)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

68:             if (!success) { 
69:                 assembly {
70:                     revert(0, 0)
71:                 }
```
[68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L68-L71)

```solidity
üìÅ File: system-contracts/contracts/libraries/EfficientCall.sol

232:     function propagateRevert() internal pure { 
233:         assembly {
234:             let size := returndatasize()
235:             returndatacopy(0, 0, size)
236:             revert(0, size)
237:         }
```
[232](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L232-L237)

</details>


---
### [GAS&#x2011;45] Merge events to save gas
Consolidating multiple event emissions into a single event in Solidity saves gas by reducing the cost per topic. This is crucial in functions emitting multiple related events. However, it's important to balance gas optimization with event data clarity for off-chain consumers.


Gas saved per Instance: ~375 *(Total: ~1,500)*
<details>
<summary><i>There are 4 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

/// @audit 'NewPendingAdmin', 'NewAdmin'
60:     function acceptAdmin() external { 
```
[60](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L60)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

/// @audit 'ChangeSecurityCouncil', 'ChangeMinDelay'
41:     constructor(address _admin, address _securityCouncil, uint256 _minDelay) { 
```
[41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L41)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

/// @audit 'NewPendingAdmin', 'NewAdmin'
119:     function acceptAdmin() external { 
```
[119](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L119)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

/// @audit 'NewPendingAdmin', 'NewAdmin'
32:     function acceptAdmin() external { 
```
[32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L32)

</details>


---
### [GAS&#x2011;46] Multiple accesses of the same mapping/array key/index should be cached
The instances below point to the second+ access of a value inside a mapping/array key/index, within a function. Caching a mapping's value in a local storage or calldata variable when the value is accessed [multiple times](https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0), saves ~42 gas per access due to not having to recalculate the key's keccak256 hash (Gkeccak256 - 30 gas) and that calculation's associated stack operations. Caching an array's struct avoids recalculating the array offsets into memory/calldata


Gas saved per Instance: ~42 *(Total: ~1,680)*
<details>
<summary><i>There are 40 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

/// @audit chainBalance[_targetChainId][ETH_TOKEN_ADDRESS] is also accessed on line 122
123:                 chainBalance[_targetChainId][ETH_TOKEN_ADDRESS] + 

/// @audit chainBalance[_targetChainId][_token] is also accessed on line 133
/// @audit chainBalance[_targetChainId] is also accessed on line 122
/// @audit chainBalance[_targetChainId] is also accessed on line 123
/// @audit chainBalance[_targetChainId] is also accessed on line 133
133:             chainBalance[_targetChainId][_token] = chainBalance[_targetChainId][_token] + amount; 

/// @audit l2BridgeAddress[_chainId] is also accessed on line 188
221:                 l2Contract: l2BridgeAddress[_chainId], 

/// @audit depositHappened[_chainId][_txHash] is also accessed on line 237
/// @audit depositHappened[_chainId] is also accessed on line 237
238:         depositHappened[_chainId][_txHash] = _txDataHash; 

/// @audit chainBalance[_chainId][_l1Token] is also accessed on line 349
/// @audit chainBalance[_chainId] is also accessed on line 349
350:             chainBalance[_chainId][_l1Token] -= _amount; 

/// @audit isWithdrawalFinalized[_chainId][_l2BatchNumber][_l2MessageIndex] is also accessed on line 417
/// @audit isWithdrawalFinalized[_chainId][_l2BatchNumber] is also accessed on line 417
/// @audit isWithdrawalFinalized[_chainId] is also accessed on line 417
418:         isWithdrawalFinalized[_chainId][_l2BatchNumber][_l2MessageIndex] = true; 

/// @audit chainBalance[_chainId][l1Token] is also accessed on line 439
/// @audit chainBalance[_chainId] is also accessed on line 439
440:             chainBalance[_chainId][l1Token] -= amount; 

/// @audit l2BridgeAddress[ERA_CHAIN_ID] is also accessed on line 563
586:                 l2Contract: l2BridgeAddress[ERA_CHAIN_ID], 
```
[123](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L123), [133](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L133), [221](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L221), [238](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L238), [350](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L350), [418](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L418), [440](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L440), [586](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L586)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

/// @audit stateTransitionManagerIsRegistered[_stateTransitionManager] is also accessed on line 84
87:         stateTransitionManagerIsRegistered[_stateTransitionManager] = true; 

/// @audit stateTransitionManagerIsRegistered[_stateTransitionManager] is also accessed on line 94
97:         stateTransitionManagerIsRegistered[_stateTransitionManager] = false; 

/// @audit tokenIsRegistered[_token] is also accessed on line 102
103:         tokenIsRegistered[_token] = true; 

/// @audit stateTransitionManager[_chainId] is also accessed on line 132
134:         stateTransitionManager[_chainId] = _stateTransitionManager; 
```
[87](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L87), [97](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L97), [103](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L103), [134](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L134)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

/// @audit stateTransition[_chainId] is also accessed on line 246
282:         stateTransition[_chainId] = stateTransitionAddress; 
```
[282](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L282)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

/// @audit validators[_chainId][_newValidator] is also accessed on line 79
/// @audit validators[_chainId] is also accessed on line 79
82:         validators[_chainId][_newValidator] = true; 

/// @audit validators[_chainId][_validator] is also accessed on line 88
/// @audit validators[_chainId] is also accessed on line 88
91:         validators[_chainId][_validator] = false; 
```
[82](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L82), [91](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L91)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

/// @audit blobHashes[0] is also accessed on line 55
66:             blobHashes[0] = logOutput.blob1Hash; 

/// @audit s.storedBatchHashes[currentTotalBatchesVerified] is also accessed on line 402
408:                 _hashStoredBatchInfo(_committedBatches[i]) == s.storedBatchHashes[currentTotalBatchesVerified], 
```
[66](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L66), [408](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L408)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

/// @audit ds.facetToSelectors[_facet] is also accessed on line 168
170:             bytes4 selector0 = ds.facetToSelectors[_facet].selectors[0]; 

/// @audit ds.selectorToFacet[_selector] is also accessed on line 183
184:         return ds.selectorToFacet[_selector].isFreezable; 
```
[170](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L170), [184](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L184)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

/// @audit ds.facetToSelectors[_facet] is also accessed on line 192
195:             ds.facetToSelectors[_facet].facetPosition = ds.facets.length.toUint16(); 

/// @audit ds.facetToSelectors[_facet] is also accessed on line 208
/// @audit ds.facetToSelectors[_facet] is also accessed on line 214
223:         ds.facetToSelectors[_facet].selectors.push(_selector); 

/// @audit ds.facetToSelectors[_facet] is also accessed on line 233
/// @audit ds.facetToSelectors[_facet] is also accessed on line 237
/// @audit ds.facetToSelectors[_facet] is also accessed on line 239
244:         ds.facetToSelectors[_facet].selectors.pop(); 
```
[195](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L195), [223](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L223), [244](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L244)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/LibMap.sol

/// @audit _map.map[mapIndex] is also accessed on line 44
61:             _map.map[mapIndex] = (newValueXorOldValue << bitOffset) ^ mapValue; 
```
[61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L61)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

/// @audit l1TokenAddress[expectedL2Token] is also accessed on line 95
99:             l1TokenAddress[expectedL2Token] = _l1Token; 
```
[99](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L99)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

/// @audit _compressedStateDiffs[stateDiffPtr] is also accessed on line 143
174:             uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr])); 
```
[174](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L174)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

/// @audit _totalL2ToL1PubdataAndStateDiffs[calldataPtr] is also accessed on line 280
289:         uint8 enumerationIndexSize = uint8(bytes1(_totalL2ToL1PubdataAndStateDiffs[calldataPtr])); 
```
[289](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L289)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

/// @audit balance[_from] is also accessed on line 40
43:             balance[_from] = fromBalance - _amount; 
```
[43](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L43)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

/// @audit rawNonces[addressAsKey] is also accessed on line 69
72:             rawNonces[addressAsKey] = (oldRawNonce + _value); 

/// @audit rawNonces[addressAsKey] is also accessed on line 112
118:             rawNonces[addressAsKey] = oldRawNonce + 1; 

/// @audit rawNonces[addressAsKey] is also accessed on line 141
144:             rawNonces[addressAsKey] = (oldRawNonce + DEPLOY_NONCE_MULTIPLIER); 
```
[72](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L72), [118](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L118), [144](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L144)

```solidity
üìÅ File: system-contracts/contracts/libraries/RLPEncoder.sol

/// @audit encoded[0] is also accessed on line 29
34:                 encoded[0] = bytes1(uint8(hbs + 0x81)); 

/// @audit encoded[0] is also accessed on line 64
69:                 encoded[0] = bytes1(uint8(_offset + hbs + 56)); 
```
[34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L34), [69](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L69)

</details>


---
### [GAS&#x2011;47] Multiple `address`/ID mappings can be combined into a single `mapping` of an `address`/ID to a `struct`
Saves a storage slot for the mapping. Depending on the circumstances and sizes of types, can avoid a Gsset (**20000 gas**) per mapping combined. Reads and subsequent writes can also be cheaper when a function requires both values and they both fit in the same storage slot. Finally, if both fields are accessed in the same function, can save **~42 gas per access** due to [not having to recalculate the key's keccak256 hash](https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0) (Gkeccak256 - **30 gas**) and that calculation's associated stack operations.


Gas saved per Instance: ~20,000 *(Total: ~380,000)*
<details>
<summary><i>There are 19 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

32:     mapping(address account => mapping(address l1Token => mapping(bytes32 depositL2TxHash => uint256 amount))) 

45:     mapping(address => uint256) private __DEPRECATED_lastWithdrawalLimitReset; 

48:     mapping(address => uint256) private __DEPRECATED_withdrawnAmountInWindow; 

51:     mapping(address => mapping(address => uint256)) private __DEPRECATED_totalDepositedAmountPerUser; 
```
[32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L32), [45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L45), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L48), [51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L51)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

48:     mapping(uint256 chainId => address l2Bridge) public override l2BridgeAddress; 

52:     mapping(uint256 chainId => mapping(bytes32 l2DepositTxHash => bytes32 depositDataHash)) 

65:     mapping(uint256 chainId => mapping(address l1Token => uint256 balance)) internal chainBalance; 
```
[48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L48), [52](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L52), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L65)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

26:     mapping(uint256 _chainId => address) public stateTransitionManager; 

29:     mapping(uint256 _chainId => address) public baseToken; 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L26), [29](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L29)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

30:     mapping(uint256 => address) public stateTransition; 

48:     mapping(uint256 => bytes32) public upgradeCutHash; 
```
[30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L30), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L48)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

21:     mapping(uint256 contractAddress => mapping(uint256 index => bytes32 value)) internal immutableDataStorage; 
```
[21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L21)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

36:     mapping(uint256 account => uint256 packedMinAndDeploymentNonce) internal rawNonces; 

41:     mapping(uint256 account => mapping(uint256 nonceKey => uint256 value)) internal nonceValues; 
```
[36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L36), [41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L41)

</details>


---
### [GAS&#x2011;48] Nested for loops should be avoided due to high gas costs resulting from O^2 time complexity
In Solidity, avoiding nested loops is crucial due to their high gas costs, especially for large datasets. Nested loops can lead to quadratic time complexity, significantly increasing gas costs. Users pay for gas, so minimizing gas usage is vital. To optimize efficiency, limit loop usage, reduce iteration ranges, and minimize computations. Alternative patterns like map/filter/reduce are often cheaper in terms of gas usage.

<details>
<summary><i>There are 2 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

/// @audit _addFunctions() has loop inside @ line 110
_replaceFunctions() has loop inside @ line 112
_removeFunctions() has loop inside @ line 114
101:         for (uint256 i = 0; i < facetCutsLength; i = i.uncheckedInc()) { 
```
[101](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L101)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

/// @audit loop @ line: 224
222:         while (nodesOnCurrentLevel > 1) { 
```
[222](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L222)

</details>


---
### [GAS&#x2011;49] Nesting `if`-statements is cheaper than using `&&`
Using a double if statement instead of logical AND (&&) can provide similar short-circuiting behavior whereas double if is slightly more efficient.


Gas saved per Instance: ~30 *(Total: ~390)*
<details>
<summary><i>There are 13 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol

41:         require(version == 1 && _bytecodeHash[1] == bytes1(0), "zf"); // Incorrectly formatted bytecodeHash 
```
[41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L41)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

361:         if (batchWhenUpgradeHappened != 0 && batchWhenUpgradeHappened <= newTotalBatchesExecuted) { 

668:             require( 
```
[361](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L361), [668](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L668)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

147:         if ( 
148:             _newVerifierParams.recursionNodeLevelVkHash == bytes32(0) &&
149:             _newVerifierParams.recursionLeafLevelVkHash == bytes32(0) &&
150:             _newVerifierParams.recursionCircuitsSetVksHash == bytes32(0)
```
[147](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L147-L150)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

131:         if ( 
132:             uint160(account) > CURRENT_MAX_PRECOMPILE_ADDRESS &&
133:             codeHash != 0x00 &&
134:             !Utils.isContractConstructing(codeHash)
```
[131](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L131-L134)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

47:         if ( 
48:             _address > address(MAX_SYSTEM_CONTRACT_ADDRESS) &&
49:             ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.getRawCodeHash(_address) == 0

77:         require( 
```
[47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L47-L49), [77](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L77)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

139:         if (to == address(DEPLOYER_SYSTEM_CONTRACT) && data.length >= 4) { 
```
[139](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L139)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

76:         require(version == 1 && _bytecodeHash[1] == bytes1(0), "Incorrectly formatted bytecodeHash"); 
```
[76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L76)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

88:         if (accountInfo.nonceOrdering == IContractDeployer.AccountNonceOrdering.Sequential && _key != 0) { 

171:         } else if (!isUsed && _shouldBeUsed) { 
```
[88](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L88), [171](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L171)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

150:         } else if ( 
151:             _block >= currentVirtualBlockUpgradeInfo.virtualBlockFinishL2Block &&
152:             currentVirtualBlockUpgradeInfo.virtualBlockFinishL2Block > 0
```
[150](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L150-L152)

</details>


---
### [GAS&#x2011;50] Newer versions of solidity are more gas efficient
The solidity language continues to pursue more efficient gas optimization schemes. Adopting a [newer version of solidity](https://github.com/ethereum/solc-js/tags) can be more gas efficient.

<details>
<summary><i>There are 105 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol

2: pragma solidity 0.8.20; 
```
[2](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol#L2)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/common/Config.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/Config.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/common/L2ContractAddresses.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/L2ContractAddresses.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/common/Messaging.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/Messaging.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/common/ReentrancyGuard.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/UncheckedMath.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UncheckedMath.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/IGovernance.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol

2: pragma solidity 0.8.20; 
```
[2](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol#L2)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol

2: pragma solidity ^0.8.0; 
```
[2](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol#L2)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/LibMap.sol

2: pragma solidity 0.8.20; 
```
[2](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L2)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol#L3)

```solidity
üìÅ File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol

19: pragma solidity 0.8.20; 
```
[19](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L19)

```solidity
üìÅ File: contracts/zksync/contracts/ForceDeployUpgrader.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/ForceDeployUpgrader.sol#L3)

```solidity
üìÅ File: contracts/zksync/contracts/L2ContractHelper.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L3)

```solidity
üìÅ File: contracts/zksync/contracts/SystemContractsCaller.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L3)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L3)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L3)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L3)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol#L3)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L3)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L3)

```solidity
üìÅ File: contracts/zksync/contracts/interfaces/IPaymaster.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymaster.sol#L3)

```solidity
üìÅ File: contracts/zksync/contracts/interfaces/IPaymasterFlow.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymasterFlow.sol#L3)

```solidity
üìÅ File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol

19: pragma solidity 0.8.20; 
```
[19](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L19)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/BootloaderUtilities.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/ComplexUpgrader.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/Constants.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/EmptyContract.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/GasBoundCaller.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/PubdataChunkPublisher.sol

2: pragma solidity 0.8.20; 
```
[2](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L2)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IAccount.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccount.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IAccountCodeStorage.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IBaseToken.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IBootloaderUtilities.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBootloaderUtilities.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IComplexUpgrader.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IComplexUpgrader.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ICompressor.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ICompressor.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IContractDeployer.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IImmutableSimulator.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IKnownCodesStorage.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IKnownCodesStorage.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IL1Messenger.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IL2StandardToken.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IMailbox.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IMailbox.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/INonceHolder.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IPaymaster.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IPaymasterFlow.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymasterFlow.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IPubdataChunkPublisher.sol

2: pragma solidity 0.8.20; 
```
[2](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPubdataChunkPublisher.sol#L2)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContext.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContextDeprecated.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContextDeprecated.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContract.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/libraries/EfficientCall.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/libraries/RLPEncoder.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractHelper.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractsCaller.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol

3: pragma solidity 0.8.20; 
```
[3](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L3)

```solidity
üìÅ File: system-contracts/contracts/libraries/Utils.sol

2: pragma solidity 0.8.20; 
```
[2](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L2)

</details>


---
### [GAS&#x2011;51] Not using the named return variables when a function returns, wastes deployment gas
The solidity compiler outputs more efficient code when the variable is declared in the return statement. There seem to be very few exceptions to this in practice, so if you see an anonymous return, you should test it with a named return instead to determine which case is most efficient.

<details>
<summary><i>There are 459 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

/// @audit Parameter of type 'address' at index '0'
75:     function l2TokenAddress(address _l1Token) external view returns (address) { 

98:     function deposit( 
99:         address _l2Receiver,
100:         address _l1Token,
101:         uint256 _amount,
102:         uint256 _l2TxGasLimit,
103:         uint256 _l2TxGasPerPubdataByte
104:     ) external payable returns (bytes32 l2TxHash) {
105:         l2TxHash = deposit(_l2Receiver, _l1Token, _amount, _l2TxGasLimit, _l2TxGasPerPubdataByte, address(0));
106:     }

133:     function deposit( 
134:         address _l2Receiver,
135:         address _l1Token,
136:         uint256 _amount,
137:         uint256 _l2TxGasLimit,
138:         uint256 _l2TxGasPerPubdataByte,
139:         address _refundRecipient
140:     ) public payable nonReentrant returns (bytes32 l2TxHash) {
141:         require(_amount != 0, "0T"); // empty deposit
142:         uint256 amount = _depositFundsToSharedBridge(msg.sender, IERC20(_l1Token), _amount);
143:         require(amount == _amount, "3T"); // The token has non-standard transfer logic
144: 
145:         l2TxHash = sharedBridge.depositLegacyErc20Bridge{value: msg.value}(
146:             msg.sender,
147:             _l2Receiver,
148:             _l1Token,
149:             _amount,
150:             _l2TxGasLimit,
151:             _l2TxGasPerPubdataByte,
152:             _refundRecipient
153:         );
154:         depositAmount[msg.sender][_l1Token][l2TxHash] = _amount;
155:         emit DepositInitiated(l2TxHash, msg.sender, _l2Receiver, _l1Token, _amount);
156:     }

/// @audit Parameter of type 'uint256' at index '0'
160:     function _depositFundsToSharedBridge(address _from, IERC20 _token, uint256 _amount) internal returns (uint256) { 
```
[75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L75), [98](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L98-L106), [133](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L133-L156), [160](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L160)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

/// @audit Parameter of type 'uint256' at index '0'
173:     function _depositFunds(address _from, IERC20 _token, uint256 _amount) internal returns (uint256) { 

182:     function bridgehubDeposit( 
183:         uint256 _chainId,
184:         address _prevMsgSender,
185:         uint256, // l2Value, needed for Weth deposits in the future
186:         bytes calldata _data
187:     ) external payable override onlyBridgehub returns (L2TransactionRequestTwoBridgesInner memory request) {
188:         require(l2BridgeAddress[_chainId] != address(0), "ShB l2 bridge not deployed");
189: 
190:         (address _l1Token, uint256 _depositAmount, address _l2Receiver) = abi.decode(
191:             _data,
192:             (address, uint256, address)
193:         );
194:         require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported");
195:         require(bridgehub.baseToken(_chainId) != _l1Token, "ShB: baseToken deposit not supported");
196: 
197:         uint256 amount;
198:         if (_l1Token == ETH_TOKEN_ADDRESS) {
199:             amount = msg.value;
200:             require(_depositAmount == 0, "ShB wrong withdraw amount");
201:         } else {
202:             require(msg.value == 0, "ShB m.v > 0 for BH d.it 2");
203:             amount = _depositAmount;
204: 
205:             uint256 withdrawAmount = _depositFunds(_prevMsgSender, IERC20(_l1Token), _depositAmount);
206:             require(withdrawAmount == _depositAmount, "5T"); // The token has non-standard transfer logic
207:         }
208:         require(amount != 0, "6T"); // empty deposit amount
209: 
210:         bytes32 txDataHash = keccak256(abi.encode(_prevMsgSender, _l1Token, amount));
211:         if (!hyperbridgingEnabled[_chainId]) {
212:             chainBalance[_chainId][_l1Token] += amount;
213:         }
214: 
215:         {
216:             // Request the finalization of the deposit on the L2 side
217:             bytes memory l2TxCalldata = _getDepositL2Calldata(_prevMsgSender, _l2Receiver, _l1Token, amount);
218: 
219:             request = L2TransactionRequestTwoBridgesInner({
220:                 magicValue: TWO_BRIDGES_MAGIC_VALUE,
221:                 l2Contract: l2BridgeAddress[_chainId],
222:                 l2Calldata: l2TxCalldata,
223:                 factoryDeps: new bytes[](0),
224:                 txDataHash: txDataHash
225:             });
226:         }
227:         emit BridgehubDepositInitiated(_chainId, txDataHash, _prevMsgSender, _l2Receiver, _l1Token, amount);
228:     }

243:     function _getDepositL2Calldata( 

/// @audit Parameter of type 'bytes' at index '0'
254:     function _getERC20Getters(address _token) internal view returns (bytes memory) { 

/// @audit Parameter of type 'bool' at index '0'
374:     function _isEraLegacyWithdrawal(uint256 _chainId, uint256 _l2BatchNumber) internal view returns (bool) { 

409:     function _finalizeWithdrawal( 
410:         uint256 _chainId,
411:         uint256 _l2BatchNumber,
412:         uint256 _l2MessageIndex,
413:         uint16 _l2TxNumberInBatch,
414:         bytes calldata _message,
415:         bytes32[] calldata _merkleProof
416:     ) internal nonReentrant returns (address l1Receiver, address l1Token, uint256 amount) {
417:         require(!isWithdrawalFinalized[_chainId][_l2BatchNumber][_l2MessageIndex], "Withdrawal is already finalized");
418:         isWithdrawalFinalized[_chainId][_l2BatchNumber][_l2MessageIndex] = true;
419: 
420:         // Handling special case for withdrawal from zkSync Era initiated before Shared Bridge.
421:         if (_isEraLegacyWithdrawal(_chainId, _l2BatchNumber)) {
422:             // Checks that the withdrawal wasn't finalized already.
423:             bool alreadyFinalized = IGetters(ERA_DIAMOND_PROXY).isEthWithdrawalFinalized(
424:                 _l2BatchNumber,
425:                 _l2MessageIndex
426:             );
427:             require(!alreadyFinalized, "Withdrawal is already finalized 2");
428:         }
429: 
430:         MessageParams memory messageParams = MessageParams({
431:             l2BatchNumber: _l2BatchNumber,
432:             l2MessageIndex: _l2MessageIndex,
433:             l2TxNumberInBatch: _l2TxNumberInBatch
434:         });
435:         (l1Receiver, l1Token, amount) = _checkWithdrawal(_chainId, messageParams, _message, _merkleProof);
436: 
437:         if (!hyperbridgingEnabled[_chainId]) {
438:             // Check that the chain has sufficient balance
439:             require(chainBalance[_chainId][l1Token] >= amount, "ShB not enough funds 2"); // not enought funds
440:             chainBalance[_chainId][l1Token] -= amount;
441:         }
442: 
443:         if (l1Token == ETH_TOKEN_ADDRESS) {
444:             bool callSuccess;
445:             // Low-level assembly call, to avoid any memory copying (save gas)
446:             assembly {
447:                 callSuccess := call(gas(), l1Receiver, amount, 0, 0, 0, 0)
448:             }
449:             require(callSuccess, "ShB: withdraw failed");
450:         } else {
451:             // Withdraw funds
452:             IERC20(l1Token).safeTransfer(l1Receiver, amount);
453:         }
454:         emit WithdrawalFinalizedSharedBridge(_chainId, l1Receiver, l1Token, amount);
455:     }

458:     function _checkWithdrawal( 
459:         uint256 _chainId,
460:         MessageParams memory _messageParams,
461:         bytes calldata _message,
462:         bytes32[] calldata _merkleProof
463:     ) internal view returns (address l1Receiver, address l1Token, uint256 amount) {
464:         (l1Receiver, l1Token, amount) = _parseL2WithdrawalMessage(_chainId, _message);
465:         L2Message memory l2ToL1Message;
466:         {
467:             bool baseTokenWithdrawal = (l1Token == bridgehub.baseToken(_chainId));
468:             address l2Sender = baseTokenWithdrawal ? L2_BASE_TOKEN_SYSTEM_CONTRACT_ADDR : l2BridgeAddress[_chainId];
469: 
470:             l2ToL1Message = L2Message({
471:                 txNumberInBatch: _messageParams.l2TxNumberInBatch,
472:                 sender: l2Sender,
473:                 data: _message
474:             });
475:         }
476: 
477:         bool success = bridgehub.proveL2MessageInclusion(
478:             _chainId,
479:             _messageParams.l2BatchNumber,
480:             _messageParams.l2MessageIndex,
481:             l2ToL1Message,
482:             _merkleProof
483:         );
484:         require(success, "ShB withd w proof"); // withdrawal wrong proof
485:     }

487:     function _parseL2WithdrawalMessage( 
488:         uint256 _chainId,
489:         bytes memory _l2ToL1message
490:     ) internal view returns (address l1Receiver, address l1Token, uint256 amount) {
491:         // We check that the message is long enough to read the data.
492:         // Please note that there are two versions of the message:
493:         // 1. The message that is sent by `withdraw(address _l1Receiver)`
494:         // It should be equal to the length of the bytes4 function signature + address l1Receiver + uint256 amount = 4 + 20 + 32 = 56 (bytes).
495:         // 2. The message that is sent by `withdrawWithMessage(address _l1Receiver, bytes calldata _additionalData)`
496:         // It should be equal to the length of the following:
497:         // bytes4 function signature + address l1Receiver + uint256 amount + address l2Sender + bytes _additionalData =
498:         // = 4 + 20 + 32 + 32 + _additionalData.length >= 68 (bytes).
499: 
500:         // So the data is expected to be at least 56 bytes long.
501:         require(_l2ToL1message.length >= 56, "ShB wrong msg len"); // wrong messsage length
502: 
503:         (uint32 functionSignature, uint256 offset) = UnsafeBytes.readUint32(_l2ToL1message, 0);
504:         if (bytes4(functionSignature) == IMailbox.finalizeEthWithdrawal.selector) {
505:             // this message is a base token withdrawal
506:             (l1Receiver, offset) = UnsafeBytes.readAddress(_l2ToL1message, offset);
507:             (amount, offset) = UnsafeBytes.readUint256(_l2ToL1message, offset);
508:             l1Token = bridgehub.baseToken(_chainId);
509:         } else if (bytes4(functionSignature) == IL1ERC20Bridge.finalizeWithdrawal.selector) {
510:             // We use the IL1ERC20Bridge for backward compatibility with old withdrawals.
511: 
512:             // this message is a token withdrawal
513: 
514:             // Check that the message length is correct.
515:             // It should be equal to the length of the function signature + address + address + uint256 = 4 + 20 + 20 + 32 =
516:             // 76 (bytes).
517:             require(_l2ToL1message.length == 76, "ShB wrong msg len 2");
518:             (l1Receiver, offset) = UnsafeBytes.readAddress(_l2ToL1message, offset);
519:             (l1Token, offset) = UnsafeBytes.readAddress(_l2ToL1message, offset);
520:             (amount, offset) = UnsafeBytes.readUint256(_l2ToL1message, offset);
521:         } else {
522:             revert("ShB Incorrect message function selector");
523:         }
524:     }

554:     function depositLegacyErc20Bridge( 
555:         address _prevMsgSender,
556:         address _l2Receiver,
557:         address _l1Token,
558:         uint256 _amount,
559:         uint256 _l2TxGasLimit,
560:         uint256 _l2TxGasPerPubdataByte,
561:         address _refundRecipient
562:     ) external payable override onlyLegacyBridge nonReentrant returns (bytes32 l2TxHash) {
563:         require(l2BridgeAddress[ERA_CHAIN_ID] != address(0), "ShB b. n dep");
564:         require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported 2");
565: 
566:         // Note that funds have been transferred to this contract in the legacy ERC20 bridge.
567:         if (!hyperbridgingEnabled[ERA_CHAIN_ID]) {
568:             chainBalance[ERA_CHAIN_ID][_l1Token] += _amount;
569:         }
570: 
571:         bytes memory l2TxCalldata = _getDepositL2Calldata(_prevMsgSender, _l2Receiver, _l1Token, _amount);
572: 
573:         {
574:             // If the refund recipient is not specified, the refund will be sent to the sender of the transaction.
575:             // Otherwise, the refund will be sent to the specified address.
576:             // If the recipient is a contract on L1, the address alias will be applied.
577:             address refundRecipient = _refundRecipient;
578:             if (_refundRecipient == address(0)) {
579:                 refundRecipient = _prevMsgSender != tx.origin
580:                     ? AddressAliasHelper.applyL1ToL2Alias(_prevMsgSender)
581:                     : _prevMsgSender;
582:             }
583: 
584:             L2TransactionRequestDirect memory request = L2TransactionRequestDirect({
585:                 chainId: ERA_CHAIN_ID,
586:                 l2Contract: l2BridgeAddress[ERA_CHAIN_ID],
587:                 mintValue: msg.value, // l2 gas + l2 msg.Value the bridgehub will withdraw the mintValue from the base token bridge for gas
588:                 l2Value: 0, // L2 msg.value, this contract doesn't support base token deposits or wrapping functionality, for direct deposits use bridgehub
589:                 l2Calldata: l2TxCalldata,
590:                 l2GasLimit: _l2TxGasLimit,
591:                 l2GasPerPubdataByteLimit: _l2TxGasPerPubdataByte,
592:                 factoryDeps: new bytes[](0),
593:                 refundRecipient: refundRecipient
594:             });
595:             l2TxHash = bridgehub.requestL2TransactionDirect{value: msg.value}(request);
596:         }
597: 
598:         bytes32 txDataHash = keccak256(abi.encode(_prevMsgSender, _l1Token, _amount));
599:         // Save the deposited amount to claim funds on L1 if the deposit failed on L2
600:         depositHappened[ERA_CHAIN_ID][l2TxHash] = txDataHash;
601: 
602:         emit LegacyDepositInitiated(ERA_CHAIN_ID, l2TxHash, _prevMsgSender, _l2Receiver, _l1Token, _amount);
603:     }

615:     function finalizeWithdrawalLegacyErc20Bridge( 
616:         uint256 _l2BatchNumber,
617:         uint256 _l2MessageIndex,
618:         uint16 _l2TxNumberInBatch,
619:         bytes calldata _message,
620:         bytes32[] calldata _merkleProof
621:     ) external override onlyLegacyBridge returns (address l1Receiver, address l1Token, uint256 amount) {
622:         (l1Receiver, l1Token, amount) = _finalizeWithdrawal(
623:             ERA_CHAIN_ID,
624:             _l2BatchNumber,
625:             _l2MessageIndex,
626:             _l2TxNumberInBatch,
627:             _message,
628:             _merkleProof
629:         );
630:     }
```
[173](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L173), [182](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L182-L228), [243](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L243), [254](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L254), [374](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L374), [409](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L409-L455), [458](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L458-L485), [487](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L487-L524), [554](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L554-L603), [615](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L615-L630)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol

/// @audit Parameter of type 'bool' at index '0'
24:     function isWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool); 

26:     function deposit( 
27:         address _l2Receiver,
28:         address _l1Token,
29:         uint256 _amount,
30:         uint256 _l2TxGasLimit,
31:         uint256 _l2TxGasPerPubdataByte,
32:         address _refundRecipient
33:     ) external payable returns (bytes32 txHash);

35:     function deposit( 
36:         address _l2Receiver,
37:         address _l1Token,
38:         uint256 _amount,
39:         uint256 _l2TxGasLimit,
40:         uint256 _l2TxGasPerPubdataByte
41:     ) external payable returns (bytes32 txHash);

/// @audit Parameter of type 'address' at index '0'
61:     function l2TokenAddress(address _l1Token) external view returns (address); 

/// @audit Parameter of type 'contract IL1SharedBridge' at index '0'
63:     function sharedBridge() external view returns (IL1SharedBridge); 

/// @audit Parameter of type 'address' at index '0'
65:     function l2TokenBeacon() external view returns (address); 

/// @audit Parameter of type 'address' at index '0'
67:     function l2Bridge() external view returns (address); 

69:     function depositAmount( 
70:         address _account,
71:         address _l1Token,
72:         bytes32 _depositL2TxHash
73:     ) external returns (uint256 amount);
```
[24](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L24), [26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L26-L33), [35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L35-L41), [61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L61), [63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L63), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L65), [67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L67), [69](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L69-L73)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol

58:     function isWithdrawalFinalized( 

64:     function depositLegacyErc20Bridge( 
65:         address _msgSender,
66:         address _l2Receiver,
67:         address _l1Token,
68:         uint256 _amount,
69:         uint256 _l2TxGasLimit,
70:         uint256 _l2TxGasPerPubdataByte,
71:         address _refundRecipient
72:     ) external payable returns (bytes32 txHash);

97:     function finalizeWithdrawalLegacyErc20Bridge( 
98:         uint256 _l2BatchNumber,
99:         uint256 _l2MessageIndex,
100:         uint16 _l2TxNumberInBatch,
101:         bytes calldata _message,
102:         bytes32[] calldata _merkleProof
103:     ) external returns (address l1Receiver, address l1Token, uint256 amount);

/// @audit Parameter of type 'address' at index '0'
114:     function l1WethAddress() external view returns (address); 

/// @audit Parameter of type 'contract IBridgehub' at index '0'
116:     function bridgehub() external view returns (IBridgehub); 

/// @audit Parameter of type 'contract IL1ERC20Bridge' at index '0'
118:     function legacyBridge() external view returns (IL1ERC20Bridge); 

/// @audit Parameter of type 'address' at index '0'
120:     function l2BridgeAddress(uint256 _chainId) external view returns (address); 

/// @audit Parameter of type 'bytes32' at index '0'
122:     function depositHappened(uint256 _chainId, bytes32 _l2TxHash) external view returns (bytes32); 

128:     function bridgehubDeposit( 
129:         uint256 _chainId,
130:         address _prevMsgSender,
131:         uint256 _l2Value,
132:         bytes calldata _data
133:     ) external payable returns (L2TransactionRequestTwoBridgesInner memory request);
```
[58](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L58), [64](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L64-L72), [97](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L97-L103), [114](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L114), [116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L116), [118](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L118), [120](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L120), [122](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L122), [128](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L128-L133)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol

/// @audit Parameter of type 'address' at index '0'
17:     function l1TokenAddress(address _l2Token) external view returns (address); 

/// @audit Parameter of type 'address' at index '0'
19:     function l2TokenAddress(address _l1Token) external view returns (address); 

/// @audit Parameter of type 'address' at index '0'
21:     function l1Bridge() external view returns (address); 
```
[17](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L17), [19](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L19), [21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L21)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

/// @audit Parameter of type 'address' at index '0'
75:     function getStateTransition(uint256 _chainId) public view returns (address) { 

114:     function createNewChain( 
115:         uint256 _chainId,
116:         address _stateTransitionManager,
117:         address _baseToken,
118:         uint256, //_salt
119:         address _admin,
120:         bytes calldata _initData
121:     ) external onlyOwnerOrAdmin nonReentrant returns (uint256 chainId) {
122:         require(_chainId != 0, "Bridgehub: chainId cannot be 0");
123:         require(_chainId <= type(uint48).max, "Bridgehub: chainId too large");
124: 
125:         require(
126:             stateTransitionManagerIsRegistered[_stateTransitionManager],
127:             "Bridgehub: state transition not registered"
128:         );
129:         require(tokenIsRegistered[_baseToken], "Bridgehub: token not registered");
130:         require(address(sharedBridge) != address(0), "Bridgehub: weth bridge not set");
131: 
132:         require(stateTransitionManager[_chainId] == address(0), "Bridgehub: chainId already registered");
133: 
134:         stateTransitionManager[_chainId] = _stateTransitionManager;
135:         baseToken[_chainId] = _baseToken;
136: 
137:         IStateTransitionManager(_stateTransitionManager).createNewChain(
138:             _chainId,
139:             _baseToken,
140:             address(sharedBridge),
141:             _admin,
142:             _initData
143:         );
144: 
145:         emit NewChain(_chainId, _stateTransitionManager, _admin);
146:         return _chainId;
147:     }

152:     function proveL2MessageInclusion( 

164:     function proveL2LogInclusion( 

176:     function proveL1ToL2TransactionStatus( 

198:     function l2TransactionBaseCost( 

217:     function requestL2TransactionDirect( 
218:         L2TransactionRequestDirect calldata _request
219:     ) external payable override nonReentrant returns (bytes32 canonicalTxHash) {
220:         {
221:             address token = baseToken[_request.chainId];
222:             if (token == ETH_TOKEN_ADDRESS) {
223:                 require(msg.value == _request.mintValue, "Bridgehub: msg.value mismatch 1");
224:             } else {
225:                 require(msg.value == 0, "Bridgehub: non-eth bridge with msg.value");
226:             }
227: 
228:             sharedBridge.bridgehubDepositBaseToken{value: msg.value}(
229:                 _request.chainId,
230:                 msg.sender,
231:                 token,
232:                 _request.mintValue
233:             );
234:         }
235: 
236:         address stateTransition = getStateTransition(_request.chainId);
237:         address refundRecipient = _actualRefundRecipient(_request.refundRecipient);
238:         canonicalTxHash = IZkSyncStateTransition(stateTransition).bridgehubRequestL2Transaction(
239:             BridgehubL2TransactionRequest({
240:                 sender: msg.sender,
241:                 contractL2: _request.l2Contract,
242:                 mintValue: _request.mintValue,
243:                 l2Value: _request.l2Value,
244:                 l2Calldata: _request.l2Calldata,
245:                 l2GasLimit: _request.l2GasLimit,
246:                 l2GasPerPubdataByteLimit: _request.l2GasPerPubdataByteLimit,
247:                 factoryDeps: _request.factoryDeps,
248:                 refundRecipient: refundRecipient
249:             })
250:         );
251:     }

262:     function requestL2TransactionTwoBridges( 
263:         L2TransactionRequestTwoBridgesOuter calldata _request
264:     ) external payable override nonReentrant returns (bytes32 canonicalTxHash) {
265:         {
266:             address token = baseToken[_request.chainId];
267:             uint256 baseTokenMsgValue;
268:             if (token == ETH_TOKEN_ADDRESS) {
269:                 require(
270:                     msg.value == _request.mintValue + _request.secondBridgeValue,
271:                     "Bridgehub: msg.value mismatch 2"
272:                 );
273:                 baseTokenMsgValue = _request.mintValue;
274:             } else {
275:                 require(msg.value == _request.secondBridgeValue, "Bridgehub: msg.value mismatch 3");
276:                 baseTokenMsgValue = 0;
277:             }
278:             sharedBridge.bridgehubDepositBaseToken{value: baseTokenMsgValue}(
279:                 _request.chainId,
280:                 msg.sender,
281:                 token,
282:                 _request.mintValue
283:             );
284:         }
285: 
286:         address stateTransition = getStateTransition(_request.chainId);
287: 
288:         L2TransactionRequestTwoBridgesInner memory outputRequest = IL1SharedBridge(_request.secondBridgeAddress)
289:             .bridgehubDeposit{value: _request.secondBridgeValue}(
290:             _request.chainId,
291:             msg.sender,
292:             _request.l2Value,
293:             _request.secondBridgeCalldata
294:         );
295: 
296:         require(outputRequest.magicValue == TWO_BRIDGES_MAGIC_VALUE, "Bridgehub: magic value mismatch");
297: 
298:         address refundRecipient = _actualRefundRecipient(_request.refundRecipient);
299: 
300:         require(
301:             _request.secondBridgeAddress > BRIDGEHUB_MIN_SECOND_BRIDGE_ADDRESS,
302:             "Bridgehub: second bridge address too low"
303:         ); // to avoid calls to precompiles
304:         canonicalTxHash = IZkSyncStateTransition(stateTransition).bridgehubRequestL2Transaction(
305:             BridgehubL2TransactionRequest({
306:                 sender: _request.secondBridgeAddress,
307:                 contractL2: outputRequest.l2Contract,
308:                 mintValue: _request.mintValue,
309:                 l2Value: _request.l2Value,
310:                 l2Calldata: outputRequest.l2Calldata,
311:                 l2GasLimit: _request.l2GasLimit,
312:                 l2GasPerPubdataByteLimit: _request.l2GasPerPubdataByteLimit,
313:                 factoryDeps: outputRequest.factoryDeps,
314:                 refundRecipient: refundRecipient
315:             })
316:         );
317: 
318:         IL1SharedBridge(_request.secondBridgeAddress).bridgehubConfirmL2Transaction(
319:             _request.chainId,
320:             outputRequest.txDataHash,
321:             canonicalTxHash
322:         );
323:     }

325:     function _actualRefundRecipient(address _refundRecipient) internal view returns (address _recipient) { 
326:         if (_refundRecipient == address(0)) {
327:             // If the `_refundRecipient` is not provided, we use the `msg.sender` as the recipient.
328:             _recipient = msg.sender == tx.origin ? msg.sender : AddressAliasHelper.applyL1ToL2Alias(msg.sender);
329:         } else if (_refundRecipient.code.length > 0) {
330:             // If the `_refundRecipient` is a smart contract, we apply the L1 to L2 alias to prevent foot guns.
331:             _recipient = AddressAliasHelper.applyL1ToL2Alias(_refundRecipient);
332:         } else {
333:             _recipient = _refundRecipient;
334:         }
335:     }
```
[75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L75), [114](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L114-L147), [152](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L152), [164](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L164), [176](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L176), [198](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L198), [217](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L217-L251), [262](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L262-L323), [325](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L325-L335)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol

/// @audit Parameter of type 'bool' at index '0'
59:     function stateTransitionManagerIsRegistered(address _stateTransitionManager) external view returns (bool); 

/// @audit Parameter of type 'address' at index '0'
61:     function stateTransitionManager(uint256 _chainId) external view returns (address); 

/// @audit Parameter of type 'bool' at index '0'
63:     function tokenIsRegistered(address _baseToken) external view returns (bool); 

/// @audit Parameter of type 'address' at index '0'
65:     function baseToken(uint256 _chainId) external view returns (address); 

/// @audit Parameter of type 'contract IL1SharedBridge' at index '0'
67:     function sharedBridge() external view returns (IL1SharedBridge); 

/// @audit Parameter of type 'address' at index '0'
69:     function getStateTransition(uint256 _chainId) external view returns (address); 

73:     function proveL2MessageInclusion( 

81:     function proveL2LogInclusion( 

89:     function proveL1ToL2TransactionStatus( 

99:     function requestL2TransactionDirect( 
100:         L2TransactionRequestDirect calldata _request
101:     ) external payable returns (bytes32 canonicalTxHash);

103:     function requestL2TransactionTwoBridges( 
104:         L2TransactionRequestTwoBridgesOuter calldata _request
105:     ) external payable returns (bytes32 canonicalTxHash);

107:     function l2TransactionBaseCost( 

116:     function createNewChain( 
117:         uint256 _chainId,
118:         address _stateTransitionManager,
119:         address _baseToken,
120:         uint256 _salt,
121:         address _admin,
122:         bytes calldata _initData
123:     ) external returns (uint256 chainId);
```
[59](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L59), [61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L61), [63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L63), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L65), [67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L67), [69](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L69), [73](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L73), [81](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L81), [89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L89), [99](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L99-L101), [103](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L103-L105), [107](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L107), [116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L116-L123)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol

21:     function hashL2Bytecode(bytes memory _bytecode) internal pure returns (bytes32 hashedBytecode) { 
22:         // Note that the length of the bytecode must be provided in 32-byte words.
23:         require(_bytecode.length % 32 == 0, "pq");
24: 
25:         uint256 bytecodeLenInWords = _bytecode.length / 32;
26:         require(bytecodeLenInWords < 2 ** 16, "pp"); // bytecode length must be less than 2^16 words
27:         require(bytecodeLenInWords % 2 == 1, "ps"); // bytecode length in words must be odd
28:         hashedBytecode = sha256(_bytecode) & 0x00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;
29:         // Setting the version of the hash
30:         hashedBytecode = (hashedBytecode | bytes32(uint256(1 << 248)));
31:         // Setting the length
32:         hashedBytecode = hashedBytecode | bytes32(bytecodeLenInWords << 224);
33:     }

49:     function bytecodeLen(bytes32 _bytecodeHash) internal pure returns (uint256 codeLengthInWords) { 
50:         codeLengthInWords = uint256(uint8(_bytecodeHash[2])) * 256 + uint256(uint8(_bytecodeHash[3]));
51:     }

60:     function computeCreate2Address( 
```
[21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L21-L33), [49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L49-L51), [60](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L60)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/UncheckedMath.sol

/// @audit Parameter of type 'uint256' at index '0'
11:     function uncheckedInc(uint256 _number) internal pure returns (uint256) { 

/// @audit Parameter of type 'uint256' at index '0'
17:     function uncheckedAdd(uint256 _lhs, uint256 _rhs) internal pure returns (uint256) { 
```
[11](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UncheckedMath.sol#L11), [17](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UncheckedMath.sol#L17)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol

19:     function readUint32(bytes memory _bytes, uint256 _start) internal pure returns (uint32 result, uint256 offset) { 
20:         assembly {
21:             offset := add(_start, 4)
22:             result := mload(add(_bytes, offset))
23:         }
24:     }

26:     function readAddress(bytes memory _bytes, uint256 _start) internal pure returns (address result, uint256 offset) { 
27:         assembly {
28:             offset := add(_start, 20)
29:             result := mload(add(_bytes, offset))
30:         }
31:     }

33:     function readUint256(bytes memory _bytes, uint256 _start) internal pure returns (uint256 result, uint256 offset) { 
34:         assembly {
35:             offset := add(_start, 32)
36:             result := mload(add(_bytes, offset))
37:         }
38:     }

40:     function readBytes32(bytes memory _bytes, uint256 _start) internal pure returns (bytes32 result, uint256 offset) { 
41:         assembly {
42:             offset := add(_start, 32)
43:             result := mload(add(_bytes, offset))
44:         }
45:     }
```
[19](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L19-L24), [26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L26-L31), [33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L33-L38), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L40-L45)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

/// @audit Parameter of type 'bool' at index '0'
84:     function isOperation(bytes32 _id) public view returns (bool) { 

/// @audit Parameter of type 'bool' at index '0'
89:     function isOperationPending(bytes32 _id) public view returns (bool) { 

/// @audit Parameter of type 'bool' at index '0'
95:     function isOperationReady(bytes32 _id) public view returns (bool) { 

/// @audit Parameter of type 'bool' at index '0'
100:     function isOperationDone(bytes32 _id) public view returns (bool) { 

/// @audit Parameter of type 'enum IGovernance.OperationState' at index '0'
105:     function getOperationState(bytes32 _id) public view returns (OperationState) { 

/// @audit Parameter of type 'bytes32' at index '0'
204:     function hashOperation(Operation calldata _operation) public pure returns (bytes32) { 
```
[84](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L84), [89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L89), [95](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L95), [100](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L100), [105](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L105), [204](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L204)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/IGovernance.sol

/// @audit Parameter of type 'bool' at index '0'
41:     function isOperation(bytes32 _id) external view returns (bool); 

/// @audit Parameter of type 'bool' at index '0'
43:     function isOperationPending(bytes32 _id) external view returns (bool); 

/// @audit Parameter of type 'bool' at index '0'
45:     function isOperationReady(bytes32 _id) external view returns (bool); 

/// @audit Parameter of type 'bool' at index '0'
47:     function isOperationDone(bytes32 _id) external view returns (bool); 

/// @audit Parameter of type 'enum IGovernance.OperationState' at index '0'
49:     function getOperationState(bytes32 _id) external view returns (OperationState); 

/// @audit Parameter of type 'bytes32' at index '0'
61:     function hashOperation(Operation calldata _operation) external pure returns (bytes32); 
```
[41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L41), [43](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L43), [45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L45), [47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L47), [49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L49), [61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L61)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol

/// @audit Parameter of type 'address' at index '0'
43:     function bridgehub() external view returns (address); 

/// @audit Parameter of type 'address' at index '0'
53:     function stateTransition(uint256 _chainId) external view returns (address); 

/// @audit Parameter of type 'bytes32' at index '0'
55:     function storedBatchZero() external view returns (bytes32); 

/// @audit Parameter of type 'bytes32' at index '0'
57:     function initialCutHash() external view returns (bytes32); 

/// @audit Parameter of type 'address' at index '0'
59:     function genesisUpgrade() external view returns (address); 

/// @audit Parameter of type 'bytes32' at index '0'
61:     function upgradeCutHash(uint256 _protocolVersion) external view returns (bytes32); 

/// @audit Parameter of type 'uint256' at index '0'
63:     function protocolVersion() external view returns (uint256); 

/// @audit Parameter of type 'address' at index '0'
71:     function getChainAdmin(uint256 _chainId) external view returns (address); 
```
[43](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L43), [53](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L53), [55](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L55), [57](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L57), [59](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L59), [61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L61), [63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L63), [71](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L71)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

/// @audit Parameter of type 'address' at index '0'
74:     function getChainAdmin(uint256 _chainId) external view override returns (address) { 
```
[74](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L74)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

/// @audit Parameter of type 'uint256' at index '0'
102:     function getCommittedBatchTimestamp(uint256 _chainId, uint256 _l2BatchNumber) external view returns (uint256) { 
```
[102](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L102)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol

/// @audit Parameter of type 'bytes32' at index '0'
24:     function initialize(InitializeData calldata _initializeData) external reentrancyGuardInitializer returns (bytes32) { 
```
[24](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L24)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

32:     function _commitOneBatch( 

130:     function _processL2Logs( 
131:         CommitBatchInfo calldata _newBatch,
132:         bytes32 _expectedSystemContractUpgradeTxHash
133:     ) internal pure returns (LogProcessingOutput memory logOutput) {
134:         // Copy L2 to L1 logs into memory.
135:         bytes memory emittedL2Logs = _newBatch.systemLogs;
136: 
137:         // Used as bitmap to set/check log processing happens exactly once.
138:         // See SystemLogKey enum in Constants.sol for ordering.
139:         uint256 processedLogs;
140: 
141:         // linear traversal of the logs
142:         for (uint256 i = 0; i < emittedL2Logs.length; i = i.uncheckedAdd(L2_TO_L1_LOG_SERIALIZE_SIZE)) {
143:             // Extract the values to be compared to/used such as the log sender, key, and value
144:             (address logSender, ) = UnsafeBytes.readAddress(emittedL2Logs, i + L2_LOG_ADDRESS_OFFSET);
145:             (uint256 logKey, ) = UnsafeBytes.readUint256(emittedL2Logs, i + L2_LOG_KEY_OFFSET);
146:             (bytes32 logValue, ) = UnsafeBytes.readBytes32(emittedL2Logs, i + L2_LOG_VALUE_OFFSET);
147: 
148:             // Ensure that the log hasn't been processed already
149:             require(!_checkBit(processedLogs, uint8(logKey)), "kp");
150:             processedLogs = _setBit(processedLogs, uint8(logKey));
151: 
152:             // Need to check that each log was sent by the correct address.
153:             if (logKey == uint256(SystemLogKey.L2_TO_L1_LOGS_TREE_ROOT_KEY)) {
154:                 require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "lm");
155:                 logOutput.l2LogsTreeRoot = logValue;
156:             } else if (logKey == uint256(SystemLogKey.TOTAL_L2_TO_L1_PUBDATA_KEY)) {
157:                 require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "ln");
158:                 logOutput.pubdataHash = logValue;
159:             } else if (logKey == uint256(SystemLogKey.STATE_DIFF_HASH_KEY)) {
160:                 require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "lb");
161:                 logOutput.stateDiffHash = logValue;
162:             } else if (logKey == uint256(SystemLogKey.PACKED_BATCH_AND_L2_BLOCK_TIMESTAMP_KEY)) {
163:                 require(logSender == L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR, "sc");
164:                 logOutput.packedBatchAndL2BlockTimestamp = uint256(logValue);
165:             } else if (logKey == uint256(SystemLogKey.PREV_BATCH_HASH_KEY)) {
166:                 require(logSender == L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR, "sv");
167:                 logOutput.previousBatchHash = logValue;
168:             } else if (logKey == uint256(SystemLogKey.CHAINED_PRIORITY_TXN_HASH_KEY)) {
169:                 require(logSender == L2_BOOTLOADER_ADDRESS, "bl");
170:                 logOutput.chainedPriorityTxsHash = logValue;
171:             } else if (logKey == uint256(SystemLogKey.NUMBER_OF_LAYER_1_TXS_KEY)) {
172:                 require(logSender == L2_BOOTLOADER_ADDRESS, "bk");
173:                 logOutput.numberOfLayer1Txs = uint256(logValue);
174:             } else if (logKey == uint256(SystemLogKey.BLOB_ONE_HASH_KEY)) {
175:                 require(logSender == L2_PUBDATA_CHUNK_PUBLISHER_ADDR, "pc");
176:                 logOutput.blob1Hash = logValue;
177:             } else if (logKey == uint256(SystemLogKey.BLOB_TWO_HASH_KEY)) {
178:                 require(logSender == L2_PUBDATA_CHUNK_PUBLISHER_ADDR, "pd");
179:                 logOutput.blob2Hash = logValue;
180:             } else if (logKey == uint256(SystemLogKey.EXPECTED_SYSTEM_CONTRACT_UPGRADE_TX_HASH_KEY)) {
181:                 require(logSender == L2_BOOTLOADER_ADDRESS, "bu");
182:                 require(_expectedSystemContractUpgradeTxHash == logValue, "ut");
183:             } else {
184:                 revert("ul");
185:             }
186:         }
187: 
188:         // We only require 9 logs to be checked, the 10th is if we are expecting a protocol upgrade
189:         // Without the protocol upgrade we expect 9 logs: 2^9 - 1 = 511
190:         // With the protocol upgrade we expect 8 logs: 2^10 - 1 = 1023
191:         if (_expectedSystemContractUpgradeTxHash == bytes32(0)) {
192:             require(processedLogs == 511, "b7");
193:         } else {
194:             require(processedLogs == 1023, "b8");
195:         }
196:     }

308:     function _collectOperationsFromPriorityQueue(uint256 _nPriorityOps) internal returns (bytes32 concatHash) { 
309:         concatHash = EMPTY_STRING_KECCAK;
310: 
311:         for (uint256 i = 0; i < _nPriorityOps; i = i.uncheckedInc()) {
312:             PriorityOperation memory priorityOp = s.priorityQueue.popFront();
313:             concatHash = keccak256(abi.encode(concatHash, priorityOp.canonicalTxHash));
314:         }
315:     }

453:     function _getBatchProofPublicInput( 

500:     function _createBatchCommitment( 

/// @audit Parameter of type 'bytes' at index '0'
515:     function _batchPassThroughData(CommitBatchInfo calldata _batch) internal pure returns (bytes memory) { 

/// @audit Parameter of type 'bytes' at index '0'
525:     function _batchMetaParameters() internal view returns (bytes memory) { 

537:     function _batchAuxiliaryOutput( 

561:     function _encodeBlobAuxilaryOutput( 
562:         bytes32[] memory _blobCommitments,
563:         bytes32[] memory _blobHashes
564:     ) internal pure returns (bytes32[] memory blobAuxOutputWords) {
565:         // These invariants should be checked by the caller of this function, but we double check
566:         // just in case.
567:         require(_blobCommitments.length == MAX_NUMBER_OF_BLOBS, "b10");
568:         require(_blobHashes.length == MAX_NUMBER_OF_BLOBS, "b11");
569: 
570:         // for each blob we have:
571:         // linear hash (hash of preimage from system logs) and
572:         // output hash of blob commitments: keccak(versioned hash || opening point || evaluation value)
573:         // These values will all be bytes32(0) when we submit pubdata via calldata instead of blobs.
574:         //
575:         // For now, only up to 2 blobs are supported by the contract, while 16 are required by the circuits.
576:         // All the unfilled blobs will have their commitment as 0, including the case when we use only 1 blob.
577: 
578:         blobAuxOutputWords = new bytes32[](2 * TOTAL_BLOBS_IN_COMMITMENT);
579: 
580:         for (uint i = 0; i < MAX_NUMBER_OF_BLOBS; i++) {
581:             blobAuxOutputWords[i * 2] = _blobHashes[i];
582:             blobAuxOutputWords[i * 2 + 1] = _blobCommitments[i];
583:         }
584:     }

/// @audit Parameter of type 'bytes32' at index '0'
587:     function _hashStoredBatchInfo(StoredBatchInfo memory _storedBatchInfo) internal pure returns (bytes32) { 

/// @audit Parameter of type 'bool' at index '0'
592:     function _checkBit(uint256 _bitMap, uint8 _index) internal pure returns (bool) { 

/// @audit Parameter of type 'uint256' at index '0'
597:     function _setBit(uint256 _bitMap, uint8 _index) internal pure returns (uint256) { 

625:     function _verifyBlobInformation( 
626:         bytes calldata _pubdataCommitments,
627:         bytes32[] memory _blobHashes
628:     ) internal view returns (bytes32[] memory blobCommitments) {
629:         uint256 versionedHashIndex = 0;
630: 
631:         require(_pubdataCommitments.length > 0, "pl");
632:         require(_pubdataCommitments.length <= PUBDATA_COMMITMENT_SIZE * MAX_NUMBER_OF_BLOBS, "bd");
633:         require(_pubdataCommitments.length % PUBDATA_COMMITMENT_SIZE == 0, "bs");
634:         blobCommitments = new bytes32[](MAX_NUMBER_OF_BLOBS);
635: 
636:         for (uint256 i = 0; i < _pubdataCommitments.length; i += PUBDATA_COMMITMENT_SIZE) {
637:             bytes32 blobVersionedHash = _getBlobVersionedHash(versionedHashIndex);
638: 
639:             require(blobVersionedHash != bytes32(0), "vh");
640: 
641:             // First 16 bytes is the opening point. While we get the point as 16 bytes, the point evaluation precompile
642:             // requires it to be 32 bytes. The blob commitment must use the opening point as 16 bytes though.
643:             bytes32 openingPoint = bytes32(
644:                 uint256(uint128(bytes16(_pubdataCommitments[i:i + PUBDATA_COMMITMENT_CLAIMED_VALUE_OFFSET])))
645:             );
646: 
647:             _pointEvaluationPrecompile(
648:                 blobVersionedHash,
649:                 openingPoint,
650:                 _pubdataCommitments[i + PUBDATA_COMMITMENT_CLAIMED_VALUE_OFFSET:i + PUBDATA_COMMITMENT_SIZE]
651:             );
652: 
653:             // Take the hash of the versioned hash || opening point || claimed value
654:             blobCommitments[versionedHashIndex] = keccak256(
655:                 abi.encodePacked(blobVersionedHash, _pubdataCommitments[i:i + PUBDATA_COMMITMENT_COMMITMENT_OFFSET])
656:             );
657:             versionedHashIndex += 1;
658:         }
659: 
660:         // This check is required because we want to ensure that there aren't any extra blobs trying to be published.
661:         // Calling the BLOBHASH opcode with an index > # blobs - 1 yields bytes32(0)
662:         bytes32 versionedHash = _getBlobVersionedHash(versionedHashIndex);
663:         require(versionedHash == bytes32(0), "lh");
664: 
665:         // We verify that for each set of blobHash/blobCommitment are either both empty
666:         // or there are values for both.
667:         for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) {
668:             require(
669:                 (_blobHashes[i] == bytes32(0) && blobCommitments[i] == bytes32(0)) ||
670:                     (_blobHashes[i] != bytes32(0) && blobCommitments[i] != bytes32(0)),
671:                 "bh"
672:             );
673:         }
674:     }

679:     function _getBlobVersionedHash(uint256 _index) internal view returns (bytes32 versionedHash) { 
680:         (bool success, bytes memory data) = s.blobVersionedHashRetriever.staticcall(abi.encode(_index));
681:         require(success, "vc");
682:         versionedHash = abi.decode(data, (bytes32));
683:     }
```
[32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L32), [130](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L130-L196), [308](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L308-L315), [453](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L453), [500](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L500), [515](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L515), [525](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L525), [537](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L537), [561](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L561-L584), [587](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L587), [592](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L592), [597](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L597), [625](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L625-L674), [679](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L679-L683)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

/// @audit Parameter of type 'address' at index '0'
32:     function getVerifier() external view returns (address) { 

/// @audit Parameter of type 'address' at index '0'
37:     function getAdmin() external view returns (address) { 

/// @audit Parameter of type 'address' at index '0'
42:     function getPendingAdmin() external view returns (address) { 

/// @audit Parameter of type 'address' at index '0'
47:     function getBridgehub() external view returns (address) { 

/// @audit Parameter of type 'address' at index '0'
52:     function getStateTransitionManager() external view returns (address) { 

/// @audit Parameter of type 'address' at index '0'
57:     function getBaseToken() external view returns (address) { 

/// @audit Parameter of type 'address' at index '0'
62:     function getBaseTokenBridge() external view returns (address) { 

/// @audit Parameter of type 'uint128' at index '0'
67:     function baseTokenGasPriceMultiplierNominator() external view returns (uint128) { 

/// @audit Parameter of type 'uint128' at index '0'
72:     function baseTokenGasPriceMultiplierDenominator() external view returns (uint128) { 

/// @audit Parameter of type 'uint256' at index '0'
77:     function getTotalBatchesCommitted() external view returns (uint256) { 

/// @audit Parameter of type 'uint256' at index '0'
82:     function getTotalBatchesVerified() external view returns (uint256) { 

/// @audit Parameter of type 'uint256' at index '0'
87:     function getTotalBatchesExecuted() external view returns (uint256) { 

/// @audit Parameter of type 'uint256' at index '0'
92:     function getTotalPriorityTxs() external view returns (uint256) { 

/// @audit Parameter of type 'uint256' at index '0'
97:     function getFirstUnprocessedPriorityTx() external view returns (uint256) { 

/// @audit Parameter of type 'uint256' at index '0'
102:     function getPriorityQueueSize() external view returns (uint256) { 

/// @audit Parameter of type 'struct PriorityOperation' at index '0'
107:     function priorityQueueFrontOperation() external view returns (PriorityOperation memory) { 

/// @audit Parameter of type 'bool' at index '0'
112:     function isValidator(address _address) external view returns (bool) { 

/// @audit Parameter of type 'bytes32' at index '0'
117:     function l2LogsRootHash(uint256 _batchNumber) external view returns (bytes32) { 

/// @audit Parameter of type 'bytes32' at index '0'
122:     function storedBatchHash(uint256 _batchNumber) external view returns (bytes32) { 

/// @audit Parameter of type 'bytes32' at index '0'
127:     function getL2BootloaderBytecodeHash() external view returns (bytes32) { 

/// @audit Parameter of type 'bytes32' at index '0'
132:     function getL2DefaultAccountBytecodeHash() external view returns (bytes32) { 

/// @audit Parameter of type 'struct VerifierParams' at index '0'
137:     function getVerifierParams() external view returns (VerifierParams memory) { 

/// @audit Parameter of type 'uint256' at index '0'
142:     function getProtocolVersion() external view returns (uint256) { 

/// @audit Parameter of type 'bytes32' at index '0'
147:     function getL2SystemContractsUpgradeTxHash() external view returns (bytes32) { 

/// @audit Parameter of type 'uint256' at index '0'
152:     function getL2SystemContractsUpgradeBatchNumber() external view returns (uint256) { 

/// @audit Parameter of type 'bool' at index '0'
157:     function isDiamondStorageFrozen() external view returns (bool) { 

163:     function isFacetFreezable(address _facet) external view returns (bool isFreezable) { 
164:         Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();
165: 
166:         // There is no direct way to get whether the facet address is freezable,
167:         // so we get it from one of the selectors that are associated with the facet.
168:         uint256 selectorsArrayLen = ds.facetToSelectors[_facet].selectors.length;
169:         if (selectorsArrayLen != 0) {
170:             bytes4 selector0 = ds.facetToSelectors[_facet].selectors[0];
171:             isFreezable = ds.selectorToFacet[selector0].isFreezable;
172:         }
173:     }

/// @audit Parameter of type 'uint256' at index '0'
176:     function getPriorityTxMaxGasLimit() external view returns (uint256) { 

/// @audit Parameter of type 'bool' at index '0'
181:     function isFunctionFreezable(bytes4 _selector) external view returns (bool) { 

/// @audit Parameter of type 'bool' at index '0'
188:     function isEthWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool) { 

/// @audit Parameter of type 'enum PubdataPricingMode' at index '0'
193:     function getPubdataPricingMode() external view returns (PubdataPricingMode) { 

202:     function facets() external view returns (Facet[] memory result) { 
203:         Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage();
204: 
205:         uint256 facetsLen = ds.facets.length;
206:         result = new Facet[](facetsLen);
207: 
208:         for (uint256 i = 0; i < facetsLen; i = i.uncheckedInc()) {
209:             address facetAddr = ds.facets[i];
210:             Diamond.FacetToSelectors memory facetToSelectors = ds.facetToSelectors[facetAddr];
211: 
212:             result[i] = Facet(facetAddr, facetToSelectors.selectors);
213:         }
214:     }

/// @audit Parameter of type 'bytes4[]' at index '0'
217:     function facetFunctionSelectors(address _facet) external view returns (bytes4[] memory) { 

/// @audit Parameter of type 'address[]' at index '0'
223:     function facetAddresses() external view returns (address[] memory) { 

/// @audit Parameter of type 'address' at index '0'
229:     function facetAddress(bytes4 _selector) external view returns (address) { 

/// @audit Parameter of type 'uint256' at index '0'
239:     function getTotalBlocksCommitted() external view returns (uint256) { 

/// @audit Parameter of type 'uint256' at index '0'
244:     function getTotalBlocksVerified() external view returns (uint256) { 

/// @audit Parameter of type 'uint256' at index '0'
249:     function getTotalBlocksExecuted() external view returns (uint256) { 

/// @audit Parameter of type 'bytes32' at index '0'
254:     function storedBlockHash(uint256 _batchNumber) external view returns (bytes32) { 

/// @audit Parameter of type 'uint256' at index '0'
259:     function getL2SystemContractsUpgradeBlockNumber() external view returns (uint256) { 
```
[32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L32), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L37), [42](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L42), [47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L47), [52](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L52), [57](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L57), [62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L62), [67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L67), [72](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L72), [77](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L77), [82](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L82), [87](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L87), [92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L92), [97](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L97), [102](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L102), [107](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L107), [112](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L112), [117](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L117), [122](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L122), [127](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L127), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L132), [137](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L137), [142](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L142), [147](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L147), [152](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L152), [157](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L157), [163](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L163-L173), [176](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L176), [181](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L181), [188](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L188), [193](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L193), [202](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L202-L214), [217](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L217), [223](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L223), [229](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L229), [239](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L239), [244](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L244), [249](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L249), [254](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L254), [259](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L259)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

47:     function bridgehubRequestL2Transaction( 
48:         BridgehubL2TransactionRequest memory _request
49:     ) external payable onlyBridgehub returns (bytes32 canonicalTxHash) {
50:         canonicalTxHash = _requestL2TransactionSender(_request);
51:     }

54:     function proveL2MessageInclusion( 

64:     function proveL2LogInclusion( 

74:     function proveL1ToL2TransactionStatus( 

104:     function _proveL2LogInclusion( 

/// @audit Parameter of type 'struct L2Log' at index '0'
130:     function _L2MessageToLog(L2Message memory _message) internal pure returns (L2Log memory) { 

143:     function l2TransactionBaseCost( 

/// @audit Parameter of type 'uint256' at index '0'
156:     function _deriveL2GasPrice(uint256 _l1GasPrice, uint256 _gasPerPubdata) internal view returns (uint256) { 

197:     function requestL2Transaction( 
198:         address _contractL2,
199:         uint256 _l2Value,
200:         bytes calldata _calldata,
201:         uint256 _l2GasLimit,
202:         uint256 _l2GasPerPubdataByteLimit,
203:         bytes[] calldata _factoryDeps,
204:         address _refundRecipient
205:     ) external payable returns (bytes32 canonicalTxHash) {
206:         require(s.chainId == ERA_CHAIN_ID, "legacy interface only available for era token");
207:         canonicalTxHash = _requestL2TransactionSender(
208:             BridgehubL2TransactionRequest({
209:                 sender: msg.sender,
210:                 contractL2: _contractL2,
211:                 mintValue: msg.value,
212:                 l2Value: _l2Value,
213:                 l2GasLimit: _l2GasLimit,
214:                 l2Calldata: _calldata,
215:                 l2GasPerPubdataByteLimit: _l2GasPerPubdataByteLimit,
216:                 factoryDeps: _factoryDeps,
217:                 refundRecipient: _refundRecipient
218:             })
219:         );
220:         IL1SharedBridge(s.baseTokenBridge).bridgehubDepositBaseToken{value: msg.value}(
221:             s.chainId,
222:             msg.sender,
223:             ETH_TOKEN_ADDRESS,
224:             msg.value
225:         );
226:     }

228:     function _requestL2TransactionSender( 
229:         BridgehubL2TransactionRequest memory _request
230:     ) internal nonReentrant returns (bytes32 canonicalTxHash) {
231:         // Change the sender address if it is a smart contract to prevent address collision between L1 and L2.
232:         // Please note, currently zkSync address derivation is different from Ethereum one, but it may be changed in the future.
233:         address l2Sender = _request.sender;
234:         if (l2Sender != tx.origin) {
235:             l2Sender = AddressAliasHelper.applyL1ToL2Alias(_request.sender);
236:         }
237: 
238:         // Enforcing that `_request.l2GasPerPubdataByteLimit` equals to a certain constant number. This is needed
239:         // to ensure that users do not get used to using "exotic" numbers for _request.l2GasPerPubdataByteLimit, e.g. 1-2, etc.
240:         // VERY IMPORTANT: nobody should rely on this constant to be fixed and every contract should give their users the ability to provide the
241:         // ability to provide `_request.l2GasPerPubdataByteLimit` for each independent transaction.
242:         // CHANGING THIS CONSTANT SHOULD BE A CLIENT-SIDE CHANGE.
243:         require(_request.l2GasPerPubdataByteLimit == REQUIRED_L2_GAS_PRICE_PER_PUBDATA, "qp");
244: 
245:         // Here we manually assign fields for the struct to prevent "stack too deep" error
246:         WritePriorityOpParams memory params;
247: 
248:         params.sender = l2Sender;
249:         params.l2Value = _request.l2Value;
250:         params.contractAddressL2 = _request.contractL2;
251:         params.l2GasLimit = _request.l2GasLimit;
252:         params.l2GasPricePerPubdata = _request.l2GasPerPubdataByteLimit;
253:         params.refundRecipient = _request.refundRecipient;
254: 
255:         canonicalTxHash = _requestL2Transaction(_request.mintValue, params, _request.l2Calldata, _request.factoryDeps);
256:     }

258:     function _requestL2Transaction( 
259:         uint256 _mintValue,
260:         WritePriorityOpParams memory _params,
261:         bytes memory _calldata,
262:         bytes[] memory _factoryDeps
263:     ) internal returns (bytes32 canonicalTxHash) {
264:         require(_factoryDeps.length <= MAX_NEW_FACTORY_DEPS, "uj");
265:         _params.txId = s.priorityQueue.getTotalPriorityTxs();
266: 
267:         // Checking that the user provided enough ether to pay for the transaction.
268:         // Using a new scope to prevent "stack too deep" error
269: 
270:         _params.l2GasPrice = _deriveL2GasPrice(tx.gasprice, _params.l2GasPricePerPubdata);
271:         uint256 baseCost = _params.l2GasPrice * _params.l2GasLimit;
272:         require(_mintValue >= baseCost + _params.l2Value, "mv"); // The `msg.value` doesn't cover the transaction cost
273: 
274:         // If the `_refundRecipient` is not provided, we use the `_sender` as the recipient.
275:         address refundRecipient = _params.refundRecipient == address(0) ? _params.sender : _params.refundRecipient;
276:         // If the `_refundRecipient` is a smart contract, we apply the L1 to L2 alias to prevent foot guns.
277:         if (refundRecipient.code.length > 0) {
278:             refundRecipient = AddressAliasHelper.applyL1ToL2Alias(refundRecipient);
279:         }
280:         _params.refundRecipient = refundRecipient;
281: 
282:         // populate missing fields
283:         _params.expirationTimestamp = uint64(block.timestamp + PRIORITY_EXPIRATION); // Safe to cast
284:         _params.valueToMint = _mintValue;
285: 
286:         canonicalTxHash = _writePriorityOp(_params, _calldata, _factoryDeps);
287:     }

289:     function _serializeL2Transaction( 
290:         WritePriorityOpParams memory _priorityOpParams,
291:         bytes memory _calldata,
292:         bytes[] memory _factoryDeps
293:     ) internal pure returns (L2CanonicalTransaction memory transaction) {
294:         transaction = L2CanonicalTransaction({
295:             txType: PRIORITY_OPERATION_L2_TX_TYPE,
296:             from: uint256(uint160(_priorityOpParams.sender)),
297:             to: uint256(uint160(_priorityOpParams.contractAddressL2)),
298:             gasLimit: _priorityOpParams.l2GasLimit,
299:             gasPerPubdataByteLimit: _priorityOpParams.l2GasPricePerPubdata,
300:             maxFeePerGas: uint256(_priorityOpParams.l2GasPrice),
301:             maxPriorityFeePerGas: uint256(0),
302:             paymaster: uint256(0),
303:             // Note, that the priority operation id is used as "nonce" for L1->L2 transactions
304:             nonce: uint256(_priorityOpParams.txId),
305:             value: _priorityOpParams.l2Value,
306:             reserved: [_priorityOpParams.valueToMint, uint256(uint160(_priorityOpParams.refundRecipient)), 0, 0],
307:             data: _calldata,
308:             signature: new bytes(0),
309:             factoryDeps: _hashFactoryDeps(_factoryDeps),
310:             paymasterInput: new bytes(0),
311:             reservedDynamic: new bytes(0)
312:         });
313:     }

316:     function _writePriorityOp( 
317:         WritePriorityOpParams memory _priorityOpParams,
318:         bytes memory _calldata,
319:         bytes[] memory _factoryDeps
320:     ) internal returns (bytes32 canonicalTxHash) {
321:         L2CanonicalTransaction memory transaction = _serializeL2Transaction(_priorityOpParams, _calldata, _factoryDeps);
322: 
323:         bytes memory transactionEncoding = abi.encode(transaction);
324: 
325:         TransactionValidator.validateL1ToL2Transaction(
326:             transaction,
327:             transactionEncoding,
328:             s.priorityTxMaxGasLimit,
329:             s.feeParams.priorityTxMaxPubdata
330:         );
331: 
332:         canonicalTxHash = keccak256(transactionEncoding);
333: 
334:         s.priorityQueue.pushBack(
335:             PriorityOperation({
336:                 canonicalTxHash: canonicalTxHash,
337:                 expirationTimestamp: _priorityOpParams.expirationTimestamp,
338:                 layer2Tip: uint192(0) // TODO: Restore after fee modeling will be stable. (SMA-1230)
339:             })
340:         );
341: 
342:         // Data that is needed for the operator to simulate priority queue offchain
343:         emit NewPriorityRequest(
344:             _priorityOpParams.txId,
345:             canonicalTxHash,
346:             _priorityOpParams.expirationTimestamp,
347:             transaction,
348:             _factoryDeps
349:         );
350:     }

353:     function _hashFactoryDeps(bytes[] memory _factoryDeps) internal pure returns (uint256[] memory hashedFactoryDeps) { 
354:         uint256 factoryDepsLen = _factoryDeps.length;
355:         hashedFactoryDeps = new uint256[](factoryDepsLen);
356:         for (uint256 i = 0; i < factoryDepsLen; i = i.uncheckedInc()) {
357:             bytes32 hashedBytecode = L2ContractHelper.hashL2Bytecode(_factoryDeps[i]);
358: 
359:             // Store the resulting hash sequentially in bytes.
360:             assembly {
361:                 mstore(add(hashedFactoryDeps, mul(add(i, 1), 32)), hashedBytecode)
362:             }
363:         }
364:     }
```
[47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L47-L51), [54](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L54), [64](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L64), [74](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L74), [104](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L104), [130](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L130), [143](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L143), [156](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L156), [197](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L197-L226), [228](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L228-L256), [258](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L258-L287), [289](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L289-L313), [316](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L316-L350), [353](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L353-L364)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol

/// @audit Parameter of type 'bytes32' at index '0'
62:     function initialize(InitializeData calldata _initData) external returns (bytes32); 
```
[62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L62)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol

/// @audit Parameter of type 'address' at index '0'
19:     function getVerifier() external view returns (address); 

/// @audit Parameter of type 'address' at index '0'
22:     function getAdmin() external view returns (address); 

/// @audit Parameter of type 'address' at index '0'
25:     function getPendingAdmin() external view returns (address); 

/// @audit Parameter of type 'address' at index '0'
28:     function getBridgehub() external view returns (address); 

/// @audit Parameter of type 'address' at index '0'
31:     function getStateTransitionManager() external view returns (address); 

/// @audit Parameter of type 'address' at index '0'
34:     function getBaseToken() external view returns (address); 

/// @audit Parameter of type 'address' at index '0'
37:     function getBaseTokenBridge() external view returns (address); 

/// @audit Parameter of type 'uint256' at index '0'
40:     function getTotalBatchesCommitted() external view returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
43:     function getTotalBatchesVerified() external view returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
46:     function getTotalBatchesExecuted() external view returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
49:     function getTotalPriorityTxs() external view returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
56:     function getFirstUnprocessedPriorityTx() external view returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
59:     function getPriorityQueueSize() external view returns (uint256); 

/// @audit Parameter of type 'struct PriorityOperation' at index '0'
62:     function priorityQueueFrontOperation() external view returns (PriorityOperation memory); 

/// @audit Parameter of type 'bool' at index '0'
65:     function isValidator(address _address) external view returns (bool); 

68:     function l2LogsRootHash(uint256 _batchNumber) external view returns (bytes32 merkleRoot); 

/// @audit Parameter of type 'bytes32' at index '0'
73:     function storedBatchHash(uint256 _batchNumber) external view returns (bytes32); 

/// @audit Parameter of type 'bytes32' at index '0'
76:     function getL2BootloaderBytecodeHash() external view returns (bytes32); 

/// @audit Parameter of type 'bytes32' at index '0'
79:     function getL2DefaultAccountBytecodeHash() external view returns (bytes32); 

/// @audit Parameter of type 'struct VerifierParams' at index '0'
82:     function getVerifierParams() external view returns (VerifierParams memory); 

/// @audit Parameter of type 'bool' at index '0'
85:     function isDiamondStorageFrozen() external view returns (bool); 

/// @audit Parameter of type 'uint256' at index '0'
88:     function getProtocolVersion() external view returns (uint256); 

/// @audit Parameter of type 'bytes32' at index '0'
91:     function getL2SystemContractsUpgradeTxHash() external view returns (bytes32); 

/// @audit Parameter of type 'uint256' at index '0'
98:     function getL2SystemContractsUpgradeBatchNumber() external view returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
101:     function getPriorityTxMaxGasLimit() external view returns (uint256); 

/// @audit Parameter of type 'bool' at index '0'
106:     function isEthWithdrawalFinalized(uint256 _l2BatchNumber, uint256 _l2MessageIndex) external view returns (bool); 

/// @audit Parameter of type 'enum PubdataPricingMode' at index '0'
109:     function getPubdataPricingMode() external view returns (PubdataPricingMode); 

/// @audit Parameter of type 'uint128' at index '0'
112:     function baseTokenGasPriceMultiplierNominator() external view returns (uint128); 

/// @audit Parameter of type 'uint128' at index '0'
115:     function baseTokenGasPriceMultiplierDenominator() external view returns (uint128); 

/// @audit Parameter of type 'struct IGetters.Facet[]' at index '0'
130:     function facets() external view returns (Facet[] memory); 

/// @audit Parameter of type 'bytes4[]' at index '0'
133:     function facetFunctionSelectors(address _facet) external view returns (bytes4[] memory); 

136:     function facetAddresses() external view returns (address[] memory facets); 

139:     function facetAddress(bytes4 _selector) external view returns (address facet); 

/// @audit Parameter of type 'bool' at index '0'
142:     function isFunctionFreezable(bytes4 _selector) external view returns (bool); 

145:     function isFacetFreezable(address _facet) external view returns (bool isFreezable); 
```
[19](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L19), [22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L22), [25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L25), [28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L28), [31](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L31), [34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L34), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L37), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L40), [43](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L43), [46](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L46), [49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L49), [56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L56), [59](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L59), [62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L62), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L65), [68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L68), [73](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L73), [76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L76), [79](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L79), [82](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L82), [85](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L85), [88](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L88), [91](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L91), [98](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L98), [101](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L101), [106](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L106), [109](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L109), [112](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L112), [115](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L115), [130](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L130), [133](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L133), [136](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L136), [139](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L139), [142](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L142), [145](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L145)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol

/// @audit Parameter of type 'uint256' at index '0'
14:     function getTotalBlocksCommitted() external view returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
18:     function getTotalBlocksVerified() external view returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
22:     function getTotalBlocksExecuted() external view returns (uint256); 

/// @audit Parameter of type 'bytes32' at index '0'
28:     function storedBlockHash(uint256 _batchNumber) external view returns (bytes32); 

/// @audit Parameter of type 'uint256' at index '0'
36:     function getL2SystemContractsUpgradeBlockNumber() external view returns (uint256); 
```
[14](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol#L14), [18](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol#L18), [22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol#L22), [28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol#L28), [36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol#L36)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol

18:     function proveL2MessageInclusion( 

31:     function proveL2LogInclusion( 

47:     function proveL1ToL2TransactionStatus( 

88:     function requestL2Transaction( 
89:         address _contractL2,
90:         uint256 _l2Value,
91:         bytes calldata _calldata,
92:         uint256 _l2GasLimit,
93:         uint256 _l2GasPerPubdataByteLimit,
94:         bytes[] calldata _factoryDeps,
95:         address _refundRecipient
96:     ) external payable returns (bytes32 canonicalTxHash);

98:     function bridgehubRequestL2Transaction( 
99:         BridgehubL2TransactionRequest calldata _request
100:     ) external payable returns (bytes32 canonicalTxHash);

107:     function l2TransactionBaseCost( 
```
[18](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L18), [31](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L31), [47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L47), [88](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L88-L96), [98](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L98-L100), [107](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L107)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol

19:     function verify( 

/// @audit Parameter of type 'bytes32' at index '0'
27:     function verificationKeyHash() external pure returns (bytes32); 
```
[19](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol#L19), [27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol#L27)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol

/// @audit Parameter of type 'string' at index '0'
9:     function getName() external view returns (string memory); 
```
[9](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol#L9)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

87:     function getDiamondStorage() internal pure returns (DiamondStorage storage diamondStorage) { 
88:         bytes32 position = DIAMOND_STORAGE_POSITION;
89:         assembly {
90:             diamondStorage.slot := position
91:         }
92:     }
```
[87](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L87-L92)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/LibMap.sol

18:     function get(Uint32Map storage _map, uint256 _index) internal view returns (uint32 result) { 
19:         unchecked {
20:             // Each storage slot can store 256 bits of data.
21:             // As uint32 is 32 bits long, 8 uint32s can be packed into one storage slot.
22:             // Hence, `_index / 8` is done to find the storage slot that contains the required uint32.
23:             uint256 mapValue = _map.map[_index / 8];
24: 
25:             // First three bits of the original `_index` denotes the position of the uint32 in that slot.
26:             // So, '(_index & 7) * 32' is done to find the bit position of the uint32 in that storage slot.
27:             uint256 bitOffset = (_index & 7) * 32;
28: 
29:             // Shift the bits to the right and retrieve the uint32 value.
30:             result = uint32(mapValue >> bitOffset);
31:         }
32:     }
```
[18](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L18-L32)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol

18:     function calculateRoot( 

40:     function _efficientHash(bytes32 _lhs, bytes32 _rhs) private pure returns (bytes32 result) { 
41:         assembly {
42:             mstore(0x00, _lhs)
43:             mstore(0x20, _rhs)
44:             result := keccak256(0x00, 0x40)
45:         }
46:     }
```
[18](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L18), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L40-L46)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol

/// @audit Parameter of type 'uint256' at index '0'
35:     function getFirstUnprocessedPriorityTx(Queue storage _queue) internal view returns (uint256) { 

/// @audit Parameter of type 'uint256' at index '0'
40:     function getTotalPriorityTxs(Queue storage _queue) internal view returns (uint256) { 

/// @audit Parameter of type 'uint256' at index '0'
45:     function getSize(Queue storage _queue) internal view returns (uint256) { 

/// @audit Parameter of type 'bool' at index '0'
50:     function isEmpty(Queue storage _queue) internal view returns (bool) { 

/// @audit Parameter of type 'struct PriorityOperation' at index '0'
64:     function front(Queue storage _queue) internal view returns (PriorityOperation memory) { 

72:     function popFront(Queue storage _queue) internal returns (PriorityOperation memory priorityOperation) { 
73:         require(!_queue.isEmpty(), "s"); // priority queue is empty
74: 
75:         // Save value into the stack to avoid double reading from the storage
76:         uint256 head = _queue.head;
77: 
78:         priorityOperation = _queue.data[head];
79:         delete _queue.data[head];
80:         _queue.head = head + 1;
81:     }
```
[35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L35), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L40), [45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L45), [50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L50), [64](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L64), [72](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L72-L81)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol

69:     function getMinimalPriorityTransactionGasLimit( 

109:     function getTransactionBodyGasLimit( 
110:         uint256 _totalGasLimit,
111:         uint256 _encodingLength
112:     ) internal pure returns (uint256 txBodyGasLimit) {
113:         uint256 overhead = getOverheadForTransaction(_encodingLength);
114: 
115:         require(_totalGasLimit >= overhead, "my"); // provided gas limit doesn't cover transaction overhead
116:         unchecked {
117:             // We enforce the fact that `_totalGasLimit >= overhead` explicitly above.
118:             txBodyGasLimit = _totalGasLimit - overhead;
119:         }
120:     }

128:     function getOverheadForTransaction( 
129:         uint256 _encodingLength
130:     ) internal pure returns (uint256 batchOverheadForTransaction) {
131:         // The overhead from taking up the transaction's slot
132:         batchOverheadForTransaction = TX_SLOT_OVERHEAD_L2_GAS;
133: 
134:         // The overhead for occupying the bootloader memory can be derived from encoded_len
135:         uint256 overheadForLength = MEMORY_OVERHEAD_GAS * _encodingLength;
136:         batchOverheadForTransaction = Math.max(batchOverheadForTransaction, overheadForLength);
137:     }
```
[69](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L69), [109](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L109-L120), [128](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L128-L137)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

67:     function upgrade(ProposedUpgrade calldata _proposedUpgrade) public virtual returns (bytes32 txHash) { 
68:         // Note that due to commitment delay, the timestamp of the L2 upgrade batch may be earlier than the timestamp
69:         // of the L1 block at which the upgrade occurred. This means that using timestamp as a signifier of "upgraded"
70:         // on the L2 side would be inaccurate. The effects of this "back-dating" of L2 upgrade batches will be reduced
71:         // as the permitted delay window is reduced in the future.
72:         require(block.timestamp >= _proposedUpgrade.upgradeTimestamp, "Upgrade is not ready yet");
73: 
74:         _setNewProtocolVersion(_proposedUpgrade.newProtocolVersion);
75:         _upgradeL1Contract(_proposedUpgrade.l1ContractsUpgradeCalldata);
76:         _upgradeVerifier(_proposedUpgrade.verifier, _proposedUpgrade.verifierParams);
77:         _setBaseSystemContracts(_proposedUpgrade.bootloaderHash, _proposedUpgrade.defaultAccountHash);
78: 
79:         txHash = _setL2SystemContractUpgrade(
80:             _proposedUpgrade.l2ProtocolUpgradeTx,
81:             _proposedUpgrade.factoryDeps,
82:             _proposedUpgrade.newProtocolVersion
83:         );
84: 
85:         _postUpgrade(_proposedUpgrade.postUpgradeCalldata);
86: 
87:         emit UpgradeComplete(_proposedUpgrade.newProtocolVersion, txHash, _proposedUpgrade);
88:     }

180:     function _setL2SystemContractUpgrade( 
```
[67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L67-L88), [180](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L180)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol

/// @audit Parameter of type 'bytes32' at index '0'
47:     function upgrade(ProposedUpgrade calldata _proposedUpgrade) public virtual override returns (bytes32) { 
```
[47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L47)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol

/// @audit Parameter of type 'bytes32' at index '0'
13:     function upgrade(ProposedUpgrade calldata _proposedUpgrade) public override returns (bytes32) { 
```
[13](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol#L13)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol

/// @audit Parameter of type 'bytes32' at index '0'
14:     function upgrade(ProposedUpgrade calldata _proposedUpgrade) public override returns (bytes32) { 
```
[14](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L14)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol

/// @audit Parameter of type 'bytes32' at index '0'
8:     function upgrade(ProposedUpgrade calldata _upgrade) external returns (bytes32); 
```
[8](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol#L8)

```solidity
üìÅ File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol

28:     function applyL1ToL2Alias(address l1Address) internal pure returns (address l2Address) { 
29:         unchecked {
30:             l2Address = address(uint160(l1Address) + offset);
31:         }
32:     }

38:     function undoL1ToL2Alias(address l2Address) internal pure returns (address l1Address) { 
39:         unchecked {
40:             l1Address = address(uint160(l2Address) - offset);
41:         }
42:     }
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L28-L32), [38](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L38-L42)

```solidity
üìÅ File: contracts/zksync/contracts/L2ContractHelper.sol

/// @audit Parameter of type 'bytes32' at index '0'
22:     function sendToL1(bytes memory _message) external returns (bytes32); 

/// @audit Parameter of type 'address' at index '0'
53:     function create2(bytes32 _salt, bytes32 _bytecodeHash, bytes calldata _input) external returns (address); 

/// @audit Parameter of type 'bytes32' at index '0'
90:     function sendMessageToL1(bytes memory _message) internal returns (bytes32) { 

101:     function computeCreate2Address( 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L22), [53](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L53), [90](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L90), [101](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L101)

```solidity
üìÅ File: contracts/zksync/contracts/SystemContractsCaller.sol

/// @audit Parameter of type 'uint32' at index '0'
27:     function safeCastToU32(uint256 _x) internal pure returns (uint32) { 

37:     function systemCall(uint32 gasLimit, address to, uint256 value, bytes memory data) internal returns (bool success) { 
38:         address callAddr = SYSTEM_CALL_CALL_ADDRESS;
39: 
40:         uint32 dataStart;
41:         assembly {
42:             dataStart := add(data, 0x20)
43:         }
44:         uint32 dataLength = uint32(Utils.safeCastToU32(data.length));
45: 
46:         uint256 farCallAbi = getFarCallABI(
47:             0,
48:             0,
49:             dataStart,
50:             dataLength,
51:             gasLimit,
52:             // Only rollup is supported for now
53:             0,
54:             CalldataForwardingMode.UseHeap,
55:             false,
56:             true
57:         );
58: 
59:         if (value == 0) {
60:             // Doing the system call directly
61:             assembly {
62:                 success := call(to, callAddr, 0, 0, farCallAbi, 0, 0)
63:             }
64:         } else {
65:             address msgValueSimulator = MSG_VALUE_SYSTEM_CONTRACT;
66:             // We need to supply the mask to the MsgValueSimulator to denote
67:             // that the call should be a system one.
68:             uint256 forwardMask = MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT;
69: 
70:             assembly {
71:                 success := call(msgValueSimulator, callAddr, value, to, farCallAbi, forwardMask, 0)
72:             }
73:         }
74:     }

76:     function systemCallWithReturndata( 
77:         uint32 gasLimit,
78:         address to,
79:         uint128 value,
80:         bytes memory data
81:     ) internal returns (bool success, bytes memory returnData) {
82:         success = systemCall(gasLimit, to, value, data);
83: 
84:         uint256 size;
85:         assembly {
86:             size := returndatasize()
87:         }
88: 
89:         returnData = new bytes(size);
90:         assembly {
91:             returndatacopy(add(returnData, 0x20), 0, size)
92:         }
93:     }

95:     function getFarCallABI( 
96:         uint32 dataOffset,
97:         uint32 memoryPage,
98:         uint32 dataStart,
99:         uint32 dataLength,
100:         uint32 gasPassed,
101:         uint8 shardId,
102:         CalldataForwardingMode forwardingMode,
103:         bool isConstructorCall,
104:         bool isSystemCall
105:     ) internal pure returns (uint256 farCallAbi) {
106:         // Fill in the call parameter fields
107:         farCallAbi = getFarCallABIWithEmptyFatPointer(
108:             gasPassed,
109:             shardId,
110:             forwardingMode,
111:             isConstructorCall,
112:             isSystemCall
113:         );
114:         // Fill in the fat pointer fields
115:         farCallAbi |= dataOffset;
116:         farCallAbi |= (uint256(memoryPage) << 32);
117:         farCallAbi |= (uint256(dataStart) << 64);
118:         farCallAbi |= (uint256(dataLength) << 96);
119:     }

121:     function getFarCallABIWithEmptyFatPointer( 
122:         uint32 gasPassed,
123:         uint8 shardId,
124:         CalldataForwardingMode forwardingMode,
125:         bool isConstructorCall,
126:         bool isSystemCall
127:     ) internal pure returns (uint256 farCallAbiWithEmptyFatPtr) {
128:         farCallAbiWithEmptyFatPtr |= (uint256(gasPassed) << 192);
129:         farCallAbiWithEmptyFatPtr |= (uint256(forwardingMode) << 224);
130:         farCallAbiWithEmptyFatPtr |= (uint256(shardId) << 232);
131:         if (isConstructorCall) {
132:             farCallAbiWithEmptyFatPtr |= (1 << 240);
133:         }
134:         if (isSystemCall) {
135:             farCallAbiWithEmptyFatPtr |= (1 << 248);
136:         }
137:     }
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L27), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L37-L74), [76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L76-L93), [95](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L95-L119), [121](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L121-L137)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

/// @audit Parameter of type 'address' at index '0'
109:     function _deployL2Token(address _l1Token, bytes calldata _data) internal returns (address) { 

138:     function _getL1WithdrawMessage( 

/// @audit Parameter of type 'address' at index '0'
149:     function l2TokenAddress(address _l1Token) public view override returns (address) { 

157:     function _getCreate2Salt(address _l1Token) internal pure returns (bytes32 salt) { 
158:         salt = bytes32(uint256(uint160(_l1Token)));
159:     }

164:     function _deployBeaconProxy(bytes32 salt) internal returns (BeaconProxy proxy) { 
165:         (bool success, bytes memory returndata) = SystemContractsCaller.systemCallWithReturndata(
166:             uint32(gasleft()),
167:             DEPLOYER_SYSTEM_CONTRACT,
168:             0,
169:             abi.encodeCall(
170:                 IContractDeployer.create2,
171:                 (salt, l2TokenProxyBytecodeHash, abi.encode(address(l2TokenBeacon), ""))
172:             )
173:         );
174: 
175:         // The deployment should be successful and return the address of the proxy
176:         require(success, "mk");
177:         proxy = BeaconProxy(abi.decode(returndata, (address)));
178:     }
```
[109](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L109), [138](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L138), [149](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L149), [157](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L157-L159), [164](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L164-L178)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

/// @audit Parameter of type 'string' at index '0'
159:     function name() public view override returns (string memory) { 

/// @audit Parameter of type 'string' at index '0'
165:     function symbol() public view override returns (string memory) { 

/// @audit Parameter of type 'uint8' at index '0'
171:     function decimals() public view override returns (uint8) { 

178:     function decodeString(bytes memory _input) external pure returns (string memory result) { 
179:         (result) = abi.decode(_input, (string));
180:     }

183:     function decodeUint8(bytes memory _input) external pure returns (uint8 result) { 
184:         (result) = abi.decode(_input, (uint8));
185:     }
```
[159](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L159), [165](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L165), [171](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L171), [178](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L178-L180), [183](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L183-L185)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol

/// @audit Parameter of type 'address' at index '0'
34:     function l1TokenAddress(address _l2Token) external view returns (address); 

/// @audit Parameter of type 'address' at index '0'
36:     function l2TokenAddress(address _l1Token) external view returns (address); 

/// @audit Parameter of type 'address' at index '0'
38:     function l1Bridge() external view returns (address); 
```
[34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L34), [36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L36), [38](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L38)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol

/// @audit Parameter of type 'address' at index '0'
16:     function l1Address() external view returns (address); 

/// @audit Parameter of type 'address' at index '0'
18:     function l2Bridge() external view returns (address); 
```
[16](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L16), [18](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L18)

```solidity
üìÅ File: contracts/zksync/contracts/interfaces/IPaymaster.sol

28:     function validateAndPayForPaymasterTransaction( 
29:         bytes32 _txHash,
30:         bytes32 _suggestedSignedHash,
31:         Transaction calldata _transaction
32:     ) external payable returns (bytes4 magic, bytes memory context);
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymaster.sol#L28-L32)

```solidity
üìÅ File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol

28:     function applyL1ToL2Alias(address l1Address) internal pure returns (address l2Address) { 
29:         unchecked {
30:             l2Address = address(uint160(l1Address) + offset);
31:         }
32:     }

38:     function undoL1ToL2Alias(address l2Address) internal pure returns (address l1Address) { 
39:         unchecked {
40:             l1Address = address(uint160(l2Address) - offset);
41:         }
42:     }
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L28-L32), [38](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L38-L42)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

78:     function getRawCodeHash(address _address) public view override returns (bytes32 codeHash) { 
79:         uint256 addressAsKey = uint256(uint160(_address));
80: 
81:         assembly {
82:             codeHash := sload(addressAsKey)
83:         }
84:     }

/// @audit Parameter of type 'bytes32' at index '0'
89:     function getCodeHash(uint256 _input) external view override returns (bytes32) { 

117:     function getCodeSize(uint256 _input) external view override returns (uint256 codeSize) { 
118:         // We consider the account bytecode size of the last 20 bytes of the input, because
119:         // according to the spec "If EXTCODESIZE of A is X, then EXTCODESIZE of A + 2**160 is X".
120:         address account = address(uint160(_input));
121:         bytes32 codeHash = getRawCodeHash(account);
122: 
123:         // If the contract is a default account or is on constructor the code size is zero,
124:         // otherwise extract the proper value for it from the bytecode hash.
125:         // NOTE: zero address and precompiles are a special case, they are contracts, but we
126:         // want to preserve EVM invariants (see EIP-1052 specification). That's why we automatically
127:         // return `0` length in the following cases:
128:         // - `codehash(0) == 0`
129:         // - `account` is a precompile.
130:         // - `account` is currently being constructed
131:         if (
132:             uint160(account) > CURRENT_MAX_PRECOMPILE_ADDRESS &&
133:             codeHash != 0x00 &&
134:             !Utils.isContractConstructing(codeHash)
135:         ) {
136:             codeSize = Utils.bytecodeLenInBytes(codeHash);
137:         }
138:     }
```
[78](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L78-L84), [89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L89), [117](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L117-L138)

```solidity
üìÅ File: system-contracts/contracts/BootloaderUtilities.sol

24:     function getTransactionHashes( 
25:         Transaction calldata _transaction
26:     ) external view override returns (bytes32 txHash, bytes32 signedTxHash) {
27:         signedTxHash = _transaction.encodeHash();
28:         if (_transaction.txType == EIP_712_TX_TYPE) {
29:             txHash = keccak256(bytes.concat(signedTxHash, EfficientCall.keccak(_transaction.signature)));
30:         } else if (_transaction.txType == LEGACY_TX_TYPE) {
31:             txHash = encodeLegacyTransactionHash(_transaction);
32:         } else if (_transaction.txType == EIP_1559_TX_TYPE) {
33:             txHash = encodeEIP1559TransactionHash(_transaction);
34:         } else if (_transaction.txType == EIP_2930_TX_TYPE) {
35:             txHash = encodeEIP2930TransactionHash(_transaction);
36:         } else {
37:             revert("Unsupported tx type");
38:         }
39:     }

44:     function encodeLegacyTransactionHash(Transaction calldata _transaction) internal view returns (bytes32 txHash) { 
45:         // Hash of legacy transactions are encoded as one of the:
46:         // - RLP(nonce, gasPrice, gasLimit, to, value, data, chainId, 0, 0)
47:         // - RLP(nonce, gasPrice, gasLimit, to, value, data)
48:         //
49:         // In this RLP encoding, only the first one above list appears, so we encode each element
50:         // inside list and then concatenate the length of all elements with them.
51: 
52:         bytes memory encodedNonce = RLPEncoder.encodeUint256(_transaction.nonce);
53:         // Encode `gasPrice` and `gasLimit` together to prevent "stack too deep error".
54:         bytes memory encodedGasParam;
55:         {
56:             bytes memory encodedGasPrice = RLPEncoder.encodeUint256(_transaction.maxFeePerGas);
57:             bytes memory encodedGasLimit = RLPEncoder.encodeUint256(_transaction.gasLimit);
58:             encodedGasParam = bytes.concat(encodedGasPrice, encodedGasLimit);
59:         }
60: 
61:         bytes memory encodedTo = RLPEncoder.encodeAddress(address(uint160(_transaction.to)));
62:         bytes memory encodedValue = RLPEncoder.encodeUint256(_transaction.value);
63:         // Encode only the length of the transaction data, and not the data itself,
64:         // so as not to copy to memory a potentially huge transaction data twice.
65:         bytes memory encodedDataLength;
66:         {
67:             // Safe cast, because the length of the transaction data can't be so large.
68:             uint64 txDataLen = uint64(_transaction.data.length);
69:             if (txDataLen != 1) {
70:                 // If the length is not equal to one, then only using the length can it be encoded definitely.
71:                 encodedDataLength = RLPEncoder.encodeNonSingleBytesLen(txDataLen);
72:             } else if (_transaction.data[0] >= 0x80) {
73:                 // If input is a byte in [0x80, 0xff] range, RLP encoding will concatenates 0x81 with the byte.
74:                 encodedDataLength = hex"81";
75:             }
76:             // Otherwise the length is not encoded at all.
77:         }
78: 
79:         bytes memory rEncoded;
80:         {
81:             uint256 rInt = uint256(bytes32(_transaction.signature[0:32]));
82:             rEncoded = RLPEncoder.encodeUint256(rInt);
83:         }
84:         bytes memory sEncoded;
85:         {
86:             uint256 sInt = uint256(bytes32(_transaction.signature[32:64]));
87:             sEncoded = RLPEncoder.encodeUint256(sInt);
88:         }
89:         bytes memory vEncoded;
90:         {
91:             uint256 vInt = uint256(uint8(_transaction.signature[64]));
92:             require(vInt == 27 || vInt == 28, "Invalid v value");
93: 
94:             // If the `chainId` is specified in the transaction, then the `v` value is encoded as
95:             // `35 + y + 2 * chainId == vInt + 8 + 2 * chainId`, where y - parity bit (see EIP-155).
96:             if (_transaction.reserved[0] != 0) {
97:                 vInt += 8 + block.chainid * 2;
98:             }
99: 
100:             vEncoded = RLPEncoder.encodeUint256(vInt);
101:         }
102: 
103:         bytes memory encodedListLength;
104:         unchecked {
105:             uint256 listLength = encodedNonce.length +
106:                 encodedGasParam.length +
107:                 encodedTo.length +
108:                 encodedValue.length +
109:                 encodedDataLength.length +
110:                 _transaction.data.length +
111:                 rEncoded.length +
112:                 sEncoded.length +
113:                 vEncoded.length;
114: 
115:             // Safe cast, because the length of the list can't be so large.
116:             encodedListLength = RLPEncoder.encodeListLen(uint64(listLength));
117:         }
118: 
119:         return
120:             keccak256(
121:                 bytes.concat(
122:                     encodedListLength,
123:                     encodedNonce,
124:                     encodedGasParam,
125:                     encodedTo,
126:                     encodedValue,
127:                     encodedDataLength,
128:                     _transaction.data,
129:                     vEncoded,
130:                     rEncoded,
131:                     sEncoded
132:                 )
133:             );
134:     }

/// @audit Parameter of type 'bytes32' at index '0'
139:     function encodeEIP2930TransactionHash(Transaction calldata _transaction) internal view returns (bytes32) { 

/// @audit Parameter of type 'bytes32' at index '0'
229:     function encodeEIP1559TransactionHash(Transaction calldata _transaction) internal view returns (bytes32) { 
```
[24](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L24-L39), [44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L44-L134), [139](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L139), [229](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L229)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

44:     function publishCompressedBytecode( 
45:         bytes calldata _bytecode,
46:         bytes calldata _rawCompressedData
47:     ) external payable onlyCallFromBootloader returns (bytes32 bytecodeHash) {
48:         unchecked {
49:             (bytes calldata dictionary, bytes calldata encodedData) = _decodeRawBytecode(_rawCompressedData);
50: 
51:             require(
52:                 encodedData.length * 4 == _bytecode.length,
53:                 "Encoded data length should be 4 times shorter than the original bytecode"
54:             );
55: 
56:             require(
57:                 dictionary.length / 8 <= encodedData.length / 2,
58:                 "Dictionary should have at most the same number of entries as the encoded data"
59:             );
60: 
61:             for (uint256 encodedDataPointer = 0; encodedDataPointer < encodedData.length; encodedDataPointer += 2) {
62:                 uint256 indexOfEncodedChunk = uint256(encodedData.readUint16(encodedDataPointer)) * 8;
63:                 require(indexOfEncodedChunk < dictionary.length, "Encoded chunk index is out of bounds");
64: 
65:                 uint64 encodedChunk = dictionary.readUint64(indexOfEncodedChunk);
66:                 uint64 realChunk = _bytecode.readUint64(encodedDataPointer * 4);
67: 
68:                 require(encodedChunk == realChunk, "Encoded chunk does not match the original bytecode");
69:             }
70:         }
71: 
72:         bytecodeHash = Utils.hashL2Bytecode(_bytecode);
73:         L1_MESSENGER_CONTRACT.sendToL1(_rawCompressedData);
74:         KNOWN_CODE_STORAGE_CONTRACT.markBytecodeAsPublished(bytecodeHash);
75:     }

110:     function verifyCompressedStateDiffs( 
111:         uint256 _numberOfStateDiffs,
112:         uint256 _enumerationIndexSize,
113:         bytes calldata _stateDiffs,
114:         bytes calldata _compressedStateDiffs
115:     ) external payable onlyCallFrom(address(L1_MESSENGER_CONTRACT)) returns (bytes32 stateDiffHash) {
116:         // We do not enforce the operator to use the optimal, i.e. the minimally possible _enumerationIndexSize.
117:         // We do enforce however, that the _enumerationIndexSize is not larger than 8 bytes long, which is the
118:         // maximal ever possible size for enumeration index.
119:         require(_enumerationIndexSize <= MAX_ENUMERATION_INDEX_SIZE, "enumeration index size is too large");
120: 
121:         uint256 numberOfInitialWrites = uint256(_compressedStateDiffs.readUint16(0));
122: 
123:         uint256 stateDiffPtr = 2;
124:         uint256 numInitialWritesProcessed = 0;
125: 
126:         // Process initial writes
127:         for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) {
128:             bytes calldata stateDiff = _stateDiffs[i:i + STATE_DIFF_ENTRY_SIZE];
129:             uint64 enumIndex = stateDiff.readUint64(84);
130:             if (enumIndex != 0) {
131:                 // It is a repeated write, so we skip it.
132:                 continue;
133:             }
134: 
135:             numInitialWritesProcessed++;
136: 
137:             bytes32 derivedKey = stateDiff.readBytes32(52);
138:             uint256 initValue = stateDiff.readUint256(92);
139:             uint256 finalValue = stateDiff.readUint256(124);
140:             require(derivedKey == _compressedStateDiffs.readBytes32(stateDiffPtr), "iw: initial key mismatch");
141:             stateDiffPtr += 32;
142: 
143:             uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr]));
144:             stateDiffPtr++;
145:             uint8 operation = metadata & OPERATION_BITMASK;
146:             uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;
147:             _verifyValueCompression(
148:                 initValue,
149:                 finalValue,
150:                 operation,
151:                 _compressedStateDiffs[stateDiffPtr:stateDiffPtr + len]
152:             );
153:             stateDiffPtr += len;
154:         }
155: 
156:         require(numInitialWritesProcessed == numberOfInitialWrites, "Incorrect number of initial storage diffs");
157: 
158:         // Process repeated writes
159:         for (uint256 i = 0; i < _numberOfStateDiffs * STATE_DIFF_ENTRY_SIZE; i += STATE_DIFF_ENTRY_SIZE) {
160:             bytes calldata stateDiff = _stateDiffs[i:i + STATE_DIFF_ENTRY_SIZE];
161:             uint64 enumIndex = stateDiff.readUint64(84);
162:             if (enumIndex == 0) {
163:                 continue;
164:             }
165: 
166:             uint256 initValue = stateDiff.readUint256(92);
167:             uint256 finalValue = stateDiff.readUint256(124);
168:             uint256 compressedEnumIndex = _sliceToUint256(
169:                 _compressedStateDiffs[stateDiffPtr:stateDiffPtr + _enumerationIndexSize]
170:             );
171:             require(enumIndex == compressedEnumIndex, "rw: enum key mismatch");
172:             stateDiffPtr += _enumerationIndexSize;
173: 
174:             uint8 metadata = uint8(bytes1(_compressedStateDiffs[stateDiffPtr]));
175:             stateDiffPtr += 1;
176:             uint8 operation = metadata & OPERATION_BITMASK;
177:             uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET;
178:             _verifyValueCompression(
179:                 initValue,
180:                 finalValue,
181:                 operation,
182:                 _compressedStateDiffs[stateDiffPtr:stateDiffPtr + len]
183:             );
184:             stateDiffPtr += len;
185:         }
186: 
187:         require(stateDiffPtr == _compressedStateDiffs.length, "Extra data in _compressedStateDiffs");
188: 
189:         stateDiffHash = EfficientCall.keccak(_stateDiffs);
190:     }

197:     function _decodeRawBytecode( 
198:         bytes calldata _rawCompressedData
199:     ) internal pure returns (bytes calldata dictionary, bytes calldata encodedData) {
200:         unchecked {
201:             // The dictionary length can't be more than 2^16, so it fits into 2 bytes.
202:             uint256 dictionaryLen = uint256(_rawCompressedData.readUint16(0));
203:             dictionary = _rawCompressedData[2:2 + dictionaryLen * 8];
204:             encodedData = _rawCompressedData[2 + dictionaryLen * 8:];
205:         }
206:     }

251:     function _sliceToUint256(bytes calldata _calldataSlice) internal pure returns (uint256 number) { 
252:         number = uint256(bytes32(_calldataSlice));
253:         number >>= (256 - (_calldataSlice.length * 8));
254:     }
```
[44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L44-L75), [110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L110-L190), [197](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L197-L206), [251](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L251-L254)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

34:     function getAccountInfo(address _address) external view returns (AccountInfo memory info) { 
35:         return accountInfo[_address];
36:     }

/// @audit Parameter of type 'enum IContractDeployer.AccountAbstractionVersion' at index '0'
40:     function extendedAccountVersion(address _address) public view returns (AccountAbstractionVersion) { 

95:     function getNewAddressCreate2( 
96:         address _sender,
97:         bytes32 _bytecodeHash,
98:         bytes32 _salt,
99:         bytes calldata _input
100:     ) public view override returns (address newAddress) {
101:         // No collision is possible with the Ethereum's CREATE2, since
102:         // the prefix begins with 0x20....
103:         bytes32 constructorInputHash = EfficientCall.keccak(_input);
104: 
105:         bytes32 hash = keccak256(
106:             bytes.concat(CREATE2_PREFIX, bytes32(uint256(uint160(_sender))), _salt, _bytecodeHash, constructorInputHash)
107:         );
108: 
109:         newAddress = address(uint160(uint256(hash)));
110:     }

115:     function getNewAddressCreate( 
116:         address _sender,
117:         uint256 _senderNonce
118:     ) public pure override returns (address newAddress) {
119:         // No collision is possible with the Ethereum's CREATE, since
120:         // the prefix begins with 0x63....
121:         bytes32 hash = keccak256(
122:             bytes.concat(CREATE_PREFIX, bytes32(uint256(uint160(_sender))), bytes32(_senderNonce))
123:         );
124: 
125:         newAddress = address(uint160(uint256(hash)));
126:     }

132:     function create2( 

147:     function create( 

162:     function create2Account( 

182:     function createAccount( 
```
[34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L34-L36), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L40), [95](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L95-L110), [115](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L115-L126), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L132), [147](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L147), [162](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L162), [182](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L182)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

67:     function validateTransaction( 
68:         bytes32, // _txHash
69:         bytes32 _suggestedSignedHash,
70:         Transaction calldata _transaction
71:     ) external payable override ignoreNonBootloader ignoreInDelegateCall returns (bytes4 magic) {
72:         magic = _validateTransaction(_suggestedSignedHash, _transaction);
73:     }

78:     function _validateTransaction( 
79:         bytes32 _suggestedSignedHash,
80:         Transaction calldata _transaction
81:     ) internal returns (bytes4 magic) {
82:         // Note, that nonce holder can only be called with "isSystem" flag.
83:         SystemContractsCaller.systemCallWithPropagatedRevert(
84:             uint32(gasleft()),
85:             address(NONCE_HOLDER_SYSTEM_CONTRACT),
86:             0,
87:             abi.encodeCall(INonceHolder.incrementMinNonceIfEquals, (_transaction.nonce))
88:         );
89: 
90:         // Even though for the transaction types present in the system right now,
91:         // we always provide the suggested signed hash, this should not be
92:         // always expected. In case the bootloader has no clue what the default hash
93:         // is, the bytes32(0) will be supplied.
94:         bytes32 txHash = _suggestedSignedHash != bytes32(0) ? _suggestedSignedHash : _transaction.encodeHash();
95: 
96:         // The fact there is are enough balance for the account
97:         // should be checked explicitly to prevent user paying for fee for a
98:         // transaction that wouldn't be included on Ethereum.
99:         uint256 totalRequiredBalance = _transaction.totalRequiredBalance();
100:         require(totalRequiredBalance <= address(this).balance, "Not enough balance for fee + value");
101: 
102:         if (_isValidSignature(txHash, _transaction.signature)) {
103:             magic = ACCOUNT_VALIDATION_SUCCESS_MAGIC;
104:         }
105:     }

/// @audit Parameter of type 'bool' at index '0'
159:     function _isValidSignature(bytes32 _hash, bytes memory _signature) internal view returns (bool) { 
```
[67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L67-L73), [78](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L78-L105), [159](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L159)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

/// @audit Parameter of type 'bytes32' at index '0'
27:     function getImmutable(address _dest, uint256 _index) external view override returns (bytes32) { 
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L27)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

65:     function getMarker(bytes32 _hash) public view override returns (uint256 marker) { 
66:         assembly {
67:             marker := sload(_hash)
68:         }
69:     }
```
[65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L65-L69)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

/// @audit Parameter of type 'uint256' at index '0'
50:     function keccakGasCost(uint256 _length) internal pure returns (uint256) { 

/// @audit Parameter of type 'uint256' at index '0'
61:     function sha256GasCost(uint256 _length) internal pure returns (uint256) { 

70:     function sendL2ToL1Log( 
71:         bool _isService,
72:         bytes32 _key,
73:         bytes32 _value
74:     ) external onlyCallFromSystemContract returns (uint256 logIdInMerkleTree) {
75:         L2ToL1Log memory l2ToL1Log = L2ToL1Log({
76:             l2ShardId: 0,
77:             isService: _isService,
78:             txNumberInBlock: SYSTEM_CONTEXT_CONTRACT.txNumberInBlock(),
79:             sender: msg.sender,
80:             key: _key,
81:             value: _value
82:         });
83:         logIdInMerkleTree = _processL2ToL1Log(l2ToL1Log);
84: 
85:         // We need to charge cost of hashing, as it will be used in `publishPubdataAndClearState`:
86:         // - keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) and keccakGasCost(64) when reconstructing L2ToL1Log
87:         // - at most 1 time keccakGasCost(64) when building the Merkle tree (as merkle tree can contain
88:         // ~2*N nodes, where the first N nodes are leaves the hash of which is calculated on the previous step).
89:         uint256 gasToPay = keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) + 2 * keccakGasCost(64);
90:         SystemContractHelper.burnGas(Utils.safeCastToU32(gasToPay), 0);
91:     }

94:     function _processL2ToL1Log(L2ToL1Log memory _l2ToL1Log) internal returns (uint256 logIdInMerkleTree) { 
95:         bytes32 hashedLog = keccak256(
96:             abi.encodePacked(
97:                 _l2ToL1Log.l2ShardId,
98:                 _l2ToL1Log.isService,
99:                 _l2ToL1Log.txNumberInBlock,
100:                 _l2ToL1Log.sender,
101:                 _l2ToL1Log.key,
102:                 _l2ToL1Log.value
103:             )
104:         );
105: 
106:         chainedLogsHash = keccak256(abi.encode(chainedLogsHash, hashedLog));
107: 
108:         logIdInMerkleTree = numberOfLogsToProcess;
109:         numberOfLogsToProcess++;
110: 
111:         emit L2ToL1LogSent(_l2ToL1Log);
112:     }

116:     function sendToL1(bytes calldata _message) external override returns (bytes32 hash) { 
117:         uint256 gasBeforeMessageHashing = gasleft();
118:         hash = EfficientCall.keccak(_message);
119:         uint256 gasSpentOnMessageHashing = gasBeforeMessageHashing - gasleft();
120: 
121:         /// Store message record
122:         chainedMessagesHash = keccak256(abi.encode(chainedMessagesHash, hash));
123: 
124:         /// Store log record
125:         L2ToL1Log memory l2ToL1Log = L2ToL1Log({
126:             l2ShardId: 0,
127:             isService: true,
128:             txNumberInBlock: SYSTEM_CONTEXT_CONTRACT.txNumberInBlock(),
129:             sender: address(this),
130:             key: bytes32(uint256(uint160(msg.sender))),
131:             value: hash
132:         });
133:         _processL2ToL1Log(l2ToL1Log);
134: 
135:         // Get cost of one byte pubdata in gas from context.
136:         uint256 pubdataLen;
137:         unchecked {
138:             // 4 bytes used to encode the length of the message (see `publishPubdataAndClearState`)
139:             // L2_TO_L1_LOG_SERIALIZE_SIZE bytes used to encode L2ToL1Log
140:             pubdataLen = 4 + _message.length + L2_TO_L1_LOG_SERIALIZE_SIZE;
141:         }
142: 
143:         // We need to charge cost of hashing, as it will be used in `publishPubdataAndClearState`:
144:         // - keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) and keccakGasCost(64) when reconstructing L2ToL1Log
145:         // - keccakGasCost(64) and gasSpentOnMessageHashing when reconstructing Messages
146:         // - at most 1 time keccakGasCost(64) when building the Merkle tree (as merkle tree can contain
147:         // ~2*N nodes, where the first N nodes are leaves the hash of which is calculated on the previous step).
148:         uint256 gasToPay = keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) +
149:             3 *
150:             keccakGasCost(64) +
151:             gasSpentOnMessageHashing +
152:             COMPUTATIONAL_PRICE_FOR_PUBDATA *
153:             pubdataLen;
154:         SystemContractHelper.burnGas(Utils.safeCastToU32(gasToPay), uint32(pubdataLen));
155: 
156:         emit L1MessageSent(msg.sender, hash, _message);
157:     }
```
[50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L50), [61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L61), [70](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L70-L91), [94](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L94-L112), [116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L116-L157)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

/// @audit Parameter of type 'uint256' at index '0'
56:     function balanceOf(uint256 _account) external view override returns (uint256) { 

99:     function _burnMsgValue() internal returns (uint256 amount) { 
100:         amount = msg.value;
101: 
102:         // Silent burning of the ether
103:         unchecked {
104:             // This is safe, since this contract holds the ether balances, and if user
105:             // send a `msg.value` it will be added to the contract (`this`) balance.
106:             balance[address(this)] -= amount;
107:             totalSupply -= amount;
108:         }
109:     }

/// @audit Parameter of type 'bytes' at index '0'
112:     function _getL1WithdrawMessage(address _to, uint256 _amount) internal pure returns (bytes memory) { 

117:     function _getExtendedWithdrawMessage( 

/// @audit Parameter of type 'string' at index '0'
128:     function name() external pure override returns (string memory) { 

/// @audit Parameter of type 'string' at index '0'
134:     function symbol() external pure override returns (string memory) { 

/// @audit Parameter of type 'uint8' at index '0'
140:     function decimals() external pure override returns (uint8) { 
```
[56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L56), [99](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L99-L109), [112](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L112), [117](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L117), [128](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L128), [134](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L134), [140](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L140)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

25:     function _getAbiParams() internal view returns (uint256 value, bool isSystemCall, address to) { 
26:         value = SystemContractHelper.getExtraAbiData(0);
27:         uint256 addressAsUint = SystemContractHelper.getExtraAbiData(1);
28:         uint256 mask = SystemContractHelper.getExtraAbiData(2);
29: 
30:         isSystemCall = (mask & MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT) != 0;
31: 
32:         to = address(uint160(addressAsUint));
33:     }

/// @audit Parameter of type 'bytes' at index '0'
47:     fallback(bytes calldata _data) external onlySystemCall returns (bytes memory) { 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L25-L33), [47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L47)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

/// @audit Parameter of type 'uint256' at index '0'
46:     function getMinNonce(address _address) public view returns (uint256) { 

/// @audit Parameter of type 'uint256' at index '0'
57:     function getRawNonce(address _address) public view returns (uint256) { 

65:     function increaseMinNonce(uint256 _value) public onlySystemCall returns (uint256 oldMinNonce) { 
66:         require(_value <= MAXIMAL_MIN_NONCE_INCREMENT, "The value for incrementing the nonce is too high");
67: 
68:         uint256 addressAsKey = uint256(uint160(msg.sender));
69:         uint256 oldRawNonce = rawNonces[addressAsKey];
70: 
71:         unchecked {
72:             rawNonces[addressAsKey] = (oldRawNonce + _value);
73:         }
74: 
75:         (, oldMinNonce) = _splitRawNonce(oldRawNonce);
76:     }

/// @audit Parameter of type 'uint256' at index '0'
102:     function getValueUnderNonce(uint256 _key) public view returns (uint256) { 

125:     function getDeploymentNonce(address _address) external view returns (uint256 deploymentNonce) { 
126:         uint256 addressAsKey = uint256(uint160(_address));
127:         (deploymentNonce, ) = _splitRawNonce(rawNonces[addressAsKey]);
128: 
129:         return deploymentNonce;
130:     }

135:     function incrementDeploymentNonce(address _address) external returns (uint256 prevDeploymentNonce) { 
136:         require(
137:             msg.sender == address(DEPLOYER_SYSTEM_CONTRACT),
138:             "Only the contract deployer can increment the deployment nonce"
139:         );
140:         uint256 addressAsKey = uint256(uint160(_address));
141:         uint256 oldRawNonce = rawNonces[addressAsKey];
142: 
143:         unchecked {
144:             rawNonces[addressAsKey] = (oldRawNonce + DEPLOY_NONCE_MULTIPLIER);
145:         }
146: 
147:         (prevDeploymentNonce, ) = _splitRawNonce(oldRawNonce);
148:     }

/// @audit Parameter of type 'bool' at index '0'
154:     function isNonceUsed(address _address, uint256 _nonce) public view returns (bool) { 

179:     function _splitRawNonce(uint256 _rawMinNonce) internal pure returns (uint256 deploymentNonce, uint256 minNonce) { 
180:         deploymentNonce = _rawMinNonce / DEPLOY_NONCE_MULTIPLIER;
181:         minNonce = _rawMinNonce % DEPLOY_NONCE_MULTIPLIER;
182:     }
```
[46](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L46), [57](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L57), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L65-L76), [102](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L102), [125](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L125-L130), [135](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L135-L148), [154](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L154), [179](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L179-L182)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

/// @audit Parameter of type 'uint256' at index '0'
117:     function getCurrentPubdataSpent() public view returns (uint256) { 

/// @audit Parameter of type 'uint256' at index '0'
122:     function getCurrentPubdataCost() external view returns (uint256) { 

132:     function getBlockHashEVM(uint256 _block) external view returns (bytes32 hash) { 
133:         uint128 blockNumber = currentVirtualL2BlockInfo.number;
134: 
135:         VirtualBlockUpgradeInfo memory currentVirtualBlockUpgradeInfo = virtualBlockUpgradeInfo;
136: 
137:         // Due to virtual blocks upgrade, we'll have to use the following logic for retreiving the blockhash:
138:         // 1. If the block number is out of the 256-block supported range, return 0.
139:         // 2. If the block was created before the upgrade for the virtual blocks (i.e. there we used to use hashes of the batches),
140:         // we return the hash of the batch.
141:         // 3. If the block was created after the day when the virtual blocks have caught up with the L2 blocks, i.e.
142:         // all the information which is returned for users should be for L2 blocks, we return the hash of the corresponding L2 block.
143:         // 4. If the block queried is a virtual blocks, calculate it on the fly.
144:         if (blockNumber <= _block || blockNumber - _block > 256) {
145:             hash = bytes32(0);
146:         } else if (_block < currentVirtualBlockUpgradeInfo.virtualBlockStartBatch) {
147:             // Note, that we will get into this branch only for a brief moment of time, right after the upgrade
148:             // for virtual blocks before 256 virtual blocks are produced.
149:             hash = batchHashes[_block];
150:         } else if (
151:             _block >= currentVirtualBlockUpgradeInfo.virtualBlockFinishL2Block &&
152:             currentVirtualBlockUpgradeInfo.virtualBlockFinishL2Block > 0
153:         ) {
154:             hash = _getLatest257L2blockHash(_block);
155:         } else {
156:             // Important: we do not want this number to ever collide with the L2 block hash (either new or old one) and so
157:             // that's why the legacy L2 blocks' hashes are keccak256(abi.encodePacked(uint32(_block))), while these are equivalent to
158:             // keccak256(abi.encodePacked(_block))
159:             hash = keccak256(abi.encode(_block));
160:         }
161:     }

166:     function getBatchHash(uint256 _batchNumber) external view returns (bytes32 hash) { 
167:         hash = batchHashes[_batchNumber];
168:     }

172:     function getBatchNumberAndTimestamp() public view returns (uint128 batchNumber, uint128 batchTimestamp) { 
173:         BlockInfo memory batchInfo = currentBatchInfo;
174:         batchNumber = batchInfo.number;
175:         batchTimestamp = batchInfo.timestamp;
176:     }

180:     function getL2BlockNumberAndTimestamp() public view returns (uint128 blockNumber, uint128 blockTimestamp) { 
181:         BlockInfo memory blockInfo = currentL2BlockInfo;
182:         blockNumber = blockInfo.number;
183:         blockTimestamp = blockInfo.timestamp;
184:     }

/// @audit Parameter of type 'uint128' at index '0'
190:     function getBlockNumber() public view returns (uint128) { 

/// @audit Parameter of type 'uint128' at index '0'
198:     function getBlockTimestamp() public view returns (uint128) { 

/// @audit Parameter of type 'bytes32' at index '0'
205:     function _getLatest257L2blockHash(uint256 _block) internal view returns (bytes32) { 

221:     function _calculateL2BlockHash( 

/// @audit Parameter of type 'bytes32' at index '0'
233:     function _calculateLegacyL2BlockHash(uint128 _blockNumber) internal pure returns (bytes32) { 

496:     function currentBlockInfo() external view returns (uint256 blockInfo) { 
497:         (uint128 blockNumber, uint128 blockTimestamp) = getBatchNumberAndTimestamp();
498:         blockInfo = (uint256(blockNumber) << 128) | uint256(blockTimestamp);
499:     }

503:     function getBlockNumberAndTimestamp() external view returns (uint256 blockNumber, uint256 blockTimestamp) { 
504:         (blockNumber, blockTimestamp) = getBatchNumberAndTimestamp();
505:     }

509:     function blockHash(uint256 _blockNumber) external view returns (bytes32 hash) { 
510:         hash = batchHashes[_blockNumber];
511:     }
```
[117](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L117), [122](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L122), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L132-L161), [166](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L166-L168), [172](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L172-L176), [180](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L180-L184), [190](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L190), [198](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L198), [205](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L205), [221](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L221), [233](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L233), [496](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L496-L499), [503](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L503-L505), [509](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L509-L511)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IAccount.sol

20:     function validateTransaction( 
21:         bytes32 _txHash,
22:         bytes32 _suggestedSignedHash,
23:         Transaction calldata _transaction
24:     ) external payable returns (bytes4 magic);
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccount.sol#L20-L24)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IAccountCodeStorage.sol

12:     function getRawCodeHash(address _address) external view returns (bytes32 codeHash); 

14:     function getCodeHash(uint256 _input) external view returns (bytes32 codeHash); 

16:     function getCodeSize(uint256 _input) external view returns (uint256 codeSize); 
```
[12](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L12), [14](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L14), [16](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L16)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IBaseToken.sol

/// @audit Parameter of type 'uint256' at index '0'
6:     function balanceOf(uint256) external view returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
10:     function totalSupply() external view returns (uint256); 

/// @audit Parameter of type 'string' at index '0'
12:     function name() external pure returns (string memory); 

/// @audit Parameter of type 'string' at index '0'
14:     function symbol() external pure returns (string memory); 

/// @audit Parameter of type 'uint8' at index '0'
16:     function decimals() external pure returns (uint8); 
```
[6](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L6), [10](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L10), [12](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L12), [14](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L14), [16](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L16)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IBootloaderUtilities.sol

8:     function getTransactionHashes( 
9:         Transaction calldata _transaction
10:     ) external view returns (bytes32 txHash, bytes32 signedTxHash);
```
[8](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBootloaderUtilities.sol#L8-L10)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ICompressor.sol

19:     function publishCompressedBytecode( 
20:         bytes calldata _bytecode,
21:         bytes calldata _rawCompressedData
22:     ) external payable returns (bytes32 bytecodeHash);

24:     function verifyCompressedStateDiffs( 
25:         uint256 _numberOfStateDiffs,
26:         uint256 _enumerationIndexSize,
27:         bytes calldata _stateDiffs,
28:         bytes calldata _compressedStateDiffs
29:     ) external payable returns (bytes32 stateDiffHash);
```
[19](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ICompressor.sol#L19-L22), [24](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ICompressor.sol#L24-L29)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IContractDeployer.sol

43:     function getNewAddressCreate2( 
44:         address _sender,
45:         bytes32 _bytecodeHash,
46:         bytes32 _salt,
47:         bytes calldata _input
48:     ) external view returns (address newAddress);

50:     function getNewAddressCreate(address _sender, uint256 _senderNonce) external pure returns (address newAddress); 

52:     function create2( 
53:         bytes32 _salt,
54:         bytes32 _bytecodeHash,
55:         bytes calldata _input
56:     ) external payable returns (address newAddress);

58:     function create2Account( 
59:         bytes32 _salt,
60:         bytes32 _bytecodeHash,
61:         bytes calldata _input,
62:         AccountAbstractionVersion _aaVersion
63:     ) external payable returns (address newAddress);

68:     function create( 
69:         bytes32 _salt,
70:         bytes32 _bytecodeHash,
71:         bytes calldata _input
72:     ) external payable returns (address newAddress);

76:     function createAccount( 
77:         bytes32 _salt,
78:         bytes32 _bytecodeHash,
79:         bytes calldata _input,
80:         AccountAbstractionVersion _aaVersion
81:     ) external payable returns (address newAddress);

84:     function getAccountInfo(address _address) external view returns (AccountInfo memory info); 
```
[43](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L43-L48), [50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L50), [52](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L52-L56), [58](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L58-L63), [68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L68-L72), [76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L76-L81), [84](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L84)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IImmutableSimulator.sol

/// @audit Parameter of type 'bytes32' at index '0'
11:     function getImmutable(address _dest, uint256 _index) external view returns (bytes32); 
```
[11](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L11)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IKnownCodesStorage.sol

/// @audit Parameter of type 'uint256' at index '0'
18:     function getMarker(bytes32 _hash) external view returns (uint256); 
```
[18](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IKnownCodesStorage.sol#L18)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IL1Messenger.sol

/// @audit Parameter of type 'bytes32' at index '0'
49:     function sendToL1(bytes memory _message) external returns (bytes32); 

51:     function sendL2ToL1Log(bool _isService, bytes32 _key, bytes32 _value) external returns (uint256 logIdInMerkleTree); 
```
[49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L49), [51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L51)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IL2StandardToken.sol

/// @audit Parameter of type 'address' at index '0'
14:     function l1Address() external view returns (address); 

/// @audit Parameter of type 'address' at index '0'
16:     function l2Bridge() external view returns (address); 
```
[14](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L14), [16](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L16)

```solidity
üìÅ File: system-contracts/contracts/interfaces/INonceHolder.sol

/// @audit Parameter of type 'uint256' at index '0'
17:     function getMinNonce(address _address) external view returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
21:     function getRawNonce(address _address) external view returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
24:     function increaseMinNonce(uint256 _value) external returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
30:     function getValueUnderNonce(uint256 _key) external view returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
37:     function getDeploymentNonce(address _address) external view returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
40:     function incrementDeploymentNonce(address _address) external returns (uint256); 

/// @audit Parameter of type 'bool' at index '0'
46:     function isNonceUsed(address _address, uint256 _nonce) external view returns (bool); 
```
[17](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L17), [21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L21), [24](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L24), [30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L30), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L37), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L40), [46](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L46)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IPaymaster.sol

28:     function validateAndPayForPaymasterTransaction( 
29:         bytes32 _txHash,
30:         bytes32 _suggestedSignedHash,
31:         Transaction calldata _transaction
32:     ) external payable returns (bytes4 magic, bytes memory context);
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L28-L32)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContext.sol

/// @audit Parameter of type 'uint256' at index '0'
30:     function chainId() external view returns (uint256); 

/// @audit Parameter of type 'address' at index '0'
32:     function origin() external view returns (address); 

/// @audit Parameter of type 'uint256' at index '0'
34:     function gasPrice() external view returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
36:     function blockGasLimit() external view returns (uint256); 

/// @audit Parameter of type 'address' at index '0'
38:     function coinbase() external view returns (address); 

/// @audit Parameter of type 'uint256' at index '0'
40:     function difficulty() external view returns (uint256); 

/// @audit Parameter of type 'uint256' at index '0'
42:     function baseFee() external view returns (uint256); 

/// @audit Parameter of type 'uint16' at index '0'
44:     function txNumberInBlock() external view returns (uint16); 

/// @audit Parameter of type 'bytes32' at index '0'
46:     function getBlockHashEVM(uint256 _block) external view returns (bytes32); 

48:     function getBatchHash(uint256 _batchNumber) external view returns (bytes32 hash); 

/// @audit Parameter of type 'uint128' at index '0'
50:     function getBlockNumber() external view returns (uint128); 

/// @audit Parameter of type 'uint128' at index '0'
52:     function getBlockTimestamp() external view returns (uint128); 

54:     function getBatchNumberAndTimestamp() external view returns (uint128 blockNumber, uint128 blockTimestamp); 

56:     function getL2BlockNumberAndTimestamp() external view returns (uint128 blockNumber, uint128 blockTimestamp); 

58:     function gasPerPubdataByte() external view returns (uint256 gasPerPubdataByte); 

60:     function getCurrentPubdataSpent() external view returns (uint256 currentPubdataSpent); 
```
[30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L30), [32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L32), [34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L34), [36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L36), [38](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L38), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L40), [42](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L42), [44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L44), [46](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L46), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L48), [50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L50), [52](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L52), [54](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L54), [56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L56), [58](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L58), [60](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L60)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContextDeprecated.sol

/// @audit Parameter of type 'uint256' at index '0'
11:     function currentBlockInfo() external view returns (uint256); 

13:     function getBlockNumberAndTimestamp() external view returns (uint256 blockNumber, uint256 blockTimestamp); 

15:     function blockHash(uint256 _blockNumber) external view returns (bytes32 hash); 
```
[11](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContextDeprecated.sol#L11), [13](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContextDeprecated.sol#L13), [15](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContextDeprecated.sol#L15)

```solidity
üìÅ File: system-contracts/contracts/libraries/EfficientCall.sol

/// @audit Parameter of type 'bytes32' at index '0'
36:     function keccak(bytes calldata _data) internal view returns (bytes32) { 

/// @audit Parameter of type 'bytes32' at index '0'
45:     function sha(bytes calldata _data) internal view returns (bytes32) { 

58:     function call( 
59:         uint256 _gas,
60:         address _address,
61:         uint256 _value,
62:         bytes calldata _data,
63:         bool _isSystem
64:     ) internal returns (bytes memory returnData) {
65:         bool success = rawCall(_gas, _address, _value, _data, _isSystem);
66:         returnData = _verifyCallResult(success);
67:     }

74:     function staticCall( 
75:         uint256 _gas,
76:         address _address,
77:         bytes calldata _data
78:     ) internal view returns (bytes memory returnData) {
79:         bool success = rawStaticCall(_gas, _address, _data);
80:         returnData = _verifyCallResult(success);
81:     }

88:     function delegateCall( 
89:         uint256 _gas,
90:         address _address,
91:         bytes calldata _data
92:     ) internal returns (bytes memory returnData) {
93:         bool success = rawDelegateCall(_gas, _address, _data);
94:         returnData = _verifyCallResult(success);
95:     }

105:     function mimicCall( 
106:         uint256 _gas,
107:         address _address,
108:         bytes calldata _data,
109:         address _whoToMimic,
110:         bool _isConstructor,
111:         bool _isSystem
112:     ) internal returns (bytes memory returnData) {
113:         bool success = rawMimicCall(_gas, _address, _data, _whoToMimic, _isConstructor, _isSystem);
114:         returnData = _verifyCallResult(success);
115:     }

124:     function rawCall( 
125:         uint256 _gas,
126:         address _address,
127:         uint256 _value,
128:         bytes calldata _data,
129:         bool _isSystem
130:     ) internal returns (bool success) {
131:         if (_value == 0) {
132:             _loadFarCallABIIntoActivePtr(_gas, _data, false, _isSystem);
133: 
134:             address callAddr = RAW_FAR_CALL_BY_REF_CALL_ADDRESS;
135:             assembly {
136:                 success := call(_address, callAddr, 0, 0, 0xFFFF, 0, 0)
137:             }
138:         } else {
139:             _loadFarCallABIIntoActivePtr(_gas, _data, false, true);
140: 
141:             // If there is provided `msg.value` call the `MsgValueSimulator` to forward ether.
142:             address msgValueSimulator = MSG_VALUE_SYSTEM_CONTRACT;
143:             address callAddr = SYSTEM_CALL_BY_REF_CALL_ADDRESS;
144:             // We need to supply the mask to the MsgValueSimulator to denote
145:             // that the call should be a system one.
146:             uint256 forwardMask = _isSystem ? MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT : 0;
147: 
148:             assembly {
149:                 success := call(msgValueSimulator, callAddr, _value, _address, 0xFFFF, forwardMask, 0)
150:             }
151:         }
152:     }

159:     function rawStaticCall(uint256 _gas, address _address, bytes calldata _data) internal view returns (bool success) { 
160:         _loadFarCallABIIntoActivePtr(_gas, _data, false, false);
161: 
162:         address callAddr = RAW_FAR_CALL_BY_REF_CALL_ADDRESS;
163:         assembly {
164:             success := staticcall(_address, callAddr, 0, 0xFFFF, 0, 0)
165:         }
166:     }

173:     function rawDelegateCall(uint256 _gas, address _address, bytes calldata _data) internal returns (bool success) { 
174:         _loadFarCallABIIntoActivePtr(_gas, _data, false, false);
175: 
176:         address callAddr = RAW_FAR_CALL_BY_REF_CALL_ADDRESS;
177:         assembly {
178:             success := delegatecall(_address, callAddr, 0, 0xFFFF, 0, 0)
179:         }
180:     }

191:     function rawMimicCall( 
192:         uint256 _gas,
193:         address _address,
194:         bytes calldata _data,
195:         address _whoToMimic,
196:         bool _isConstructor,
197:         bool _isSystem
198:     ) internal returns (bool success) {
199:         _loadFarCallABIIntoActivePtr(_gas, _data, _isConstructor, _isSystem);
200: 
201:         address callAddr = MIMIC_CALL_BY_REF_CALL_ADDRESS;
202:         uint256 cleanupMask = ADDRESS_MASK;
203:         assembly {
204:             // Clearing values before usage in assembly, since Solidity
205:             // doesn't do it by default
206:             _whoToMimic := and(_whoToMimic, cleanupMask)
207: 
208:             success := call(_address, callAddr, 0, 0, _whoToMimic, 0, 0)
209:         }
210:     }

215:     function _verifyCallResult(bool _success) private pure returns (bytes memory returnData) { 
216:         if (_success) {
217:             uint256 size;
218:             assembly {
219:                 size := returndatasize()
220:             }
221: 
222:             returnData = new bytes(size);
223:             assembly {
224:                 returndatacopy(add(returnData, 0x20), 0, size)
225:             }
226:         } else {
227:             propagateRevert();
228:         }
229:     }
```
[36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L36), [45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L45), [58](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L58-L67), [74](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L74-L81), [88](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L88-L95), [105](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L105-L115), [124](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L124-L152), [159](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L159-L166), [173](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L173-L180), [191](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L191-L210), [215](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L215-L229)

```solidity
üìÅ File: system-contracts/contracts/libraries/RLPEncoder.sol

11:     function encodeAddress(address _val) internal pure returns (bytes memory encoded) { 
12:         // The size is equal to 20 bytes of the address itself + 1 for encoding bytes length in RLP.
13:         encoded = new bytes(0x15);
14: 
15:         bytes20 shiftedVal = bytes20(_val);
16:         assembly {
17:             // In the first byte we write the encoded length as 0x80 + 0x14 == 0x94.
18:             mstore(add(encoded, 0x20), 0x9400000000000000000000000000000000000000000000000000000000000000)
19:             // Write address data without stripping zeros.
20:             mstore(add(encoded, 0x21), shiftedVal)
21:         }
22:     }

24:     function encodeUint256(uint256 _val) internal pure returns (bytes memory encoded) { 
25:         unchecked {
26:             if (_val < 128) {
27:                 encoded = new bytes(1);
28:                 // Handle zero as a non-value, since stripping zeroes results in an empty byte array
29:                 encoded[0] = (_val == 0) ? bytes1(uint8(128)) : bytes1(uint8(_val));
30:             } else {
31:                 uint256 hbs = _highestByteSet(_val);
32: 
33:                 encoded = new bytes(hbs + 2);
34:                 encoded[0] = bytes1(uint8(hbs + 0x81));
35: 
36:                 uint256 lbs = 31 - hbs;
37:                 uint256 shiftedVal = _val << (lbs * 8);
38: 
39:                 assembly {
40:                     mstore(add(encoded, 0x21), shiftedVal)
41:                 }
42:             }
43:         }
44:     }

/// @audit Parameter of type 'bytes' at index '0'
49:     function encodeNonSingleBytesLen(uint64 _len) internal pure returns (bytes memory) { 

/// @audit Parameter of type 'bytes' at index '0'
56:     function encodeListLen(uint64 _len) internal pure returns (bytes memory) { 

60:     function _encodeLength(uint64 _len, uint256 _offset) private pure returns (bytes memory encoded) { 
61:         unchecked {
62:             if (_len < 56) {
63:                 encoded = new bytes(1);
64:                 encoded[0] = bytes1(uint8(_len + _offset));
65:             } else {
66:                 uint256 hbs = _highestByteSet(uint256(_len));
67: 
68:                 encoded = new bytes(hbs + 2);
69:                 encoded[0] = bytes1(uint8(_offset + hbs + 56));
70: 
71:                 uint256 lbs = 31 - hbs;
72:                 uint256 shiftedVal = uint256(_len) << (lbs * 8);
73: 
74:                 assembly {
75:                     mstore(add(encoded, 0x21), shiftedVal)
76:                 }
77:             }
78:         }
79:     }

84:     function _highestByteSet(uint256 _number) private pure returns (uint256 hbs) { 
85:         unchecked {
86:             if (_number > type(uint128).max) {
87:                 _number >>= 128;
88:                 hbs += 16;
89:             }
90:             if (_number > type(uint64).max) {
91:                 _number >>= 64;
92:                 hbs += 8;
93:             }
94:             if (_number > type(uint32).max) {
95:                 _number >>= 32;
96:                 hbs += 4;
97:             }
98:             if (_number > type(uint16).max) {
99:                 _number >>= 16;
100:                 hbs += 2;
101:             }
102:             if (_number > type(uint8).max) {
103:                 hbs += 1;
104:             }
105:         }
106:     }
```
[11](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L11-L22), [24](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L24-L44), [49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L49), [56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L56), [60](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L60-L79), [84](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L84-L106)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractHelper.sol

63:     function getCodeAddress() internal view returns (address addr) { 
64:         address callAddr = CODE_ADDRESS_CALL_ADDRESS;
65:         assembly {
66:             addr := staticcall(0, callAddr, 0, 0xFFFF, 0, 0)
67:         }
68:     }

124:     function packPrecompileParams( 
125:         uint32 _inputMemoryOffset,
126:         uint32 _inputMemoryLength,
127:         uint32 _outputMemoryOffset,
128:         uint32 _outputMemoryLength,
129:         uint64 _perPrecompileInterpreted
130:     ) internal pure returns (uint256 rawParams) {
131:         rawParams = _inputMemoryOffset;
132:         rawParams |= uint256(_inputMemoryLength) << 32;
133:         rawParams |= uint256(_outputMemoryOffset) << 64;
134:         rawParams |= uint256(_outputMemoryLength) << 96;
135:         rawParams |= uint256(_perPrecompileInterpreted) << 192;
136:     }

148:     function unsafePrecompileCall( 
149:         uint256 _rawParams,
150:         uint32 _gasToBurn,
151:         uint32 _pubdataToSpend
152:     ) internal view returns (bool success) {
153:         address callAddr = PRECOMPILE_CALL_ADDRESS;
154: 
155:         uint256 params = uint256(_gasToBurn) + (uint256(_pubdataToSpend) << 32);
156: 
157:         uint256 cleanupMask = UINT64_MASK;
158:         assembly {
159:             // Clearing input params as they are not cleaned by Solidity by default
160:             params := and(params, cleanupMask)
161:             success := staticcall(_rawParams, callAddr, params, 0xFFFF, 0, 0)
162:         }
163:     }

168:     function setValueForNextFarCall(uint128 _value) internal returns (bool success) { 
169:         uint256 cleanupMask = UINT128_MASK;
170:         address callAddr = SET_CONTEXT_VALUE_CALL_ADDRESS;
171:         assembly {
172:             // Clearing input params as they are not cleaned by Solidity by default
173:             _value := and(_value, cleanupMask)
174:             success := call(0, callAddr, _value, 0, 0xFFFF, 0, 0)
175:         }
176:     }

203:     function getZkSyncMetaBytes() internal view returns (uint256 meta) { 
204:         address callAddr = META_CALL_ADDRESS;
205:         assembly {
206:             meta := staticcall(0, callAddr, 0, 0xFFFF, 0, 0)
207:         }
208:     }

215:     function extractNumberFromMeta(uint256 meta, uint256 offset, uint256 size) internal pure returns (uint256 result) { 
216:         // Firstly, we delete all the bits after the field
217:         uint256 shifted = (meta << (256 - size - offset));
218:         // Then we shift everything back
219:         result = (shifted >> (256 - size));
220:     }

227:     function getPubdataPublishedFromMeta(uint256 meta) internal pure returns (uint32 pubdataPublished) { 
228:         pubdataPublished = uint32(extractNumberFromMeta(meta, META_GAS_PER_PUBDATA_BYTE_OFFSET, 32));
229:     }

237:     function getHeapSizeFromMeta(uint256 meta) internal pure returns (uint32 heapSize) { 
238:         heapSize = uint32(extractNumberFromMeta(meta, META_HEAP_SIZE_OFFSET, 32));
239:     }

246:     function getAuxHeapSizeFromMeta(uint256 meta) internal pure returns (uint32 auxHeapSize) { 
247:         auxHeapSize = uint32(extractNumberFromMeta(meta, META_AUX_HEAP_SIZE_OFFSET, 32));
248:     }

254:     function getShardIdFromMeta(uint256 meta) internal pure returns (uint8 shardId) { 
255:         shardId = uint8(extractNumberFromMeta(meta, META_SHARD_ID_OFFSET, 8));
256:     }

263:     function getCallerShardIdFromMeta(uint256 meta) internal pure returns (uint8 callerShardId) { 
264:         callerShardId = uint8(extractNumberFromMeta(meta, META_CALLER_SHARD_ID_OFFSET, 8));
265:     }

272:     function getCodeShardIdFromMeta(uint256 meta) internal pure returns (uint8 codeShardId) { 
273:         codeShardId = uint8(extractNumberFromMeta(meta, META_CODE_SHARD_ID_OFFSET, 8));
274:     }

279:     function getZkSyncMeta() internal view returns (ZkSyncMeta memory meta) { 
280:         uint256 metaPacked = getZkSyncMetaBytes();
281:         meta.pubdataPublished = getPubdataPublishedFromMeta(metaPacked);
282:         meta.heapSize = getHeapSizeFromMeta(metaPacked);
283:         meta.auxHeapSize = getAuxHeapSizeFromMeta(metaPacked);
284:         meta.shardId = getShardIdFromMeta(metaPacked);
285:         meta.callerShardId = getCallerShardIdFromMeta(metaPacked);
286:         meta.codeShardId = getCodeShardIdFromMeta(metaPacked);
287:     }

296:     function getCallFlags() internal view returns (uint256 callFlags) { 
297:         address callAddr = CALLFLAGS_CALL_ADDRESS;
298:         assembly {
299:             callFlags := staticcall(0, callAddr, 0, 0xFFFF, 0, 0)
300:         }
301:     }

307:     function getCalldataPtr() internal view returns (uint256 ptr) { 
308:         address callAddr = PTR_CALLDATA_CALL_ADDRESS;
309:         assembly {
310:             ptr := staticcall(0, callAddr, 0, 0xFFFF, 0, 0)
311:         }
312:     }

318:     function getExtraAbiData(uint256 index) internal view returns (uint256 extraAbiData) { 
319:         require(index < 10, "There are only 10 accessible registers");
320: 
321:         address callAddr = GET_EXTRA_ABI_DATA_ADDRESS;
322:         assembly {
323:             extraAbiData := staticcall(index, callAddr, 0, 0xFFFF, 0, 0)
324:         }
325:     }

/// @audit Parameter of type 'bool' at index '0'
329:     function isSystemCall() internal view returns (bool) { 

/// @audit Parameter of type 'bool' at index '0'
338:     function isSystemContract(address _address) internal pure returns (bool) { 
```
[63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L63-L68), [124](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L124-L136), [148](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L148-L163), [168](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L168-L176), [203](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L203-L208), [215](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L215-L220), [227](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L227-L229), [237](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L237-L239), [246](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L246-L248), [254](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L254-L256), [263](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L263-L265), [272](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L272-L274), [279](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L279-L287), [296](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L296-L301), [307](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L307-L312), [318](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L318-L325), [329](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L329), [338](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L338)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractsCaller.sol

76:     function systemCall(uint32 gasLimit, address to, uint256 value, bytes memory data) internal returns (bool success) { 
77:         address callAddr = SYSTEM_CALL_CALL_ADDRESS;
78: 
79:         uint32 dataStart;
80:         assembly {
81:             dataStart := add(data, 0x20)
82:         }
83:         uint32 dataLength = uint32(Utils.safeCastToU32(data.length));
84: 
85:         uint256 farCallAbi = SystemContractsCaller.getFarCallABI(
86:             0,
87:             0,
88:             dataStart,
89:             dataLength,
90:             gasLimit,
91:             // Only rollup is supported for now
92:             0,
93:             CalldataForwardingMode.UseHeap,
94:             false,
95:             true
96:         );
97: 
98:         if (value == 0) {
99:             // Doing the system call directly
100:             assembly {
101:                 success := call(to, callAddr, 0, 0, farCallAbi, 0, 0)
102:             }
103:         } else {
104:             address msgValueSimulator = MSG_VALUE_SYSTEM_CONTRACT;
105:             // We need to supply the mask to the MsgValueSimulator to denote
106:             // that the call should be a system one.
107:             uint256 forwardMask = MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT;
108: 
109:             assembly {
110:                 success := call(msgValueSimulator, callAddr, value, to, farCallAbi, forwardMask, 0)
111:             }
112:         }
113:     }

123:     function systemCallWithReturndata( 
124:         uint32 gasLimit,
125:         address to,
126:         uint128 value,
127:         bytes memory data
128:     ) internal returns (bool success, bytes memory returnData) {
129:         success = systemCall(gasLimit, to, value, data);
130: 
131:         uint256 size;
132:         assembly {
133:             size := returndatasize()
134:         }
135: 
136:         returnData = new bytes(size);
137:         assembly {
138:             returndatacopy(add(returnData, 0x20), 0, size)
139:         }
140:     }

150:     function systemCallWithPropagatedRevert( 
151:         uint32 gasLimit,
152:         address to,
153:         uint128 value,
154:         bytes memory data
155:     ) internal returns (bytes memory returnData) {
156:         bool success;
157:         (success, returnData) = systemCallWithReturndata(gasLimit, to, value, data);
158: 
159:         if (!success) {
160:             assembly {
161:                 let size := mload(returnData)
162:                 revert(add(returnData, 0x20), size)
163:             }
164:         }
165:     }

214:     function getFarCallABI( 
215:         uint32 dataOffset,
216:         uint32 memoryPage,
217:         uint32 dataStart,
218:         uint32 dataLength,
219:         uint32 gasPassed,
220:         uint8 shardId,
221:         CalldataForwardingMode forwardingMode,
222:         bool isConstructorCall,
223:         bool isSystemCall
224:     ) internal pure returns (uint256 farCallAbi) {
225:         // Fill in the call parameter fields
226:         farCallAbi = getFarCallABIWithEmptyFatPointer(
227:             gasPassed,
228:             shardId,
229:             forwardingMode,
230:             isConstructorCall,
231:             isSystemCall
232:         );
233:         // Fill in the fat pointer fields
234:         farCallAbi |= dataOffset;
235:         farCallAbi |= (uint256(memoryPage) << 32);
236:         farCallAbi |= (uint256(dataStart) << 64);
237:         farCallAbi |= (uint256(dataLength) << 96);
238:     }

250:     function getFarCallABIWithEmptyFatPointer( 
251:         uint32 gasPassed,
252:         uint8 shardId,
253:         CalldataForwardingMode forwardingMode,
254:         bool isConstructorCall,
255:         bool isSystemCall
256:     ) internal pure returns (uint256 farCallAbiWithEmptyFatPtr) {
257:         farCallAbiWithEmptyFatPtr |= (uint256(gasPassed) << 192);
258:         farCallAbiWithEmptyFatPtr |= (uint256(forwardingMode) << 224);
259:         farCallAbiWithEmptyFatPtr |= (uint256(shardId) << 232);
260:         if (isConstructorCall) {
261:             farCallAbiWithEmptyFatPtr |= (1 << 240);
262:         }
263:         if (isSystemCall) {
264:             farCallAbiWithEmptyFatPtr |= (1 << 248);
265:         }
266:     }
```
[76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L76-L113), [123](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L123-L140), [150](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L150-L165), [214](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L214-L238), [250](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L250-L266)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

/// @audit Parameter of type 'bool' at index '0'
94:     function isEthToken(uint256 _addr) internal pure returns (bool) { 

100:     function encodeHash(Transaction calldata _transaction) internal view returns (bytes32 resultHash) { 
101:         if (_transaction.txType == LEGACY_TX_TYPE) {
102:             resultHash = _encodeHashLegacyTransaction(_transaction);
103:         } else if (_transaction.txType == EIP_712_TX_TYPE) {
104:             resultHash = _encodeHashEIP712Transaction(_transaction);
105:         } else if (_transaction.txType == EIP_1559_TX_TYPE) {
106:             resultHash = _encodeHashEIP1559Transaction(_transaction);
107:         } else if (_transaction.txType == EIP_2930_TX_TYPE) {
108:             resultHash = _encodeHashEIP2930Transaction(_transaction);
109:         } else {
110:             // Currently no other transaction types are supported.
111:             // Any new transaction types will be processed in a similar manner.
112:             revert("Encoding unsupported tx");
113:         }
114:     }

/// @audit Parameter of type 'bytes32' at index '0'
118:     function _encodeHashEIP712Transaction(Transaction calldata _transaction) private view returns (bytes32) { 

/// @audit Parameter of type 'bytes32' at index '0'
147:     function _encodeHashLegacyTransaction(Transaction calldata _transaction) private view returns (bytes32) { 

/// @audit Parameter of type 'bytes32' at index '0'
219:     function _encodeHashEIP2930Transaction(Transaction calldata _transaction) private view returns (bytes32) { 

/// @audit Parameter of type 'bytes32' at index '0'
289:     function _encodeHashEIP1559Transaction(Transaction calldata _transaction) private view returns (bytes32) { 

395:     function payToTheBootloader(Transaction calldata _transaction) internal returns (bool success) { 
396:         address bootloaderAddr = BOOTLOADER_FORMAL_ADDRESS;
397:         uint256 amount = _transaction.maxFeePerGas * _transaction.gasLimit;
398: 
399:         assembly {
400:             success := call(gas(), bootloaderAddr, amount, 0, 0, 0, 0)
401:         }
402:     }

405:     function totalRequiredBalance(Transaction calldata _transaction) internal pure returns (uint256 requiredBalance) { 
406:         if (address(uint160(_transaction.paymaster)) != address(0)) {
407:             // Paymaster pays for the fee
408:             requiredBalance = _transaction.value;
409:         } else {
410:             // The user should have enough balance for both the fee and the value of the transaction
411:             requiredBalance = _transaction.maxFeePerGas * _transaction.gasLimit + _transaction.value;
412:         }
413:     }
```
[94](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L94), [100](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L100-L114), [118](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L118), [147](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L147), [219](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L219), [289](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L289), [395](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L395-L402), [405](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L405-L413)

```solidity
üìÅ File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol

19:     function readUint16(bytes calldata _bytes, uint256 _start) internal pure returns (uint16 result) { 
20:         assembly {
21:             let offset := sub(_bytes.offset, 30)
22:             result := calldataload(add(offset, _start))
23:         }
24:     }

26:     function readUint32(bytes calldata _bytes, uint256 _start) internal pure returns (uint32 result) { 
27:         assembly {
28:             let offset := sub(_bytes.offset, 28)
29:             result := calldataload(add(offset, _start))
30:         }
31:     }

33:     function readUint64(bytes calldata _bytes, uint256 _start) internal pure returns (uint64 result) { 
34:         assembly {
35:             let offset := sub(_bytes.offset, 24)
36:             result := calldataload(add(offset, _start))
37:         }
38:     }

40:     function readBytes32(bytes calldata _bytes, uint256 _start) internal pure returns (bytes32 result) { 
41:         assembly {
42:             result := calldataload(add(_bytes.offset, _start))
43:         }
44:     }

46:     function readUint256(bytes calldata _bytes, uint256 _start) internal pure returns (uint256 result) { 
47:         assembly {
48:             result := calldataload(add(_bytes.offset, _start))
49:         }
50:     }
```
[19](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L19-L24), [26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L26-L31), [33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L33-L38), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L40-L44), [46](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L46-L50)

```solidity
üìÅ File: system-contracts/contracts/libraries/Utils.sol

/// @audit Parameter of type 'uint128' at index '0'
20:     function safeCastToU128(uint256 _x) internal pure returns (uint128) { 

/// @audit Parameter of type 'uint32' at index '0'
26:     function safeCastToU32(uint256 _x) internal pure returns (uint32) { 

/// @audit Parameter of type 'uint24' at index '0'
32:     function safeCastToU24(uint256 _x) internal pure returns (uint24) { 

39:     function bytecodeLenInBytes(bytes32 _bytecodeHash) internal pure returns (uint256 codeLength) { 
40:         codeLength = bytecodeLenInWords(_bytecodeHash) << 5; // _bytecodeHash * 32
41:     }

44:     function bytecodeLenInWords(bytes32 _bytecodeHash) internal pure returns (uint256 codeLengthInWords) { 
45:         unchecked {
46:             codeLengthInWords = uint256(uint8(_bytecodeHash[2])) * 256 + uint256(uint8(_bytecodeHash[3]));
47:         }
48:     }

/// @audit Parameter of type 'bool' at index '0'
51:     function isContractConstructed(bytes32 _bytecodeHash) internal pure returns (bool) { 

/// @audit Parameter of type 'bool' at index '0'
56:     function isContractConstructing(bytes32 _bytecodeHash) internal pure returns (bool) { 

/// @audit Parameter of type 'bytes32' at index '0'
63:     function constructingBytecodeHash(bytes32 _bytecodeHash) internal pure returns (bytes32) { 

/// @audit Parameter of type 'bytes32' at index '0'
71:     function constructedBytecodeHash(bytes32 _bytecodeHash) internal pure returns (bytes32) { 

82:     function hashL2Bytecode(bytes calldata _bytecode) internal view returns (bytes32 hashedBytecode) { 
83:         // Note that the length of the bytecode must be provided in 32-byte words.
84:         require(_bytecode.length % 32 == 0, "po");
85: 
86:         uint256 lengthInWords = _bytecode.length / 32;
87:         require(lengthInWords < 2 ** 16, "pp"); // bytecode length must be less than 2^16 words
88:         require(lengthInWords % 2 == 1, "pr"); // bytecode length in words must be odd
89:         hashedBytecode =
90:             EfficientCall.sha(_bytecode) &
91:             0x00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;
92:         // Setting the version of the hash
93:         hashedBytecode = (hashedBytecode | bytes32(uint256(1 << 248)));
94:         // Setting the length
95:         hashedBytecode = hashedBytecode | bytes32(lengthInWords << 224);
96:     }
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L20), [26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L26), [32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L32), [39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L39-L41), [44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L44-L48), [51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L51), [56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L56), [63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L63), [71](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L71), [82](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L82-L96)

</details>


---
### [GAS&#x2011;52] Only emit event in setter function if the state variable was changed
Emitting events in setter functions of smart contracts only when state variables change saves gas. This is because emitting events consumes gas, and unnecessary events, where no actual state change occurs, lead to wasteful consumption.

<details>
<summary><i>There are 5 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

/// @audit NewPendingAdmin
51:     function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin { 
52:         // Save previous value into the stack to put it into the event later
53:         address oldPendingAdmin = pendingAdmin;
54:         // Change pending admin
55:         pendingAdmin = _newPendingAdmin;
56:         emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
57:     }
```
[51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L51-L57)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

/// @audit ChangeMinDelay
249:     function updateDelay(uint256 _newDelay) external onlySelf { 
250:         emit ChangeMinDelay(minDelay, _newDelay);
251:         minDelay = _newDelay;
252:     }

/// @audit ChangeSecurityCouncil
256:     function updateSecurityCouncil(address _newSecurityCouncil) external onlySelf { 
257:         emit ChangeSecurityCouncil(securityCouncil, _newSecurityCouncil);
258:         securityCouncil = _newSecurityCouncil;
259:     }
```
[249](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L249-L252), [256](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L256-L259)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

/// @audit NewPendingAdmin
110:     function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin { 
111:         // Save previous value into the stack to put it into the event later
112:         address oldPendingAdmin = pendingAdmin;
113:         // Change pending admin
114:         pendingAdmin = _newPendingAdmin;
115:         emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
116:     }
```
[110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L110-L116)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

/// @audit NewExecutionDelay
96:     function setExecutionDelay(uint32 _executionDelay) external onlyOwner { 
97:         executionDelay = _executionDelay;
98:         emit NewExecutionDelay(_executionDelay);
99:     }
```
[96](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L96-L99)

</details>


---
### [GAS&#x2011;53] Optimize Deployment Size by Fine-tuning IPFS Hash
The Solidity compiler appends 53 bytes of metadata to the smart contract code, incurring an extra cost of 10,600 gas. This additional expense arises from 200 gas per bytecode, plus calldata cost, which amounts to 16 gas for non-zero bytes and 4 gas for zero bytes. This results in a maximum of 848 extra gas in calldata cost.

Reducing this cost is crucial for the following reasons:

The metadata's 53-byte addition leads to a deployment cost increase of 10,600 gas.
It can also result in an additional calldata cost of up to 848 gas.
Ways to Minimize Gas Consumption:

Employ the `--no-cbor-metadata` compiler option to exclude metadata. Be cautious as this might impact contract verification.
Search for code comments that yield an IPFS hash with more zeros, thereby reducing calldata costs.


Gas saved per Instance: ~10,600 *(Total: ~1,113,000)*
<details>
<summary><i>There are 105 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL2Bridge.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: Apache-2.0 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IWETH9.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/common/Config.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/Config.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/common/L2ContractAddresses.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/L2ContractAddresses.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/common/Messaging.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/Messaging.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/common/ReentrancyGuard.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/UncheckedMath.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UncheckedMath.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UnsafeBytes.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/IGovernance.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/IStateTransitionManager.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IDiamondInit.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/ILegacyGetters.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IVerifier.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransition.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: UNLICENSED 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IZkSyncStateTransitionBase.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: UNLICENSED 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/l2-deps/ISystemContext.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/LibMap.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/DefaultUpgrade.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/GenesisUpgrade.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/IDefaultUpgrade.sol#L1)

```solidity
üìÅ File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: Apache-2.0 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L1)

```solidity
üìÅ File: contracts/zksync/contracts/ForceDeployUpgrader.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT OR Apache-2.0 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/ForceDeployUpgrader.sol#L1)

```solidity
üìÅ File: contracts/zksync/contracts/L2ContractHelper.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L1)

```solidity
üìÅ File: contracts/zksync/contracts/SystemContractsCaller.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L1)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L1)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L1)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L1)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL1SharedBridge.sol#L1)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2SharedBridge.sol#L1)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/interfaces/IL2StandardToken.sol#L1)

```solidity
üìÅ File: contracts/zksync/contracts/interfaces/IPaymaster.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymaster.sol#L1)

```solidity
üìÅ File: contracts/zksync/contracts/interfaces/IPaymasterFlow.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymasterFlow.sol#L1)

```solidity
üìÅ File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: Apache-2.0 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/BootloaderUtilities.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/ComplexUpgrader.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/Constants.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/EmptyContract.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/EmptyContract.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/GasBoundCaller.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/PubdataChunkPublisher.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IAccount.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccount.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IAccountCodeStorage.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IAccountCodeStorage.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IBaseToken.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBaseToken.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IBootloaderUtilities.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IBootloaderUtilities.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IComplexUpgrader.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IComplexUpgrader.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ICompressor.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ICompressor.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IContractDeployer.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IImmutableSimulator.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IImmutableSimulator.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IKnownCodesStorage.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IKnownCodesStorage.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IL1Messenger.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IL2StandardToken.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL2StandardToken.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IMailbox.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IMailbox.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/INonceHolder.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/INonceHolder.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IPaymaster.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IPaymasterFlow.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymasterFlow.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IPubdataChunkPublisher.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPubdataChunkPublisher.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContext.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContextDeprecated.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContextDeprecated.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContract.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/libraries/EfficientCall.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/libraries/RLPEncoder.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractHelper.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractsCaller.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/libraries/UnsafeBytesCalldata.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/UnsafeBytesCalldata.sol#L1)

```solidity
üìÅ File: system-contracts/contracts/libraries/Utils.sol

/// @audit Consider optimizing the IPFS hash during deployment.
1: // SPDX-License-Identifier: MIT 
```
[1](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L1)

</details>


---
### [GAS&#x2011;54] Optimize Ether deposits using the `receive()` function
Consider using receive() function instead of a specific deposit() (or similar) function. If there are several functions in the contract that can receive Ether, it is recommended to use receive() for the most frequently used function. The receive() or fallback() function can handle incoming Ether transfers directly, providing more gas-efficient way to manage deposits.


Gas saved per Instance: ~45 *(Total: ~1,395)*
<details>
<summary><i>There are 31 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

98:     function deposit( 
99:         address _l2Receiver,
100:         address _l1Token,
101:         uint256 _amount,
102:         uint256 _l2TxGasLimit,
103:         uint256 _l2TxGasPerPubdataByte
104:     ) external payable returns (bytes32 l2TxHash) {

133:     function deposit( 
134:         address _l2Receiver,
135:         address _l1Token,
136:         uint256 _amount,
137:         uint256 _l2TxGasLimit,
138:         uint256 _l2TxGasPerPubdataByte,
139:         address _refundRecipient
140:     ) public payable nonReentrant returns (bytes32 l2TxHash) {
```
[98](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L98-L104), [133](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L133-L140)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

137:     function receiveEth(uint256 _chainId) external payable { 

148:     function bridgehubDepositBaseToken( 
149:         uint256 _chainId,
150:         address _prevMsgSender,
151:         address _l1Token,
152:         uint256 _amount
153:     ) external payable virtual onlyBridgehubOrEra(_chainId) {

182:     function bridgehubDeposit( 
183:         uint256 _chainId,
184:         address _prevMsgSender,
185:         uint256, // l2Value, needed for Weth deposits in the future
186:         bytes calldata _data
187:     ) external payable override onlyBridgehub returns (L2TransactionRequestTwoBridgesInner memory request) {

554:     function depositLegacyErc20Bridge( 
555:         address _prevMsgSender,
556:         address _l2Receiver,
557:         address _l1Token,
558:         uint256 _amount,
559:         uint256 _l2TxGasLimit,
560:         uint256 _l2TxGasPerPubdataByte,
561:         address _refundRecipient
562:     ) external payable override onlyLegacyBridge nonReentrant returns (bytes32 l2TxHash) {
```
[137](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L137), [148](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L148-L153), [182](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L182-L187), [554](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L554-L562)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

217:     function requestL2TransactionDirect( 
218:         L2TransactionRequestDirect calldata _request
219:     ) external payable override nonReentrant returns (bytes32 canonicalTxHash) {

262:     function requestL2TransactionTwoBridges( 
263:         L2TransactionRequestTwoBridgesOuter calldata _request
264:     ) external payable override nonReentrant returns (bytes32 canonicalTxHash) {
```
[217](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L217-L219), [262](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L262-L264)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

167:     function execute(Operation calldata _operation) external payable onlyOwnerOrSecurityCouncil { 

186:     function executeInstant(Operation calldata _operation) external payable onlySecurityCouncil { 
```
[167](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L167), [186](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L186)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

47:     function bridgehubRequestL2Transaction( 
48:         BridgehubL2TransactionRequest memory _request
49:     ) external payable onlyBridgehub returns (bytes32 canonicalTxHash) {

197:     function requestL2Transaction( 
198:         address _contractL2,
199:         uint256 _l2Value,
200:         bytes calldata _calldata,
201:         uint256 _l2GasLimit,
202:         uint256 _l2GasPerPubdataByteLimit,
203:         bytes[] calldata _factoryDeps,
204:         address _refundRecipient
205:     ) external payable returns (bytes32 canonicalTxHash) {
```
[47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L47-L49), [197](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L197-L205)

```solidity
üìÅ File: contracts/zksync/contracts/ForceDeployUpgrader.sol

13:     function forceDeploy(IContractDeployer.ForceDeployment[] calldata _forceDeployments) external payable { 
```
[13](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/ForceDeployUpgrader.sol#L13)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

79:     function finalizeDeposit( 
80:         address _l1Sender,
81:         address _l2Receiver,
82:         address _l1Token,
83:         uint256 _amount,
84:         bytes calldata _data
85:     ) external payable override {
```
[79](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L79-L85)

```solidity
üìÅ File: system-contracts/contracts/ComplexUpgrader.sol

21:     function upgrade(address _delegateTo, bytes calldata _calldata) external payable { 
```
[21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L21)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

44:     function publishCompressedBytecode( 
45:         bytes calldata _bytecode,
46:         bytes calldata _rawCompressedData
47:     ) external payable onlyCallFromBootloader returns (bytes32 bytecodeHash) {

110:     function verifyCompressedStateDiffs( 
111:         uint256 _numberOfStateDiffs,
112:         uint256 _enumerationIndexSize,
113:         bytes calldata _stateDiffs,
114:         bytes calldata _compressedStateDiffs
115:     ) external payable onlyCallFrom(address(L1_MESSENGER_CONTRACT)) returns (bytes32 stateDiffHash) {
```
[44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L44-L47), [110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L110-L115)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

132:     function create2( 
133:         bytes32 _salt,
134:         bytes32 _bytecodeHash,
135:         bytes calldata _input
136:     ) external payable override returns (address) {

147:     function create( 
148:         bytes32 _salt,
149:         bytes32 _bytecodeHash,
150:         bytes calldata _input
151:     ) external payable override returns (address) {

162:     function create2Account( 
163:         bytes32 _salt,
164:         bytes32 _bytecodeHash,
165:         bytes calldata _input,
166:         AccountAbstractionVersion _aaVersion
167:     ) public payable override onlySystemCall returns (address) {

182:     function createAccount( 
183:         bytes32, // salt
184:         bytes32 _bytecodeHash,
185:         bytes calldata _input,
186:         AccountAbstractionVersion _aaVersion
187:     ) public payable override onlySystemCall returns (address) {

213:     function forceDeployOnAddress(ForceDeployment calldata _deployment, address _sender) external payable onlySelf { 

238:     function forceDeployOnAddresses(ForceDeployment[] calldata _deployments) external payable { 
```
[132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L132-L136), [147](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L147-L151), [162](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L162-L167), [182](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L182-L187), [213](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L213), [238](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L238)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

67:     function validateTransaction( 
68:         bytes32, // _txHash
69:         bytes32 _suggestedSignedHash,
70:         Transaction calldata _transaction
71:     ) external payable override ignoreNonBootloader ignoreInDelegateCall returns (bytes4 magic) {

112:     function executeTransaction( 
113:         bytes32, // _txHash
114:         bytes32, // _suggestedSignedHash
115:         Transaction calldata _transaction
116:     ) external payable override ignoreNonBootloader ignoreInDelegateCall {

125:     function executeTransactionFromOutside(Transaction calldata _transaction) external payable override { 

196:     function payForTransaction( 
197:         bytes32, // _txHash
198:         bytes32, // _suggestedSignedHash
199:         Transaction calldata _transaction
200:     ) external payable ignoreNonBootloader ignoreInDelegateCall {

212:     function prepareForPaymaster( 
213:         bytes32, // _txHash
214:         bytes32, // _suggestedSignedHash
215:         Transaction calldata _transaction
216:     ) external payable ignoreNonBootloader ignoreInDelegateCall {
```
[67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L67-L71), [112](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L112-L116), [125](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L125), [196](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L196-L200), [212](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L212-L216)

```solidity
üìÅ File: system-contracts/contracts/GasBoundCaller.sol

35:     function gasBoundCall(address _to, uint256 _maxTotalGas, bytes calldata _data) external payable { 
```
[35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L35)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

72:     function withdraw(address _l1Receiver) external payable override { 

85:     function withdrawWithMessage(address _l1Receiver, bytes memory _additionalData) external payable override { 
```
[72](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L72), [85](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L85)

</details>


---
### [GAS&#x2011;55] Order of initial checks in a function can be optimized
Some of the checks below involve expensive operations, such as SLOAD or external calls. Reorder them so that the validations with expensive operations are prevented from being executed if the initial checks fail.


Gas saved per Instance: ~2,100 *(Total: ~6,300)*
<details>
<summary><i>There are 3 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

/// @audit Gas efficient order: 2,1
554:     function depositLegacyErc20Bridge( 
555:         address _prevMsgSender,
556:         address _l2Receiver,
557:         address _l1Token,
558:         uint256 _amount,
559:         uint256 _l2TxGasLimit,
560:         uint256 _l2TxGasPerPubdataByte,
561:         address _refundRecipient
562:     ) external payable override onlyLegacyBridge nonReentrant returns (bytes32 l2TxHash) {
/// @audit  1 (expensive operation)
563:         require(l2BridgeAddress[ERA_CHAIN_ID] != address(0), "ShB b. n dep");
/// @audit  2 
564:         require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported 2");
```
[554](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L554-L564)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

/// @audit Gas efficient order: 2,1,3
215:     function _commitBatches( 
216:         StoredBatchInfo memory _lastCommittedBatchData,
217:         CommitBatchInfo[] calldata _newBatchesData
218:     ) internal {
219:         // check that we have the right protocol version
220:         // three comments:
221:         // 1. A chain has to keep their protocol version up to date, as processing a block requires the latest or previous protocol version
222:         // to solve this we will need to add the feature to create batches with only the protocol upgrade tx, without any other txs.
223:         // 2. A chain might become out of sync if it launches while we are in the middle of a protocol upgrade. This would mean they cannot process their genesis upgrade
224:         // as thier protocolversion would be outdated, and they also cannot process the protocol upgrade tx as they have a pending upgrade.
225:         // 3. The protocol upgrade is increased in the BaseZkSyncUpgrade, in the executor only the systemContractsUpgradeTxHash is checked
/// @audit  1 (expensive operation)
226:         require(
227:             IStateTransitionManager(s.stateTransitionManager).protocolVersion() == s.protocolVersion,
228:             "Executor facet: wrong protocol version"
229:         );
230:         // With the new changes for EIP-4844, namely the restriction on number of blobs per block, we only allow for a single batch to be committed at a time.
/// @audit  2 
231:         require(_newBatchesData.length == 1, "e4");
232:         // Check that we commit batches after last committed batch
/// @audit  3 (expensive operation)
233:         require(s.storedBatchHashes[s.totalBatchesCommitted] == _hashStoredBatchInfo(_lastCommittedBatchData), "i"); // incorrect previous batch data
```
[215](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L215-L233)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

/// @audit Gas efficient order: 2,1
79:     function finalizeDeposit( 
80:         address _l1Sender,
81:         address _l2Receiver,
82:         address _l1Token,
83:         uint256 _amount,
84:         bytes calldata _data
85:     ) external payable override {
86:         // Only the L1 bridge counterpart can initiate and finalize the deposit.
/// @audit  1 (expensive operation)
87:         require(
88:             AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1Bridge ||
89:                 AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1LegacyBridge,
90:             "mq"
91:         );
/// @audit  2 
92:         require(msg.value == 0, "Value should be 0 for ERC20 bridge");
```
[79](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L79-L92)

</details>


---
### [GAS&#x2011;56] Pre-increments/pre-decrements are cheaper than `+1`/`+=1` or `-1`/`-=1`

Gas saved per Instance: ~12.6 *(Total: ~226.8)*
<details>
<summary><i>There are 18 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/UncheckedMath.sol

/// @audit prefer '++_number'
13:             return _number + 1; 
```
[13](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/UncheckedMath.sol#L13)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

/// @audit prefer '++versionedHashIndex'
657:             versionedHashIndex += 1; 
```
[657](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L657)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol

/// @audit prefer '++tail'
60:         _queue.tail = tail + 1; 

/// @audit prefer '++head'
80:         _queue.head = head + 1; 
```
[60](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L60), [80](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L80)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

/// @audit prefer '++stateDiffPtr'
175:             stateDiffPtr += 1; 
```
[175](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L175)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

/// @audit prefer '--_key'
89:             require(isNonceUsed(msg.sender, _key - 1), "Previous nonce has not been used"); 

/// @audit prefer '++oldRawNonce'
118:             rawNonces[addressAsKey] = oldRawNonce + 1; 
```
[89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L89), [118](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L118)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

/// @audit prefer '--_l2BlockNumber'
248:             bytes32 correctPrevBlockHash = _calculateLegacyL2BlockHash(_l2BlockNumber - 1); 

/// @audit prefer '--_l2BlockNumber'
255:             _setL2BlockHash(_l2BlockNumber - 1, correctPrevBlockHash); 

/// @audit prefer '--_maxVirtualBlocksToCreate'
288:             _maxVirtualBlocksToCreate -= 1; 

/// @audit prefer '--_l2BlockNumber'
319:         _setL2BlockHash(_l2BlockNumber - 1, _prevL2BlockHash); 

/// @audit prefer '--_l2BlockNumber'
370:                 _expectedPrevL2BlockHash == _getLatest257L2blockHash(_l2BlockNumber - 1), 

/// @audit prefer '++currentL2BlockNumber'
374:         } else if (currentL2BlockNumber + 1 == _l2BlockNumber) { 

/// @audit prefer '--currentL2BlockNumber'
376:             bytes32 prevL2BlockHash = _getLatest257L2blockHash(currentL2BlockNumber - 1); 

/// @audit prefer '++previousBatchNumber'
452:         require(previousBatchNumber + 1 == _expectedNewNumber, "The provided block number is not correct"); 

/// @audit prefer '++previousBatchNumber'
459:         BlockInfo memory newBlockInfo = BlockInfo({number: previousBatchNumber + 1, timestamp: _newTimestamp}); 

/// @audit txNumberInBlock is a state variable, using '++txNumberInBlock' will save even more gas
483:         txNumberInBlock += 1; 
```
[248](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L248), [255](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L255), [288](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L288), [319](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L319), [370](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L370), [374](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L374), [376](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L376), [452](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L452), [459](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L459), [483](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L483)

```solidity
üìÅ File: system-contracts/contracts/libraries/RLPEncoder.sol

/// @audit prefer '++hbs'
103:                 hbs += 1; 
```
[103](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L103)

</details>


---
### [GAS&#x2011;57] Prefer using `storage` instead of `memory` for state variables saves gas
When fetching data from a storage location, assigning the data to a `memory` variable causes all fields of the struct/array to be read from storage, which incurs a Gcoldsload (**2100 gas**) for *each* field of the struct/array. If the fields are read from the new memory variable, they incur an additional `MLOAD` rather than a cheap stack read. Instead of declaring the variable with the `memory` keyword, declaring the variable with the `storage` keyword and caching any fields that need to be re-read in stack variables, will be much cheaper, only incurring the Gcoldsload for the fields actually read. The only time it makes sense to read the whole struct/array into a `memory` variable, is if the full struct/array is being returned by the function, is being passed to a function that requires `memory`, or if the array/struct is being read from another `memory` array/struct


Gas saved per Instance: ~2,100 *(Total: ~31,500)*
<details>
<summary><i>There are 15 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol

27:         Diamond.SelectorToFacet memory facet = diamondStorage.selectorToFacet[msg.sig]; 
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L27)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

72:         FeeParams memory oldFeeParams = s.feeParams; 
```
[72](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L72)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

396:         VerifierParams memory verifierParams = s.verifierParams; 
```
[396](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L396)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

210:             Diamond.FacetToSelectors memory facetToSelectors = ds.facetToSelectors[facetAddr]; 
```
[210](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L210)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

157:         FeeParams memory feeParams = s.feeParams; 
```
[157](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L157)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

140:             SelectorToFacet memory oldFacet = ds.selectorToFacet[selector]; 

160:             SelectorToFacet memory oldFacet = ds.selectorToFacet[selector]; 

180:             SelectorToFacet memory oldFacet = ds.selectorToFacet[selector]; 
```
[140](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L140), [160](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L160), [180](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L180)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

155:         VerifierParams memory oldVerifierParams = s.verifierParams; 
```
[155](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L155)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

41:         AccountInfo memory info = accountInfo[_address]; 

75:         AccountInfo memory currentInfo = accountInfo[msg.sender]; 
```
[41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L41), [75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L75)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

135:         VirtualBlockUpgradeInfo memory currentVirtualBlockUpgradeInfo = virtualBlockUpgradeInfo; 

173:         BlockInfo memory batchInfo = currentBatchInfo; 

181:         BlockInfo memory blockInfo = currentL2BlockInfo; 

275:         BlockInfo memory virtualBlockInfo = currentVirtualL2BlockInfo; 
```
[135](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L135), [173](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L173), [181](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L181), [275](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L275)

</details>


---
### [GAS&#x2011;58] `private` functions used once can be inlined

Gas saved per Instance: ~30 *(Total: ~450)*
<details>
<summary><i>There are 15 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/common/ReentrancyGuard.sol

46:     function _initializeReentrancyGuard() private { 
```
[46](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L46)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

126:     function _addFunctions(address _facet, bytes4[] memory _selectors, bool _isFacetFreezable) private { 

149:     function _replaceFunctions(address _facet, bytes4[] memory _selectors, bool _isFacetFreezable) private { 

172:     function _removeFunctions(address _facet, bytes4[] memory _selectors) private { 

257:     function _removeFacet(address _facet) private { 

278:     function _initializeDiamondCut(address _init, bytes memory _calldata) private { 
```
[126](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L126), [149](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L149), [172](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L172), [257](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L257), [278](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L278)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

92:     function _setL2DefaultAccountBytecodeHash(bytes32 _l2DefaultAccountBytecodeHash) private { 

109:     function _setL2BootloaderBytecodeHash(bytes32 _l2BootloaderBytecodeHash) private { 

126:     function _setVerifier(IVerifier _newVerifier) private { 

142:     function _setVerifierParams(VerifierParams calldata _newVerifierParams) private { 

222:     function _verifyFactoryDeps(bytes[] calldata _factoryDeps, uint256[] calldata _expectedHashes) private pure { 
```
[92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L92), [109](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L109), [126](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L126), [142](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L142), [222](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L222)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

118:     function _encodeHashEIP712Transaction(Transaction calldata _transaction) private view returns (bytes32) { 

147:     function _encodeHashLegacyTransaction(Transaction calldata _transaction) private view returns (bytes32) { 

219:     function _encodeHashEIP2930Transaction(Transaction calldata _transaction) private view returns (bytes32) { 

289:     function _encodeHashEIP1559Transaction(Transaction calldata _transaction) private view returns (bytes32) { 
```
[118](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L118), [147](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L147), [219](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L219), [289](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L289)

</details>


---
### [GAS&#x2011;59] Refactor modifiers to call a local function
Modifiers code is copied in all instances where it's used, increasing bytecode size. By doing a refractor to the internal function, one can reduce bytecode size significantly at the cost of one `JUMP`.


Gas saved per Instance: ~600 *(Total: ~19,200)*
<details>
<summary><i>There are 32 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

68:     modifier onlyBridgehub() { 

74:     modifier onlyBridgehubOrEra(uint256 _chainId) { 

83:     modifier onlyLegacyBridge() { 
```
[68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L68), [74](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L74), [83](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L83)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

45:     modifier onlyOwnerOrAdmin() { 
```
[45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L45)

```solidity
üìÅ File: contracts/ethereum/contracts/common/ReentrancyGuard.sol

41:     modifier reentrancyGuardInitializer() { 

68:     modifier nonReentrant() { 
```
[41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L41), [68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L68)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

58:     modifier onlySelf() { 

64:     modifier onlySecurityCouncil() { 

70:     modifier onlyOwnerOrSecurityCouncil() { 
```
[58](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L58), [64](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L64), [70](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L70)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

63:     modifier onlyBridgehub() { 

69:     modifier onlyOwnerOrAdmin() { 
```
[63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L63), [69](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L69)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

61:     modifier onlyChainAdmin(uint256 _chainId) { 

67:     modifier onlyValidator(uint256 _chainId) { 
```
[61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L61), [67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L67)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol

15:     modifier onlyAdmin() { 

21:     modifier onlyValidator() { 

26:     modifier onlyStateTransitionManager() { 

31:     modifier onlyBridgehub() { 

36:     modifier onlyAdminOrStateTransitionManager() { 

44:     modifier onlyValidatorOrStateTransitionManager() { 

52:     modifier onlyBaseTokenBridge() { 
```
[15](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L15), [21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L21), [26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L26), [31](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L31), [36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L36), [44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L44), [52](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L52)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

129:     modifier onlyBridge() { 

134:     modifier onlyNextVersion(uint8 _version) { 
```
[129](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L129), [134](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L134)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

25:     modifier onlyDeployer() { 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L25)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

28:     modifier onlySelf() { 
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L28)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

28:     modifier ignoreNonBootloader() { 

45:     modifier ignoreInDelegateCall() { 
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L28), [45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L45)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

19:     modifier onlyCompressor() { 
```
[19](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L19)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContract.sol

20:     modifier onlySystemCall() { 

30:     modifier onlyCallFromSystemContract() { 

40:     modifier onlyCallFrom(address caller) { 

47:     modifier onlyCallFromBootloader() { 

54:     modifier onlyCallFromForceDeployer() { 
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L20), [30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L30), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L40), [47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L47), [54](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L54)

</details>


---
### [GAS&#x2011;60] Remove or replace unused state variables
Saves a storage slot. If the variable is assigned a non-zero value, saves Gsset (**20000 gas**). If it's assigned a zero value, saves Gsreset (**2900 gas**). If the variable remains unassigned, there is no gas savings unless the variable is `public`, in which case the compiler-generated non-payable getter deployment cost is saved. If the state variable is overriding an interface's public function, mark the variable as `constant` or `immutable` so that it does not use a storage slot


Gas saved per Instance: ~11,450 *(Total: ~80,150)*
<details>
<summary><i>There are 7 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

45:     mapping(address => uint256) private __DEPRECATED_lastWithdrawalLimitReset; 

48:     mapping(address => uint256) private __DEPRECATED_withdrawnAmountInWindow; 

51:     mapping(address => mapping(address => uint256)) private __DEPRECATED_totalDepositedAmountPerUser; 
```
[45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L45), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L48), [51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L51)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/LibMap.sol

11:         mapping(uint256 packedIndex => uint256 eightPackedValues) map; 
```
[11](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L11)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

37:     uint256 public blockGasLimit = type(uint32).max; 

41:     address public coinbase = BOOTLOADER_FORMAL_ADDRESS; 

44:     uint256 public difficulty = 2.5e15; 
```
[37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L37), [41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L41), [44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L44)

</details>


---
### [GAS&#x2011;61] Reorder modifiers to save on expensive operations
According to the Solidity documentation, modifiers are executed in the order in which they are presented in the code. Reordering them so that modifiers containing only checks are executed first can prevent execution of expensive operations, such as external calls, SLOADS or SSTORES and **save gas**.


Gas saved per Instance: ~2,100 *(Total: ~6,300)*
<details>
<summary><i>There are 3 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

/// @audit Gas efficient modifier order:
/// @audit  - initializer
/// @audit  - reentrancyGuardInitializer
104:     function initialize( 
105:         address _owner,
106:         uint256 _eraFirstPostUpgradeBatch
107:     ) external reentrancyGuardInitializer initializer {

/// @audit Gas efficient modifier order:
/// @audit  - nonReentrant
/// @audit  - onlyLegacyBridge
554:     function depositLegacyErc20Bridge( 
555:         address _prevMsgSender,
556:         address _l2Receiver,
557:         address _l1Token,
558:         uint256 _amount,
559:         uint256 _l2TxGasLimit,
560:         uint256 _l2TxGasPerPubdataByte,
561:         address _refundRecipient
562:     ) external payable override onlyLegacyBridge nonReentrant returns (bytes32 l2TxHash) {
```
[104](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L104-L107), [554](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L554-L562)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

/// @audit Gas efficient modifier order:
/// @audit  - nonReentrant
/// @audit  - onlyOwnerOrAdmin (expensive operations)
114:     function createNewChain( 
115:         uint256 _chainId,
116:         address _stateTransitionManager,
117:         address _baseToken,
118:         uint256, //_salt
119:         address _admin,
120:         bytes calldata _initData
121:     ) external onlyOwnerOrAdmin nonReentrant returns (uint256 chainId) {
```
[114](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L114-L121)

</details>


---
### [GAS&#x2011;62] `require()` or `revert()` statements that check input arguments should be at the top of the function
Checks that involve constants should come before checks that involve state variables, function calls, and calculations. By doing these checks first, the function is able to revert before wasting a Gcoldsload (**2100 gas***) in a function that may ultimately revert in the unhappy case.

<details>
<summary><i>There are 31 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

155:             require(msg.value == _amount, "L1SharedBridge: msg.value not equal to amount"); 

161:             require(amount == _amount, "3T"); // The token has non-standard transfer logic 

349:             require(chainBalance[_chainId][_l1Token] >= _amount, "ShB n funds"); 

564:         require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported 2"); 
```
[155](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L155), [161](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L161), [349](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L349), [564](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L564)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

110:         require( 
111:             s.protocolVersion == _oldProtocolVersion,
112:             "StateTransition: protocolVersion mismatch in STC when upgrading"
113:         );

116:         require( 
117:             s.protocolVersion > _oldProtocolVersion,
118:             "StateTransition: protocolVersion mismatch in STC after upgrading"
119:         );
```
[110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L110-L113), [116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L116-L119)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

272:         require(_mintValue >= baseCost + _params.l2Value, "mv"); // The `msg.value` doesn't cover the transaction cost 
```
[272](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L272)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

175:         require(_facet == address(0), "a1"); // facet address must be zero 

215:             require(_isSelectorFreezable == ds.selectorToFacet[selector0].isFreezable, "J1"); 
```
[175](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L175), [215](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L215)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

205:         require( 
206:             _l2ProtocolUpgradeTx.nonce == _newProtocolVersion,
207:             "The new protocol version should be included in the L2 system upgrade tx"
208:         );

238:         require( 
239:             _newProtocolVersion > previousProtocolVersion,
240:             "New protocol version is not greater than the current one"
241:         );
242:         require(
243:             _newProtocolVersion - previousProtocolVersion <= MAX_ALLOWED_PROTOCOL_VERSION_DELTA,
244:             "Too big protocol version difference"
245:         );
```
[205](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L205-L208), [238](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L238-L245)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol

22:         require( 
23:             // Genesis Upgrade difference: Note this is the only thing change > to >=
24:             _newProtocolVersion >= previousProtocolVersion,
25:             "New protocol version is not greater than the current one"
26:         );
27:         require(
28:             _newProtocolVersion - previousProtocolVersion <= MAX_ALLOWED_PROTOCOL_VERSION_DELTA,
29:             "Too big protocol version difference"
30:         );
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L22-L30)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

68:             require(_l1LegecyBridge != address(0), "bf2"); 

101:             require(currentL1Token == _l1Token, "gg"); // Double check that the expected value equal to real one 
```
[68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L68), [101](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L101)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

77:         require( 
78:             _nonceOrdering == AccountNonceOrdering.Arbitrary &&
79:                 currentInfo.nonceOrdering == AccountNonceOrdering.Sequential,
80:             "It is only possible to change from sequential to arbitrary ordering"
81:         );
```
[77](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L77-L81)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

41:         require(fromBalance >= _amount, "Transfer amount exceeds balance"); 
```
[41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L41)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

89:             require(isNonceUsed(msg.sender, _key - 1), "Previous nonce has not been used"); 

115:         require(oldMinNonce == _expectedNonce, "Incorrect nonce"); 
```
[89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L89), [115](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L115)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

287:             require(_maxVirtualBlocksToCreate > 0, "Can't initialize the first virtual block"); 

351:             require( 
352:                 _l2BlockTimestamp >= currentBatchTimestamp,
353:                 "The timestamp of the L2 block must be greater than or equal to the timestamp of the current batch"
354:             );
355:             require(_maxVirtualBlocksToCreate > 0, "There must be a virtual block created at the start of the batch");

367:             require(!_isFirstInBatch, "Can not reuse L2 block number from the previous batch"); 
368:             require(currentL2BlockTimestamp == _l2BlockTimestamp, "The timestamp of the same L2 block must be same");
369:             require(
370:                 _expectedPrevL2BlockHash == _getLatest257L2blockHash(_l2BlockNumber - 1),
371:                 "The previous hash of the same L2 block must be same"
372:             );
373:             require(_maxVirtualBlocksToCreate == 0, "Can not create virtual blocks in the middle of the miniblock");

385:             require(_expectedPrevL2BlockHash == pendingL2BlockHash, "The current L2 block hash is incorrect"); 
386:             require(
387:                 _l2BlockTimestamp > currentL2BlockTimestamp,
388:                 "The timestamp of the new L2 block must be greater than the timestamp of the previous L2 block"
389:             );

429:         require( 
430:             _newTimestamp > currentBlockTimestamp,
431:             "The timestamp of the batch must be greater than the timestamp of the previous block"
432:         );
```
[287](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L287), [351](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L351-L355), [367](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L367-L373), [385](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L385-L389), [429](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L429-L432)

</details>


---
### [GAS&#x2011;63] `require()`/`revert()` strings longer than 32 bytes cost extra gas
Each extra memory word of bytes past the original 32 [incurs an MSTORE](https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#consider-having-short-revert-strings) which costs **3 gas**


Gas saved per Instance: ~3 *(Total: ~312)*
<details>
<summary><i>There are 104 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

/// @audit 42 bytes long
75:         require( 
76:             msg.sender == address(bridgehub) || (_chainId == ERA_CHAIN_ID && msg.sender == ERA_DIAMOND_PROXY),
77:             "L1SharedBridge: not bridgehub or era chain"
78:         );

/// @audit 45 bytes long
155:             require(msg.value == _amount, "L1SharedBridge: msg.value not equal to amount"); 

/// @audit 36 bytes long
195:         require(bridgehub.baseToken(_chainId) != _l1Token, "ShB: baseToken deposit not supported"); 

/// @audit 33 bytes long
427:             require(!alreadyFinalized, "Withdrawal is already finalized 2"); 

/// @audit 33 bytes long
564:         require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported 2"); 
```
[75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L75-L78), [155](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L155), [195](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L195), [427](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L427), [564](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L564)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

/// @audit 46 bytes long
83:         require( 
84:             !stateTransitionManagerIsRegistered[_stateTransitionManager],
85:             "Bridgehub: state transition already registered"
86:         );

/// @audit 46 bytes long
93:         require( 
94:             stateTransitionManagerIsRegistered[_stateTransitionManager],
95:             "Bridgehub: state transition not registered yet"
96:         );

/// @audit 35 bytes long
102:         require(!tokenIsRegistered[_token], "Bridgehub: token already registered"); 

/// @audit 42 bytes long
125:         require( 
126:             stateTransitionManagerIsRegistered[_stateTransitionManager],
127:             "Bridgehub: state transition not registered"
128:         );

/// @audit 37 bytes long
132:         require(stateTransitionManager[_chainId] == address(0), "Bridgehub: chainId already registered"); 

/// @audit 40 bytes long
225:                 require(msg.value == 0, "Bridgehub: non-eth bridge with msg.value"); 

/// @audit 40 bytes long
300:         require( 
301:             _request.secondBridgeAddress > BRIDGEHUB_MIN_SECOND_BRIDGE_ADDRESS,
302:             "Bridgehub: second bridge address too low"
303:         ); // to avoid calls to precompiles
```
[83](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L83-L86), [93](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L93-L96), [102](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L102), [125](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L125-L128), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L132), [225](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L225), [300](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L300-L303)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

/// @audit 64 bytes long
59:         require(msg.sender == address(this), "Only governance contract itself is allowed to call this function"); 

/// @audit 54 bytes long
65:         require(msg.sender == securityCouncil, "Only security council is allowed to call this function"); 

/// @audit 69 bytes long
71:         require( 
72:             msg.sender == owner() || msg.sender == securityCouncil,
73:             "Only the owner and security council are allowed to call this function"
74:         );

/// @audit 40 bytes long
172:         require(isOperationReady(id), "Operation must be ready before execution"); 

/// @audit 39 bytes long
177:         require(isOperationReady(id), "Operation must be ready after execution"); 

/// @audit 42 bytes long
191:         require(isOperationPending(id), "Operation must be pending before execution"); 

/// @audit 41 bytes long
196:         require(isOperationPending(id), "Operation must be pending after execution"); 

/// @audit 46 bytes long
216:         require(!isOperation(_id), "Operation with this proposal id already exists"); 
/// @audit 41 bytes long
217:         require(_delay >= minDelay, "Proposed delay is less than minimum delay");

/// @audit 35 bytes long
240:         require(_predecessorId == bytes32(0) || isOperationDone(_predecessorId), "Predecessor operation not completed"); 
```
[59](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L59), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L65), [71](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L71-L74), [172](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L172), [177](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L177), [191](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L191), [196](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L196), [216](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L216-L217), [240](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L240)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

/// @audit 41 bytes long
256:         require(cutHashInput == initialCutHash, "StateTransition: initial cutHash mismatch"); 
```
[256](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L256)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

/// @audit 35 bytes long
62:         require(msg.sender == stateTransitionManager.getChainAdmin(_chainId), "ValidatorTimelock: only chain admin"); 

/// @audit 33 bytes long
68:         require(validators[_chainId][msg.sender] == true, "ValidatorTimelock: only validator"); 
```
[62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L62), [68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L68)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

/// @audit 43 bytes long
90:         require(s.totalBatchesCommitted == 0, "AdminFacet: set validium only after genesis"); // Validium mode can be set only before the first batch is committed 

/// @audit 33 bytes long
105:         require( 
106:             cutHashInput == IStateTransitionManager(s.stateTransitionManager).upgradeCutHash(_oldProtocolVersion),
107:             "StateTransition: cutHash mismatch"
108:         );

/// @audit 63 bytes long
110:         require( 
111:             s.protocolVersion == _oldProtocolVersion,
112:             "StateTransition: protocolVersion mismatch in STC when upgrading"
113:         );

/// @audit 64 bytes long
116:         require( 
117:             s.protocolVersion > _oldProtocolVersion,
118:             "StateTransition: protocolVersion mismatch in STC after upgrading"
119:         );
```
[90](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L90), [105](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L105-L108), [110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L110-L113), [116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L116-L119)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

/// @audit 38 bytes long
226:         require( 
227:             IStateTransitionManager(s.stateTransitionManager).protocolVersion() == s.protocolVersion,
228:             "Executor facet: wrong protocol version"
229:         );

/// @audit 42 bytes long
616:         require(success, "failed to call point evaluation precompile"); 
```
[226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L226-L229), [616](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L616)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

/// @audit 59 bytes long
39:         require(s.chainId == ERA_CHAIN_ID, "transferEthToSharedBridge only available for Era on mailbox"); 

/// @audit 45 bytes long
158:         require(s.baseTokenGasPriceMultiplierDenominator > 0, "Mailbox: baseTokenGasPriceDenominator not set"); 

/// @audit 55 bytes long
185:         require(s.chainId == ERA_CHAIN_ID, "finalizeEthWithdrawal only available for Era on mailbox"); 

/// @audit 45 bytes long
206:         require(s.chainId == ERA_CHAIN_ID, "legacy interface only available for era token"); 
```
[39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L39), [158](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L158), [185](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L185), [206](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L206)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol

/// @audit 36 bytes long
22:         require(s.validators[msg.sender], "StateTransition Chain: not validator"); 

/// @audit 51 bytes long
27:         require(msg.sender == s.stateTransitionManager, "StateTransition Chain: not state transition manager"); 

/// @audit 36 bytes long
32:         require(msg.sender == s.bridgehub, "StateTransition Chain: not bridgehub"); 

/// @audit 64 bytes long
37:         require( 
38:             msg.sender == s.admin || msg.sender == s.stateTransitionManager,
39:             "StateTransition Chain: Only by admin or state transition manager"
40:         );

/// @audit 68 bytes long
45:         require( 
46:             s.validators[msg.sender] || msg.sender == s.stateTransitionManager,
47:             "StateTransition Chain: Only by validator or state transition manager"
48:         );

/// @audit 41 bytes long
53:         require(msg.sender == s.baseTokenBridge, "Only shared bridge can call this function"); 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L22), [27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L27), [32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L32), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L37-L40), [45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L45-L48), [53](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L53)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

/// @audit 34 bytes long
190:         require(_l2ProtocolUpgradeTx.txType == SYSTEM_UPGRADE_L2_TX_TYPE, "L2 system upgrade tx type is wrong"); 

/// @audit 71 bytes long
205:         require( 
206:             _l2ProtocolUpgradeTx.nonce == _newProtocolVersion,
207:             "The new protocol version should be included in the L2 system upgrade tx"
208:         );

/// @audit 56 bytes long
238:         require( 
239:             _newProtocolVersion > previousProtocolVersion,
240:             "New protocol version is not greater than the current one"
241:         );
/// @audit 35 bytes long
242:         require(
243:             _newProtocolVersion - previousProtocolVersion <= MAX_ALLOWED_PROTOCOL_VERSION_DELTA,
244:             "Too big protocol version difference"
245:         );

/// @audit 39 bytes long
249:         require(s.l2SystemContractsUpgradeTxHash == bytes32(0), "Previous upgrade has not been finalized"); 
/// @audit 61 bytes long
250:         require(
251:             s.l2SystemContractsUpgradeBatchNumber == 0,
252:             "The batch number of the previous upgrade has not been cleaned"
253:         );
```
[190](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L190), [205](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L205-L208), [238](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L238-L245), [249](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L249-L253)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol

/// @audit 56 bytes long
22:         require( 
23:             // Genesis Upgrade difference: Note this is the only thing change > to >=
24:             _newProtocolVersion >= previousProtocolVersion,
25:             "New protocol version is not greater than the current one"
26:         );
/// @audit 35 bytes long
27:         require(
28:             _newProtocolVersion - previousProtocolVersion <= MAX_ALLOWED_PROTOCOL_VERSION_DELTA,
29:             "Too big protocol version difference"
30:         );

/// @audit 39 bytes long
33:         require(s.l2SystemContractsUpgradeTxHash == bytes32(0), "Previous upgrade has not been finalized"); 
/// @audit 61 bytes long
34:         require(
35:             s.l2SystemContractsUpgradeBatchNumber == 0,
36:             "The batch number of the previous upgrade has not been cleaned"
37:         );
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L22-L30), [33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L33-L37)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

/// @audit 34 bytes long
92:         require(msg.value == 0, "Value should be 0 for ERC20 bridge"); 
```
[92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L92)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

/// @audit 45 bytes long
26:         require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract"); 

/// @audit 46 bytes long
37:         require(Utils.isContractConstructing(_hash), "Code hash is not for a contract on constructor"); 

/// @audit 43 bytes long
48:         require(Utils.isContractConstructed(_hash), "Code hash is not for a constructed contract"); 

/// @audit 46 bytes long
57:         require(Utils.isContractConstructing(codeHash), "Code hash is not for a contract on constructor"); 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L26), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L37), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L48), [57](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L57)

```solidity
üìÅ File: system-contracts/contracts/ComplexUpgrader.sol

/// @audit 36 bytes long
22:         require(msg.sender == FORCE_DEPLOYER, "Can only be called by FORCE_DEPLOYER"); 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L22)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

/// @audit 72 bytes long
51:             require( 
52:                 encodedData.length * 4 == _bytecode.length,
53:                 "Encoded data length should be 4 times shorter than the original bytecode"
54:             );

/// @audit 77 bytes long
56:             require( 
57:                 dictionary.length / 8 <= encodedData.length / 2,
58:                 "Dictionary should have at most the same number of entries as the encoded data"
59:             );

/// @audit 36 bytes long
63:                 require(indexOfEncodedChunk < dictionary.length, "Encoded chunk index is out of bounds"); 

/// @audit 50 bytes long
68:                 require(encodedChunk == realChunk, "Encoded chunk does not match the original bytecode"); 

/// @audit 35 bytes long
119:         require(_enumerationIndexSize <= MAX_ENUMERATION_INDEX_SIZE, "enumeration index size is too large"); 

/// @audit 41 bytes long
156:         require(numInitialWritesProcessed == numberOfInitialWrites, "Incorrect number of initial storage diffs"); 

/// @audit 35 bytes long
187:         require(stateDiffPtr == _compressedStateDiffs.length, "Extra data in _compressedStateDiffs"); 

/// @audit 58 bytes long
230:                 require(convertedValue == _finalValue, "transform or no compression: compressed and final mismatch"); 

/// @audit 46 bytes long
232:                 require( 
233:                     _initialValue + convertedValue == _finalValue,
234:                     "add: initial plus converted not equal to final"
235:                 );

/// @audit 47 bytes long
237:                 require( 
238:                     _initialValue - convertedValue == _finalValue,
239:                     "sub: initial minus converted not equal to final"
240:                 );
```
[51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L51-L54), [56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L56-L59), [63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L63), [68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L68), [119](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L119), [156](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L156), [187](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L187), [230](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L230), [232](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L232-L235), [237](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L237-L240)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

/// @audit 67 bytes long
77:         require( 
78:             _nonceOrdering == AccountNonceOrdering.Arbitrary &&
79:                 currentInfo.nonceOrdering == AccountNonceOrdering.Sequential,
80:             "It is only possible to change from sequential to arbitrary ordering"
81:         );

/// @audit 65 bytes long
239:         require( 
240:             msg.sender == FORCE_DEPLOYER || msg.sender == address(COMPLEX_UPGRADER_CONTRACT),
241:             "Can only be called by FORCE_DEPLOYER or COMPLEX_UPGRADER_CONTRACT"
242:         );

/// @audit 69 bytes long
251:         require(msg.value == sumOfValues, "`value` provided is not equal to the combined `value`s of deployments"); 

/// @audit 40 bytes long
265:         require(uint160(_newAddress) > MAX_SYSTEM_CONTRACT_ADDRESS, "Can not deploy contracts in kernel space"); 

/// @audit 56 bytes long
350:             require(value == 0, "The value must be zero if we do not call the constructor"); 
```
[77](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L77-L81), [239](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L239-L242), [251](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L251), [265](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L265), [350](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L350)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

/// @audit 34 bytes long
100:         require(totalRequiredBalance <= address(this).balance, "Not enough balance for fee + value"); 

/// @audit 37 bytes long
202:         require(success, "Failed to pay the fee to the operator"); 
```
[100](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L100), [202](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L202)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

/// @audit 45 bytes long
35:         require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract"); 
```
[35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L35)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

/// @audit 34 bytes long
76:         require(version == 1 && _bytecodeHash[1] == bytes1(0), "Incorrectly formatted bytecodeHash"); 
```
[76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L76)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

/// @audit 60 bytes long
214:         require( 
215:             reconstructedChainedLogsHash == chainedLogsHash,
216:             "reconstructedChainedLogsHash is not equal to chainedLogsHash"
217:         );

/// @audit 68 bytes long
245:         require( 
246:             reconstructedChainedMessagesHash == chainedMessagesHash,
247:             "reconstructedChainedMessagesHash is not equal to chainedMessagesHash"
248:         );

/// @audit 94 bytes long
269:         require( 
270:             reconstructedChainedL1BytecodesRevealDataHash == chainedL1BytecodesRevealDataHash,
271:             "reconstructedChainedL1BytecodesRevealDataHash is not equal to chainedL1BytecodesRevealDataHash"
272:         );

/// @audit 39 bytes long
279:         require( 
280:             uint256(uint8(bytes1(_totalL2ToL1PubdataAndStateDiffs[calldataPtr]))) ==
281:                 STATE_DIFF_COMPRESSION_VERSION_NUMBER,
282:             "state diff compression version mismatch"
283:         );

/// @audit 42 bytes long
315:         require(calldataPtr == _totalL2ToL1PubdataAndStateDiffs.length, "Extra data in the totalL2ToL1Pubdata array"); 
```
[214](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L214-L217), [245](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L245-L248), [269](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L269-L272), [279](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L279-L283), [315](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L315)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

/// @audit 62 bytes long
33:         require( 
34:             msg.sender == MSG_VALUE_SYSTEM_CONTRACT ||
35:                 msg.sender == address(DEPLOYER_SYSTEM_CONTRACT) ||
36:                 msg.sender == BOOTLOADER_FORMAL_ADDRESS,
37:             "Only system contracts with special access can call this method"
38:         );
```
[33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L33-L38)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

/// @audit 48 bytes long
66:         require(_value <= MAXIMAL_MIN_NONCE_INCREMENT, "The value for incrementing the nonce is too high"); 

/// @audit 61 bytes long
136:         require( 
137:             msg.sender == address(DEPLOYER_SYSTEM_CONTRACT),
138:             "Only the contract deployer can increment the deployment nonce"
139:         );
```
[66](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L66), [136](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L136-L139)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

/// @audit 33 bytes long
242:         require(_isFirstInBatch, "Upgrade transaction must be first"); 

/// @audit 44 bytes long
245:         require(_l2BlockNumber > 0, "L2 block number is never expected to be zero"); 

/// @audit 39 bytes long
249:             require(correctPrevBlockHash == _expectedPrevL2BlockHash, "The previous L2 block hash is incorrect"); 

/// @audit 40 bytes long
287:             require(_maxVirtualBlocksToCreate > 0, "Can't initialize the first virtual block"); 

/// @audit 97 bytes long
351:             require( 
352:                 _l2BlockTimestamp >= currentBatchTimestamp,
353:                 "The timestamp of the L2 block must be greater than or equal to the timestamp of the current batch"
354:             );
/// @audit 63 bytes long
355:             require(_maxVirtualBlocksToCreate > 0, "There must be a virtual block created at the start of the batch");

/// @audit 53 bytes long
367:             require(!_isFirstInBatch, "Can not reuse L2 block number from the previous batch"); 
/// @audit 47 bytes long
368:             require(currentL2BlockTimestamp == _l2BlockTimestamp, "The timestamp of the same L2 block must be same");
/// @audit 51 bytes long
369:             require(
370:                 _expectedPrevL2BlockHash == _getLatest257L2blockHash(_l2BlockNumber - 1),
371:                 "The previous hash of the same L2 block must be same"
372:             );
/// @audit 60 bytes long
373:             require(_maxVirtualBlocksToCreate == 0, "Can not create virtual blocks in the middle of the miniblock");

/// @audit 38 bytes long
385:             require(_expectedPrevL2BlockHash == pendingL2BlockHash, "The current L2 block hash is incorrect"); 
/// @audit 93 bytes long
386:             require(
387:                 _l2BlockTimestamp > currentL2BlockTimestamp,
388:                 "The timestamp of the new L2 block must be greater than the timestamp of the previous L2 block"
389:             );

/// @audit 47 bytes long
413:         require(currentBatchNumber > 0, "The current batch number must be greater than 0"); 

/// @audit 83 bytes long
429:         require( 
430:             _newTimestamp > currentBlockTimestamp,
431:             "The timestamp of the batch must be greater than the timestamp of the previous block"
432:         );

/// @audit 40 bytes long
452:         require(previousBatchNumber + 1 == _expectedNewNumber, "The provided block number is not correct"); 
```
[242](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L242), [245](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L245), [249](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L249), [287](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L287), [351](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L351-L355), [367](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L367-L373), [385](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L385-L389), [413](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L413), [429](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L429-L432), [452](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L452)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContract.sol

/// @audit 36 bytes long
21:         require( 
22:             SystemContractHelper.isSystemCall() || SystemContractHelper.isSystemContract(msg.sender),
23:             "This method require system call flag"
24:         );

/// @audit 52 bytes long
31:         require( 
32:             SystemContractHelper.isSystemContract(msg.sender),
33:             "This method require the caller to be system contract"
34:         );
```
[21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L21-L24), [31](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L31-L34)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractHelper.sol

/// @audit 38 bytes long
319:         require(index < 10, "There are only 10 accessible registers"); 
```
[319](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L319)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

/// @audit 58 bytes long
363:         require(_transaction.paymasterInput.length >= 4, "The standard paymaster input must be at least 4 bytes long"); 

/// @audit 64 bytes long
367:             require( 
368:                 _transaction.paymasterInput.length >= 68,
369:                 "The approvalBased paymaster input must be at least 68 bytes long"
370:             );
```
[363](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L363), [367](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L367-L370)

</details>


---
### [GAS&#x2011;64] Same cast is done multiple times
It's cheaper to do it once, and store the result to a variable. The examples below are the second+ instance of a given cast of the variable

<details>
<summary><i>There are 11 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

/// @audit 'address(sharedBridge)' is done 2 times total in this same function
67:         IERC20(_token).safeTransfer(address(sharedBridge), amount); 

/// @audit 'address(sharedBridge)' is done 3 times total in this same function
161:         uint256 balanceBefore = _token.balanceOf(address(sharedBridge)); 
```
[67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L67), [161](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L161)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

/// @audit 'bytes4(functionSignature)' is done 2 times total in this same function
504:         if (bytes4(functionSignature) == IMailbox.finalizeEthWithdrawal.selector) { 
```
[504](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L504)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

/// @audit 'address(sharedBridge)' is done 2 times total in this same function
140:             address(sharedBridge), 
```
[140](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L140)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

/// @audit 'uint8(PubdataSource.Calldata)' is done 2 times total in this same function
40:         require(pubdataSource == uint8(PubdataSource.Calldata) || pubdataSource == uint8(PubdataSource.Blob), "us"); 

/// @audit 'uint8(PubdataSource.Blob)' is done 2 times total in this same function
52:         } else if (pubdataSource == uint8(PubdataSource.Blob)) { 

/// @audit 'uint8(logKey)' is done 2 times total in this same function
150:             processedLogs = _setBit(processedLogs, uint8(logKey)); 

/// @audit 'uint256(logValue)' is done 2 times total in this same function
164:                 logOutput.packedBatchAndL2BlockTimestamp = uint256(logValue); 
```
[40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L40), [52](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L52), [150](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L150), [164](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L164)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

/// @audit 'address(l2Token)' is done 2 times total in this same function
115:         return address(l2Token); 
```
[115](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L115)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

/// @audit 'uint160(_newAddress)' is done 2 times total in this same function
265:         require(uint160(_newAddress) > MAX_SYSTEM_CONTRACT_ADDRESS, "Can not deploy contracts in kernel space"); 
```
[265](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L265)

```solidity
üìÅ File: system-contracts/contracts/libraries/RLPEncoder.sol

/// @audit 'uint256(_len)' is done 2 times total in this same function
66:                 uint256 hbs = _highestByteSet(uint256(_len)); 
```
[66](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L66)

</details>


---
### [GAS&#x2011;65] Simple checks for zero can be done using assembly to save gas

Gas saved per Instance: ~6 *(Total: ~750)*
<details>
<summary><i>There are 125 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

141:         require(_amount != 0, "0T"); // empty deposit 

186:         require(amount != 0, "2T"); // empty deposit 
```
[141](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L141), [186](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L186)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

108:         require(_owner != address(0), "ShB owner 0"); 

154:         if (_l1Token == ETH_TOKEN_ADDRESS) { 

158:             require(msg.value == 0, "ShB m.v > 0 b d.it"); 

188:         require(l2BridgeAddress[_chainId] != address(0), "ShB l2 bridge not deployed"); 

198:         if (_l1Token == ETH_TOKEN_ADDRESS) { 

200:             require(_depositAmount == 0, "ShB wrong withdraw amount"); 

202:             require(msg.value == 0, "ShB m.v > 0 for BH d.it 2"); 

208:         require(amount != 0, "6T"); // empty deposit amount 

237:         require(depositHappened[_chainId][_txHash] == 0x00, "ShB tx hap"); 

563:         require(l2BridgeAddress[ERA_CHAIN_ID] != address(0), "ShB b. n dep"); 

578:             if (_refundRecipient == address(0)) { 
```
[108](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L108), [154](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L154), [158](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L158), [188](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L188), [198](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L198), [200](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L200), [202](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L202), [208](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L208), [237](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L237), [563](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L563), [578](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L578)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

122:         require(_chainId != 0, "Bridgehub: chainId cannot be 0"); 

130:         require(address(sharedBridge) != address(0), "Bridgehub: weth bridge not set"); 

132:         require(stateTransitionManager[_chainId] == address(0), "Bridgehub: chainId already registered"); 

222:             if (token == ETH_TOKEN_ADDRESS) { 

225:                 require(msg.value == 0, "Bridgehub: non-eth bridge with msg.value"); 

326:         if (_refundRecipient == address(0)) { 
```
[122](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L122), [130](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L130), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L132), [222](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L222), [225](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L225), [326](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L326)

```solidity
üìÅ File: contracts/ethereum/contracts/common/ReentrancyGuard.sol

58:         require(lockSlotOldValue == 0, "1B"); 
```
[58](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L58)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol

23:         require(_bytecode.length % 32 == 0, "pq"); 

41:         require(version == 1 && _bytecodeHash[1] == bytes1(0), "zf"); // Incorrectly formatted bytecodeHash 
```
[23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L23), [41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L41)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

42:         require(_admin != address(0), "Admin should be non zero address"); 

107:         if (timestamp == 0) { 

240:         require(_predecessorId == bytes32(0) || isOperationDone(_predecessorId), "Predecessor operation not completed"); 
```
[42](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L42), [107](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L107), [240](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L240)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

82:         require(_initializeData.governor != address(0), "StateTransition: governor zero"); 

246:         if (stateTransition[_chainId] != address(0)) { 
```
[82](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L82), [246](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L246)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol

25:         require(address(_initializeData.verifier) != address(0), "vt"); 
26:         require(_initializeData.admin != address(0), "vy");
27:         require(_initializeData.validatorTimelock != address(0), "hc");
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L25-L27)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol

25:         require(msg.data.length >= 4 || msg.data.length == 0, "Ut"); 

30:         require(facetAddress != address(0), "F"); // Proxy has no facet for this selector 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L25), [30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L30)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

90:         require(s.totalBatchesCommitted == 0, "AdminFacet: set validium only after genesis"); // Validium mode can be set only before the first batch is committed 
```
[90](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L90)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

48:         if (s.feeParams.pubdataPricingMode == PubdataPricingMode.Validium) { 

50:             require(logOutput.pubdataHash == 0x00, "v0h"); 

191:         if (_expectedSystemContractUpgradeTxHash == bytes32(0)) { 

237:         if (systemContractsUpgradeTxHash == bytes32(0) || s.l2SystemContractsUpgradeBatchNumber != 0) { 

284:         require(s.l2SystemContractsUpgradeBatchNumber == 0, "ik"); 

361:         if (batchWhenUpgradeHappened != 0 && batchWhenUpgradeHappened <= newTotalBatchesExecuted) { 

633:         require(_pubdataCommitments.length % PUBDATA_COMMITMENT_SIZE == 0, "bs"); 

639:             require(blobVersionedHash != bytes32(0), "vh"); 

663:         require(versionedHash == bytes32(0), "lh"); 

668:             require( 
669:                 (_blobHashes[i] == bytes32(0) && blobCommitments[i] == bytes32(0)) ||
670:                     (_blobHashes[i] != bytes32(0) && blobCommitments[i] != bytes32(0)),
671:                 "bh"
672:             );
```
[48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L48), [50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L50), [191](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L191), [237](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L237), [284](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L284), [361](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L361), [633](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L633), [639](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L639), [663](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L663), [668](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L668-L672)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

169:         if (selectorsArrayLen != 0) { 

183:         require(ds.selectorToFacet[_selector].facetAddress != address(0), "g2"); 
```
[169](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L169), [183](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L183)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

141:             require(oldFacet.facetAddress == address(0), "J"); // facet for this selector already exists 

161:             require(oldFacet.facetAddress != address(0), "L"); // it is impossible to replace the facet with zero address 

175:         require(_facet == address(0), "a1"); // facet address must be zero 

181:             require(oldFacet.facetAddress != address(0), "a2"); // Can't delete a non-existent facet 

194:         if (selectorsLength == 0) { 

213:         if (selectorPosition != 0) { 

250:         if (lastSelectorPosition == 0) { 

279:         if (_init == address(0)) { 
280:             require(_calldata.length == 0, "H"); // Non-empty calldata for zero address
```
[141](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L141), [161](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L161), [175](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L175), [181](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L181), [194](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L194), [213](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L213), [250](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L250), [279](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L279-L280)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol

50:         require(_transaction.paymaster == 0, "uc"); 
51:         require(_transaction.value == 0, "ud");
52:         require(_transaction.maxFeePerGas == 0, "uq");
53:         require(_transaction.maxPriorityFeePerGas == 0, "ux");
54:         require(_transaction.reserved[0] == 0, "ue");

56:         require(_transaction.reserved[2] == 0, "ug"); 
57:         require(_transaction.reserved[3] == 0, "uo");
58:         require(_transaction.signature.length == 0, "uh");
59:         require(_transaction.paymasterInput.length == 0, "ul1");
60:         require(_transaction.reservedDynamic.length == 0, "um");
```
[50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L50-L54), [56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L56-L60)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

93:         if (_l2DefaultAccountBytecodeHash == bytes32(0)) { 

110:         if (_l2BootloaderBytecodeHash == bytes32(0)) { 

147:         if ( 
148:             _newVerifierParams.recursionNodeLevelVkHash == bytes32(0) &&
149:             _newVerifierParams.recursionLeafLevelVkHash == bytes32(0) &&
150:             _newVerifierParams.recursionCircuitsSetVksHash == bytes32(0)

186:         if (_l2ProtocolUpgradeTx.txType == 0) { 

249:         require(s.l2SystemContractsUpgradeTxHash == bytes32(0), "Previous upgrade has not been finalized"); 
250:         require(
251:             s.l2SystemContractsUpgradeBatchNumber == 0,
252:             "The batch number of the previous upgrade has not been cleaned"
253:         );
```
[93](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L93), [110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L110), [147](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L147-L150), [186](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L186), [249](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L249-L253)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol

33:         require(s.l2SystemContractsUpgradeTxHash == bytes32(0), "Previous upgrade has not been finalized"); 
34:         require(
35:             s.l2SystemContractsUpgradeBatchNumber == 0,
36:             "The batch number of the previous upgrade has not been cleaned"
37:         );
```
[33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L33-L37)

```solidity
üìÅ File: contracts/zksync/contracts/SystemContractsCaller.sol

59:         if (value == 0) { 
```
[59](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L59)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

55:         require(_l1Bridge != address(0), "bf"); 
56:         require(_l2TokenProxyBytecodeHash != bytes32(0), "df");
57:         require(_aliasedOwner != address(0), "sf");
58:         require(_l2TokenProxyBytecodeHash != bytes32(0), "df");

63:         if (block.chainid != ERA_CHAIN_ID) { 

68:             require(_l1LegecyBridge != address(0), "bf2"); 

92:         require(msg.value == 0, "Value should be 0 for ERC20 bridge"); 

96:         if (currentL1Token == address(0)) { 

129:         require(l1Token != address(0), "yh"); 
```
[55](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L55-L58), [63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L63), [68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L68), [92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L92), [96](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L96), [129](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L129)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

51:         require(_l1Address != address(0), "in6"); // Should be non-zero address 
```
[51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L51)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

102:         if (codeHash == 0x00 && NONCE_HOLDER_SYSTEM_CONTRACT.getRawNonce(account) > 0) { 

131:         if ( 
132:             uint160(account) > CURRENT_MAX_PRECOMPILE_ADDRESS &&
133:             codeHash != 0x00 &&
134:             !Utils.isContractConstructing(codeHash)
```
[102](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L102), [131](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L131-L134)

```solidity
üìÅ File: system-contracts/contracts/BootloaderUtilities.sol

96:             if (_transaction.reserved[0] != 0) { 
```
[96](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L96)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

130:             if (enumIndex != 0) { 

162:             if (enumIndex == 0) { 

229:             if (_operation == 0 || _operation == 3) { 
```
[130](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L130), [162](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L162), [229](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L229)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

47:         if ( 
48:             _address > address(MAX_SYSTEM_CONTRACT_ADDRESS) &&
49:             ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.getRawCodeHash(_address) == 0

264:         require(_bytecodeHash != bytes32(0x0), "BytecodeHash cannot be zero"); 

268:         require( 
269:             ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.getCodeHash(uint256(uint160(_newAddress))) == 0x0,
270:             "Code hash is non-zero"
271:         );

273:         require(NONCE_HOLDER_SYSTEM_CONTRACT.getRawNonce(_newAddress) == 0x00, "Account is occupied"); 

330:         if (_callConstructor) { 

350:             require(value == 0, "The value must be zero if we do not call the constructor"); 
```
[47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L47-L49), [264](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L264), [268](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L268-L271), [273](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L273), [330](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L330), [350](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L350)

```solidity
üìÅ File: system-contracts/contracts/GasBoundCaller.sol

73:         if (pubdataCost != 0) { 
```
[73](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L73)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

47:         if (getMarker(_bytecodeHash) == 0) { 

76:         require(version == 1 && _bytecodeHash[1] == bytes1(0), "Incorrectly formatted bytecodeHash"); 
```
[47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L47), [76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L76)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

62:         if (value != 0) { 
```
[62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L62)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

85:         require(_value != 0, "Nonce value cannot be set to 0"); 

88:         if (accountInfo.nonceOrdering == IContractDeployer.AccountNonceOrdering.Sequential && _key != 0) { 
```
[85](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L85), [88](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L88)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

268:         if (virtualBlockUpgradeInfo.virtualBlockFinishL2Block != 0) { 

277:         if (currentVirtualL2BlockInfo.number == 0 && virtualBlockInfo.timestamp == 0) { 

289:         } else if (_maxVirtualBlocksToCreate == 0) { 

360:         if (currentL2BlockNumber == 0 && currentL2BlockTimestamp == 0) { 

366:         } else if (currentL2BlockNumber == _l2BlockNumber) { 

373:             require(_maxVirtualBlocksToCreate == 0, "Can not create virtual blocks in the middle of the miniblock"); 
```
[268](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L268), [277](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L277), [289](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L289), [360](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L360), [366](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L366), [373](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L373)

```solidity
üìÅ File: system-contracts/contracts/libraries/EfficientCall.sol

131:         if (_value == 0) { 
```
[131](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L131)

```solidity
üìÅ File: system-contracts/contracts/libraries/RLPEncoder.sol

26:             if (_val < 128) { 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L26)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractsCaller.sol

98:         if (value == 0) { 
```
[98](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L98)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

184:         if (_transaction.reserved[0] != 0) { 

406:         if (address(uint160(_transaction.paymaster)) != address(0)) { 
```
[184](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L184), [406](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L406)

```solidity
üìÅ File: system-contracts/contracts/libraries/Utils.sol

84:         require(_bytecode.length % 32 == 0, "po"); 
```
[84](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L84)

</details>


---
### [GAS&#x2011;66] Simplify modulo operations
`x % 2 == 0` operations can be simplified to `x & 1 == 0`


Gas saved per Instance: ~101 *(Total: ~505)*
<details>
<summary><i>There are 5 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol

27:         require(bytecodeLenInWords % 2 == 1, "ps"); // bytecode length in words must be odd 

43:         require(bytecodeLen(_bytecodeHash) % 2 == 1, "uy"); // Code length in words must be odd 
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L27), [43](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L43)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol

30:             currentHash = (_index % 2 == 0) 
```
[30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L30)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

78:         require(Utils.bytecodeLenInWords(_bytecodeHash) % 2 == 1, "Code length in words must be odd"); 
```
[78](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L78)

```solidity
üìÅ File: system-contracts/contracts/libraries/Utils.sol

88:         require(lengthInWords % 2 == 1, "pr"); // bytecode length in words must be odd 
```
[88](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L88)

</details>


---
### [GAS&#x2011;67] Sort Solidity operations using short-circuit mode
In Solidity, boolean expressions utilize short-circuiting. For || (logical OR) operations, the second expression is evaluated only if the first one is false. Similarly, for && (logical AND) operations, the second expression is evaluated only if the first one is true. This optimization saves gas by avoiding unnecessary evaluations. For instance, in require(msg.sender == owner || msg.sender == manager), if msg.sender == owner evaluates to true, msg.sender == manager isn't checked. It's recommended to place the less expensive expression first to optimize gas usage.

<details>
<summary><i>There are 64 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

/// @audit Lines: 57 to 61
/// @audit Lines: 57 to 61
/// @audit Lines: 57 to 61
104:     function initialize( 
105:         address _owner,
106:         uint256 _eraFirstPostUpgradeBatch
107:     ) external reentrancyGuardInitializer initializer {
108:         require(_owner != address(0), "ShB owner 0");
109:         _transferOwnership(_owner);
110: 
111:         eraFirstPostUpgradeBatch = _eraFirstPostUpgradeBatch;
112:         l2BridgeAddress[ERA_CHAIN_ID] = ERA_ERC20_BRIDGE_ADDRESS;
113:     }

/// @audit Lines: 75 to 79
/// @audit Lines: 75 to 79
148:     function bridgehubDepositBaseToken( 
149:         uint256 _chainId,
150:         address _prevMsgSender,
151:         address _l1Token,
152:         uint256 _amount
153:     ) external payable virtual onlyBridgehubOrEra(_chainId) {
154:         if (_l1Token == ETH_TOKEN_ADDRESS) {
155:             require(msg.value == _amount, "L1SharedBridge: msg.value not equal to amount");
156:         } else {
157:             // The Bridgehub also checks this, but we want to be sure
158:             require(msg.value == 0, "ShB m.v > 0 b d.it");
159: 
160:             uint256 amount = _depositFunds(_prevMsgSender, IERC20(_l1Token), _amount); // note if _prevMsgSender is this contract, this will return 0. This does not happen.
161:             require(amount == _amount, "3T"); // The token has non-standard transfer logic
162:         }
163: 
164:         if (!hyperbridgingEnabled[_chainId]) {
165:             chainBalance[_chainId][_l1Token] += _amount;
166:         }
167:         // Note that we don't save the deposited amount, as this is for the base token, which gets sent to the refundRecipient if the tx fails
168:         emit BridgehubDepositBaseTokenInitiated(_chainId, _prevMsgSender, _l1Token, _amount);
169:     }
```
[104](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L104-L113), [148](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L148-L169)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

/// @audit Lines: 46 to 49
51:     function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin { 
52:         // Save previous value into the stack to put it into the event later
53:         address oldPendingAdmin = pendingAdmin;
54:         // Change pending admin
55:         pendingAdmin = _newPendingAdmin;
56:         emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
57:     }

/// @audit Lines: 46 to 49
114:     function createNewChain( 
115:         uint256 _chainId,
116:         address _stateTransitionManager,
117:         address _baseToken,
118:         uint256, //_salt
119:         address _admin,
120:         bytes calldata _initData
121:     ) external onlyOwnerOrAdmin nonReentrant returns (uint256 chainId) {
122:         require(_chainId != 0, "Bridgehub: chainId cannot be 0");
123:         require(_chainId <= type(uint48).max, "Bridgehub: chainId too large");
124: 
125:         require(
126:             stateTransitionManagerIsRegistered[_stateTransitionManager],
127:             "Bridgehub: state transition not registered"
128:         );
129:         require(tokenIsRegistered[_baseToken], "Bridgehub: token not registered");
130:         require(address(sharedBridge) != address(0), "Bridgehub: weth bridge not set");
131: 
132:         require(stateTransitionManager[_chainId] == address(0), "Bridgehub: chainId already registered");
133: 
134:         stateTransitionManager[_chainId] = _stateTransitionManager;
135:         baseToken[_chainId] = _baseToken;
136: 
137:         IStateTransitionManager(_stateTransitionManager).createNewChain(
138:             _chainId,
139:             _baseToken,
140:             address(sharedBridge),
141:             _admin,
142:             _initData
143:         );
144: 
145:         emit NewChain(_chainId, _stateTransitionManager, _admin);
146:         return _chainId;
147:     }
```
[51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L51-L57), [114](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L114-L147)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol

/// @audit Lines: 41 to 44
39:     function validateBytecodeHash(bytes32 _bytecodeHash) internal pure { 
40:         uint8 version = uint8(_bytecodeHash[0]);
41:         require(version == 1 && _bytecodeHash[1] == bytes1(0), "zf"); // Incorrectly formatted bytecodeHash
42: 
43:         require(bytecodeLen(_bytecodeHash) % 2 == 1, "uy"); // Code length in words must be odd
44:     }
```
[39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L39-L44)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

/// @audit Lines: 71 to 75
167:     function execute(Operation calldata _operation) external payable onlyOwnerOrSecurityCouncil { 
168:         bytes32 id = hashOperation(_operation);
169:         // Check if the predecessor operation is completed.
170:         _checkPredecessorDone(_operation.predecessor);
171:         // Ensure that the operation is ready to proceed.
172:         require(isOperationReady(id), "Operation must be ready before execution");
173:         // Execute operation.
174:         _execute(_operation.calls);
175:         // Reconfirming that the operation is still ready after execution.
176:         // This is needed to avoid unexpected reentrancy attacks of re-executing the same operation.
177:         require(isOperationReady(id), "Operation must be ready after execution");
178:         // Set operation to be done
179:         timestamps[id] = EXECUTED_PROPOSAL_TIMESTAMP;
180:         emit OperationExecuted(id);
181:     }

/// @audit Lines: 240 to 243
239:     function _checkPredecessorDone(bytes32 _predecessorId) internal view { 
240:         require(_predecessorId == bytes32(0) || isOperationDone(_predecessorId), "Predecessor operation not completed");
241:     }
```
[167](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L167-L181), [239](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L239-L241)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

/// @audit Lines: 70 to 73
110:     function setPendingAdmin(address _newPendingAdmin) external onlyOwnerOrAdmin { 
111:         // Save previous value into the stack to put it into the event later
112:         address oldPendingAdmin = pendingAdmin;
113:         // Change pending admin
114:         pendingAdmin = _newPendingAdmin;
115:         emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin);
116:     }

/// @audit Lines: 70 to 73
132:     function setValidatorTimelock(address _validatorTimelock) external onlyOwnerOrAdmin { 
133:         validatorTimelock = _validatorTimelock;
134:     }

/// @audit Lines: 70 to 73
170:     function revertBatches(uint256 _chainId, uint256 _newLastBatch) external onlyOwnerOrAdmin { 
171:         IZkSyncStateTransition(stateTransition[_chainId]).revertBatches(_newLastBatch);
172:     }
```
[110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L110-L116), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L132-L134), [170](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L170-L172)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol

/// @audit Lines: 25 to 28
/// @audit Lines: 31 to 34
20:     fallback() external payable { 
21:         Diamond.DiamondStorage storage diamondStorage = Diamond.getDiamondStorage();
22:         // Check whether the data contains a "full" selector or it is empty.
23:         // Required because Diamond proxy finds a facet by function signature,
24:         // which is not defined for data length in range [1, 3].
25:         require(msg.data.length >= 4 || msg.data.length == 0, "Ut");
26:         // Get facet from function selector
27:         Diamond.SelectorToFacet memory facet = diamondStorage.selectorToFacet[msg.sig];
28:         address facetAddress = facet.facetAddress;
29: 
30:         require(facetAddress != address(0), "F"); // Proxy has no facet for this selector
31:         require(!diamondStorage.isFrozen || !facet.isFreezable, "q1"); // Facet is frozen
32: 
33:         assembly {
34:             // The pointer to the free memory slot
35:             let ptr := mload(0x40)
36:             // Copy function signature and arguments from calldata at zero position into memory at pointer position
37:             calldatacopy(ptr, 0, calldatasize())
38:             // Delegatecall method of the implementation contract returns 0 on error
39:             let result := delegatecall(gas(), facetAddress, ptr, calldatasize(), 0, 0)
40:             // Get the size of the last return data
41:             let size := returndatasize()
42:             // Copy the size length of bytes from return data at zero position to pointer position
43:             returndatacopy(ptr, 0, size)
44:             // Depending on the result value
45:             switch result
46:             case 0 {
47:                 // End execution and revert state changes
48:                 revert(ptr, size)
49:             }
50:             default {
51:                 // Return data with length of size at pointers position
52:                 return(ptr, size)
53:             }
54:         }
55:     }
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L20-L55)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

/// @audit Lines: 25 to 30
67:     function changeFeeParams(FeeParams calldata _newFeeParams) external onlyAdminOrStateTransitionManager { 
68:         // Double checking that the new fee params are valid, i.e.
69:         // the maximal pubdata per batch is not less than the maximal pubdata per priority transaction.
70:         require(_newFeeParams.maxPubdataPerBatch >= _newFeeParams.priorityTxMaxPubdata, "n6");
71: 
72:         FeeParams memory oldFeeParams = s.feeParams;
73:         s.feeParams = _newFeeParams;
74: 
75:         emit NewFeeParams(oldFeeParams, _newFeeParams);
76:     }

/// @audit Lines: 25 to 30
79:     function setTokenMultiplier(uint128 _nominator, uint128 _denominator) external onlyAdminOrStateTransitionManager { 
80:         uint128 oldNominator = s.baseTokenGasPriceMultiplierNominator;
81:         uint128 oldDenominator = s.baseTokenGasPriceMultiplierDenominator;
82: 
83:         s.baseTokenGasPriceMultiplierNominator = _nominator;
84:         s.baseTokenGasPriceMultiplierDenominator = _denominator;
85: 
86:         emit NewBaseTokenMultiplier(oldNominator, oldDenominator, _nominator, _denominator);
87:     }

/// @audit Lines: 25 to 30
100:     function upgradeChainFromVersion( 
101:         uint256 _oldProtocolVersion,
102:         Diamond.DiamondCutData calldata _diamondCut
103:     ) external onlyAdminOrStateTransitionManager {
104:         bytes32 cutHashInput = keccak256(abi.encode(_diamondCut));
105:         require(
106:             cutHashInput == IStateTransitionManager(s.stateTransitionManager).upgradeCutHash(_oldProtocolVersion),
107:             "StateTransition: cutHash mismatch"
108:         );
109: 
110:         require(
111:             s.protocolVersion == _oldProtocolVersion,
112:             "StateTransition: protocolVersion mismatch in STC when upgrading"
113:         );
114:         Diamond.diamondCut(_diamondCut);
115:         emit ExecuteUpgrade(_diamondCut);
116:         require(
117:             s.protocolVersion > _oldProtocolVersion,
118:             "StateTransition: protocolVersion mismatch in STC after upgrading"
119:         );
120:     }

/// @audit Lines: 25 to 30
133:     function freezeDiamond() external onlyAdminOrStateTransitionManager { 
134:         Diamond.DiamondStorage storage diamondStorage = Diamond.getDiamondStorage();
135: 
136:         require(!diamondStorage.isFrozen, "a9"); // diamond proxy is frozen already
137:         diamondStorage.isFrozen = true;
138: 
139:         emit Freeze();
140:     }

/// @audit Lines: 25 to 30
143:     function unfreezeDiamond() external onlyAdminOrStateTransitionManager { 
144:         Diamond.DiamondStorage storage diamondStorage = Diamond.getDiamondStorage();
145: 
146:         require(diamondStorage.isFrozen, "a7"); // diamond proxy is not frozen
147:         diamondStorage.isFrozen = false;
148: 
149:         emit Unfreeze();
150:     }
```
[67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L67-L76), [79](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L79-L87), [100](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L100-L120), [133](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L133-L140), [143](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L143-L150)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

/// @audit Lines: 40 to 43
32:     function _commitOneBatch( 
33:         StoredBatchInfo memory _previousBatch,
34:         CommitBatchInfo calldata _newBatch,
35:         bytes32 _expectedSystemContractUpgradeTxHash
36:     ) internal view returns (StoredBatchInfo memory) {
37:         require(_newBatch.batchNumber == _previousBatch.batchNumber + 1, "f"); // only commit next batch
38: 
39:         uint8 pubdataSource = uint8(bytes1(_newBatch.pubdataCommitments[0]));
40:         require(pubdataSource == uint8(PubdataSource.Calldata) || pubdataSource == uint8(PubdataSource.Blob), "us");
41: 
42:         // Check that batch contain all meta information for L2 logs.
43:         // Get the chained hash of priority transaction hashes.
44:         LogProcessingOutput memory logOutput = _processL2Logs(_newBatch, _expectedSystemContractUpgradeTxHash);
45: 
46:         bytes32[] memory blobCommitments = new bytes32[](MAX_NUMBER_OF_BLOBS);
47:         bytes32[] memory blobHashes = new bytes32[](MAX_NUMBER_OF_BLOBS);
48:         if (s.feeParams.pubdataPricingMode == PubdataPricingMode.Validium) {
49:             // skipping data validation for validium, we just check that the data is empty
50:             require(logOutput.pubdataHash == 0x00, "v0h");
51:             require(_newBatch.pubdataCommitments.length == 1);
52:         } else if (pubdataSource == uint8(PubdataSource.Blob)) {
53:             // We want only want to include the actual blob linear hashes when we send pubdata via blobs.
54:             // Otherwise we should be using bytes32(0)
55:             blobHashes[0] = logOutput.blob1Hash;
56:             blobHashes[1] = logOutput.blob2Hash;
57:             // In this scenario, pubdataCommitments is a list of: opening point (16 bytes) || claimed value (32 bytes) || commitment (48 bytes) || proof (48 bytes)) = 144 bytes
58:             blobCommitments = _verifyBlobInformation(_newBatch.pubdataCommitments[1:], blobHashes);
59:         } else if (pubdataSource == uint8(PubdataSource.Calldata)) {
60:             // In this scenario pubdataCommitments is actual pubdata consisting of l2 to l1 logs, l2 to l1 message, compressed smart contract bytecode, and compressed state diffs
61:             require(
62:                 logOutput.pubdataHash ==
63:                     keccak256(_newBatch.pubdataCommitments[1:_newBatch.pubdataCommitments.length - 32]),
64:                 "wp"
65:             );
66:             blobHashes[0] = logOutput.blob1Hash;
67:             blobCommitments[0] = bytes32(
68:                 _newBatch.pubdataCommitments[_newBatch.pubdataCommitments.length - 32:_newBatch
69:                     .pubdataCommitments
70:                     .length]
71:             );
72:         }
73: 
74:         require(_previousBatch.batchHash == logOutput.previousBatchHash, "l");
75:         // Check that the priority operation hash in the L2 logs is as expected
76:         require(logOutput.chainedPriorityTxsHash == _newBatch.priorityOperationsHash, "t");
77:         // Check that the number of processed priority operations is as expected
78:         require(logOutput.numberOfLayer1Txs == _newBatch.numberOfLayer1Txs, "ta");
79: 
80:         // Check the timestamp of the new batch
81:         _verifyBatchTimestamp(logOutput.packedBatchAndL2BlockTimestamp, _newBatch.timestamp, _previousBatch.timestamp);
82: 
83:         // Create batch commitment for the proof verification
84:         bytes32 commitment = _createBatchCommitment(_newBatch, logOutput.stateDiffHash, blobCommitments, blobHashes);
85: 
86:         return
87:             StoredBatchInfo(
88:                 _newBatch.batchNumber,
89:                 _newBatch.newStateRoot,
90:                 _newBatch.indexRepeatedStorageChanges,
91:                 _newBatch.numberOfLayer1Txs,
92:                 _newBatch.priorityOperationsHash,
93:                 logOutput.l2LogsTreeRoot,
94:                 _newBatch.timestamp,
95:                 commitment
96:             );
97:     }

/// @audit Lines: 237 to 241
215:     function _commitBatches( 
216:         StoredBatchInfo memory _lastCommittedBatchData,
217:         CommitBatchInfo[] calldata _newBatchesData
218:     ) internal {
219:         // check that we have the right protocol version
220:         // three comments:
221:         // 1. A chain has to keep their protocol version up to date, as processing a block requires the latest or previous protocol version
222:         // to solve this we will need to add the feature to create batches with only the protocol upgrade tx, without any other txs.
223:         // 2. A chain might become out of sync if it launches while we are in the middle of a protocol upgrade. This would mean they cannot process their genesis upgrade
224:         // as thier protocolversion would be outdated, and they also cannot process the protocol upgrade tx as they have a pending upgrade.
225:         // 3. The protocol upgrade is increased in the BaseZkSyncUpgrade, in the executor only the systemContractsUpgradeTxHash is checked
226:         require(
227:             IStateTransitionManager(s.stateTransitionManager).protocolVersion() == s.protocolVersion,
228:             "Executor facet: wrong protocol version"
229:         );
230:         // With the new changes for EIP-4844, namely the restriction on number of blobs per block, we only allow for a single batch to be committed at a time.
231:         require(_newBatchesData.length == 1, "e4");
232:         // Check that we commit batches after last committed batch
233:         require(s.storedBatchHashes[s.totalBatchesCommitted] == _hashStoredBatchInfo(_lastCommittedBatchData), "i"); // incorrect previous batch data
234: 
235:         bytes32 systemContractsUpgradeTxHash = s.l2SystemContractsUpgradeTxHash;
236:         // Upgrades are rarely done so we optimize a case with no active system contracts upgrade.
237:         if (systemContractsUpgradeTxHash == bytes32(0) || s.l2SystemContractsUpgradeBatchNumber != 0) {
238:             _commitBatchesWithoutSystemContractsUpgrade(_lastCommittedBatchData, _newBatchesData);
239:         } else {
240:             _commitBatchesWithSystemContractsUpgrade(
241:                 _lastCommittedBatchData,
242:                 _newBatchesData,
243:                 systemContractsUpgradeTxHash
244:             );
245:         }
246: 
247:         s.totalBatchesCommitted = s.totalBatchesCommitted + _newBatchesData.length;
248:     }

/// @audit Lines: 361 to 365
349:     function _executeBatches(StoredBatchInfo[] calldata _batchesData) internal { 
350:         uint256 nBatches = _batchesData.length;
351:         for (uint256 i = 0; i < nBatches; i = i.uncheckedInc()) {
352:             _executeOneBatch(_batchesData[i], i);
353:             emit BlockExecution(_batchesData[i].batchNumber, _batchesData[i].batchHash, _batchesData[i].commitment);
354:         }
355: 
356:         uint256 newTotalBatchesExecuted = s.totalBatchesExecuted + nBatches;
357:         s.totalBatchesExecuted = newTotalBatchesExecuted;
358:         require(newTotalBatchesExecuted <= s.totalBatchesVerified, "n"); // Can't execute batches more than committed and proven currently.
359: 
360:         uint256 batchWhenUpgradeHappened = s.l2SystemContractsUpgradeBatchNumber;
361:         if (batchWhenUpgradeHappened != 0 && batchWhenUpgradeHappened <= newTotalBatchesExecuted) {
362:             delete s.l2SystemContractsUpgradeTxHash;
363:             delete s.l2SystemContractsUpgradeBatchNumber;
364:         }
365:     }

/// @audit Lines: 16 to 20
472:     function revertBatches(uint256 _newLastBatch) external nonReentrant onlyValidatorOrStateTransitionManager { 
473:         _revertBatches(_newLastBatch);
474:     }

/// @audit Lines: 668 to 672
/// @audit Lines: 668 to 672
/// @audit Lines: 668 to 672
625:     function _verifyBlobInformation( 
626:         bytes calldata _pubdataCommitments,
627:         bytes32[] memory _blobHashes
628:     ) internal view returns (bytes32[] memory blobCommitments) {
629:         uint256 versionedHashIndex = 0;
630: 
631:         require(_pubdataCommitments.length > 0, "pl");
632:         require(_pubdataCommitments.length <= PUBDATA_COMMITMENT_SIZE * MAX_NUMBER_OF_BLOBS, "bd");
633:         require(_pubdataCommitments.length % PUBDATA_COMMITMENT_SIZE == 0, "bs");
634:         blobCommitments = new bytes32[](MAX_NUMBER_OF_BLOBS);
635: 
636:         for (uint256 i = 0; i < _pubdataCommitments.length; i += PUBDATA_COMMITMENT_SIZE) {
637:             bytes32 blobVersionedHash = _getBlobVersionedHash(versionedHashIndex);
638: 
639:             require(blobVersionedHash != bytes32(0), "vh");
640: 
641:             // First 16 bytes is the opening point. While we get the point as 16 bytes, the point evaluation precompile
642:             // requires it to be 32 bytes. The blob commitment must use the opening point as 16 bytes though.
643:             bytes32 openingPoint = bytes32(
644:                 uint256(uint128(bytes16(_pubdataCommitments[i:i + PUBDATA_COMMITMENT_CLAIMED_VALUE_OFFSET])))
645:             );
646: 
647:             _pointEvaluationPrecompile(
648:                 blobVersionedHash,
649:                 openingPoint,
650:                 _pubdataCommitments[i + PUBDATA_COMMITMENT_CLAIMED_VALUE_OFFSET:i + PUBDATA_COMMITMENT_SIZE]
651:             );
652: 
653:             // Take the hash of the versioned hash || opening point || claimed value
654:             blobCommitments[versionedHashIndex] = keccak256(
655:                 abi.encodePacked(blobVersionedHash, _pubdataCommitments[i:i + PUBDATA_COMMITMENT_COMMITMENT_OFFSET])
656:             );
657:             versionedHashIndex += 1;
658:         }
659: 
660:         // This check is required because we want to ensure that there aren't any extra blobs trying to be published.
661:         // Calling the BLOBHASH opcode with an index > # blobs - 1 yields bytes32(0)
662:         bytes32 versionedHash = _getBlobVersionedHash(versionedHashIndex);
663:         require(versionedHash == bytes32(0), "lh");
664: 
665:         // We verify that for each set of blobHash/blobCommitment are either both empty
666:         // or there are values for both.
667:         for (uint256 i = 0; i < MAX_NUMBER_OF_BLOBS; i++) {
668:             require(
669:                 (_blobHashes[i] == bytes32(0) && blobCommitments[i] == bytes32(0)) ||
670:                     (_blobHashes[i] != bytes32(0) && blobCommitments[i] != bytes32(0)),
671:                 "bh"
672:             );
673:         }
674:     }
```
[32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L32-L97), [215](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L215-L248), [349](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L349-L365), [472](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L472-L474), [625](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L625-L674)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

/// @audit Lines: 147 to 152
/// @audit Lines: 147 to 152
142:     function _setVerifierParams(VerifierParams calldata _newVerifierParams) private { 
143:         // An upgrade to the verifier params must be done carefully to ensure there aren't batches in the committed state
144:         // during the transition. If verifier is upgraded, it will immediately be used to prove all committed batches.
145:         // Batches committed expecting the old verifier params will fail. Ensure all commited batches are finalized before the
146:         // verifier is upgraded.
147:         if (
148:             _newVerifierParams.recursionNodeLevelVkHash == bytes32(0) &&
149:             _newVerifierParams.recursionLeafLevelVkHash == bytes32(0) &&
150:             _newVerifierParams.recursionCircuitsSetVksHash == bytes32(0)
151:         ) {
152:             return;
153:         }
154: 
155:         VerifierParams memory oldVerifierParams = s.verifierParams;
156:         s.verifierParams = _newVerifierParams;
157:         emit NewVerifierParams(oldVerifierParams, _newVerifierParams);
158:     }
```
[142](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L142-L158)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

/// @audit Lines: 104 to 107
49:     function initialize( 
50:         address _l1Bridge,
51:         address _l1LegecyBridge,
52:         bytes32 _l2TokenProxyBytecodeHash,
53:         address _aliasedOwner
54:     ) external reinitializer(2) {
55:         require(_l1Bridge != address(0), "bf");
56:         require(_l2TokenProxyBytecodeHash != bytes32(0), "df");
57:         require(_aliasedOwner != address(0), "sf");
58:         require(_l2TokenProxyBytecodeHash != bytes32(0), "df");
59: 
60:         l1Bridge = _l1Bridge;
61:         l2TokenProxyBytecodeHash = _l2TokenProxyBytecodeHash;
62: 
63:         if (block.chainid != ERA_CHAIN_ID) {
64:             address l2StandardToken = address(new L2StandardERC20{salt: bytes32(0)}());
65:             l2TokenBeacon = new UpgradeableBeacon{salt: bytes32(0)}(l2StandardToken);
66:             l2TokenBeacon.transferOwnership(_aliasedOwner);
67:         } else {
68:             require(_l1LegecyBridge != address(0), "bf2");
69:             // l2StandardToken and l2TokenBeacon are already deployed on ERA, and stored in the proxy
70:         }
71:     }

/// @audit Lines: 87 to 91
79:     function finalizeDeposit( 
80:         address _l1Sender,
81:         address _l2Receiver,
82:         address _l1Token,
83:         uint256 _amount,
84:         bytes calldata _data
85:     ) external payable override {
86:         // Only the L1 bridge counterpart can initiate and finalize the deposit.
87:         require(
88:             AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1Bridge ||
89:                 AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1LegacyBridge,
90:             "mq"
91:         );
92:         require(msg.value == 0, "Value should be 0 for ERC20 bridge");
93: 
94:         address expectedL2Token = l2TokenAddress(_l1Token);
95:         address currentL1Token = l1TokenAddress[expectedL2Token];
96:         if (currentL1Token == address(0)) {
97:             address deployedToken = _deployL2Token(_l1Token, _data);
98:             require(deployedToken == expectedL2Token, "mt");
99:             l1TokenAddress[expectedL2Token] = _l1Token;
100:         } else {
101:             require(currentL1Token == _l1Token, "gg"); // Double check that the expected value equal to real one
102:         }
103: 
104:         IL2StandardToken(expectedL2Token).bridgeMint(_l2Receiver, _amount);
105:         emit FinalizeDeposit(_l1Sender, _l2Receiver, expectedL2Token, _amount);
106:     }
```
[49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L49-L71), [79](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L79-L106)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

/// @audit Lines: 66 to 70
/// @audit Lines: 66 to 70
/// @audit Lines: 66 to 70
50:     function bridgeInitialize(address _l1Address, bytes memory _data) external initializer { 
51:         require(_l1Address != address(0), "in6"); // Should be non-zero address
52:         l1Address = _l1Address;
53: 
54:         l2Bridge = msg.sender;
55: 
56:         // We parse the data exactly as they were created on the L1 bridge
57:         (bytes memory nameBytes, bytes memory symbolBytes, bytes memory decimalsBytes) = abi.decode(
58:             _data,
59:             (bytes, bytes, bytes)
60:         );
61: 
62:         ERC20Getters memory getters;
63:         string memory decodedName;
64:         string memory decodedSymbol;
65: 
66:         // L1 bridge didn't check if the L1 token return values with proper types for `name`/`symbol`/`decimals`
67:         // That's why we need to try to decode them, and if it works out, set the values as getters.
68: 
69:         // NOTE: Solidity doesn't have a convenient way to try to decode a value:
70:         // - Decode them manually, i.e. write a function that will validate that data in the correct format
71:         // and return decoded value and a boolean value - whether it was possible to decode.
72:         // - Use the standard abi.decode method, but wrap it into an external call in which error can be handled.
73:         // We use the second option here.
74: 
75:         try this.decodeString(nameBytes) returns (string memory nameString) {
76:             decodedName = nameString;
77:         } catch {
78:             getters.ignoreName = true;
79:         }
80: 
81:         try this.decodeString(symbolBytes) returns (string memory symbolString) {
82:             decodedSymbol = symbolString;
83:         } catch {
84:             getters.ignoreSymbol = true;
85:         }
86: 
87:         // Set decoded values for name and symbol.
88:         __ERC20_init_unchained(decodedName, decodedSymbol);
89: 
90:         // Set the name for EIP-712 signature.
91:         __ERC20Permit_init(decodedName);
92: 
93:         try this.decodeUint8(decimalsBytes) returns (uint8 decimalsUint8) {
94:             // Set decoded value for decimals.
95:             decimals_ = decimalsUint8;
96:         } catch {
97:             getters.ignoreDecimals = true;
98:         }
99: 
100:         availableGetters = getters;
101:         emit BridgeInitialize(_l1Address, decodedName, decodedSymbol, decimals_);
102:     }

/// @audit Lines: 104 to 107
111:     function reinitializeToken( 
112:         ERC20Getters calldata _availableGetters,
113:         string memory _newName,
114:         string memory _newSymbol,
115:         uint8 _version
116:     ) external onlyNextVersion(_version) reinitializer(_version) {
117:         // It is expected that this token is deployed as a beacon proxy, so we'll
118:         // allow the governor of the beacon to reinitialize the token.
119:         address beaconAddress = _getBeacon();
120:         require(msg.sender == UpgradeableBeacon(beaconAddress).owner(), "tt");
121: 
122:         __ERC20_init_unchained(_newName, _newSymbol);
123:         __ERC20Permit_init(_newName);
124:         availableGetters = _availableGetters;
125: 
126:         emit BridgeInitialize(l1Address, _newName, _newSymbol, decimals_);
127:     }
```
[50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L50-L102), [111](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L111-L127)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

/// @audit Lines: 102 to 112
89:     function getCodeHash(uint256 _input) external view override returns (bytes32) { 
90:         // We consider the account bytecode hash of the last 20 bytes of the input, because
91:         // according to the spec "If EXTCODEHASH of A is X, then EXTCODEHASH of A + 2**160 is X".
92:         address account = address(uint160(_input));
93:         if (uint160(account) <= CURRENT_MAX_PRECOMPILE_ADDRESS) {
94:             return EMPTY_STRING_KECCAK;
95:         }
96: 
97:         bytes32 codeHash = getRawCodeHash(account);
98: 
99:         // The code hash is equal to the `keccak256("")` if the account is an EOA with at least one transaction.
100:         // Otherwise, the account is either deployed smart contract or an empty account,
101:         // for both cases the code hash is equal to the raw code hash.
102:         if (codeHash == 0x00 && NONCE_HOLDER_SYSTEM_CONTRACT.getRawNonce(account) > 0) {
103:             codeHash = EMPTY_STRING_KECCAK;
104:         }
105:         // The contract is still on the constructor, which means it is not deployed yet,
106:         // so set `keccak256("")` as a code hash. The EVM has the same behavior.
107:         else if (Utils.isContractConstructing(codeHash)) {
108:             codeHash = EMPTY_STRING_KECCAK;
109:         }
110: 
111:         return codeHash;
112:     }

/// @audit Lines: 131 to 136
/// @audit Lines: 131 to 136
117:     function getCodeSize(uint256 _input) external view override returns (uint256 codeSize) { 
118:         // We consider the account bytecode size of the last 20 bytes of the input, because
119:         // according to the spec "If EXTCODESIZE of A is X, then EXTCODESIZE of A + 2**160 is X".
120:         address account = address(uint160(_input));
121:         bytes32 codeHash = getRawCodeHash(account);
122: 
123:         // If the contract is a default account or is on constructor the code size is zero,
124:         // otherwise extract the proper value for it from the bytecode hash.
125:         // NOTE: zero address and precompiles are a special case, they are contracts, but we
126:         // want to preserve EVM invariants (see EIP-1052 specification). That's why we automatically
127:         // return `0` length in the following cases:
128:         // - `codehash(0) == 0`
129:         // - `account` is a precompile.
130:         // - `account` is currently being constructed
131:         if (
132:             uint160(account) > CURRENT_MAX_PRECOMPILE_ADDRESS &&
133:             codeHash != 0x00 &&
134:             !Utils.isContractConstructing(codeHash)
135:         ) {
136:             codeSize = Utils.bytecodeLenInBytes(codeHash);
137:         }
138:     }
```
[89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L89-L112), [117](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L117-L138)

```solidity
üìÅ File: system-contracts/contracts/BootloaderUtilities.sol

/// @audit Lines: 92 to 93
44:     function encodeLegacyTransactionHash(Transaction calldata _transaction) internal view returns (bytes32 txHash) { 
45:         // Hash of legacy transactions are encoded as one of the:
46:         // - RLP(nonce, gasPrice, gasLimit, to, value, data, chainId, 0, 0)
47:         // - RLP(nonce, gasPrice, gasLimit, to, value, data)
48:         //
49:         // In this RLP encoding, only the first one above list appears, so we encode each element
50:         // inside list and then concatenate the length of all elements with them.
51: 
52:         bytes memory encodedNonce = RLPEncoder.encodeUint256(_transaction.nonce);
53:         // Encode `gasPrice` and `gasLimit` together to prevent "stack too deep error".
54:         bytes memory encodedGasParam;
55:         {
56:             bytes memory encodedGasPrice = RLPEncoder.encodeUint256(_transaction.maxFeePerGas);
57:             bytes memory encodedGasLimit = RLPEncoder.encodeUint256(_transaction.gasLimit);
58:             encodedGasParam = bytes.concat(encodedGasPrice, encodedGasLimit);
59:         }
60: 
61:         bytes memory encodedTo = RLPEncoder.encodeAddress(address(uint160(_transaction.to)));
62:         bytes memory encodedValue = RLPEncoder.encodeUint256(_transaction.value);
63:         // Encode only the length of the transaction data, and not the data itself,
64:         // so as not to copy to memory a potentially huge transaction data twice.
65:         bytes memory encodedDataLength;
66:         {
67:             // Safe cast, because the length of the transaction data can't be so large.
68:             uint64 txDataLen = uint64(_transaction.data.length);
69:             if (txDataLen != 1) {
70:                 // If the length is not equal to one, then only using the length can it be encoded definitely.
71:                 encodedDataLength = RLPEncoder.encodeNonSingleBytesLen(txDataLen);
72:             } else if (_transaction.data[0] >= 0x80) {
73:                 // If input is a byte in [0x80, 0xff] range, RLP encoding will concatenates 0x81 with the byte.
74:                 encodedDataLength = hex"81";
75:             }
76:             // Otherwise the length is not encoded at all.
77:         }
78: 
79:         bytes memory rEncoded;
80:         {
81:             uint256 rInt = uint256(bytes32(_transaction.signature[0:32]));
82:             rEncoded = RLPEncoder.encodeUint256(rInt);
83:         }
84:         bytes memory sEncoded;
85:         {
86:             uint256 sInt = uint256(bytes32(_transaction.signature[32:64]));
87:             sEncoded = RLPEncoder.encodeUint256(sInt);
88:         }
89:         bytes memory vEncoded;
90:         {
91:             uint256 vInt = uint256(uint8(_transaction.signature[64]));
92:             require(vInt == 27 || vInt == 28, "Invalid v value");
93: 
94:             // If the `chainId` is specified in the transaction, then the `v` value is encoded as
95:             // `35 + y + 2 * chainId == vInt + 8 + 2 * chainId`, where y - parity bit (see EIP-155).
96:             if (_transaction.reserved[0] != 0) {
97:                 vInt += 8 + block.chainid * 2;
98:             }
99: 
100:             vEncoded = RLPEncoder.encodeUint256(vInt);
101:         }
102: 
103:         bytes memory encodedListLength;
104:         unchecked {
105:             uint256 listLength = encodedNonce.length +
106:                 encodedGasParam.length +
107:                 encodedTo.length +
108:                 encodedValue.length +
109:                 encodedDataLength.length +
110:                 _transaction.data.length +
111:                 rEncoded.length +
112:                 sEncoded.length +
113:                 vEncoded.length;
114: 
115:             // Safe cast, because the length of the list can't be so large.
116:             encodedListLength = RLPEncoder.encodeListLen(uint64(listLength));
117:         }
118: 
119:         return
120:             keccak256(
121:                 bytes.concat(
122:                     encodedListLength,
123:                     encodedNonce,
124:                     encodedGasParam,
125:                     encodedTo,
126:                     encodedValue,
127:                     encodedDataLength,
128:                     _transaction.data,
129:                     vEncoded,
130:                     rEncoded,
131:                     sEncoded
132:                 )
133:             );
134:     }

/// @audit Lines: 191 to 192
139:     function encodeEIP2930TransactionHash(Transaction calldata _transaction) internal view returns (bytes32) { 
140:         // Encode all fixed-length params to avoid "stack too deep error"
141:         bytes memory encodedFixedLengthParams;
142:         {
143:             bytes memory encodedChainId = RLPEncoder.encodeUint256(block.chainid);
144:             bytes memory encodedNonce = RLPEncoder.encodeUint256(_transaction.nonce);
145:             bytes memory encodedGasPrice = RLPEncoder.encodeUint256(_transaction.maxFeePerGas);
146:             bytes memory encodedGasLimit = RLPEncoder.encodeUint256(_transaction.gasLimit);
147:             bytes memory encodedTo = RLPEncoder.encodeAddress(address(uint160(_transaction.to)));
148:             bytes memory encodedValue = RLPEncoder.encodeUint256(_transaction.value);
149:             encodedFixedLengthParams = bytes.concat(
150:                 encodedChainId,
151:                 encodedNonce,
152:                 encodedGasPrice,
153:                 encodedGasLimit,
154:                 encodedTo,
155:                 encodedValue
156:             );
157:         }
158: 
159:         // Encode only the length of the transaction data, and not the data itself,
160:         // so as not to copy to memory a potentially huge transaction data twice.
161:         bytes memory encodedDataLength;
162:         {
163:             // Safe cast, because the length of the transaction data can't be so large.
164:             uint64 txDataLen = uint64(_transaction.data.length);
165:             if (txDataLen != 1) {
166:                 // If the length is not equal to one, then only using the length can it be encoded definitely.
167:                 encodedDataLength = RLPEncoder.encodeNonSingleBytesLen(txDataLen);
168:             } else if (_transaction.data[0] >= 0x80) {
169:                 // If input is a byte in [0x80, 0xff] range, RLP encoding will concatenates 0x81 with the byte.
170:                 encodedDataLength = hex"81";
171:             }
172:             // Otherwise the length is not encoded at all.
173:         }
174: 
175:         // On zkSync, access lists are always zero length (at least for now).
176:         bytes memory encodedAccessListLength = RLPEncoder.encodeListLen(0);
177: 
178:         bytes memory rEncoded;
179:         {
180:             uint256 rInt = uint256(bytes32(_transaction.signature[0:32]));
181:             rEncoded = RLPEncoder.encodeUint256(rInt);
182:         }
183:         bytes memory sEncoded;
184:         {
185:             uint256 sInt = uint256(bytes32(_transaction.signature[32:64]));
186:             sEncoded = RLPEncoder.encodeUint256(sInt);
187:         }
188:         bytes memory vEncoded;
189:         {
190:             uint256 vInt = uint256(uint8(_transaction.signature[64]));
191:             require(vInt == 27 || vInt == 28, "Invalid v value");
192: 
193:             vEncoded = RLPEncoder.encodeUint256(vInt - 27);
194:         }
195: 
196:         bytes memory encodedListLength;
197:         unchecked {
198:             uint256 listLength = encodedFixedLengthParams.length +
199:                 encodedDataLength.length +
200:                 _transaction.data.length +
201:                 encodedAccessListLength.length +
202:                 rEncoded.length +
203:                 sEncoded.length +
204:                 vEncoded.length;
205: 
206:             // Safe cast, because the length of the list can't be so large.
207:             encodedListLength = RLPEncoder.encodeListLen(uint64(listLength));
208:         }
209: 
210:         return
211:             keccak256(
212:                 bytes.concat(
213:                     "\x01",
214:                     encodedListLength,
215:                     encodedFixedLengthParams,
216:                     encodedDataLength,
217:                     _transaction.data,
218:                     encodedAccessListLength,
219:                     vEncoded,
220:                     rEncoded,
221:                     sEncoded
222:                 )
223:             );
224:     }

/// @audit Lines: 286 to 287
229:     function encodeEIP1559TransactionHash(Transaction calldata _transaction) internal view returns (bytes32) { 
230:         // The formula for hash of EIP1559 transaction in the original proposal:
231:         // https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1559.md
232: 
233:         // Encode all fixed-length params to avoid "stack too deep error"
234:         bytes memory encodedFixedLengthParams;
235:         {
236:             bytes memory encodedChainId = RLPEncoder.encodeUint256(block.chainid);
237:             bytes memory encodedNonce = RLPEncoder.encodeUint256(_transaction.nonce);
238:             bytes memory encodedMaxPriorityFeePerGas = RLPEncoder.encodeUint256(_transaction.maxPriorityFeePerGas);
239:             bytes memory encodedMaxFeePerGas = RLPEncoder.encodeUint256(_transaction.maxFeePerGas);
240:             bytes memory encodedGasLimit = RLPEncoder.encodeUint256(_transaction.gasLimit);
241:             bytes memory encodedTo = RLPEncoder.encodeAddress(address(uint160(_transaction.to)));
242:             bytes memory encodedValue = RLPEncoder.encodeUint256(_transaction.value);
243:             encodedFixedLengthParams = bytes.concat(
244:                 encodedChainId,
245:                 encodedNonce,
246:                 encodedMaxPriorityFeePerGas,
247:                 encodedMaxFeePerGas,
248:                 encodedGasLimit,
249:                 encodedTo,
250:                 encodedValue
251:             );
252:         }
253: 
254:         // Encode only the length of the transaction data, and not the data itself,
255:         // so as not to copy to memory a potentially huge transaction data twice.
256:         bytes memory encodedDataLength;
257:         {
258:             // Safe cast, because the length of the transaction data can't be so large.
259:             uint64 txDataLen = uint64(_transaction.data.length);
260:             if (txDataLen != 1) {
261:                 // If the length is not equal to one, then only using the length can it be encoded definitely.
262:                 encodedDataLength = RLPEncoder.encodeNonSingleBytesLen(txDataLen);
263:             } else if (_transaction.data[0] >= 0x80) {
264:                 // If input is a byte in [0x80, 0xff] range, RLP encoding will concatenates 0x81 with the byte.
265:                 encodedDataLength = hex"81";
266:             }
267:             // Otherwise the length is not encoded at all.
268:         }
269: 
270:         // On zkSync, access lists are always zero length (at least for now).
271:         bytes memory encodedAccessListLength = RLPEncoder.encodeListLen(0);
272: 
273:         bytes memory rEncoded;
274:         {
275:             uint256 rInt = uint256(bytes32(_transaction.signature[0:32]));
276:             rEncoded = RLPEncoder.encodeUint256(rInt);
277:         }
278:         bytes memory sEncoded;
279:         {
280:             uint256 sInt = uint256(bytes32(_transaction.signature[32:64]));
281:             sEncoded = RLPEncoder.encodeUint256(sInt);
282:         }
283:         bytes memory vEncoded;
284:         {
285:             uint256 vInt = uint256(uint8(_transaction.signature[64]));
286:             require(vInt == 27 || vInt == 28, "Invalid v value");
287: 
288:             vEncoded = RLPEncoder.encodeUint256(vInt - 27);
289:         }
290: 
291:         bytes memory encodedListLength;
292:         unchecked {
293:             uint256 listLength = encodedFixedLengthParams.length +
294:                 encodedDataLength.length +
295:                 _transaction.data.length +
296:                 encodedAccessListLength.length +
297:                 rEncoded.length +
298:                 sEncoded.length +
299:                 vEncoded.length;
300: 
301:             // Safe cast, because the length of the list can't be so large.
302:             encodedListLength = RLPEncoder.encodeListLen(uint64(listLength));
303:         }
304: 
305:         return
306:             keccak256(
307:                 bytes.concat(
308:                     "\x02",
309:                     encodedListLength,
310:                     encodedFixedLengthParams,
311:                     encodedDataLength,
312:                     _transaction.data,
313:                     encodedAccessListLength,
314:                     vEncoded,
315:                     rEncoded,
316:                     sEncoded
317:                 )
318:             );
319:     }
```
[44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L44-L134), [139](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L139-L224), [229](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L229-L319)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

/// @audit Lines: 229 to 237
220:     function _verifyValueCompression( 
221:         uint256 _initialValue,
222:         uint256 _finalValue,
223:         uint256 _operation,
224:         bytes calldata _compressedValue
225:     ) internal pure {
226:         uint256 convertedValue = _sliceToUint256(_compressedValue);
227: 
228:         unchecked {
229:             if (_operation == 0 || _operation == 3) {
230:                 require(convertedValue == _finalValue, "transform or no compression: compressed and final mismatch");
231:             } else if (_operation == 1) {
232:                 require(
233:                     _initialValue + convertedValue == _finalValue,
234:                     "add: initial plus converted not equal to final"
235:                 );
236:             } else if (_operation == 2) {
237:                 require(
238:                     _initialValue - convertedValue == _finalValue,
239:                     "sub: initial minus converted not equal to final"
240:                 );
241:             } else {
242:                 revert("unsupported operation");
243:             }
244:         }
245:     }
```
[220](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L220-L245)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

/// @audit Lines: 47 to 52
40:     function extendedAccountVersion(address _address) public view returns (AccountAbstractionVersion) { 
41:         AccountInfo memory info = accountInfo[_address];
42:         if (info.supportedAAVersion != AccountAbstractionVersion.None) {
43:             return info.supportedAAVersion;
44:         }
45: 
46:         // It is an EOA, it is still an account.
47:         if (
48:             _address > address(MAX_SYSTEM_CONTRACT_ADDRESS) &&
49:             ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.getRawCodeHash(_address) == 0
50:         ) {
51:             return AccountAbstractionVersion.Version1;
52:         }
53: 
54:         return AccountAbstractionVersion.None;
55:     }

/// @audit Lines: 16 to 20
65:     function updateAccountVersion(AccountAbstractionVersion _version) external onlySystemCall { 
66:         accountInfo[msg.sender].supportedAAVersion = _version;
67: 
68:         emit AccountVersionUpdated(msg.sender, _version);
69:     }

/// @audit Lines: 77 to 82
/// @audit Lines: 16 to 20
74:     function updateNonceOrdering(AccountNonceOrdering _nonceOrdering) external onlySystemCall { 
75:         AccountInfo memory currentInfo = accountInfo[msg.sender];
76: 
77:         require(
78:             _nonceOrdering == AccountNonceOrdering.Arbitrary &&
79:                 currentInfo.nonceOrdering == AccountNonceOrdering.Sequential,
80:             "It is only possible to change from sequential to arbitrary ordering"
81:         );
82: 
83:         currentInfo.nonceOrdering = _nonceOrdering;
84:         _storeAccountInfo(msg.sender, currentInfo);
85: 
86:         emit AccountNonceOrderingUpdated(msg.sender, _nonceOrdering);
87:     }

/// @audit Lines: 16 to 20
162:     function create2Account( 
163:         bytes32 _salt,
164:         bytes32 _bytecodeHash,
165:         bytes calldata _input,
166:         AccountAbstractionVersion _aaVersion
167:     ) public payable override onlySystemCall returns (address) {
168:         NONCE_HOLDER_SYSTEM_CONTRACT.incrementDeploymentNonce(msg.sender);
169:         address newAddress = getNewAddressCreate2(msg.sender, _bytecodeHash, _salt, _input);
170: 
171:         _nonSystemDeployOnAddress(_bytecodeHash, newAddress, _aaVersion, _input);
172: 
173:         return newAddress;
174:     }

/// @audit Lines: 16 to 20
182:     function createAccount( 
183:         bytes32, // salt
184:         bytes32 _bytecodeHash,
185:         bytes calldata _input,
186:         AccountAbstractionVersion _aaVersion
187:     ) public payable override onlySystemCall returns (address) {
188:         uint256 senderNonce = NONCE_HOLDER_SYSTEM_CONTRACT.incrementDeploymentNonce(msg.sender);
189:         address newAddress = getNewAddressCreate(msg.sender, senderNonce);
190: 
191:         _nonSystemDeployOnAddress(_bytecodeHash, newAddress, _aaVersion, _input);
192: 
193:         return newAddress;
194:     }

/// @audit Lines: 239 to 243
238:     function forceDeployOnAddresses(ForceDeployment[] calldata _deployments) external payable { 
239:         require(
240:             msg.sender == FORCE_DEPLOYER || msg.sender == address(COMPLEX_UPGRADER_CONTRACT),
241:             "Can only be called by FORCE_DEPLOYER or COMPLEX_UPGRADER_CONTRACT"
242:         );
243: 
244:         uint256 deploymentsLength = _deployments.length;
245:         // We need to ensure that the `value` provided by the call is enough to provide `value`
246:         // for all of the deployments
247:         uint256 sumOfValues = 0;
248:         for (uint256 i = 0; i < deploymentsLength; ++i) {
249:             sumOfValues += _deployments[i].value;
250:         }
251:         require(msg.value == sumOfValues, "`value` provided is not equal to the combined `value`s of deployments");
252: 
253:         for (uint256 i = 0; i < deploymentsLength; ++i) {
254:             this.forceDeployOnAddress{value: _deployments[i].value}(_deployments[i], msg.sender);
255:         }
256:     }
```
[40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L40-L55), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L65-L69), [74](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L74-L87), [162](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L162-L174), [182](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L182-L194), [238](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L238-L256)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

/// @audit Lines: 139 to 153
131:     function _execute(Transaction calldata _transaction) internal { 
132:         address to = address(uint160(_transaction.to));
133:         uint128 value = Utils.safeCastToU128(_transaction.value);
134:         bytes calldata data = _transaction.data;
135:         uint32 gas = Utils.safeCastToU32(gasleft());
136: 
137:         // Note, that the deployment method from the deployer contract can only be called with a "systemCall" flag.
138:         bool isSystemCall;
139:         if (to == address(DEPLOYER_SYSTEM_CONTRACT) && data.length >= 4) {
140:             bytes4 selector = bytes4(data[:4]);
141:             // Check that called function is the deployment method,
142:             // the others deployer method is not supposed to be called from the default account.
143:             isSystemCall =
144:                 selector == DEPLOYER_SYSTEM_CONTRACT.create.selector ||
145:                 selector == DEPLOYER_SYSTEM_CONTRACT.create2.selector ||
146:                 selector == DEPLOYER_SYSTEM_CONTRACT.createAccount.selector ||
147:                 selector == DEPLOYER_SYSTEM_CONTRACT.create2Account.selector;
148:         }
149:         bool success = EfficientCall.rawCall(gas, to, value, data, isSystemCall);
150:         if (!success) {
151:             EfficientCall.propagateRevert();
152:         }
153:     }

/// @audit Lines: 173 to 174
159:     function _isValidSignature(bytes32 _hash, bytes memory _signature) internal view returns (bool) { 
160:         require(_signature.length == 65, "Signature length is incorrect");
161:         uint8 v;
162:         bytes32 r;
163:         bytes32 s;
164:         // Signature loading code
165:         // we jump 32 (0x20) as the first slot of bytes contains the length
166:         // we jump 65 (0x41) per signature
167:         // for v we load 32 bytes ending with v (the first 31 come from s) then apply a mask
168:         assembly {
169:             r := mload(add(_signature, 0x20))
170:             s := mload(add(_signature, 0x40))
171:             v := and(mload(add(_signature, 0x41)), 0xff)
172:         }
173:         require(v == 27 || v == 28, "v is neither 27 nor 28");
174: 
175:         // EIP-2 still allows signature malleability for ecrecover(). Remove this possibility and make the signature
176:         // unique. Appendix F in the Ethereum Yellow paper (https://ethereum.github.io/yellowpaper/paper.pdf), defines
177:         // the valid range for s in (301): 0 < s < secp256k1n √∑ 2 + 1, and for v in (302): v ‚àà {27, 28}. Most
178:         // signatures from current libraries generate a unique signature with an s-value in the lower half order.
179:         //
180:         // If your library generates malleable signatures, such as s-values in the upper range, calculate a new s-value
181:         // with 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141 - s1 and flip v from 27 to 28 or
182:         // vice versa. If your library also generates signatures with 0/1 for v instead 27/28, add 27 to v to accept
183:         // these malleable signatures as well.
184:         require(uint256(s) <= 0x7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5D576E7357A4501DDFE92F46681B20A0, "Invalid s");
185: 
186:         address recoveredAddress = ecrecover(_hash, v, r, s);
187: 
188:         return recoveredAddress == address(this) && recoveredAddress != address(0);
189:     }
```
[131](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L131-L153), [159](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L159-L189)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

/// @audit Lines: 76 to 79
74:     function _validateBytecode(bytes32 _bytecodeHash) internal pure { 
75:         uint8 version = uint8(_bytecodeHash[0]);
76:         require(version == 1 && _bytecodeHash[1] == bytes1(0), "Incorrectly formatted bytecodeHash");
77: 
78:         require(Utils.bytecodeLenInWords(_bytecodeHash) % 2 == 1, "Code length in words must be odd");
79:     }
```
[74](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L74-L79)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

/// @audit Lines: 33 to 38
/// @audit Lines: 33 to 38
32:     function transferFromTo(address _from, address _to, uint256 _amount) external override { 
33:         require(
34:             msg.sender == MSG_VALUE_SYSTEM_CONTRACT ||
35:                 msg.sender == address(DEPLOYER_SYSTEM_CONTRACT) ||
36:                 msg.sender == BOOTLOADER_FORMAL_ADDRESS,
37:             "Only system contracts with special access can call this method"
38:         );
39: 
40:         uint256 fromBalance = balance[_from];
41:         require(fromBalance >= _amount, "Transfer amount exceeds balance");
42:         unchecked {
43:             balance[_from] = fromBalance - _amount;
44:             // Overflow not possible: the sum of all balances is capped by totalSupply, and the sum is preserved by
45:             // decrementing then incrementing.
46:             balance[_to] += _amount;
47:         }
48: 
49:         emit Transfer(_from, _to, _amount);
50:     }
```
[32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L32-L50)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

/// @audit Lines: 19 to 24
47:     fallback(bytes calldata _data) external onlySystemCall returns (bytes memory) { 
48:         // Firstly we calculate how much gas has been actually provided by the user to the inner call.
49:         // For that, we need to get the total gas available in this context and subtract the stipend from it.
50:         uint256 gasInContext = gasleft();
51:         // Note, that the `gasInContext` might be slightly less than the MSG_VALUE_SIMULATOR_STIPEND_GAS, since
52:         // by the time we retrieve it, some gas might have already been spent, e.g. on the `gasleft` opcode itself.
53:         uint256 userGas = gasInContext > MSG_VALUE_SIMULATOR_STIPEND_GAS
54:             ? gasInContext - MSG_VALUE_SIMULATOR_STIPEND_GAS
55:             : 0;
56: 
57:         (uint256 value, bool isSystemCall, address to) = _getAbiParams();
58: 
59:         // Prevent mimic call to the MsgValueSimulator to prevent an unexpected change of callee.
60:         require(to != address(this), "MsgValueSimulator calls itself");
61: 
62:         if (value != 0) {
63:             (bool success, ) = address(REAL_BASE_TOKEN_SYSTEM_CONTRACT).call(
64:                 abi.encodeCall(REAL_BASE_TOKEN_SYSTEM_CONTRACT.transferFromTo, (msg.sender, to, value))
65:             );
66: 
67:             // If the transfer of ETH fails, we do the most Ethereum-like behaviour in such situation: revert(0,0)
68:             if (!success) {
69:                 assembly {
70:                     revert(0, 0)
71:                 }
72:             }
73: 
74:             // If value is non-zero, we also provide additional gas to the callee.
75:             userGas += GAS_TO_PASS;
76:         }
77: 
78:         // For the next call this `msg.value` will be used.
79:         SystemContractHelper.setValueForNextFarCall(Utils.safeCastToU128(value));
80: 
81:         return EfficientCall.mimicCall(userGas, to, _data, msg.sender, false, isSystemCall);
82:     }
```
[47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L47-L82)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

/// @audit Lines: 19 to 23
65:     function increaseMinNonce(uint256 _value) public onlySystemCall returns (uint256 oldMinNonce) { 
66:         require(_value <= MAXIMAL_MIN_NONCE_INCREMENT, "The value for incrementing the nonce is too high");
67: 
68:         uint256 addressAsKey = uint256(uint160(msg.sender));
69:         uint256 oldRawNonce = rawNonces[addressAsKey];
70: 
71:         unchecked {
72:             rawNonces[addressAsKey] = (oldRawNonce + _value);
73:         }
74: 
75:         (, oldMinNonce) = _splitRawNonce(oldRawNonce);
76:     }

/// @audit Lines: 88 to 93
/// @audit Lines: 19 to 23
82:     function setValueUnderNonce(uint256 _key, uint256 _value) public onlySystemCall { 
83:         IContractDeployer.AccountInfo memory accountInfo = DEPLOYER_SYSTEM_CONTRACT.getAccountInfo(msg.sender);
84: 
85:         require(_value != 0, "Nonce value cannot be set to 0");
86:         // If an account has sequential nonce ordering, we enforce that the previous
87:         // nonce has already been used.
88:         if (accountInfo.nonceOrdering == IContractDeployer.AccountNonceOrdering.Sequential && _key != 0) {
89:             require(isNonceUsed(msg.sender, _key - 1), "Previous nonce has not been used");
90:         }
91: 
92:         uint256 addressAsKey = uint256(uint160(msg.sender));
93: 
94:         nonceValues[addressAsKey][_key] = _value;
95: 
96:         emit ValueSetUnderNonce(msg.sender, _key, _value);
97:     }

/// @audit Lines: 19 to 23
110:     function incrementMinNonceIfEquals(uint256 _expectedNonce) external onlySystemCall { 
111:         uint256 addressAsKey = uint256(uint160(msg.sender));
112:         uint256 oldRawNonce = rawNonces[addressAsKey];
113: 
114:         (, uint256 oldMinNonce) = _splitRawNonce(oldRawNonce);
115:         require(oldMinNonce == _expectedNonce, "Incorrect nonce");
116: 
117:         unchecked {
118:             rawNonces[addressAsKey] = oldRawNonce + 1;
119:         }
120:     }

/// @audit Lines: 171 to 174
166:     function validateNonceUsage(address _address, uint256 _key, bool _shouldBeUsed) external view { 
167:         bool isUsed = isNonceUsed(_address, _key);
168: 
169:         if (isUsed && !_shouldBeUsed) {
170:             revert("Reusing the same nonce twice");
171:         } else if (!isUsed && _shouldBeUsed) {
172:             revert("The nonce was not set as used");
173:         }
174:     }
```
[65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L65-L76), [82](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L82-L97), [110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L110-L120), [166](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L166-L174)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

/// @audit Lines: 144 to 164
/// @audit Lines: 150 to 163
132:     function getBlockHashEVM(uint256 _block) external view returns (bytes32 hash) { 
133:         uint128 blockNumber = currentVirtualL2BlockInfo.number;
134: 
135:         VirtualBlockUpgradeInfo memory currentVirtualBlockUpgradeInfo = virtualBlockUpgradeInfo;
136: 
137:         // Due to virtual blocks upgrade, we'll have to use the following logic for retreiving the blockhash:
138:         // 1. If the block number is out of the 256-block supported range, return 0.
139:         // 2. If the block was created before the upgrade for the virtual blocks (i.e. there we used to use hashes of the batches),
140:         // we return the hash of the batch.
141:         // 3. If the block was created after the day when the virtual blocks have caught up with the L2 blocks, i.e.
142:         // all the information which is returned for users should be for L2 blocks, we return the hash of the corresponding L2 block.
143:         // 4. If the block queried is a virtual blocks, calculate it on the fly.
144:         if (blockNumber <= _block || blockNumber - _block > 256) {
145:             hash = bytes32(0);
146:         } else if (_block < currentVirtualBlockUpgradeInfo.virtualBlockStartBatch) {
147:             // Note, that we will get into this branch only for a brief moment of time, right after the upgrade
148:             // for virtual blocks before 256 virtual blocks are produced.
149:             hash = batchHashes[_block];
150:         } else if (
151:             _block >= currentVirtualBlockUpgradeInfo.virtualBlockFinishL2Block &&
152:             currentVirtualBlockUpgradeInfo.virtualBlockFinishL2Block > 0
153:         ) {
154:             hash = _getLatest257L2blockHash(_block);
155:         } else {
156:             // Important: we do not want this number to ever collide with the L2 block hash (either new or old one) and so
157:             // that's why the legacy L2 blocks' hashes are keccak256(abi.encodePacked(uint32(_block))), while these are equivalent to
158:             // keccak256(abi.encodePacked(_block))
159:             hash = keccak256(abi.encode(_block));
160:         }
161:     }

/// @audit Lines: 277 to 297
263:     function _setVirtualBlock( 
264:         uint128 _l2BlockNumber,
265:         uint128 _maxVirtualBlocksToCreate,
266:         uint128 _newTimestamp
267:     ) internal {
268:         if (virtualBlockUpgradeInfo.virtualBlockFinishL2Block != 0) {
269:             // No need to to do anything about virtual blocks anymore
270:             // All the info is the same as for L2 blocks.
271:             currentVirtualL2BlockInfo = currentL2BlockInfo;
272:             return;
273:         }
274: 
275:         BlockInfo memory virtualBlockInfo = currentVirtualL2BlockInfo;
276: 
277:         if (currentVirtualL2BlockInfo.number == 0 && virtualBlockInfo.timestamp == 0) {
278:             uint128 currentBatchNumber = currentBatchInfo.number;
279: 
280:             // The virtual block is set for the first time. We can count it as 1 creation of a virtual block.
281:             // Note, that when setting the virtual block number we use the batch number to make a smoother upgrade from batch number to
282:             // the L2 block number.
283:             virtualBlockInfo.number = currentBatchNumber;
284:             // Remembering the batch number on which the upgrade to the virtual blocks has been done.
285:             virtualBlockUpgradeInfo.virtualBlockStartBatch = currentBatchNumber;
286: 
287:             require(_maxVirtualBlocksToCreate > 0, "Can't initialize the first virtual block");
288:             _maxVirtualBlocksToCreate -= 1;
289:         } else if (_maxVirtualBlocksToCreate == 0) {
290:             // The virtual blocks have been already initialized, but the operator didn't ask to create
291:             // any new virtual blocks. So we can just return.
292:             return;
293:         }
294: 
295:         virtualBlockInfo.number += _maxVirtualBlocksToCreate;
296:         virtualBlockInfo.timestamp = _newTimestamp;
297: 
298:         // The virtual block number must never exceed the L2 block number.
299:         // We do not use a `require` here, since the virtual blocks are a temporary solution to let the Solidity's `block.number`
300:         // catch up with the L2 block number and so the situation where virtualBlockInfo.number starts getting larger
301:         // than _l2BlockNumber is expected once virtual blocks have caught up the L2 blocks.
302:         if (virtualBlockInfo.number >= _l2BlockNumber) {
303:             virtualBlockUpgradeInfo.virtualBlockFinishL2Block = _l2BlockNumber;
304:             virtualBlockInfo.number = _l2BlockNumber;
305:         }
306: 
307:         currentVirtualL2BlockInfo = virtualBlockInfo;
308:     }

/// @audit Lines: 360 to 408
341:     function setL2Block( 
342:         uint128 _l2BlockNumber,
343:         uint128 _l2BlockTimestamp,
344:         bytes32 _expectedPrevL2BlockHash,
345:         bool _isFirstInBatch,
346:         uint128 _maxVirtualBlocksToCreate
347:     ) external onlyCallFromBootloader {
348:         // We check that the timestamp of the L2 block is consistent with the timestamp of the batch.
349:         if (_isFirstInBatch) {
350:             uint128 currentBatchTimestamp = currentBatchInfo.timestamp;
351:             require(
352:                 _l2BlockTimestamp >= currentBatchTimestamp,
353:                 "The timestamp of the L2 block must be greater than or equal to the timestamp of the current batch"
354:             );
355:             require(_maxVirtualBlocksToCreate > 0, "There must be a virtual block created at the start of the batch");
356:         }
357: 
358:         (uint128 currentL2BlockNumber, uint128 currentL2BlockTimestamp) = getL2BlockNumberAndTimestamp();
359: 
360:         if (currentL2BlockNumber == 0 && currentL2BlockTimestamp == 0) {
361:             // Since currentL2BlockNumber and currentL2BlockTimestamp are zero it means that it is
362:             // the first ever batch with L2 blocks, so we need to initialize those.
363:             _upgradeL2Blocks(_l2BlockNumber, _expectedPrevL2BlockHash, _isFirstInBatch);
364: 
365:             _setNewL2BlockData(_l2BlockNumber, _l2BlockTimestamp, _expectedPrevL2BlockHash);
366:         } else if (currentL2BlockNumber == _l2BlockNumber) {
367:             require(!_isFirstInBatch, "Can not reuse L2 block number from the previous batch");
368:             require(currentL2BlockTimestamp == _l2BlockTimestamp, "The timestamp of the same L2 block must be same");
369:             require(
370:                 _expectedPrevL2BlockHash == _getLatest257L2blockHash(_l2BlockNumber - 1),
371:                 "The previous hash of the same L2 block must be same"
372:             );
373:             require(_maxVirtualBlocksToCreate == 0, "Can not create virtual blocks in the middle of the miniblock");
374:         } else if (currentL2BlockNumber + 1 == _l2BlockNumber) {
375:             // From the checks in _upgradeL2Blocks it is known that currentL2BlockNumber can not be 0
376:             bytes32 prevL2BlockHash = _getLatest257L2blockHash(currentL2BlockNumber - 1);
377: 
378:             bytes32 pendingL2BlockHash = _calculateL2BlockHash(
379:                 currentL2BlockNumber,
380:                 currentL2BlockTimestamp,
381:                 prevL2BlockHash,
382:                 currentL2BlockTxsRollingHash
383:             );
384: 
385:             require(_expectedPrevL2BlockHash == pendingL2BlockHash, "The current L2 block hash is incorrect");
386:             require(
387:                 _l2BlockTimestamp > currentL2BlockTimestamp,
388:                 "The timestamp of the new L2 block must be greater than the timestamp of the previous L2 block"
389:             );
390: 
391:             // Since the new block is created, we'll clear out the rolling hash
392:             _setNewL2BlockData(_l2BlockNumber, _l2BlockTimestamp, _expectedPrevL2BlockHash);
393:         } else {
394:             revert("Invalid new L2 block number");
395:         }
396: 
397:         _setVirtualBlock(_l2BlockNumber, _maxVirtualBlocksToCreate, _l2BlockTimestamp);
398:     }
```
[132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L132-L161), [263](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L263-L308), [341](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L341-L398)

</details>


---
### [GAS&#x2011;68] Splitting `require()` statements that use `&&` saves gas
See [this issue](https://github.com/code-423n4/2022-01-xdefi-findings/issues/128) which describes the fact that there is a larger deployment gas cost, but with enough runtime calls, the change ends up being cheaper by **3 gas**


Gas saved per Instance: ~3 *(Total: ~15)*
<details>
<summary><i>There are 5 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

75:         require( 
76:             msg.sender == address(bridgehub) || (_chainId == ERA_CHAIN_ID && msg.sender == ERA_DIAMOND_PROXY),
77:             "L1SharedBridge: not bridgehub or era chain"
78:         );
```
[75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L75-L78)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol

41:         require(version == 1 && _bytecodeHash[1] == bytes1(0), "zf"); // Incorrectly formatted bytecodeHash 
```
[41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L41)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

668:             require( 
669:                 (_blobHashes[i] == bytes32(0) && blobCommitments[i] == bytes32(0)) ||
670:                     (_blobHashes[i] != bytes32(0) && blobCommitments[i] != bytes32(0)),
671:                 "bh"
672:             );
```
[668](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L668-L672)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

77:         require( 
78:             _nonceOrdering == AccountNonceOrdering.Arbitrary &&
79:                 currentInfo.nonceOrdering == AccountNonceOrdering.Sequential,
80:             "It is only possible to change from sequential to arbitrary ordering"
81:         );
```
[77](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L77-L81)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

76:         require(version == 1 && _bytecodeHash[1] == bytes1(0), "Incorrectly formatted bytecodeHash"); 
```
[76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L76)

</details>


---
### [GAS&#x2011;69] Stack variable is only used once
If the variable is only accessed once, it's cheaper to use the assigned value directly that one time, and save the 3 gas the extra stack assignment would spend.


Gas saved per Instance: ~3 *(Total: ~750)*
<details>
<summary><i>There are 250 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

76:         bytes32 constructorInputHash = keccak256(abi.encode(l2TokenBeacon, "")); 
77:         bytes32 salt = bytes32(uint256(uint160(_l1Token)));

142:         uint256 amount = _depositFundsToSharedBridge(msg.sender, IERC20(_l1Token), _amount); 

161:         uint256 balanceBefore = _token.balanceOf(address(sharedBridge)); 

163:         uint256 balanceAfter = _token.balanceOf(address(sharedBridge)); 
```
[76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L76-L77), [142](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L142), [161](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L161), [163](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L163)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

160:             uint256 amount = _depositFunds(_prevMsgSender, IERC20(_l1Token), _amount); // note if _prevMsgSender is this contract, this will return 0. This does not happen. 

174:         uint256 balanceBefore = _token.balanceOf(address(this)); 

176:         uint256 balanceAfter = _token.balanceOf(address(this)); 

205:             uint256 withdrawAmount = _depositFunds(_prevMsgSender, IERC20(_l1Token), _depositAmount); 

217:             bytes memory l2TxCalldata = _getDepositL2Calldata(_prevMsgSender, _l2Receiver, _l1Token, amount); 

249:         bytes memory gettersData = _getERC20Getters(_l1Token); 

256:             bytes memory name = bytes("Ether"); 
257:             bytes memory symbol = bytes("ETH");
258:             bytes memory decimals = abi.encode(uint8(18));

316:             bool proofValid = bridgehub.proveL1ToL2TransactionStatus( 

333:                 bool weCanCheckDepositHere = !_isEraLegacyWithdrawal(_chainId, _l2BatchNumber); 

340:                 bytes32 dataHash = depositHappened[_chainId][_l2TxHash]; 
341:                 bytes32 txDataHash = keccak256(abi.encode(_depositSender, _l1Token, _amount));

355:             bool callSuccess; 

423:             bool alreadyFinalized = IGetters(ERA_DIAMOND_PROXY).isEthWithdrawalFinalized( 

430:         MessageParams memory messageParams = MessageParams({ 

444:             bool callSuccess; 

467:             bool baseTokenWithdrawal = (l1Token == bridgehub.baseToken(_chainId)); 
468:             address l2Sender = baseTokenWithdrawal ? L2_BASE_TOKEN_SYSTEM_CONTRACT_ADDR : l2BridgeAddress[_chainId];

477:         bool success = bridgehub.proveL2MessageInclusion( 

571:         bytes memory l2TxCalldata = _getDepositL2Calldata(_prevMsgSender, _l2Receiver, _l1Token, _amount); 

584:             L2TransactionRequestDirect memory request = L2TransactionRequestDirect({ 

598:         bytes32 txDataHash = keccak256(abi.encode(_prevMsgSender, _l1Token, _amount)); 
```
[160](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L160), [174](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L174), [176](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L176), [205](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L205), [217](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L217), [249](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L249), [256](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L256-L258), [316](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L316), [333](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L333), [340](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L340-L341), [355](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L355), [423](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L423), [430](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L430), [444](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L444), [467](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L467-L468), [477](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L477), [571](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L571), [584](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L584), [598](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L598)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

53:         address oldPendingAdmin = pendingAdmin; 

64:         address previousAdmin = admin; 

159:         address stateTransition = getStateTransition(_chainId); 

171:         address stateTransition = getStateTransition(_chainId); 

185:         address stateTransition = getStateTransition(_chainId); 

204:         address stateTransition = getStateTransition(_chainId); 

236:         address stateTransition = getStateTransition(_request.chainId); 
237:         address refundRecipient = _actualRefundRecipient(_request.refundRecipient);

286:         address stateTransition = getStateTransition(_request.chainId); 

298:         address refundRecipient = _actualRefundRecipient(_request.refundRecipient); 
```
[53](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L53), [64](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L64), [159](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L159), [171](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L171), [185](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L185), [204](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L204), [236](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L236-L237), [286](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L286), [298](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L298)

```solidity
üìÅ File: contracts/ethereum/contracts/common/ReentrancyGuard.sol

47:         uint256 lockSlotOldValue; 
```
[47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L47)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol

40:         uint8 version = uint8(_bytecodeHash[0]); 

66:         bytes32 senderBytes = bytes32(uint256(uint160(_sender))); 
67:         bytes32 data = keccak256(
```
[40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L40), [66](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L66-L67)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

90:         IExecutor.StoredBatchInfo memory batchZero = IExecutor.StoredBatchInfo( 

112:         address oldPendingAdmin = pendingAdmin; 

123:         address previousAdmin = admin; 

178:         bytes memory systemContextCalldata = abi.encodeCall(ISystemContext.setChainId, (_chainId)); 
179:         uint256[] memory uintEmptyArray;
180:         bytes[] memory bytesEmptyArray;

202:         ProposedUpgrade memory proposedUpgrade = ProposedUpgrade({ 

219:         Diamond.FacetCut[] memory emptyArray; 
220:         Diamond.DiamondCutData memory cutData = Diamond.DiamondCutData({

255:         bytes32 cutHashInput = keccak256(_diamondCut); 

277:         DiamondProxy stateTransitionContract = new DiamondProxy{salt: bytes32(0)}(block.chainid, diamondCut); 
```
[90](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L90), [112](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L112), [123](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L123), [178](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L178-L180), [202](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L202), [219](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L219-L220), [255](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L255), [277](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L277)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

115:             uint32 timestamp = uint32(block.timestamp); 

134:             uint32 timestamp = uint32(block.timestamp); 

183:         uint256 delay = executionDelay; // uint32 

186:                 uint256 commitBatchTimestamp = committedBatchTimestamp[ERA_CHAIN_ID].get( 

207:         uint256 delay = executionDelay; // uint32 

210:                 uint256 commitBatchTimestamp = committedBatchTimestamp[_chainId].get(_newBatchesData[i].batchNumber); 
```
[115](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L115), [134](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L134), [183](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L183), [186](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L186), [207](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L207), [210](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L210)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol

28:         address facetAddress = facet.facetAddress; 
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L28)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

25:         address oldPendingAdmin = s.pendingAdmin; 

36:         address previousAdmin = s.admin; 

61:         uint256 oldPriorityTxMaxGasLimit = s.priorityTxMaxGasLimit; 

72:         FeeParams memory oldFeeParams = s.feeParams; 

80:         uint128 oldNominator = s.baseTokenGasPriceMultiplierNominator; 
81:         uint128 oldDenominator = s.baseTokenGasPriceMultiplierDenominator;

104:         bytes32 cutHashInput = keccak256(abi.encode(_diamondCut)); 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L25), [36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L36), [61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L61), [72](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L72), [80](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L80-L81), [104](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L104)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

84:         bytes32 commitment = _createBatchCommitment(_newBatch, logOutput.stateDiffHash, blobCommitments, blobHashes); 

116:         uint256 lastL2BlockTimestamp = _packedBatchAndL2BlockTimestamp & PACKED_L2_BLOCK_TIMESTAMP_MASK; 

291:             bytes32 expectedUpgradeTxHash = i == 0 ? _systemContractUpgradeTxHash : bytes32(0); 

312:             PriorityOperation memory priorityOp = s.priorityQueue.popFront(); 

329:         bytes32 priorityOperationsHash = _collectOperationsFromPriorityQueue(_storedBatch.numberOfLayer1Txs); 

396:         VerifierParams memory verifierParams = s.verifierParams; 

444:         bool successVerifyProof = s.verifier.verify( 

506:         bytes32 passThroughDataHash = keccak256(_batchPassThroughData(_newBatchData)); 
507:         bytes32 metadataHash = keccak256(_batchMetaParameters());
508:         bytes32 auxiliaryOutputHash = keccak256(

545:         bytes32 l2ToL1LogsHash = keccak256(_batch.systemLogs); 

610:         bytes memory precompileInput = abi.encodePacked(_versionedHash, _openingPoint, _openingValueCommitmentProof); 

643:             bytes32 openingPoint = bytes32( 

662:         bytes32 versionedHash = _getBlobVersionedHash(versionedHashIndex); 
```
[84](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L84), [116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L116), [291](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L291), [312](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L312), [329](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L329), [396](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L396), [444](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L444), [506](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L506-L508), [545](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L545), [610](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L610), [643](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L643), [662](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L662)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

158:         Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage(); 

168:         uint256 selectorsArrayLen = ds.facetToSelectors[_facet].selectors.length; 

170:             bytes4 selector0 = ds.facetToSelectors[_facet].selectors[0]; 

210:             Diamond.FacetToSelectors memory facetToSelectors = ds.facetToSelectors[facetAddr]; 

218:         Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage(); 

224:         Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage(); 

230:         Diamond.DiamondStorage storage ds = Diamond.getDiamondStorage(); 
```
[158](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L158), [168](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L168), [170](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L170), [210](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L210), [218](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L218), [224](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L224), [230](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L230)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

41:         uint256 amount = address(this).balance; 
42:         address sharedBridgeAddress = s.baseTokenBridge;

92:         L2Log memory l2Log = L2Log({ 

123:         bytes32 calculatedRootHash = Merkle.calculateRoot(_proof, _index, hashedLog); 
124:         bytes32 actualRootHash = s.l2LogsRootHashes[_batchNumber];

148:         uint256 l2GasPrice = _deriveL2GasPrice(_gasPrice, _l2GasPerPubdataByteLimit); 

167:         uint256 fullPubdataPriceBaseToken = pubdataPriceBaseToken + 

171:         uint256 l2GasPrice = feeParams.minimalL2GasPrice + batchOverheadBaseToken / uint256(feeParams.maxL2GasPerBatch); 
172:         uint256 minL2GasPriceBaseToken = (fullPubdataPriceBaseToken + _gasPerPubdata - 1) / _gasPerPubdata;

271:         uint256 baseCost = _params.l2GasPrice * _params.l2GasLimit; 
```
[41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L41-L42), [92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L92), [123](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L123-L124), [148](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L148), [167](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L167), [171](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L171-L172), [271](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L271)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

127:         DiamondStorage storage ds = getDiamondStorage(); 

140:             SelectorToFacet memory oldFacet = ds.selectorToFacet[selector]; 

150:         DiamondStorage storage ds = getDiamondStorage(); 

173:         DiamondStorage storage ds = getDiamondStorage(); 

214:             bytes4 selector0 = ds.facetToSelectors[_facet].selectors[0]; 
```
[127](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L127), [140](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L140), [150](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L150), [173](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L173), [214](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L214)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/LibMap.sol

23:             uint256 mapValue = _map.map[_index / 8]; 

27:             uint256 bitOffset = (_index & 7) * 32; 

54:             uint32 oldValue = uint32(mapValue >> bitOffset); 

57:             uint256 newValueXorOldValue = uint256(oldValue ^ _value); 
```
[23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L23), [27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L27), [54](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L54), [57](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/LibMap.sol#L57)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol

135:         uint256 overheadForLength = MEMORY_OVERHEAD_GAS * _encodingLength; 
```
[135](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L135)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

100:         bytes32 previousDefaultAccountBytecodeHash = s.l2DefaultAccountBytecodeHash; 

117:         bytes32 previousBootloaderBytecodeHash = s.l2BootloaderBytecodeHash; 

135:         IVerifier oldVerifier = s.verifier; 

155:         VerifierParams memory oldVerifierParams = s.verifierParams; 
```
[100](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L100), [117](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L117), [135](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L135), [155](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L155)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol

59:         bytes32 txHash = _setL2SystemContractUpgrade( 
```
[59](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L59)

```solidity
üìÅ File: contracts/zksync/contracts/L2ContractHelper.sol

107:         bytes32 senderBytes = bytes32(uint256(uint160(_sender))); 
108:         bytes32 data = keccak256(
```
[107](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L107-L108)

```solidity
üìÅ File: contracts/zksync/contracts/SystemContractsCaller.sol

40:         uint32 dataStart; 

44:         uint32 dataLength = uint32(Utils.safeCastToU32(data.length)); 

84:         uint256 size; 
```
[40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L40), [44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L44), [84](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L84)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

64:             address l2StandardToken = address(new L2StandardERC20{salt: bytes32(0)}()); 

97:             address deployedToken = _deployL2Token(_l1Token, _data); 

110:         bytes32 salt = _getCreate2Salt(_l1Token); 

131:         bytes memory message = _getL1WithdrawMessage(_l1Receiver, l1Token, _amount); 

150:         bytes32 constructorInputHash = keccak256(abi.encode(address(l2TokenBeacon), "")); 
151:         bytes32 salt = _getCreate2Salt(_l1Token);
```
[64](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L64), [97](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L97), [110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L110), [131](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L131), [150](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L150-L151)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

75:         try this.decodeString(nameBytes) returns (string memory nameString) { 

81:         try this.decodeString(symbolBytes) returns (string memory symbolString) { 

93:         try this.decodeUint8(decimalsBytes) returns (uint8 decimalsUint8) { 

119:         address beaconAddress = _getBeacon(); 
```
[75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L75), [81](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L81), [93](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L93), [119](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L119)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

60:         bytes32 constructedBytecodeHash = Utils.constructedBytecodeHash(codeHash); 
```
[60](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L60)

```solidity
üìÅ File: system-contracts/contracts/BootloaderUtilities.sol

56:             bytes memory encodedGasPrice = RLPEncoder.encodeUint256(_transaction.maxFeePerGas); 
57:             bytes memory encodedGasLimit = RLPEncoder.encodeUint256(_transaction.gasLimit);

81:             uint256 rInt = uint256(bytes32(_transaction.signature[0:32])); 

86:             uint256 sInt = uint256(bytes32(_transaction.signature[32:64])); 

105:             uint256 listLength = encodedNonce.length + 

143:             bytes memory encodedChainId = RLPEncoder.encodeUint256(block.chainid); 
144:             bytes memory encodedNonce = RLPEncoder.encodeUint256(_transaction.nonce);
145:             bytes memory encodedGasPrice = RLPEncoder.encodeUint256(_transaction.maxFeePerGas);
146:             bytes memory encodedGasLimit = RLPEncoder.encodeUint256(_transaction.gasLimit);
147:             bytes memory encodedTo = RLPEncoder.encodeAddress(address(uint160(_transaction.to)));
148:             bytes memory encodedValue = RLPEncoder.encodeUint256(_transaction.value);

180:             uint256 rInt = uint256(bytes32(_transaction.signature[0:32])); 

185:             uint256 sInt = uint256(bytes32(_transaction.signature[32:64])); 

198:             uint256 listLength = encodedFixedLengthParams.length + 

236:             bytes memory encodedChainId = RLPEncoder.encodeUint256(block.chainid); 
237:             bytes memory encodedNonce = RLPEncoder.encodeUint256(_transaction.nonce);
238:             bytes memory encodedMaxPriorityFeePerGas = RLPEncoder.encodeUint256(_transaction.maxPriorityFeePerGas);
239:             bytes memory encodedMaxFeePerGas = RLPEncoder.encodeUint256(_transaction.maxFeePerGas);
240:             bytes memory encodedGasLimit = RLPEncoder.encodeUint256(_transaction.gasLimit);
241:             bytes memory encodedTo = RLPEncoder.encodeAddress(address(uint160(_transaction.to)));
242:             bytes memory encodedValue = RLPEncoder.encodeUint256(_transaction.value);

275:             uint256 rInt = uint256(bytes32(_transaction.signature[0:32])); 

280:             uint256 sInt = uint256(bytes32(_transaction.signature[32:64])); 

293:             uint256 listLength = encodedFixedLengthParams.length + 
```
[56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L56-L57), [81](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L81), [86](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L86), [105](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L105), [143](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L143-L148), [180](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L180), [185](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L185), [198](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L198), [236](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L236-L242), [275](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L275), [280](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L280), [293](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L293)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

65:                 uint64 encodedChunk = dictionary.readUint64(indexOfEncodedChunk); 
66:                 uint64 realChunk = _bytecode.readUint64(encodedDataPointer * 4);

121:         uint256 numberOfInitialWrites = uint256(_compressedStateDiffs.readUint16(0)); 

137:             bytes32 derivedKey = stateDiff.readBytes32(52); 

168:             uint256 compressedEnumIndex = _sliceToUint256( 
```
[65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L65-L66), [121](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L121), [137](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L137), [168](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L168)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

103:         bytes32 constructorInputHash = EfficientCall.keccak(_input); 

105:         bytes32 hash = keccak256( 

121:         bytes32 hash = keccak256( 

188:         uint256 senderNonce = NONCE_HOLDER_SYSTEM_CONTRACT.incrementDeploymentNonce(msg.sender); 

302:         uint256 knownCodeMarker = KNOWN_CODE_STORAGE_CONTRACT.getMarker(_bytecodeHash); 

311:         bytes32 constructingBytecodeHash = Utils.constructingBytecodeHash(_bytecodeHash); 

343:             bytes memory returnData = EfficientCall.mimicCall(gasleft(), _newAddress, _input, _sender, true, _isSystem); 

347:             ImmutableData[] memory immutables = abi.decode(returnData, (ImmutableData[])); 
```
[103](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L103), [105](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L105), [121](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L121), [188](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L188), [302](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L302), [311](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L311), [343](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L343), [347](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L347)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

94:         bytes32 txHash = _suggestedSignedHash != bytes32(0) ? _suggestedSignedHash : _transaction.encodeHash(); 

99:         uint256 totalRequiredBalance = _transaction.totalRequiredBalance(); 

133:         uint128 value = Utils.safeCastToU128(_transaction.value); 

135:         uint32 gas = Utils.safeCastToU32(gasleft()); 

149:         bool success = EfficientCall.rawCall(gas, to, value, data, isSystemCall); 

162:         bytes32 r; 

201:         bool success = _transaction.payToTheBootloader(); 
```
[94](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L94), [99](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L99), [133](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L133), [135](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L135), [149](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L149), [162](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L162), [201](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L201)

```solidity
üìÅ File: system-contracts/contracts/GasBoundCaller.sol

49:         uint256 pubdataAllowance = _maxTotalGas > expectedForCompute ? _maxTotalGas - expectedForCompute : 0; 

63:         uint256 pubdataSpent = pubdataPublishedAfter > pubdataPublishedBefore 

67:         uint256 pubdataPrice = REAL_SYSTEM_CONTEXT_CONTRACT.gasPerPubdataByte(); 
```
[49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L49), [63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L63), [67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L67)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

39:                 uint256 index = _immutables[i].index; 
40:                 bytes32 value = _immutables[i].value;
```
[39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L39-L40)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

75:         uint8 version = uint8(_bytecodeHash[0]); 
```
[75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L75)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

75:         L2ToL1Log memory l2ToL1Log = L2ToL1Log({ 

89:         uint256 gasToPay = keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) + 2 * keccakGasCost(64); 

95:         bytes32 hashedLog = keccak256( 

117:         uint256 gasBeforeMessageHashing = gasleft(); 

119:         uint256 gasSpentOnMessageHashing = gasBeforeMessageHashing - gasleft(); 

125:         L2ToL1Log memory l2ToL1Log = L2ToL1Log({ 

148:         uint256 gasToPay = keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) + 

175:         uint256 gasToPay = sha256GasCost(bytecodeLen) + 

230:         bytes32 l2ToL1LogsTreeRoot = l2ToL1LogsTreeArray[0]; 

239:             bytes32 hashedMessage = EfficientCall.keccak( 

289:         uint8 enumerationIndexSize = uint8(bytes1(_totalL2ToL1PubdataAndStateDiffs[calldataPtr])); 

292:         bytes calldata compressedStateDiffs = _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 

303:         bytes calldata stateDiffs = _totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 

307:         bytes32 stateDiffHash = COMPRESSOR_CONTRACT.verifyCompressedStateDiffs( 
```
[75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L75), [89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L89), [95](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L95), [117](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L117), [119](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L119), [125](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L125), [148](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L148), [175](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L175), [230](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L230), [239](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L239), [289](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L289), [292](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L292), [303](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L303), [307](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L307)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

76:         bytes memory message = _getL1WithdrawMessage(_l1Receiver, amount); 

89:         bytes memory message = _getExtendedWithdrawMessage(_l1Receiver, amount, msg.sender, _additionalData); 
```
[76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L76), [89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L89)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

27:         uint256 addressAsUint = SystemContractHelper.getExtraAbiData(1); 
28:         uint256 mask = SystemContractHelper.getExtraAbiData(2);
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L27-L28)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

47:         uint256 addressAsKey = uint256(uint160(_address)); 

58:         uint256 addressAsKey = uint256(uint160(_address)); 

83:         IContractDeployer.AccountInfo memory accountInfo = DEPLOYER_SYSTEM_CONTRACT.getAccountInfo(msg.sender); 

92:         uint256 addressAsKey = uint256(uint160(msg.sender)); 

103:         uint256 addressAsKey = uint256(uint160(msg.sender)); 

126:         uint256 addressAsKey = uint256(uint160(_address)); 

155:         uint256 addressAsKey = uint256(uint160(_address)); 
```
[47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L47), [58](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L58), [83](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L83), [92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L92), [103](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L103), [126](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L126), [155](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L155)

```solidity
üìÅ File: system-contracts/contracts/PubdataChunkPublisher.sol

37:             uint256 start = BLOB_SIZE_BYTES * i; 

45:             bytes32 blobHash; 
```
[37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L37), [45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L45)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

350:             uint128 currentBatchTimestamp = currentBatchInfo.timestamp; 

376:             bytes32 prevL2BlockHash = _getLatest257L2blockHash(currentL2BlockNumber - 1); 

378:             bytes32 pendingL2BlockHash = _calculateL2BlockHash( 

416:         uint256 packedTimestamps = (uint256(currentBatchTimestamp) << 128) | currentL2BlockTimestamp; 

428:         uint128 currentBlockTimestamp = currentL2BlockInfo.timestamp; 

459:         BlockInfo memory newBlockInfo = BlockInfo({number: previousBatchNumber + 1, timestamp: _newTimestamp}); 

476:         BlockInfo memory newBlockInfo = BlockInfo({number: uint128(_number), timestamp: uint128(_newTimestamp)}); 
```
[350](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L350), [376](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L376), [378](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L378), [416](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L416), [428](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L428), [459](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L459), [476](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L476)

```solidity
üìÅ File: system-contracts/contracts/libraries/EfficientCall.sol

65:         bool success = rawCall(_gas, _address, _value, _data, _isSystem); 

79:         bool success = rawStaticCall(_gas, _address, _data); 

93:         bool success = rawDelegateCall(_gas, _address, _data); 

113:         bool success = rawMimicCall(_gas, _address, _data, _whoToMimic, _isConstructor, _isSystem); 

217:             uint256 size; 

261:         uint32 shrinkTo = uint32(msg.data.length - (_data.length + dataOffset)); 

264:         uint32 gas = Utils.safeCastToU32(_gas); 
265:         uint256 farCallAbi = SystemContractsCaller.getFarCallABIWithEmptyFatPointer(
```
[65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L65), [79](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L79), [93](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L93), [113](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L113), [217](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L217), [261](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L261), [264](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L264-L265)

```solidity
üìÅ File: system-contracts/contracts/libraries/RLPEncoder.sol

36:                 uint256 lbs = 31 - hbs; 

71:                 uint256 lbs = 31 - hbs; 
```
[36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L36), [71](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L71)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractHelper.sol

217:         uint256 shifted = (meta << (256 - size - offset)); 

330:         uint256 callFlags = getCallFlags(); 

345:         bool precompileCallSuccess = unsafePrecompileCall( 
```
[217](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L217), [330](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L330), [345](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L345)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractsCaller.sol

79:         uint32 dataStart; 

83:         uint32 dataLength = uint32(Utils.safeCastToU32(data.length)); 

131:         uint256 size; 
```
[79](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L79), [83](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L83), [131](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L131)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

119:         bytes32 structHash = keccak256( 

138:         bytes32 domainSeparator = keccak256( 

159:             bytes memory encodedGasPrice = RLPEncoder.encodeUint256(_transaction.maxFeePerGas); 
160:             bytes memory encodedGasLimit = RLPEncoder.encodeUint256(_transaction.gasLimit);

190:             uint256 listLength = encodedNonce.length + 

228:             bytes memory encodedChainId = RLPEncoder.encodeUint256(block.chainid); 
229:             bytes memory encodedNonce = RLPEncoder.encodeUint256(_transaction.nonce);
230:             bytes memory encodedGasPrice = RLPEncoder.encodeUint256(_transaction.maxFeePerGas);
231:             bytes memory encodedGasLimit = RLPEncoder.encodeUint256(_transaction.gasLimit);
232:             bytes memory encodedTo = RLPEncoder.encodeAddress(address(uint160(_transaction.to)));
233:             bytes memory encodedValue = RLPEncoder.encodeUint256(_transaction.value);

265:             uint256 listLength = encodedFixedLengthParams.length + 

298:             bytes memory encodedChainId = RLPEncoder.encodeUint256(block.chainid); 
299:             bytes memory encodedNonce = RLPEncoder.encodeUint256(_transaction.nonce);
300:             bytes memory encodedMaxPriorityFeePerGas = RLPEncoder.encodeUint256(_transaction.maxPriorityFeePerGas);
301:             bytes memory encodedMaxFeePerGas = RLPEncoder.encodeUint256(_transaction.maxFeePerGas);
302:             bytes memory encodedGasLimit = RLPEncoder.encodeUint256(_transaction.gasLimit);
303:             bytes memory encodedTo = RLPEncoder.encodeAddress(address(uint160(_transaction.to)));
304:             bytes memory encodedValue = RLPEncoder.encodeUint256(_transaction.value);

337:             uint256 listLength = encodedFixedLengthParams.length + 

377:             uint256 currentAllowance = IERC20(token).allowance(address(this), paymaster); 
```
[119](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L119), [138](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L138), [159](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L159-L160), [190](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L190), [228](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L228-L233), [265](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L265), [298](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L298-L304), [337](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L337), [377](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L377)

</details>


---
### [GAS&#x2011;70] Stack variable used as a cheaper cache for a state variable is used only once
It's cheaper to access the state variable directly if it is accessed only once. This can save the **3 gas** cost of the extra stack allocation.


Gas saved per Instance: ~3 *(Total: ~18)*
<details>
<summary><i>There are 6 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

53:         address oldPendingAdmin = pendingAdmin; 

64:         address previousAdmin = admin; 
```
[53](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L53), [64](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L64)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

112:         address oldPendingAdmin = pendingAdmin; 

123:         address previousAdmin = admin; 
```
[112](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L112), [123](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L123)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

183:         uint256 delay = executionDelay; // uint32 

207:         uint256 delay = executionDelay; // uint32 
```
[183](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L183), [207](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L207)

</details>


---
### [GAS&#x2011;71] State variable read in a loop
The state variable should be cached in and read from a local variable, or accumulated in a local variable then written to storage once outside of the loop, rather than reading/updating it on every iteration of the loop, which will replace each Gwarmaccess (**100 gas**) with a much cheaper stack read.


Gas saved per Instance: ~97 *(Total: ~679)*
<details>
<summary><i>There are 7 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

/// @audit timestamp, committedBatchTimestamp
116:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 
117:                 committedBatchTimestamp[ERA_CHAIN_ID].set(_newBatchesData[i].batchNumber, timestamp);
118:             }

/// @audit timestamp, committedBatchTimestamp
135:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 
136:                 committedBatchTimestamp[_chainId].set(_newBatchesData[i].batchNumber, timestamp);
137:             }

/// @audit committedBatchTimestamp
185:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 
186:                 uint256 commitBatchTimestamp = committedBatchTimestamp[ERA_CHAIN_ID].get(
187:                     _newBatchesData[i].batchNumber
188:                 );
189: 
190:                 // Note: if the `commitBatchTimestamp` is zero, that means either:
191:                 // * The batch was committed, but not through this contract.
192:                 // * The batch wasn't committed at all, so execution will fail in the zkSync contract.
193:                 // We allow executing such batches.
194: 
195:                 require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed
196:             }

/// @audit committedBatchTimestamp
209:             for (uint256 i = 0; i < _newBatchesData.length; ++i) { 
210:                 uint256 commitBatchTimestamp = committedBatchTimestamp[_chainId].get(_newBatchesData[i].batchNumber);
211: 
212:                 // Note: if the `commitBatchTimestamp` is zero, that means either:
213:                 // * The batch was committed, but not through this contract.
214:                 // * The batch wasn't committed at all, so execution will fail in the zkSync contract.
215:                 // We allow executing such batches.
216: 
217:                 require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed
218:             }
```
[116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L116-L118), [135](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L135-L137), [185](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L185-L196), [209](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L209-L218)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

/// @audit s
311:         for (uint256 i = 0; i < _nPriorityOps; i = i.uncheckedInc()) { 
312:             PriorityOperation memory priorityOp = s.priorityQueue.popFront();
313:             concatHash = keccak256(abi.encode(concatHash, priorityOp.canonicalTxHash));
314:         }

/// @audit s
405:         for (uint256 i = 0; i < committedBatchesLength; i = i.uncheckedInc()) { 
406:             currentTotalBatchesVerified = currentTotalBatchesVerified.uncheckedInc();
407:             require(
408:                 _hashStoredBatchInfo(_committedBatches[i]) == s.storedBatchHashes[currentTotalBatchesVerified],
409:                 "o1"
410:             );
411: 
412:             bytes32 currentBatchCommitment = _committedBatches[i].commitment;
413:             proofPublicInput[i] = _getBatchProofPublicInput(
414:                 prevBatchCommitment,
415:                 currentBatchCommitment,
416:                 verifierParams
417:             );
418: 
419:             prevBatchCommitment = currentBatchCommitment;
420:         }
```
[311](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L311-L314), [405](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L405-L420)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

/// @audit action, facetCuts, facetCuts, facetCuts, facetCuts, action, selectors, action, facet, selectors, facet, selectors, facet, selectors
101:         for (uint256 i = 0; i < facetCutsLength; i = i.uncheckedInc()) { 
102:             Action action = facetCuts[i].action;
103:             address facet = facetCuts[i].facet;
104:             bool isFacetFreezable = facetCuts[i].isFreezable;
105:             bytes4[] memory selectors = facetCuts[i].selectors;
106: 
107:             require(selectors.length > 0, "B"); // no functions for diamond cut
108: 
109:             if (action == Action.Add) {
110:                 _addFunctions(facet, selectors, isFacetFreezable);
111:             } else if (action == Action.Replace) {
112:                 _replaceFunctions(facet, selectors, isFacetFreezable);
113:             } else if (action == Action.Remove) {
114:                 _removeFunctions(facet, selectors);
115:             } else {
116:                 revert("C"); // undefined diamond cut action
117:             }
118:         }
```
[101](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L101-L118)

</details>


---
### [GAS&#x2011;72] State variables can be packed into fewer storage slots by truncating timestamp bytes
By using a `uint32` rather than a larger type for variables that track timestamps, one can save gas by using fewer storage slots per struct, at the expense of the protocol breaking after the year 2106 (when `uint32` wraps). If this is an acceptable tradeoff, if variables occupying the same slot are both written the same function or by the constructor, avoids a separate Gsset (**20000 gas**). Reads of the variables can also be cheaper


Gas saved per Instance: ~53,333.333 *(Total: ~160,000)*
<details>
<summary><i>There are 3 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

/// @audit use this order:
/// -  timestamps
/// -  securityCouncil
/// -  minDelay (uint32)
/// @audit 1 storage slot(s) saved, (before 3, after 2)
20: contract Governance is IGovernance, Ownable2Step { 
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L20)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

/// @audit use this order:
/// -  stateTransition
/// -  upgradeCutHash
/// -  storedBatchZero
/// -  initialCutHash
/// -  genesisUpgrade
/// -  protocolVersion
/// -  validatorTimelock (uint32)
/// -  admin
/// -  pendingAdmin
/// @audit 6 storage slot(s) saved, (before 9, after 3)
25: contract StateTransitionManager is IStateTransitionManager, ReentrancyGuard, Ownable2Step { 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L25)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

/// @audit use this order:
/// -  committedBatchTimestamp
/// -  validators
/// -  stateTransitionManager
/// -  executionDelay (uint32)
/// @audit 1 storage slot(s) saved, (before 4, after 3)
22: contract ValidatorTimelock is IExecutor, Ownable2Step { 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L22)

</details>


---
### [GAS&#x2011;73] State variables can be reordered to fit into fewer storage slots
If variables occupying the same slot are both written the same function or by the constructor, avoids a separate Gsset (**20000 gas**). Reads of the variables can also be cheaper


Gas saved per Instance: ~20,000 *(Total: ~80,000)*
<details>
<summary><i>There are 4 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

/// @audit use this order: 
/// - timestamps,
/// - securityCouncil,
/// - minDelay
/// @audit to save 1 storage slots, (before 3, after 2)
20: contract Governance is IGovernance, Ownable2Step { 
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L20)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

/// @audit use this order: 
/// - stateTransition,
/// - upgradeCutHash,
/// - storedBatchZero,
/// - initialCutHash,
/// - genesisUpgrade,
/// - protocolVersion,
/// - validatorTimelock,
/// - admin,
/// - pendingAdmin
/// @audit to save 1 storage slots, (before 4, after 3)
25: contract StateTransitionManager is IStateTransitionManager, ReentrancyGuard, Ownable2Step { 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L25)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

/// @audit use this order: 
/// - committedBatchTimestamp,
/// - validators,
/// - stateTransitionManager,
/// - executionDelay
/// @audit to save 1 storage slots, (before 4, after 3)
22: contract ValidatorTimelock is IExecutor, Ownable2Step { 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L22)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

/// @audit use this order: 
/// - chainId,
/// - gasPrice,
/// - blockGasLimit,
/// - difficulty,
/// - baseFee,
/// - currentBatchInfo,
/// - batchHashes,
/// - currentL2BlockInfo,
/// - currentL2BlockTxsRollingHash,
/// - l2BlockHash,
/// - currentVirtualL2BlockInfo,
/// - virtualBlockUpgradeInfo,
/// - gasPerPubdataByte,
/// - basePubdataSpent,
/// - origin,
/// - txNumberInBlock,
/// - coinbase
/// @audit to save 1 storage slots, (before 17, after 16)
17: contract SystemContext is ISystemContext, ISystemContextDeprecated, ISystemContract { 
```
[17](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L17)

</details>


---
### [GAS&#x2011;74] State variables only set in their definitions should be declared `constant`
This can avoid a Gsset (**20000 gas**) on deployment (in constructor), and replaces the first access in each transaction (Gcoldsload - **2100 gas**) and each access thereafter (Gwarmacces - **100 gas**) with a `PUSH32` (**3 gas**).


Gas saved per Instance: ~2,097 *(Total: ~14,679)*
<details>
<summary><i>There are 7 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

36:     address public l2Bridge; 

39:     address public l2TokenBeacon; 

42:     bytes32 public l2TokenProxyBytecodeHash; 
```
[36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L36), [39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L39), [42](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L42)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

37:     address private l1LegacyBridge; 
```
[37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L37)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

37:     uint256 public blockGasLimit = type(uint32).max; 

41:     address public coinbase = BOOTLOADER_FORMAL_ADDRESS; 

44:     uint256 public difficulty = 2.5e15; 
```
[37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L37), [41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L41), [44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L44)

</details>


---
### [GAS&#x2011;75] State variables should be cached in stack variables rather than re-reading them from storage
When performing multiple operations on a state variable in a function, it is recommended to cache it first. Either multiple reads or multiple writes to a state variable can save gas by caching it on the stack. Caching of a state variable replaces each Gwarmaccess (100 gas) with a much cheaper stack read. Other less obvious fixes/optimizations include having local memory caches of state variable structs, or having local caches of state variable contracts/addresses. *Saves 100 gas per instance*.


Gas saved per Instance: ~100 *(Total: ~4,200)*
<details>
<summary><i>There are 42 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

/// @audit depositAmount: 2 reads 
176:     function claimFailedDeposit( 
177:         address _depositSender,
178:         address _l1Token,
179:         bytes32 _l2TxHash,
180:         uint256 _l2BatchNumber,
181:         uint256 _l2MessageIndex,
182:         uint16 _l2TxNumberInBatch,
183:         bytes32[] calldata _merkleProof
184:     ) external nonReentrant {
```
[176](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L176-L184)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

/// @audit _initialized: 2 reads (2 in modifiers)
104:     function initialize( 
105:         address _owner,
106:         uint256 _eraFirstPostUpgradeBatch
107:     ) external reentrancyGuardInitializer initializer {

/// @audit chainBalance: 2 reads 
116:     function transferFundsFromLegacy(address _token, address _target, uint256 _targetChainId) external onlyOwner { 

/// @audit l2BridgeAddress: 2 reads 
182:     function bridgehubDeposit( 
183:         uint256 _chainId,
184:         address _prevMsgSender,
185:         uint256, // l2Value, needed for Weth deposits in the future
186:         bytes calldata _data
187:     ) external payable override onlyBridgehub returns (L2TransactionRequestTwoBridgesInner memory request) {

/// @audit depositHappened: 2 reads 
/// @audit chainBalance: 2 reads 
303:     function _claimFailedDeposit( 
304:         bool _checkedInLegacyBridge,
305:         uint256 _chainId,
306:         address _depositSender,
307:         address _l1Token,
308:         uint256 _amount,
309:         bytes32 _l2TxHash,
310:         uint256 _l2BatchNumber,
311:         uint256 _l2MessageIndex,
312:         uint16 _l2TxNumberInBatch,
313:         bytes32[] calldata _merkleProof
314:     ) internal nonReentrant {

/// @audit chainBalance: 2 reads 
409:     function _finalizeWithdrawal( 
410:         uint256 _chainId,
411:         uint256 _l2BatchNumber,
412:         uint256 _l2MessageIndex,
413:         uint16 _l2TxNumberInBatch,
414:         bytes calldata _message,
415:         bytes32[] calldata _merkleProof
416:     ) internal nonReentrant returns (address l1Receiver, address l1Token, uint256 amount) {

/// @audit l2BridgeAddress: 2 reads 
554:     function depositLegacyErc20Bridge( 
555:         address _prevMsgSender,
556:         address _l2Receiver,
557:         address _l1Token,
558:         uint256 _amount,
559:         uint256 _l2TxGasLimit,
560:         uint256 _l2TxGasPerPubdataByte,
561:         address _refundRecipient
562:     ) external payable override onlyLegacyBridge nonReentrant returns (bytes32 l2TxHash) {
```
[104](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L104-L107), [116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L116), [182](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L182-L187), [303](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L303-L314), [409](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L409-L416), [554](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L554-L562)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

/// @audit pendingAdmin: 3 reads 
60:     function acceptAdmin() external { 

/// @audit sharedBridge: 2 reads 
114:     function createNewChain( 
115:         uint256 _chainId,
116:         address _stateTransitionManager,
117:         address _baseToken,
118:         uint256, //_salt
119:         address _admin,
120:         bytes calldata _initData
121:     ) external onlyOwnerOrAdmin nonReentrant returns (uint256 chainId) {
```
[60](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L60), [114](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L114-L121)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

/// @audit pendingAdmin: 3 reads 
119:     function acceptAdmin() external { 

/// @audit protocolVersion: 3 reads 
177:     function _setChainIdUpgrade(uint256 _chainId, address _chainContract) internal { 
```
[119](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L119), [177](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L177)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

/// @audit s: 2 reads (1 in modifiers)
23:     function setPendingAdmin(address _newPendingAdmin) external onlyAdmin { 

/// @audit s: 3 reads 
32:     function acceptAdmin() external { 

/// @audit s: 2 reads (1 in modifiers)
58:     function setPriorityTxMaxGasLimit(uint256 _newPriorityTxMaxGasLimit) external onlyStateTransitionManager { 

/// @audit s: 3 reads (2 in modifiers)
67:     function changeFeeParams(FeeParams calldata _newFeeParams) external onlyAdminOrStateTransitionManager { 

/// @audit s: 4 reads (2 in modifiers)
79:     function setTokenMultiplier(uint128 _nominator, uint128 _denominator) external onlyAdminOrStateTransitionManager { 

/// @audit s: 2 reads (1 in modifiers)
89:     function setValidiumMode(PubdataPricingMode _validiumMode) external onlyAdmin { 

/// @audit s: 5 reads (2 in modifiers)
100:     function upgradeChainFromVersion( 
101:         uint256 _oldProtocolVersion,
102:         Diamond.DiamondCutData calldata _diamondCut
103:     ) external onlyAdminOrStateTransitionManager {

/// @audit s: 2 reads (2 in modifiers)
133:     function freezeDiamond() external onlyAdminOrStateTransitionManager { 

/// @audit s: 2 reads (2 in modifiers)
143:     function unfreezeDiamond() external onlyAdminOrStateTransitionManager { 
```
[23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L23), [32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L32), [58](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L58), [67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L67), [79](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L79), [89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L89), [100](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L100-L103), [133](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L133), [143](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L143)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

/// @audit s: 7 reads 
215:     function _commitBatches( 
216:         StoredBatchInfo memory _lastCommittedBatchData,
217:         CommitBatchInfo[] calldata _newBatchesData
218:     ) internal {

/// @audit s: 2 reads 
321:     function _executeOneBatch(StoredBatchInfo memory _storedBatch, uint256 _executedBatchIdx) internal { 

/// @audit s: 5 reads 
349:     function _executeBatches(StoredBatchInfo[] calldata _batchesData) internal { 

/// @audit s: 6 reads 
386:     function _proveBatches( 
387:         StoredBatchInfo calldata _prevBatch,
388:         StoredBatchInfo[] calldata _committedBatches,
389:         ProofInput calldata _proof
390:     ) internal {

/// @audit s: 2 reads (2 in modifiers)
472:     function revertBatches(uint256 _newLastBatch) external nonReentrant onlyValidatorOrStateTransitionManager { 

/// @audit s: 8 reads 
481:     function _revertBatches(uint256 _newLastBatch) internal { 

/// @audit s: 3 reads 
525:     function _batchMetaParameters() internal view returns (bytes memory) { 
```
[215](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L215-L218), [321](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L321), [349](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L349), [386](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L386-L390), [472](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L472), [481](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L481), [525](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L525)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

/// @audit s: 3 reads (1 in modifiers)
38:     function transferEthToSharedBridge() external onlyBaseTokenBridge { 

/// @audit s: 2 reads 
104:     function _proveL2LogInclusion( 
105:         uint256 _batchNumber,
106:         uint256 _index,
107:         L2Log memory _log,
108:         bytes32[] calldata _proof
109:     ) internal view returns (bool) {

/// @audit s: 4 reads 
156:     function _deriveL2GasPrice(uint256 _l1GasPrice, uint256 _gasPerPubdata) internal view returns (uint256) { 

/// @audit s: 2 reads 
178:     function finalizeEthWithdrawal( 
179:         uint256 _l2BatchNumber,
180:         uint256 _l2MessageIndex,
181:         uint16 _l2TxNumberInBatch,
182:         bytes calldata _message,
183:         bytes32[] calldata _merkleProof
184:     ) external nonReentrant {

/// @audit s: 3 reads 
197:     function requestL2Transaction( 
198:         address _contractL2,
199:         uint256 _l2Value,
200:         bytes calldata _calldata,
201:         uint256 _l2GasLimit,
202:         uint256 _l2GasPerPubdataByteLimit,
203:         bytes[] calldata _factoryDeps,
204:         address _refundRecipient
205:     ) external payable returns (bytes32 canonicalTxHash) {

/// @audit s: 3 reads 
316:     function _writePriorityOp( 
317:         WritePriorityOpParams memory _priorityOpParams,
318:         bytes memory _calldata,
319:         bytes[] memory _factoryDeps
320:     ) internal returns (bytes32 canonicalTxHash) {
```
[38](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L38), [104](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L104-L109), [156](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L156), [178](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L178-L184), [197](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L197-L205), [316](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L316-L320)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

/// @audit s: 2 reads 
180:     function _setL2SystemContractUpgrade( 
181:         L2CanonicalTransaction calldata _l2ProtocolUpgradeTx,
182:         bytes[] calldata _factoryDeps,
183:         uint256 _newProtocolVersion
184:     ) internal returns (bytes32) {

/// @audit s: 3 reads 
236:     function _setNewProtocolVersion(uint256 _newProtocolVersion) internal virtual { 
```
[180](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L180-L184), [236](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L236)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol

/// @audit s: 3 reads 
20:     function _setNewProtocolVersion(uint256 _newProtocolVersion) internal override { 
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L20)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

/// @audit _initialized: 2 reads (2 in modifiers)
50:     function bridgeInitialize(address _l1Address, bytes memory _data) external initializer { 
```
[50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L50)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

/// @audit numberOfLogsToProcess: 2 reads 
94:     function _processL2ToL1Log(L2ToL1Log memory _l2ToL1Log) internal returns (uint256 logIdInMerkleTree) { 
```
[94](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L94)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

/// @audit balance: 2 reads 
32:     function transferFromTo(address _from, address _to, uint256 _amount) external override { 
```
[32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L32)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

/// @audit basePubdataSpent: 2 reads 
117:     function getCurrentPubdataSpent() public view returns (uint256) { 

/// @audit currentVirtualL2BlockInfo: 2 reads 
263:     function _setVirtualBlock( 
264:         uint128 _l2BlockNumber,
265:         uint128 _maxVirtualBlocksToCreate,
266:         uint128 _newTimestamp
267:     ) internal {
```
[117](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L117), [263](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L263-L267)

</details>


---
### [GAS&#x2011;76] Struct can be reordered to fit into fewer storage slots
In Solidity, data type packing within struct variables is a recommended practice to optimize gas usage and efficiency in smart contracts.

This technique leverages the fact that Ethereum‚Äôs storage model stores variables in slots, with each slot offering a capacity of 32 bytes. When data types that consume less than 32 bytes, such as **uint8**, **bool**, or **address**, are declared individually, each occupies a whole storage slot. However, when these smaller variables are grouped into a struct, they can share a storage slot, resulting in a significant reduction in storage requirements and, by extension, gas costs.


Gas saved per Instance: ~20,000 *(Total: ~40,000)*
<details>
<summary><i>There are 2 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol

/// @audit use this order:  batchHash, numberOfLayer1Txs, priorityOperationsHash, l2LogsTreeRoot, timestamp, commitment, batchNumber, indexRepeatedStorageChanges
/// @audit 1 storage slot(s) saved, (before 8, after 7)
83:     struct StoredBatchInfo { 
```
[83](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L83)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

/// @audit use this order:  action, selectors, facet, isFreezable
/// @audit 1 storage slot(s) saved, (before 4, after 3)
62:     struct FacetCut { 
```
[62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L62)

</details>


---
### [GAS&#x2011;77] Structs can be assigned more efficiently
Rather defining the struct in a single line, it is more efficient to declare an empty struct and then assign each struct element individually. This can net quite a large gas saving of **130 per instance**.


Gas saved per Instance: ~130 *(Total: ~2,340)*
<details>
<summary><i>There are 18 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

219:             request = L2TransactionRequestTwoBridgesInner({ 
220:                 magicValue: TWO_BRIDGES_MAGIC_VALUE,
221:                 l2Contract: l2BridgeAddress[_chainId],
222:                 l2Calldata: l2TxCalldata,
223:                 factoryDeps: new bytes[](0),
224:                 txDataHash: txDataHash
225:             });

430:         MessageParams memory messageParams = MessageParams({ 
431:             l2BatchNumber: _l2BatchNumber,
432:             l2MessageIndex: _l2MessageIndex,
433:             l2TxNumberInBatch: _l2TxNumberInBatch
434:         });

470:             l2ToL1Message = L2Message({ 
471:                 txNumberInBatch: _messageParams.l2TxNumberInBatch,
472:                 sender: l2Sender,
473:                 data: _message
474:             });

584:             L2TransactionRequestDirect memory request = L2TransactionRequestDirect({ 
585:                 chainId: ERA_CHAIN_ID,
586:                 l2Contract: l2BridgeAddress[ERA_CHAIN_ID],
587:                 mintValue: msg.value, // l2 gas + l2 msg.Value the bridgehub will withdraw the mintValue from the base token bridge for gas
588:                 l2Value: 0, // L2 msg.value, this contract doesn't support base token deposits or wrapping functionality, for direct deposits use bridgehub
589:                 l2Calldata: l2TxCalldata,
590:                 l2GasLimit: _l2TxGasLimit,
591:                 l2GasPerPubdataByteLimit: _l2TxGasPerPubdataByte,
592:                 factoryDeps: new bytes[](0),
593:                 refundRecipient: refundRecipient
594:             });
```
[219](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L219-L225), [430](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L430-L434), [470](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L470-L474), [584](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L584-L594)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

239:             BridgehubL2TransactionRequest({ 
240:                 sender: msg.sender,
241:                 contractL2: _request.l2Contract,
242:                 mintValue: _request.mintValue,
243:                 l2Value: _request.l2Value,
244:                 l2Calldata: _request.l2Calldata,
245:                 l2GasLimit: _request.l2GasLimit,
246:                 l2GasPerPubdataByteLimit: _request.l2GasPerPubdataByteLimit,
247:                 factoryDeps: _request.factoryDeps,
248:                 refundRecipient: refundRecipient
249:             })

305:             BridgehubL2TransactionRequest({ 
306:                 sender: _request.secondBridgeAddress,
307:                 contractL2: outputRequest.l2Contract,
308:                 mintValue: _request.mintValue,
309:                 l2Value: _request.l2Value,
310:                 l2Calldata: outputRequest.l2Calldata,
311:                 l2GasLimit: _request.l2GasLimit,
312:                 l2GasPerPubdataByteLimit: _request.l2GasPerPubdataByteLimit,
313:                 factoryDeps: outputRequest.factoryDeps,
314:                 refundRecipient: refundRecipient
315:             })
```
[239](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L239-L249), [305](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L305-L315)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

182:         L2CanonicalTransaction memory l2ProtocolUpgradeTx = L2CanonicalTransaction({ 
183:             txType: SYSTEM_UPGRADE_L2_TX_TYPE,
184:             from: uint256(uint160(L2_FORCE_DEPLOYER_ADDR)),
185:             to: uint256(uint160(L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR)),
186:             gasLimit: 5,
187:             gasPerPubdataByteLimit: REQUIRED_L2_GAS_PRICE_PER_PUBDATA,
188:             maxFeePerGas: uint256(0),
189:             maxPriorityFeePerGas: uint256(0),
190:             paymaster: uint256(0),
191:             // Note, that the priority operation id is used as "nonce" for L1->L2 transactions
192:             nonce: protocolVersion,
193:             value: 0,
194:             reserved: [uint256(0), 0, 0, 0],
195:             data: systemContextCalldata,
196:             signature: new bytes(0),
197:             factoryDeps: uintEmptyArray,
198:             paymasterInput: new bytes(0),
199:             reservedDynamic: new bytes(0)
200:         });

202:         ProposedUpgrade memory proposedUpgrade = ProposedUpgrade({ 
203:             l2ProtocolUpgradeTx: l2ProtocolUpgradeTx,
204:             factoryDeps: bytesEmptyArray,
205:             bootloaderHash: bytes32(0),
206:             defaultAccountHash: bytes32(0),
207:             verifier: address(0),
208:             verifierParams: VerifierParams({
209:                 recursionNodeLevelVkHash: bytes32(0),
210:                 recursionLeafLevelVkHash: bytes32(0),
211:                 recursionCircuitsSetVksHash: bytes32(0)
212:             }),
213:             l1ContractsUpgradeCalldata: new bytes(0),
214:             postUpgradeCalldata: new bytes(0),
215:             upgradeTimestamp: 0,
216:             newProtocolVersion: protocolVersion
217:         });

220:         Diamond.DiamondCutData memory cutData = Diamond.DiamondCutData({ 
221:             facetCuts: emptyArray,
222:             initAddress: genesisUpgrade,
223:             initCalldata: abi.encodeCall(IDefaultUpgrade.upgrade, (proposedUpgrade))
224:         });
```
[182](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L182-L200), [202](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L202-L217), [220](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L220-L224)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

92:         L2Log memory l2Log = L2Log({ 
93:             l2ShardId: 0,
94:             isService: true,
95:             txNumberInBatch: _l2TxNumberInBatch,
96:             sender: L2_BOOTLOADER_ADDRESS,
97:             key: _l2TxHash,
98:             value: bytes32(uint256(_status))
99:         });

132:             L2Log({ 
133:                 l2ShardId: 0,
134:                 isService: true,
135:                 txNumberInBatch: _message.txNumberInBatch,
136:                 sender: L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR,
137:                 key: bytes32(uint256(uint160(_message.sender))),
138:                 value: keccak256(_message.data)
139:             });

208:             BridgehubL2TransactionRequest({ 
209:                 sender: msg.sender,
210:                 contractL2: _contractL2,
211:                 mintValue: msg.value,
212:                 l2Value: _l2Value,
213:                 l2GasLimit: _l2GasLimit,
214:                 l2Calldata: _calldata,
215:                 l2GasPerPubdataByteLimit: _l2GasPerPubdataByteLimit,
216:                 factoryDeps: _factoryDeps,
217:                 refundRecipient: _refundRecipient
218:             })

294:         transaction = L2CanonicalTransaction({ 
295:             txType: PRIORITY_OPERATION_L2_TX_TYPE,
296:             from: uint256(uint160(_priorityOpParams.sender)),
297:             to: uint256(uint160(_priorityOpParams.contractAddressL2)),
298:             gasLimit: _priorityOpParams.l2GasLimit,
299:             gasPerPubdataByteLimit: _priorityOpParams.l2GasPricePerPubdata,
300:             maxFeePerGas: uint256(_priorityOpParams.l2GasPrice),
301:             maxPriorityFeePerGas: uint256(0),
302:             paymaster: uint256(0),
303:             // Note, that the priority operation id is used as "nonce" for L1->L2 transactions
304:             nonce: uint256(_priorityOpParams.txId),
305:             value: _priorityOpParams.l2Value,
306:             reserved: [_priorityOpParams.valueToMint, uint256(uint160(_priorityOpParams.refundRecipient)), 0, 0],
307:             data: _calldata,
308:             signature: new bytes(0),
309:             factoryDeps: _hashFactoryDeps(_factoryDeps),
310:             paymasterInput: new bytes(0),
311:             reservedDynamic: new bytes(0)
312:         });

335:             PriorityOperation({ 
336:                 canonicalTxHash: canonicalTxHash,
337:                 expirationTimestamp: _priorityOpParams.expirationTimestamp,
338:                 layer2Tip: uint192(0) // TODO: Restore after fee modeling will be stable. (SMA-1230)
339:             })
```
[92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L92-L99), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L132-L139), [208](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L208-L218), [294](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L294-L312), [335](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L335-L339)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

218:         ds.selectorToFacet[_selector] = SelectorToFacet({ 
219:             facetAddress: _facet,
220:             selectorPosition: selectorPosition,
221:             isFreezable: _isSelectorFreezable
222:         });
```
[218](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L218-L222)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

75:         L2ToL1Log memory l2ToL1Log = L2ToL1Log({ 
76:             l2ShardId: 0,
77:             isService: _isService,
78:             txNumberInBlock: SYSTEM_CONTEXT_CONTRACT.txNumberInBlock(),
79:             sender: msg.sender,
80:             key: _key,
81:             value: _value
82:         });

125:         L2ToL1Log memory l2ToL1Log = L2ToL1Log({ 
126:             l2ShardId: 0,
127:             isService: true,
128:             txNumberInBlock: SYSTEM_CONTEXT_CONTRACT.txNumberInBlock(),
129:             sender: address(this),
130:             key: bytes32(uint256(uint160(msg.sender))),
131:             value: hash
132:         });
```
[75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L75-L82), [125](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L125-L132)

</details>


---
### [GAS&#x2011;78] Structs can be packed into fewer storage slots by truncating timestamp bytes
By using a `uint32` rather than a larger type for variables that track timestamps, one can save gas by using fewer storage slots per struct, at the expense of the protocol breaking after the year 2106 (when `uint32` wraps). If this is an acceptable tradeoff, each slot saved can avoid an extra Gsset (**20000 gas**) for the first setting of the struct. Subsequent reads as well as writes have smaller gas savings


Gas saved per Instance: ~20,000 

<i>There is one instance of this issue:</i>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol

/// @audit use this order:
/// -  batchHash 
/// -  numberOfLayer1Txs 
/// -  priorityOperationsHash 
/// -  l2LogsTreeRoot 
/// -  commitment 
/// -  batchNumber 
/// -  timestamp (uint32)
/// -  indexRepeatedStorageChanges 
/// @audit 1 storage slot(s) saved, (before 7, after 6)
83:     struct StoredBatchInfo { 
```
[83](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L83)


---
### [GAS&#x2011;79] The result of a function call should be cached rather than re-calling the function
External calls are expensive. Results of external function calls should be cached rather than call them multiple times. Consider caching the following:


Gas saved per Instance: ~100 *(Total: ~300)*
<details>
<summary><i>There are 3 instances of this issue:</i></summary>

```solidity
üìÅ File: system-contracts/contracts/GasBoundCaller.sol

/// @audit REAL_SYSTEM_CONTEXT_CONTRACT.getCurrentPubdataSpent() called on lines 51, 59
/// @audit gasleft() called on lines 40, 57, 46, 76
35:     function gasBoundCall(address _to, uint256 _maxTotalGas, bytes calldata _data) external payable { 
```
[35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L35)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

/// @audit gasleft() called on lines 117, 119
116:     function sendToL1(bytes calldata _message) external override returns (bytes32 hash) { 
```
[116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L116)

</details>


---
### [GAS&#x2011;80] `unchecked {}` can be used on the division of two `uint`s in order to save gas
The division cannot overflow, since both the numerator and the denominator are non-negative


Gas saved per Instance: ~60 *(Total: ~300)*
<details>
<summary><i>There are 5 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

168:             batchOverheadBaseToken / 
169:             uint256(feeParams.maxPubdataPerBatch);

171:         uint256 l2GasPrice = feeParams.minimalL2GasPrice + batchOverheadBaseToken / uint256(feeParams.maxL2GasPerBatch); 
172:         uint256 minL2GasPriceBaseToken = (fullPubdataPriceBaseToken + _gasPerPubdata - 1) / _gasPerPubdata;
```
[168](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L168-L169), [171](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L171-L172)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol

30:         require(l2GasForTxBody / _transaction.gasPerPubdataByteLimit <= _priorityTxMaxPubdata, "uk"); 
```
[30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L30)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

180:         deploymentNonce = _rawMinNonce / DEPLOY_NONCE_MULTIPLIER; 
```
[180](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L180)

</details>


---
### [GAS&#x2011;81] Unnecessary `nonReentrant` modifier in certain functions
Function not calling any external contract can't be in re-entrancy or function can only be called by `onlyOwner`/`onlyMinter` so no chance to re-enter here.


Gas saved per Instance: ~24,700 

<i>There is one instance of this issue:</i>

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

114:     function createNewChain( 
115:         uint256 _chainId,
116:         address _stateTransitionManager,
117:         address _baseToken,
118:         uint256, //_salt
119:         address _admin,
120:         bytes calldata _initData
121:     ) external onlyOwnerOrAdmin nonReentrant returns (uint256 chainId) {
```
[114](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L114-L121)


---
### [GAS&#x2011;82] Update OpenZeppelin dependency to the latest version
Every release contains new gas optimizations. Use the [latest version](https://github.com/OpenZeppelin/openzeppelin-contracts/releases) to take advantage of this.

 Current version is : `4.9.5`

<details>
<summary><i>There are 22 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

5: import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol"; 
6: import {SafeERC20} from "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L5-L6)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

5: import {Initializable} from "@openzeppelin/contracts/proxy/utils/Initializable.sol"; 
6: import {Ownable2Step} from "@openzeppelin/contracts/access/Ownable2Step.sol";

8: import {IERC20Metadata} from "@openzeppelin/contracts/token/ERC20/extensions/IERC20Metadata.sol"; 
9: import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";
10: import {SafeERC20} from "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L5-L6), [8](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L8-L10)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

5: import {Ownable2Step} from "@openzeppelin/contracts/access/Ownable2Step.sol"; 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L5)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

5: import {Ownable2Step} from "@openzeppelin/contracts/access/Ownable2Step.sol"; 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L5)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

16: import {Ownable2Step} from "@openzeppelin/contracts/access/Ownable2Step.sol"; 
```
[16](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L16)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

5: import {Ownable2Step} from "@openzeppelin/contracts/access/Ownable2Step.sol"; 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L5)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

5: import {Math} from "@openzeppelin/contracts/utils/math/Math.sol"; 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L5)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

5: import {SafeCast} from "@openzeppelin/contracts/utils/math/SafeCast.sol"; 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L5)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol

5: import {Math} from "@openzeppelin/contracts/utils/math/Math.sol"; 
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L5)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

5: import {Initializable} from "@openzeppelin/contracts/proxy/utils/Initializable.sol"; 
6: import {BeaconProxy} from "@openzeppelin/contracts/proxy/beacon/BeaconProxy.sol";
7: import {UpgradeableBeacon} from "@openzeppelin/contracts/proxy/beacon/UpgradeableBeacon.sol";
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L5-L7)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

5: import {ERC20PermitUpgradeable} from "@openzeppelin/contracts-upgradeable/token/ERC20/extensions/draft-ERC20PermitUpgradeable.sol"; 
6: import {UpgradeableBeacon} from "@openzeppelin/contracts/proxy/beacon/UpgradeableBeacon.sol";
7: import {ERC1967Upgrade} from "@openzeppelin/contracts/proxy/ERC1967/ERC1967Upgrade.sol";
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L5-L7)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

5: import "../openzeppelin/token/ERC20/IERC20.sol"; 
6: import "../openzeppelin/token/ERC20/utils/SafeERC20.sol";
```
[5](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L5-L6)

</details>


---
### [GAS&#x2011;83] Usage of `uints`/`ints` smaller than 32 bytes (256 bits) incurs overhead
Citing the [documentation](https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html):

> When using elements that are smaller than 32 bytes, your contract‚Äôs gas usage may be higher.This is because the EVM operates on 32 bytes at a time.Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.

For example, each operation involving a `uint8` costs an extra ** 22 - 28 gas ** (depending on whether the other operand is also a variable of type `uint8`) as compared to ones involving`uint256`, due to the compiler having to clear the higher bits of the memory word before operating on the`uint8`, as well as the associated stack operations of doing so.

Consider using a larger size, then downcast where needed.


Gas saved per Instance: ~6 *(Total: ~726)*
<details>
<summary><i>There are 121 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

182:         uint16 _l2TxNumberInBatch, 

211:         uint16 _l2TxNumberInBatch, 
```
[182](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L182), [211](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L211)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

285:         uint16 _l2TxNumberInBatch, 

312:         uint16 _l2TxNumberInBatch, 

404:         uint16 l2TxNumberInBatch; 

503:         (uint32 functionSignature, uint256 offset) = UnsafeBytes.readUint32(_l2ToL1message, 0); 

618:         uint16 _l2TxNumberInBatch, 

651:         uint16 _l2TxNumberInBatch, 
```
[285](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L285), [312](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L312), [404](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L404), [503](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L503), [618](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L618), [651](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L651)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol

49:         uint16 _l2TxNumberInBatch, 

56:         uint16 _l2TxNumberInBatch, 
```
[49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L49), [56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1ERC20Bridge.sol#L56)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol

81:         uint16 _l2TxNumberInBatch, 

93:         uint16 _l2TxNumberInBatch, 

100:         uint16 _l2TxNumberInBatch, 

109:         uint16 _l2TxNumberInBatch, 
```
[81](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L81), [93](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L93), [100](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L100), [109](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/interfaces/IL1SharedBridge.sol#L109)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

181:         uint16 _l2TxNumberInBatch, 
```
[181](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L181)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol

94:         uint16 _l2TxNumberInBatch, 
```
[94](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L94)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

26:     address public securityCouncil; 

35:     uint256 public minDelay; 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L26), [35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L35)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

33:     bytes32 public storedBatchZero; 

39:     address public genesisUpgrade; 

45:     address public validatorTimelock; 

51:     address public admin; 
```
[33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L33), [39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L39), [45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L45), [51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L51)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

44:     IStateTransitionManager public stateTransitionManager; 

53:     uint32 public executionDelay; 

55:     constructor(address _initialOwner, uint32 _executionDelay) { 

96:     function setExecutionDelay(uint32 _executionDelay) external onlyOwner { 

115:             uint32 timestamp = uint32(block.timestamp); 
```
[44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L44), [53](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L53), [55](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L55), [96](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L96), [115](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L115)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

79:     function setTokenMultiplier(uint128 _nominator, uint128 _denominator) external onlyAdminOrStateTransitionManager { 
80:         uint128 oldNominator = s.baseTokenGasPriceMultiplierNominator;
```
[79](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L79-L80)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

67:     function baseTokenGasPriceMultiplierNominator() external view returns (uint128) { 
```
[67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L67)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

78:         uint16 _l2TxNumberInBatch, 
```
[78](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L78)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol

40:     function setTokenMultiplier(uint128 _nominator, uint128 _denominator) external; 

84:         uint128 oldNominator, 

86:         uint128 newNominator, 
```
[40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L40), [84](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L84), [86](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IAdmin.sol#L86)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol

84:         uint64 batchNumber; 

90:         uint256 timestamp; 

113:         uint64 batchNumber; 

115:         uint64 indexRepeatedStorageChanges; 
```
[84](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L84), [90](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L90), [113](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L113), [115](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L115)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol

112:     function baseTokenGasPriceMultiplierNominator() external view returns (uint128); 
```
[112](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IGetters.sol#L112)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol

51:         uint16 _l2TxNumberInBatch, 

65:         uint16 _l2TxNumberInBatch, 

126:         uint64 expirationTimestamp, 
```
[51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L51), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L65), [126](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L126)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

32:         uint16 selectorPosition; 

41:         uint16 facetPosition; 

208:         uint16 selectorPosition = (ds.facetToSelectors[_facet].selectors.length).toUint16(); 
```
[32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L32), [41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L41), [208](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L208)

```solidity
üìÅ File: contracts/zksync/contracts/SystemContractsCaller.sol

37:     function systemCall(uint32 gasLimit, address to, uint256 value, bytes memory data) internal returns (bool success) { 

40:         uint32 dataStart; 

77:         uint32 gasLimit, 

79:         uint128 value, 

96:         uint32 dataOffset, 

98:         uint32 dataStart, 

100:         uint32 gasPassed, 
```
[37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L37), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L40), [77](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L77), [79](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L79), [96](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L96), [98](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L98), [100](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L100)

```solidity
üìÅ File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol

22:     uint160 constant offset = uint160(0x1111000000000000000000000000000000001111); 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L22)

```solidity
üìÅ File: system-contracts/contracts/BootloaderUtilities.sol

68:             uint64 txDataLen = uint64(_transaction.data.length); 

164:             uint64 txDataLen = uint64(_transaction.data.length); 

259:             uint64 txDataLen = uint64(_transaction.data.length); 
```
[68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L68), [164](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L164), [259](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L259)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

65:                 uint64 encodedChunk = dictionary.readUint64(indexOfEncodedChunk); 

129:             uint64 enumIndex = stateDiff.readUint64(84); 

161:             uint64 enumIndex = stateDiff.readUint64(84); 
```
[65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L65), [129](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L129), [161](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L161)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

133:         uint128 value = Utils.safeCastToU128(_transaction.value); 

135:         uint32 gas = Utils.safeCastToU32(gasleft()); 
```
[133](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L133), [135](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L135)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

200:         uint32 numberOfL2ToL1Logs = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4])); 

233:         uint32 numberOfMessages = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4])); 

237:             uint32 currentMessageLength = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4])); 

251:         uint32 numberOfBytecodes = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4])); 

255:             uint32 currentBytecodeLength = uint32( 

286:         uint24 compressedStateDiffSize = uint24(bytes3(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 3])); 

300:         uint32 numberOfStateDiffs = uint32(bytes4(_totalL2ToL1PubdataAndStateDiffs[calldataPtr:calldataPtr + 4])); 
```
[200](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L200), [233](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L233), [237](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L237), [251](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L251), [255](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L255), [286](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L286), [300](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L300)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

89:     uint16 public txNumberInBlock; 

172:     function getBatchNumberAndTimestamp() public view returns (uint128 batchNumber, uint128 batchTimestamp) { 

180:     function getL2BlockNumberAndTimestamp() public view returns (uint128 blockNumber, uint128 blockTimestamp) { 

190:     function getBlockNumber() public view returns (uint128) { 

222:         uint128 _blockNumber, 

233:     function _calculateLegacyL2BlockHash(uint128 _blockNumber) internal pure returns (bytes32) { 

241:     function _upgradeL2Blocks(uint128 _l2BlockNumber, bytes32 _expectedPrevL2BlockHash, bool _isFirstInBatch) internal { 

264:         uint128 _l2BlockNumber, 

266:         uint128 _newTimestamp 

278:             uint128 currentBatchNumber = currentBatchInfo.number; 

314:     function _setNewL2BlockData(uint128 _l2BlockNumber, uint128 _l2BlockTimestamp, bytes32 _prevL2BlockHash) internal { 

342:         uint128 _l2BlockNumber, 

346:         uint128 _maxVirtualBlocksToCreate 

358:         (uint128 currentL2BlockNumber, uint128 currentL2BlockTimestamp) = getL2BlockNumberAndTimestamp(); 

409:         (uint128 currentBatchNumber, uint128 currentBatchTimestamp) = getBatchNumberAndTimestamp(); 
410:         (, uint128 currentL2BlockTimestamp) = getL2BlockNumberAndTimestamp();

427:     function _ensureBatchConsistentWithL2Block(uint128 _newTimestamp) internal view { 
428:         uint128 currentBlockTimestamp = currentL2BlockInfo.timestamp;

446:         uint128 _newTimestamp, 

450:         (uint128 previousBatchNumber, uint128 previousBatchTimestamp) = getBatchNumberAndTimestamp(); 

497:         (uint128 blockNumber, uint128 blockTimestamp) = getBatchNumberAndTimestamp(); 
```
[89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L89), [172](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L172), [180](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L180), [190](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L190), [222](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L222), [233](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L233), [241](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L241), [264](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L264), [266](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L266), [278](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L278), [314](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L314), [342](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L342), [346](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L346), [358](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L358), [409](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L409-L410), [427](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L427-L428), [446](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L446), [450](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L450), [497](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L497)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IMailbox.sol

9:         uint16 _l2TxNumberInBlock, 
```
[9](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IMailbox.sol#L9)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContext.sol

13:         uint128 timestamp; 

23:         uint128 virtualBlockStartBatch; 

44:     function txNumberInBlock() external view returns (uint16); 

50:     function getBlockNumber() external view returns (uint128); 

54:     function getBatchNumberAndTimestamp() external view returns (uint128 blockNumber, uint128 blockTimestamp); 

56:     function getL2BlockNumberAndTimestamp() external view returns (uint128 blockNumber, uint128 blockTimestamp); 
```
[13](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L13), [23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L23), [44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L44), [50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L50), [54](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L54), [56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContext.sol#L56)

```solidity
üìÅ File: system-contracts/contracts/libraries/EfficientCall.sol

261:         uint32 shrinkTo = uint32(msg.data.length - (_data.length + dataOffset)); 
```
[261](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L261)

```solidity
üìÅ File: system-contracts/contracts/libraries/RLPEncoder.sol

49:     function encodeNonSingleBytesLen(uint64 _len) internal pure returns (bytes memory) { 

56:     function encodeListLen(uint64 _len) internal pure returns (bytes memory) { 

60:     function _encodeLength(uint64 _len, uint256 _offset) private pure returns (bytes memory encoded) { 
```
[49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L49), [56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L56), [60](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L60)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractHelper.sol

106:     function ptrShrinkIntoActive(uint32 _shrink) internal view { 

126:         uint32 _inputMemoryLength, 

128:         uint32 _outputMemoryLength, 

150:         uint32 _gasToBurn, 

168:     function setValueForNextFarCall(uint128 _value) internal returns (bool success) { 

227:     function getPubdataPublishedFromMeta(uint256 meta) internal pure returns (uint32 pubdataPublished) { 

237:     function getHeapSizeFromMeta(uint256 meta) internal pure returns (uint32 heapSize) { 

246:     function getAuxHeapSizeFromMeta(uint256 meta) internal pure returns (uint32 auxHeapSize) { 

344:     function burnGas(uint32 _gasToPay, uint32 _pubdataToSpend) internal view { 
```
[106](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L106), [126](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L126), [128](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L128), [150](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L150), [168](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L168), [227](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L227), [237](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L237), [246](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L246), [344](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L344)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractsCaller.sol

76:     function systemCall(uint32 gasLimit, address to, uint256 value, bytes memory data) internal returns (bool success) { 

79:         uint32 dataStart; 

124:         uint32 gasLimit, 

126:         uint128 value, 

151:         uint32 gasLimit, 

153:         uint128 value, 

215:         uint32 dataOffset, 

217:         uint32 dataStart, 

219:         uint32 gasPassed, 
```
[76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L76), [79](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L79), [124](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L124), [126](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L126), [151](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L151), [153](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L153), [215](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L215), [217](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L217), [219](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L219)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

171:             uint64 txDataLen = uint64(_transaction.data.length); 

249:             uint64 txDataLen = uint64(_transaction.data.length); 

321:             uint64 txDataLen = uint64(_transaction.data.length); 
```
[171](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L171), [249](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L249), [321](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L321)

</details>


---
### [GAS&#x2011;84] Use `+=` for `mapping`s
Using `+=` for mappings saves **[40 gas](https://gist.github.com/IllIllI000/4fc5f83a9edc6ed16677258bf58f32a5)** due to not having to recalculate the mapping's value's hash


Gas saved per Instance: ~40 

<i>There is one instance of this issue:</i>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

133:             chainBalance[_targetChainId][_token] = chainBalance[_targetChainId][_token] + amount; 
```
[133](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L133)


---
### [GAS&#x2011;85] Use `Array.unsafeAccess()` to avoid repeated array length checks
When using storage arrays, solidity adds an internal lookup of the array's length (a Gcoldsload **2100 gas**) to ensure you don't read past the array's end. You can avoid this lookup by using [`Array.unsafeAccess()`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/94697be8a3f0dfcd95dfb13ffbd39b5973f5c65d/contracts/utils/Arrays.sol#L57) in cases where the length has already been checked, as is the case with the instances below


Gas saved per Instance: ~2,100 *(Total: ~71,400)*
<details>
<summary><i>There are 34 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

226:             (bool success, bytes memory returnData) = _calls[i].target.call{value: _calls[i].value}(_calls[i].data); 
```
[226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L226)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

117:                 committedBatchTimestamp[ERA_CHAIN_ID].set(_newBatchesData[i].batchNumber, timestamp); 

136:                 committedBatchTimestamp[_chainId].set(_newBatchesData[i].batchNumber, timestamp); 

187:                     _newBatchesData[i].batchNumber 

210:                 uint256 commitBatchTimestamp = committedBatchTimestamp[_chainId].get(_newBatchesData[i].batchNumber); 
```
[117](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L117), [136](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L136), [187](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L187), [210](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L210)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

258:             _lastCommittedBatchData = _commitOneBatch(_lastCommittedBatchData, _newBatchesData[i], bytes32(0)); 

294:                 _newBatchesData[i], 

352:             _executeOneBatch(_batchesData[i], i); 
353:             emit BlockExecution(_batchesData[i].batchNumber, _batchesData[i].batchHash, _batchesData[i].commitment);

408:                 _hashStoredBatchInfo(_committedBatches[i]) == s.storedBatchHashes[currentTotalBatchesVerified], 

412:             bytes32 currentBatchCommitment = _committedBatches[i].commitment; 
```
[258](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L258), [294](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L294), [352](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L352-L353), [408](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L408), [412](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L412)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

209:             address facetAddr = ds.facets[i]; 
```
[209](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L209)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

357:             bytes32 hashedBytecode = L2ContractHelper.hashL2Bytecode(_factoryDeps[i]); 
```
[357](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L357)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

102:             Action action = facetCuts[i].action; 
103:             address facet = facetCuts[i].facet;
104:             bool isFacetFreezable = facetCuts[i].isFreezable;
105:             bytes4[] memory selectors = facetCuts[i].selectors;

107:             require(selectors.length > 0, "B"); // no functions for diamond cut 

139:             bytes4 selector = _selectors[i]; 

159:             bytes4 selector = _selectors[i]; 

179:             bytes4 selector = _selectors[i]; 
```
[102](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L102-L105), [107](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L107), [139](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L139), [159](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L159), [179](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L179)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol

31:                 ? _efficientHash(currentHash, _path[i]) 
32:                 : _efficientHash(_path[i], currentHash);
```
[31](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L31-L32)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

228:                 L2ContractHelper.hashL2Bytecode(_factoryDeps[i]) == bytes32(_expectedHashes[i]), 
```
[228](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L228)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

249:             sumOfValues += _deployments[i].value; 

254:             this.forceDeployOnAddress{value: _deployments[i].value}(_deployments[i], msg.sender); 
```
[249](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L249), [254](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L254)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

39:                 uint256 index = _immutables[i].index; 
40:                 bytes32 value = _immutables[i].value;
```
[39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L39-L40)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

31:                 _markBytecodeAsPublished(_hashes[i], _shouldSendToL1); 
```
[31](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L31)

</details>


---
### [GAS&#x2011;86] Use assembly for small `keccak256` hashes, in order to save gas
The assembly version of the keccak256 hashing function can be more gas efficient than the high-level Solidity version.


Gas saved per Instance: ~80 *(Total: ~3,040)*
<details>
<summary><i>There are 38 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

76:         bytes32 constructorInputHash = keccak256(abi.encode(l2TokenBeacon, "")); 
```
[76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L76)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

210:         bytes32 txDataHash = keccak256(abi.encode(_prevMsgSender, _l1Token, amount)); 

341:                 bytes32 txDataHash = keccak256(abi.encode(_depositSender, _l1Token, _amount)); 

598:         bytes32 txDataHash = keccak256(abi.encode(_prevMsgSender, _l1Token, _amount)); 
```
[210](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L210), [341](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L341), [598](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L598)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol

67:         bytes32 data = keccak256( 
68:             bytes.concat(CREATE2_PREFIX, senderBytes, _salt, _bytecodeHash, _constructorInputHash)
69:         );
```
[67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L67-L69)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

205:         return keccak256(abi.encode(_operation)); 
```
[205](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L205)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

255:         bytes32 cutHashInput = keccak256(_diamondCut); 
```
[255](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L255)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

104:         bytes32 cutHashInput = keccak256(abi.encode(_diamondCut)); 
```
[104](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L104)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

63:                     keccak256(_newBatch.pubdataCommitments[1:_newBatch.pubdataCommitments.length - 32]), 

460:                 keccak256( 
461:                     abi.encodePacked(
462:                         _prevBatchCommitment,
463:                         _currentBatchCommitment,
464:                         _verifierParams.recursionNodeLevelVkHash,
465:                         _verifierParams.recursionLeafLevelVkHash
466:                     )
467:                 )

506:         bytes32 passThroughDataHash = keccak256(_batchPassThroughData(_newBatchData)); 
507:         bytes32 metadataHash = keccak256(_batchMetaParameters());
508:         bytes32 auxiliaryOutputHash = keccak256(
509:             _batchAuxiliaryOutput(_newBatchData, _stateDiffHash, _blobCommitments, _blobHashes)
510:         );

512:         return keccak256(abi.encode(passThroughDataHash, metadataHash, auxiliaryOutputHash)); 

545:         bytes32 l2ToL1LogsHash = keccak256(_batch.systemLogs); 

588:         return keccak256(abi.encode(_storedBatchInfo)); 
```
[63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L63), [460](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L460-L467), [506](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L506-L510), [512](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L512), [545](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L545), [588](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L588)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

112:         bytes32 hashedLog = keccak256( 
113:             abi.encodePacked(_log.l2ShardId, _log.isService, _log.txNumberInBatch, _log.sender, _log.key, _log.value)
114:         );

138:                 value: keccak256(_message.data) 
```
[112](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L112-L114), [138](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L138)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

212:         bytes32 l2ProtocolUpgradeTxHash = keccak256(encodedTransaction); 
```
[212](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L212)

```solidity
üìÅ File: contracts/zksync/contracts/L2ContractHelper.sol

108:         bytes32 data = keccak256( 
109:             bytes.concat(CREATE2_PREFIX, senderBytes, _salt, _bytecodeHash, _constructorInputHash)
110:         );
```
[108](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L108-L110)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

150:         bytes32 constructorInputHash = keccak256(abi.encode(address(l2TokenBeacon), "")); 
```
[150](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L150)

```solidity
üìÅ File: system-contracts/contracts/BootloaderUtilities.sol

120:             keccak256( 
121:                 bytes.concat(
122:                     encodedListLength,
123:                     encodedNonce,
124:                     encodedGasParam,
125:                     encodedTo,
126:                     encodedValue,
127:                     encodedDataLength,
128:                     _transaction.data,
129:                     vEncoded,
130:                     rEncoded,
131:                     sEncoded
132:                 )
133:             );

211:             keccak256( 
212:                 bytes.concat(
213:                     "\x01",
214:                     encodedListLength,
215:                     encodedFixedLengthParams,
216:                     encodedDataLength,
217:                     _transaction.data,
218:                     encodedAccessListLength,
219:                     vEncoded,
220:                     rEncoded,
221:                     sEncoded
222:                 )
223:             );

306:             keccak256( 
307:                 bytes.concat(
308:                     "\x02",
309:                     encodedListLength,
310:                     encodedFixedLengthParams,
311:                     encodedDataLength,
312:                     _transaction.data,
313:                     encodedAccessListLength,
314:                     vEncoded,
315:                     rEncoded,
316:                     sEncoded
317:                 )
318:             );
```
[120](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L120-L133), [211](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L211-L223), [306](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L306-L318)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

105:         bytes32 hash = keccak256( 
106:             bytes.concat(CREATE2_PREFIX, bytes32(uint256(uint160(_sender))), _salt, _bytecodeHash, constructorInputHash)
107:         );

121:         bytes32 hash = keccak256( 
122:             bytes.concat(CREATE_PREFIX, bytes32(uint256(uint160(_sender))), bytes32(_senderNonce))
123:         );
```
[105](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L105-L107), [121](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L121-L123)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

95:         bytes32 hashedLog = keccak256( 
96:             abi.encodePacked(
97:                 _l2ToL1Log.l2ShardId,
98:                 _l2ToL1Log.isService,
99:                 _l2ToL1Log.txNumberInBlock,
100:                 _l2ToL1Log.sender,
101:                 _l2ToL1Log.key,
102:                 _l2ToL1Log.value
103:             )
104:         );
```
[95](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L95-L104)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

227:         return keccak256(abi.encode(_blockNumber, _blockTimestamp, _prevL2BlockHash, _blockTxsRollingHash)); 

234:         return keccak256(abi.encodePacked(uint32(_blockNumber))); 
```
[227](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L227), [234](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L234)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

119:         bytes32 structHash = keccak256( 
120:             abi.encode(
121:                 EIP712_TRANSACTION_TYPE_HASH,
122:                 _transaction.txType,
123:                 _transaction.from,
124:                 _transaction.to,
125:                 _transaction.gasLimit,
126:                 _transaction.gasPerPubdataByteLimit,
127:                 _transaction.maxFeePerGas,
128:                 _transaction.maxPriorityFeePerGas,
129:                 _transaction.paymaster,
130:                 _transaction.nonce,
131:                 _transaction.value,
132:                 EfficientCall.keccak(_transaction.data),
133:                 keccak256(abi.encodePacked(_transaction.factoryDeps)),
134:                 EfficientCall.keccak(_transaction.paymasterInput)
135:             )
136:         );

138:         bytes32 domainSeparator = keccak256( 
139:             abi.encode(EIP712_DOMAIN_TYPEHASH, keccak256("zkSync"), keccak256("2"), block.chainid)
140:         );

142:         return keccak256(abi.encodePacked("\x19\x01", domainSeparator, structHash)); 

203:             keccak256( 
204:                 bytes.concat(
205:                     encodedListLength,
206:                     encodedNonce,
207:                     encodedGasParam,
208:                     encodedTo,
209:                     encodedValue,
210:                     encodedDataLength,
211:                     _transaction.data,
212:                     encodedChainId
213:                 )
214:             );

275:             keccak256( 
276:                 bytes.concat(
277:                     "\x01",
278:                     encodedListLength,
279:                     encodedFixedLengthParams,
280:                     encodedDataLength,
281:                     _transaction.data,
282:                     encodedAccessListLength
283:                 )
284:             );

347:             keccak256( 
348:                 bytes.concat(
349:                     "\x02",
350:                     encodedListLength,
351:                     encodedFixedLengthParams,
352:                     encodedDataLength,
353:                     _transaction.data,
354:                     encodedAccessListLength
355:                 )
356:             );
```
[119](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L119-L136), [138](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L138-L140), [142](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L142), [203](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L203-L214), [275](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L275-L284), [347](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L347-L356)

</details>


---
### [GAS&#x2011;87] Use assembly in place of `abi.decode` to save gas
Instead of using abi.decode, we can use assembly to decode our desired calldata values directly. This will allow us to avoid decoding calldata values that we will not use.


Gas saved per Instance: ~112 *(Total: ~1,232)*
<details>
<summary><i>There are 11 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

190:         (address _l1Token, uint256 _depositAmount, address _l2Receiver) = abi.decode( 
```
[190](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L190)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

252:         Diamond.DiamondCutData memory diamondCut = abi.decode(_diamondCut, (Diamond.DiamondCutData)); 
```
[252](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L252)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

617:         (, uint256 result) = abi.decode(data, (uint256, uint256)); 

682:         versionedHash = abi.decode(data, (bytes32)); 
```
[617](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L617), [682](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L682)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

298:             require(abi.decode(data, (bytes32)) == DIAMOND_INIT_SUCCESS_RETURN_VALUE, "lp1"); 
```
[298](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L298)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

177:         proxy = BeaconProxy(abi.decode(returndata, (address))); 
```
[177](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L177)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

57:         (bytes memory nameBytes, bytes memory symbolBytes, bytes memory decimalsBytes) = abi.decode( 

179:         (result) = abi.decode(_input, (string)); 

184:         (result) = abi.decode(_input, (uint8)); 
```
[57](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L57), [179](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L179), [184](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L184)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

347:             ImmutableData[] memory immutables = abi.decode(returnData, (ImmutableData[])); 
```
[347](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L347)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

374:             (address token, uint256 minAllowance) = abi.decode(_transaction.paymasterInput[4:68], (address, uint256)); 
```
[374](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L374)

</details>


---
### [GAS&#x2011;88] Use assembly scratch space to build calldata for external calls
Using Solidity's assembly scratch space for constructing calldata in external calls with one or two arguments can be a gas-efficient approach. This method leverages the designated memory area (the first 64 bytes of memory) for temporary data storage during assembly operations. By directly writing arguments into this scratch space, it eliminates the need for additional memory allocation typically required for calldata preparation. This technique can lead to notable gas savings, especially in high-frequency or gas-sensitive operations. However, it requires careful implementation to avoid data corruption and should be used with a thorough understanding of low-level EVM operations and memory handling. Proper testing and validation are crucial when employing such optimizations.


Gas saved per Instance: ~220 *(Total: ~11,880)*
<details>
<summary><i>There are 54 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

65:         uint256 amount = IERC20(_token).balanceOf(address(this)); 

161:         uint256 balanceBefore = _token.balanceOf(address(sharedBridge)); 

163:         uint256 balanceAfter = _token.balanceOf(address(sharedBridge)); 
```
[65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L65), [161](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L161), [163](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L163)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

127:             uint256 balanceBefore = IERC20(_token).balanceOf(address(this)); 
128:             uint256 amount = IERC20(_token).balanceOf(address(legacyBridge));

130:             IL1ERC20Bridge(_target).tranferTokenToSharedBridge(_token, amount); 
131:             uint256 balanceAfter = IERC20(_token).balanceOf(address(this));

138:         require(bridgehub.getStateTransition(_chainId) == msg.sender, "receiveEth not state transition"); 

174:         uint256 balanceBefore = _token.balanceOf(address(this)); 

176:         uint256 balanceAfter = _token.balanceOf(address(this)); 

195:         require(bridgehub.baseToken(_chainId) != _l1Token, "ShB: baseToken deposit not supported"); 

396:             require(!legacyBridge.isWithdrawalFinalized(_l2BatchNumber, _l2MessageIndex), "ShB: legacy withdrawal"); 

423:             bool alreadyFinalized = IGetters(ERA_DIAMOND_PROXY).isEthWithdrawalFinalized( 

467:             bool baseTokenWithdrawal = (l1Token == bridgehub.baseToken(_chainId)); 

508:             l1Token = bridgehub.baseToken(_chainId); 

595:             l2TxHash = bridgehub.requestL2TransactionDirect{value: msg.value}(request); 
```
[127](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L127-L128), [130](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L130-L131), [138](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L138), [174](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L174), [176](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L176), [195](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L195), [396](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L396), [423](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L423), [467](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L467), [508](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L508), [595](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L595)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

76:         return IStateTransitionManager(stateTransitionManager[_chainId]).stateTransition(_chainId); 

238:         canonicalTxHash = IZkSyncStateTransition(stateTransition).bridgehubRequestL2Transaction( 

304:         canonicalTxHash = IZkSyncStateTransition(stateTransition).bridgehubRequestL2Transaction( 
```
[76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L76), [238](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L238), [304](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L304)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

171:         IZkSyncStateTransition(stateTransition[_chainId]).revertBatches(_newLastBatch); 

226:         IAdmin(_chainContract).executeUpgrade(cutData); 
```
[171](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L171), [226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L226)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

62:         require(msg.sender == stateTransitionManager.getChainAdmin(_chainId), "ValidatorTimelock: only chain admin"); 

226:         address contractAddress = stateTransitionManager.stateTransition(_chainId); 
```
[62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L62), [226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L226)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

106:             cutHashInput == IStateTransitionManager(s.stateTransitionManager).upgradeCutHash(_oldProtocolVersion), 
```
[106](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L106)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

43:         IL1SharedBridge(sharedBridgeAddress).receiveEth{value: amount}(ERA_CHAIN_ID); 
```
[43](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L43)

```solidity
üìÅ File: contracts/zksync/contracts/ForceDeployUpgrader.sol

14:         IContractDeployer(DEPLOYER_SYSTEM_CONTRACT).forceDeployOnAddresses{value: msg.value}(_forceDeployments); 
```
[14](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/ForceDeployUpgrader.sol#L14)

```solidity
üìÅ File: contracts/zksync/contracts/L2ContractHelper.sol

91:         return L2_MESSENGER.sendToL1(_message); 
```
[91](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L91)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

66:             l2TokenBeacon.transferOwnership(_aliasedOwner); 

104:         IL2StandardToken(expectedL2Token).bridgeMint(_l2Receiver, _amount); 

113:         L2StandardERC20(address(l2Token)).bridgeInitialize(_l1Token, _data); 

126:         IL2StandardToken(_l2Token).bridgeBurn(msg.sender, _amount); 
```
[66](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L66), [104](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L104), [113](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L113), [126](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L126)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

75:         try this.decodeString(nameBytes) returns (string memory nameString) { 

81:         try this.decodeString(symbolBytes) returns (string memory symbolString) { 

93:         try this.decodeUint8(decimalsBytes) returns (uint8 decimalsUint8) { 
```
[75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L75), [81](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L81), [93](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L93)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

102:         if (codeHash == 0x00 && NONCE_HOLDER_SYSTEM_CONTRACT.getRawNonce(account) > 0) { 
```
[102](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L102)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

73:         L1_MESSENGER_CONTRACT.sendToL1(_rawCompressedData); 
74:         KNOWN_CODE_STORAGE_CONTRACT.markBytecodeAsPublished(bytecodeHash);
```
[73](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L73-L74)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

49:             ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.getRawCodeHash(_address) == 0 

168:         NONCE_HOLDER_SYSTEM_CONTRACT.incrementDeploymentNonce(msg.sender); 

188:         uint256 senderNonce = NONCE_HOLDER_SYSTEM_CONTRACT.incrementDeploymentNonce(msg.sender); 

254:             this.forceDeployOnAddress{value: _deployments[i].value}(_deployments[i], msg.sender); 

269:             ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.getCodeHash(uint256(uint160(_newAddress))) == 0x0, 

273:         require(NONCE_HOLDER_SYSTEM_CONTRACT.getRawNonce(_newAddress) == 0x00, "Account is occupied"); 

302:         uint256 knownCodeMarker = KNOWN_CODE_STORAGE_CONTRACT.getMarker(_bytecodeHash); 

312:         ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.storeAccountConstructingCodeHash(_newAddress, constructingBytecodeHash); 

345:             ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.markAccountCodeHashAsConstructed(_newAddress); 

348:             IMMUTABLE_SIMULATOR_SYSTEM_CONTRACT.setImmutables(_newAddress, immutables); 

352:             ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.storeAccountConstructedCodeHash(_newAddress, _bytecodeHash); 
```
[49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L49), [168](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L168), [188](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L188), [254](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L254), [269](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L269), [273](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L273), [302](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L302), [312](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L312), [345](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L345), [348](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L348), [352](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L352)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

51:                 L1_MESSENGER_CONTRACT.requestBytecodeL1Publication(_bytecodeHash); 
```
[51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L51)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

317:         PUBDATA_CHUNK_PUBLISHER.chunkAndPublishPubdata(totalL2ToL1Pubdata); 
```
[317](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L317)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

77:         L1_MESSENGER_CONTRACT.sendToL1(message); 

90:         L1_MESSENGER_CONTRACT.sendToL1(message); 
```
[77](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L77), [90](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L90)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

83:         IContractDeployer.AccountInfo memory accountInfo = DEPLOYER_SYSTEM_CONTRACT.getAccountInfo(msg.sender); 
```
[83](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L83)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

377:             uint256 currentAllowance = IERC20(token).allowance(address(this), paymaster); 
```
[377](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L377)

</details>


---
### [GAS&#x2011;89] Use assembly to perform efficient back-to-back calls
If a similar external call is performed back-to-back, we can use assembly to reuse any function signatures and function parameters that stay the same. In addition, we can also reuse the same memory space for each function call (`scratch space` + `free memory pointer` + `zero slot`), which can potentially allow us to avoid memory expansion costs.


Gas saved per Instance: ~300 *(Total: ~600)*

<i>There are 2 instaces of this issue:</i>

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

382:                 IERC20(token).safeApprove(paymaster, 0); 
383:                 IERC20(token).safeApprove(paymaster, minAllowance);
```
[382](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L382-L383)


---
### [GAS&#x2011;90] Use assembly to validate `msg.sender`
We can use assembly to efficiently validate msg.sender with the least amount of opcodes necessary. For more details check the following report [Here](https://code4rena.com/reports/2023-05-juicebox#g-06-use-assembly-to-validate-msgsender)


Gas saved per Instance: ~12 *(Total: ~204)*
<details>
<summary><i>There are 17 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

64:         require(msg.sender == address(sharedBridge), "Not shared bridge"); 
```
[64](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L64)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

138:         require(bridgehub.getStateTransition(_chainId) == msg.sender, "receiveEth not state transition"); 
```
[138](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L138)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

62:         require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights 
```
[62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L62)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

121:         require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights 
```
[121](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L121)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

34:         require(msg.sender == pendingAdmin, "n4"); // Only proposed by current admin address can claim the admin rights 
```
[34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L34)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

87:         require( 
88:             AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1Bridge ||
89:                 AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1LegacyBridge,
90:             "mq"
91:         );
```
[87](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L87-L91)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

120:         require(msg.sender == UpgradeableBeacon(beaconAddress).owner(), "tt"); 
```
[120](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L120)

```solidity
üìÅ File: system-contracts/contracts/ComplexUpgrader.sol

22:         require(msg.sender == FORCE_DEPLOYER, "Can only be called by FORCE_DEPLOYER"); 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L22)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

239:         require( 
240:             msg.sender == FORCE_DEPLOYER || msg.sender == address(COMPLEX_UPGRADER_CONTRACT),
241:             "Can only be called by FORCE_DEPLOYER or COMPLEX_UPGRADER_CONTRACT"
242:         );
```
[239](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L239-L242)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

35:         require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract"); 
```
[35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L35)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

33:         require( 
34:             msg.sender == MSG_VALUE_SYSTEM_CONTRACT ||
35:                 msg.sender == address(DEPLOYER_SYSTEM_CONTRACT) ||
36:                 msg.sender == BOOTLOADER_FORMAL_ADDRESS,
37:             "Only system contracts with special access can call this method"
38:         );
```
[33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L33-L38)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

89:             require(isNonceUsed(msg.sender, _key - 1), "Previous nonce has not been used"); 

136:         require( 
137:             msg.sender == address(DEPLOYER_SYSTEM_CONTRACT),
138:             "Only the contract deployer can increment the deployment nonce"
139:         );
```
[89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L89), [136](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L136-L139)

</details>


---
### [GAS&#x2011;91] Use `assembly` to write address/contract storage values
Using `assembly { sstore(state.slot, addr) }` instead of `state = addr` can save gas.


Gas saved per Instance: ~50 *(Total: ~2,600)*
<details>
<summary><i>There are 52 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

96:         l1WethAddress = _l1WethAddress; 

112:         l2BridgeAddress[ERA_CHAIN_ID] = ERA_ERC20_BRIDGE_ADDRESS; 

143:         l2BridgeAddress[_chainId] = _l2BridgeAddress; 

508:             l1Token = bridgehub.baseToken(_chainId); 

579:                 refundRecipient = _prevMsgSender != tx.origin 
580:                     ? AddressAliasHelper.applyL1ToL2Alias(_prevMsgSender)
581:                     : _prevMsgSender;
```
[96](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L96), [112](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L112), [143](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L143), [508](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L508), [579](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L579-L581)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

55:         pendingAdmin = _newPendingAdmin; 

65:         admin = currentPendingAdmin; 

109:         sharedBridge = IL1SharedBridge(_sharedBridge); 

134:         stateTransitionManager[_chainId] = _stateTransitionManager; 
135:         baseToken[_chainId] = _baseToken;

328:             _recipient = msg.sender == tx.origin ? msg.sender : AddressAliasHelper.applyL1ToL2Alias(msg.sender); 

331:             _recipient = AddressAliasHelper.applyL1ToL2Alias(_refundRecipient); 

333:             _recipient = _refundRecipient; 
```
[55](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L55), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L65), [109](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L109), [134](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L134-L135), [328](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L328), [331](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L331), [333](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L333)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

46:         securityCouncil = _securityCouncil; 

258:         securityCouncil = _newSecurityCouncil; 
```
[46](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L46), [258](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L258)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

59:         bridgehub = _bridgehub; 

85:         genesisUpgrade = _initializeData.genesisUpgrade; 

87:         validatorTimelock = _initializeData.validatorTimelock; 

114:         pendingAdmin = _newPendingAdmin; 

124:         admin = currentPendingAdmin; 

133:         validatorTimelock = _validatorTimelock; 

234:         stateTransition[_chainId] = _stateTransitionContract; 

282:         stateTransition[_chainId] = stateTransitionAddress; 
```
[59](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L59), [85](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L85), [87](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L87), [114](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L114), [124](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L124), [133](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L133), [234](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L234), [282](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L282)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

74:         stateTransitionManager = _stateTransitionManager; 
```
[74](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L74)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol

31:         s.bridgehub = _initializeData.bridgehub; 
32:         s.stateTransitionManager = _initializeData.stateTransitionManager;
33:         s.baseToken = _initializeData.baseToken;
34:         s.baseTokenBridge = _initializeData.baseTokenBridge;

38:         s.admin = _initializeData.admin; 

47:         s.blobVersionedHashRetriever = _initializeData.blobVersionedHashRetriever; 
```
[31](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L31-L34), [38](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L38), [47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L47)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

27:         s.pendingAdmin = _newPendingAdmin; 

37:         s.admin = pendingAdmin; 
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L27), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L37)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

235:             l2Sender = AddressAliasHelper.applyL1ToL2Alias(_request.sender); 

248:         params.sender = l2Sender; 

250:         params.contractAddressL2 = _request.contractL2; 

253:         params.refundRecipient = _request.refundRecipient; 

278:             refundRecipient = AddressAliasHelper.applyL1ToL2Alias(refundRecipient); 

280:         _params.refundRecipient = refundRecipient; 
```
[235](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L235), [248](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L248), [250](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L250), [253](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L253), [278](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L278), [280](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L280)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

268:             ds.facets[facetPosition] = lastFacet; 
```
[268](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L268)

```solidity
üìÅ File: contracts/ethereum/contracts/vendor/AddressAliasHelper.sol

30:             l2Address = address(uint160(l1Address) + offset); 

40:             l1Address = address(uint160(l2Address) - offset); 
```
[30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L30), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/vendor/AddressAliasHelper.sol#L40)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

60:         l1Bridge = _l1Bridge; 

65:             l2TokenBeacon = new UpgradeableBeacon{salt: bytes32(0)}(l2StandardToken); 

99:             l1TokenAddress[expectedL2Token] = _l1Token; 
```
[60](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L60), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L65), [99](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L99)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

52:         l1Address = _l1Address; 

54:         l2Bridge = msg.sender; 
```
[52](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L52), [54](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L54)

```solidity
üìÅ File: contracts/zksync/contracts/vendor/AddressAliasHelper.sol

30:             l2Address = address(uint160(l1Address) + offset); 

40:             l1Address = address(uint160(l2Address) - offset); 
```
[30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L30), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/vendor/AddressAliasHelper.sol#L40)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

109:         newAddress = address(uint160(uint256(hash))); 

125:         newAddress = address(uint160(uint256(hash))); 
```
[109](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L109), [125](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L125)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

32:         to = address(uint160(addressAsUint)); 
```
[32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L32)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

100:         origin = _newOrigin; 
```
[100](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L100)

</details>


---
### [GAS&#x2011;92] Use `calldata` instead of `memory` for function arguments that do not get mutated
Mark data types as `calldata` instead of `memory` where possible. This makes it so that the data is not automatically loaded into memory. If the data passed into the function does not need to be changed (like updating values in an array), it can be passed in as `calldata`. The one exception to this is if the argument must later be passed into another function that takes an argument that specifies `memory` storage.


Gas saved per Instance: ~300 *(Total: ~5,400)*
<details>
<summary><i>There are 18 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

/// @audit _log
164:     function proveL2LogInclusion( 
165:         uint256 _chainId,
166:         uint256 _batchNumber,
167:         uint256 _index,
168:         L2Log memory _log,
169:         bytes32[] calldata _proof
170:     ) external view override returns (bool) {
```
[164](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L164-L170)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/IBridgehub.sol

/// @audit _log
81:     function proveL2LogInclusion( 
```
[81](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/IBridgehub.sol#L81)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol

/// @audit _diamondCut
11:     constructor(uint256 _chainId, Diamond.DiamondCutData memory _diamondCut) { 
```
[11](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L11)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

/// @audit _lastCommittedBatchData
199:     function commitBatches( 
200:         StoredBatchInfo memory _lastCommittedBatchData,
201:         CommitBatchInfo[] calldata _newBatchesData
202:     ) external nonReentrant onlyValidator {

/// @audit _lastCommittedBatchData
207:     function commitBatchesSharedBridge( 
208:         uint256, // _chainId
209:         StoredBatchInfo memory _lastCommittedBatchData,
210:         CommitBatchInfo[] calldata _newBatchesData
211:     ) external nonReentrant onlyValidator {
```
[199](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L199-L202), [207](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L207-L211)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

/// @audit _request
47:     function bridgehubRequestL2Transaction( 
48:         BridgehubL2TransactionRequest memory _request
49:     ) external payable onlyBridgehub returns (bytes32 canonicalTxHash) {

/// @audit _message
54:     function proveL2MessageInclusion( 
55:         uint256 _batchNumber,
56:         uint256 _index,
57:         L2Message memory _message,
58:         bytes32[] calldata _proof
59:     ) public view returns (bool) {

/// @audit _log
64:     function proveL2LogInclusion( 
65:         uint256 _batchNumber,
66:         uint256 _index,
67:         L2Log memory _log,
68:         bytes32[] calldata _proof
69:     ) external view returns (bool) {
```
[47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L47-L49), [54](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L54-L59), [64](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L64-L69)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol

/// @audit _log
31:     function proveL2LogInclusion( 
```
[31](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IMailbox.sol#L31)

```solidity
üìÅ File: contracts/zksync/contracts/L2ContractHelper.sol

/// @audit _message
22:     function sendToL1(bytes memory _message) external returns (bytes32); 

/// @audit _additionalData
65:     function withdrawWithMessage(address _l1Receiver, bytes memory _additionalData) external payable; 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L22), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L65)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

/// @audit _data
50:     function bridgeInitialize(address _l1Address, bytes memory _data) external initializer { 

/// @audit _newName
/// @audit _newSymbol
111:     function reinitializeToken( 
112:         ERC20Getters calldata _availableGetters,
113:         string memory _newName,
114:         string memory _newSymbol,
115:         uint8 _version
116:     ) external onlyNextVersion(_version) reinitializer(_version) {

/// @audit _input
178:     function decodeString(bytes memory _input) external pure returns (string memory result) { 

/// @audit _input
183:     function decodeUint8(bytes memory _input) external pure returns (uint8 result) { 
```
[50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L50), [111](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L111-L116), [178](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L178), [183](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L183)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

/// @audit _additionalData
85:     function withdrawWithMessage(address _l1Receiver, bytes memory _additionalData) external payable override { 
```
[85](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L85)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IL1Messenger.sol

/// @audit _message
49:     function sendToL1(bytes memory _message) external returns (bytes32); 
```
[49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L49)

</details>


---
### [GAS&#x2011;93] Use constants instead of `type(uint<n>).max` / `.min`

Gas saved per Instance: ~4 *(Total: ~76)*
<details>
<summary><i>There are 19 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

/// @audit 0xFFFFFFFFFFFF
123:         require(_chainId <= type(uint48).max, "Bridgehub: chainId too large"); 
```
[123](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L123)

```solidity
üìÅ File: contracts/ethereum/contracts/common/Config.sol

/// @audit 0xFFFF
115: address constant BRIDGEHUB_MIN_SECOND_BRIDGE_ADDRESS = address(uint160(type(uint16).max)); 
```
[115](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/Config.sol#L115)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol

/// @audit 0xFFFF
48:         require(_transaction.from <= type(uint16).max, "ua"); 
/// @audit 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
49:         require(_transaction.to <= type(uint160).max, "ub");

/// @audit 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
55:         require(_transaction.reserved[1] <= type(uint160).max, "uf"); 
```
[48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L48-L49), [55](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L55)

```solidity
üìÅ File: contracts/zksync/contracts/SystemContractsCaller.sol

/// @audit 0xFFFFFFFF
28:         require(_x <= type(uint32).max, "Overflow"); 
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L28)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

/// @audit 0xFFFFFFFF
37:     uint256 public blockGasLimit = type(uint32).max; 
```
[37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L37)

```solidity
üìÅ File: system-contracts/contracts/libraries/RLPEncoder.sol

/// @audit 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
86:             if (_number > type(uint128).max) { 

/// @audit 0xFFFFFFFFFFFFFFFF
90:             if (_number > type(uint64).max) { 

/// @audit 0xFFFFFFFF
94:             if (_number > type(uint32).max) { 

/// @audit 0xFFFF
98:             if (_number > type(uint16).max) { 

/// @audit 0xFF
102:             if (_number > type(uint8).max) { 
```
[86](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L86), [90](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L90), [94](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L94), [98](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L98), [102](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L102)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractHelper.sol

/// @audit 0xFFFFFFFF
9: uint256 constant UINT32_MASK = type(uint32).max; 
/// @audit 0xFFFFFFFFFFFFFFFF
10: uint256 constant UINT64_MASK = type(uint64).max;
/// @audit 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
11: uint256 constant UINT128_MASK = type(uint128).max;
/// @audit 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
12: uint256 constant ADDRESS_MASK = type(uint160).max;
```
[9](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L9-L12)

```solidity
üìÅ File: system-contracts/contracts/libraries/Utils.sol

/// @audit 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
21:         require(_x <= type(uint128).max, "Overflow"); 

/// @audit 0xFFFFFFFF
27:         require(_x <= type(uint32).max, "Overflow"); 

/// @audit 0xFFFFFF
33:         require(_x <= type(uint24).max, "Overflow"); 
```
[21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L21), [27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L27), [33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L33)

</details>


---
### [GAS&#x2011;94] Use custom errors rather than `revert()`/`require()` strings to save gas
[Source](https://blog.soliditylang.org/2021/04/21/custom-errors/)
Instead of using error strings, to reduce deployment and runtime cost, you should use Custom Errors. This would save both deployment and runtime cost.


Gas saved per Instance: ~29 *(Total: ~9,773)*
<details>
<summary><i>There are 337 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

64:         require(msg.sender == address(sharedBridge), "Not shared bridge"); 

66:         require(amount == _amount, "Incorrect amount"); 

141:         require(_amount != 0, "0T"); // empty deposit 

143:         require(amount == _amount, "3T"); // The token has non-standard transfer logic 

186:         require(amount != 0, "2T"); // empty deposit 

215:         require(!isWithdrawalFinalized[_l2BatchNumber][_l2MessageIndex], "pw"); 
```
[64](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L64), [66](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L66), [141](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L141), [143](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L143), [186](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L186), [215](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L215)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

69:         require(msg.sender == address(bridgehub), "ShB not BH"); 

75:         require( 
76:             msg.sender == address(bridgehub) || (_chainId == ERA_CHAIN_ID && msg.sender == ERA_DIAMOND_PROXY),
77:             "L1SharedBridge: not bridgehub or era chain"
78:         );

84:         require(msg.sender == address(legacyBridge), "ShB not legacy bridge"); 

108:         require(_owner != address(0), "ShB owner 0"); 

121:             require(balanceAfter > balanceBefore, "ShB: 0 eth transferred"); 

129:             require(amount > 0, "ShB: 0 amount to transfer"); 

132:             require(balanceAfter - balanceBefore == amount, "ShB: wrong amount transferred"); 

138:         require(bridgehub.getStateTransition(_chainId) == msg.sender, "receiveEth not state transition"); 

155:             require(msg.value == _amount, "L1SharedBridge: msg.value not equal to amount"); 

158:             require(msg.value == 0, "ShB m.v > 0 b d.it"); 

161:             require(amount == _amount, "3T"); // The token has non-standard transfer logic 

188:         require(l2BridgeAddress[_chainId] != address(0), "ShB l2 bridge not deployed"); 

194:         require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported"); 
195:         require(bridgehub.baseToken(_chainId) != _l1Token, "ShB: baseToken deposit not supported");

200:             require(_depositAmount == 0, "ShB wrong withdraw amount"); 

202:             require(msg.value == 0, "ShB m.v > 0 for BH d.it 2"); 

206:             require(withdrawAmount == _depositAmount, "5T"); // The token has non-standard transfer logic 

208:         require(amount != 0, "6T"); // empty deposit amount 

237:         require(depositHappened[_chainId][_txHash] == 0x00, "ShB tx hap"); 

325:             require(proofValid, "yn"); 

327:         require(_amount > 0, "y1"); 

342:                 require(dataHash == txDataHash, "ShB: d.it not hap"); 

349:             require(chainBalance[_chainId][_l1Token] >= _amount, "ShB n funds"); 

360:             require(callSuccess, "ShB: claimFailedDeposit failed"); 

396:             require(!legacyBridge.isWithdrawalFinalized(_l2BatchNumber, _l2MessageIndex), "ShB: legacy withdrawal"); 

417:         require(!isWithdrawalFinalized[_chainId][_l2BatchNumber][_l2MessageIndex], "Withdrawal is already finalized"); 

427:             require(!alreadyFinalized, "Withdrawal is already finalized 2"); 

439:             require(chainBalance[_chainId][l1Token] >= amount, "ShB not enough funds 2"); // not enought funds 

449:             require(callSuccess, "ShB: withdraw failed"); 

484:         require(success, "ShB withd w proof"); // withdrawal wrong proof 

501:         require(_l2ToL1message.length >= 56, "ShB wrong msg len"); // wrong messsage length 

517:             require(_l2ToL1message.length == 76, "ShB wrong msg len 2"); 

522:             revert("ShB Incorrect message function selector"); 

563:         require(l2BridgeAddress[ERA_CHAIN_ID] != address(0), "ShB b. n dep"); 
564:         require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported 2");
```
[69](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L69), [75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L75-L78), [84](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L84), [108](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L108), [121](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L121), [129](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L129), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L132), [138](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L138), [155](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L155), [158](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L158), [161](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L161), [188](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L188), [194](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L194-L195), [200](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L200), [202](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L202), [206](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L206), [208](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L208), [237](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L237), [325](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L325), [327](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L327), [342](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L342), [349](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L349), [360](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L360), [396](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L396), [417](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L417), [427](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L427), [439](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L439), [449](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L449), [484](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L484), [501](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L501), [517](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L517), [522](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L522), [563](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L563-L564)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

46:         require(msg.sender == admin || msg.sender == owner(), "Bridgehub: not owner or admin"); 

62:         require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights 

83:         require( 
84:             !stateTransitionManagerIsRegistered[_stateTransitionManager],
85:             "Bridgehub: state transition already registered"
86:         );

93:         require( 
94:             stateTransitionManagerIsRegistered[_stateTransitionManager],
95:             "Bridgehub: state transition not registered yet"
96:         );

102:         require(!tokenIsRegistered[_token], "Bridgehub: token already registered"); 

122:         require(_chainId != 0, "Bridgehub: chainId cannot be 0"); 
123:         require(_chainId <= type(uint48).max, "Bridgehub: chainId too large");

125:         require( 
126:             stateTransitionManagerIsRegistered[_stateTransitionManager],
127:             "Bridgehub: state transition not registered"
128:         );
129:         require(tokenIsRegistered[_baseToken], "Bridgehub: token not registered");
130:         require(address(sharedBridge) != address(0), "Bridgehub: weth bridge not set");

132:         require(stateTransitionManager[_chainId] == address(0), "Bridgehub: chainId already registered"); 

223:                 require(msg.value == _request.mintValue, "Bridgehub: msg.value mismatch 1"); 

225:                 require(msg.value == 0, "Bridgehub: non-eth bridge with msg.value"); 

269:                 require( 
270:                     msg.value == _request.mintValue + _request.secondBridgeValue,
271:                     "Bridgehub: msg.value mismatch 2"
272:                 );

275:                 require(msg.value == _request.secondBridgeValue, "Bridgehub: msg.value mismatch 3"); 

296:         require(outputRequest.magicValue == TWO_BRIDGES_MAGIC_VALUE, "Bridgehub: magic value mismatch"); 

300:         require( 
301:             _request.secondBridgeAddress > BRIDGEHUB_MIN_SECOND_BRIDGE_ADDRESS,
302:             "Bridgehub: second bridge address too low"
303:         ); // to avoid calls to precompiles
```
[46](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L46), [62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L62), [83](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L83-L86), [93](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L93-L96), [102](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L102), [122](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L122-L123), [125](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L125-L130), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L132), [223](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L223), [225](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L225), [269](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L269-L272), [275](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L275), [296](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L296), [300](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L300-L303)

```solidity
üìÅ File: contracts/ethereum/contracts/common/ReentrancyGuard.sol

58:         require(lockSlotOldValue == 0, "1B"); 

75:         require(_status == _NOT_ENTERED, "r1"); 
```
[58](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L58), [75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L75)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol

23:         require(_bytecode.length % 32 == 0, "pq"); 

26:         require(bytecodeLenInWords < 2 ** 16, "pp"); // bytecode length must be less than 2^16 words 
27:         require(bytecodeLenInWords % 2 == 1, "ps"); // bytecode length in words must be odd

41:         require(version == 1 && _bytecodeHash[1] == bytes1(0), "zf"); // Incorrectly formatted bytecodeHash 

43:         require(bytecodeLen(_bytecodeHash) % 2 == 1, "uy"); // Code length in words must be odd 
```
[23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L23), [26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L26-L27), [41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L41), [43](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L43)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

42:         require(_admin != address(0), "Admin should be non zero address"); 

59:         require(msg.sender == address(this), "Only governance contract itself is allowed to call this function"); 

65:         require(msg.sender == securityCouncil, "Only security council is allowed to call this function"); 

71:         require( 
72:             msg.sender == owner() || msg.sender == securityCouncil,
73:             "Only the owner and security council are allowed to call this function"
74:         );

155:         require(isOperationPending(_id), "Operation must be pending"); 

172:         require(isOperationReady(id), "Operation must be ready before execution"); 

177:         require(isOperationReady(id), "Operation must be ready after execution"); 

191:         require(isOperationPending(id), "Operation must be pending before execution"); 

196:         require(isOperationPending(id), "Operation must be pending after execution"); 

216:         require(!isOperation(_id), "Operation with this proposal id already exists"); 
217:         require(_delay >= minDelay, "Proposed delay is less than minimum delay");

240:         require(_predecessorId == bytes32(0) || isOperationDone(_predecessorId), "Predecessor operation not completed"); 
```
[42](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L42), [59](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L59), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L65), [71](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L71-L74), [155](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L155), [172](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L172), [177](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L177), [191](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L191), [196](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L196), [216](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L216-L217), [240](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L240)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

64:         require(msg.sender == bridgehub, "StateTransition: only bridgehub"); 

70:         require(msg.sender == admin || msg.sender == owner(), "Bridgehub: not owner or admin"); 

82:         require(_initializeData.governor != address(0), "StateTransition: governor zero"); 

121:         require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights 

256:         require(cutHashInput == initialCutHash, "StateTransition: initial cutHash mismatch"); 
```
[64](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L64), [70](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L70), [82](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L82), [121](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L121), [256](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L256)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

62:         require(msg.sender == stateTransitionManager.getChainAdmin(_chainId), "ValidatorTimelock: only chain admin"); 

68:         require(validators[_chainId][msg.sender] == true, "ValidatorTimelock: only validator"); 

195:                 require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed 

217:                 require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed 
```
[62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L62), [68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L68), [195](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L195), [217](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L217)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol

25:         require(address(_initializeData.verifier) != address(0), "vt"); 
26:         require(_initializeData.admin != address(0), "vy");
27:         require(_initializeData.validatorTimelock != address(0), "hc");
28:         require(_initializeData.priorityTxMaxGasLimit <= MAX_GAS_PER_TRANSACTION, "vu");
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L25-L28)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol

14:         require(_chainId == block.chainid, "pr"); 

25:         require(msg.data.length >= 4 || msg.data.length == 0, "Ut"); 

30:         require(facetAddress != address(0), "F"); // Proxy has no facet for this selector 
31:         require(!diamondStorage.isFrozen || !facet.isFreezable, "q1"); // Facet is frozen
```
[14](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L14), [25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L25), [30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L30-L31)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

34:         require(msg.sender == pendingAdmin, "n4"); // Only proposed by current admin address can claim the admin rights 

59:         require(_newPriorityTxMaxGasLimit <= MAX_GAS_PER_TRANSACTION, "n5"); 

70:         require(_newFeeParams.maxPubdataPerBatch >= _newFeeParams.priorityTxMaxPubdata, "n6"); 

90:         require(s.totalBatchesCommitted == 0, "AdminFacet: set validium only after genesis"); // Validium mode can be set only before the first batch is committed 

105:         require( 
106:             cutHashInput == IStateTransitionManager(s.stateTransitionManager).upgradeCutHash(_oldProtocolVersion),
107:             "StateTransition: cutHash mismatch"
108:         );

110:         require( 
111:             s.protocolVersion == _oldProtocolVersion,
112:             "StateTransition: protocolVersion mismatch in STC when upgrading"
113:         );

116:         require( 
117:             s.protocolVersion > _oldProtocolVersion,
118:             "StateTransition: protocolVersion mismatch in STC after upgrading"
119:         );

136:         require(!diamondStorage.isFrozen, "a9"); // diamond proxy is frozen already 

146:         require(diamondStorage.isFrozen, "a7"); // diamond proxy is not frozen 
```
[34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L34), [59](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L59), [70](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L70), [90](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L90), [105](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L105-L108), [110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L110-L113), [116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L116-L119), [136](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L136), [146](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L146)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

37:         require(_newBatch.batchNumber == _previousBatch.batchNumber + 1, "f"); // only commit next batch 

40:         require(pubdataSource == uint8(PubdataSource.Calldata) || pubdataSource == uint8(PubdataSource.Blob), "us"); 

50:             require(logOutput.pubdataHash == 0x00, "v0h"); 

61:             require( 
62:                 logOutput.pubdataHash ==
63:                     keccak256(_newBatch.pubdataCommitments[1:_newBatch.pubdataCommitments.length - 32]),
64:                 "wp"
65:             );

74:         require(_previousBatch.batchHash == logOutput.previousBatchHash, "l"); 

76:         require(logOutput.chainedPriorityTxsHash == _newBatch.priorityOperationsHash, "t"); 

78:         require(logOutput.numberOfLayer1Txs == _newBatch.numberOfLayer1Txs, "ta"); 

110:         require(batchTimestamp == _expectedBatchTimestamp, "tb"); 

114:         require(_previousBatchTimestamp < batchTimestamp, "h3"); 

122:         require(block.timestamp - COMMIT_TIMESTAMP_NOT_OLDER <= batchTimestamp, "h1"); // New batch timestamp is too small 
123:         require(lastL2BlockTimestamp <= block.timestamp + COMMIT_TIMESTAMP_APPROXIMATION_DELTA, "h2"); // The last L2 block timestamp is too big

149:             require(!_checkBit(processedLogs, uint8(logKey)), "kp"); 

154:                 require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "lm"); 

157:                 require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "ln"); 

160:                 require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "lb"); 

163:                 require(logSender == L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR, "sc"); 

166:                 require(logSender == L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR, "sv"); 

169:                 require(logSender == L2_BOOTLOADER_ADDRESS, "bl"); 

172:                 require(logSender == L2_BOOTLOADER_ADDRESS, "bk"); 

175:                 require(logSender == L2_PUBDATA_CHUNK_PUBLISHER_ADDR, "pc"); 

178:                 require(logSender == L2_PUBDATA_CHUNK_PUBLISHER_ADDR, "pd"); 

181:                 require(logSender == L2_BOOTLOADER_ADDRESS, "bu"); 
182:                 require(_expectedSystemContractUpgradeTxHash == logValue, "ut");

184:                 revert("ul"); 

192:             require(processedLogs == 511, "b7"); 

194:             require(processedLogs == 1023, "b8"); 

226:         require( 
227:             IStateTransitionManager(s.stateTransitionManager).protocolVersion() == s.protocolVersion,
228:             "Executor facet: wrong protocol version"
229:         );

231:         require(_newBatchesData.length == 1, "e4"); 

233:         require(s.storedBatchHashes[s.totalBatchesCommitted] == _hashStoredBatchInfo(_lastCommittedBatchData), "i"); // incorrect previous batch data 

284:         require(s.l2SystemContractsUpgradeBatchNumber == 0, "ik"); 

323:         require(currentBatchNumber == s.totalBatchesExecuted + _executedBatchIdx + 1, "k"); // Execute batches in order 
324:         require(
325:             _hashStoredBatchInfo(_storedBatch) == s.storedBatchHashes[currentBatchNumber],
326:             "exe10" // executing batch should be committed
327:         );

330:         require(priorityOperationsHash == _storedBatch.priorityOperationsHash, "x"); // priority operations hash does not match to expected 

358:         require(newTotalBatchesExecuted <= s.totalBatchesVerified, "n"); // Can't execute batches more than committed and proven currently. 

402:         require(_hashStoredBatchInfo(_prevBatch) == s.storedBatchHashes[currentTotalBatchesVerified], "t1"); 

407:             require( 
408:                 _hashStoredBatchInfo(_committedBatches[i]) == s.storedBatchHashes[currentTotalBatchesVerified],
409:                 "o1"
410:             );

421:         require(currentTotalBatchesVerified <= s.totalBatchesCommitted, "q"); 

442:         require(proofPublicInput.length == 1, "t4"); 

449:         require(successVerifyProof, "p"); // Proof verification fail 

482:         require(s.totalBatchesCommitted > _newLastBatch, "v1"); // The last committed batch is less than new last batch 
483:         require(_newLastBatch >= s.totalBatchesExecuted, "v2"); // Already executed batches cannot be reverted

543:         require(_batch.systemLogs.length <= MAX_L2_TO_L1_LOGS_COMMITMENT_BYTES, "pu"); 

567:         require(_blobCommitments.length == MAX_NUMBER_OF_BLOBS, "b10"); 
568:         require(_blobHashes.length == MAX_NUMBER_OF_BLOBS, "b11");

616:         require(success, "failed to call point evaluation precompile"); 

618:         require(result == BLS_MODULUS, "precompile unexpected output"); 

631:         require(_pubdataCommitments.length > 0, "pl"); 
632:         require(_pubdataCommitments.length <= PUBDATA_COMMITMENT_SIZE * MAX_NUMBER_OF_BLOBS, "bd");
633:         require(_pubdataCommitments.length % PUBDATA_COMMITMENT_SIZE == 0, "bs");

639:             require(blobVersionedHash != bytes32(0), "vh"); 

663:         require(versionedHash == bytes32(0), "lh"); 

668:             require( 
669:                 (_blobHashes[i] == bytes32(0) && blobCommitments[i] == bytes32(0)) ||
670:                     (_blobHashes[i] != bytes32(0) && blobCommitments[i] != bytes32(0)),
671:                 "bh"
672:             );

681:         require(success, "vc"); 
```
[37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L37), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L40), [50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L50), [61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L61-L65), [74](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L74), [76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L76), [78](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L78), [110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L110), [114](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L114), [122](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L122-L123), [149](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L149), [154](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L154), [157](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L157), [160](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L160), [163](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L163), [166](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L166), [169](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L169), [172](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L172), [175](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L175), [178](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L178), [181](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L181-L182), [184](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L184), [192](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L192), [194](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L194), [226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L226-L229), [231](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L231), [233](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L233), [284](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L284), [323](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L323-L327), [330](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L330), [358](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L358), [402](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L402), [407](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L407-L410), [421](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L421), [442](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L442), [449](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L449), [482](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L482-L483), [543](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L543), [567](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L567-L568), [616](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L616), [618](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L618), [631](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L631-L633), [639](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L639), [663](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L663), [668](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L668-L672), [681](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L681)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

183:         require(ds.selectorToFacet[_selector].facetAddress != address(0), "g2"); 
```
[183](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L183)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

39:         require(s.chainId == ERA_CHAIN_ID, "transferEthToSharedBridge only available for Era on mailbox"); 

110:         require(_batchNumber <= s.totalBatchesExecuted, "xx"); 

117:         require(hashedLog != L2_L1_LOGS_TREE_DEFAULT_LEAF_HASH, "tw"); 

158:         require(s.baseTokenGasPriceMultiplierDenominator > 0, "Mailbox: baseTokenGasPriceDenominator not set"); 

185:         require(s.chainId == ERA_CHAIN_ID, "finalizeEthWithdrawal only available for Era on mailbox"); 

206:         require(s.chainId == ERA_CHAIN_ID, "legacy interface only available for era token"); 

243:         require(_request.l2GasPerPubdataByteLimit == REQUIRED_L2_GAS_PRICE_PER_PUBDATA, "qp"); 

264:         require(_factoryDeps.length <= MAX_NEW_FACTORY_DEPS, "uj"); 

272:         require(_mintValue >= baseCost + _params.l2Value, "mv"); // The `msg.value` doesn't cover the transaction cost 
```
[39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L39), [110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L110), [117](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L117), [158](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L158), [185](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L185), [206](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L206), [243](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L243), [264](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L264), [272](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L272)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol

16:         require(msg.sender == s.admin, "StateTransition Chain: not admin"); 

22:         require(s.validators[msg.sender], "StateTransition Chain: not validator"); 

27:         require(msg.sender == s.stateTransitionManager, "StateTransition Chain: not state transition manager"); 

32:         require(msg.sender == s.bridgehub, "StateTransition Chain: not bridgehub"); 

37:         require( 
38:             msg.sender == s.admin || msg.sender == s.stateTransitionManager,
39:             "StateTransition Chain: Only by admin or state transition manager"
40:         );

45:         require( 
46:             s.validators[msg.sender] || msg.sender == s.stateTransitionManager,
47:             "StateTransition Chain: Only by validator or state transition manager"
48:         );

53:         require(msg.sender == s.baseTokenBridge, "Only shared bridge can call this function"); 
```
[16](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L16), [22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L22), [27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L27), [32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L32), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L37-L40), [45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L45-L48), [53](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L53)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

107:             require(selectors.length > 0, "B"); // no functions for diamond cut 

116:                 revert("C"); // undefined diamond cut action 

132:         require(_facet.code.length > 0, "G"); 

141:             require(oldFacet.facetAddress == address(0), "J"); // facet for this selector already exists 

155:         require(_facet.code.length > 0, "K"); 

161:             require(oldFacet.facetAddress != address(0), "L"); // it is impossible to replace the facet with zero address 

175:         require(_facet == address(0), "a1"); // facet address must be zero 

181:             require(oldFacet.facetAddress != address(0), "a2"); // Can't delete a non-existent facet 

215:             require(_isSelectorFreezable == ds.selectorToFacet[selector0].isFreezable, "J1"); 

280:             require(_calldata.length == 0, "H"); // Non-empty calldata for zero address 

287:                     revert("I"); // delegatecall failed 

297:             require(data.length == 32, "lp"); 
298:             require(abi.decode(data, (bytes32)) == DIAMOND_INIT_SUCCESS_RETURN_VALUE, "lp1");
```
[107](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L107), [116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L116), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L132), [141](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L141), [155](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L155), [161](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L161), [175](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L175), [181](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L181), [215](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L215), [280](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L280), [287](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L287), [297](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L297-L298)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol

24:         require(pathLength > 0, "xc"); 
25:         require(pathLength < 256, "bt");
26:         require(_index < (1 << pathLength), "px");
```
[24](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L24-L26)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol

65:         require(!_queue.isEmpty(), "D"); // priority queue is empty 

73:         require(!_queue.isEmpty(), "s"); // priority queue is empty 
```
[65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L65), [73](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L73)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol

28:         require(l2GasForTxBody <= _priorityTxMaxGasLimit, "ui"); 

30:         require(l2GasForTxBody / _transaction.gasPerPubdataByteLimit <= _priorityTxMaxPubdata, "uk"); 

34:         require( 
35:             getMinimalPriorityTransactionGasLimit(
36:                 _encoded.length,
37:                 _transaction.factoryDeps.length,
38:                 _transaction.gasPerPubdataByteLimit
39:             ) <= l2GasForTxBody,
40:             "up"
41:         );

48:         require(_transaction.from <= type(uint16).max, "ua"); 
49:         require(_transaction.to <= type(uint160).max, "ub");
50:         require(_transaction.paymaster == 0, "uc");
51:         require(_transaction.value == 0, "ud");
52:         require(_transaction.maxFeePerGas == 0, "uq");
53:         require(_transaction.maxPriorityFeePerGas == 0, "ux");
54:         require(_transaction.reserved[0] == 0, "ue");
55:         require(_transaction.reserved[1] <= type(uint160).max, "uf");
56:         require(_transaction.reserved[2] == 0, "ug");
57:         require(_transaction.reserved[3] == 0, "uo");
58:         require(_transaction.signature.length == 0, "uh");
59:         require(_transaction.paymasterInput.length == 0, "ul1");
60:         require(_transaction.reservedDynamic.length == 0, "um");

115:         require(_totalGasLimit >= overhead, "my"); // provided gas limit doesn't cover transaction overhead 
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L28), [30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L30), [34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L34-L41), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L48-L60), [115](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L115)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

72:         require(block.timestamp >= _proposedUpgrade.upgradeTimestamp, "Upgrade is not ready yet"); 

190:         require(_l2ProtocolUpgradeTx.txType == SYSTEM_UPGRADE_L2_TX_TYPE, "L2 system upgrade tx type is wrong"); 

205:         require( 
206:             _l2ProtocolUpgradeTx.nonce == _newProtocolVersion,
207:             "The new protocol version should be included in the L2 system upgrade tx"
208:         );

223:         require(_factoryDeps.length == _expectedHashes.length, "Wrong number of factory deps"); 
224:         require(_factoryDeps.length <= MAX_NEW_FACTORY_DEPS, "Factory deps can be at most 32");

227:             require( 
228:                 L2ContractHelper.hashL2Bytecode(_factoryDeps[i]) == bytes32(_expectedHashes[i]),
229:                 "Wrong factory dep hash"
230:             );

238:         require( 
239:             _newProtocolVersion > previousProtocolVersion,
240:             "New protocol version is not greater than the current one"
241:         );
242:         require(
243:             _newProtocolVersion - previousProtocolVersion <= MAX_ALLOWED_PROTOCOL_VERSION_DELTA,
244:             "Too big protocol version difference"
245:         );

249:         require(s.l2SystemContractsUpgradeTxHash == bytes32(0), "Previous upgrade has not been finalized"); 
250:         require(
251:             s.l2SystemContractsUpgradeBatchNumber == 0,
252:             "The batch number of the previous upgrade has not been cleaned"
253:         );
```
[72](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L72), [190](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L190), [205](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L205-L208), [223](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L223-L224), [227](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L227-L230), [238](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L238-L245), [249](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L249-L253)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol

22:         require( 
23:             // Genesis Upgrade difference: Note this is the only thing change > to >=
24:             _newProtocolVersion >= previousProtocolVersion,
25:             "New protocol version is not greater than the current one"
26:         );
27:         require(
28:             _newProtocolVersion - previousProtocolVersion <= MAX_ALLOWED_PROTOCOL_VERSION_DELTA,
29:             "Too big protocol version difference"
30:         );

33:         require(s.l2SystemContractsUpgradeTxHash == bytes32(0), "Previous upgrade has not been finalized"); 
34:         require(
35:             s.l2SystemContractsUpgradeBatchNumber == 0,
36:             "The batch number of the previous upgrade has not been cleaned"
37:         );

52:         require(block.timestamp >= _proposedUpgrade.upgradeTimestamp, "Upgrade is not ready yet"); 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L22-L30), [33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L33-L37), [52](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L52)

```solidity
üìÅ File: contracts/zksync/contracts/SystemContractsCaller.sol

28:         require(_x <= type(uint32).max, "Overflow"); 
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L28)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

55:         require(_l1Bridge != address(0), "bf"); 
56:         require(_l2TokenProxyBytecodeHash != bytes32(0), "df");
57:         require(_aliasedOwner != address(0), "sf");
58:         require(_l2TokenProxyBytecodeHash != bytes32(0), "df");

68:             require(_l1LegecyBridge != address(0), "bf2"); 

87:         require( 
88:             AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1Bridge ||
89:                 AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1LegacyBridge,
90:             "mq"
91:         );
92:         require(msg.value == 0, "Value should be 0 for ERC20 bridge");

98:             require(deployedToken == expectedL2Token, "mt"); 

101:             require(currentL1Token == _l1Token, "gg"); // Double check that the expected value equal to real one 

124:         require(_amount > 0, "Amount cannot be zero"); 

129:         require(l1Token != address(0), "yh"); 

176:         require(success, "mk"); 
```
[55](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L55-L58), [68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L68), [87](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L87-L92), [98](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L98), [101](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L101), [124](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L124), [129](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L129), [176](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L176)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

51:         require(_l1Address != address(0), "in6"); // Should be non-zero address 

120:         require(msg.sender == UpgradeableBeacon(beaconAddress).owner(), "tt"); 

130:         require(msg.sender == l2Bridge, "xnt"); // Only L2 bridge can call this method 

137:         require(_version == _getInitializedVersion() + 1, "v"); 
```
[51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L51), [120](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L120), [130](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L130), [137](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L137)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

26:         require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract"); 

37:         require(Utils.isContractConstructing(_hash), "Code hash is not for a contract on constructor"); 

48:         require(Utils.isContractConstructed(_hash), "Code hash is not for a constructed contract"); 

57:         require(Utils.isContractConstructing(codeHash), "Code hash is not for a contract on constructor"); 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L26), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L37), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L48), [57](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L57)

```solidity
üìÅ File: system-contracts/contracts/BootloaderUtilities.sol

37:             revert("Unsupported tx type"); 

92:             require(vInt == 27 || vInt == 28, "Invalid v value"); 

191:             require(vInt == 27 || vInt == 28, "Invalid v value"); 

286:             require(vInt == 27 || vInt == 28, "Invalid v value"); 
```
[37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L37), [92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L92), [191](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L191), [286](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L286)

```solidity
üìÅ File: system-contracts/contracts/ComplexUpgrader.sol

22:         require(msg.sender == FORCE_DEPLOYER, "Can only be called by FORCE_DEPLOYER"); 

24:         require(_delegateTo.code.length > 0, "Delegatee is an EOA"); 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L22), [24](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L24)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

51:             require( 
52:                 encodedData.length * 4 == _bytecode.length,
53:                 "Encoded data length should be 4 times shorter than the original bytecode"
54:             );

56:             require( 
57:                 dictionary.length / 8 <= encodedData.length / 2,
58:                 "Dictionary should have at most the same number of entries as the encoded data"
59:             );

63:                 require(indexOfEncodedChunk < dictionary.length, "Encoded chunk index is out of bounds"); 

68:                 require(encodedChunk == realChunk, "Encoded chunk does not match the original bytecode"); 

119:         require(_enumerationIndexSize <= MAX_ENUMERATION_INDEX_SIZE, "enumeration index size is too large"); 

140:             require(derivedKey == _compressedStateDiffs.readBytes32(stateDiffPtr), "iw: initial key mismatch"); 

156:         require(numInitialWritesProcessed == numberOfInitialWrites, "Incorrect number of initial storage diffs"); 

171:             require(enumIndex == compressedEnumIndex, "rw: enum key mismatch"); 

187:         require(stateDiffPtr == _compressedStateDiffs.length, "Extra data in _compressedStateDiffs"); 

230:                 require(convertedValue == _finalValue, "transform or no compression: compressed and final mismatch"); 

232:                 require( 
233:                     _initialValue + convertedValue == _finalValue,
234:                     "add: initial plus converted not equal to final"
235:                 );

237:                 require( 
238:                     _initialValue - convertedValue == _finalValue,
239:                     "sub: initial minus converted not equal to final"
240:                 );

242:                 revert("unsupported operation"); 
```
[51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L51-L54), [56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L56-L59), [63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L63), [68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L68), [119](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L119), [140](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L140), [156](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L156), [171](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L171), [187](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L187), [230](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L230), [232](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L232-L235), [237](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L237-L240), [242](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L242)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

29:         require(msg.sender == address(this), "Callable only by self"); 

77:         require( 
78:             _nonceOrdering == AccountNonceOrdering.Arbitrary &&
79:                 currentInfo.nonceOrdering == AccountNonceOrdering.Sequential,
80:             "It is only possible to change from sequential to arbitrary ordering"
81:         );

239:         require( 
240:             msg.sender == FORCE_DEPLOYER || msg.sender == address(COMPLEX_UPGRADER_CONTRACT),
241:             "Can only be called by FORCE_DEPLOYER or COMPLEX_UPGRADER_CONTRACT"
242:         );

251:         require(msg.value == sumOfValues, "`value` provided is not equal to the combined `value`s of deployments"); 

264:         require(_bytecodeHash != bytes32(0x0), "BytecodeHash cannot be zero"); 
265:         require(uint160(_newAddress) > MAX_SYSTEM_CONTRACT_ADDRESS, "Can not deploy contracts in kernel space");

268:         require( 
269:             ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.getCodeHash(uint256(uint160(_newAddress))) == 0x0,
270:             "Code hash is non-zero"
271:         );

273:         require(NONCE_HOLDER_SYSTEM_CONTRACT.getRawNonce(_newAddress) == 0x00, "Account is occupied"); 

303:         require(knownCodeMarker > 0, "The code hash is not known"); 

350:             require(value == 0, "The value must be zero if we do not call the constructor"); 
```
[29](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L29), [77](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L77-L81), [239](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L239-L242), [251](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L251), [264](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L264-L265), [268](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L268-L271), [273](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L273), [303](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L303), [350](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L350)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

100:         require(totalRequiredBalance <= address(this).balance, "Not enough balance for fee + value"); 

160:         require(_signature.length == 65, "Signature length is incorrect"); 

173:         require(v == 27 || v == 28, "v is neither 27 nor 28"); 

184:         require(uint256(s) <= 0x7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5D576E7357A4501DDFE92F46681B20A0, "Invalid s"); 

202:         require(success, "Failed to pay the fee to the operator"); 
```
[100](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L100), [160](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L160), [173](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L173), [184](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L184), [202](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L202)

```solidity
üìÅ File: system-contracts/contracts/GasBoundCaller.sol

46:         require(_maxTotalGas >= gasleft(), "Gas limit is too low"); 

76:             require(pubdataAllowance + gasleft() >= pubdataCost + CALL_RETURN_OVERHEAD, "Not enough gas for pubdata"); 
```
[46](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L46), [76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L76)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

35:         require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract"); 
```
[35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L35)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

20:         require(msg.sender == address(COMPRESSOR_CONTRACT), "Callable only by the compressor"); 

76:         require(version == 1 && _bytecodeHash[1] == bytes1(0), "Incorrectly formatted bytecodeHash"); 

78:         require(Utils.bytecodeLenInWords(_bytecodeHash) % 2 == 1, "Code length in words must be odd"); 
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L20), [76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L76), [78](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L78)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

201:         require(numberOfL2ToL1Logs <= L2_TO_L1_LOGS_MERKLE_TREE_LEAVES, "Too many L2->L1 logs"); 

214:         require( 
215:             reconstructedChainedLogsHash == chainedLogsHash,
216:             "reconstructedChainedLogsHash is not equal to chainedLogsHash"
217:         );

245:         require( 
246:             reconstructedChainedMessagesHash == chainedMessagesHash,
247:             "reconstructedChainedMessagesHash is not equal to chainedMessagesHash"
248:         );

269:         require( 
270:             reconstructedChainedL1BytecodesRevealDataHash == chainedL1BytecodesRevealDataHash,
271:             "reconstructedChainedL1BytecodesRevealDataHash is not equal to chainedL1BytecodesRevealDataHash"
272:         );

279:         require( 
280:             uint256(uint8(bytes1(_totalL2ToL1PubdataAndStateDiffs[calldataPtr]))) ==
281:                 STATE_DIFF_COMPRESSION_VERSION_NUMBER,
282:             "state diff compression version mismatch"
283:         );

298:         require(calldataPtr <= MAX_ALLOWED_PUBDATA_PER_BATCH, "L1 Messenger pubdata is too long"); 

315:         require(calldataPtr == _totalL2ToL1PubdataAndStateDiffs.length, "Extra data in the totalL2ToL1Pubdata array"); 
```
[201](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L201), [214](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L214-L217), [245](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L245-L248), [269](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L269-L272), [279](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L279-L283), [298](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L298), [315](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L315)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

33:         require( 
34:             msg.sender == MSG_VALUE_SYSTEM_CONTRACT ||
35:                 msg.sender == address(DEPLOYER_SYSTEM_CONTRACT) ||
36:                 msg.sender == BOOTLOADER_FORMAL_ADDRESS,
37:             "Only system contracts with special access can call this method"
38:         );

41:         require(fromBalance >= _amount, "Transfer amount exceeds balance"); 
```
[33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L33-L38), [41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L41)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

60:         require(to != address(this), "MsgValueSimulator calls itself"); 
```
[60](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L60)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

66:         require(_value <= MAXIMAL_MIN_NONCE_INCREMENT, "The value for incrementing the nonce is too high"); 

85:         require(_value != 0, "Nonce value cannot be set to 0"); 

89:             require(isNonceUsed(msg.sender, _key - 1), "Previous nonce has not been used"); 

115:         require(oldMinNonce == _expectedNonce, "Incorrect nonce"); 

136:         require( 
137:             msg.sender == address(DEPLOYER_SYSTEM_CONTRACT),
138:             "Only the contract deployer can increment the deployment nonce"
139:         );

170:             revert("Reusing the same nonce twice"); 

172:             revert("The nonce was not set as used"); 
```
[66](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L66), [85](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L85), [89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L89), [115](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L115), [136](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L136-L139), [170](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L170), [172](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L172)

```solidity
üìÅ File: system-contracts/contracts/PubdataChunkPublisher.sol

22:         require(_pubdata.length <= BLOB_SIZE_BYTES * MAX_NUMBER_OF_BLOBS, "pubdata should fit in 2 blobs"); 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L22)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

242:         require(_isFirstInBatch, "Upgrade transaction must be first"); 

245:         require(_l2BlockNumber > 0, "L2 block number is never expected to be zero"); 

249:             require(correctPrevBlockHash == _expectedPrevL2BlockHash, "The previous L2 block hash is incorrect"); 

287:             require(_maxVirtualBlocksToCreate > 0, "Can't initialize the first virtual block"); 

351:             require( 
352:                 _l2BlockTimestamp >= currentBatchTimestamp,
353:                 "The timestamp of the L2 block must be greater than or equal to the timestamp of the current batch"
354:             );
355:             require(_maxVirtualBlocksToCreate > 0, "There must be a virtual block created at the start of the batch");

367:             require(!_isFirstInBatch, "Can not reuse L2 block number from the previous batch"); 
368:             require(currentL2BlockTimestamp == _l2BlockTimestamp, "The timestamp of the same L2 block must be same");
369:             require(
370:                 _expectedPrevL2BlockHash == _getLatest257L2blockHash(_l2BlockNumber - 1),
371:                 "The previous hash of the same L2 block must be same"
372:             );
373:             require(_maxVirtualBlocksToCreate == 0, "Can not create virtual blocks in the middle of the miniblock");

385:             require(_expectedPrevL2BlockHash == pendingL2BlockHash, "The current L2 block hash is incorrect"); 
386:             require(
387:                 _l2BlockTimestamp > currentL2BlockTimestamp,
388:                 "The timestamp of the new L2 block must be greater than the timestamp of the previous L2 block"
389:             );

394:             revert("Invalid new L2 block number"); 

413:         require(currentBatchNumber > 0, "The current batch number must be greater than 0"); 

429:         require( 
430:             _newTimestamp > currentBlockTimestamp,
431:             "The timestamp of the batch must be greater than the timestamp of the previous block"
432:         );

451:         require(_newTimestamp > previousBatchTimestamp, "Timestamps should be incremental"); 
452:         require(previousBatchNumber + 1 == _expectedNewNumber, "The provided block number is not correct");
```
[242](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L242), [245](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L245), [249](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L249), [287](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L287), [351](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L351-L355), [367](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L367-L373), [385](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L385-L389), [394](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L394), [413](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L413), [429](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L429-L432), [451](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L451-L452)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContract.sol

21:         require( 
22:             SystemContractHelper.isSystemCall() || SystemContractHelper.isSystemContract(msg.sender),
23:             "This method require system call flag"
24:         );

31:         require( 
32:             SystemContractHelper.isSystemContract(msg.sender),
33:             "This method require the caller to be system contract"
34:         );

41:         require(msg.sender == caller, "Inappropriate caller"); 

48:         require(msg.sender == BOOTLOADER_FORMAL_ADDRESS, "Callable only by the bootloader"); 
```
[21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L21-L24), [31](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L31-L34), [41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L41), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L48)

```solidity
üìÅ File: system-contracts/contracts/libraries/EfficientCall.sol

38:         require(returnData.length == 32, "keccak256 returned invalid data"); 

47:         require(returnData.length == 32, "sha returned invalid data"); 
```
[38](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L38), [47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L47)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractHelper.sol

319:         require(index < 10, "There are only 10 accessible registers"); 

350:         require(precompileCallSuccess, "Failed to charge gas"); 
```
[319](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L319), [350](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L350)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

112:             revert("Encoding unsupported tx"); 

363:         require(_transaction.paymasterInput.length >= 4, "The standard paymaster input must be at least 4 bytes long"); 

367:             require( 
368:                 _transaction.paymasterInput.length >= 68,
369:                 "The approvalBased paymaster input must be at least 68 bytes long"
370:             );

388:             revert("Unsupported paymaster flow"); 
```
[112](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L112), [363](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L363), [367](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L367-L370), [388](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L388)

```solidity
üìÅ File: system-contracts/contracts/libraries/Utils.sol

21:         require(_x <= type(uint128).max, "Overflow"); 

27:         require(_x <= type(uint32).max, "Overflow"); 

33:         require(_x <= type(uint24).max, "Overflow"); 

84:         require(_bytecode.length % 32 == 0, "po"); 

87:         require(lengthInWords < 2 ** 16, "pp"); // bytecode length must be less than 2^16 words 
88:         require(lengthInWords % 2 == 1, "pr"); // bytecode length in words must be odd
```
[21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L21), [27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L27), [33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L33), [84](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L84), [87](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L87-L88)

</details>


---
### [GAS&#x2011;95] Use `if` statements instead of ternary operators
https://gist.github.com/notbozho/0d9f4dbc0026f8e7771a4fa39244f57e

<details>
<summary><i>There are 14 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

468:             address l2Sender = baseTokenWithdrawal ? L2_BASE_TOKEN_SYSTEM_CONTRACT_ADDR : l2BridgeAddress[_chainId]; 

579:                 refundRecipient = _prevMsgSender != tx.origin 
580:                     ? AddressAliasHelper.applyL1ToL2Alias(_prevMsgSender)
581:                     : _prevMsgSender;
```
[468](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L468), [579](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L579-L581)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

328:             _recipient = msg.sender == tx.origin ? msg.sender : AddressAliasHelper.applyL1ToL2Alias(msg.sender); 
```
[328](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L328)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

291:             bytes32 expectedUpgradeTxHash = i == 0 ? _systemContractUpgradeTxHash : bytes32(0); 
```
[291](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L291)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

275:         address refundRecipient = _params.refundRecipient == address(0) ? _params.sender : _params.refundRecipient; 
```
[275](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L275)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol

30:             currentHash = (_index % 2 == 0) 
31:                 ? _efficientHash(currentHash, _path[i])
32:                 : _efficientHash(_path[i], currentHash);
```
[30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L30-L32)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

146:             uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET; 

177:             uint8 len = operation == 0 ? 32 : metadata >> LENGTH_BITS_OFFSET; 
```
[146](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L146), [177](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L177)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

94:         bytes32 txHash = _suggestedSignedHash != bytes32(0) ? _suggestedSignedHash : _transaction.encodeHash(); 
```
[94](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L94)

```solidity
üìÅ File: system-contracts/contracts/GasBoundCaller.sol

49:         uint256 pubdataAllowance = _maxTotalGas > expectedForCompute ? _maxTotalGas - expectedForCompute : 0; 

63:         uint256 pubdataSpent = pubdataPublishedAfter > pubdataPublishedBefore 
64:             ? pubdataPublishedAfter - pubdataPublishedBefore
65:             : 0;
```
[49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L49), [63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L63-L65)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

53:         uint256 userGas = gasInContext > MSG_VALUE_SIMULATOR_STIPEND_GAS 
54:             ? gasInContext - MSG_VALUE_SIMULATOR_STIPEND_GAS
55:             : 0;
```
[53](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L53-L55)

```solidity
üìÅ File: system-contracts/contracts/libraries/EfficientCall.sol

146:             uint256 forwardMask = _isSystem ? MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT : 0; 
```
[146](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L146)

```solidity
üìÅ File: system-contracts/contracts/libraries/RLPEncoder.sol

29:                 encoded[0] = (_val == 0) ? bytes1(uint8(128)) : bytes1(uint8(_val)); 
```
[29](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L29)

</details>


---
### [GAS&#x2011;96] Use immutable when you have storage variable that is not going to change
<details>
<summary><i>There are 7 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

36:     address public l2Bridge; 

39:     address public l2TokenBeacon; 

42:     bytes32 public l2TokenProxyBytecodeHash; 
```
[36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L36), [39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L39), [42](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L42)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

37:     address private l1LegacyBridge; 
```
[37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L37)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

26:     uint256 public chainId; 

30:     address public origin; 

34:     uint256 public gasPrice; 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L26), [30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L30), [34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L34)

</details>


---
### [GAS&#x2011;97] Use local variables for emitting
Emitted values should not be read from storage again. Instead, the existing values from memory should be used.


Gas saved per Instance: ~100 *(Total: ~1,200)*
<details>
<summary><i>There are 12 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

/// @audit pendingAdmin
69:         emit NewAdmin(previousAdmin, pendingAdmin); 
```
[69](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L69)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

/// @audit minDelay
250:         emit ChangeMinDelay(minDelay, _newDelay); 

/// @audit securityCouncil
257:         emit ChangeSecurityCouncil(securityCouncil, _newSecurityCouncil); 
```
[250](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L250), [257](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L257)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

/// @audit pendingAdmin
128:         emit NewAdmin(previousAdmin, pendingAdmin); 

/// @audit protocolVersion
227:         emit SetChainIdUpgrade(_chainContract, l2ProtocolUpgradeTx, protocolVersion); 
```
[128](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L128), [227](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L227)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

/// @audit s
436:         emit BlocksVerification(s.totalBatchesVerified, currentTotalBatchesVerified); 

/// @audit s
/// @audit s
/// @audit s
496:         emit BlocksRevert(s.totalBatchesCommitted, s.totalBatchesVerified, s.totalBatchesExecuted); 
```
[436](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L436), [496](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L496)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

/// @audit decimals_
101:         emit BridgeInitialize(_l1Address, decodedName, decodedSymbol, decimals_); 

/// @audit l1Address
/// @audit decimals_
126:         emit BridgeInitialize(l1Address, _newName, _newSymbol, decimals_); 
```
[101](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L101), [126](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L126)

</details>


---
### [GAS&#x2011;98] Use of `emit` inside a loop
Emitting an event inside a loop performs a LOG op N times, where N is the loop length. Consider refactoring the code to emit the event only once at the end of loop. **Gas savings should be multiplied by the average loop length.**


Gas saved per Instance: ~375 *(Total: ~1,500)*
<details>
<summary><i>There are 4 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

261:             emit BlockCommit( 
262:                 _lastCommittedBatchData.batchNumber,
263:                 _lastCommittedBatchData.batchHash,
264:                 _lastCommittedBatchData.commitment
265:             );

299:             emit BlockCommit( 
300:                 _lastCommittedBatchData.batchNumber,
301:                 _lastCommittedBatchData.batchHash,
302:                 _lastCommittedBatchData.commitment
303:             );

353:             emit BlockExecution(_batchesData[i].batchNumber, _batchesData[i].batchHash, _batchesData[i].commitment); 
```
[261](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L261-L265), [299](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L299-L303), [353](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L353)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

/// @audit '_markBytecodeAsPublished' emits events (MarkedAsKnown)
31:                 _markBytecodeAsPublished(_hashes[i], _shouldSendToL1); 
```
[31](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L31)

</details>


---
### [GAS&#x2011;99] Use `revert()` to gain maximum gas savings
If you dont need Error messages, or you want gain maximum gas savings - `revert()` is the cheapest way to revert a transaction in terms of gas.

```solidity
	revert(); // 117 gas
	require(false); // 132 gas
	revert CustomError(); // 157 gas
	assert(false); // 164 gas
	revert("Custom Error"); // 406 gas
	require(false, "Custom Error"); // 421 gas
```
The gas savings are calculated based on the average gas cost of the total instances of these functions in the contract, minus the gas cost of `revert()` which is 117 gas.


Gas saved per Instance: ~290.136 *(Total: ~100,387)*
<details>
<summary><i>There are 346 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

64:         require(msg.sender == address(sharedBridge), "Not shared bridge"); 

66:         require(amount == _amount, "Incorrect amount"); 

141:         require(_amount != 0, "0T"); // empty deposit 

143:         require(amount == _amount, "3T"); // The token has non-standard transfer logic 

186:         require(amount != 0, "2T"); // empty deposit 

215:         require(!isWithdrawalFinalized[_l2BatchNumber][_l2MessageIndex], "pw"); 
```
[64](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L64), [66](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L66), [141](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L141), [143](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L143), [186](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L186), [215](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L215)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

69:         require(msg.sender == address(bridgehub), "ShB not BH"); 

75:         require( 
76:             msg.sender == address(bridgehub) || (_chainId == ERA_CHAIN_ID && msg.sender == ERA_DIAMOND_PROXY),
77:             "L1SharedBridge: not bridgehub or era chain"
78:         );

84:         require(msg.sender == address(legacyBridge), "ShB not legacy bridge"); 

108:         require(_owner != address(0), "ShB owner 0"); 

121:             require(balanceAfter > balanceBefore, "ShB: 0 eth transferred"); 

129:             require(amount > 0, "ShB: 0 amount to transfer"); 

132:             require(balanceAfter - balanceBefore == amount, "ShB: wrong amount transferred"); 

138:         require(bridgehub.getStateTransition(_chainId) == msg.sender, "receiveEth not state transition"); 

155:             require(msg.value == _amount, "L1SharedBridge: msg.value not equal to amount"); 

158:             require(msg.value == 0, "ShB m.v > 0 b d.it"); 

161:             require(amount == _amount, "3T"); // The token has non-standard transfer logic 

188:         require(l2BridgeAddress[_chainId] != address(0), "ShB l2 bridge not deployed"); 

194:         require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported"); 
195:         require(bridgehub.baseToken(_chainId) != _l1Token, "ShB: baseToken deposit not supported");

200:             require(_depositAmount == 0, "ShB wrong withdraw amount"); 

202:             require(msg.value == 0, "ShB m.v > 0 for BH d.it 2"); 

206:             require(withdrawAmount == _depositAmount, "5T"); // The token has non-standard transfer logic 

208:         require(amount != 0, "6T"); // empty deposit amount 

237:         require(depositHappened[_chainId][_txHash] == 0x00, "ShB tx hap"); 

325:             require(proofValid, "yn"); 

327:         require(_amount > 0, "y1"); 

342:                 require(dataHash == txDataHash, "ShB: d.it not hap"); 

349:             require(chainBalance[_chainId][_l1Token] >= _amount, "ShB n funds"); 

360:             require(callSuccess, "ShB: claimFailedDeposit failed"); 

396:             require(!legacyBridge.isWithdrawalFinalized(_l2BatchNumber, _l2MessageIndex), "ShB: legacy withdrawal"); 

417:         require(!isWithdrawalFinalized[_chainId][_l2BatchNumber][_l2MessageIndex], "Withdrawal is already finalized"); 

427:             require(!alreadyFinalized, "Withdrawal is already finalized 2"); 

439:             require(chainBalance[_chainId][l1Token] >= amount, "ShB not enough funds 2"); // not enought funds 

449:             require(callSuccess, "ShB: withdraw failed"); 

484:         require(success, "ShB withd w proof"); // withdrawal wrong proof 

501:         require(_l2ToL1message.length >= 56, "ShB wrong msg len"); // wrong messsage length 

517:             require(_l2ToL1message.length == 76, "ShB wrong msg len 2"); 

522:             revert("ShB Incorrect message function selector"); 

563:         require(l2BridgeAddress[ERA_CHAIN_ID] != address(0), "ShB b. n dep"); 
564:         require(_l1Token != l1WethAddress, "ShB: WETH deposit not supported 2");
```
[69](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L69), [75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L75-L78), [84](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L84), [108](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L108), [121](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L121), [129](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L129), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L132), [138](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L138), [155](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L155), [158](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L158), [161](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L161), [188](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L188), [194](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L194-L195), [200](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L200), [202](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L202), [206](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L206), [208](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L208), [237](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L237), [325](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L325), [327](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L327), [342](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L342), [349](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L349), [360](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L360), [396](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L396), [417](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L417), [427](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L427), [439](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L439), [449](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L449), [484](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L484), [501](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L501), [517](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L517), [522](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L522), [563](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L563-L564)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

46:         require(msg.sender == admin || msg.sender == owner(), "Bridgehub: not owner or admin"); 

62:         require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights 

83:         require( 
84:             !stateTransitionManagerIsRegistered[_stateTransitionManager],
85:             "Bridgehub: state transition already registered"
86:         );

93:         require( 
94:             stateTransitionManagerIsRegistered[_stateTransitionManager],
95:             "Bridgehub: state transition not registered yet"
96:         );

102:         require(!tokenIsRegistered[_token], "Bridgehub: token already registered"); 

122:         require(_chainId != 0, "Bridgehub: chainId cannot be 0"); 
123:         require(_chainId <= type(uint48).max, "Bridgehub: chainId too large");

125:         require( 
126:             stateTransitionManagerIsRegistered[_stateTransitionManager],
127:             "Bridgehub: state transition not registered"
128:         );
129:         require(tokenIsRegistered[_baseToken], "Bridgehub: token not registered");
130:         require(address(sharedBridge) != address(0), "Bridgehub: weth bridge not set");

132:         require(stateTransitionManager[_chainId] == address(0), "Bridgehub: chainId already registered"); 

223:                 require(msg.value == _request.mintValue, "Bridgehub: msg.value mismatch 1"); 

225:                 require(msg.value == 0, "Bridgehub: non-eth bridge with msg.value"); 

269:                 require( 
270:                     msg.value == _request.mintValue + _request.secondBridgeValue,
271:                     "Bridgehub: msg.value mismatch 2"
272:                 );

275:                 require(msg.value == _request.secondBridgeValue, "Bridgehub: msg.value mismatch 3"); 

296:         require(outputRequest.magicValue == TWO_BRIDGES_MAGIC_VALUE, "Bridgehub: magic value mismatch"); 

300:         require( 
301:             _request.secondBridgeAddress > BRIDGEHUB_MIN_SECOND_BRIDGE_ADDRESS,
302:             "Bridgehub: second bridge address too low"
303:         ); // to avoid calls to precompiles
```
[46](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L46), [62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L62), [83](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L83-L86), [93](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L93-L96), [102](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L102), [122](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L122-L123), [125](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L125-L130), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L132), [223](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L223), [225](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L225), [269](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L269-L272), [275](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L275), [296](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L296), [300](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L300-L303)

```solidity
üìÅ File: contracts/ethereum/contracts/common/ReentrancyGuard.sol

58:         require(lockSlotOldValue == 0, "1B"); 

75:         require(_status == _NOT_ENTERED, "r1"); 
```
[58](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L58), [75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/ReentrancyGuard.sol#L75)

```solidity
üìÅ File: contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol

23:         require(_bytecode.length % 32 == 0, "pq"); 

26:         require(bytecodeLenInWords < 2 ** 16, "pp"); // bytecode length must be less than 2^16 words 
27:         require(bytecodeLenInWords % 2 == 1, "ps"); // bytecode length in words must be odd

41:         require(version == 1 && _bytecodeHash[1] == bytes1(0), "zf"); // Incorrectly formatted bytecodeHash 

43:         require(bytecodeLen(_bytecodeHash) % 2 == 1, "uy"); // Code length in words must be odd 
```
[23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L23), [26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L26-L27), [41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L41), [43](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/libraries/L2ContractHelper.sol#L43)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

42:         require(_admin != address(0), "Admin should be non zero address"); 

59:         require(msg.sender == address(this), "Only governance contract itself is allowed to call this function"); 

65:         require(msg.sender == securityCouncil, "Only security council is allowed to call this function"); 

71:         require( 
72:             msg.sender == owner() || msg.sender == securityCouncil,
73:             "Only the owner and security council are allowed to call this function"
74:         );

155:         require(isOperationPending(_id), "Operation must be pending"); 

172:         require(isOperationReady(id), "Operation must be ready before execution"); 

177:         require(isOperationReady(id), "Operation must be ready after execution"); 

191:         require(isOperationPending(id), "Operation must be pending before execution"); 

196:         require(isOperationPending(id), "Operation must be pending after execution"); 

216:         require(!isOperation(_id), "Operation with this proposal id already exists"); 
217:         require(_delay >= minDelay, "Proposed delay is less than minimum delay");

240:         require(_predecessorId == bytes32(0) || isOperationDone(_predecessorId), "Predecessor operation not completed"); 
```
[42](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L42), [59](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L59), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L65), [71](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L71-L74), [155](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L155), [172](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L172), [177](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L177), [191](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L191), [196](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L196), [216](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L216-L217), [240](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L240)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

64:         require(msg.sender == bridgehub, "StateTransition: only bridgehub"); 

70:         require(msg.sender == admin || msg.sender == owner(), "Bridgehub: not owner or admin"); 

82:         require(_initializeData.governor != address(0), "StateTransition: governor zero"); 

106:         assert(L2_TO_L1_LOG_SERIALIZE_SIZE != 2 * 32); 

121:         require(msg.sender == currentPendingAdmin, "n42"); // Only proposed by current admin address can claim the admin rights 

256:         require(cutHashInput == initialCutHash, "StateTransition: initial cutHash mismatch"); 
```
[64](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L64), [70](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L70), [82](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L82), [106](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L106), [121](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L121), [256](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L256)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

62:         require(msg.sender == stateTransitionManager.getChainAdmin(_chainId), "ValidatorTimelock: only chain admin"); 

68:         require(validators[_chainId][msg.sender] == true, "ValidatorTimelock: only validator"); 

80:             revert AddressAlreadyValidator(_chainId); 

89:             revert ValidatorDoesNotExist(_chainId); 

195:                 require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed 

217:                 require(block.timestamp >= commitBatchTimestamp + delay, "5c"); // The delay is not passed 
```
[62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L62), [68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L68), [80](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L80), [89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L89), [195](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L195), [217](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L217)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol

25:         require(address(_initializeData.verifier) != address(0), "vt"); 
26:         require(_initializeData.admin != address(0), "vy");
27:         require(_initializeData.validatorTimelock != address(0), "hc");
28:         require(_initializeData.priorityTxMaxGasLimit <= MAX_GAS_PER_TRANSACTION, "vu");

51:         assert(L2_TO_L1_LOG_SERIALIZE_SIZE != 2 * 32); 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L25-L28), [51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L51)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol

14:         require(_chainId == block.chainid, "pr"); 

25:         require(msg.data.length >= 4 || msg.data.length == 0, "Ut"); 

30:         require(facetAddress != address(0), "F"); // Proxy has no facet for this selector 
31:         require(!diamondStorage.isFrozen || !facet.isFreezable, "q1"); // Facet is frozen
```
[14](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L14), [25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L25), [30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L30-L31)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

34:         require(msg.sender == pendingAdmin, "n4"); // Only proposed by current admin address can claim the admin rights 

59:         require(_newPriorityTxMaxGasLimit <= MAX_GAS_PER_TRANSACTION, "n5"); 

70:         require(_newFeeParams.maxPubdataPerBatch >= _newFeeParams.priorityTxMaxPubdata, "n6"); 

90:         require(s.totalBatchesCommitted == 0, "AdminFacet: set validium only after genesis"); // Validium mode can be set only before the first batch is committed 

105:         require( 
106:             cutHashInput == IStateTransitionManager(s.stateTransitionManager).upgradeCutHash(_oldProtocolVersion),
107:             "StateTransition: cutHash mismatch"
108:         );

110:         require( 
111:             s.protocolVersion == _oldProtocolVersion,
112:             "StateTransition: protocolVersion mismatch in STC when upgrading"
113:         );

116:         require( 
117:             s.protocolVersion > _oldProtocolVersion,
118:             "StateTransition: protocolVersion mismatch in STC after upgrading"
119:         );

136:         require(!diamondStorage.isFrozen, "a9"); // diamond proxy is frozen already 

146:         require(diamondStorage.isFrozen, "a7"); // diamond proxy is not frozen 
```
[34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L34), [59](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L59), [70](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L70), [90](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L90), [105](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L105-L108), [110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L110-L113), [116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L116-L119), [136](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L136), [146](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L146)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

37:         require(_newBatch.batchNumber == _previousBatch.batchNumber + 1, "f"); // only commit next batch 

40:         require(pubdataSource == uint8(PubdataSource.Calldata) || pubdataSource == uint8(PubdataSource.Blob), "us"); 

50:             require(logOutput.pubdataHash == 0x00, "v0h"); 
51:             require(_newBatch.pubdataCommitments.length == 1);

61:             require( 
62:                 logOutput.pubdataHash ==
63:                     keccak256(_newBatch.pubdataCommitments[1:_newBatch.pubdataCommitments.length - 32]),
64:                 "wp"
65:             );

74:         require(_previousBatch.batchHash == logOutput.previousBatchHash, "l"); 

76:         require(logOutput.chainedPriorityTxsHash == _newBatch.priorityOperationsHash, "t"); 

78:         require(logOutput.numberOfLayer1Txs == _newBatch.numberOfLayer1Txs, "ta"); 

110:         require(batchTimestamp == _expectedBatchTimestamp, "tb"); 

114:         require(_previousBatchTimestamp < batchTimestamp, "h3"); 

122:         require(block.timestamp - COMMIT_TIMESTAMP_NOT_OLDER <= batchTimestamp, "h1"); // New batch timestamp is too small 
123:         require(lastL2BlockTimestamp <= block.timestamp + COMMIT_TIMESTAMP_APPROXIMATION_DELTA, "h2"); // The last L2 block timestamp is too big

149:             require(!_checkBit(processedLogs, uint8(logKey)), "kp"); 

154:                 require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "lm"); 

157:                 require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "ln"); 

160:                 require(logSender == L2_TO_L1_MESSENGER_SYSTEM_CONTRACT_ADDR, "lb"); 

163:                 require(logSender == L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR, "sc"); 

166:                 require(logSender == L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR, "sv"); 

169:                 require(logSender == L2_BOOTLOADER_ADDRESS, "bl"); 

172:                 require(logSender == L2_BOOTLOADER_ADDRESS, "bk"); 

175:                 require(logSender == L2_PUBDATA_CHUNK_PUBLISHER_ADDR, "pc"); 

178:                 require(logSender == L2_PUBDATA_CHUNK_PUBLISHER_ADDR, "pd"); 

181:                 require(logSender == L2_BOOTLOADER_ADDRESS, "bu"); 
182:                 require(_expectedSystemContractUpgradeTxHash == logValue, "ut");

184:                 revert("ul"); 

192:             require(processedLogs == 511, "b7"); 

194:             require(processedLogs == 1023, "b8"); 

226:         require( 
227:             IStateTransitionManager(s.stateTransitionManager).protocolVersion() == s.protocolVersion,
228:             "Executor facet: wrong protocol version"
229:         );

231:         require(_newBatchesData.length == 1, "e4"); 

233:         require(s.storedBatchHashes[s.totalBatchesCommitted] == _hashStoredBatchInfo(_lastCommittedBatchData), "i"); // incorrect previous batch data 

284:         require(s.l2SystemContractsUpgradeBatchNumber == 0, "ik"); 

323:         require(currentBatchNumber == s.totalBatchesExecuted + _executedBatchIdx + 1, "k"); // Execute batches in order 
324:         require(
325:             _hashStoredBatchInfo(_storedBatch) == s.storedBatchHashes[currentBatchNumber],
326:             "exe10" // executing batch should be committed
327:         );

330:         require(priorityOperationsHash == _storedBatch.priorityOperationsHash, "x"); // priority operations hash does not match to expected 

358:         require(newTotalBatchesExecuted <= s.totalBatchesVerified, "n"); // Can't execute batches more than committed and proven currently. 

402:         require(_hashStoredBatchInfo(_prevBatch) == s.storedBatchHashes[currentTotalBatchesVerified], "t1"); 

407:             require( 
408:                 _hashStoredBatchInfo(_committedBatches[i]) == s.storedBatchHashes[currentTotalBatchesVerified],
409:                 "o1"
410:             );

421:         require(currentTotalBatchesVerified <= s.totalBatchesCommitted, "q"); 

426:         assert(block.chainid != 1); 

442:         require(proofPublicInput.length == 1, "t4"); 

449:         require(successVerifyProof, "p"); // Proof verification fail 

482:         require(s.totalBatchesCommitted > _newLastBatch, "v1"); // The last committed batch is less than new last batch 
483:         require(_newLastBatch >= s.totalBatchesExecuted, "v2"); // Already executed batches cannot be reverted

543:         require(_batch.systemLogs.length <= MAX_L2_TO_L1_LOGS_COMMITMENT_BYTES, "pu"); 

567:         require(_blobCommitments.length == MAX_NUMBER_OF_BLOBS, "b10"); 
568:         require(_blobHashes.length == MAX_NUMBER_OF_BLOBS, "b11");

616:         require(success, "failed to call point evaluation precompile"); 

618:         require(result == BLS_MODULUS, "precompile unexpected output"); 

631:         require(_pubdataCommitments.length > 0, "pl"); 
632:         require(_pubdataCommitments.length <= PUBDATA_COMMITMENT_SIZE * MAX_NUMBER_OF_BLOBS, "bd");
633:         require(_pubdataCommitments.length % PUBDATA_COMMITMENT_SIZE == 0, "bs");

639:             require(blobVersionedHash != bytes32(0), "vh"); 

663:         require(versionedHash == bytes32(0), "lh"); 

668:             require( 
669:                 (_blobHashes[i] == bytes32(0) && blobCommitments[i] == bytes32(0)) ||
670:                     (_blobHashes[i] != bytes32(0) && blobCommitments[i] != bytes32(0)),
671:                 "bh"
672:             );

681:         require(success, "vc"); 
```
[37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L37), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L40), [50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L50-L51), [61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L61-L65), [74](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L74), [76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L76), [78](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L78), [110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L110), [114](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L114), [122](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L122-L123), [149](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L149), [154](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L154), [157](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L157), [160](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L160), [163](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L163), [166](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L166), [169](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L169), [172](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L172), [175](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L175), [178](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L178), [181](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L181-L182), [184](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L184), [192](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L192), [194](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L194), [226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L226-L229), [231](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L231), [233](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L233), [284](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L284), [323](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L323-L327), [330](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L330), [358](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L358), [402](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L402), [407](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L407-L410), [421](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L421), [426](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L426), [442](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L442), [449](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L449), [482](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L482-L483), [543](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L543), [567](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L567-L568), [616](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L616), [618](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L618), [631](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L631-L633), [639](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L639), [663](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L663), [668](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L668-L672), [681](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L681)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

183:         require(ds.selectorToFacet[_selector].facetAddress != address(0), "g2"); 
```
[183](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L183)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

39:         require(s.chainId == ERA_CHAIN_ID, "transferEthToSharedBridge only available for Era on mailbox"); 

110:         require(_batchNumber <= s.totalBatchesExecuted, "xx"); 

117:         require(hashedLog != L2_L1_LOGS_TREE_DEFAULT_LEAF_HASH, "tw"); 

158:         require(s.baseTokenGasPriceMultiplierDenominator > 0, "Mailbox: baseTokenGasPriceDenominator not set"); 

185:         require(s.chainId == ERA_CHAIN_ID, "finalizeEthWithdrawal only available for Era on mailbox"); 

206:         require(s.chainId == ERA_CHAIN_ID, "legacy interface only available for era token"); 

243:         require(_request.l2GasPerPubdataByteLimit == REQUIRED_L2_GAS_PRICE_PER_PUBDATA, "qp"); 

264:         require(_factoryDeps.length <= MAX_NEW_FACTORY_DEPS, "uj"); 

272:         require(_mintValue >= baseCost + _params.l2Value, "mv"); // The `msg.value` doesn't cover the transaction cost 
```
[39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L39), [110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L110), [117](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L117), [158](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L158), [185](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L185), [206](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L206), [243](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L243), [264](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L264), [272](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L272)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol

16:         require(msg.sender == s.admin, "StateTransition Chain: not admin"); 

22:         require(s.validators[msg.sender], "StateTransition Chain: not validator"); 

27:         require(msg.sender == s.stateTransitionManager, "StateTransition Chain: not state transition manager"); 

32:         require(msg.sender == s.bridgehub, "StateTransition Chain: not bridgehub"); 

37:         require( 
38:             msg.sender == s.admin || msg.sender == s.stateTransitionManager,
39:             "StateTransition Chain: Only by admin or state transition manager"
40:         );

45:         require( 
46:             s.validators[msg.sender] || msg.sender == s.stateTransitionManager,
47:             "StateTransition Chain: Only by validator or state transition manager"
48:         );

53:         require(msg.sender == s.baseTokenBridge, "Only shared bridge can call this function"); 
```
[16](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L16), [22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L22), [27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L27), [32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L32), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L37-L40), [45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L45-L48), [53](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/ZkSyncStateTransitionBase.sol#L53)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

107:             require(selectors.length > 0, "B"); // no functions for diamond cut 

116:                 revert("C"); // undefined diamond cut action 

132:         require(_facet.code.length > 0, "G"); 

141:             require(oldFacet.facetAddress == address(0), "J"); // facet for this selector already exists 

155:         require(_facet.code.length > 0, "K"); 

161:             require(oldFacet.facetAddress != address(0), "L"); // it is impossible to replace the facet with zero address 

175:         require(_facet == address(0), "a1"); // facet address must be zero 

181:             require(oldFacet.facetAddress != address(0), "a2"); // Can't delete a non-existent facet 

215:             require(_isSelectorFreezable == ds.selectorToFacet[selector0].isFreezable, "J1"); 

280:             require(_calldata.length == 0, "H"); // Non-empty calldata for zero address 

287:                     revert("I"); // delegatecall failed 

297:             require(data.length == 32, "lp"); 
298:             require(abi.decode(data, (bytes32)) == DIAMOND_INIT_SUCCESS_RETURN_VALUE, "lp1");
```
[107](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L107), [116](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L116), [132](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L132), [141](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L141), [155](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L155), [161](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L161), [175](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L175), [181](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L181), [215](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L215), [280](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L280), [287](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L287), [297](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L297-L298)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol

24:         require(pathLength > 0, "xc"); 
25:         require(pathLength < 256, "bt");
26:         require(_index < (1 << pathLength), "px");
```
[24](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L24-L26)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol

65:         require(!_queue.isEmpty(), "D"); // priority queue is empty 

73:         require(!_queue.isEmpty(), "s"); // priority queue is empty 
```
[65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L65), [73](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/PriorityQueue.sol#L73)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol

28:         require(l2GasForTxBody <= _priorityTxMaxGasLimit, "ui"); 

30:         require(l2GasForTxBody / _transaction.gasPerPubdataByteLimit <= _priorityTxMaxPubdata, "uk"); 

34:         require( 
35:             getMinimalPriorityTransactionGasLimit(
36:                 _encoded.length,
37:                 _transaction.factoryDeps.length,
38:                 _transaction.gasPerPubdataByteLimit
39:             ) <= l2GasForTxBody,
40:             "up"
41:         );

48:         require(_transaction.from <= type(uint16).max, "ua"); 
49:         require(_transaction.to <= type(uint160).max, "ub");
50:         require(_transaction.paymaster == 0, "uc");
51:         require(_transaction.value == 0, "ud");
52:         require(_transaction.maxFeePerGas == 0, "uq");
53:         require(_transaction.maxPriorityFeePerGas == 0, "ux");
54:         require(_transaction.reserved[0] == 0, "ue");
55:         require(_transaction.reserved[1] <= type(uint160).max, "uf");
56:         require(_transaction.reserved[2] == 0, "ug");
57:         require(_transaction.reserved[3] == 0, "uo");
58:         require(_transaction.signature.length == 0, "uh");
59:         require(_transaction.paymasterInput.length == 0, "ul1");
60:         require(_transaction.reservedDynamic.length == 0, "um");

115:         require(_totalGasLimit >= overhead, "my"); // provided gas limit doesn't cover transaction overhead 
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L28), [30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L30), [34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L34-L41), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L48-L60), [115](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/TransactionValidator.sol#L115)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

72:         require(block.timestamp >= _proposedUpgrade.upgradeTimestamp, "Upgrade is not ready yet"); 

190:         require(_l2ProtocolUpgradeTx.txType == SYSTEM_UPGRADE_L2_TX_TYPE, "L2 system upgrade tx type is wrong"); 

205:         require( 
206:             _l2ProtocolUpgradeTx.nonce == _newProtocolVersion,
207:             "The new protocol version should be included in the L2 system upgrade tx"
208:         );

223:         require(_factoryDeps.length == _expectedHashes.length, "Wrong number of factory deps"); 
224:         require(_factoryDeps.length <= MAX_NEW_FACTORY_DEPS, "Factory deps can be at most 32");

227:             require( 
228:                 L2ContractHelper.hashL2Bytecode(_factoryDeps[i]) == bytes32(_expectedHashes[i]),
229:                 "Wrong factory dep hash"
230:             );

238:         require( 
239:             _newProtocolVersion > previousProtocolVersion,
240:             "New protocol version is not greater than the current one"
241:         );
242:         require(
243:             _newProtocolVersion - previousProtocolVersion <= MAX_ALLOWED_PROTOCOL_VERSION_DELTA,
244:             "Too big protocol version difference"
245:         );

249:         require(s.l2SystemContractsUpgradeTxHash == bytes32(0), "Previous upgrade has not been finalized"); 
250:         require(
251:             s.l2SystemContractsUpgradeBatchNumber == 0,
252:             "The batch number of the previous upgrade has not been cleaned"
253:         );
```
[72](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L72), [190](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L190), [205](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L205-L208), [223](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L223-L224), [227](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L227-L230), [238](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L238-L245), [249](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L249-L253)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol

22:         require( 
23:             // Genesis Upgrade difference: Note this is the only thing change > to >=
24:             _newProtocolVersion >= previousProtocolVersion,
25:             "New protocol version is not greater than the current one"
26:         );
27:         require(
28:             _newProtocolVersion - previousProtocolVersion <= MAX_ALLOWED_PROTOCOL_VERSION_DELTA,
29:             "Too big protocol version difference"
30:         );

33:         require(s.l2SystemContractsUpgradeTxHash == bytes32(0), "Previous upgrade has not been finalized"); 
34:         require(
35:             s.l2SystemContractsUpgradeBatchNumber == 0,
36:             "The batch number of the previous upgrade has not been cleaned"
37:         );

52:         require(block.timestamp >= _proposedUpgrade.upgradeTimestamp, "Upgrade is not ready yet"); 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L22-L30), [33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L33-L37), [52](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L52)

```solidity
üìÅ File: contracts/zksync/contracts/SystemContractsCaller.sol

28:         require(_x <= type(uint32).max, "Overflow"); 
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L28)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

55:         require(_l1Bridge != address(0), "bf"); 
56:         require(_l2TokenProxyBytecodeHash != bytes32(0), "df");
57:         require(_aliasedOwner != address(0), "sf");
58:         require(_l2TokenProxyBytecodeHash != bytes32(0), "df");

68:             require(_l1LegecyBridge != address(0), "bf2"); 

87:         require( 
88:             AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1Bridge ||
89:                 AddressAliasHelper.undoL1ToL2Alias(msg.sender) == l1LegacyBridge,
90:             "mq"
91:         );
92:         require(msg.value == 0, "Value should be 0 for ERC20 bridge");

98:             require(deployedToken == expectedL2Token, "mt"); 

101:             require(currentL1Token == _l1Token, "gg"); // Double check that the expected value equal to real one 

124:         require(_amount > 0, "Amount cannot be zero"); 

129:         require(l1Token != address(0), "yh"); 

176:         require(success, "mk"); 
```
[55](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L55-L58), [68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L68), [87](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L87-L92), [98](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L98), [101](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L101), [124](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L124), [129](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L129), [176](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L176)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

51:         require(_l1Address != address(0), "in6"); // Should be non-zero address 

120:         require(msg.sender == UpgradeableBeacon(beaconAddress).owner(), "tt"); 

130:         require(msg.sender == l2Bridge, "xnt"); // Only L2 bridge can call this method 

137:         require(_version == _getInitializedVersion() + 1, "v"); 
```
[51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L51), [120](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L120), [130](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L130), [137](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L137)

```solidity
üìÅ File: system-contracts/contracts/AccountCodeStorage.sol

26:         require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract"); 

37:         require(Utils.isContractConstructing(_hash), "Code hash is not for a contract on constructor"); 

48:         require(Utils.isContractConstructed(_hash), "Code hash is not for a constructed contract"); 

57:         require(Utils.isContractConstructing(codeHash), "Code hash is not for a contract on constructor"); 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L26), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L37), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L48), [57](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/AccountCodeStorage.sol#L57)

```solidity
üìÅ File: system-contracts/contracts/BootloaderUtilities.sol

37:             revert("Unsupported tx type"); 

92:             require(vInt == 27 || vInt == 28, "Invalid v value"); 

191:             require(vInt == 27 || vInt == 28, "Invalid v value"); 

286:             require(vInt == 27 || vInt == 28, "Invalid v value"); 
```
[37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L37), [92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L92), [191](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L191), [286](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L286)

```solidity
üìÅ File: system-contracts/contracts/ComplexUpgrader.sol

22:         require(msg.sender == FORCE_DEPLOYER, "Can only be called by FORCE_DEPLOYER"); 

24:         require(_delegateTo.code.length > 0, "Delegatee is an EOA"); 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L22), [24](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ComplexUpgrader.sol#L24)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

51:             require( 
52:                 encodedData.length * 4 == _bytecode.length,
53:                 "Encoded data length should be 4 times shorter than the original bytecode"
54:             );

56:             require( 
57:                 dictionary.length / 8 <= encodedData.length / 2,
58:                 "Dictionary should have at most the same number of entries as the encoded data"
59:             );

63:                 require(indexOfEncodedChunk < dictionary.length, "Encoded chunk index is out of bounds"); 

68:                 require(encodedChunk == realChunk, "Encoded chunk does not match the original bytecode"); 

119:         require(_enumerationIndexSize <= MAX_ENUMERATION_INDEX_SIZE, "enumeration index size is too large"); 

140:             require(derivedKey == _compressedStateDiffs.readBytes32(stateDiffPtr), "iw: initial key mismatch"); 

156:         require(numInitialWritesProcessed == numberOfInitialWrites, "Incorrect number of initial storage diffs"); 

171:             require(enumIndex == compressedEnumIndex, "rw: enum key mismatch"); 

187:         require(stateDiffPtr == _compressedStateDiffs.length, "Extra data in _compressedStateDiffs"); 

230:                 require(convertedValue == _finalValue, "transform or no compression: compressed and final mismatch"); 

232:                 require( 
233:                     _initialValue + convertedValue == _finalValue,
234:                     "add: initial plus converted not equal to final"
235:                 );

237:                 require( 
238:                     _initialValue - convertedValue == _finalValue,
239:                     "sub: initial minus converted not equal to final"
240:                 );

242:                 revert("unsupported operation"); 
```
[51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L51-L54), [56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L56-L59), [63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L63), [68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L68), [119](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L119), [140](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L140), [156](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L156), [171](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L171), [187](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L187), [230](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L230), [232](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L232-L235), [237](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L237-L240), [242](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L242)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

29:         require(msg.sender == address(this), "Callable only by self"); 

77:         require( 
78:             _nonceOrdering == AccountNonceOrdering.Arbitrary &&
79:                 currentInfo.nonceOrdering == AccountNonceOrdering.Sequential,
80:             "It is only possible to change from sequential to arbitrary ordering"
81:         );

239:         require( 
240:             msg.sender == FORCE_DEPLOYER || msg.sender == address(COMPLEX_UPGRADER_CONTRACT),
241:             "Can only be called by FORCE_DEPLOYER or COMPLEX_UPGRADER_CONTRACT"
242:         );

251:         require(msg.value == sumOfValues, "`value` provided is not equal to the combined `value`s of deployments"); 

264:         require(_bytecodeHash != bytes32(0x0), "BytecodeHash cannot be zero"); 
265:         require(uint160(_newAddress) > MAX_SYSTEM_CONTRACT_ADDRESS, "Can not deploy contracts in kernel space");

268:         require( 
269:             ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT.getCodeHash(uint256(uint160(_newAddress))) == 0x0,
270:             "Code hash is non-zero"
271:         );

273:         require(NONCE_HOLDER_SYSTEM_CONTRACT.getRawNonce(_newAddress) == 0x00, "Account is occupied"); 

303:         require(knownCodeMarker > 0, "The code hash is not known"); 

350:             require(value == 0, "The value must be zero if we do not call the constructor"); 
```
[29](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L29), [77](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L77-L81), [239](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L239-L242), [251](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L251), [264](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L264-L265), [268](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L268-L271), [273](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L273), [303](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L303), [350](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L350)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

100:         require(totalRequiredBalance <= address(this).balance, "Not enough balance for fee + value"); 

160:         require(_signature.length == 65, "Signature length is incorrect"); 

173:         require(v == 27 || v == 28, "v is neither 27 nor 28"); 

184:         require(uint256(s) <= 0x7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5D576E7357A4501DDFE92F46681B20A0, "Invalid s"); 

202:         require(success, "Failed to pay the fee to the operator"); 

222:         assert(msg.sender != BOOTLOADER_FORMAL_ADDRESS); 
```
[100](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L100), [160](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L160), [173](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L173), [184](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L184), [202](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L202), [222](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L222)

```solidity
üìÅ File: system-contracts/contracts/GasBoundCaller.sol

46:         require(_maxTotalGas >= gasleft(), "Gas limit is too low"); 

76:             require(pubdataAllowance + gasleft() >= pubdataCost + CALL_RETURN_OVERHEAD, "Not enough gas for pubdata"); 
```
[46](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L46), [76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/GasBoundCaller.sol#L76)

```solidity
üìÅ File: system-contracts/contracts/ImmutableSimulator.sol

35:         require(msg.sender == address(DEPLOYER_SYSTEM_CONTRACT), "Callable only by the deployer system contract"); 
```
[35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ImmutableSimulator.sol#L35)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

20:         require(msg.sender == address(COMPRESSOR_CONTRACT), "Callable only by the compressor"); 

76:         require(version == 1 && _bytecodeHash[1] == bytes1(0), "Incorrectly formatted bytecodeHash"); 

78:         require(Utils.bytecodeLenInWords(_bytecodeHash) % 2 == 1, "Code length in words must be odd"); 
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L20), [76](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L76), [78](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L78)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

201:         require(numberOfL2ToL1Logs <= L2_TO_L1_LOGS_MERKLE_TREE_LEAVES, "Too many L2->L1 logs"); 

214:         require( 
215:             reconstructedChainedLogsHash == chainedLogsHash,
216:             "reconstructedChainedLogsHash is not equal to chainedLogsHash"
217:         );

245:         require( 
246:             reconstructedChainedMessagesHash == chainedMessagesHash,
247:             "reconstructedChainedMessagesHash is not equal to chainedMessagesHash"
248:         );

269:         require( 
270:             reconstructedChainedL1BytecodesRevealDataHash == chainedL1BytecodesRevealDataHash,
271:             "reconstructedChainedL1BytecodesRevealDataHash is not equal to chainedL1BytecodesRevealDataHash"
272:         );

279:         require( 
280:             uint256(uint8(bytes1(_totalL2ToL1PubdataAndStateDiffs[calldataPtr]))) ==
281:                 STATE_DIFF_COMPRESSION_VERSION_NUMBER,
282:             "state diff compression version mismatch"
283:         );

298:         require(calldataPtr <= MAX_ALLOWED_PUBDATA_PER_BATCH, "L1 Messenger pubdata is too long"); 

315:         require(calldataPtr == _totalL2ToL1PubdataAndStateDiffs.length, "Extra data in the totalL2ToL1Pubdata array"); 
```
[201](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L201), [214](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L214-L217), [245](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L245-L248), [269](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L269-L272), [279](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L279-L283), [298](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L298), [315](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L315)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

33:         require( 
34:             msg.sender == MSG_VALUE_SYSTEM_CONTRACT ||
35:                 msg.sender == address(DEPLOYER_SYSTEM_CONTRACT) ||
36:                 msg.sender == BOOTLOADER_FORMAL_ADDRESS,
37:             "Only system contracts with special access can call this method"
38:         );

41:         require(fromBalance >= _amount, "Transfer amount exceeds balance"); 
```
[33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L33-L38), [41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L41)

```solidity
üìÅ File: system-contracts/contracts/MsgValueSimulator.sol

60:         require(to != address(this), "MsgValueSimulator calls itself"); 
```
[60](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/MsgValueSimulator.sol#L60)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

66:         require(_value <= MAXIMAL_MIN_NONCE_INCREMENT, "The value for incrementing the nonce is too high"); 

85:         require(_value != 0, "Nonce value cannot be set to 0"); 

89:             require(isNonceUsed(msg.sender, _key - 1), "Previous nonce has not been used"); 

115:         require(oldMinNonce == _expectedNonce, "Incorrect nonce"); 

136:         require( 
137:             msg.sender == address(DEPLOYER_SYSTEM_CONTRACT),
138:             "Only the contract deployer can increment the deployment nonce"
139:         );

170:             revert("Reusing the same nonce twice"); 

172:             revert("The nonce was not set as used"); 
```
[66](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L66), [85](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L85), [89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L89), [115](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L115), [136](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L136-L139), [170](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L170), [172](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L172)

```solidity
üìÅ File: system-contracts/contracts/PubdataChunkPublisher.sol

22:         require(_pubdata.length <= BLOB_SIZE_BYTES * MAX_NUMBER_OF_BLOBS, "pubdata should fit in 2 blobs"); 
```
[22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L22)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

242:         require(_isFirstInBatch, "Upgrade transaction must be first"); 

245:         require(_l2BlockNumber > 0, "L2 block number is never expected to be zero"); 

249:             require(correctPrevBlockHash == _expectedPrevL2BlockHash, "The previous L2 block hash is incorrect"); 

287:             require(_maxVirtualBlocksToCreate > 0, "Can't initialize the first virtual block"); 

351:             require( 
352:                 _l2BlockTimestamp >= currentBatchTimestamp,
353:                 "The timestamp of the L2 block must be greater than or equal to the timestamp of the current batch"
354:             );
355:             require(_maxVirtualBlocksToCreate > 0, "There must be a virtual block created at the start of the batch");

367:             require(!_isFirstInBatch, "Can not reuse L2 block number from the previous batch"); 
368:             require(currentL2BlockTimestamp == _l2BlockTimestamp, "The timestamp of the same L2 block must be same");
369:             require(
370:                 _expectedPrevL2BlockHash == _getLatest257L2blockHash(_l2BlockNumber - 1),
371:                 "The previous hash of the same L2 block must be same"
372:             );
373:             require(_maxVirtualBlocksToCreate == 0, "Can not create virtual blocks in the middle of the miniblock");

385:             require(_expectedPrevL2BlockHash == pendingL2BlockHash, "The current L2 block hash is incorrect"); 
386:             require(
387:                 _l2BlockTimestamp > currentL2BlockTimestamp,
388:                 "The timestamp of the new L2 block must be greater than the timestamp of the previous L2 block"
389:             );

394:             revert("Invalid new L2 block number"); 

413:         require(currentBatchNumber > 0, "The current batch number must be greater than 0"); 

429:         require( 
430:             _newTimestamp > currentBlockTimestamp,
431:             "The timestamp of the batch must be greater than the timestamp of the previous block"
432:         );

451:         require(_newTimestamp > previousBatchTimestamp, "Timestamps should be incremental"); 
452:         require(previousBatchNumber + 1 == _expectedNewNumber, "The provided block number is not correct");
```
[242](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L242), [245](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L245), [249](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L249), [287](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L287), [351](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L351-L355), [367](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L367-L373), [385](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L385-L389), [394](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L394), [413](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L413), [429](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L429-L432), [451](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L451-L452)

```solidity
üìÅ File: system-contracts/contracts/interfaces/ISystemContract.sol

21:         require( 
22:             SystemContractHelper.isSystemCall() || SystemContractHelper.isSystemContract(msg.sender),
23:             "This method require system call flag"
24:         );

31:         require( 
32:             SystemContractHelper.isSystemContract(msg.sender),
33:             "This method require the caller to be system contract"
34:         );

41:         require(msg.sender == caller, "Inappropriate caller"); 

48:         require(msg.sender == BOOTLOADER_FORMAL_ADDRESS, "Callable only by the bootloader"); 

55:         require(msg.sender == FORCE_DEPLOYER); 
```
[21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L21-L24), [31](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L31-L34), [41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L41), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L48), [55](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/ISystemContract.sol#L55)

```solidity
üìÅ File: system-contracts/contracts/libraries/EfficientCall.sol

38:         require(returnData.length == 32, "keccak256 returned invalid data"); 

47:         require(returnData.length == 32, "sha returned invalid data"); 
```
[38](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L38), [47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L47)

```solidity
üìÅ File: system-contracts/contracts/libraries/RLPEncoder.sol

50:         assert(_len != 1); 
```
[50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/RLPEncoder.sol#L50)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractHelper.sol

319:         require(index < 10, "There are only 10 accessible registers"); 

350:         require(precompileCallSuccess, "Failed to charge gas"); 
```
[319](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L319), [350](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L350)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

112:             revert("Encoding unsupported tx"); 

363:         require(_transaction.paymasterInput.length >= 4, "The standard paymaster input must be at least 4 bytes long"); 

367:             require( 
368:                 _transaction.paymasterInput.length >= 68,
369:                 "The approvalBased paymaster input must be at least 68 bytes long"
370:             );

388:             revert("Unsupported paymaster flow"); 
```
[112](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L112), [363](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L363), [367](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L367-L370), [388](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L388)

```solidity
üìÅ File: system-contracts/contracts/libraries/Utils.sol

21:         require(_x <= type(uint128).max, "Overflow"); 

27:         require(_x <= type(uint32).max, "Overflow"); 

33:         require(_x <= type(uint24).max, "Overflow"); 

84:         require(_bytecode.length % 32 == 0, "po"); 

87:         require(lengthInWords < 2 ** 16, "pp"); // bytecode length must be less than 2^16 words 
88:         require(lengthInWords % 2 == 1, "pr"); // bytecode length in words must be odd
```
[21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L21), [27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L27), [33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L33), [84](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L84), [87](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/Utils.sol#L87-L88)

</details>


---
### [GAS&#x2011;100] Use `s.x = s.x + y` instead of `s.x += y` for structs
Using the `s.x = s.x + y` instead of `s.x += y` for structs can save **100 gas**. The same applies to `-=`, `*=`, etc.


Gas saved per Instance: ~100 

<i>There is one instance of this issue:</i>

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

295:         virtualBlockInfo.number += _maxVirtualBlocksToCreate; 
```
[295](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L295)


---
### [GAS&#x2011;101] Use scratch space when building emitted events with two data arguments
We can use assembly to emit events efficiently by utilizing `scratch space` and the `free memory pointer`. This will allow us to potentially avoid memory expansion costs.
Note: In order to do this optimization safely, we will need to cache and restore the free memory pointer.

For example, for a generic `emit` event for `eventSentAmountExample`: 
```solidity
// uint256 id, uint256 value, uint256 amount
emit eventSentAmountExample(id, value, amount);
```



Gas saved per Instance: ~38 *(Total: ~1,786)*
<details>
<summary><i>There are 47 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

56:         emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin); 

68:         emit NewPendingAdmin(currentPendingAdmin, address(0)); 
69:         emit NewAdmin(previousAdmin, pendingAdmin);
```
[56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L56), [68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L68-L69)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

47:         emit ChangeSecurityCouncil(address(0), _securityCouncil); 

50:         emit ChangeMinDelay(0, _minDelay); 

144:         emit ShadowOperationScheduled(_id, _delay); 

157:         emit OperationCancelled(_id); 

180:         emit OperationExecuted(id); 

199:         emit OperationExecuted(id); 

250:         emit ChangeMinDelay(minDelay, _newDelay); 

257:         emit ChangeSecurityCouncil(securityCouncil, _newSecurityCouncil); 
```
[47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L47), [50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L50), [144](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L144), [157](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L157), [180](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L180), [199](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L199), [250](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L250), [257](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L257)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

115:         emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin); 

127:         emit NewPendingAdmin(currentPendingAdmin, address(0)); 
128:         emit NewAdmin(previousAdmin, pendingAdmin);

235:         emit StateTransitionNewChain(_chainId, _stateTransitionContract); 

287:         emit StateTransitionNewChain(_chainId, stateTransitionAddress); 
```
[115](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L115), [127](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L127-L128), [235](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L235), [287](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L287)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

83:         emit ValidatorAdded(_chainId, _newValidator); 

92:         emit ValidatorRemoved(_chainId, _validator); 

98:         emit NewExecutionDelay(_executionDelay); 
```
[83](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L83), [92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L92), [98](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L98)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

28:         emit NewPendingAdmin(oldPendingAdmin, _newPendingAdmin); 

40:         emit NewPendingAdmin(pendingAdmin, address(0)); 
41:         emit NewAdmin(previousAdmin, pendingAdmin);

47:         emit ValidatorStatusUpdate(_validator, _active); 

54:         emit IsPorterAvailableStatusUpdate(_zkPorterIsAvailable); 

63:         emit NewPriorityTxMaxGasLimit(oldPriorityTxMaxGasLimit, _newPriorityTxMaxGasLimit); 

75:         emit NewFeeParams(oldFeeParams, _newFeeParams); 

86:         emit NewBaseTokenMultiplier(oldNominator, oldDenominator, _nominator, _denominator); 

92:         emit ValidiumModeStatusUpdate(_validiumMode); 

115:         emit ExecuteUpgrade(_diamondCut); 

125:         emit ExecuteUpgrade(_diamondCut); 

139:         emit Freeze(); 

149:         emit Unfreeze(); 
```
[28](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L28), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L40-L41), [47](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L47), [54](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L54), [63](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L63), [75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L75), [86](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L86), [92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L92), [115](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L115), [125](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L125), [139](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L139), [149](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L149)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

436:         emit BlocksVerification(s.totalBatchesVerified, currentTotalBatchesVerified); 
```
[436](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L436)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

104:         emit NewL2DefaultAccountBytecodeHash(previousDefaultAccountBytecodeHash, _l2DefaultAccountBytecodeHash); 

121:         emit NewL2BootloaderBytecodeHash(previousBootloaderBytecodeHash, _l2BootloaderBytecodeHash); 

137:         emit NewVerifier(address(oldVerifier), address(_newVerifier)); 

157:         emit NewVerifierParams(oldVerifierParams, _newVerifierParams); 

256:         emit NewProtocolVersion(previousProtocolVersion, _newProtocolVersion); 
```
[104](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L104), [121](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L121), [137](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L137), [157](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L157), [256](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L256)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol

40:         emit NewProtocolVersion(previousProtocolVersion, _newProtocolVersion); 
```
[40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgradeGenesis.sol#L40)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

147:         emit BridgeMint(_to, _amount); 

156:         emit BridgeBurn(_from, _amount); 
```
[147](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L147), [156](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L156)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

68:         emit AccountVersionUpdated(msg.sender, _version); 

86:         emit AccountNonceOrderingUpdated(msg.sender, _nonceOrdering); 
```
[68](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L68), [86](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L86)

```solidity
üìÅ File: system-contracts/contracts/KnownCodesStorage.sol

59:             emit MarkedAsKnown(_bytecodeHash, _shouldSendToL1); 
```
[59](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/KnownCodesStorage.sol#L59)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

111:         emit L2ToL1LogSent(_l2ToL1Log); 

181:         emit BytecodeL1PublicationRequested(_bytecodeHash); 
```
[111](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L111), [181](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L181)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

67:         emit Mint(_account, _amount); 
```
[67](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L67)

</details>


---
### [GAS&#x2011;102] Use `selfbalance()` instead of `address(this).balance`
Use assembly when getting a contract's balance of ETH.

You can use `selfbalance()` instead of `address(this).balance` when getting your contract's balance of ETH to save gas.
Additionally, you can use `balance(address)` instead of `address().balance` when getting an external contract's balance of ETH.

*Saves 15 gas when checking internal balance, 6 for external*

<details>
<summary><i>There are 4 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

118:             uint256 balanceBefore = address(this).balance; 

120:             uint256 balanceAfter = address(this).balance; 
```
[118](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L118), [120](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L120)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

41:         uint256 amount = address(this).balance; 
```
[41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L41)

```solidity
üìÅ File: system-contracts/contracts/DefaultAccount.sol

100:         require(totalRequiredBalance <= address(this).balance, "Not enough balance for fee + value"); 
```
[100](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/DefaultAccount.sol#L100)

</details>


---
### [GAS&#x2011;103] Use shift right/left instead of division/multiplication if possible
`<x> * 2` is the same as `<x> << 1`. While the compiler uses the `SHL` opcode to accomplish both, the version that uses multiplication incurs an overhead of **20 gas** due to `JUMP`s to and from a compiler utility function that introduces checks which can be avoided by using `unchecked {}` around the division by two.


Gas saved per Instance: ~20 *(Total: ~240)*
<details>
<summary><i>There are 12 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

106:         assert(L2_TO_L1_LOG_SERIALIZE_SIZE != 2 * 32); 
```
[106](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L106)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol

51:         assert(L2_TO_L1_LOG_SERIALIZE_SIZE != 2 * 32); 
```
[51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondInit.sol#L51)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

578:         blobAuxOutputWords = new bytes32[](2 * TOTAL_BLOBS_IN_COMMITMENT); 

581:             blobAuxOutputWords[i * 2] = _blobHashes[i]; 
582:             blobAuxOutputWords[i * 2 + 1] = _blobCommitments[i];
```
[578](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L578), [581](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L581-L582)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Merkle.sol

33:             _index /= 2; 
```
[33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Merkle.sol#L33)

```solidity
üìÅ File: system-contracts/contracts/BootloaderUtilities.sol

97:                 vInt += 8 + block.chainid * 2; 
```
[97](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/BootloaderUtilities.sol#L97)

```solidity
üìÅ File: system-contracts/contracts/Compressor.sol

57:                 dictionary.length / 8 <= encodedData.length / 2, 
```
[57](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Compressor.sol#L57)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

89:         uint256 gasToPay = keccakGasCost(L2_TO_L1_LOG_SERIALIZE_SIZE) + 2 * keccakGasCost(64); 

223:             nodesOnCurrentLevel /= 2; 

226:                     abi.encode(l2ToL1LogsTreeArray[2 * i], l2ToL1LogsTreeArray[2 * i + 1]) 
```
[89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L89), [223](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L223), [226](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L226)

</details>


---
### [GAS&#x2011;104] Use the inputs/results of assignments rather than re-reading state variables
When a state variable is assigned, it saves gas to use the value being assigned, later in the function, rather than re-reading the state variable itself. If needed, it can also be stored to a local variable, and be used in that way. Both options avoid a Gwarmaccess (**100 gas**). Note that if the operation is, say `+=`, the assignment also results in a value which can be used. The instances below point to the first reference after the assignment, since later references are already covered by issues describing the caching of state variable values.


Gas saved per Instance: ~97 *(Total: ~485)*
<details>
<summary><i>There are 5 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

/// @audit use result of assignment of l2TokenBeacon, here
66:             l2TokenBeacon.transferOwnership(_aliasedOwner); 
```
[66](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L66)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

/// @audit use result of assignment of decimals_, here
101:         emit BridgeInitialize(_l1Address, decodedName, decodedSymbol, decimals_); 
```
[101](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L101)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

/// @audit use result of assignment of currentVirtualL2BlockInfo, here
275:         BlockInfo memory virtualBlockInfo = currentVirtualL2BlockInfo; 

/// @audit use result of assignment of currentVirtualL2BlockInfo, here
277:         if (currentVirtualL2BlockInfo.number == 0 && virtualBlockInfo.timestamp == 0) { 

/// @audit use result of assignment of currentVirtualL2BlockInfo, here
307:         currentVirtualL2BlockInfo = virtualBlockInfo; 
```
[275](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L275), [277](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L277), [307](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L307)

</details>


---
### [GAS&#x2011;105] Use `uint256(1)`/`uint256(2)` instead of `true`/`false` to save gas for changes
Use uint256(1) and uint256(2) for true/false to avoid a Gwarmaccess (100 gas), and to avoid Gsset (20000 gas) when changing from ‚Äòfalse‚Äô to ‚Äòtrue‚Äô, after having been ‚Äòtrue‚Äô in the past. Refer to the [source](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/5ae630684a0f57de400ef69499addab4c32ac8fb/contracts/security/ReentrancyGuard.sol#L23-L27).


Gas saved per Instance: ~17,100 *(Total: ~102,600)*
<details>
<summary><i>There are 6 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

27:     mapping(uint256 l2BatchNumber => mapping(uint256 l2ToL1MessageNumber => bool isFinalized)) 
28:         public isWithdrawalFinalized;
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L27-L28)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

57:     mapping(uint256 chainId => mapping(uint256 l2BatchNumber => mapping(uint256 l2ToL1MessageNumber => bool isFinalized))) 
58:         public isWithdrawalFinalized;

61:     mapping(uint256 chainId => bool enabled) internal hyperbridgingEnabled; 
```
[57](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L57-L58), [61](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L61)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

21:     mapping(address _stateTransitionManager => bool) public stateTransitionManagerIsRegistered; 

23:     mapping(address _token => bool) public tokenIsRegistered; 
```
[21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L21), [23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L23)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

50:     mapping(uint256 _chainId => mapping(address _validator => bool)) public validators; 
```
[50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L50)

</details>


---
### [GAS&#x2011;106] Use `unchecked` for divisions on constant or immutable values
Unsigned divisions on constant or immutable values do not result in overflow. Therefore, these operations can be marked as unchecked, optimizing gas usage without compromising safety.

For instance, if `a` is an unsigned integer and `b` is a constant or immutable, a / b can be safely rewritten as: unchecked { a / b }


Gas saved per Instance: ~60 *(Total: ~180)*
<details>
<summary><i>There are 3 instances of this issue:</i></summary>

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

51:         return KECCAK_ROUND_GAS_COST * (_length / KECCAK_ROUND_NUMBER_OF_BYTES + 1); 

62:         return SHA256_ROUND_GAS_COST * ((_length + 8) / SHA256_ROUND_NUMBER_OF_BYTES + 1); 
```
[51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L51), [62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L62)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

180:         deploymentNonce = _rawMinNonce / DEPLOY_NONCE_MULTIPLIER; 
```
[180](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L180)

</details>


---
### [GAS&#x2011;107] Using `bool`s for storage incurs overhead
Use uint256(1) and uint256(2) for true/false to avoid a Gwarmaccess (100 gas), and to avoid Gsset (20000 gas) when changing from ‚Äòfalse‚Äô to ‚Äòtrue‚Äô, after having been ‚Äòtrue‚Äô in the past. See [source](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27).


Gas saved per Instance: ~17,100 *(Total: ~376,200)*
<details>
<summary><i>There are 22 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/common/Messaging.sol

25:     bool isService; 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/Messaging.sol#L25)

```solidity
üìÅ File: contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol

19:         bool callConstructor; 
```
[19](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/interfaces/IL2ContractDeployer.sol#L19)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol

31:     bool approvedBySecurityCouncil; 

103:     bool zkPorterIsAvailable; 
```
[31](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol#L31), [103](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol#L103)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

33:         bool isFreezable; 

54:         bool isFrozen; 

65:         bool isFreezable; 
```
[33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L33), [54](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L54), [65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L65)

```solidity
üìÅ File: contracts/zksync/contracts/L2ContractHelper.sol

40:         bool callConstructor; 
```
[40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/L2ContractHelper.sol#L40)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

21:         bool ignoreName; 
22:         bool ignoreSymbol;
23:         bool ignoreDecimals;
```
[21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L21-L23)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

203:         bool callConstructor; 
```
[203](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L203)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IL1Messenger.sol

16:     bool isService; 
```
[16](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IL1Messenger.sol#L16)

</details>


---
### [GAS&#x2011;108] Using `constant`s directly, rather than caching the value, saves gas
<details>
<summary><i>There are 21 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

88:         bytes32 position = DIAMOND_STORAGE_POSITION; 
```
[88](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L88)

```solidity
üìÅ File: contracts/zksync/contracts/SystemContractsCaller.sol

65:             address msgValueSimulator = MSG_VALUE_SYSTEM_CONTRACT; 
```
[65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L65)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

221:         uint256 nodesOnCurrentLevel = L2_TO_L1_LOGS_MERKLE_TREE_LEAVES; 
```
[221](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L221)

```solidity
üìÅ File: system-contracts/contracts/libraries/EfficientCall.sol

142:             address msgValueSimulator = MSG_VALUE_SYSTEM_CONTRACT; 
```
[142](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/EfficientCall.sol#L142)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractHelper.sol

49:         address callAddr = TO_L1_CALL_ADDRESS; 

64:         address callAddr = CODE_ADDRESS_CALL_ADDRESS; 

75:         address callAddr = LOAD_CALLDATA_INTO_ACTIVE_PTR_CALL_ADDRESS; 

86:         address callAddr = PTR_PACK_INTO_ACTIVE_CALL_ADDRESS; 

95:         address callAddr = PTR_ADD_INTO_ACTIVE_CALL_ADDRESS; 

107:         address callAddr = PTR_SHRINK_INTO_ACTIVE_CALL_ADDRESS; 

153:         address callAddr = PRECOMPILE_CALL_ADDRESS; 

170:         address callAddr = SET_CONTEXT_VALUE_CALL_ADDRESS; 

182:         address callAddr = EVENT_INITIALIZE_ADDRESS; 

192:         address callAddr = EVENT_WRITE_ADDRESS; 

204:         address callAddr = META_CALL_ADDRESS; 

297:         address callAddr = CALLFLAGS_CALL_ADDRESS; 

308:         address callAddr = PTR_CALLDATA_CALL_ADDRESS; 

321:         address callAddr = GET_EXTRA_ABI_DATA_ADDRESS; 
```
[49](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L49), [64](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L64), [75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L75), [86](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L86), [95](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L95), [107](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L107), [153](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L153), [170](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L170), [182](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L182), [192](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L192), [204](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L204), [297](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L297), [308](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L308), [321](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L321)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractsCaller.sol

104:             address msgValueSimulator = MSG_VALUE_SYSTEM_CONTRACT; 

107:             uint256 forwardMask = MSG_VALUE_SIMULATOR_IS_SYSTEM_BIT; 
```
[104](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L104), [107](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L107)

```solidity
üìÅ File: system-contracts/contracts/libraries/TransactionHelper.sol

396:         address bootloaderAddr = BOOTLOADER_FORMAL_ADDRESS; 
```
[396](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/TransactionHelper.sol#L396)

</details>


---
### [GAS&#x2011;109] Using `constant`s instead of `enum` can save gas
`Enum` is expensive and it is [more efficient to use constants](https://www.codehawks.com/finding/clm84992q02j9w9ruebun36d9) instead. An illustrative example of this approach can be found in the [ReentrancyGuard.sol](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/181d518609a9f006fcb97af63e6952e603cf100e/contracts/utils/ReentrancyGuard.sol#L34-L35).

<details>
<summary><i>There are 15 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/common/Messaging.sol

8: enum TxStatus { 
9:     Failure,
10:     Success
11: }
```
[8](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/common/Messaging.sol#L8-L11)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/IGovernance.sol

14:     enum OperationState { 
15:         Unset,
16:         Waiting,
17:         Ready,
18:         Done
19:     }
```
[14](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/IGovernance.sol#L14-L19)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol

12: enum UpgradeState { 
13:     None,
14:     Transparent,
15:     Shadow
16: }

39: enum PubdataPricingMode { 
40:     Rollup,
41:     Validium
42: }
```
[12](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol#L12-L16), [39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/ZkSyncStateTransitionStorage.sol#L39-L42)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol

8: enum SystemLogKey { 
9:     L2_TO_L1_LOGS_TREE_ROOT_KEY,
10:     TOTAL_L2_TO_L1_PUBDATA_KEY,
11:     STATE_DIFF_HASH_KEY,
12:     PACKED_BATCH_AND_L2_BLOCK_TIMESTAMP_KEY,
13:     PREV_BATCH_HASH_KEY,
14:     CHAINED_PRIORITY_TXN_HASH_KEY,
15:     NUMBER_OF_LAYER_1_TXS_KEY,
16:     BLOB_ONE_HASH_KEY,
17:     BLOB_TWO_HASH_KEY,
18:     EXPECTED_SYSTEM_CONTRACT_UPGRADE_TX_HASH_KEY
19: }

22: enum PubdataSource { 
23:     Calldata,
24:     Blob
25: }
```
[8](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L8-L19), [22](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-interfaces/IExecutor.sol#L22-L25)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

80:     enum Action { 
81:         Add,
82:         Replace,
83:         Remove
84:     }
```
[80](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L80-L84)

```solidity
üìÅ File: contracts/zksync/contracts/SystemContractsCaller.sol

20: enum CalldataForwardingMode { 
21:     UseHeap,
22:     ForwardFatPointer,
23:     UseAuxHeap
24: }
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/SystemContractsCaller.sol#L20-L24)

```solidity
üìÅ File: contracts/zksync/contracts/interfaces/IPaymaster.sol

7: enum ExecutionResult { 
8:     Revert,
9:     Success
10: }
```
[7](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/interfaces/IPaymaster.sol#L7-L10)

```solidity
üìÅ File: system-contracts/contracts/Constants.sol

110: enum SystemLogKey { 
111:     L2_TO_L1_LOGS_TREE_ROOT_KEY,
112:     TOTAL_L2_TO_L1_PUBDATA_KEY,
113:     STATE_DIFF_HASH_KEY,
114:     PACKED_BATCH_AND_L2_BLOCK_TIMESTAMP_KEY,
115:     PREV_BATCH_HASH_KEY,
116:     CHAINED_PRIORITY_TXN_HASH_KEY,
117:     NUMBER_OF_LAYER_1_TXS_KEY,
118:     BLOB_ONE_HASH_KEY,
119:     BLOB_TWO_HASH_KEY,
120:     EXPECTED_SYSTEM_CONTRACT_UPGRADE_TX_HASH_KEY
121: }
```
[110](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/Constants.sol#L110-L121)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IContractDeployer.sol

11:     enum AccountAbstractionVersion { 
12:         None,
13:         Version1
14:     }

23:     enum AccountNonceOrdering { 
24:         Sequential,
25:         Arbitrary
26:     }
```
[11](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L11-L14), [23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IContractDeployer.sol#L23-L26)

```solidity
üìÅ File: system-contracts/contracts/interfaces/IPaymaster.sol

7: enum ExecutionResult { 
8:     Revert,
9:     Success
10: }
```
[7](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/interfaces/IPaymaster.sol#L7-L10)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractHelper.sol

24: enum Global { 
25:     CalldataPtr,
26:     CallFlags,
27:     ExtraABIData1,
28:     ExtraABIData2,
29:     ReturndataPtr
30: }
```
[24](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractHelper.sol#L24-L30)

```solidity
üìÅ File: system-contracts/contracts/libraries/SystemContractsCaller.sol

56: enum CalldataForwardingMode { 
57:     UseHeap,
58:     ForwardFatPointer,
59:     UseAuxHeap
60: }
```
[56](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/libraries/SystemContractsCaller.sol#L56-L60)

</details>


---
### [GAS&#x2011;110] Using globals directly is cheaper than assigning them to variables
Using the [global](https://docs.soliditylang.org/en/v0.8.14/cheatsheet.html#global-variables) directly saves **5 [gas](https://gist.github.com/IllIllI000/0a38d74d0af20412471a43f1e4fcf8be)**


Gas saved per Instance: ~5 

<i>There is one instance of this issue:</i>

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

329:         uint256 value = msg.value; 
```
[329](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L329)


---
### [GAS&#x2011;111] Using `private` rather than `public`, saves gas
For constants, the values can be read from the verified contract source code, or if there are multiple values there can be a single getter function that returns a tuple of the values of all currently-public constants. Saves 3406-3606 gas in deployment gas due to the compiler not having to create non-payable getter functions for deployment calldata, not having to store the bytes of the value outside of where it's used, and not adding another entry to the method ID table


Gas saved per Instance: ~3,606 *(Total: ~191,118)*
<details>
<summary><i>There are 53 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol

23:     IL1SharedBridge public immutable override sharedBridge; 

27:     mapping(uint256 l2BatchNumber => mapping(uint256 l2ToL1MessageNumber => bool isFinalized)) 
28:         public isWithdrawalFinalized;

32:     mapping(address account => mapping(address l1Token => mapping(bytes32 depositL2TxHash => uint256 amount))) 
33:         public depositAmount;

36:     address public l2Bridge; 

39:     address public l2TokenBeacon; 

42:     bytes32 public l2TokenProxyBytecodeHash; 
```
[23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L23), [27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L27-L28), [32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L32-L33), [36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L36), [39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L39), [42](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1ERC20Bridge.sol#L42)

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

34:     address public immutable override l1WethAddress; 

37:     IBridgehub public immutable override bridgehub; 

40:     IL1ERC20Bridge public immutable override legacyBridge; 

48:     mapping(uint256 chainId => address l2Bridge) public override l2BridgeAddress; 

52:     mapping(uint256 chainId => mapping(bytes32 l2DepositTxHash => bytes32 depositDataHash)) 
53:         public
54:         override depositHappened;

57:     mapping(uint256 chainId => mapping(uint256 l2BatchNumber => mapping(uint256 l2ToL1MessageNumber => bool isFinalized))) 
58:         public isWithdrawalFinalized;
```
[34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L34), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L37), [40](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L40), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L48), [52](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L52-L54), [57](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L57-L58)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

18:     IL1SharedBridge public sharedBridge; 

21:     mapping(address _stateTransitionManager => bool) public stateTransitionManagerIsRegistered; 

23:     mapping(address _token => bool) public tokenIsRegistered; 

26:     mapping(uint256 _chainId => address) public stateTransitionManager; 

29:     mapping(uint256 _chainId => address) public baseToken; 

32:     address public admin; 
```
[18](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L18), [21](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L21), [23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L23), [26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L26), [29](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L29), [32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L32)

```solidity
üìÅ File: contracts/ethereum/contracts/governance/Governance.sol

26:     address public securityCouncil; 

32:     mapping(bytes32 operationId => uint256 executionTimestamp) public timestamps; 

35:     uint256 public minDelay; 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L26), [32](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L32), [35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/governance/Governance.sol#L35)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

27:     address public immutable bridgehub; 

30:     mapping(uint256 => address) public stateTransition; 

33:     bytes32 public storedBatchZero; 

36:     bytes32 public initialCutHash; 

39:     address public genesisUpgrade; 

42:     uint256 public protocolVersion; 

45:     address public validatorTimelock; 

48:     mapping(uint256 => bytes32) public upgradeCutHash; 

51:     address public admin; 
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L27), [30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L30), [33](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L33), [36](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L36), [39](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L39), [42](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L42), [45](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L45), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L48), [51](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L51)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol

26:     string public constant override getName = "ValidatorTimelock"; 

44:     IStateTransitionManager public stateTransitionManager; 

50:     mapping(uint256 _chainId => mapping(address _validator => bool)) public validators; 

53:     uint32 public executionDelay; 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L26), [44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L44), [50](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L50), [53](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/ValidatorTimelock.sol#L53)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

20:     string public constant override getName = "AdminFacet"; 
```
[20](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L20)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

27:     string public constant override getName = "ExecutorFacet"; 
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L27)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

25:     string public constant override getName = "GettersFacet"; 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L25)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

35:     string public constant override getName = "MailboxFacet"; 
```
[35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L35)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2SharedBridge.sol

25:     address public override l1Bridge; 

29:     UpgradeableBeacon public l2TokenBeacon; 

35:     mapping(address l2TokenAddress => address l1TokenAddress) public override l1TokenAddress; 
```
[25](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L25), [29](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L29), [35](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2SharedBridge.sol#L35)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

34:     address public override l2Bridge; 

37:     address public override l1Address; 
```
[34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L34), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L37)

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

23:     uint256 public override totalSupply; 
```
[23](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L23)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

26:     uint256 public chainId; 

30:     address public origin; 

34:     uint256 public gasPrice; 

37:     uint256 public blockGasLimit = type(uint32).max; 

41:     address public coinbase = BOOTLOADER_FORMAL_ADDRESS; 

44:     uint256 public difficulty = 2.5e15; 

48:     uint256 public baseFee; 

89:     uint16 public txNumberInBlock; 

92:     uint256 public gasPerPubdataByte; 
```
[26](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L26), [30](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L30), [34](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L34), [37](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L37), [41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L41), [44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L44), [48](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L48), [89](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L89), [92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L92)

</details>


---
### [GAS&#x2011;112] Using `storage` instead of `memory` for structs/arrays saves gas
When fetching data from a storage location, assigning the data to a `memory` variable causes all fields of the struct/array to be read from storage, which incurs a Gcoldsload (**2100 gas**) for *each* field of the struct/array. If the fields are read from the new memory variable, they incur an additional `MLOAD` rather than a cheap stack read. Instead of declearing the variable with the `memory` keyword, declaring the variable with the `storage` keyword and caching any fields that need to be re-read in stack variables, will be much cheaper, only incuring the Gcoldsload for the fields actually read. The only time it makes sense to read the whole struct/array into a `memory` variable, is if the full struct/array is being returned by the function, is being passed to a function that requires `memory`, or if the array/struct is being read from another `memory` array/struct


Gas saved per Instance: ~2,100 *(Total: ~100,800)*
<details>
<summary><i>There are 48 instances of this issue:</i></summary>

```solidity
üìÅ File: contracts/ethereum/contracts/bridge/L1SharedBridge.sol

430:         MessageParams memory messageParams = MessageParams({ 
431:             l2BatchNumber: _l2BatchNumber,
432:             l2MessageIndex: _l2MessageIndex,
433:             l2TxNumberInBatch: _l2TxNumberInBatch
434:         });

465:         L2Message memory l2ToL1Message; 

584:             L2TransactionRequestDirect memory request = L2TransactionRequestDirect({ 
585:                 chainId: ERA_CHAIN_ID,
586:                 l2Contract: l2BridgeAddress[ERA_CHAIN_ID],
587:                 mintValue: msg.value, // l2 gas + l2 msg.Value the bridgehub will withdraw the mintValue from the base token bridge for gas
588:                 l2Value: 0, // L2 msg.value, this contract doesn't support base token deposits or wrapping functionality, for direct deposits use bridgehub
589:                 l2Calldata: l2TxCalldata,
590:                 l2GasLimit: _l2TxGasLimit,
591:                 l2GasPerPubdataByteLimit: _l2TxGasPerPubdataByte,
592:                 factoryDeps: new bytes[](0),
593:                 refundRecipient: refundRecipient
594:             });
```
[430](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L430-L434), [465](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L465), [584](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridge/L1SharedBridge.sol#L584-L594)

```solidity
üìÅ File: contracts/ethereum/contracts/bridgehub/Bridgehub.sol

288:         L2TransactionRequestTwoBridgesInner memory outputRequest = IL1SharedBridge(_request.secondBridgeAddress) 
289:             .bridgehubDeposit{value: _request.secondBridgeValue}(
290:             _request.chainId,
291:             msg.sender,
292:             _request.l2Value,
293:             _request.secondBridgeCalldata
294:         );
```
[288](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/bridgehub/Bridgehub.sol#L288-L294)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/StateTransitionManager.sol

90:         IExecutor.StoredBatchInfo memory batchZero = IExecutor.StoredBatchInfo( 
91:             0,
92:             _initializeData.genesisBatchHash,
93:             _initializeData.genesisIndexRepeatedStorageChanges,
94:             0,
95:             EMPTY_STRING_KECCAK,
96:             DEFAULT_L2_LOGS_TREE_ROOT_HASH,
97:             0,
98:             _initializeData.genesisBatchCommitment
99:         );

179:         uint256[] memory uintEmptyArray; 
180:         bytes[] memory bytesEmptyArray;

182:         L2CanonicalTransaction memory l2ProtocolUpgradeTx = L2CanonicalTransaction({ 
183:             txType: SYSTEM_UPGRADE_L2_TX_TYPE,
184:             from: uint256(uint160(L2_FORCE_DEPLOYER_ADDR)),
185:             to: uint256(uint160(L2_SYSTEM_CONTEXT_SYSTEM_CONTRACT_ADDR)),
186:             gasLimit: 5,
187:             gasPerPubdataByteLimit: REQUIRED_L2_GAS_PRICE_PER_PUBDATA,
188:             maxFeePerGas: uint256(0),
189:             maxPriorityFeePerGas: uint256(0),
190:             paymaster: uint256(0),
191:             // Note, that the priority operation id is used as "nonce" for L1->L2 transactions
192:             nonce: protocolVersion,
193:             value: 0,
194:             reserved: [uint256(0), 0, 0, 0],
195:             data: systemContextCalldata,
196:             signature: new bytes(0),
197:             factoryDeps: uintEmptyArray,
198:             paymasterInput: new bytes(0),
199:             reservedDynamic: new bytes(0)
200:         });

202:         ProposedUpgrade memory proposedUpgrade = ProposedUpgrade({ 
203:             l2ProtocolUpgradeTx: l2ProtocolUpgradeTx,
204:             factoryDeps: bytesEmptyArray,
205:             bootloaderHash: bytes32(0),
206:             defaultAccountHash: bytes32(0),
207:             verifier: address(0),
208:             verifierParams: VerifierParams({
209:                 recursionNodeLevelVkHash: bytes32(0),
210:                 recursionLeafLevelVkHash: bytes32(0),
211:                 recursionCircuitsSetVksHash: bytes32(0)
212:             }),
213:             l1ContractsUpgradeCalldata: new bytes(0),
214:             postUpgradeCalldata: new bytes(0),
215:             upgradeTimestamp: 0,
216:             newProtocolVersion: protocolVersion
217:         });

219:         Diamond.FacetCut[] memory emptyArray; 
220:         Diamond.DiamondCutData memory cutData = Diamond.DiamondCutData({
221:             facetCuts: emptyArray,
222:             initAddress: genesisUpgrade,
223:             initCalldata: abi.encodeCall(IDefaultUpgrade.upgrade, (proposedUpgrade))
224:         });

252:         Diamond.DiamondCutData memory diamondCut = abi.decode(_diamondCut, (Diamond.DiamondCutData)); 
```
[90](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L90-L99), [179](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L179-L180), [182](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L182-L200), [202](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L202-L217), [219](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L219-L224), [252](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/StateTransitionManager.sol#L252)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol

27:         Diamond.SelectorToFacet memory facet = diamondStorage.selectorToFacet[msg.sig]; 
```
[27](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/DiamondProxy.sol#L27)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol

72:         FeeParams memory oldFeeParams = s.feeParams; 
```
[72](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Admin.sol#L72)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol

44:         LogProcessingOutput memory logOutput = _processL2Logs(_newBatch, _expectedSystemContractUpgradeTxHash); 

46:         bytes32[] memory blobCommitments = new bytes32[](MAX_NUMBER_OF_BLOBS); 
47:         bytes32[] memory blobHashes = new bytes32[](MAX_NUMBER_OF_BLOBS);

312:             PriorityOperation memory priorityOp = s.priorityQueue.popFront(); 

396:         VerifierParams memory verifierParams = s.verifierParams; 

399:         uint256[] memory proofPublicInput = new uint256[](committedBatchesLength); 
```
[44](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L44), [46](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L46-L47), [312](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L312), [396](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L396), [399](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Executor.sol#L399)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol

210:             Diamond.FacetToSelectors memory facetToSelectors = ds.facetToSelectors[facetAddr]; 
```
[210](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Getters.sol#L210)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol

92:         L2Log memory l2Log = L2Log({ 
93:             l2ShardId: 0,
94:             isService: true,
95:             txNumberInBatch: _l2TxNumberInBatch,
96:             sender: L2_BOOTLOADER_ADDRESS,
97:             key: _l2TxHash,
98:             value: bytes32(uint256(_status))
99:         });

157:         FeeParams memory feeParams = s.feeParams; 

246:         WritePriorityOpParams memory params; 

321:         L2CanonicalTransaction memory transaction = _serializeL2Transaction(_priorityOpParams, _calldata, _factoryDeps); 
```
[92](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L92-L99), [157](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L157), [246](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L246), [321](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/chain-deps/facets/Mailbox.sol#L321)

```solidity
üìÅ File: contracts/ethereum/contracts/state-transition/libraries/Diamond.sol

97:         FacetCut[] memory facetCuts = _diamondCut.facetCuts; 

105:             bytes4[] memory selectors = facetCuts[i].selectors; 

140:             SelectorToFacet memory oldFacet = ds.selectorToFacet[selector]; 

160:             SelectorToFacet memory oldFacet = ds.selectorToFacet[selector]; 

180:             SelectorToFacet memory oldFacet = ds.selectorToFacet[selector]; 
```
[97](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L97), [105](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L105), [140](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L140), [160](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L160), [180](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/state-transition/libraries/Diamond.sol#L180)

```solidity
üìÅ File: contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol

155:         VerifierParams memory oldVerifierParams = s.verifierParams; 
```
[155](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/ethereum/contracts/upgrades/BaseZkSyncUpgrade.sol#L155)

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

62:         ERC20Getters memory getters; 
```
[62](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L62)

```solidity
üìÅ File: system-contracts/contracts/ContractDeployer.sol

41:         AccountInfo memory info = accountInfo[_address]; 

75:         AccountInfo memory currentInfo = accountInfo[msg.sender]; 

219:         AccountInfo memory newAccountInfo; 

291:         AccountInfo memory newAccountInfo; 

347:             ImmutableData[] memory immutables = abi.decode(returnData, (ImmutableData[])); 
```
[41](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L41), [75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L75), [219](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L219), [291](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L291), [347](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/ContractDeployer.sol#L347)

```solidity
üìÅ File: system-contracts/contracts/L1Messenger.sol

75:         L2ToL1Log memory l2ToL1Log = L2ToL1Log({ 
76:             l2ShardId: 0,
77:             isService: _isService,
78:             txNumberInBlock: SYSTEM_CONTEXT_CONTRACT.txNumberInBlock(),
79:             sender: msg.sender,
80:             key: _key,
81:             value: _value
82:         });

125:         L2ToL1Log memory l2ToL1Log = L2ToL1Log({ 
126:             l2ShardId: 0,
127:             isService: true,
128:             txNumberInBlock: SYSTEM_CONTEXT_CONTRACT.txNumberInBlock(),
129:             sender: address(this),
130:             key: bytes32(uint256(uint160(msg.sender))),
131:             value: hash
132:         });

204:         bytes32[] memory l2ToL1LogsTreeArray = new bytes32[](L2_TO_L1_LOGS_MERKLE_TREE_LEAVES); 
```
[75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L75-L82), [125](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L125-L132), [204](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L1Messenger.sol#L204)

```solidity
üìÅ File: system-contracts/contracts/NonceHolder.sol

83:         IContractDeployer.AccountInfo memory accountInfo = DEPLOYER_SYSTEM_CONTRACT.getAccountInfo(msg.sender); 
```
[83](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/NonceHolder.sol#L83)

```solidity
üìÅ File: system-contracts/contracts/PubdataChunkPublisher.sol

24:         bytes32[] memory blobHashes = new bytes32[](MAX_NUMBER_OF_BLOBS); 
```
[24](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/PubdataChunkPublisher.sol#L24)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

135:         VirtualBlockUpgradeInfo memory currentVirtualBlockUpgradeInfo = virtualBlockUpgradeInfo; 

173:         BlockInfo memory batchInfo = currentBatchInfo; 

181:         BlockInfo memory blockInfo = currentL2BlockInfo; 

275:         BlockInfo memory virtualBlockInfo = currentVirtualL2BlockInfo; 

459:         BlockInfo memory newBlockInfo = BlockInfo({number: previousBatchNumber + 1, timestamp: _newTimestamp}); 

476:         BlockInfo memory newBlockInfo = BlockInfo({number: uint128(_number), timestamp: uint128(_newTimestamp)}); 
```
[135](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L135), [173](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L173), [181](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L181), [275](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L275), [459](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L459), [476](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L476)

</details>


---
### [GAS&#x2011;113] Using `this.<fn>()` wastes gas
Calling an `external` function internally, through the use of `this` wastes the gas overhead of calling an `external` function (100 gas). Instead, change the function from `external` to `public`, and remove the `this`


Gas saved per Instance: ~100 *(Total: ~300)*

<i>There are 3 instaces of this issue:</i>

```solidity
üìÅ File: contracts/zksync/contracts/bridge/L2StandardERC20.sol

75:         try this.decodeString(nameBytes) returns (string memory nameString) { 

81:         try this.decodeString(symbolBytes) returns (string memory symbolString) { 

93:         try this.decodeUint8(decimalsBytes) returns (uint8 decimalsUint8) { 
```
[75](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L75), [81](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L81), [93](https://github.com/code-423n4/2024-03-zksync/blob/main/code/contracts/zksync/contracts/bridge/L2StandardERC20.sol#L93)


---
### [GAS&#x2011;114] `x + y` is more efficient than using `+=` for state variables (likewise for `-=`)
In instances found where either `+=` or -= are used against state variables use `x = x + y` instead


Gas saved per Instance: ~248 *(Total: ~744)*
<details>
<summary><i>There are 3 instances of this issue:</i></summary>

```solidity
üìÅ File: system-contracts/contracts/L2BaseToken.sol

65:         totalSupply += _amount; 

107:             totalSupply -= amount; 
```
[65](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L65), [107](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/L2BaseToken.sol#L107)

```solidity
üìÅ File: system-contracts/contracts/SystemContext.sol

483:         txNumberInBlock += 1; 
```
[483](https://github.com/code-423n4/2024-03-zksync/blob/main/code/system-contracts/contracts/SystemContext.sol#L483)

</details>
